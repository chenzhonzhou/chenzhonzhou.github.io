<!-- build time:Sun Dec 03 2023 14:39:10 GMT+0800 (GMT+08:00) --><!DOCTYPE html><html class="theme-next gemini use-motion" lang="zh-Hans"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><script src="//cdn.bootcss.com/pace/1.0.2/pace.min.js"></script><link href="//cdn.bootcss.com/pace/1.0.2/themes/pink/pace-theme-flash.css" rel="stylesheet"><script></script><meta name="theme-color" content="#222"><style>.pace .pace-progress{background:#1E92FB;height:3px}.pace .pace-progress-inner{box-shadow:0 0 10px #1E92FB,0 0 5px #1E92FB}.pace .pace-activity{border-top-color:#1E92FB;border-left-color:#1E92FB}</style><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><meta name="google-site-verification" content="HGM141IpbHrSmnAmR6W_zE4bo9Z3f-yXLeHYT3bg1fk"><meta name="baidu-site-verification" content="code-5Ai1DA8e6T"><link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css"><link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css"><link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4"><link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222"><meta name="keywords" content="网络,tcpip,"><link rel="alternate" href="/atom.xml" title="凡间的精灵" type="application/atom+xml"><meta name="description" content="1、TCP协议1.1 TCP状态迁移路线图按照client&#x2F;server两条路线讲述TCP状态迁移路线图客户端TCP状态迁移：1CLOSED-&amp;gt;SYN_SENT-&amp;gt;ESTABLISHED-&amp;gt;FIN_WAIT_1-&amp;gt;FIN_WAIT_2-&amp;gt;TIME_WAIT-&amp;gt;CLOSED服务器TCP状态迁移：1CLOSED-&amp;gt;LISTEN-&amp;gt;SYN-RECEIVED"><meta name="keywords" content="网络,tcpip"><meta property="og:type" content="article"><meta property="og:title" content="tcpip 网络连接那些事"><meta property="og:url" content="http:&#x2F;&#x2F;chenzhonzhou.github.io&#x2F;2016&#x2F;11&#x2F;15&#x2F;tcpip-wang-luo-lian-jie-na-xie-shi&#x2F;index.html"><meta property="og:site_name" content="凡间的精灵"><meta property="og:description" content="1、TCP协议1.1 TCP状态迁移路线图按照client&#x2F;server两条路线讲述TCP状态迁移路线图客户端TCP状态迁移：1CLOSED-&amp;gt;SYN_SENT-&amp;gt;ESTABLISHED-&amp;gt;FIN_WAIT_1-&amp;gt;FIN_WAIT_2-&amp;gt;TIME_WAIT-&amp;gt;CLOSED服务器TCP状态迁移：1CLOSED-&amp;gt;LISTEN-&amp;gt;SYN-RECEIVED"><meta property="og:locale" content="zh-Hans"><meta property="og:image" content="http:&#x2F;&#x2F;chenzhonzhou.github.io&#x2F;2016&#x2F;11&#x2F;15&#x2F;tcpip-wang-luo-lian-jie-na-xie-shi&#x2F;%E5%9B%BE%E7%89%871.png"><meta property="og:image" content="http:&#x2F;&#x2F;chenzhonzhou.github.io&#x2F;2016&#x2F;11&#x2F;15&#x2F;tcpip-wang-luo-lian-jie-na-xie-shi&#x2F;%E5%9B%BE%E7%89%8719.png"><meta property="og:image" content="http:&#x2F;&#x2F;chenzhonzhou.github.io&#x2F;2016&#x2F;11&#x2F;15&#x2F;tcpip-wang-luo-lian-jie-na-xie-shi&#x2F;%E5%9B%BE%E7%89%873.png"><meta property="og:image" content="http:&#x2F;&#x2F;chenzhonzhou.github.io&#x2F;2016&#x2F;11&#x2F;15&#x2F;tcpip-wang-luo-lian-jie-na-xie-shi&#x2F;%E5%9B%BE%E7%89%874.png"><meta property="og:image" content="http:&#x2F;&#x2F;chenzhonzhou.github.io&#x2F;2016&#x2F;11&#x2F;15&#x2F;tcpip-wang-luo-lian-jie-na-xie-shi&#x2F;%E5%9B%BE%E7%89%8720.png"><meta property="og:image" content="http:&#x2F;&#x2F;chenzhonzhou.github.io&#x2F;2016&#x2F;11&#x2F;15&#x2F;tcpip-wang-luo-lian-jie-na-xie-shi&#x2F;%E5%9B%BE%E7%89%876.png"><meta property="og:image" content="http:&#x2F;&#x2F;chenzhonzhou.github.io&#x2F;2016&#x2F;11&#x2F;15&#x2F;tcpip-wang-luo-lian-jie-na-xie-shi&#x2F;%E5%9B%BE%E7%89%877.png"><meta property="og:image" content="http:&#x2F;&#x2F;chenzhonzhou.github.io&#x2F;2016&#x2F;11&#x2F;15&#x2F;tcpip-wang-luo-lian-jie-na-xie-shi&#x2F;%E5%9B%BE%E7%89%878.png"><meta property="og:image" content="http:&#x2F;&#x2F;chenzhonzhou.github.io&#x2F;2016&#x2F;11&#x2F;15&#x2F;tcpip-wang-luo-lian-jie-na-xie-shi&#x2F;%E5%9B%BE%E7%89%879.png"><meta property="og:image" content="http:&#x2F;&#x2F;chenzhonzhou.github.io&#x2F;2016&#x2F;11&#x2F;15&#x2F;tcpip-wang-luo-lian-jie-na-xie-shi&#x2F;%E5%9B%BE%E7%89%8710.png"><meta property="og:image" content="http:&#x2F;&#x2F;chenzhonzhou.github.io&#x2F;2016&#x2F;11&#x2F;15&#x2F;tcpip-wang-luo-lian-jie-na-xie-shi&#x2F;%E5%9B%BE%E7%89%8711.png"><meta property="og:image" content="http:&#x2F;&#x2F;chenzhonzhou.github.io&#x2F;2016&#x2F;11&#x2F;15&#x2F;tcpip-wang-luo-lian-jie-na-xie-shi&#x2F;%E5%9B%BE%E7%89%8712.png"><meta property="og:image" content="http:&#x2F;&#x2F;chenzhonzhou.github.io&#x2F;2016&#x2F;11&#x2F;15&#x2F;tcpip-wang-luo-lian-jie-na-xie-shi&#x2F;%E5%9B%BE%E7%89%8713.png"><meta property="og:image" content="http:&#x2F;&#x2F;chenzhonzhou.github.io&#x2F;2016&#x2F;11&#x2F;15&#x2F;tcpip-wang-luo-lian-jie-na-xie-shi&#x2F;%E5%9B%BE%E7%89%8714.png"><meta property="og:image" content="http:&#x2F;&#x2F;chenzhonzhou.github.io&#x2F;2016&#x2F;11&#x2F;15&#x2F;tcpip-wang-luo-lian-jie-na-xie-shi&#x2F;%E5%9B%BE%E7%89%8715.png"><meta property="og:image" content="http:&#x2F;&#x2F;chenzhonzhou.github.io&#x2F;2016&#x2F;11&#x2F;15&#x2F;tcpip-wang-luo-lian-jie-na-xie-shi&#x2F;%E5%9B%BE%E7%89%8716.png"><meta property="og:image" content="http:&#x2F;&#x2F;chenzhonzhou.github.io&#x2F;2016&#x2F;11&#x2F;15&#x2F;tcpip-wang-luo-lian-jie-na-xie-shi&#x2F;%E5%9B%BE%E7%89%8717.png"><meta property="og:updated_time" content="2019-11-22T03:07:03.751Z"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="http:&#x2F;&#x2F;chenzhonzhou.github.io&#x2F;2016&#x2F;11&#x2F;15&#x2F;tcpip-wang-luo-lian-jie-na-xie-shi&#x2F;%E5%9B%BE%E7%89%871.png"><script type="text/javascript" id="hexo.configurations">var NexT=window.NexT||{},CONFIG={root:"/",scheme:"Gemini",version:"5.1.4",sidebar:{position:"left",display:"always",offset:12,b2t:!0,scrollpercent:!0,onmobile:!0},fancybox:!0,tabs:!0,motion:{enable:!0,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}},duoshuo:{userId:"0",author:"博主"},algolia:{applicationID:"",apiKey:"",indexName:"",hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}}}</script><link rel="canonical" href="http://chenzhonzhou.github.io/2016/11/15/tcpip-wang-luo-lian-jie-na-xie-shi/"><title>tcpip 网络连接那些事 | 凡间的精灵</title><link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css"></head><body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans"><div class="container sidebar-position-left page-post-detail"><div class="headband"></div><header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-wrapper"><div class="site-meta"><div class="custom-logo-site-title"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">凡间的精灵</span> <span class="logo-line-after"><i></i></span></a></div><p class="site-subtitle">凡尘落素一精灵</p></div><div class="site-nav-toggle"><button><span class="btn-bar"></span> <span class="btn-bar"></span> <span class="btn-bar"></span></button></div></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i><br>首页</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i><br>归档</a></li><li class="menu-item menu-item-categories"><a href="/categories" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i><br>分类</a></li><li class="menu-item menu-item-tags"><a href="/tags" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i><br>标签</a></li><li class="menu-item menu-item-sitemap"><a href="/sitemap.xml" rel="section"><i class="menu-item-icon fa fa-fw fa-sitemap"></i><br>站点地图</a></li><li class="menu-item menu-item-search"><a href="javascript:;" class="popup-trigger"><i class="menu-item-icon fa fa-search fa-fw"></i><br>搜索</a></li></ul><div class="site-search"><div class="popup search-popup local-search-popup"><div class="local-search-header clearfix"><span class="search-icon"><i class="fa fa-search"></i> </span><span class="popup-btn-close"><i class="fa fa-times-circle"></i></span><div class="local-search-input-wrapper"><input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input"></div></div><div id="local-search-result"></div></div></div></nav></div></header><main id="main" class="main"><div class="main-inner"><div class="content-wrap"><div id="content" class="content"><div id="posts" class="posts-expand"><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><div class="post-block"><link itemprop="mainEntityOfPage" href="http://chenzhonzhou.github.io/2016/11/15/tcpip-wang-luo-lian-jie-na-xie-shi/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="name" content="Zhongzhou Chen"><meta itemprop="description" content=""><meta itemprop="image" content="/images/chen.png"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="凡间的精灵"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">tcpip 网络连接那些事</h1><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-11-15T11:26:08+08:00">2016-11-15 </time></span><span class="post-category"><span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-folder-o"></i> </span><span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/%E7%BD%91%E7%BB%9C/" itemprop="url" rel="index"><span itemprop="name">网络</span></a></span></span><div class="post-wordcount"><span class="post-meta-item-icon"><i class="fa fa-file-word-o"></i> </span><span class="post-meta-item-text">字数统计&#58;</span> <span title="字数统计">2.9k </span><span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-clock-o"></i> </span><span class="post-meta-item-text">阅读时长 &asymp;</span> <span title="阅读时长">11</span></div></div></header><div class="post-body" itemprop="articleBody"><h2 id="1、TCP协议"><a href="#1、TCP协议" class="headerlink" title="1、TCP协议"></a>1、TCP协议</h2><h3 id="1-1-TCP状态迁移路线图"><a href="#1-1-TCP状态迁移路线图" class="headerlink" title="1.1 TCP状态迁移路线图"></a>1.1 TCP状态迁移路线图</h3><p><img src="/2016/11/15/tcpip-wang-luo-lian-jie-na-xie-shi/%E5%9B%BE%E7%89%871.png" alt=""><br>按照client/server两条路线讲述TCP状态迁移路线图<br><strong>客户端TCP状态迁移：</strong></p><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CLOSED-&gt;SYN_SENT-&gt;ESTABLISHED-&gt;FIN_WAIT_1-&gt;FIN_WAIT_2-&gt;TIME_WAIT-&gt;CLOSED</span><br></pre></td></tr></tbody></table></figure><p><strong>服务器TCP状态迁移：</strong></p><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CLOSED-&gt;LISTEN-&gt;SYN-RECEIVED-&gt;ESTABLISHED-&gt;CLOSE_WAIT-&gt;LAST_ACK-&gt;CLOSED</span><br></pre></td></tr></tbody></table></figure><h3 id="1-2-三次握手"><a href="#1-2-三次握手" class="headerlink" title="1.2 三次握手"></a>1.2 三次握手</h3><h4 id="正常的三次握手"><a href="#正常的三次握手" class="headerlink" title="正常的三次握手"></a>正常的三次握手</h4><p><img src="/2016/11/15/tcpip-wang-luo-lian-jie-na-xie-shi/%E5%9B%BE%E7%89%8719.png" alt="img"></p><ol><li>客户端发送一个带SYN标志的TCP报文到服务器。这是三次握手过程中的报文1。</li><li>服务器端回应客户端的，这是三次握手中的第2个报文，这个报文同时带ACK标志和SYN标志。因此它表示对刚才客户端SYN报文的回应；同时又标志SYN给客户端，询问客户端是否准备好进行数据通讯。</li><li>客户必须再次回应服务段一个ACK报文，这是报文段3</li></ol><p><strong>SERVER：</strong></p><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">In [7]: s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line">In [8]:  s.bind((HOST, PORT))</span><br><span class="line">In [9]: s.listen(1)</span><br></pre></td></tr></tbody></table></figure><p><strong>CLIENT：</strong></p><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">In [3]: s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line">In [4]: s.connect((host,port))</span><br><span class="line">client调用connect，server调用了socket + bind + listen，三次握手建立成功</span><br></pre></td></tr></tbody></table></figure><h4 id="三次握手复位"><a href="#三次握手复位" class="headerlink" title="三次握手复位"></a>三次握手复位</h4><p><img src="/2016/11/15/tcpip-wang-luo-lian-jie-na-xie-shi/%E5%9B%BE%E7%89%873.png" alt="image-20191119110247186"></p><p>复现方式<br><strong>SERVER：</strong><br>没有监听10001端口，服务端会直接返回RSET</p><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">In [3]: s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line">In [4]: host=''</span><br><span class="line">In [5]: port=10000</span><br><span class="line">In [6]: s.bind((host,port)) ##没有listen</span><br></pre></td></tr></tbody></table></figure><p><strong>CLIENT：</strong></p><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">In [5]: s.connect((host,port))</span><br><span class="line">telnet 115.28.46.185 10001</span><br></pre></td></tr></tbody></table></figure><p>可能的情况：到不存在的端口的连接请求<br>返回错误：telnet: Unable to connect to remote host: Connection refused</p><h4 id="三次握手重传"><a href="#三次握手重传" class="headerlink" title="三次握手重传"></a>三次握手重传</h4><p><img src="/2016/11/15/tcpip-wang-luo-lian-jie-na-xie-shi/%E5%9B%BE%E7%89%874.png" alt="image-20191119110345163"></p><p>复现方式<br><strong>SERVER：</strong><br>iptables -I INPUT -p tcp –dport 10000 -j DROP #服务端DROP10000端口的数据包<br><strong>CLIENT：</strong><br>telnet 115.28.46.185 10000<br>可能的情况：丢失在发往Internet的途中，对端DROP掉数据包，应用无响应导致重传等<br>返回错误：telnet: Unable to connect to remote host: Connection timed out</p><h3 id="1-3-四次挥手"><a href="#1-3-四次挥手" class="headerlink" title="1.3 四次挥手"></a>1.3 四次挥手</h3><h4 id="四次挥手状态迁移一"><a href="#四次挥手状态迁移一" class="headerlink" title="四次挥手状态迁移一"></a>四次挥手状态迁移一</h4><p><img src="/2016/11/15/tcpip-wang-luo-lian-jie-na-xie-shi/%E5%9B%BE%E7%89%8720.png" alt="img"></p><ol><li>客户端A发送一个FIN，用来关闭客户A到服务器B的数据传送。</li><li>服务器B收到这个FIN，它发回一个ACK，确认序号为收到的序号加1。和SYN一样，一个FIN将占用一个序号。</li><li>服务器B关闭与客户端A的连接，发送一个FIN给客户端A。</li><li>客户端A发回ACK报文确认，并将确认序号设置为收到序号加1。</li></ol><h4 id="四次挥手状态迁移二"><a href="#四次挥手状态迁移二" class="headerlink" title="四次挥手状态迁移二"></a>四次挥手状态迁移二</h4><p><img src="/2016/11/15/tcpip-wang-luo-lian-jie-na-xie-shi/%E5%9B%BE%E7%89%876.png" alt=""></p><p>TCP协议的连接是全双工连接，一个TCP连接存在双向的读写通道。</p><p>简单说来是 “先关读，后关写”，一共需要四个阶段。以客户机发起关闭连接为例：</p><ol><li>服务器读通道关闭</li><li>客户机写通道关闭</li><li>客户机读通道关闭</li><li>服务器写通道关闭，关闭行为是在发起方数据发送完毕之后，给对方发出一个FIN（finish）数据段。直到接收到对方发送的FIN，且对方收到了接收确认ACK之后，双方的数据通信完全结束，过程中每次接收都需要返回确认数据段ACK。</li></ol><h3 id="1-4-TCP状态"><a href="#1-4-TCP状态" class="headerlink" title="1.4 TCP状态"></a>1.4 TCP状态</h3><h4 id="状态之SYN-RECV"><a href="#状态之SYN-RECV" class="headerlink" title="状态之SYN_RECV"></a>状态之SYN_RECV</h4><p>服务端收到建立连接的SYN没有收到ACK包的时候处在SYN_RECV状态。<br>处在SYNC_RECV的TCP连接称为半连接，存储在内核的半连接队列中，在内核收到对端发送的ack包时会查找半连接队列，并将符合的requst_sock信息存储到完成三次握手的连接的队列中，然后删除此半连接。大量SYNC_RECV的TCP连接会导致半连接队列溢出，这样后续的连接建立请求会被内核直接丢弃，这就是SYN Flood攻击。<br>相关参数：</p><ol><li>net.ipv4.tcp_synack_retries<br>对于syn请求，内核会发送SYN ＋ ACK数据报文，对上一个SYN进行确认<br>这里决定内核在放弃连接之前所送出的 SYN+ACK 数目</li><li>net.ipv4.tcp_syncookies<br>SYN Cookie原理由D. J. Bernstain和 Eric Schenk发明。SYN Cookie是对TCP服务器端的三次握手协议作一些修改，专门用来防范SYN Flood攻击的一种手段。<br>在TCP服务器收到TCP SYN包并返回TCP SYN+ACK包时，不分配一个专门的数据区，而是根据这个SYN包计算出一个cookie值，在syn backlog队列不足的时候，提供一种机制临时将syn链接换出</li></ol><h4 id="状态之CLOSE-WAIT"><a href="#状态之CLOSE-WAIT" class="headerlink" title="状态之CLOSE_WAIT"></a>状态之CLOSE_WAIT</h4><p>发起TCP连接关闭的一方称为client，被动关闭的一方称为server。被动关闭的server收到FIN后，发出ACK的TCP状态之后状态变为CLOSE_WAIT， CLOSE_WAIT没有超时时间。<br>出现这种状况一般都是由于server端代码的问题，没有发出FIN，如果服务器上出现大量CLOSE_WAIT，应该要考虑检查代码。<br><strong>CLIENT：</strong><br>In [6]: s.close()，客户端调用了close()方法，进入FIN_WAIT2<br>tcp 0 0 115.28.46.185:45522 123.57.161.192:10000 FIN_WAIT2<br><strong>SERVER：</strong><br>SERVER端口进入CLOSE_WAIT状态，解决办法server调用close()方法<br>root@localhost:~# netstat -ant |grep 10000<br>tcp 0 0 0.0.0.0:10000 0.0.0.0:* LISTEN<br>tcp 1 0 123.57.161.192:10000 115.28.46.185:45522 CLOSE_WAIT</p><h4 id="状态之FIN-WAIT2"><a href="#状态之FIN-WAIT2" class="headerlink" title="状态之FIN_WAIT2"></a>状态之FIN_WAIT2</h4><p>FIN_WAIT2常见于存在客户端，客户端发出FIN之后收到服务端的ACK，但是没有收到服务端的FIN<br>client的连接过一段时间就没有了，而server的连接一直处于CLOSE_WAIT状态<br>原因在于Linux系统内核中有一个参数可以控制FIN_WAIT_2的时间：<br>net.ipv4.tcp_fin_timeout<br>抓包</p><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">13:27:48.635176 IP 115.28.46.185.45539 &gt; 123.57.161.192.webmin: Flags [F.], seq 1, ack 1, win 29200, length 0</span><br><span class="line">13:27:48.637587 IP 123.57.161.192.webmin &gt; 115.28.46.185.45539: Flags [.], ack 2, win 29200, length 0</span><br></pre></td></tr></tbody></table></figure><h4 id="状态之FIN-WAIT1"><a href="#状态之FIN-WAIT1" class="headerlink" title="状态之FIN_WAIT1"></a>状态之FIN_WAIT1</h4><p>FIN_WAIT1常见于存在客户端，客户端发出FIN之后没收收到服务端的ACK<br><strong>SERVER：</strong><br>In [13]: s.bind((host,port))<br>In [14]: s.listen(1)<br><strong>CLIENT：</strong><br>In [22]: s.connect ((host,port))<br>之后进入ESTABLISHED<br><strong>SERVER：</strong><br>root@localhost:~# iptables -I INPUT -s 115.28.46.185 -j DROP 配置DROP客户端的访问<br><strong>CLIENT：</strong><br>In [22]: s.close()<br>tcp 0 1 115.28.46.185:45534 123.57.161.192:10000 FIN_WAIT1<br>主要涉及两个参数<br>net.ipv4.tcp_max_orphans 最大孤儿socket<br>net.ipv4.tcp_orphan_retries 最大重试次数，负载比较高的主机可以设置小一些</p><h4 id="状态之FIN-WAIT1抓包文件"><a href="#状态之FIN-WAIT1抓包文件" class="headerlink" title="状态之FIN_WAIT1抓包文件"></a>状态之FIN_WAIT1抓包文件</h4><p><img src="/2016/11/15/tcpip-wang-luo-lian-jie-na-xie-shi/%E5%9B%BE%E7%89%877.png" alt=""></p><h4 id="状态之TIME-WAIT"><a href="#状态之TIME-WAIT" class="headerlink" title="状态之TIME_WAIT"></a>状态之TIME_WAIT</h4><p>2MSL（max segment lifetime）<br>TIME_WAIT是主动关闭连接的一方保持的状态，对于服务器来说它本身就是“客户端”，从而进入TIME_WAIT的状态，然后在保持这个状态2MSL（max segment lifetime）时间之后，彻底关闭回收资源。<br>这个是TCP/IP的设计者规定的，主要出于以下两个方面的考虑：</p><ol><li>防止上一次连接中的包，迷路后重新出现，影响新连接（经过2MSL，上一次连接中所有的重复包都会消失）</li><li>可靠的关闭TCP连接。在主动关闭方发送的最后一个 ack(fin) ，有可能丢失，这时被动方会重新发fin, 如果这时主动方处于 CLOSED 状态 ，就会响应 rst 而不是 ack。所以主动方要处于 TIME_WAIT 状态，而不能是 CLOSED 。另外这么设计TIME_WAIT 会定时的回收资源，并不会占用很大资源的，除非短时间内接受大量请求或者受到攻击。</li></ol><p><strong>常见解决方案：</strong><br>#表示开启重用。允许将TIME-WAIT sockets重新用于新的TCP连接，默认为0，表示关闭 net.ipv4.tcp_tw_reuse = 1<br>#表示开启TCP连接中TIME-WAIT sockets的快速回收，默认为0，表示关闭 net.ipv4.tcp_tw_recycle = 1<br>#表示如果套接字由本端要求关闭，这个参数决定了它保持在FIN-WAIT-2状态的时间 #tcp_max_tw_buckets<br>这个是控制并发的TIME_WAIT的数量，默认值是180000，如果超限，那么，系统会把多的给destory掉，然后在日志里打一个警告（如：time wait bucket table overflow），官网文档说这个参数是用来对抗DDoS攻击的。也说的默认值180000并不小。这个还是需要根据实际情况考虑,增大会增加资源的占用。</p><h4 id="查看tcp状态"><a href="#查看tcp状态" class="headerlink" title="查看tcp状态"></a>查看tcp状态</h4><p><strong>linux查看tcp的状态命令：</strong></p><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">1. netstat -nat &nbsp;查看TCP各个状态的数量</span><br><span class="line">2. sar -n SOCK 查看tcp创建的连接数</span><br><span class="line">3. tcpdump -iany tcp port 10000 对tcp端口为10000的进行抓包，本地使用wireshark</span><br><span class="line">4. netstat&nbsp;-n&nbsp;|&nbsp;awk&nbsp;‘/^tcp/&nbsp;{++S[$NF]}&nbsp;END&nbsp;{for(a&nbsp;in&nbsp;S)&nbsp;print&nbsp;a,&nbsp;S[a]}’&nbsp;查看各连接状态数</span><br></pre></td></tr></tbody></table></figure><h2 id="2、HTTP协议"><a href="#2、HTTP协议" class="headerlink" title="2、HTTP协议"></a>2、HTTP协议</h2><h3 id="2-1-打开一个站点经过了什么"><a href="#2-1-打开一个站点经过了什么" class="headerlink" title="2.1 打开一个站点经过了什么?"></a>2.1 打开一个站点经过了什么?</h3><p><img src="/2016/11/15/tcpip-wang-luo-lian-jie-na-xie-shi/%E5%9B%BE%E7%89%878.png" alt=""></p><p>以打开 <a href="http://www.aliyun.com" target="_blank" rel="noopener">www.aliyun.com</a> 为例</p><ol><li>将域名解析成ip地址</li><li>浏览器向web服务器发起Request</li><li>服务器向浏览器返回response</li></ol><p><strong>工具：</strong>chrome F12 火狐 firedebug<br>以及强大的工具Fiddler<br>Liunx下curl命令</p><h3 id="2-2-使用Fiddler"><a href="#2-2-使用Fiddler" class="headerlink" title="2.2 使用Fiddler"></a>2.2 使用Fiddler</h3><p><img src="/2016/11/15/tcpip-wang-luo-lian-jie-na-xie-shi/%E5%9B%BE%E7%89%879.png" alt=""></p><p>请求第一行中的Method表示请求方法，比如”POST”，”GET”， Path-to-resoure表示请求的资源， Http/version-number 表示HTTP协议的版本号<br>响应HTTP/version-number表示HTTP协议的版本号， status-code 和message</p><p><img src="/2016/11/15/tcpip-wang-luo-lian-jie-na-xie-shi/%E5%9B%BE%E7%89%8710.png" alt=""></p><p>URL(Uniform Resource Locator) 地址用于描述一个网络上的资源<br>schema://host[:port#]/path/…/[;url-params][?query-string] [#anchor]<br>scheme 指定低层使用的协议(例如：http, https, ftp)<br>host HTTP服务器的IP地址或者域名<br>port HTTP服务器的默认端口是80，这种情况下端口号可以省略。如果使用了别的端口，必须指明，例如 <a href="http://www.cnblogs.com:8080/" target="_blank" rel="noopener">http://www.cnblogs.com:8080/</a><br>path 访问资源的路径<br>url-params<br>query-string 发送给http服务器的数据<br>anchor- 锚</p><h3 id="2-3-GET、POST"><a href="#2-3-GET、POST" class="headerlink" title="2.3 GET、POST"></a>2.3 GET、POST</h3><p><img src="/2016/11/15/tcpip-wang-luo-lian-jie-na-xie-shi/%E5%9B%BE%E7%89%8711.png" alt=""></p><p><img src="/2016/11/15/tcpip-wang-luo-lian-jie-na-xie-shi/%E5%9B%BE%E7%89%8712.png" alt=""></p><p>GET和POST区别</p><ol><li>GET提交的数据会放在URL之后，以?分割URL和传输数据，参数之间以&amp;相连</li><li>POST主要通过该form表单的形式提交数据</li><li>GET提交的数据大小有限制（因为浏览器对URL的长度有限制），而POST方法提交的数据没有限制</li><li>GET需要使用Request.QueryString来取得变量的值，而POST方式通过Request.Form来获取变量的值</li></ol><h3 id="2-4-HEAD、OPTIONS"><a href="#2-4-HEAD、OPTIONS" class="headerlink" title="2.4 HEAD、OPTIONS"></a>2.4 HEAD、OPTIONS</h3><p><img src="/2016/11/15/tcpip-wang-luo-lian-jie-na-xie-shi/%E5%9B%BE%E7%89%8713.png" alt=""></p><p><img src="/2016/11/15/tcpip-wang-luo-lian-jie-na-xie-shi/%E5%9B%BE%E7%89%8714.png" alt=""></p><p>HEAD和OPTIONS</p><ol><li>HEAD只请求资源的首部，一个HEAD请求的响应中，HTTP头中包含的元信息应该和一个GET请求的响应消息相同。</li><li>跨域请求中会用到，它用于获取当前URL所支持的方法。若请求成功，则它会在HTTP头中包含一个名为“Allow”的头，会返回支持的方法，<br>如截图，支持HEAD、GET、OPTIONS</li></ol><h3 id="2-5-状态码"><a href="#2-5-状态码" class="headerlink" title="2.5 状态码"></a>2.5 状态码</h3><p>Response 消息中的第一行叫做状态行，由HTTP协议版本号， 状态码， 状态消息 三部分组成。<br>状态码用来告诉HTTP客户端，HTTP服务器是否产生了预期的Response.<br>HTTP/1.1中定义了5类状态码， 状态码由三位数字组成，第一个数字定义了响应的类别<br>1XX 提示信息 - 表示请求已被成功接收，继续处理<br>2XX 成功 - 表示请求已被成功接收，理解，接受<br>3XX 重定向 - 要完成请求必须进行更进一步的处理<br>4XX 客户端错误 - 请求有语法错误或请求无法实现<br>5XX 服务器端错误 - 服务器未能实现合法的请求</p><h3 id="2-6-keep-alive和cookie"><a href="#2-6-keep-alive和cookie" class="headerlink" title="2.6 keep-alive和cookie"></a>2.6 keep-alive和cookie</h3><p>http协议是无状态的，同一个客户端的这次请求和上次请求是没有对应关系，对http服务器来说，它并不知道这两个请求来自同一个客户端。<br>Cookie是用来解决会话保持，slb的植入和重写cookie<br>HTTP/1.1起，默认都开启了Keep-Alive，保持连接特性，Keep-Alive不会永久保持连接，它有一个保持时间，可以在web服务里配置</p><p><img src="/2016/11/15/tcpip-wang-luo-lian-jie-na-xie-shi/%E5%9B%BE%E7%89%8715.png" alt=""></p><h3 id="2-7-Referer以及其他"><a href="#2-7-Referer以及其他" class="headerlink" title="2.7 Referer以及其他"></a>2.7 Referer以及其他</h3><p><img src="/2016/11/15/tcpip-wang-luo-lian-jie-na-xie-shi/%E5%9B%BE%E7%89%8716.png" alt=""></p><p><img src="/2016/11/15/tcpip-wang-luo-lian-jie-na-xie-shi/%E5%9B%BE%E7%89%8717.png" alt=""></p><p>Accept-Language：浏览器申明自己接收的语言<br>Accept-Encoding: gzip, deflate客户端支持gzip<br>X-cache 阿里cdn，hit是已经命中<br>等 <a href="http://www.w3.org/" target="_blank" rel="noopener">http://www.w3.org/</a></p><script>document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });</script></div><div><div><div style="text-align:center;color:#ccc;font-size:14px">-------------本文结束<i class="fa fa-paw"></i>感谢您的阅读-------------</div></div></div><div></div><footer class="post-footer"><div class="post-tags"><a href="/tags/%E7%BD%91%E7%BB%9C/" rel="tag"><i class="fa fa-tag"></i> 网络</a> <a href="/tags/tcpip/" rel="tag"><i class="fa fa-tag"></i> tcpip</a></div><div class="post-nav"><div class="post-nav-next post-nav-item"><a href="/2016/11/09/mongodb-chang-yong-ming-ling/" rel="next" title="MongoDB常用命令"><i class="fa fa-chevron-left"></i> MongoDB常用命令</a></div><span class="post-nav-divider"></span><div class="post-nav-prev post-nav-item"><a href="/2016/11/15/mongodb-bei-fen-he-hui-fu/" rel="prev" title="MongoDB备份和恢复">MongoDB备份和恢复 <i class="fa fa-chevron-right"></i></a></div></div></footer></div></article><div class="post-spread"><div class="jiathis_style"><span class="jiathis_txt">分享到：</span> <a class="jiathis_button_fav">收藏夹</a> <a class="jiathis_button_copy">复制网址</a> <a class="jiathis_button_email">邮件</a> <a class="jiathis_button_weixin">微信</a> <a class="jiathis_button_qzone">QQ空间</a> <a class="jiathis_button_tqq">腾讯微博</a> <a class="jiathis_button_douban">豆瓣</a> <a class="jiathis_button_share">一键分享</a> <a href="http://www.jiathis.com/share?uid=2140465" class="jiathis jiathis_txt jiathis_separator jtico jtico_jiathis" target="_blank">更多</a> <a class="jiathis_counter_style"></a></div><script type="text/javascript">var jiathis_config={data_track_clickback:!0,summary:"",shortUrl:!1,hideMore:!1}</script><script type="text/javascript" src="http://v3.jiathis.com/code/jia.js?uid=" charset="utf-8"></script></div></div></div></div><div class="sidebar-toggle"><div class="sidebar-toggle-line-wrap"><span class="sidebar-toggle-line sidebar-toggle-line-first"></span> <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span> <span class="sidebar-toggle-line sidebar-toggle-line-last"></span></div></div><aside id="sidebar" class="sidebar"><div id="sidebar-dimmer"></div><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">文章目录</li><li class="sidebar-nav-overview" data-target="site-overview-wrap">站点概览</li></ul><section class="site-overview-wrap sidebar-panel"><div class="site-overview"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="site-author-image" itemprop="image" src="/images/chen.png" alt="Zhongzhou Chen"><p class="site-author-name" itemprop="name">Zhongzhou Chen</p><p class="site-description motion-element" itemprop="description"></p></div><nav class="site-state motion-element"><div class="site-state-item site-state-posts"><a href="/archives/%7C%7C%20archive"><span class="site-state-item-count">371</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"><a href="/categories/index.html"><span class="site-state-item-count">89</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"><a href="/tags/index.html"><span class="site-state-item-count">188</span> <span class="site-state-item-name">标签</span></a></div></nav><div class="feed-link motion-element"><a href="/atom.xml" rel="alternate"><i class="fa fa-rss"></i> RSS</a></div></div></section><section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active"><div class="post-toc"><div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#1、TCP协议"><span class="nav-text">1、TCP协议</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-1-TCP状态迁移路线图"><span class="nav-text">1.1 TCP状态迁移路线图</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-2-三次握手"><span class="nav-text">1.2 三次握手</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#正常的三次握手"><span class="nav-text">正常的三次握手</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#三次握手复位"><span class="nav-text">三次握手复位</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#三次握手重传"><span class="nav-text">三次握手重传</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-3-四次挥手"><span class="nav-text">1.3 四次挥手</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#四次挥手状态迁移一"><span class="nav-text">四次挥手状态迁移一</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#四次挥手状态迁移二"><span class="nav-text">四次挥手状态迁移二</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-4-TCP状态"><span class="nav-text">1.4 TCP状态</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#状态之SYN-RECV"><span class="nav-text">状态之SYN_RECV</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#状态之CLOSE-WAIT"><span class="nav-text">状态之CLOSE_WAIT</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#状态之FIN-WAIT2"><span class="nav-text">状态之FIN_WAIT2</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#状态之FIN-WAIT1"><span class="nav-text">状态之FIN_WAIT1</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#状态之FIN-WAIT1抓包文件"><span class="nav-text">状态之FIN_WAIT1抓包文件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#状态之TIME-WAIT"><span class="nav-text">状态之TIME_WAIT</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#查看tcp状态"><span class="nav-text">查看tcp状态</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2、HTTP协议"><span class="nav-text">2、HTTP协议</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-1-打开一个站点经过了什么"><span class="nav-text">2.1 打开一个站点经过了什么?</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2-使用Fiddler"><span class="nav-text">2.2 使用Fiddler</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-3-GET、POST"><span class="nav-text">2.3 GET、POST</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-4-HEAD、OPTIONS"><span class="nav-text">2.4 HEAD、OPTIONS</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-5-状态码"><span class="nav-text">2.5 状态码</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-6-keep-alive和cookie"><span class="nav-text">2.6 keep-alive和cookie</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-7-Referer以及其他"><span class="nav-text">2.7 Referer以及其他</span></a></li></ol></li></ol></div></div></section><div class="back-to-top"><i class="fa fa-arrow-up"></i> <span id="scrollpercent"><span>0</span>%</span></div></div></aside></div></main><footer id="footer" class="footer"><div class="footer-inner"><script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script><div class="copyright">&copy; <span itemprop="copyrightYear">2023</span> <span class="with-love"><i class="fa fa-user"></i> </span><span class="author" itemprop="copyrightHolder">Zhongzhou Chen</span> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-area-chart"></i> </span><span class="post-meta-item-text">Site words total count&#58;</span> <span title="Site words total count">863.9k</span></div><span class="post-meta-divider"></span></div></footer></div><script type="text/javascript">"[object Function]"!==Object.prototype.toString.call(window.Promise)&&(window.Promise=null)</script><script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script><script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script><script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script><script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script><script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script><script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script><script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script><style>.copy-btn{display:inline-block;padding:6px 12px;font-size:13px;font-weight:700;line-height:20px;color:#333;white-space:nowrap;vertical-align:middle;cursor:pointer;background-color:#eee;background-image:linear-gradient(#fcfcfc,#eee);border:1px solid #d5d5d5;border-radius:3px;user-select:none;outline:0}.highlight-wrap .copy-btn{transition:opacity .3s ease-in-out;opacity:0;padding:2px 6px;position:absolute;right:4px;top:8px}.highlight-wrap .copy-btn:focus,.highlight-wrap:hover .copy-btn{opacity:1}.highlight-wrap{position:relative}</style><script>$(".highlight").each(function(t,e){var n=$("<div>").addClass("highlight-wrap");$(e).after(n),n.append($("<button>").addClass("copy-btn").append("复制").on("click",function(t){var e=$(this).parent().find(".code").find(".line").map(function(t,e){return $(e).text()}).toArray().join("\n"),n=document.createElement("textarea");document.body.appendChild(n),n.style.position="absolute",n.style.top="0px",n.style.left="0px",n.value=e,n.select(),n.focus();var o=document.execCommand("copy");document.body.removeChild(n),o?$(this).text("复制成功"):$(this).text("复制失败"),$(this).blur()})).on("mouseleave",function(t){var e=$(this).find(".copy-btn");setTimeout(function(){e.text("复制")},300)}).append(e)})</script><script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script><script type="text/javascript">function proceedsearch(){$("body").append('<div class="search-popup-overlay local-search-pop-overlay"></div>').css("overflow","hidden"),$(".search-popup-overlay").click(onPopupClose),$(".popup").toggle();var t=$("#local-search-input");t.attr("autocapitalize","none"),t.attr("autocorrect","off"),t.focus()}var isfetched=!1,isXml=!0,search_path="search.xml";0===search_path.length?search_path="search.xml":/json$/i.test(search_path)&&(isXml=!1);var path="/"+search_path,onPopupClose=function(t){$(".popup").hide(),$("#local-search-input").val(""),$(".search-result-list").remove(),$("#no-result").remove(),$(".local-search-pop-overlay").remove(),$("body").css("overflow","")},searchFunc=function(t,e,o){"use strict";$("body").append('<div class="search-popup-overlay local-search-pop-overlay"><div id="search-loading-icon"><i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i></div></div>').css("overflow","hidden"),$("#search-loading-icon").css("margin","20% auto 0 auto").css("text-align","center"),$.ajax({url:t,dataType:isXml?"xml":"json",async:!0,success:function(t){isfetched=!0,$(".popup").detach().appendTo(".header-inner");var n=isXml?$("entry",t).map(function(){return{title:$("title",this).text(),content:$("content",this).text(),url:$("url",this).text()}}).get():t,r=document.getElementById(e),s=document.getElementById(o),a=function(){var t=r.value.trim().toLowerCase(),e=t.split(/[\s\-]+/);e.length>1&&e.push(t);var o=[];if(t.length>0&&n.forEach(function(n){function r(e,o,n,r){for(var s=r[r.length-1],a=s.position,i=s.word,l=[],h=0;a+i.length<=n&&0!=r.length;){i===t&&h++,l.push({position:a,length:i.length});var p=a+i.length;for(r.pop();0!=r.length&&(s=r[r.length-1],a=s.position,i=s.word,p>a);)r.pop()}return c+=h,{hits:l,start:o,end:n,searchTextCount:h}}function s(t,e){var o="",n=e.start;return e.hits.forEach(function(e){o+=t.substring(n,e.position);var r=e.position+e.length;o+='<b class="search-keyword">'+t.substring(e.position,r)+"</b>",n=r}),o+=t.substring(n,e.end)}var a=!1,i=0,c=0,l=n.title.trim(),h=l.toLowerCase(),p=n.content.trim().replace(/<[^>]+>/g,""),u=p.toLowerCase(),f=decodeURIComponent(n.url),d=[],g=[];if(""!=l&&(e.forEach(function(t){function e(t,e,o){var n=t.length;if(0===n)return[];var r=0,s=[],a=[];for(o||(e=e.toLowerCase(),t=t.toLowerCase());(s=e.indexOf(t,r))>-1;)a.push({position:s,word:t}),r=s+n;return a}d=d.concat(e(t,h,!1)),g=g.concat(e(t,u,!1))}),(d.length>0||g.length>0)&&(a=!0,i=d.length+g.length)),a){[d,g].forEach(function(t){t.sort(function(t,e){return e.position!==t.position?e.position-t.position:t.word.length-e.word.length})});var v=[];0!=d.length&&v.push(r(l,0,l.length,d));for(var $=[];0!=g.length;){var C=g[g.length-1],m=C.position,x=C.word,w=m-20,y=m+80;0>w&&(w=0),y<m+x.length&&(y=m+x.length),y>p.length&&(y=p.length),$.push(r(p,w,y,g))}$.sort(function(t,e){return t.searchTextCount!==e.searchTextCount?e.searchTextCount-t.searchTextCount:t.hits.length!==e.hits.length?e.hits.length-t.hits.length:t.start-e.start});var T=parseInt("1");T>=0&&($=$.slice(0,T));var b="";b+=0!=v.length?"<li><a href='"+f+"' class='search-result-title'>"+s(l,v[0])+"</a>":"<li><a href='"+f+"' class='search-result-title'>"+l+"</a>",$.forEach(function(t){b+="<a href='"+f+'\'><p class="search-result">'+s(p,t)+"...</p></a>"}),b+="</li>",o.push({item:b,searchTextCount:c,hitCount:i,id:o.length})}}),1===e.length&&""===e[0])s.innerHTML='<div id="no-result"><i class="fa fa-search fa-5x" /></div>';else if(0===o.length)s.innerHTML='<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>';else{o.sort(function(t,e){return t.searchTextCount!==e.searchTextCount?e.searchTextCount-t.searchTextCount:t.hitCount!==e.hitCount?e.hitCount-t.hitCount:e.id-t.id});var a='<ul class="search-result-list">';o.forEach(function(t){a+=t.item}),a+="</ul>",s.innerHTML=a}};r.addEventListener("input",a),$(".local-search-pop-overlay").remove(),$("body").css("overflow",""),proceedsearch()}})};$(".popup-trigger").click(function(t){t.stopPropagation(),isfetched===!1?searchFunc(path,"local-search-input","local-search-result"):proceedsearch()}),$(".popup-btn-close").click(onPopupClose),$(".popup").click(function(t){t.stopPropagation()}),$(document).on("keyup",function(t){var e=27===t.which&&$(".search-popup").is(":visible");e&&onPopupClose()})</script><script type="text/javascript" src="/js/src/love.js"></script><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({pluginRootPath:"live2dw/",pluginJsPath:"lib/",pluginModelPath:"assets/",tagMode:!1,debug:!1,log:!1,model:{jsonPath:"/live2dw/assets/shizuku.model.json"},display:{position:"right"},mobile:{show:!0,scale:.2},react:{opacityDefault:.7,opacityOnHover:.2,opacity:.4}})</script></body></html><!-- rebuild by neat -->