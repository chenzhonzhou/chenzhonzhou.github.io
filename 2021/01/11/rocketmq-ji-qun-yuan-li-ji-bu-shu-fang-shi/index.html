<!DOCTYPE html><html class="theme-next gemini use-motion" lang="zh-Hans"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><script src="//cdn.bootcss.com/pace/1.0.2/pace.min.js"></script><link href="//cdn.bootcss.com/pace/1.0.2/themes/pink/pace-theme-flash.css" rel="stylesheet"><script></script><meta name="theme-color" content="#222"><style>.pace .pace-progress{background:#1e92fb;height:3px}.pace .pace-progress-inner{box-shadow:0 0 10px #1e92fb,0 0 5px #1e92fb}.pace .pace-activity{border-top-color:#1e92fb;border-left-color:#1e92fb}</style><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css"><link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css"><link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4"><link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222"><meta name="keywords" content="消息队列,RocketMQ,"><link rel="alternate" href="/atom.xml" title="凡间的精灵" type="application/atom+xml"><meta name="description" content="一、RocketMQ简介RocketMQ是一个纯Java、分布式、队列模型的开源消息中间件，前身是MetaQ，是阿里参考Kafka特点研发的一个队列模型的消息中间件，后开源给apache基金会成为了apache的顶级开源项目，具有高性能、高可靠、高实时、分布式特点。RocketMQ单机也可以支持亿级的消息堆积能力。单机写入TPS单实例约7万条&#x2F;秒，单机部署3个Broker，可以跑到最高12万条&#x2F;秒"><meta name="keywords" content="消息队列,RocketMQ"><meta property="og:type" content="article"><meta property="og:title" content="RocketMQ 集群原理及部署方式"><meta property="og:url" content="http:&#x2F;&#x2F;chenzhonzhou.github.io&#x2F;2021&#x2F;01&#x2F;11&#x2F;rocketmq-ji-qun-yuan-li-ji-bu-shu-fang-shi&#x2F;index.html"><meta property="og:site_name" content="凡间的精灵"><meta property="og:description" content="一、RocketMQ简介RocketMQ是一个纯Java、分布式、队列模型的开源消息中间件，前身是MetaQ，是阿里参考Kafka特点研发的一个队列模型的消息中间件，后开源给apache基金会成为了apache的顶级开源项目，具有高性能、高可靠、高实时、分布式特点。RocketMQ单机也可以支持亿级的消息堆积能力。单机写入TPS单实例约7万条&#x2F;秒，单机部署3个Broker，可以跑到最高12万条&#x2F;秒"><meta property="og:locale" content="zh-Hans"><meta property="og:image" content="http:&#x2F;&#x2F;chenzhonzhou.github.io&#x2F;2021&#x2F;01&#x2F;11&#x2F;rocketmq-ji-qun-yuan-li-ji-bu-shu-fang-shi&#x2F;%E5%9B%BE%E7%89%871.png"><meta property="og:image" content="http:&#x2F;&#x2F;chenzhonzhou.github.io&#x2F;2021&#x2F;01&#x2F;11&#x2F;rocketmq-ji-qun-yuan-li-ji-bu-shu-fang-shi&#x2F;%E5%9B%BE%E7%89%872.png"><meta property="og:image" content="http:&#x2F;&#x2F;chenzhonzhou.github.io&#x2F;2021&#x2F;01&#x2F;11&#x2F;rocketmq-ji-qun-yuan-li-ji-bu-shu-fang-shi&#x2F;%E5%9B%BE%E7%89%877.png"><meta property="og:image" content="http:&#x2F;&#x2F;chenzhonzhou.github.io&#x2F;2021&#x2F;01&#x2F;11&#x2F;rocketmq-ji-qun-yuan-li-ji-bu-shu-fang-shi&#x2F;%E5%9B%BE%E7%89%878.png"><meta property="og:image" content="http:&#x2F;&#x2F;chenzhonzhou.github.io&#x2F;2021&#x2F;01&#x2F;11&#x2F;rocketmq-ji-qun-yuan-li-ji-bu-shu-fang-shi&#x2F;%E5%9B%BE%E7%89%875.png"><meta property="og:updated_time" content="2021-01-12T10:43:58.333Z"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="http:&#x2F;&#x2F;chenzhonzhou.github.io&#x2F;2021&#x2F;01&#x2F;11&#x2F;rocketmq-ji-qun-yuan-li-ji-bu-shu-fang-shi&#x2F;%E5%9B%BE%E7%89%871.png"><script type="text/javascript" id="hexo.configurations">var NexT=window.NexT||{},CONFIG={root:"/",scheme:"Gemini",version:"5.1.4",sidebar:{position:"left",display:"always",offset:12,b2t:!0,scrollpercent:!0,onmobile:!0},fancybox:!0,tabs:!0,motion:{enable:!0,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}},duoshuo:{userId:"0",author:"博主"},algolia:{applicationID:"",apiKey:"",indexName:"",hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}}}</script><link rel="canonical" href="http://chenzhonzhou.github.io/2021/01/11/rocketmq-ji-qun-yuan-li-ji-bu-shu-fang-shi/"><title>RocketMQ 集群原理及部署方式 | 凡间的精灵</title><link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css"></head><body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans"><div class="container sidebar-position-left page-post-detail"><div class="headband"></div><header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-wrapper"><div class="site-meta"><div class="custom-logo-site-title"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">凡间的精灵</span><span class="logo-line-after"><i></i></span></a></div><p class="site-subtitle">凡尘落素一精灵</p></div><div class="site-nav-toggle"><button><span class="btn-bar"></span><span class="btn-bar"></span><span class="btn-bar"></span></button></div></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i><br>首页</a></li><li class="menu-item menu-item-archives"><a href="/archives" rel="section"><i class="menu-item-icon fa fa-fw fa-question-circle"></i><br>归档</a></li><li class="menu-item menu-item-categories"><a href="/categories" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i><br>分类</a></li><li class="menu-item menu-item-tags"><a href="/tags" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i><br>标签</a></li><li class="menu-item menu-item-about"><a href="/about" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i><br>关于</a></li><li class="menu-item menu-item-search"><a href="javascript:;" class="popup-trigger"><i class="menu-item-icon fa fa-search fa-fw"></i><br>搜索</a></li></ul><div class="site-search"><div class="popup search-popup local-search-popup"><div class="local-search-header clearfix"><span class="search-icon"><i class="fa fa-search"></i></span><span class="popup-btn-close"><i class="fa fa-times-circle"></i></span><div class="local-search-input-wrapper"><input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input"></div></div><div id="local-search-result"></div></div></div></nav></div></header><main id="main" class="main"><div class="main-inner"><div class="content-wrap"><div id="content" class="content"><div id="posts" class="posts-expand"><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><div class="post-block"><link itemprop="mainEntityOfPage" href="http://chenzhonzhou.github.io/2021/01/11/rocketmq-ji-qun-yuan-li-ji-bu-shu-fang-shi/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="name" content="Zhongzhou Chen"><meta itemprop="description" content=""><meta itemprop="image" content="/images/chen.png"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="凡间的精灵"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">RocketMQ 集群原理及部署方式</h1><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i></span> <span class="post-meta-item-text">发表于</span> <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-01-11T16:21:47+08:00">2021-01-11</time></span> <span class="post-category"><span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-folder-o"></i></span> <span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/" itemprop="url" rel="index"><span itemprop="name">消息队列</span></a></span> ， <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/RocketMQ/" itemprop="url" rel="index"><span itemprop="name">RocketMQ</span></a></span></span><div class="post-wordcount"><span class="post-meta-item-icon"><i class="fa fa-file-word-o"></i></span> <span class="post-meta-item-text">字数统计&#58;</span> <span title="字数统计">7.7k</span> <span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-clock-o"></i></span> <span class="post-meta-item-text">阅读时长 &asymp;</span> <span title="阅读时长">34</span></div></div></header><div class="post-body" itemprop="articleBody"><h2 id="一、RocketMQ简介"><a href="#一、RocketMQ简介" class="headerlink" title="一、RocketMQ简介"></a>一、RocketMQ简介</h2><p><strong>RocketMQ</strong>是一个纯<strong>Java</strong>、分布式、队列模型的开源消息中间件，前身是<strong>MetaQ</strong>，是阿里参考<strong>Kafka</strong>特点研发的一个队列模型的消息中间件，后开源给<strong>apache</strong>基金会成为了<strong>apache</strong>的顶级开源项目，具有高性能、高可靠、高实时、分布式特点。</p><p>RocketMQ单机也可以支持<strong>亿级的消息堆积能力</strong>。单机写入<strong>TPS单实例约7万条/秒</strong>，单机部署3个Broker，可以跑到最高<strong>12万条/秒</strong>，消息大小<strong>10个字节</strong>。</p><h3 id="1-1-RocketMQ发展历程"><a href="#1-1-RocketMQ发展历程" class="headerlink" title="1.1 RocketMQ发展历程"></a>1.1 RocketMQ发展历程</h3><p><strong>2007年</strong>：淘宝实施了“五彩石”项目，“五彩石”用于将交易系统从单机变成分布式，也是在这个过程中产生了阿里巴巴第一代消息引擎——Notify。<br><strong>2010年</strong>：阿里巴巴B2B部门基于ActiveMQ的5.1版本也开发了自己的一款消息引擎，称为Napoli，这款消息引擎在B2B里面广泛地被使用，不仅仅是在交易领域，在很多的后台异步解耦等方面也得到了广泛的应用。<br><strong>2011年</strong>：业界出现了现在被很多大数据领域所推崇的Kafka消息引擎，阿里巴巴在研究了Kafka的整体机制和架构设计之后，基于Kafka的设计使用Java进行了完全重写并推出了<strong>MetaQ 1.0</strong>版本，主要是用于解决顺序消息和海量堆积的问题。<br><strong>2012年</strong>：阿里巴巴开源其自研的第三代分布式消息中间件——<strong>RocketMQ</strong>。<br>经过几年的技术打磨，阿里称基于RocketMQ技术，目前双十一当天消息容量可达到万亿级。<br><strong>2016年11月</strong>：阿里将RocketMQ捐献给<strong>Apache</strong>软件基金会，正式成为孵化项目。<br>阿里称会将其打造成顶级项目。<strong>这是阿里迈出的一大步</strong>，因为加入到开源软件基金会需要经过评审方的考核与观察。<br><strong>2017年2月20日</strong>：RocketMQ正式发布4.0版本，专家称新版本适用于电商领域，金融领域，大数据领域，兼有物联网领域的编程模型。</p><p>以上就是RocketMQ的整体发展历史，其实在阿里巴巴内部围绕着RocketMQ内核打造了三款产品，分别是<strong>MetaQ</strong>、<strong>Notify</strong>和<strong>Aliware MQ</strong>。</p><p>这三者分别采用了不同的模型，<strong>MetaQ</strong>主要使用了拉模型，解决了顺序消息和海量堆积问题；<strong>Notify</strong>主要使用了推模型，解决了事务消息；而云产品<strong>Aliware MQ</strong>则是提供了商业化的版本。</p><h3 id="1-2-RocketMQ的功能"><a href="#1-2-RocketMQ的功能" class="headerlink" title="1.2 RocketMQ的功能"></a>1.2 RocketMQ的功能</h3><p><strong><a href="https://github.com/apache/rocketmq" target="_blank" rel="noopener">github</a></strong></p><ul><li><p>消息传递模式包括发布/订阅、请求/回复和流式传输</p></li><li><p>财务级事务消息</p></li><li><p>基于<a href="https://github.com/openmessaging/openmessaging-storage-dledger" target="_blank" rel="noopener">DLedger</a>的内置容错和高可用性配置选项</p></li><li><p>各种跨语言客户端，如java、C/C++、Python、Go</p></li><li><p>可插拔传输协议，如TCP、SSL、AIO</p></li><li><p>内置消息跟踪功能，还支持opentracing</p></li><li><p>多功能大数据与流媒体生态系统集成</p></li><li><p>按时间或偏移量的邮件追溯</p></li><li><p>同一队列中可靠的FIFO和严格有序的消息传递</p></li><li><p>高效的推拉消费模式</p></li><li><p>单队列百万级消息累积容量</p></li><li><p>多种消息传递协议，如JMS和OpenMessageing</p></li><li><p>灵活的分布式部署体系结构</p></li><li><p>闪电式批量信息交换系统</p></li><li><p>各种消息过滤机制，如SQL和Tag</p></li><li><p>用于独立测试和云隔离集群的Docker映像</p></li><li><p>功能丰富的管理仪表板，用于配置、度量和监视</p></li><li><p>身份验证和授权</p></li><li><p>免费开放源代码连接器，用于源和接收器</p></li></ul><h2 id="二、RocketMQ架构组成"><a href="#二、RocketMQ架构组成" class="headerlink" title="二、RocketMQ架构组成"></a>二、RocketMQ架构组成</h2><h3 id="2-1-集群组成"><a href="#2-1-集群组成" class="headerlink" title="2.1 集群组成"></a>2.1 集群组成</h3><p>RocketMQ部署结构如下图所示：</p><p><img src="/2021/01/11/rocketmq-ji-qun-yuan-li-ji-bu-shu-fang-shi/%E5%9B%BE%E7%89%871.png" alt="图片1"></p><p>从中间件服务角度来看整个RocketMQ消息系统（服务端）主要分为：<strong>NameServer和Broker</strong>两个部分。</p><h4 id="2-1-1-NameServer"><a href="#2-1-1-NameServer" class="headerlink" title="2.1.1 NameServer"></a>2.1.1 NameServer</h4><blockquote><p>提供服务发现和注册，这里主要是管理Broker，NameServer接受来自Broker的注册，并通过心跳机制来检测Broker服务的健康性；</p><p>提供路由功能，集群(这里是指以集群方式部署的NameServer)中的每个NameServer都保存了Broker集群(这里是指以集群方式部署的Broker)中整个的路由信息和队列信息。这里需要注意，在NameServer集群中，每个NameServer都是相互独立的，所以每个Broker需要连接所有的NameServer，每创建一个新的topic都要同步到所有的NameServer上。</p></blockquote><p><strong>NameServer</strong>是一个功能齐全的服务器，其角色类似Dubbo中的Zookeeper，但NameServer与Zookeeper相比更轻量。主要是因为每个NameServer节点互相之间是独立的，没有任何信息交互。</p><p><strong>NameServer</strong>压力不会太大，平时主要开销是在维持心跳和提供Topic-Broker的关系数据。<br>但有一点需要注意，Broker向NameServer发心跳时， 会带上当前自己所负责的所有<strong>Topic</strong>信息，如果<strong>Topic</strong>个数太多（万级别），会导致一次心跳中，就Topic的数据就几十M，网络情况差的话， 网络传输失败，心跳失败，导致NameServer误认为Broker心跳失败。</p><p><strong>NameServer</strong> 被设计成几乎无状态的，可以横向扩展，节点之间相互之间无通信，通过部署多台机器来标记自己是一个伪集群。</p><p>每个 Broker 在启动的时候会到 NameServer 注册，Producer 在发送消息前会根据 Topic 到 <strong>NameServer</strong> 获取到 Broker 的路由信息，Consumer 也会定时获取 Topic 的路由信息。</p><h4 id="2-1-2-Broker"><a href="#2-1-2-Broker" class="headerlink" title="2.1.2 Broker"></a>2.1.2 Broker</h4><blockquote><p>负责消息的存储、传递、查询以及高可用(HA)保证等。其由如下几个子模块（源码总体上也是这么拆分的）构成：</p><p>Remoting Module：整个Broker的实体，负责处理来自clients端的请求。<br>Client Manager：负责管理客户端(Producer/Consumer)和维护Consumer的Topic订阅信息<br>Store Service：提供方便简单的API接口处理消息存储到物理硬盘和查询功能。<br>HA Service：高可用服务，提供Master Broker 和 Slave Broker之间的数据同步功能。<br>Index Service：根据特定的Message key对投递到Broker的消息进行索引服务，以提供消息的快速查询。</p></blockquote><p><strong>Broker</strong>是具体提供业务的服务器，单个Broker节点与所有的NameServer节点保持长连接及心跳，并会定时将<strong>Topic</strong>信息注册到NameServer，顺带一提底层的通信和连接都是<strong>基于Netty实现</strong>的。</p><p><strong>Broker</strong>负责消息存储，以Topic为纬度支持轻量级的队列，单机可以支撑上万队列规模，支持消息推拉模型。</p><p>官网上有数据显示：具有<strong>上亿级消息堆积能力</strong>，同时可<strong>严格保证消息的有序性</strong>。</p><p>而从客户端的角度看主要有：<strong>Producer、Consumer</strong>两个部分。</p><h4 id="2-1-3-Producer"><a href="#2-1-3-Producer" class="headerlink" title="2.1.3 Producer"></a>2.1.3 Producer</h4><blockquote><p>消息生产者，负责产生消息，一般由业务系统负责产生消息。</p></blockquote><p><strong>Producer</strong>由用户进行分布式部署，消息由<strong>Producer</strong>通过多种负载均衡模式发送到<strong>Broker</strong>集群，发送低延时，支持快速失败。</p><p><strong>RocketMQ</strong> 提供了三种方式发送消息：同步、异步和单向</p><ul><li><strong>同步发送</strong>：同步发送指消息发送方发出数据后会在收到接收方发回响应之后才发下一个数据包。一般用于重要通知消息，例如重要通知邮件、营销短信。</li><li><strong>异步发送</strong>：异步发送指发送方发出数据后，不等接收方发回响应，接着发送下个数据包，一般用于可能链路耗时较长而对响应时间敏感的业务场景，例如用户视频上传后通知启动转码服务。</li><li><strong>单向发送</strong>：单向发送是指只负责发送消息而不等待服务器回应且没有回调函数触发，适用于某些耗时非常短但对可靠性要求并不高的场景，例如日志收集。</li></ul><h4 id="2-1-4-Consumer"><a href="#2-1-4-Consumer" class="headerlink" title="2.1.4 Consumer"></a>2.1.4 Consumer</h4><blockquote><p>消息消费者，负责消费消息，一般是后台系统负责异步消费。</p></blockquote><p><strong>Consumer</strong>也由用户部署，支持以push推，pull拉两种模式对消息进行消费。同时也支持集群方式和广播方式的消费，它提供实时消息订阅机制，可以满足大多数用户的需求。</p><p><strong>Pull</strong>：拉取型消费者（Pull Consumer）主动从消息服务器拉取信息，只要批量拉取到消息，用户应用就会启动消费过程，所以 Pull 称为主动消费型。</p><p><strong>Push</strong>：推送型消费者（Push Consumer）封装了消息的拉取、消费进度和其他的内部维护工作，将消息到达时执行的回调接口留给用户应用程序来实现。所以 Push 称为被动消费类型，但从实现上看还是从消息服务器中拉取消息，不同于 Pull 的是 Push 首先要注册消费监听器，当监听器处触发后才开始消费消息。</p><h3 id="2-2-消息领域模型"><a href="#2-2-消息领域模型" class="headerlink" title="2.2 消息领域模型"></a>2.2 消息领域模型</h3><p><img src="/2021/01/11/rocketmq-ji-qun-yuan-li-ji-bu-shu-fang-shi/%E5%9B%BE%E7%89%872.png" alt="图片2"></p><h4 id="2-2-1-Message"><a href="#2-2-1-Message" class="headerlink" title="2.2.1 Message"></a>2.2.1 Message</h4><p><strong>Message</strong>（消息）就是要传输的信息。</p><p>一条消息必须有一个主题（Topic），主题可以看做是你的信件要邮寄的地址。<br>一条消息也可以拥有一个可选的标签（Tag）和额处的键值对，它们可以用于设置一个业务 Key 并在 Broker 上查找此消息以便在开发期间查找问题。</p><h4 id="2-2-2-Topic"><a href="#2-2-2-Topic" class="headerlink" title="2.2.2 Topic"></a>2.2.2 Topic</h4><p><strong>Topic</strong>（主题）可以看做消息的规类，它是消息的第一级类型。比如一个电商系统可以分为：交易消息、物流消息等，一条消息必须有一个 Topic 。</p><p><strong>Topic</strong> 与生产者和消费者的关系非常松散，一个 Topic 可以有0个、1个、多个生产者向其发送消息，一个生产者也可以同时向不同的 Topic 发送消息。一个 Topic 也可以被 0个、1个、多个消费者订阅。</p><h4 id="2-2-3-Tag"><a href="#2-2-3-Tag" class="headerlink" title="2.2.3 Tag"></a>2.2.3 Tag</h4><p><strong>Tag</strong>（标签）可以看作子主题，它是消息的第二级类型，用于为用户提供额外的灵活性。使用标签，同一业务模块不同目的的消息就可以用相同 Topic 而不同的 <strong>Tag</strong> 来标识。比如交易消息又可以分为：交易创建消息、交易完成消息等，一条消息可以没有 <strong>Tag</strong> 。</p><p>标签有助于保持您的代码干净和连贯，并且还可以为 <strong>RocketMQ</strong> 提供的查询系统提供帮助。</p><h4 id="2-2-4-Group"><a href="#2-2-4-Group" class="headerlink" title="2.2.4 Group"></a>2.2.4 Group</h4><p>分组，一个组可以订阅多个Topic。<br>分为ProducerGroup，ConsumerGroup，代表某一类的生产者和消费者，一般来说同一个服务可以作为Group，同一个Group一般来说发送和消费的消息都是一样的</p><h4 id="2-2-5-Queue"><a href="#2-2-5-Queue" class="headerlink" title="2.2.5 Queue"></a>2.2.5 Queue</h4><p>在<strong>Kafka</strong>中叫Partition，每个Queue内部是有序的，在<strong>RocketMQ</strong>中分为读和写两种队列，一般来说读写队列数量一致，如果不一致就会出现很多问题。</p><h4 id="Message-Queue"><a href="#Message-Queue" class="headerlink" title="Message Queue"></a>Message Queue</h4><p><strong>Message Queue</strong>（消息队列），主题被划分为一个或多个子主题，即消息队列。</p><p>一个 Topic 下可以设置多个消息队列，发送消息时执行该消息的 Topic ，RocketMQ 会轮询该 Topic 下的所有队列将消息发出去。<br>一个Topic下可以有多个Queue，Queue的引入使得消息的存储可以分布式集群化，具有了水平扩展能力。</p><h4 id="2-2-6-Offset"><a href="#2-2-6-Offset" class="headerlink" title="2.2.6 Offset"></a>2.2.6 Offset</h4><p>在<strong>RocketMQ</strong> 中，所有消息队列都是持久化，长度无限的数据结构，所谓长度无限是指队列中的每个存储单元都是定长，访问其中的存储单元使用Offset 来访问，Offset 为 java long 类型，64 位，理论上在 100年内不会溢出，所以认为是长度无限。</p><p>也可以认为 Message Queue 是一个长度无限的数组，<strong>Offset</strong> 就是下标。</p><h3 id="2-3-消息消费模式"><a href="#2-3-消息消费模式" class="headerlink" title="2.3 消息消费模式"></a>2.3 消息消费模式</h3><p>消息消费模式有两种：<strong>Clustering</strong>（集群消费）和<strong>Broadcasting</strong>（广播消费）。</p><p>默认情况下就是集群消费，该模式下一个消费者集群共同消费一个主题的多个队列，一个队列只会被一个消费者消费，如果某个消费者挂掉，分组内其它消费者会接替挂掉的消费者继续消费。</p><p>而广播消费消息会发给消费者组中的每一个消费者进行消费。</p><h3 id="2-4-Message-Order"><a href="#2-4-Message-Order" class="headerlink" title="2.4 Message Order"></a>2.4 Message Order</h3><p><strong>Message Order</strong>（消息顺序）有两种：<strong>Orderly</strong>（顺序消费）和<strong>Concurrently</strong>（并行消费）。</p><p>顺序消费表示消息消费的顺序同生产者为每个消息队列发送的顺序一致，所以如果正在处理全局顺序是强制性的场景，需要确保使用的主题只有一个消息队列。</p><p>并行消费不再保证消息顺序，消费的最大并行数量受每个消费者客户端指定的线程池限制。</p><h2 id="三、RocketMQ集群模式"><a href="#三、RocketMQ集群模式" class="headerlink" title="三、RocketMQ集群模式"></a>三、RocketMQ集群模式</h2><p><strong>编译源码包</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[admin@rocketmq1 ~]$ wget https://github.com/apache/rocketmq/archive/rocketmq-all-4.8.0.tar.gz</span><br><span class="line">[admin@rocketmq1 ~]$ <span class="built_in">cd</span> rocketmq-rocketmq-all-4.8.0/</span><br><span class="line">[admin@rocketmq1 rocketmq-rocketmq-all-4.8.0]$ mvn -Prelease-all -DskipTests clean install -U</span><br></pre></td></tr></table></figure><p><strong>编译后产物所在目录</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[admin@rocketmq1 rocketmq-rocketmq-all-4.8.0]$ ls distribution/target/rocketmq-4.8.0/rocketmq-4.8.0/</span><br><span class="line">benchmark  bin  conf  lib  LICENSE  NOTICE  README.md</span><br></pre></td></tr></table></figure><p><strong>拷贝到工作目录下</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[admin@rocketmq2 rocketmq-4.8.0]$ cp -rf distribution/target/rocketmq-4.8.0/rocketmq-4.8.0/ ~/rocketmq</span><br></pre></td></tr></table></figure><p><strong>安装jdk 1.8</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[admin@rocketmq1 ~]$ wget --no-cookies --no-check-certificate --header <span class="string">"Cookie: gpw_e24=http%3A%2F%2Fwww.oracle.com%2F; oraclelicense=accept-securebackup-cookie"</span> <span class="string">"http://download.oracle.com/otn-pub/java/jdk/8u141-b15/336fa29ff2bb4ef291e347e091f7f4a7/jdk-8u141-linux-x64.tar.gz"</span></span><br><span class="line"> </span><br><span class="line">[admin@rocketmq1 ~]$ tar xzf jdk-8u141-linux-x64.tar.gz</span><br><span class="line">[admin@rocketmq1 ~]$ sudo vim /etc/profile</span><br><span class="line"><span class="built_in">export</span> JAVA_HOME=/work/admin/jdk-8u141-linux</span><br><span class="line"><span class="built_in">export</span> JRE_HOME=<span class="variable">$&#123;JAVA_HOME&#125;</span>/jre</span><br><span class="line"><span class="built_in">export</span> CLASSPATH=.:<span class="variable">$&#123;JAVA_HOME&#125;</span>/lib:<span class="variable">$&#123;JRE_HOME&#125;</span>/lib</span><br><span class="line"><span class="built_in">export</span> PATH=<span class="variable">$&#123;JAVA_HOME&#125;</span>/bin:<span class="variable">$PATH</span></span><br><span class="line"></span><br><span class="line">[admin@rocketmq1 ~]$ <span class="built_in">source</span> /etc/profile</span><br></pre></td></tr></table></figure><h3 id="3-1-单Master模式"><a href="#3-1-单Master模式" class="headerlink" title="3.1 单Master模式"></a>3.1 单Master模式</h3><p>这种方式风险较大，一旦Broker重启或者宕机时，会导致整个服务不可用。不建议线上环境使用,可以用于本地测试。</p><p><strong>环境如下：</strong></p><table><thead><tr><th>主机</th><th>IP地址</th><th>组件划分</th></tr></thead><tbody><tr><td>rocketmq1</td><td>192.168.10.76</td><td>Nameserver、Broker</td></tr></tbody></table><h4 id="3-1-1-启动nameserver"><a href="#3-1-1-启动nameserver" class="headerlink" title="3.1.1 启动nameserver"></a>3.1.1 启动nameserver</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[admin@rocketmq1 ~]$ <span class="built_in">cd</span> rocketmq-4.8.0/</span><br><span class="line">[admin@rocketmq1 rocketmq-4.8.0]$ nohup bash bin/mqnamesrv &amp;</span><br></pre></td></tr></table></figure><h4 id="3-1-2-启动broker"><a href="#3-1-2-启动broker" class="headerlink" title="3.1.2 启动broker"></a>3.1.2 启动broker</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[admin@rocketmq1 rocketmq-4.8.0]$ nohup bash bin/mqbroker -n 127.0.0.1:9876 autoCreateTopicEnable=<span class="literal">true</span> -c conf/broker.conf &amp;</span><br></pre></td></tr></table></figure><p>内存不够的话可以修改<code>bin/runserver.sh</code>和<code>bin/runbroker.sh</code>适当降低内存限制。</p><h4 id="3-1-3-看是否启动成功"><a href="#3-1-3-看是否启动成功" class="headerlink" title="3.1.3 看是否启动成功"></a>3.1.3 看是否启动成功</h4><p>通过jps命令查看是否启动成功</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[admin@rocketmq1 rocketmq-4.8.0]$ jps</span><br><span class="line">2272 Jps</span><br><span class="line">2213 NamesrvStartup</span><br><span class="line">2254 BrokerStartup</span><br></pre></td></tr></table></figure><h3 id="3-2-多Master模式"><a href="#3-2-多Master模式" class="headerlink" title="3.2 多Master模式"></a>3.2 多Master模式</h3><p>一个集群无Slave，全是Master，例如2个Master或者3个Master，这种模式的优缺点如下：</p><ul><li><p>优点：配置简单，单个Master宕机或重启维护对应用无影响，在磁盘配置为RAID10时，即使机器宕机不可恢复情况下，由于RAID10磁盘非常可靠，消息也不会丢（异步刷盘丢失少量消息，同步刷盘一条不丢），性能最高；</p></li><li><p>缺点：单台机器宕机期间，这台机器上未被消费的消息在机器恢复之前不可订阅，消息实时性会受到影响。</p></li></ul><p><strong>环境如下：</strong></p><table><thead><tr><th>主机</th><th>IP地址</th><th>组件划分</th></tr></thead><tbody><tr><td>rocketmq1</td><td>192.168.10.76</td><td>Nameserver1、Broker_Master-1</td></tr><tr><td>rocketmq2</td><td>192.168.10.77</td><td>Nameserver2、Broker_Master-2</td></tr></tbody></table><h4 id="3-2-1-创建目录修改配置"><a href="#3-2-1-创建目录修改配置" class="headerlink" title="3.2.1 创建目录修改配置"></a>3.2.1 创建目录修改配置</h4><p><strong>创建数据目录</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#在各服务器执行以下命令创建数据目录</span></span><br><span class="line"></span><br><span class="line">[admin@rocketmq1 rocketmq]$ mkdir -p /home/admin/rocketmq/data/store</span><br><span class="line">[admin@rocketmq1 rocketmq]$ mkdir -p /home/admin/rocketmq/data/store/commitlog</span><br><span class="line">[admin@rocketmq1 rocketmq]$ mkdir -p /home/admin/rocketmq/data/store/consumequeue</span><br><span class="line">[admin@rocketmq1 rocketmq]$ mkdir -p /home/admin/rocketmq/data/store/index</span><br></pre></td></tr></table></figure><p><strong>修改日志路径</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#在各服务器执行以下命令修改日志存储路径</span></span><br><span class="line"></span><br><span class="line">[admin@rocketmq1 rocketmq]$ sed -i  <span class="string">'s#$&#123;user.home&#125;#/home/admin/rocketmq/data#g'</span> conf/*.xml</span><br></pre></td></tr></table></figure><p><strong>配置rocketmq</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#配置Broker_Master-1</span></span><br><span class="line"></span><br><span class="line">[admin@rocketmq1 rocketmq]$ cat conf/2m-noslave/broker-a.properties</span><br><span class="line">brokerClusterName=rocketmq-2m-noslave-cluster</span><br><span class="line">brokerName=rocketmq-broker-m1</span><br><span class="line">brokerId=0</span><br><span class="line">namesrvAddr=192.168.10.76:9876;192.168.10.77:9876</span><br><span class="line">defaultTopicQueueNums=4</span><br><span class="line">autoCreateTopicEnable=<span class="literal">true</span></span><br><span class="line">autoCreateSubscriptionGroup=<span class="literal">true</span></span><br><span class="line">listenPort=10911</span><br><span class="line">deleteWhen=04</span><br><span class="line">fileReservedTime=120</span><br><span class="line">mapedFileSizeCommitLog=1073741824</span><br><span class="line">mapedFileSizeConsumeQueue=50000000</span><br><span class="line">destroyMapedFileIntervalForcibly=120000</span><br><span class="line">redeleteHangedFileInterval=120000</span><br><span class="line">diskMaxUsedSpaceRatio=88</span><br><span class="line">maxMessageSize=65536</span><br><span class="line">sendMessageThreadPoolNums=128</span><br><span class="line">pullMessageThreadPoolNums=128</span><br><span class="line">storePathRootDir=/home/admin/rocketmq/data/store</span><br><span class="line">storePathCommitLog=/home/admin/rocketmq/data/store/commitlog</span><br><span class="line">storePathConsumeQueue=/home/admin/rocketmq/data/store/consumequeue</span><br><span class="line">storePathIndex=/home/admin/rocketmq/data/store/index</span><br><span class="line">storeCheckpoint=/home/admin/rocketmq/data/store/checkpoint</span><br><span class="line">abortFile=/home/admin/rocketmq/data/store/abort</span><br><span class="line">brokerRole=ASYNC_MASTER</span><br><span class="line">flushDiskType=ASYNC_FLUSH</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#配置Broker_Master-2</span></span><br><span class="line"></span><br><span class="line">[admin@rocketmq2 rocketmq]$ cat conf/2m-noslave/broker-b.properties</span><br><span class="line">brokerClusterName=rocketmq-2m-noslave-cluster</span><br><span class="line">brokerName=rocketmq-broker-m2</span><br><span class="line">brokerId=0</span><br><span class="line">namesrvAddr=192.168.10.76:9876;192.168.10.77:9876</span><br><span class="line">defaultTopicQueueNums=4</span><br><span class="line">autoCreateTopicEnable=<span class="literal">true</span></span><br><span class="line">autoCreateSubscriptionGroup=<span class="literal">true</span></span><br><span class="line">listenPort=10911</span><br><span class="line">deleteWhen=04</span><br><span class="line">fileReservedTime=120</span><br><span class="line">mapedFileSizeCommitLog=1073741824</span><br><span class="line">mapedFileSizeConsumeQueue=50000000</span><br><span class="line">destroyMapedFileIntervalForcibly=120000</span><br><span class="line">redeleteHangedFileInterval=120000</span><br><span class="line">diskMaxUsedSpaceRatio=88</span><br><span class="line">maxMessageSize=65536</span><br><span class="line">sendMessageThreadPoolNums=128</span><br><span class="line">pullMessageThreadPoolNums=128</span><br><span class="line">storePathRootDir=/home/admin/rocketmq/data/store</span><br><span class="line">storePathCommitLog=/home/admin/rocketmq/data/store/commitlog</span><br><span class="line">storePathConsumeQueue=/home/admin/rocketmq/data/store/consumequeue</span><br><span class="line">storePathIndex=/home/admin/rocketmq/data/store/index</span><br><span class="line">storeCheckpoint=/home/admin/rocketmq/data/store/checkpoint</span><br><span class="line">abortFile=/home/admin/rocketmq/data/store/abort</span><br><span class="line">brokerRole=ASYNC_MASTER</span><br><span class="line">flushDiskType=ASYNC_FLUSH</span><br></pre></td></tr></table></figure><h4 id="3-2-2-启动NameServer"><a href="#3-2-2-启动NameServer" class="headerlink" title="3.2.2 启动NameServer"></a>3.2.2 启动NameServer</h4><p>NameServer需要先于Broker启动，且如果在生产环境使用，为了保证高可用，建议一般规模的集群启动3个NameServer，各节点的启动命令相同，如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#启动Nameserver1</span></span><br><span class="line">[admin@rocketmq1 rocketmq]$ nohup bash bin/mqnamesrv &amp;</span><br><span class="line"></span><br><span class="line"><span class="comment">#启动Nameserver2</span></span><br><span class="line">[admin@rocketmq2 rocketmq]$ nohup bash bin/mqnamesrv &amp;</span><br></pre></td></tr></table></figure><h4 id="3-2-3-启动Broker"><a href="#3-2-3-启动Broker" class="headerlink" title="3.2.3 启动Broker"></a>3.2.3 启动Broker</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#启动Broker_Master-1</span></span><br><span class="line">[admin@rocketmq1 rocketmq]$ nohup bash bin/mqbroker -c conf/2m-noslave/broker-a.properties &amp;</span><br><span class="line"></span><br><span class="line"><span class="comment">#启动Broker_Master-2</span></span><br><span class="line">[admin@rocketmq2 rocketmq]$ nohup bash bin/mqbroker -c conf/2m-noslave/broker-b.properties &amp;</span><br></pre></td></tr></table></figure><h4 id="3-2-4-关闭服务"><a href="#3-2-4-关闭服务" class="headerlink" title="3.2.4 关闭服务"></a>3.2.4 关闭服务</h4><p><strong>关闭NameServer</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[admin@rocketmq1 rocketmq]$ bash bin/mqshutdown namesrv</span><br></pre></td></tr></table></figure><p><strong>关闭Broker</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"> [admin@rocketmq1 rocketmq]$ bash bin/mqshutdown broker</span><br></pre></td></tr></table></figure><h3 id="3-3-多Master多Slave模式-异步复制"><a href="#3-3-多Master多Slave模式-异步复制" class="headerlink" title="3.3 多Master多Slave模式-异步复制"></a>3.3 多Master多Slave模式-异步复制</h3><p>每个Master配置一个Slave，有多对Master-Slave，HA采用异步复制方式，主备有短暂消息延迟（毫秒级），这种模式的优缺点如下：</p><ul><li>优点：即使磁盘损坏，消息丢失的非常少，且消息实时性不会受影响，同时Master宕机后，消费者仍然可以从Slave消费，而且此过程对应用透明，不需要人工干预，性能同多Master模式几乎一样；</li><li>缺点：Master宕机，磁盘损坏情况下会丢失少量消息。</li></ul><p><strong>环境如下：</strong></p><table><thead><tr><th>主机</th><th>IP地址</th><th>组件划分</th></tr></thead><tbody><tr><td>rocketmq1</td><td>192.168.10.76</td><td>Nameserver1、Broker_Master-1</td></tr><tr><td>rocketmq2</td><td>192.168.10.77</td><td>Nameserver2、Broker_Master-2</td></tr><tr><td>rocketmq3</td><td>192.168.10.78</td><td>Nameserver3、Broker_Master_slave-1</td></tr><tr><td>rocketmq4</td><td>192.168.10.79</td><td>Nameserver4、Broker_Master_slave-2</td></tr></tbody></table><h4 id="3-3-1-创建目录修改配置"><a href="#3-3-1-创建目录修改配置" class="headerlink" title="3.3.1 创建目录修改配置"></a>3.3.1 创建目录修改配置</h4><p><strong>创建数据目录</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#在各服务器执行以下命令创建数据目录</span></span><br><span class="line"></span><br><span class="line">[admin@rocketmq1 rocketmq]$ mkdir -p /home/admin/rocketmq/data/store</span><br><span class="line">[admin@rocketmq1 rocketmq]$ mkdir -p /home/admin/rocketmq/data/store/commitlog</span><br><span class="line">[admin@rocketmq1 rocketmq]$ mkdir -p /home/admin/rocketmq/data/store/consumequeue</span><br><span class="line">[admin@rocketmq1 rocketmq]$ mkdir -p /home/admin/rocketmq/data/store/index</span><br></pre></td></tr></table></figure><p><strong>修改日志路径</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#在各服务器执行以下命令修改日志存储路径</span></span><br><span class="line"></span><br><span class="line">[admin@rocketmq1 rocketmq]$ sed -i  <span class="string">'s#$&#123;user.home&#125;#/home/admin/rocketmq/data#g'</span> conf/*.xml</span><br></pre></td></tr></table></figure><p><strong>配置rocketmq</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#配置Broker_Master-1</span></span><br><span class="line"></span><br><span class="line">[admin@rocketmq1 rocketmq]$ cat conf/2m-2s-async/broker-a.properties</span><br><span class="line">brokerClusterName=rocketmq-2m-slave-cluster-async</span><br><span class="line">brokerName=rocketmq-broker-m1</span><br><span class="line">brokerId=0</span><br><span class="line">namesrvAddr=192.168.10.76:9876;192.168.10.77:9876;192.168.10.78:9876;192.168.10.79:9876</span><br><span class="line">defaultTopicQueueNums=4</span><br><span class="line">autoCreateTopicEnable=<span class="literal">true</span></span><br><span class="line">autoCreateSubscriptionGroup=<span class="literal">true</span></span><br><span class="line">listenPort=10911</span><br><span class="line">deleteWhen=04</span><br><span class="line">fileReservedTime=120</span><br><span class="line">mapedFileSizeCommitLog=1073741824</span><br><span class="line">mapedFileSizeConsumeQueue=50000000</span><br><span class="line">destroyMapedFileIntervalForcibly=120000</span><br><span class="line">redeleteHangedFileInterval=120000</span><br><span class="line">diskMaxUsedSpaceRatio=88</span><br><span class="line">maxMessageSize=65536</span><br><span class="line">sendMessageThreadPoolNums=128</span><br><span class="line">pullMessageThreadPoolNums=128</span><br><span class="line">storePathRootDir=/home/admin/rocketmq/data/store</span><br><span class="line">storePathCommitLog=/home/admin/rocketmq/data/store/commitlog</span><br><span class="line">storePathConsumeQueue=/home/admin/rocketmq/data/store/consumequeue</span><br><span class="line">storePathIndex=/home/admin/rocketmq/data/store/index</span><br><span class="line">storeCheckpoint=/home/admin/rocketmq/data/store/checkpoint</span><br><span class="line">abortFile=/home/admin/rocketmq/data/store/abort</span><br><span class="line">brokerRole=ASYNC_MASTER</span><br><span class="line">flushDiskType=ASYNC_FLUSH</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#配置Broker_Master-2</span></span><br><span class="line"></span><br><span class="line">[admin@rocketmq2 rocketmq]$ cat conf/2m-2s-async/broker-b.properties</span><br><span class="line">brokerClusterName=rocketmq-2m-slave-cluster-async</span><br><span class="line">brokerName=rocketmq-broker-m2</span><br><span class="line">brokerId=0</span><br><span class="line">namesrvAddr=192.168.10.76:9876;192.168.10.77:9876;192.168.10.78:9876;192.168.10.79:9876</span><br><span class="line">defaultTopicQueueNums=4</span><br><span class="line">autoCreateTopicEnable=<span class="literal">true</span></span><br><span class="line">autoCreateSubscriptionGroup=<span class="literal">true</span></span><br><span class="line">listenPort=10911</span><br><span class="line">deleteWhen=04</span><br><span class="line">fileReservedTime=120</span><br><span class="line">mapedFileSizeCommitLog=1073741824</span><br><span class="line">mapedFileSizeConsumeQueue=50000000</span><br><span class="line">destroyMapedFileIntervalForcibly=120000</span><br><span class="line">redeleteHangedFileInterval=120000</span><br><span class="line">diskMaxUsedSpaceRatio=88</span><br><span class="line">maxMessageSize=65536</span><br><span class="line">sendMessageThreadPoolNums=128</span><br><span class="line">pullMessageThreadPoolNums=128</span><br><span class="line">storePathRootDir=/home/admin/rocketmq/data/store</span><br><span class="line">storePathCommitLog=/home/admin/rocketmq/data/store/commitlog</span><br><span class="line">storePathConsumeQueue=/home/admin/rocketmq/data/store/consumequeue</span><br><span class="line">storePathIndex=/home/admin/rocketmq/data/store/index</span><br><span class="line">storeCheckpoint=/home/admin/rocketmq/data/store/checkpoint</span><br><span class="line">abortFile=/home/admin/rocketmq/data/store/abort</span><br><span class="line">brokerRole=ASYNC_MASTER</span><br><span class="line">flushDiskType=ASYNC_FLUSH</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#配置Broker_Master_slave-1</span></span><br><span class="line"></span><br><span class="line">[admin@rocketmq3 rocketmq]$ cat conf/2m-2s-async/broker<span class="_">-a</span>-s.properties</span><br><span class="line">brokerClusterName=rocketmq-2m-slave-cluster-async</span><br><span class="line">brokerName=rocketmq-broker-m1</span><br><span class="line">brokerId=1</span><br><span class="line">namesrvAddr=192.168.10.76:9876;192.168.10.77:9876;192.168.10.78:9876;192.168.10.79:9876</span><br><span class="line">defaultTopicQueueNums=4</span><br><span class="line">autoCreateTopicEnable=<span class="literal">true</span></span><br><span class="line">autoCreateSubscriptionGroup=<span class="literal">true</span></span><br><span class="line">listenPort=10911</span><br><span class="line">deleteWhen=04</span><br><span class="line">fileReservedTime=120</span><br><span class="line">mapedFileSizeCommitLog=1073741824</span><br><span class="line">mapedFileSizeConsumeQueue=50000000</span><br><span class="line">destroyMapedFileIntervalForcibly=120000</span><br><span class="line">redeleteHangedFileInterval=120000</span><br><span class="line">diskMaxUsedSpaceRatio=88</span><br><span class="line">maxMessageSize=65536</span><br><span class="line">sendMessageThreadPoolNums=128</span><br><span class="line">pullMessageThreadPoolNums=128</span><br><span class="line">storePathRootDir=/home/admin/rocketmq/data/store</span><br><span class="line">storePathCommitLog=/home/admin/rocketmq/data/store/commitlog</span><br><span class="line">storePathConsumeQueue=/home/admin/rocketmq/data/store/consumequeue</span><br><span class="line">storePathIndex=/home/admin/rocketmq/data/store/index</span><br><span class="line">storeCheckpoint=/home/admin/rocketmq/data/store/checkpoint</span><br><span class="line">abortFile=/home/admin/rocketmq/data/store/abort</span><br><span class="line">brokerRole=SLAVE</span><br><span class="line">flushDiskType=ASYNC_FLUSH</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#配置Broker_Master_slave-2</span></span><br><span class="line"></span><br><span class="line">[admin@rocketmq3 rocketmq]$ cat conf/2m-2s-async/broker-b-s.properties</span><br><span class="line">brokerClusterName=rocketmq-2m-slave-cluster-async</span><br><span class="line">brokerName=rocketmq-broker-m2</span><br><span class="line">brokerId=1</span><br><span class="line">namesrvAddr=192.168.10.76:9876;192.168.10.77:9876;192.168.10.78:9876;192.168.10.79:9876</span><br><span class="line">defaultTopicQueueNums=4</span><br><span class="line">autoCreateTopicEnable=<span class="literal">true</span></span><br><span class="line">autoCreateSubscriptionGroup=<span class="literal">true</span></span><br><span class="line">listenPort=10911</span><br><span class="line">deleteWhen=04</span><br><span class="line">fileReservedTime=120</span><br><span class="line">mapedFileSizeCommitLog=1073741824</span><br><span class="line">mapedFileSizeConsumeQueue=50000000</span><br><span class="line">destroyMapedFileIntervalForcibly=120000</span><br><span class="line">redeleteHangedFileInterval=120000</span><br><span class="line">diskMaxUsedSpaceRatio=88</span><br><span class="line">maxMessageSize=65536</span><br><span class="line">sendMessageThreadPoolNums=128</span><br><span class="line">pullMessageThreadPoolNums=128</span><br><span class="line">storePathRootDir=/home/admin/rocketmq/data/store1</span><br><span class="line">storePathCommitLog=/home/admin/rocketmq/data/store/commitlog1</span><br><span class="line">storePathConsumeQueue=/home/admin/rocketmq/data/store/consumequeue1</span><br><span class="line">storePathIndex=/home/admin/rocketmq/data/store/index1</span><br><span class="line">storeCheckpoint=/home/admin/rocketmq/data/store/checkpoint1</span><br><span class="line">abortFile=/home/admin/rocketmq/data/store/abort1</span><br><span class="line">brokerRole=SLAVE</span><br><span class="line">flushDiskType=ASYNC_FLUSH</span><br></pre></td></tr></table></figure><h4 id="3-3-2-启动NameServer"><a href="#3-3-2-启动NameServer" class="headerlink" title="3.3.2 启动NameServer"></a>3.3.2 启动NameServer</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#启动Nameserver1</span></span><br><span class="line">[admin@rocketmq1 rocketmq]$ nohup bash bin/mqnamesrv &amp;</span><br><span class="line"></span><br><span class="line"><span class="comment">#启动Nameserver2</span></span><br><span class="line">[admin@rocketmq2 rocketmq]$ nohup bash bin/mqnamesrv &amp;</span><br><span class="line"></span><br><span class="line"><span class="comment">#启动Nameserver3</span></span><br><span class="line">[admin@rocketmq3 rocketmq]$ nohup bash bin/mqnamesrv &amp;</span><br><span class="line"></span><br><span class="line"><span class="comment">#启动Nameserver4</span></span><br><span class="line">[admin@rocketmq4 rocketmq]$ nohup bash bin/mqnamesrv &amp;</span><br></pre></td></tr></table></figure><h4 id="3-3-3-启动Broker"><a href="#3-3-3-启动Broker" class="headerlink" title="3.3.3 启动Broker"></a>3.3.3 启动Broker</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#启动Broker_Master-1</span></span><br><span class="line">[admin@rocketmq1 rocketmq]$ nohup bash bin/mqbroker -c conf/2m-2s-async/broker-a.properties &amp;</span><br><span class="line"></span><br><span class="line"><span class="comment">#启动Broker_Master-2</span></span><br><span class="line">[admin@rocketmq2 rocketmq]$ nohup bash bin/mqbroker -c conf/2m-2s-async/broker-b.properties &amp;</span><br><span class="line"></span><br><span class="line"><span class="comment">#启动Broker_Master_slave-1</span></span><br><span class="line">[admin@rocketmq3 rocketmq]$ nohup bash bin/mqbroker -c conf/2m-2s-async/broker<span class="_">-a</span>-s.properties &amp;</span><br><span class="line"></span><br><span class="line"><span class="comment">#启动Broker_Master_slave-2</span></span><br><span class="line">[admin@rocketmq4 rocketmq]$ nohup bash bin/mqbroker -c conf/2m-2s-async/broker-b-s.properties &amp;</span><br></pre></td></tr></table></figure><h4 id="3-3-4-关闭服务"><a href="#3-3-4-关闭服务" class="headerlink" title="3.3.4 关闭服务"></a>3.3.4 关闭服务</h4><p><strong>关闭NameServer</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[admin@rocketmq1 rocketmq]$ bash bin/mqshutdown namesrv</span><br></pre></td></tr></table></figure><p><strong>关闭Broker</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"> [admin@rocketmq1 rocketmq]$ bash bin/mqshutdown broker</span><br></pre></td></tr></table></figure><h3 id="3-4-多Master多Slave模式-同步双写"><a href="#3-4-多Master多Slave模式-同步双写" class="headerlink" title="3.4 多Master多Slave模式-同步双写"></a>3.4 多Master多Slave模式-同步双写</h3><p>每个Master配置一个Slave，有多对Master-Slave，HA采用同步双写方式，即只有主备都写成功，才向应用返回成功，这种模式的优缺点如下：</p><ul><li>优点：数据与服务都无单点故障，Master宕机情况下，消息无延迟，服务可用性与数据可用性都非常高；</li><li>缺点：性能比异步复制模式略低（大约低10%左右），发送单个消息的RT会略高，且目前版本在主节点宕机后，备机不能自动切换为主机。</li></ul><p><strong>环境如下：</strong></p><table><thead><tr><th>主机</th><th>IP地址</th><th>组件划分</th></tr></thead><tbody><tr><td>rocketmq1</td><td>192.168.10.76</td><td>Nameserver1、Broker_Master-1</td></tr><tr><td>rocketmq2</td><td>192.168.10.77</td><td>Nameserver2、Broker_Master-2</td></tr><tr><td>rocketmq3</td><td>192.168.10.78</td><td>Nameserver3、Broker_Master_slave-1</td></tr><tr><td>rocketmq4</td><td>192.168.10.79</td><td>Nameserver4、Broker_Master_slave-2</td></tr></tbody></table><h4 id="3-2-1-创建目录修改配置-1"><a href="#3-2-1-创建目录修改配置-1" class="headerlink" title="3.2.1 创建目录修改配置"></a>3.2.1 创建目录修改配置</h4><p><strong>创建数据目录</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#在各服务器执行以下命令创建数据目录</span></span><br><span class="line"></span><br><span class="line">[admin@rocketmq1 rocketmq]$ mkdir -p /home/admin/rocketmq/data/store</span><br><span class="line">[admin@rocketmq1 rocketmq]$ mkdir -p /home/admin/rocketmq/data/store/commitlog</span><br><span class="line">[admin@rocketmq1 rocketmq]$ mkdir -p /home/admin/rocketmq/data/store/consumequeue</span><br><span class="line">[admin@rocketmq1 rocketmq]$ mkdir -p /home/admin/rocketmq/data/store/index</span><br></pre></td></tr></table></figure><p><strong>修改日志路径</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#在各服务器执行以下命令修改日志存储路径</span></span><br><span class="line"></span><br><span class="line">[admin@rocketmq1 rocketmq]$ sed -i  <span class="string">'s#$&#123;user.home&#125;#/home/admin/rocketmq/data#g'</span> conf/*.xml</span><br></pre></td></tr></table></figure><p><strong>配置rocketmq</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#配置Broker_Master-1</span></span><br><span class="line"></span><br><span class="line">[admin@rocketmq1 rocketmq]$ cat conf/2m-2s-sync/broker-a.properties</span><br><span class="line">brokerClusterName=rocketmq-2m-slave-cluster-sync</span><br><span class="line">brokerName=rocketmq-broker-m1</span><br><span class="line">brokerId=0</span><br><span class="line">namesrvAddr=192.168.10.76:9876;192.168.10.77:9876;192.168.10.78:9876;192.168.10.79:9876</span><br><span class="line">defaultTopicQueueNums=4</span><br><span class="line">autoCreateTopicEnable=<span class="literal">true</span></span><br><span class="line">autoCreateSubscriptionGroup=<span class="literal">true</span></span><br><span class="line">listenPort=10911</span><br><span class="line">deleteWhen=04</span><br><span class="line">fileReservedTime=120</span><br><span class="line">mapedFileSizeCommitLog=1073741824</span><br><span class="line">mapedFileSizeConsumeQueue=50000000</span><br><span class="line">destroyMapedFileIntervalForcibly=120000</span><br><span class="line">redeleteHangedFileInterval=120000</span><br><span class="line">diskMaxUsedSpaceRatio=88</span><br><span class="line">maxMessageSize=65536</span><br><span class="line">sendMessageThreadPoolNums=128</span><br><span class="line">pullMessageThreadPoolNums=128</span><br><span class="line">storePathRootDir=/home/admin/rocketmq/data/store</span><br><span class="line">storePathCommitLog=/home/admin/rocketmq/data/store/commitlog</span><br><span class="line">storePathConsumeQueue=/home/admin/rocketmq/data/store/consumequeue</span><br><span class="line">storePathIndex=/home/admin/rocketmq/data/store/index</span><br><span class="line">storeCheckpoint=/home/admin/rocketmq/data/store/checkpoint</span><br><span class="line">abortFile=/home/admin/rocketmq/data/store/abort</span><br><span class="line">brokerRole=SYNC_MASTER</span><br><span class="line">flushDiskType=SYNC_FLUSH</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#配置Broker_Master-2</span></span><br><span class="line"></span><br><span class="line">[admin@rocketmq2 rocketmq]$ cat conf/2m-2s-sync/broker-b.properties</span><br><span class="line">brokerClusterName=rocketmq-2m-slave-cluster-sync</span><br><span class="line">brokerName=rocketmq-broker-m2</span><br><span class="line">brokerId=0</span><br><span class="line">namesrvAddr=192.168.10.76:9876;192.168.10.77:9876;192.168.10.78:9876;192.168.10.79:9876</span><br><span class="line">defaultTopicQueueNums=4</span><br><span class="line">autoCreateTopicEnable=<span class="literal">true</span></span><br><span class="line">autoCreateSubscriptionGroup=<span class="literal">true</span></span><br><span class="line">listenPort=10911</span><br><span class="line">deleteWhen=04</span><br><span class="line">fileReservedTime=120</span><br><span class="line">mapedFileSizeCommitLog=1073741824</span><br><span class="line">mapedFileSizeConsumeQueue=50000000</span><br><span class="line">destroyMapedFileIntervalForcibly=120000</span><br><span class="line">redeleteHangedFileInterval=120000</span><br><span class="line">diskMaxUsedSpaceRatio=88</span><br><span class="line">maxMessageSize=65536</span><br><span class="line">sendMessageThreadPoolNums=128</span><br><span class="line">pullMessageThreadPoolNums=128</span><br><span class="line">storePathRootDir=/home/admin/rocketmq/data/store</span><br><span class="line">storePathCommitLog=/home/admin/rocketmq/data/store/commitlog</span><br><span class="line">storePathConsumeQueue=/home/admin/rocketmq/data/store/consumequeue</span><br><span class="line">storePathIndex=/home/admin/rocketmq/data/store/index</span><br><span class="line">storeCheckpoint=/home/admin/rocketmq/data/store/checkpoint</span><br><span class="line">abortFile=/home/admin/rocketmq/data/store/abort</span><br><span class="line">brokerRole=SYNC_MASTER</span><br><span class="line">flushDiskType=SYNC_FLUSH</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#配置Broker_Master_slave-1</span></span><br><span class="line"></span><br><span class="line">[admin@rocketmq3 rocketmq]$ cat conf/2m-2s-sync/broker<span class="_">-a</span>-s.properties</span><br><span class="line">brokerClusterName=rocketmq-2m-slave-cluster-sync</span><br><span class="line">brokerName=rocketmq-broker-m1</span><br><span class="line">brokerId=1</span><br><span class="line">namesrvAddr=192.168.10.76:9876;192.168.10.77:9876;192.168.10.78:9876;192.168.10.79:9876</span><br><span class="line">defaultTopicQueueNums=4</span><br><span class="line">autoCreateTopicEnable=<span class="literal">true</span></span><br><span class="line">autoCreateSubscriptionGroup=<span class="literal">true</span></span><br><span class="line">listenPort=10911</span><br><span class="line">deleteWhen=04</span><br><span class="line">fileReservedTime=120</span><br><span class="line">mapedFileSizeCommitLog=1073741824</span><br><span class="line">mapedFileSizeConsumeQueue=50000000</span><br><span class="line">destroyMapedFileIntervalForcibly=120000</span><br><span class="line">redeleteHangedFileInterval=120000</span><br><span class="line">diskMaxUsedSpaceRatio=88</span><br><span class="line">maxMessageSize=65536</span><br><span class="line">sendMessageThreadPoolNums=128</span><br><span class="line">pullMessageThreadPoolNums=128</span><br><span class="line">storePathRootDir=/home/admin/rocketmq/data/store</span><br><span class="line">storePathCommitLog=/home/admin/rocketmq/data/store/commitlog</span><br><span class="line">storePathConsumeQueue=/home/admin/rocketmq/data/store/consumequeue</span><br><span class="line">storePathIndex=/home/admin/rocketmq/data/store/index</span><br><span class="line">storeCheckpoint=/home/admin/rocketmq/data/store/checkpoint</span><br><span class="line">abortFile=/home/admin/rocketmq/data/store/abort</span><br><span class="line">brokerRole=SLAVE</span><br><span class="line">flushDiskType=ASYNC_FLUSH</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#配置Broker_Master_slave-2</span></span><br><span class="line"></span><br><span class="line">[admin@rocketmq3 rocketmq]$ cat conf/2m-2s-sync/broker-b-s.properties</span><br><span class="line">brokerClusterName=rocketmq-2m-slave-cluster-sync</span><br><span class="line">brokerName=rocketmq-broker-m2</span><br><span class="line">brokerId=1</span><br><span class="line">namesrvAddr=192.168.10.76:9876;192.168.10.77:9876;192.168.10.78:9876;192.168.10.79:9876</span><br><span class="line">defaultTopicQueueNums=4</span><br><span class="line">autoCreateTopicEnable=<span class="literal">true</span></span><br><span class="line">autoCreateSubscriptionGroup=<span class="literal">true</span></span><br><span class="line">listenPort=10911</span><br><span class="line">deleteWhen=04</span><br><span class="line">fileReservedTime=120</span><br><span class="line">mapedFileSizeCommitLog=1073741824</span><br><span class="line">mapedFileSizeConsumeQueue=50000000</span><br><span class="line">destroyMapedFileIntervalForcibly=120000</span><br><span class="line">redeleteHangedFileInterval=120000</span><br><span class="line">diskMaxUsedSpaceRatio=88</span><br><span class="line">maxMessageSize=65536</span><br><span class="line">sendMessageThreadPoolNums=128</span><br><span class="line">pullMessageThreadPoolNums=128</span><br><span class="line">storePathRootDir=/home/admin/rocketmq/data/store1</span><br><span class="line">storePathCommitLog=/home/admin/rocketmq/data/store/commitlog1</span><br><span class="line">storePathConsumeQueue=/home/admin/rocketmq/data/store/consumequeue1</span><br><span class="line">storePathIndex=/home/admin/rocketmq/data/store/index1</span><br><span class="line">storeCheckpoint=/home/admin/rocketmq/data/store/checkpoint1</span><br><span class="line">abortFile=/home/admin/rocketmq/data/store/abort1</span><br><span class="line">brokerRole=SLAVE</span><br><span class="line">flushDiskType=ASYNC_FLUSH</span><br></pre></td></tr></table></figure><h4 id="3-4-2-启动NameServer"><a href="#3-4-2-启动NameServer" class="headerlink" title="3.4.2 启动NameServer"></a>3.4.2 启动NameServer</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#启动Nameserver1</span></span><br><span class="line">[admin@rocketmq1 rocketmq]$ nohup bash bin/mqnamesrv &amp;</span><br><span class="line"></span><br><span class="line"><span class="comment">#启动Nameserver2</span></span><br><span class="line">[admin@rocketmq2 rocketmq]$ nohup bash bin/mqnamesrv &amp;</span><br><span class="line"></span><br><span class="line"><span class="comment">#启动Nameserver3</span></span><br><span class="line">[admin@rocketmq3 rocketmq]$ nohup bash bin/mqnamesrv &amp;</span><br><span class="line"></span><br><span class="line"><span class="comment">#启动Nameserver4</span></span><br><span class="line">[admin@rocketmq4 rocketmq]$ nohup bash bin/mqnamesrv &amp;</span><br></pre></td></tr></table></figure><h4 id="3-4-3-启动Broker"><a href="#3-4-3-启动Broker" class="headerlink" title="3.4.3 启动Broker"></a>3.4.3 启动Broker</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#启动Broker_Master-1</span></span><br><span class="line">[admin@rocketmq1 rocketmq]$ nohup bash bin/mqbroker -c conf/2m-2s-sync/broker-a.properties &amp;</span><br><span class="line"></span><br><span class="line"><span class="comment">#启动Broker_Master-2</span></span><br><span class="line">[admin@rocketmq2 rocketmq]$ nohup bash bin/mqbroker -c conf/2m-2s-sync/broker-b.properties &amp;</span><br><span class="line"></span><br><span class="line"><span class="comment">#启动Broker_Master_slave-1</span></span><br><span class="line">[admin@rocketmq3 rocketmq]$ nohup bash bin/mqbroker -c conf/2m-2s-sync/broker<span class="_">-a</span>-s.properties &amp;</span><br><span class="line"></span><br><span class="line"><span class="comment">#启动Broker_Master_slave-2</span></span><br><span class="line">[admin@rocketmq4 rocketmq]$ nohup bash bin/mqbroker -c conf/2m-2s-sync/broker-b-s.properties &amp;</span><br></pre></td></tr></table></figure><h4 id="3-4-4-关闭服务"><a href="#3-4-4-关闭服务" class="headerlink" title="3.4.4 关闭服务"></a>3.4.4 关闭服务</h4><p><strong>关闭NameServer</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[admin@rocketmq1 rocketmq]$ bash bin/mqshutdown namesrv</span><br></pre></td></tr></table></figure><p><strong>关闭Broker</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"> [admin@rocketmq1 rocketmq]$ bash bin/mqshutdown broker</span><br></pre></td></tr></table></figure><h3 id="3-5-Dledger-模式"><a href="#3-5-Dledger-模式" class="headerlink" title="3.5 Dledger 模式"></a>3.5 Dledger 模式</h3><p>RocketMQ 4.5 以前的版本大多都是采用 Master-Slave 架构来部署，能在一定程度上保证数据的不丢失，也能保证一定的可用性。</p><p>但是那种方式 的缺陷很明显，最大的问题就是当 Master Broker 挂了之后 ，没办法让 Slave Broker 自动 切换为新的 Master Broker，需要手动更改配置将 Slave Broker 设置为 Master Broker，以及重启机器，这个非常麻烦。</p><p>在手动运维的期间，可能会导致系统的不可用。</p><p>使用 Dledger 技术要求至少由三个 Broker 组成 ，一个 Master 和两个 Slave，这样三个 Broker 就可以组成一个 Group ，也就是三个 Broker 可以分组来运行。一但 Master 宕机，Dledger 就可以从剩下的两个 Broker 中选举一个 Master 继续对外提供服务。</p><h4 id="3-5-1-DLedger-多副本即主从切换核心配置参数"><a href="#3-5-1-DLedger-多副本即主从切换核心配置参数" class="headerlink" title="3.5.1 DLedger 多副本即主从切换核心配置参数"></a>3.5.1 DLedger 多副本即主从切换核心配置参数</h4><table><thead><tr><th>配置名称</th><th>含义</th></tr></thead><tbody><tr><td>enableDLegerCommitLog</td><td>是否启用 DLedger，即是否启用 RocketMQ 主从切换，默认值为 false。如果需要开启主从切换，则该值需要设置为 true。</td></tr><tr><td>dLegerGroup</td><td>节点所属的 raft 组，建议与 brokerName 保持一致，例如 broker-a。</td></tr><tr><td>dLegerPeers</td><td>集群节点信息，示例配置如下：n0-127.0.0.1:40911;n1-127.0.0.1:40912;n2-127.0.0.1:40913，多个节点用英文冒号隔开，单个条目遵循 legerSlefId-ip:端口，这里的端口用作 dledger 内部通信。</td></tr><tr><td>dLegerSelfId</td><td>当前节点id。取自 legerPeers 中条目的开头，即上述示例中的 n0，并且特别需要强调，只能第一个字符为英文，其他字符需要配置成数字。</td></tr><tr><td>storePathRootDir</td><td>DLedger 日志文件的存储根目录，为了能够支持平滑升级，该值与 storePathCommitLog 设置为不同的目录</td></tr></tbody></table><p><strong>环境如下：</strong></p><table><thead><tr><th>主机</th><th>IP地址</th><th>组件划分</th></tr></thead><tbody><tr><td>rocketmq1</td><td>192.168.10.76</td><td>Nameserver1、Broker_Master-1</td></tr><tr><td>rocketmq2</td><td>192.168.10.77</td><td>Nameserver2、Broker_Master_slave-1</td></tr><tr><td>rocketmq3</td><td>192.168.10.78</td><td>Nameserver3、Broker_Master_slave-2</td></tr></tbody></table><h4 id="3-5-2-创建目录修改配置"><a href="#3-5-2-创建目录修改配置" class="headerlink" title="3.5.2 创建目录修改配置"></a>3.5.2 创建目录修改配置</h4><p><strong>创建数据目录</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#在各服务器执行以下命令创建数据目录</span></span><br><span class="line"></span><br><span class="line">[admin@rocketmq1 rocketmq]$ mkdir -p /home/admin/rocketmq/data/store</span><br><span class="line">[admin@rocketmq1 rocketmq]$ mkdir -p /home/admin/rocketmq/data/store/commitlog</span><br><span class="line">[admin@rocketmq1 rocketmq]$ mkdir -p /home/admin/rocketmq/data/store/consumequeue</span><br><span class="line">[admin@rocketmq1 rocketmq]$ mkdir -p /home/admin/rocketmq/data/store/index</span><br></pre></td></tr></table></figure><p><strong>修改日志路径</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#在各服务器执行以下命令修改日志存储路径</span></span><br><span class="line"></span><br><span class="line">[admin@rocketmq1 rocketmq]$ sed -i  <span class="string">'s#$&#123;user.home&#125;#/home/admin/rocketmq/data#g'</span> conf/*.xml</span><br></pre></td></tr></table></figure><p><strong>配置rocketmq</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#配置Broker_Master-1</span></span><br><span class="line"></span><br><span class="line">[admin@rocketmq1 rocketmq]$ cat conf/2m-2s-sync/broker-a.properties</span><br><span class="line">brokerClusterName=rocketmq-2m-slave-cluster</span><br><span class="line">brokerName=rocketmq-broker-m1</span><br><span class="line">brokerId=0</span><br><span class="line">namesrvAddr=192.168.10.76:9876;192.168.10.77:9876;192.168.10.78:9876</span><br><span class="line">defaultTopicQueueNums=4</span><br><span class="line">autoCreateTopicEnable=<span class="literal">true</span></span><br><span class="line">autoCreateSubscriptionGroup=<span class="literal">true</span></span><br><span class="line">listenPort=10911</span><br><span class="line">deleteWhen=04</span><br><span class="line">fileReservedTime=120</span><br><span class="line">mapedFileSizeCommitLog=1073741824</span><br><span class="line">mapedFileSizeConsumeQueue=50000000</span><br><span class="line">destroyMapedFileIntervalForcibly=120000</span><br><span class="line">redeleteHangedFileInterval=120000</span><br><span class="line">diskMaxUsedSpaceRatio=88</span><br><span class="line">maxMessageSize=65536</span><br><span class="line">sendMessageThreadPoolNums=128</span><br><span class="line">pullMessageThreadPoolNums=128</span><br><span class="line">storePathRootDir=/home/admin/rocketmq/data/store</span><br><span class="line">storePathCommitLog=/home/admin/rocketmq/data/store/commitlog</span><br><span class="line">storePathConsumeQueue=/home/admin/rocketmq/data/store/consumequeue</span><br><span class="line">storePathIndex=/home/admin/rocketmq/data/store/index</span><br><span class="line">storeCheckpoint=/home/admin/rocketmq/data/store/checkpoint</span><br><span class="line">abortFile=/home/admin/rocketmq/data/store/abort</span><br><span class="line">brokerRole=ASYNC_MASTER</span><br><span class="line">flushDiskTyp=ASYNC_FLUSH</span><br><span class="line"><span class="comment"># dledger 相关的配置属性</span></span><br><span class="line">enableDLegerCommitLog=<span class="literal">true</span></span><br><span class="line">storePathRootDir=/home/admin/rocketmq/data/store/dledger</span><br><span class="line">dLegerGroup=rocketmq-broker-m1</span><br><span class="line">dLegerPeers=n0-192.168.10.76:40911;n1-192.168.10.77:40911;n2-192.168.10.78:40911</span><br><span class="line">dLegerSelfId=n0</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#配置Broker_Master_slave-1</span></span><br><span class="line"></span><br><span class="line">[admin@rocketmq2 rocketmq]$ cat conf/2m-2s-sync/broker<span class="_">-a</span>-s.properties</span><br><span class="line">brokerClusterName=rocketmq-2m-slave-cluster</span><br><span class="line">brokerName=rocketmq-broker-m1</span><br><span class="line">brokerId=1</span><br><span class="line">namesrvAddr=192.168.10.76:9876;192.168.10.77:9876;192.168.10.78:9876</span><br><span class="line">defaultTopicQueueNums=4</span><br><span class="line">autoCreateTopicEnable=<span class="literal">true</span></span><br><span class="line">autoCreateSubscriptionGroup=<span class="literal">true</span></span><br><span class="line">listenPort=10911</span><br><span class="line">deleteWhen=04</span><br><span class="line">fileReservedTime=120</span><br><span class="line">mapedFileSizeCommitLog=1073741824</span><br><span class="line">mapedFileSizeConsumeQueue=50000000</span><br><span class="line">destroyMapedFileIntervalForcibly=120000</span><br><span class="line">redeleteHangedFileInterval=120000</span><br><span class="line">diskMaxUsedSpaceRatio=88</span><br><span class="line">maxMessageSize=65536</span><br><span class="line">sendMessageThreadPoolNums=128</span><br><span class="line">pullMessageThreadPoolNums=128</span><br><span class="line">storePathRootDir=/home/admin/rocketmq/data/store</span><br><span class="line">storePathCommitLog=/home/admin/rocketmq/data/store/commitlog</span><br><span class="line">storePathConsumeQueue=/home/admin/rocketmq/data/store/consumequeue</span><br><span class="line">storePathIndex=/home/admin/rocketmq/data/store/index</span><br><span class="line">storeCheckpoint=/home/admin/rocketmq/data/store/checkpoint</span><br><span class="line">abortFile=/home/admin/rocketmq/data/store/abort</span><br><span class="line">brokerRole=SLAVE</span><br><span class="line">flushDiskTyp=ASYNC_FLUSH</span><br><span class="line"><span class="comment"># dledger 相关的配置属性</span></span><br><span class="line">enableDLegerCommitLog=<span class="literal">true</span></span><br><span class="line">storePathRootDir=/home/admin/rocketmq/data/store/dledger</span><br><span class="line">dLegerGroup=rocketmq-broker-m1</span><br><span class="line">dLegerPeers=n0-192.168.10.76:40911;n1-192.168.10.77:40911;n2-192.168.10.78:40911</span><br><span class="line">dLegerSelfId=n1</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#配置Broker_Master_slave-1</span></span><br><span class="line"></span><br><span class="line">[admin@rocketmq3 rocketmq]$ cat conf/2m-2s-sync/broker<span class="_">-a</span>-s.properties</span><br><span class="line">brokerClusterName=rocketmq-2m-slave-cluster</span><br><span class="line">brokerName=rocketmq-broker-m1</span><br><span class="line">brokerId=2</span><br><span class="line">namesrvAddr=192.168.10.76:9876;192.168.10.77:9876;192.168.10.78:9876</span><br><span class="line">defaultTopicQueueNums=4</span><br><span class="line">autoCreateTopicEnable=<span class="literal">true</span></span><br><span class="line">autoCreateSubscriptionGroup=<span class="literal">true</span></span><br><span class="line">listenPort=10911</span><br><span class="line">deleteWhen=04</span><br><span class="line">fileReservedTime=120</span><br><span class="line">mapedFileSizeCommitLog=1073741824</span><br><span class="line">mapedFileSizeConsumeQueue=50000000</span><br><span class="line">destroyMapedFileIntervalForcibly=120000</span><br><span class="line">redeleteHangedFileInterval=120000</span><br><span class="line">diskMaxUsedSpaceRatio=88</span><br><span class="line">maxMessageSize=65536</span><br><span class="line">sendMessageThreadPoolNums=128</span><br><span class="line">pullMessageThreadPoolNums=128</span><br><span class="line">storePathRootDir=/home/admin/rocketmq/data/store</span><br><span class="line">storePathCommitLog=/home/admin/rocketmq/data/store/commitlog</span><br><span class="line">storePathConsumeQueue=/home/admin/rocketmq/data/store/consumequeue</span><br><span class="line">storePathIndex=/home/admin/rocketmq/data/store/index</span><br><span class="line">storeCheckpoint=/home/admin/rocketmq/data/store/checkpoint</span><br><span class="line">abortFile=/home/admin/rocketmq/data/store/abort</span><br><span class="line">brokerRole=SLAVE</span><br><span class="line">flushDiskTyp=ASYNC_FLUSH</span><br><span class="line"><span class="comment"># dledger 相关的配置属性</span></span><br><span class="line">enableDLegerCommitLog=<span class="literal">true</span></span><br><span class="line">storePathRootDir=/home/admin/rocketmq/data/store/dledger</span><br><span class="line">dLegerGroup=rocketmq-broker-m1</span><br><span class="line">dLegerPeers=n0-192.168.10.76:40911;n1-192.168.10.77:40911;n2-192.168.10.78:40911</span><br><span class="line">dLegerSelfId=n2</span><br></pre></td></tr></table></figure><h4 id="3-5-3-启动NameServer"><a href="#3-5-3-启动NameServer" class="headerlink" title="3.5.3 启动NameServer"></a>3.5.3 启动NameServer</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#启动Nameserver1</span></span><br><span class="line">[admin@rocketmq1 rocketmq]$ nohup bash bin/mqnamesrv &amp;</span><br><span class="line"></span><br><span class="line"><span class="comment">#启动Nameserver2</span></span><br><span class="line">[admin@rocketmq2 rocketmq]$ nohup bash bin/mqnamesrv &amp;</span><br><span class="line"></span><br><span class="line"><span class="comment">#启动Nameserver3</span></span><br><span class="line">[admin@rocketmq3 rocketmq]$ nohup bash bin/mqnamesrv &amp;</span><br></pre></td></tr></table></figure><h4 id="3-5-4-启动Broker"><a href="#3-5-4-启动Broker" class="headerlink" title="3.5.4 启动Broker"></a>3.5.4 启动Broker</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#启动Broker_Master-1</span></span><br><span class="line">[admin@rocketmq1 rocketmq]$ nohup bash bin/mqbroker -c conf/2m-2s-sync/broker-a.properties &amp;</span><br><span class="line"></span><br><span class="line"><span class="comment">#启动Broker_Master_slave-1</span></span><br><span class="line">[admin@rocketmq2 rocketmq]$ nohup bash bin/mqbroker -c conf/2m-2s-sync/broker<span class="_">-a</span>-s.properties &amp;</span><br><span class="line"></span><br><span class="line"><span class="comment">#启动Broker_Master_slave-2</span></span><br><span class="line">[admin@rocketmq3 rocketmq]$ nohup bash bin/mqbroker -c conf/2m-2s-sync/broker<span class="_">-a</span>-s.properties &amp;</span><br></pre></td></tr></table></figure><h4 id="3-5-5-测试Master自动切换"><a href="#3-5-5-测试Master自动切换" class="headerlink" title="3.5.5 测试Master自动切换"></a>3.5.5 测试Master自动切换</h4><p>通过3.6步安装rocketmq-console，在浏览器输入 <a href="http://IP:8080" target="_blank" rel="noopener">http://IP:8080</a> 访问控制台，显示集群状态如下：</p><p><img src="/2021/01/11/rocketmq-ji-qun-yuan-li-ji-bu-shu-fang-shi/%E5%9B%BE%E7%89%877.png" alt="图片7"></p><p>通过上图可以看到，当前192.168.10.77是master节点。</p><p>接下来停止192.168.10.77上的broker服务</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[admin@rocketmq2 rocketmq]$ bash bin/mqshutdown broker</span><br><span class="line">[admin@rocketmq2 rocketmq]$ jps</span><br><span class="line">5530 NamesrvStartup</span><br><span class="line">6956 Jps</span><br></pre></td></tr></table></figure><p>再次查看群集状态</p><p><img src="/2021/01/11/rocketmq-ji-qun-yuan-li-ji-bu-shu-fang-shi/%E5%9B%BE%E7%89%878.png" alt="图片8"></p><p>可以看到当前192.168.10.78被选举成了master</p><h3 id="3-6-通过控制台连接rocketmq"><a href="#3-6-通过控制台连接rocketmq" class="headerlink" title="3.6 通过控制台连接rocketmq"></a>3.6 通过控制台连接rocketmq</h3><h4 id="3-6-1-下载rocketmq-console"><a href="#3-6-1-下载rocketmq-console" class="headerlink" title="3.6.1 下载rocketmq-console"></a>3.6.1 下载rocketmq-console</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[admin@rocketmq1 ~]$ git <span class="built_in">clone</span> https://github.com/apache/rocketmq-externals.git</span><br></pre></td></tr></table></figure><h4 id="3-6-2-修改配置文件"><a href="#3-6-2-修改配置文件" class="headerlink" title="3.6.2 修改配置文件"></a>3.6.2 修改配置文件</h4><p><strong>修改pom.xml文件删掉如下plugins段内容</strong>，在234行附近</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">[admin@rocketmq1 ~]$ <span class="built_in">cd</span> rocketmq-externals/rocketmq-console/</span><br><span class="line">[admin@rocketmq1 rocketmq-console]$ vim pom.xml</span><br><span class="line"></span><br><span class="line">            &lt;plugin&gt;</span><br><span class="line">                &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;</span><br><span class="line">                &lt;artifactId&gt;maven-checkstyle-plugin&lt;/artifactId&gt;</span><br><span class="line">                &lt;version&gt;2.17&lt;/version&gt;</span><br><span class="line">                &lt;executions&gt;</span><br><span class="line">                    &lt;execution&gt;</span><br><span class="line">                        &lt;id&gt;validate&lt;/id&gt;</span><br><span class="line">                        &lt;phase&gt;validate&lt;/phase&gt;</span><br><span class="line">                        &lt;configuration&gt;</span><br><span class="line">                            &lt;excludes&gt;src/main/resources&lt;/excludes&gt;</span><br><span class="line">                            &lt;configLocation&gt;style/rmq_checkstyle.xml&lt;/configLocation&gt;</span><br><span class="line">                            &lt;encoding&gt;UTF-8&lt;/encoding&gt;</span><br><span class="line">                            &lt;consoleOutput&gt;<span class="literal">true</span>&lt;/consoleOutput&gt;</span><br><span class="line">                            &lt;failsOnError&gt;<span class="literal">true</span>&lt;/failsOnError&gt;</span><br><span class="line">                        &lt;/configuration&gt;</span><br><span class="line">                        &lt;goals&gt;</span><br><span class="line">                            &lt;goal&gt;check&lt;/goal&gt;</span><br><span class="line">                        &lt;/goals&gt;</span><br><span class="line">                    &lt;/execution&gt;</span><br><span class="line">                &lt;/executions&gt;</span><br><span class="line">            &lt;/plugin&gt;</span><br></pre></td></tr></table></figure><p><strong>修改连接rocketmq的地址</strong>，主要修改连接rocketmq的地址</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[admin@rocketmq1 rocketmq-console]$ vim src/main/resources/application.properties</span><br><span class="line"></span><br><span class="line">rocketmq.config.namesrvAddr=192.168.10.76:9876;192.168.10.77:9876;192.168.10.78:9876;192.168.10.79:9876</span><br></pre></td></tr></table></figure><h4 id="3-6-3-编译rocketmq-console"><a href="#3-6-3-编译rocketmq-console" class="headerlink" title="3.6.3 编译rocketmq-console"></a>3.6.3 编译rocketmq-console</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[admin@rocketmq1 rocketmq-console]$ mvn clean package -Dmaven.test.skip=<span class="literal">true</span></span><br></pre></td></tr></table></figure><h4 id="3-6-4-启动rocketmq-console"><a href="#3-6-4-启动rocketmq-console" class="headerlink" title="3.6.4 启动rocketmq-console"></a>3.6.4 启动rocketmq-console</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[admin@rocketmq1 rocketmq-console]$ java -jar target/rocketmq-console-ng-2.0.0.jar</span><br></pre></td></tr></table></figure><h4 id="3-6-5-访问rocketmq-console控制台"><a href="#3-6-5-访问rocketmq-console控制台" class="headerlink" title="3.6.5 访问rocketmq-console控制台"></a>3.6.5 访问rocketmq-console控制台</h4><p>在浏览器输入 <a href="http://IP:8080" target="_blank" rel="noopener">http://IP:8080</a></p><p><img src="/2021/01/11/rocketmq-ji-qun-yuan-li-ji-bu-shu-fang-shi/%E5%9B%BE%E7%89%875.png" alt="图片5"></p><h3 id="3-7-rocketmq配置解析"><a href="#3-7-rocketmq配置解析" class="headerlink" title="3.7 rocketmq配置解析"></a>3.7 rocketmq配置解析</h3><table><thead><tr><th>配置名称</th><th>含义</th></tr></thead><tbody><tr><td>brokerClusterName</td><td>所属集群名字</td></tr><tr><td>brokerName</td><td>broker名字</td></tr><tr><td>brokerId</td><td>0 Master | &gt;0 Slave</td></tr><tr><td>namesrvAddr</td><td>nameServer地址,分号分隔</td></tr><tr><td>listenPort</td><td>Broker 对外服务的监听端口，默认10911</td></tr><tr><td>defaultTopicQueueNums</td><td>发送消息时,自动创建服务器不存在的topic,默认创建的队列数</td></tr><tr><td>autoCreateTopicEnable</td><td>是否允许 Broker 自动创建Topic, 通常线下开启，线上关闭</td></tr><tr><td>autoCreateSubscriptionGroup</td><td>是否允许 Broker 自动创建订阅组, 通常线下开启, 线上关闭</td></tr><tr><td>listenPort</td><td>Broker 服务对外监听端口</td></tr><tr><td>deleteWhen</td><td>删除文件时间点，默认凌晨 4点</td></tr><tr><td>fileReservedTime</td><td>文件保留时间，默认 48 小时</td></tr><tr><td>mapedFileSizeCommitLog</td><td>commitLog每个文件的大小默认1G</td></tr><tr><td>mapedFileSizeConsumeQueue</td><td>ConsumeQueue每个文件默认存30W条,根据业务情况调整</td></tr><tr><td>destroyMapedFileIntervalForcibly</td><td>强制删除文件间隔时间（单位毫秒）</td></tr><tr><td>redeleteHangedFileInterval</td><td>定期检查Hanged文件间隔时间（单位毫秒）</td></tr><tr><td>diskMaxUsedSpaceRatio</td><td>检测物理文件磁盘空间</td></tr><tr><td>maxMessageSize</td><td>限制的消息大小</td></tr><tr><td>sendMessageThreadPoolNums</td><td>发消息线程池数量</td></tr><tr><td>pullMessageThreadPoolNums</td><td>拉消息线程池数量</td></tr><tr><td>brokerRole</td><td>Broker 的角色 [ASYNC_FLUSH 异步复制Master, SYNC_MASTER 同步双写Master],从节点为SLAVE</td></tr><tr><td>flushDiskType</td><td>刷盘方式[ASYNC_FLUSH 异步刷盘, SYNC_FLUSH 同步刷盘]</td></tr><tr><td>storePathRootDir</td><td>存储路径</td></tr><tr><td>storePathCommitLog</td><td>消费队列存储路径存储路径</td></tr><tr><td>storePathConsumeQueue</td><td>消费队列存储路径存储路径</td></tr><tr><td>storePathIndex</td><td>消息索引存储路径</td></tr><tr><td>storeCheckpoint</td><td>checkpoint 文件存储路径</td></tr><tr><td>abortFile</td><td>abort 文件存储路径</td></tr></tbody></table></div><div><div><div style="text-align:center;color:#ccc;font-size:14px">-------------本文结束<i class="fa fa-paw"></i>感谢您的阅读-------------</div></div></div><div></div><footer class="post-footer"><div class="post-tags"><a href="/tags/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/" rel="tag"><i class="fa fa-tag"></i> 消息队列</a><a href="/tags/RocketMQ/" rel="tag"><i class="fa fa-tag"></i> RocketMQ</a></div><div class="post-nav"><div class="post-nav-next post-nav-item"><a href="/2021/01/07/kali-wu-xian-wang-luo-shen-tou/" rel="next" title="Kali 无线网络渗透"><i class="fa fa-chevron-left"></i> Kali 无线网络渗透</a></div><span class="post-nav-divider"></span><div class="post-nav-prev post-nav-item"><a href="/2021/01/24/es-chu-xian-unassigned-shards-jie-jue-fang-fa/" rel="prev" title="ES出现unassigned_shards解决方法">ES出现unassigned_shards解决方法<i class="fa fa-chevron-right"></i></a></div></div></footer></div></article><div class="post-spread"><div class="jiathis_style"><span class="jiathis_txt">分享到：</span> <a class="jiathis_button_fav">收藏夹</a> <a class="jiathis_button_copy">复制网址</a> <a class="jiathis_button_email">邮件</a> <a class="jiathis_button_weixin">微信</a> <a class="jiathis_button_qzone">QQ空间</a> <a class="jiathis_button_tqq">腾讯微博</a> <a class="jiathis_button_douban">豆瓣</a> <a class="jiathis_button_share">一键分享</a> <a href="http://www.jiathis.com/share?uid=2140465" class="jiathis jiathis_txt jiathis_separator jtico jtico_jiathis" target="_blank">更多</a><a class="jiathis_counter_style"></a></div><script type="text/javascript">var jiathis_config={data_track_clickback:!0,summary:"",shortUrl:!1,hideMore:!1}</script><script type="text/javascript" src="http://v3.jiathis.com/code/jia.js?uid=" charset="utf-8"></script></div></div></div></div><div class="sidebar-toggle"><div class="sidebar-toggle-line-wrap"><span class="sidebar-toggle-line sidebar-toggle-line-first"></span><span class="sidebar-toggle-line sidebar-toggle-line-middle"></span><span class="sidebar-toggle-line sidebar-toggle-line-last"></span></div></div><aside id="sidebar" class="sidebar"><div id="sidebar-dimmer"></div><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">文章目录</li><li class="sidebar-nav-overview" data-target="site-overview-wrap">站点概览</li></ul><section class="site-overview-wrap sidebar-panel"><div class="site-overview"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="site-author-image" itemprop="image" src="/images/chen.png" alt="Zhongzhou Chen"><p class="site-author-name" itemprop="name">Zhongzhou Chen</p><p class="site-description motion-element" itemprop="description"></p></div><nav class="site-state motion-element"><div class="site-state-item site-state-posts"><a href="/archives"><span class="site-state-item-count">282</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"><a href="/categories/index.html"><span class="site-state-item-count">84</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"><a href="/tags/index.html"><span class="site-state-item-count">164</span> <span class="site-state-item-name">标签</span></a></div></nav><div class="feed-link motion-element"><a href="/atom.xml" rel="alternate"><i class="fa fa-rss"></i> RSS</a></div></div></section><section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active"><div class="post-toc"><div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#一、RocketMQ简介"><span class="nav-text">一、RocketMQ简介</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-1-RocketMQ发展历程"><span class="nav-text">1.1 RocketMQ发展历程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-2-RocketMQ的功能"><span class="nav-text">1.2 RocketMQ的功能</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#二、RocketMQ架构组成"><span class="nav-text">二、RocketMQ架构组成</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-1-集群组成"><span class="nav-text">2.1 集群组成</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#2-1-1-NameServer"><span class="nav-text">2.1.1 NameServer</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-1-2-Broker"><span class="nav-text">2.1.2 Broker</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-1-3-Producer"><span class="nav-text">2.1.3 Producer</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-1-4-Consumer"><span class="nav-text">2.1.4 Consumer</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2-消息领域模型"><span class="nav-text">2.2 消息领域模型</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#2-2-1-Message"><span class="nav-text">2.2.1 Message</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-2-2-Topic"><span class="nav-text">2.2.2 Topic</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-2-3-Tag"><span class="nav-text">2.2.3 Tag</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-2-4-Group"><span class="nav-text">2.2.4 Group</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-2-5-Queue"><span class="nav-text">2.2.5 Queue</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Message-Queue"><span class="nav-text">Message Queue</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-2-6-Offset"><span class="nav-text">2.2.6 Offset</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-3-消息消费模式"><span class="nav-text">2.3 消息消费模式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-4-Message-Order"><span class="nav-text">2.4 Message Order</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#三、RocketMQ集群模式"><span class="nav-text">三、RocketMQ集群模式</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#3-1-单Master模式"><span class="nav-text">3.1 单Master模式</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#3-1-1-启动nameserver"><span class="nav-text">3.1.1 启动nameserver</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-1-2-启动broker"><span class="nav-text">3.1.2 启动broker</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-1-3-看是否启动成功"><span class="nav-text">3.1.3 看是否启动成功</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-2-多Master模式"><span class="nav-text">3.2 多Master模式</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#3-2-1-创建目录修改配置"><span class="nav-text">3.2.1 创建目录修改配置</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-2-2-启动NameServer"><span class="nav-text">3.2.2 启动NameServer</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-2-3-启动Broker"><span class="nav-text">3.2.3 启动Broker</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-2-4-关闭服务"><span class="nav-text">3.2.4 关闭服务</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-3-多Master多Slave模式-异步复制"><span class="nav-text">3.3 多Master多Slave模式-异步复制</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#3-3-1-创建目录修改配置"><span class="nav-text">3.3.1 创建目录修改配置</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-3-2-启动NameServer"><span class="nav-text">3.3.2 启动NameServer</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-3-3-启动Broker"><span class="nav-text">3.3.3 启动Broker</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-3-4-关闭服务"><span class="nav-text">3.3.4 关闭服务</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-4-多Master多Slave模式-同步双写"><span class="nav-text">3.4 多Master多Slave模式-同步双写</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#3-2-1-创建目录修改配置-1"><span class="nav-text">3.2.1 创建目录修改配置</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-4-2-启动NameServer"><span class="nav-text">3.4.2 启动NameServer</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-4-3-启动Broker"><span class="nav-text">3.4.3 启动Broker</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-4-4-关闭服务"><span class="nav-text">3.4.4 关闭服务</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-5-Dledger-模式"><span class="nav-text">3.5 Dledger 模式</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#3-5-1-DLedger-多副本即主从切换核心配置参数"><span class="nav-text">3.5.1 DLedger 多副本即主从切换核心配置参数</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-5-2-创建目录修改配置"><span class="nav-text">3.5.2 创建目录修改配置</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-5-3-启动NameServer"><span class="nav-text">3.5.3 启动NameServer</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-5-4-启动Broker"><span class="nav-text">3.5.4 启动Broker</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-5-5-测试Master自动切换"><span class="nav-text">3.5.5 测试Master自动切换</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-6-通过控制台连接rocketmq"><span class="nav-text">3.6 通过控制台连接rocketmq</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#3-6-1-下载rocketmq-console"><span class="nav-text">3.6.1 下载rocketmq-console</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-6-2-修改配置文件"><span class="nav-text">3.6.2 修改配置文件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-6-3-编译rocketmq-console"><span class="nav-text">3.6.3 编译rocketmq-console</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-6-4-启动rocketmq-console"><span class="nav-text">3.6.4 启动rocketmq-console</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-6-5-访问rocketmq-console控制台"><span class="nav-text">3.6.5 访问rocketmq-console控制台</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-7-rocketmq配置解析"><span class="nav-text">3.7 rocketmq配置解析</span></a></li></ol></li></ol></div></div></section><div class="back-to-top"><i class="fa fa-arrow-up"></i> <span id="scrollpercent"><span>0</span>%</span></div></div></aside></div></main><footer id="footer" class="footer"><div class="footer-inner"><script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script><div class="copyright">&copy; <span itemprop="copyrightYear">2021</span><span class="with-love"><i class="fa fa-user"></i></span> <span class="author" itemprop="copyrightHolder">Zhongzhou Chen</span> <span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-area-chart"></i></span> <span class="post-meta-item-text">Site words total count&#58;</span> <span title="Site words total count">597k</span></div><span class="post-meta-divider"></span></div></footer></div><script type="text/javascript">"[object Function]"!==Object.prototype.toString.call(window.Promise)&&(window.Promise=null)</script><script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script><script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script><script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script><script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script><script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script><script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script><script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script><script type="text/javascript">function proceedsearch(){$("body").append('<div class="search-popup-overlay local-search-pop-overlay"></div>').css("overflow","hidden"),$(".search-popup-overlay").click(onPopupClose),$(".popup").toggle();var t=$("#local-search-input");t.attr("autocapitalize","none"),t.attr("autocorrect","off"),t.focus()}var isfetched=!1,isXml=!0,search_path="search.xml";0===search_path.length?search_path="search.xml":/json$/i.test(search_path)&&(isXml=!1);var path="/"+search_path,onPopupClose=function(t){$(".popup").hide(),$("#local-search-input").val(""),$(".search-result-list").remove(),$("#no-result").remove(),$(".local-search-pop-overlay").remove(),$("body").css("overflow","")},searchFunc=function(t,e,s){"use strict";$("body").append('<div class="search-popup-overlay local-search-pop-overlay"><div id="search-loading-icon"><i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i></div></div>').css("overflow","hidden"),$("#search-loading-icon").css("margin","20% auto 0 auto").css("text-align","center"),$.ajax({url:t,dataType:isXml?"xml":"json",async:!0,success:function(t){isfetched=!0,$(".popup").detach().appendTo(".header-inner");var o=isXml?$("entry",t).map(function(){return{title:$("title",this).text(),content:$("content",this).text(),url:$("url",this).text()}}).get():t,n=document.getElementById(e),r=document.getElementById(s);n.addEventListener("input",function(){var y=n.value.trim().toLowerCase(),T=y.split(/[\s\-]+/);1<T.length&&T.push(y);var b=[];if(0<y.length&&o.forEach(function(t){function e(t,e,o,n){for(var r=n[n.length-1],s=r.position,a=r.word,i=[],c=0;s+a.length<=o&&0!=n.length;){a===y&&c++,i.push({position:s,length:a.length});var l=s+a.length;for(n.pop();0!=n.length&&(s=(r=n[n.length-1]).position,a=r.word,s<l);)n.pop()}return h+=c,{hits:i,start:e,end:o,searchTextCount:c}}function o(o,t){var n="",r=t.start;return t.hits.forEach(function(t){n+=o.substring(r,t.position);var e=t.position+t.length;n+='<b class="search-keyword">'+o.substring(t.position,e)+"</b>",r=e}),n+=o.substring(r,t.end)}var n=!1,r=0,h=0,s=t.title.trim(),a=s.toLowerCase(),i=t.content.trim().replace(/<[^>]+>/g,""),c=i.toLowerCase(),l=decodeURIComponent(t.url),p=[],u=[];if(""!=s&&(T.forEach(function(t){function e(t,e,o){var n=t.length;if(0===n)return[];var r=0,s=[],a=[];for(o||(e=e.toLowerCase(),t=t.toLowerCase());-1<(s=e.indexOf(t,r));)a.push({position:s,word:t}),r=s+n;return a}p=p.concat(e(t,a,!1)),u=u.concat(e(t,c,!1))}),(0<p.length||0<u.length)&&(n=!0,r=p.length+u.length)),n){[p,u].forEach(function(t){t.sort(function(t,e){return e.position!==t.position?e.position-t.position:t.word.length-e.word.length})});var f=[];0!=p.length&&f.push(e(0,0,s.length,p));for(var d=[];0!=u.length;){var g=u[u.length-1],v=g.position,$=g.word,C=v-20,m=v+80;C<0&&(C=0),m<v+$.length&&(m=v+$.length),m>i.length&&(m=i.length),d.push(e(0,C,m,u))}d.sort(function(t,e){return t.searchTextCount!==e.searchTextCount?e.searchTextCount-t.searchTextCount:t.hits.length!==e.hits.length?e.hits.length-t.hits.length:t.start-e.start});var x=parseInt("1");0<=x&&(d=d.slice(0,x));var w="";w+=0!=f.length?"<li><a href='"+l+"' class='search-result-title'>"+o(s,f[0])+"</a>":"<li><a href='"+l+"' class='search-result-title'>"+s+"</a>",d.forEach(function(t){w+="<a href='"+l+'\'><p class="search-result">'+o(i,t)+"...</p></a>"}),w+="</li>",b.push({item:w,searchTextCount:h,hitCount:r,id:b.length})}}),1===T.length&&""===T[0])r.innerHTML='<div id="no-result"><i class="fa fa-search fa-5x" /></div>';else if(0===b.length)r.innerHTML='<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>';else{b.sort(function(t,e){return t.searchTextCount!==e.searchTextCount?e.searchTextCount-t.searchTextCount:t.hitCount!==e.hitCount?e.hitCount-t.hitCount:e.id-t.id});var e='<ul class="search-result-list">';b.forEach(function(t){e+=t.item}),e+="</ul>",r.innerHTML=e}}),$(".local-search-pop-overlay").remove(),$("body").css("overflow",""),proceedsearch()}})};$(".popup-trigger").click(function(t){t.stopPropagation(),!1===isfetched?searchFunc(path,"local-search-input","local-search-result"):proceedsearch()}),$(".popup-btn-close").click(onPopupClose),$(".popup").click(function(t){t.stopPropagation()}),$(document).on("keyup",function(t){27===t.which&&$(".search-popup").is(":visible")&&onPopupClose()})</script><script type="text/javascript" src="/js/src/clipboard.min.js"></script><script type="text/javascript" src="/js/src/clipboard-use.js"></script><script type="text/javascript" src="/js/src/love.js"></script><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({pluginRootPath:"live2dw/",pluginJsPath:"lib/",pluginModelPath:"assets/",tagMode:!1,log:!1,model:{jsonPath:"/live2dw/assets/shizuku.model.json"},display:{position:"right"},mobile:{show:!0,scale:.5},react:{opacityDefault:.7,opacityOnHover:.2}})</script></body></html>