<!-- build time:Tue Dec 21 2021 14:39:49 GMT+0800 (GMT+08:00) --><!DOCTYPE html><html class="theme-next gemini use-motion" lang="zh-Hans"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><script src="//cdn.bootcss.com/pace/1.0.2/pace.min.js"></script><link href="//cdn.bootcss.com/pace/1.0.2/themes/pink/pace-theme-flash.css" rel="stylesheet"><script></script><meta name="theme-color" content="#222"><style>.pace .pace-progress{background:#1E92FB;height:3px}.pace .pace-progress-inner{box-shadow:0 0 10px #1E92FB,0 0 5px #1E92FB}.pace .pace-activity{border-top-color:#1E92FB;border-left-color:#1E92FB}</style><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><meta name="google-site-verification" content="HGM141IpbHrSmnAmR6W_zE4bo9Z3f-yXLeHYT3bg1fk"><meta name="baidu-site-verification" content="code-5Ai1DA8e6T"><link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css"><link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css"><link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4"><link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222"><meta name="keywords" content="Hadoop,OLAP,Presto,"><link rel="alternate" href="/atom.xml" title="凡间的精灵" type="application/atom+xml"><meta name="description" content="Presto 是由 Facebook 推出的一个基于Java开发的开源分布式SQL查询引擎，数据量支持GB到TB字节，presto本身不存数据，但是可以接入很多数据源，它使得用SQL访问任何数据源成为可能，而且支持跨数据源的级联查询。你可以使用Presto通过水平扩展查询处理的方式来查询大型数据集。发展历史如下：2012年秋季，Facebook启动Presto项目；2013年冬季，Presto开源"><meta name="keywords" content="Hadoop,OLAP,Presto"><meta property="og:type" content="article"><meta property="og:title" content="Presto 分布式SQL查询引擎"><meta property="og:url" content="http:&#x2F;&#x2F;chenzhonzhou.github.io&#x2F;2021&#x2F;11&#x2F;16&#x2F;presto-fen-bu-shi-sql-cha-xun-yin-qing&#x2F;index.html"><meta property="og:site_name" content="凡间的精灵"><meta property="og:description" content="Presto 是由 Facebook 推出的一个基于Java开发的开源分布式SQL查询引擎，数据量支持GB到TB字节，presto本身不存数据，但是可以接入很多数据源，它使得用SQL访问任何数据源成为可能，而且支持跨数据源的级联查询。你可以使用Presto通过水平扩展查询处理的方式来查询大型数据集。发展历史如下：2012年秋季，Facebook启动Presto项目；2013年冬季，Presto开源"><meta property="og:locale" content="zh-Hans"><meta property="og:image" content="http:&#x2F;&#x2F;chenzhonzhou.github.io&#x2F;2021&#x2F;11&#x2F;16&#x2F;presto-fen-bu-shi-sql-cha-xun-yin-qing&#x2F;%E5%9B%BE%E7%89%871.png"><meta property="og:image" content="http:&#x2F;&#x2F;chenzhonzhou.github.io&#x2F;2021&#x2F;11&#x2F;16&#x2F;presto-fen-bu-shi-sql-cha-xun-yin-qing&#x2F;%E5%9B%BE%E7%89%872.png"><meta property="og:image" content="http:&#x2F;&#x2F;chenzhonzhou.github.io&#x2F;2021&#x2F;11&#x2F;16&#x2F;presto-fen-bu-shi-sql-cha-xun-yin-qing&#x2F;%E5%9B%BE%E7%89%873.png"><meta property="og:image" content="http:&#x2F;&#x2F;chenzhonzhou.github.io&#x2F;2021&#x2F;11&#x2F;16&#x2F;presto-fen-bu-shi-sql-cha-xun-yin-qing&#x2F;%E5%9B%BE%E7%89%874.png"><meta property="og:image" content="http:&#x2F;&#x2F;chenzhonzhou.github.io&#x2F;2021&#x2F;11&#x2F;16&#x2F;presto-fen-bu-shi-sql-cha-xun-yin-qing&#x2F;%E5%9B%BE%E7%89%875.png"><meta property="og:updated_time" content="2021-12-16T10:42:04.937Z"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="http:&#x2F;&#x2F;chenzhonzhou.github.io&#x2F;2021&#x2F;11&#x2F;16&#x2F;presto-fen-bu-shi-sql-cha-xun-yin-qing&#x2F;%E5%9B%BE%E7%89%871.png"><script type="text/javascript" id="hexo.configurations">var NexT=window.NexT||{},CONFIG={root:"/",scheme:"Gemini",version:"5.1.4",sidebar:{position:"left",display:"always",offset:12,b2t:!0,scrollpercent:!0,onmobile:!0},fancybox:!0,tabs:!0,motion:{enable:!0,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}},duoshuo:{userId:"0",author:"博主"},algolia:{applicationID:"",apiKey:"",indexName:"",hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}}}</script><link rel="canonical" href="http://chenzhonzhou.github.io/2021/11/16/presto-fen-bu-shi-sql-cha-xun-yin-qing/"><title>Presto 分布式SQL查询引擎 | 凡间的精灵</title><link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css"></head><body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans"><div class="container sidebar-position-left page-post-detail"><div class="headband"></div><header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-wrapper"><div class="site-meta"><div class="custom-logo-site-title"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">凡间的精灵</span> <span class="logo-line-after"><i></i></span></a></div><p class="site-subtitle">凡尘落素一精灵</p></div><div class="site-nav-toggle"><button><span class="btn-bar"></span> <span class="btn-bar"></span> <span class="btn-bar"></span></button></div></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i><br>首页</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i><br>归档</a></li><li class="menu-item menu-item-categories"><a href="/categories" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i><br>分类</a></li><li class="menu-item menu-item-tags"><a href="/tags" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i><br>标签</a></li><li class="menu-item menu-item-sitemap"><a href="/sitemap.xml" rel="section"><i class="menu-item-icon fa fa-fw fa-sitemap"></i><br>站点地图</a></li><li class="menu-item menu-item-search"><a href="javascript:;" class="popup-trigger"><i class="menu-item-icon fa fa-search fa-fw"></i><br>搜索</a></li></ul><div class="site-search"><div class="popup search-popup local-search-popup"><div class="local-search-header clearfix"><span class="search-icon"><i class="fa fa-search"></i> </span><span class="popup-btn-close"><i class="fa fa-times-circle"></i></span><div class="local-search-input-wrapper"><input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input"></div></div><div id="local-search-result"></div></div></div></nav></div></header><main id="main" class="main"><div class="main-inner"><div class="content-wrap"><div id="content" class="content"><div id="posts" class="posts-expand"><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><div class="post-block"><link itemprop="mainEntityOfPage" href="http://chenzhonzhou.github.io/2021/11/16/presto-fen-bu-shi-sql-cha-xun-yin-qing/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="name" content="Zhongzhou Chen"><meta itemprop="description" content=""><meta itemprop="image" content="/images/chen.png"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="凡间的精灵"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">Presto 分布式SQL查询引擎</h1><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-11-16T17:18:17+08:00">2021-11-16 </time></span><span class="post-category"><span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-folder-o"></i> </span><span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Hadoop/" itemprop="url" rel="index"><span itemprop="name">Hadoop</span></a></span></span><div class="post-wordcount"><span class="post-meta-item-icon"><i class="fa fa-file-word-o"></i> </span><span class="post-meta-item-text">字数统计&#58;</span> <span title="字数统计">6.4k </span><span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-clock-o"></i> </span><span class="post-meta-item-text">阅读时长 &asymp;</span> <span title="阅读时长">26</span></div></div></header><div class="post-body" itemprop="articleBody"><p><a href="https://prestodb.io/" target="_blank" rel="noopener">Presto</a> 是由 Facebook 推出的一个基于Java开发的开源分布式SQL查询引擎，数据量支持GB到TB字节，presto本身不存数据，但是可以接入很多数据源，它使得用SQL访问任何数据源成为可能，而且支持跨数据源的级联查询。你可以使用Presto通过水平扩展查询处理的方式来查询大型数据集。</p><p>发展历史如下：</p><ul><li>2012年秋季，Facebook启动Presto项目；</li><li>2013年冬季，Presto开源；</li><li>2017年11月，11888 commits，203 releases，198 contributors；</li><li>2019年1月，Presto分家，目前有 PrestoDB 和 PrestoSQL（Trino） 两个社区。</li></ul><h2 id="一、Presto-架构组成"><a href="#一、Presto-架构组成" class="headerlink" title="一、Presto 架构组成"></a>一、Presto 架构组成</h2><p><img src="/2021/11/16/presto-fen-bu-shi-sql-cha-xun-yin-qing/%E5%9B%BE%E7%89%871.png" alt="图片1"></p><h3 id="1-1-Presto-服务器类型"><a href="#1-1-Presto-服务器类型" class="headerlink" title="1.1 Presto 服务器类型"></a>1.1 Presto 服务器类型</h3><h4 id="1-1-1-Coordinator"><a href="#1-1-1-Coordinator" class="headerlink" title="1.1.1 Coordinator"></a>1.1.1 Coordinator</h4><p>集群的管理节点<br>1）对外负责管理集群与客户端的连接，并接收客户端查询请求；<br>2）进行SQL的语法解析、查询计划生成和优化，并进行查询任务的调度；<br>3）Discovery Server节点，跟踪Worker节点的状态，通常内嵌于Coordinator节点中；<br>4）部署情况：一般作为单独节点部署在集群中；<br>5）通信方式：使用RESTful接口与客户端、Workers进行交互。</p><h4 id="1-1-2-Worker"><a href="#1-1-2-Worker" class="headerlink" title="1.1.2 Worker"></a>1.1.2 Worker</h4><p>集群的工作节点<br>1）用于执行被分解后的查询任务(task)及与数据的读写交互；<br>2）部署情况：一般集群中部署多个worker节点；<br>3）通信方式：使用RESTful接口与Coordinator、其他Workers进行交互。</p><h3 id="1-2-Presto-数据源"><a href="#1-2-Presto-数据源" class="headerlink" title="1.2 Presto 数据源"></a>1.2 Presto 数据源</h3><h4 id="1-2-1-Connector"><a href="#1-2-1-Connector" class="headerlink" title="1.2.1 Connector"></a>1.2.1 Connector</h4><p>Presto通过connector可以访问多种不同的数据源，connector相当于数据库访问的驱动。每种connector通过实现Presto的SPI接口实现数据源的标准接入。</p><h4 id="1-2-2-Catalog"><a href="#1-2-2-Catalog" class="headerlink" title="1.2.2 Catalog"></a>1.2.2 Catalog</h4><p>Presto Catalog目录包含架构并通过连接器引用数据源。例如，您可以配置 JMX 目录以通过 JMX 连接器提供对 JMX 信息的访问。当您在 Presto 中运行 SQL 语句时，您是在针对一个或多个目录运行它。目录的其他示例包括用于连接到 Hive 数据源的 Hive 目录。</p><p>在 Presto 中寻址表时，完全限定的表名始终以目录为根。例如，一个完全合格的表名称<code>hive.test_data.test</code>将引用<code>test</code>表中 <code>test_data</code>的架构<code>hive</code>目录。</p><p>目录在存储在 Presto 配置目录中的属性文件中定义。</p><h4 id="1-2-3-Schema"><a href="#1-2-3-Schema" class="headerlink" title="1.2.3 Schema"></a>1.2.3 Schema</h4><p>Schema是一种组织表格的方式。Catalog和Schema一起定义了一组可以查询的表。使用 Presto 访问 Hive 或关系数据库（例如 MySQL）时，Schema会转换为目标数据库中的database。其他类型的连接器可能会选择以对底层数据源有意义的方式将表组织成模式。</p><h4 id="1-2-4-Table"><a href="#1-2-4-Table" class="headerlink" title="1.2.4 Table"></a>1.2.4 Table</h4><p>数据表，与任何关系数据库中的概念类似。从源数据到表的映射由connector定义。</p><h3 id="1-3-presto-查询模型"><a href="#1-3-presto-查询模型" class="headerlink" title="1.3 presto 查询模型"></a>1.3 presto 查询模型</h3><h4 id="1-3-1-Statement"><a href="#1-3-1-Statement" class="headerlink" title="1.3.1 Statement"></a>1.3.1 Statement</h4><p><strong>Statement：</strong>语句，其实就是输入的SQL；</p><h4 id="1-3-2-Query"><a href="#1-3-2-Query" class="headerlink" title="1.3.2 Query"></a>1.3.2 Query</h4><p><strong>Query：</strong>根据SQL语句生成查询执行计划，进而生成可以执行的查询（Query），一个Query包含stages、tasks、splits、connectors等组件和相应的数据源这些概念；</p><h4 id="1-3-3-Stage"><a href="#1-3-3-Stage" class="headerlink" title="1.3.3 Stage"></a>1.3.3 Stage</h4><p><strong>Stage：</strong>当Presto执行Query时，会将query拆分成具有层次关系的多个stages。一个Query的stages之间是树形的层次结构，每一个Query都有一个Root stage，用于聚合所有其他Stages的输出数据。Stage只是coordinator用于分布式查询计划(query plan)建模的逻辑概念，本身并不会执行在Presto Workers上；</p><h4 id="1-3-4-Exchange"><a href="#1-3-4-Exchange" class="headerlink" title="1.3.4 Exchange"></a>1.3.4 Exchange</h4><p><strong>Exchange：</strong>Exchange用于不同Presto节点间查询的不同stages数据交换。Task生产数据放入输出Buffer中，也可以通过exchange客户端从其他task消费数据</p><h4 id="1-3-5-Task"><a href="#1-3-5-Task" class="headerlink" title="1.3.5 Task"></a>1.3.5 Task</h4><p><strong>Task：</strong>Presto是通过Task来运行的，一个分布式查询计划（query plan）被拆解成一些列的stage，一个stage分解成一系列并行执行的task，每个task被分解成一个或多个并行的driver，每个driver作用于一系列splist上，每个task都有对应的输入输出；</p><h4 id="1-3-6-Driver"><a href="#1-3-6-Driver" class="headerlink" title="1.3.6 Driver"></a>1.3.6 Driver</h4><p><strong>Driver：</strong>Drivers处理数据，并由task聚合后传给下游stage的一个task。一个Driver就是作用于一个split上的一系列operator的集合。Driver是Presto架构最底层的并行处理单元。每个Driver都有一个输入和一个输出。</p><h4 id="1-3-7-Operator"><a href="#1-3-7-Operator" class="headerlink" title="1.3.7 Operator"></a>1.3.7 Operator</h4><p><strong>Operator：</strong>一个operator代表对一个split的一种操作，一个Operator依次读取一个Split中的数据，将Operator所代表的计算和操作应用于该split上，并产生输出。</p><h4 id="1-3-8-Split"><a href="#1-3-8-Split" class="headerlink" title="1.3.8 Split"></a>1.3.8 Split</h4><p><strong>Split：</strong>分片，一个分片就是一个大的数据集中的一个小的子集，位于分布式query plan中较低层次的stages从数据源获取splits，位于较高层次的中间stages则从其他stages获取数据。</p><h2 id="二、Presto-其它特性"><a href="#二、Presto-其它特性" class="headerlink" title="二、Presto 其它特性"></a>二、Presto 其它特性</h2><h3 id="2-1-presto-SQL执行步骤"><a href="#2-1-presto-SQL执行步骤" class="headerlink" title="2.1 presto SQL执行步骤"></a>2.1 presto SQL执行步骤</h3><p>1）客户端通过http发送一个查询语句给presto集群的coordinator；<br>2）coordinator接收到客户端的查询语句，对语句进行解析，生成查询执行计划，并根据生成的执行计划生成stage和task，并将task分发到需要处理数据的worker上进行分析；<br>3）worker执行task，task通过connector从数据源中读取需要的数据；<br>4）上游stage输出的结果给到下游stage作为输入，每个Stage的每个task在worker内存中进行计算和处理；<br>5）client从提交查询后，就一直监听coordinator中的查询结果，一有结果就立即输出，直到轮询所有的结果都返回，则本次查询结束。</p><h3 id="2-2-Presto-低延时查询原理"><a href="#2-2-Presto-低延时查询原理" class="headerlink" title="2.2 Presto 低延时查询原理"></a>2.2 Presto 低延时查询原理</h3><ol><li>得益于 YARN 调度的慢。YARN 的定位是一个通用的资源管理系统。但是无论是 Hive 采用 MR、TEZ 何种引擎，执行 SQL时，每个执行算子都在 Yarn Container 中运行，而 <strong>Yarn 拉起 Container 性能特别低（秒级）</strong>。这犹如应用程序在拉起进程和开启多线程一样。线程更轻量级，简单的运算开启线程的速度更快，加速更明显；而启用进程则要笨重的多，还容易受到操作系统限制。而 <strong>Presto 调度的确就是用了线程</strong>，而不是进程。</li><li>Presto 的Coordinator/Worker 架构更像 Spark Standalone 模式，只在两个进程和服务中完成。但是Spark更多侧重于 SparkRDD之间依赖关系，Stage失败线性恢复等功能导致有较大开销。Spark Input也直接依赖Hadoop InputFormat API，导致SparkSQL在运行时，并不能把 SQL 优化细节传导到 InputFormat。Presto 弃用 Hadoop InputFormat，但采用类似的数据分区技术，并且可以把 SQL 经过解析后，把Where 条件生成 TupleDomain 传递给 Connector。Connector 能根据字段元数据采用一定程度的索引下推，利用底层系统的索引能力，大大<strong>减少数据扫描区间和参与计算的数据量</strong>。</li><li>Presto 是完全基于内存的并行计算，他不像 <strong>Hive MR/TEZ 需要把中间数据写盘、Spark 需要把溢出的数据写盘</strong>，Presto 是完全假设数据能有效的放入内存。再者，得益于<strong>Presto流水线式的作业计算能力</strong>，在很多 SQL 执行时通过分析SQL的执行计划，能把立即展现的数据立即返回。这也是给用户一种很快的“假象”。但这种“假象”也是无可厚非的，我们即便是从一个结果中提取大量数据，也是遍历游标，等到我们遍历到那个位置，后续的结果数据已经源源不断的计算完成，并不影响我们获得结果</li></ol><h3 id="2-3-Presto-的优点与不足"><a href="#2-3-Presto-的优点与不足" class="headerlink" title="2.3 Presto 的优点与不足"></a>2.3 Presto 的优点与不足</h3><h4 id="2-3-1-presto-优点"><a href="#2-3-1-presto-优点" class="headerlink" title="2.3.1 presto 优点"></a>2.3.1 presto 优点</h4><p>1）<strong>多数据源：</strong>Presto支持MySQL、PostgreSQL、Cassandra、Hive、Kafka、JMX等，多数据源及多数据源之间混合计算；<br>2）<strong>支持 ANSI SQL：</strong>Presto支持<strong>ANSI SQL</strong>，并提供了一个SQL Shell给用户，用户可以直接使用ANSI SQL进行数据查询和计算；<br>3）<strong>扩展性：</strong>Presto有很好的扩展性，开发人员可以很容易地开发出适用于自己特定数据源的Connector，并且可以使用SQL语句查询和分析自定义Connector中的数据；<br>4）<strong>混合计算：</strong>在数据库中每种类型的数据源都对应于一种特定类型的Connector，用户可以根据业务需要在Presto中针对于一种类型的Connector配置一个或者多个Catalog并查询其中的数据，用户可以混合多个Catalog进行join查询和计算；<br>5）<strong>高性能：</strong>低延迟高并发的内存计算引擎，相对hive，无论是mr还是tez还是spark执行引擎，至少提升10倍以上 ；<br>6）<strong>流水线：</strong>presto是基于pipeline进行设计，在进行少量数据处理的过程中，用户无需等到所有数据计算完成才能看到结果，<strong>一旦开始计算就可产生一部分结果返回，后续的计算结果以多个page返回给终端用户（Driver）</strong>。</p><h4 id="2-3-2-Presto-不足"><a href="#2-3-2-Presto-不足" class="headerlink" title="2.3.2 Presto 不足"></a>2.3.2 Presto 不足</h4><p>通过 Presto 执行流程的架构，可以看出 Presto 在查询上也存在一些不足：</p><p>1）<strong>没有容错能力：</strong>当一个 query 分发到多个 Worker 去执行时，当有一个 Worker 因为各种原因查询失败，Master 感知到之后，整个 query 也会失败。<br>2）<strong>内存限制：</strong>由于 Presto 是纯内存计算，所以当内存不够时，Presto 并不会将结果 dump 到磁盘上，所以查询也就失败了。<br>3）<strong>并行查询：</strong>因为所有的 task 都是并行执行，如果其中一台 Worker 因为各种原因查询很慢，那么整个 query 就会变得很慢。<br>4）<strong>并发限制：</strong>因为全内存操作+内存限制，能同时处理的数据量有限，因而导致并发能力不足。</p><h3 id="2-4-Presto-应用场景"><a href="#2-4-Presto-应用场景" class="headerlink" title="2.4 Presto 应用场景"></a>2.4 Presto 应用场景</h3><p>1）<strong>实时计算：</strong>Presto 性能优越，实时查询工具上的重要选择；</p><p>2）<strong>Ad-Hoc查询：</strong>数据分析应用、Presto 根据特定条件的查询返回结果和生成报表；</p><p>3）<strong>ETL：</strong>因支持的数据源广泛、可用于不同数据库之间迁移，转换 和 完成 ETL 清洗的能力；</p><p>4）<strong>实时数据流分析：</strong>Presto-Kafka Connector 使用 SQL对Kafka的数据流进行清洗、分析；</p><p>5）<strong>作为MPP：</strong>Presto Connector 有非常好的扩展性，可进行扩展开发，可支持其他<strong>异构非SQL查询引擎转为SQL</strong>，支持索引下推。</p><blockquote><p>Ad-Hoc：即席查询（Ad Hoc）是用户根据自己的需求，灵活的选择查询条件，系统能够根据用户的选择生成相应的统计报表。即席查询与普通应用查询最大的不同是普通的应用查询是定制开发的，而即席查询是由用户自定义查询条件的。<br>ETL：（Extract-Transform-Load ）用来描述将数据从来源端经过萃取（Extract）、转置（Transform）、加载（Load）至目的端的过程。<br>MPP：Massively Parallel Processor，翻译过来就是大规模并行处理。</p></blockquote><h3 id="2-5-presto-和hive-的对比"><a href="#2-5-presto-和hive-的对比" class="headerlink" title="2.5 presto 和hive 的对比"></a>2.5 presto 和hive 的对比</h3><p>hive和presto是针对不同使用场景的。presto虽然查询很快，但是也不是适用于所有的查询场景。</p><p>比如做多张大表的关联查询，由于presto是基于内存查询的。做大表关联查询时，数据要加载到内存中，假如使用presto查询超过了几分钟才会有返回。且严重影响集群的性能。这就违背了presto交互式查询的初衷，交互式就是要做到近实时查询与返回。所以，presto不适合做多张大表的join操作或者ETL操作。这种情况就该使用hive了。</p><p>虽然能够处理 PB 级别的海量数据分析，但不是代表 Presto 把 PB 级别都放在内存中计算的。而是根据场景，如 count，avg 等聚合运算，是边读数据边计算，再清内存，再读数据再计算，这种耗的内存并不高。但是连表查，就可能产生大量的临时数据，因此速度会变慢，反而 Hive此时会更擅长。</p><p>另外，hive只能做hdfs查询（es等需要插件支持），而presto支持了mysql，pg，kafka，redis等。<strong>presto是支持多数据源的查询利器</strong>。</p><h2 id="三、Presto的优化"><a href="#三、Presto的优化" class="headerlink" title="三、Presto的优化"></a>三、Presto的优化</h2><p>Presto 的优化是一个非常有水平的问题，大致总结下，分如下几个类别</p><h3 id="3-1数据存储"><a href="#3-1数据存储" class="headerlink" title="3.1数据存储"></a>3.1数据存储</h3><p>想要使用 Presto 更高效地查询数据，需要在数据存储方面利用一些优化手段。</p><h4 id="3-1-1-合理设置分区"><a href="#3-1-1-合理设置分区" class="headerlink" title="3.1.1 合理设置分区"></a>3.1.1 合理设置分区</h4><p>与 Hive 类似，Presto 会根据元数据信息读取分区数据，合理地设置分区能减少 Presto 数据读取量，提升查询性能。</p><h4 id="3-1-2-使用-ORC-格式存储"><a href="#3-1-2-使用-ORC-格式存储" class="headerlink" title="3.1.2 使用 ORC 格式存储"></a>3.1.2 使用 ORC 格式存储</h4><p>Presto 对 ORC文件 读取进行了特定优化，因此，在 Hive 中创建 Presto 使用的表时，建议采用 ORC 格式存储。相对于 Parquet 格式，Presto 对 ORC 格式支持得更好。</p><h4 id="3-1-3-使用压缩"><a href="#3-1-3-使用压缩" class="headerlink" title="3.1.3 使用压缩"></a>3.1.3 使用压缩</h4><p>数据压缩可以减少节点间数据传输对 IO 带宽的压力，对于即席查询需要快速解压，建议采用 Snappy压缩。</p><h4 id="3-1-4-预先排序"><a href="#3-1-4-预先排序" class="headerlink" title="3.1.4 预先排序"></a>3.1.4 预先排序</h4><p>对于已经排序的数据，在查询的数据过滤阶段，ORC格式支持跳过读取不必要的数据。比如对于经常需要过滤的字段可以预先排序。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="keyword">table</span> nation_orc <span class="keyword">partition</span>(p) <span class="keyword">SELECT</span> * <span class="keyword">FROM</span> nation <span class="keyword">SORT</span> <span class="keyword">BY</span> n_name;</span><br></pre></td></tr></table></figure><p>如果需要过滤 n_name 字段，则性能将提升。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="keyword">count</span>(*) <span class="keyword">FROM</span> nation_orc <span class="keyword">WHERE</span> n_name=’AUSTRALIA’;</span><br></pre></td></tr></table></figure><h3 id="3-2-SQL查询"><a href="#3-2-SQL查询" class="headerlink" title="3.2 SQL查询"></a>3.2 SQL查询</h3><p>想要使用 Presto更高效地查询数据，需要在编写查询SQL语句方面利用一些优化手段。</p><h4 id="3-2-1-只选择需要的字段"><a href="#3-2-1-只选择需要的字段" class="headerlink" title="3.2.1 只选择需要的字段"></a>3.2.1 只选择需要的字段</h4><p>由于采用列式存储，所以只选择需要的字段可加快字段的读取速度，减少数据量。避免采用 * 读取所有字段。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[GOOD]: <span class="keyword">SELECT</span> <span class="built_in">time</span>,<span class="keyword">user</span>,host <span class="keyword">FROM</span> tbl[BAD]:  <span class="keyword">SELECT</span> * <span class="keyword">FROM</span> tbl</span><br></pre></td></tr></table></figure><h4 id="3-2-2-过滤条件必须加上分区字段"><a href="#3-2-2-过滤条件必须加上分区字段" class="headerlink" title="3.2.2 过滤条件必须加上分区字段"></a>3.2.2 过滤条件必须加上分区字段</h4><p>对于有分区的表，where语句中优先使用分区字段进行过滤。acct_day 是分区字段，visit_time 是具体访问时间。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[GOOD]: <span class="keyword">SELECT</span> <span class="built_in">time</span>,<span class="keyword">user</span>,host <span class="keyword">FROM</span> tbl <span class="keyword">where</span> acct_day=<span class="number">20171101</span>[BAD]:  <span class="keyword">SELECT</span> * <span class="keyword">FROM</span> tbl <span class="keyword">where</span> visit_time=<span class="number">20171101</span></span><br></pre></td></tr></table></figure><h4 id="3-2-3-Group-By语句优化"><a href="#3-2-3-Group-By语句优化" class="headerlink" title="3.2.3 Group By语句优化"></a>3.2.3 Group By语句优化</h4><p>合理安排 Group by语句中字段顺序对性能有一定提升。将 Group By 语句中字段按照每个字段 distinct 数据多少进行降序排列。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[GOOD]: <span class="keyword">SELECT</span> <span class="keyword">GROUP</span> <span class="keyword">BY</span> uid, gender</span><br><span class="line">[BAD]: <span class="keyword">SELECT</span> <span class="keyword">GROUP</span> <span class="keyword">BY</span> gender, uid</span><br></pre></td></tr></table></figure><h4 id="3-2-4-Order-by时使用Limit"><a href="#3-2-4-Order-by时使用Limit" class="headerlink" title="3.2.4 Order by时使用Limit"></a>3.2.4 Order by时使用Limit</h4><p>Order by 需要扫描数据到单个 worker 节点进行排序，导致单个worker需要大量内存。如果是查询 Top N 或者 Bottom N，使用 limit 可减少排序计算和内存压力。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[GOOD]: <span class="keyword">SELECT</span> * <span class="keyword">FROM</span> tbl <span class="keyword">ORDER</span> <span class="keyword">BY</span> <span class="built_in">time</span> <span class="keyword">LIMIT</span> <span class="number">100</span>[BAD]:  <span class="keyword">SELECT</span> * <span class="keyword">FROM</span> tbl <span class="keyword">ORDER</span> <span class="keyword">BY</span> <span class="built_in">time</span></span><br></pre></td></tr></table></figure><h4 id="3-2-5-使用近似聚合函数"><a href="#3-2-5-使用近似聚合函数" class="headerlink" title="3.2.5 使用近似聚合函数"></a>3.2.5 使用近似聚合函数</h4><p>Presto有一些近似聚合函数，对于允许有少量误差的查询场景，使用这些函数对查询性能有大幅提升。比如使用approx_distinct()函数比Count(distinct x)有大概2.3%的误差。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> approx_distinct(user_id) <span class="keyword">FROM</span> <span class="keyword">access</span></span><br></pre></td></tr></table></figure><h4 id="3-2-6-用regexp-like代替多个like语句"><a href="#3-2-6-用regexp-like代替多个like语句" class="headerlink" title="3.2.6 用regexp_like代替多个like语句"></a>3.2.6 用regexp_like代替多个like语句</h4><p>Presto查询优化器没有对多个 like 语句进行优化，使用regexp_like对性能有较大提升。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[GOOD]: <span class="keyword">SELECT</span> ...FROM accessWHERE <span class="keyword">regexp_like</span>(method, <span class="string">'GET|POST|PUT|DELETE'</span>)</span><br><span class="line">[BAD]: <span class="keyword">SELECT</span> ...FROM accessWHERE method <span class="keyword">LIKE</span> <span class="string">'%GET%'</span> <span class="keyword">OR</span> method <span class="keyword">LIKE</span> <span class="string">'%POST%'</span> <span class="keyword">OR</span> method <span class="keyword">LIKE</span> <span class="string">'%PUT%'</span> <span class="keyword">OR</span> method <span class="keyword">LIKE</span> <span class="string">'%DELETE%'</span></span><br></pre></td></tr></table></figure><h4 id="3-2-7-使用Join语句时将大表放在左边"><a href="#3-2-7-使用Join语句时将大表放在左边" class="headerlink" title="3.2.7 使用Join语句时将大表放在左边"></a>3.2.7 使用Join语句时将大表放在左边</h4><p>Presto中 join 的默认算法是broadcast join，即将 join 左边的表分割到多个 worker ，然后将join 右边的表数据整个复制一份发送到每个worker进行计算。如果右边的表数据量太大，则可能会报内存溢出错误。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[GOOD]: <span class="keyword">SELECT</span> ... <span class="keyword">FROM</span> large_table l <span class="keyword">join</span> small_table s <span class="keyword">on</span> l.id = s.id</span><br><span class="line">[BAD]: <span class="keyword">SELECT</span> ... <span class="keyword">FROM</span> small_table s <span class="keyword">join</span> large_table l <span class="keyword">on</span> l.id = s.id</span><br></pre></td></tr></table></figure><h4 id="3-2-8-使用Rank函数代替row-number函数来获取Top-N"><a href="#3-2-8-使用Rank函数代替row-number函数来获取Top-N" class="headerlink" title="3.2.8 使用Rank函数代替row_number函数来获取Top N"></a>3.2.8 使用Rank函数代替row_number函数来获取Top N</h4><p>在进行一些分组排序场景时，使用rank函数性能更好</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[GOOD]: <span class="keyword">SELECT</span> <span class="keyword">checksum</span>(rnk)<span class="keyword">FROM</span> (  <span class="keyword">SELECT</span> <span class="keyword">rank</span>() <span class="keyword">OVER</span> (<span class="keyword">PARTITION</span> <span class="keyword">BY</span> l_orderkey, l_partkey <span class="keyword">ORDER</span> <span class="keyword">BY</span> l_shipdate <span class="keyword">DESC</span>) <span class="keyword">AS</span> rnk  <span class="keyword">FROM</span> lineitem) tWHERE rnk = <span class="number">1</span></span><br><span class="line">[BAD]: <span class="keyword">SELECT</span> <span class="keyword">checksum</span>(rnk)<span class="keyword">FROM</span> (  <span class="keyword">SELECT</span> row_number() <span class="keyword">OVER</span> (<span class="keyword">PARTITION</span> <span class="keyword">BY</span> l_orderkey, l_partkey <span class="keyword">ORDER</span> <span class="keyword">BY</span> l_shipdate <span class="keyword">DESC</span>) <span class="keyword">AS</span> rnk  <span class="keyword">FROM</span> lineitem) tWHERE rnk = <span class="number">1</span></span><br></pre></td></tr></table></figure><h3 id="3-3-注意事项"><a href="#3-3-注意事项" class="headerlink" title="3.3 注意事项"></a>3.3 注意事项</h3><p>ORC和Parquet 都支持列式存储，但是ORC对Presto支持更好（Parquet对Impala支持更好）</p><p>对于列式存储而言，存储文件为二进制的，对于经常增删字段的表，建议不要使用列式存储（修改文件元数据代价大）。对比数据仓库，DWD层建议不要使用ORC，而DM层则建议使用。</p><h4 id="3-3-1-字段名引用"><a href="#3-3-1-字段名引用" class="headerlink" title="3.3.1 字段名引用"></a>3.3.1 字段名引用</h4><p>避免和关键字冲突：MySQL对字段加反引号`、Presto对字段加双引号分割；当然，如果字段名称不是关键字，可以不加这个双引号。</p><h4 id="3-3-2-时间函数"><a href="#3-3-2-时间函数" class="headerlink" title="3.3.2 时间函数"></a>3.3.2 时间函数</h4><p>对于Timestamp，需要进行比较的时候，需要添加Timestamp关键字，而MySQL中对Timestamp可以直接进行比较。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*MySQL的写法*/</span></span><br><span class="line"><span class="keyword">SELECT</span> t <span class="keyword">FROM</span> a <span class="keyword">WHERE</span> t &gt; <span class="string">'2017-01-01 00:00:00'</span>; </span><br><span class="line"></span><br><span class="line"><span class="comment">/*Presto中的写法*/</span></span><br><span class="line"><span class="keyword">SELECT</span> t <span class="keyword">FROM</span> a <span class="keyword">WHERE</span> t &gt; <span class="built_in">timestamp</span> <span class="string">'2017-01-01 00:00:00'</span>;</span><br></pre></td></tr></table></figure><h4 id="3-3-3-不支持INSERT-OVERWRITE语法"><a href="#3-3-3-不支持INSERT-OVERWRITE语法" class="headerlink" title="3.3.3 不支持INSERT OVERWRITE语法"></a>3.3.3 不支持INSERT OVERWRITE语法</h4><p>Presto中不支持 <code>insert overwrite</code> 语法，只能先 <code>delete</code>，然后 <code>insert into</code>。</p><h4 id="3-3-4-PARQUET格式"><a href="#3-3-4-PARQUET格式" class="headerlink" title="3.3.4 PARQUET格式"></a>3.3.4 PARQUET格式</h4><p>Presto目前支持Parquet格式，支持查询，但不支持insert。</p><h2 id="四、Presto-部署"><a href="#四、Presto-部署" class="headerlink" title="四、Presto 部署"></a>四、Presto 部署</h2><h3 id="4-1-Presto-单节点部署"><a href="#4-1-Presto-单节点部署" class="headerlink" title="4.1 Presto 单节点部署"></a>4.1 Presto 单节点部署</h3><h4 id="4-1-1-下载-presto"><a href="#4-1-1-下载-presto" class="headerlink" title="4.1.1 下载 presto"></a>4.1.1 下载 presto</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[hadoop@hadoop1 ~/downloads]$ wget https://repo1.maven.org/maven2/com/facebook/presto/presto-server/0.265.1/presto-server-0.265.1.tar.gz</span><br></pre></td></tr></table></figure><h4 id="4-1-2-配置-presto"><a href="#4-1-2-配置-presto" class="headerlink" title="4.1.2 配置 presto"></a>4.1.2 配置 presto</h4><p><strong>配置 node.properties</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[hadoop@hadoop1 ~]$ tar xf downloads/presto-server-0.265.1.tar.gz</span><br><span class="line">[hadoop@hadoop1 ~]$ cd presto-server-0.265.1/</span><br><span class="line">[hadoop@hadoop1 ~/presto-server-0.265.1]$ mkdir etc</span><br><span class="line">[hadoop@hadoop1 ~/presto-server-0.265.1]$ vim etc/node.properties</span><br><span class="line">node.environment=production</span><br><span class="line">node.id=ffffffff-ffff-ffff-ffff-ffffffffffff</span><br><span class="line">node.data-dir=/opt/data/presto</span><br></pre></td></tr></table></figure><blockquote><p><strong>node.environment：</strong>环境名称。群集中的所有Presto节点必须具有相同的环境名称；<br><strong>node.id：</strong>唯一的标识符 每个节点的node.id 需要不一样；<br><strong>node.data-dir：</strong>数据目录的位置。Presto将在此处存储日志和其他数据。</p></blockquote><p><strong>配置 jvm.config</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[hadoop@hadoop1 ~/presto-server-0.265.1]$ vim etc/jvm.config</span><br><span class="line">-server</span><br><span class="line">-Xmx8000M</span><br><span class="line">-XX:+UseG1GC</span><br><span class="line">-XX:G1HeapRegionSize=32M</span><br><span class="line">-XX:+UseGCOverheadLimit</span><br><span class="line">-XX:+ExplicitGCInvokesConcurrent</span><br><span class="line">-XX:+HeapDumpOnOutOfMemoryError</span><br><span class="line">-XX:+ExitOnOutOfMemoryError</span><br></pre></td></tr></table></figure><p><strong>配置 config.properties</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[hadoop@hadoop1 ~/presto-server-0.265.1]$ vim etc/config.properties</span><br><span class="line">coordinator=true</span><br><span class="line">node-scheduler.include-coordinator=true</span><br><span class="line">http-server.http.port=9527</span><br><span class="line">query.max-memory=5GB</span><br><span class="line">query.max-memory-per-node=6GB</span><br><span class="line">query.max-total-memory-per-node=6GB</span><br><span class="line">discovery-server.enabled=true</span><br><span class="line">discovery.uri=http://localhost:9527</span><br></pre></td></tr></table></figure><blockquote><p><strong>coordinator：</strong>允许这个 Presto 实例充当协调器（接受来自客户端的查询并管理查询执行）。<br><strong>node-scheduler.include-coordinator：</strong>允许在协调器上安排工作。对于较大的集群，协调器上的处理工作会影响查询性能，因为机器的资源无法用于调度、管理和监控查询执行的关键任务。<br><strong>http-server.http.port:</strong> 指定 HTTP 服务器的端口。Presto 使用 HTTP 进行所有内部和外部通信。<br><strong>query.max-memory：</strong>查询可以使用的最大分布式内存量。<br><strong>query.max-memory-per-node：</strong>查询可以在任何一台机器上使用的最大用户内存量。<br><strong>query.max-total-memory-per-node：</strong>查询在任何一台机器上可能使用的最大用户和系统内存量，其中系统内存是读取器、写入器和网络缓冲区等在执行过程中使用的内存。<br><strong>discovery-server.enabled：</strong>Presto 使用 Discovery 服务查找集群中的所有节点。每个 Presto 实例都会在启动时向 Discovery 服务注册自己。为了简化部署并避免运行额外的服务，Presto 协调器可以运行一个嵌入式版本的 Discovery 服务。它与 Presto 共享 HTTP 服务器，因此使用相同的端口。<br><strong>discovery.uri：</strong>发现服务器的 URI。因为我们在 Presto 协调器中启用了 Discovery 的嵌入式版本，所以这应该是 Presto 协调器的 URI。替换<code>example.net:8080</code>以匹配 Presto 协调器的主机和端口。此 URI 不得以斜杠结尾。</p></blockquote><p><strong>配置 log.properties</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[hadoop@hadoop1 ~/presto-server-0.265.1]$ vim etc/log.properties</span><br><span class="line">com.facebook.presto=INFO</span><br></pre></td></tr></table></figure><h4 id="4-1-3-运行-presto"><a href="#4-1-3-运行-presto" class="headerlink" title="4.1.3 运行 presto"></a>4.1.3 运行 presto</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[hadoop@hadoop1 ~/presto-server-0.265.1]$ ./bin/launcher start</span><br></pre></td></tr></table></figure><blockquote><p>bin/launcher start 作为守护进程后台运行<br>bin/launcher run 则是在前台运行</p></blockquote><h4 id="4-1-4-访问-WEB-UI"><a href="#4-1-4-访问-WEB-UI" class="headerlink" title="4.1.4 访问 WEB UI"></a>4.1.4 访问 WEB UI</h4><p><img src="/2021/11/16/presto-fen-bu-shi-sql-cha-xun-yin-qing/%E5%9B%BE%E7%89%872.png" alt="图片2"></p><h3 id="4-2-Presto-集群部署"><a href="#4-2-Presto-集群部署" class="headerlink" title="4.2 Presto 集群部署"></a>4.2 Presto 集群部署</h3><p><strong>服务规划</strong></p><table><thead><tr><th>主机名</th><th>Presto角色</th></tr></thead><tbody><tr><td>hadoop1</td><td>Coordinator</td></tr><tr><td>hadoop2</td><td>Worker</td></tr><tr><td>hadoop3</td><td>Worker</td></tr></tbody></table><h4 id="4-2-1-Coordinator-节点配置"><a href="#4-2-1-Coordinator-节点配置" class="headerlink" title="4.2.1 Coordinator 节点配置"></a>4.2.1 Coordinator 节点配置</h4><p><strong>下载 presto</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[hadoop@hadoop1 ~/downloads]$ wget https://repo1.maven.org/maven2/com/facebook/presto/presto-server/0.265.1/presto-server-0.265.1.tar.gz</span><br></pre></td></tr></table></figure><p><strong>配置 presto</strong></p><p>配置 node.properties</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[hadoop@hadoop1 ~]$ tar xf downloads/presto-server-0.265.1.tar.gz</span><br><span class="line">[hadoop@hadoop1 ~]$ cd presto-server-0.265.1/</span><br><span class="line">[hadoop@hadoop1 ~/presto-server-0.265.1]$ mkdir etc</span><br><span class="line">[hadoop@hadoop1 ~/presto-server-0.265.1]$ vim etc/node.properties</span><br><span class="line">node.environment=production</span><br><span class="line">node.id=ffffffff-ffff-ffff-ffff-ffffffffffff</span><br><span class="line">node.data-dir=/opt/data/presto</span><br></pre></td></tr></table></figure><p>配置 jvm.config</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[hadoop@hadoop1 ~/presto-server-0.265.1]$ vim etc/jvm.config</span><br><span class="line">-server</span><br><span class="line">-Xmx8000M</span><br><span class="line">-XX:+UseG1GC</span><br><span class="line">-XX:G1HeapRegionSize=32M</span><br><span class="line">-XX:+UseGCOverheadLimit</span><br><span class="line">-XX:+ExplicitGCInvokesConcurrent</span><br><span class="line">-XX:+HeapDumpOnOutOfMemoryError</span><br><span class="line">-XX:+ExitOnOutOfMemoryError</span><br></pre></td></tr></table></figure><p>配置 config.properties</p><p>每台Presto服务器都可以充当协调器和工作器。但是专用于一台计算机仅执行协调工作的服务器可以在较大的群集上提供最佳性能。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[hadoop@hadoop1 ~/presto-server-0.265.1]$ vim etc/config.properties</span><br><span class="line">coordinator=true</span><br><span class="line">node-scheduler.include-coordinator=false</span><br><span class="line">http-server.http.port=9527</span><br><span class="line">query.max-memory=5GB</span><br><span class="line">query.max-memory-per-node=6GB</span><br><span class="line">query.max-total-memory-per-node=6GB</span><br><span class="line">discovery-server.enabled=true</span><br><span class="line">discovery.uri=http://localhost:9527</span><br></pre></td></tr></table></figure><p>配置 log.properties</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[hadoop@hadoop1 ~/presto-server-0.265.1]$ vim etc/log.properties</span><br><span class="line">com.facebook.presto=INFO</span><br></pre></td></tr></table></figure><h4 id="4-2-2-Worker-节点配置"><a href="#4-2-2-Worker-节点配置" class="headerlink" title="4.2.2 Worker 节点配置"></a>4.2.2 Worker 节点配置</h4><p>将Coordinator 的presto分发到其它 Worker节点</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[hadoop@hadoop1 ~/presto-server-0.265.1]$ rsync -av presto-server-0.265.1 hadoop@hadoop2:~/</span><br><span class="line">[hadoop@hadoop1 ~/presto-server-0.265.1]$ rsync -av presto-server-0.265.1 hadoop@hadoop3:~/</span><br></pre></td></tr></table></figure><p>修改 node.properties 配置文件，中的 node.id 配置项，每个节点应该是唯一的</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[hadoop@hadoop2 ~/presto-server-0.265.1]$ vim etc/node.properties</span><br><span class="line">node.environment=production</span><br><span class="line">node.id=ffffffff-ffff-ffff-ffff-fffffffff02</span><br><span class="line">node.data-dir=/opt/data/presto</span><br><span class="line"></span><br><span class="line">[hadoop@hadoop3 ~/presto-server-0.265.1]$ vim etc/node.properties</span><br><span class="line">node.environment=production</span><br><span class="line">node.id=ffffffff-ffff-ffff-ffff-fffffffff03</span><br><span class="line">node.data-dir=/opt/data/presto</span><br></pre></td></tr></table></figure><p>修改 config.properties 配置文件</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[hadoop@hadoop2 ~/presto-server-0.265.1]$ vim etc/config.properties</span><br><span class="line">[hadoop@hadoop3 ~/presto-server-0.265.1]$ vim etc/config.properties</span><br><span class="line">coordinator=false #work节点需要填写false</span><br><span class="line">http-server.http.port=9527</span><br><span class="line">query.max-memory=5GB</span><br><span class="line">query.max-memory-per-node=6GB</span><br><span class="line">query.max-total-memory-per-node=6GB</span><br><span class="line">discovery.uri=http://hadoop1:9527</span><br></pre></td></tr></table></figure><h4 id="4-2-3-运行-presto"><a href="#4-2-3-运行-presto" class="headerlink" title="4.2.3 运行 presto"></a>4.2.3 运行 presto</h4><p>集群启动方式与单点的一样，每台都启动起来即可使用。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[hadoop@hadoop1 ~/presto-server-0.265.1]$ ./bin/launcher start</span><br><span class="line">[hadoop@hadoop2 ~/presto-server-0.265.1]$ ./bin/launcher start</span><br><span class="line">[hadoop@hadoop3 ~/presto-server-0.265.1]$ ./bin/launcher start</span><br></pre></td></tr></table></figure><h4 id="4-2-4-访问-WEB-UI"><a href="#4-2-4-访问-WEB-UI" class="headerlink" title="4.2.4 访问 WEB UI"></a>4.2.4 访问 WEB UI</h4><p><img src="/2021/11/16/presto-fen-bu-shi-sql-cha-xun-yin-qing/%E5%9B%BE%E7%89%873.png" alt="图片3"></p><h3 id="4-3-Prest-添加MySQL数据源"><a href="#4-3-Prest-添加MySQL数据源" class="headerlink" title="4.3 Prest 添加MySQL数据源"></a>4.3 Prest 添加MySQL数据源</h3><p>要配置MySQL连接器，请在<code>etc/catalog</code>命名中创建目录属性文件</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[hadoop@hadoop1 ~/presto-server-0.265.1]$ mkdir etc/catalog</span><br></pre></td></tr></table></figure><p><strong>配置 mysql Connector</strong>，只需要在Coordinator 节点上配置</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[hadoop@hadoop1 ~/presto-server-0.265.1]$ vim etc/catalog/mysql.properties</span><br><span class="line">connector.name=mysql</span><br><span class="line">connection-url=jdbc:mysql://192.168.126.145:3306?useUnicode=true&amp;characterEncoding=UTF-8&amp;useSSL=false&amp;autoReconnect=true&amp;failOverReadOnly=false&amp;serverTimezone=GMT%2B10</span><br><span class="line">connection-user=admin</span><br><span class="line">connection-password=abc!@#123ABC</span><br></pre></td></tr></table></figure><p><strong>重启presto服务</strong>，配置完后重启Coordinator 节点的presto服务</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[hadoop@hadoop1 ~/presto-server-0.265.1]$ ./bin/launcher stop</span><br><span class="line">[hadoop@hadoop1 ~/presto-server-0.265.1]$ ./bin/launcher start</span><br></pre></td></tr></table></figure><p>客户端工具连接presto，使用dbeaver客户端连接presto</p><p><img src="/2021/11/16/presto-fen-bu-shi-sql-cha-xun-yin-qing/%E5%9B%BE%E7%89%874.png" alt="图片4"></p><p><img src="/2021/11/16/presto-fen-bu-shi-sql-cha-xun-yin-qing/%E5%9B%BE%E7%89%875.png" alt="图片5"></p><h3 id="4-4-Presto-添加-Hive数据源"><a href="#4-4-Presto-添加-Hive数据源" class="headerlink" title="4.4 Presto 添加 Hive数据源"></a>4.4 Presto 添加 Hive数据源</h3><p><strong>配置 hive Connector</strong>，只需要在Coordinator 节点上配置</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[hadoop@hadoop1 ~/presto-server-0.265.1]$ vim etc/catalog/hive.properties</span><br><span class="line">connector.name=hive-hadoop2</span><br><span class="line">hive.metastore.uri=thrift://hadoop1:9083</span><br><span class="line">hive.config.resources=etc/cluster/core-site.xml,etc/cluster/hdfs-site.xml</span><br></pre></td></tr></table></figure><p>对于基本设置，Presto 会自动配置 HDFS 客户端，不需要任何配置文件。在某些情况下，例如使用联合 HDFS 或 NameNode 高可用性时，需要指定额外的 HDFS 客户端选项才能访问您的 HDFS 集群。为此，添加<code>hive.config.resources</code>属性以引用您的 HDFS 配置文件。</p><p>如果presto运行在非hadoop节点上，则需要将hadoop的<code>core-site.xml</code> 和 <code>hdfs-site.xml</code>配置文件拷贝到所有presto节点上。</p><blockquote><p>但在我的环境中，hdfs和core配置文件只需要存在presto Coordinator 节点就行</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[hadoop@hadoop1 ~/presto-server-0.265.1]$ cp /home/hadoop/hadoop-2.7.2/etc/hadoop/&#123;core,hdfs&#125;-site.xml etc/cluster/</span><br><span class="line">[hadoop@hadoop1 ~/presto-server-0.265.1]$ rsync -sv etc/cluster/ hadoop@hadoop2:~/presto-server-0.265.1/etc/</span><br><span class="line">[hadoop@hadoop1 ~/presto-server-0.265.1]$ rsync -sv etc/cluster/ hadoop@hadoop3:~/presto-server-0.265.1/etc/</span><br></pre></td></tr></table></figure><p>重启所有节点presto服务</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[hadoop@hadoop1 ~/presto-server-0.265.1]$ ./bin/launcher stop</span><br><span class="line">[hadoop@hadoop1 ~/presto-server-0.265.1]$ ./bin/launcher start</span><br></pre></td></tr></table></figure><h3 id="4-5-Presto-基于文件的用户管理配置（不完整，待补充）"><a href="#4-5-Presto-基于文件的用户管理配置（不完整，待补充）" class="headerlink" title="4.5 Presto 基于文件的用户管理配置（不完整，待补充）"></a>4.5 Presto 基于文件的用户管理配置（不完整，待补充）</h3><blockquote><p>只需要在Coordinator 节点上配置</p></blockquote><p><strong>启用密码文件身份认证</strong>，设置 <code>etc/config.properties</code> 中的<a href="https://trino.io/docs/current/security/authentication-types.html" target="_blank" rel="noopener">密码验证类型</a></p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">http-server.authentication.type</span>=<span class="string">PASSWORD</span></span><br></pre></td></tr></table></figure><p><strong>添加 <code>etc/password-authenticator.properties</code> 配置文件</strong>，使用<code>file</code>身份验证器名称在协调器上创建一个文件</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[hadoop@hadoop1 ~/presto-server-0.265.1]$ vim etc/password-authenticator.properties</span><br><span class="line">password-authenticator.name=file</span><br><span class="line">file.password-file=etc/password.db</span><br></pre></td></tr></table></figure><p>可用的配置属性有</p><blockquote><table><thead><tr><th><code>file.password-file</code></th><th>密码文件的路径。</th></tr></thead><tbody><tr><td><code>file.refresh-period</code></td><td>重新加载密码文件的频率。默认为<code>5s</code>.</td></tr><tr><td><code>file.auth-token-cache.max-size</code></td><td>缓存的已验证密码的最大数量。默认为<code>1000</code>.</td></tr></tbody></table></blockquote><p><strong>创建密码文件</strong></p><p>添加用于hive认证的用户</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">创建密码文件</span></span><br><span class="line">[hadoop@hadoop1 ~/presto-server-0.265.1]$ touch etc/password.db</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">创建用户</span></span><br><span class="line">[hadoop@hadoop1 ~/presto-server-0.265.1]$ htpasswd -B -C 10 etc/password.db admin</span><br></pre></td></tr></table></figure><p><strong>配置基于文件的系统访问控制</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[hadoop@hadoop1 ~/presto-server-0.265.1]$ vim etc/access-control.properties</span><br><span class="line">access-control.name=file</span><br><span class="line">security.config-file=etc/rules.json</span><br><span class="line">security.refresh-period=1s</span><br></pre></td></tr></table></figure><p><strong>配置hive用户访问权限规则</strong></p><p>例如，如果你想只允许用户<code>admin</code>访问 <code>mysql</code>和<code>hive</code>目录，允许所有用户访问<code>hive</code> 目录，允许用户<code>hive2</code>用户访问<code>mysql</code>目录，可以使用以下规则</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[hadoop@hadoop1 ~/presto-server-0.265.1]$ vim etc/rules.json</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"catalogs"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">"user"</span>: <span class="string">"admin"</span>,</span><br><span class="line">      <span class="attr">"catalog"</span>: <span class="string">"(mysql|hive)"</span>,</span><br><span class="line">      <span class="attr">"allow"</span>: <span class="string">"all"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">"catalog"</span>: <span class="string">"hive"</span>,</span><br><span class="line">      <span class="attr">"allow"</span>: <span class="string">"read-only"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">"user"</span>: <span class="string">"hive2"</span>,</span><br><span class="line">      <span class="attr">"catalog"</span>: <span class="string">"mysql"</span>,</span><br><span class="line">      <span class="attr">"allow"</span>: <span class="string">"all"</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>以上只能对访问的用户进行权限绑定，至于账户密码认证需要做一些开发上的修改，可以参考：<a href="https://blog.csdn.net/a80090023/article/details/119616321" target="_blank" rel="noopener">https://blog.csdn.net/a80090023/article/details/119616321</a></p></div><div><div><div style="text-align:center;color:#ccc;font-size:14px">-------------本文结束<i class="fa fa-paw"></i>感谢您的阅读-------------</div></div></div><div></div><footer class="post-footer"><div class="post-tags"><a href="/tags/Hadoop/" rel="tag"><i class="fa fa-tag"></i> Hadoop</a> <a href="/tags/OLAP/" rel="tag"><i class="fa fa-tag"></i> OLAP</a> <a href="/tags/Presto/" rel="tag"><i class="fa fa-tag"></i> Presto</a></div><div class="post-nav"><div class="post-nav-next post-nav-item"><a href="/2021/11/16/da-shu-ju-zhu-liu-liu-ji-suan-flink-ji-storm-spark-bi-jiao/" rel="next" title="大数据主流流计算Flink及Storm、Spark比较"><i class="fa fa-chevron-left"></i> 大数据主流流计算Flink及Storm、Spark比较</a></div><span class="post-nav-divider"></span><div class="post-nav-prev post-nav-item"><a href="/2021/11/19/clickhouse-lian-ji-fen-xi-chu-li-olap/" rel="prev" title="ClickHouse 联机分析处理(OLAP)">ClickHouse 联机分析处理(OLAP) <i class="fa fa-chevron-right"></i></a></div></div></footer></div></article><div class="post-spread"><div class="jiathis_style"><span class="jiathis_txt">分享到：</span> <a class="jiathis_button_fav">收藏夹</a> <a class="jiathis_button_copy">复制网址</a> <a class="jiathis_button_email">邮件</a> <a class="jiathis_button_weixin">微信</a> <a class="jiathis_button_qzone">QQ空间</a> <a class="jiathis_button_tqq">腾讯微博</a> <a class="jiathis_button_douban">豆瓣</a> <a class="jiathis_button_share">一键分享</a> <a href="http://www.jiathis.com/share?uid=2140465" class="jiathis jiathis_txt jiathis_separator jtico jtico_jiathis" target="_blank">更多</a> <a class="jiathis_counter_style"></a></div><script type="text/javascript">var jiathis_config={data_track_clickback:!0,summary:"",shortUrl:!1,hideMore:!1}</script><script type="text/javascript" src="http://v3.jiathis.com/code/jia.js?uid=" charset="utf-8"></script></div></div></div></div><div class="sidebar-toggle"><div class="sidebar-toggle-line-wrap"><span class="sidebar-toggle-line sidebar-toggle-line-first"></span> <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span> <span class="sidebar-toggle-line sidebar-toggle-line-last"></span></div></div><aside id="sidebar" class="sidebar"><div id="sidebar-dimmer"></div><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">文章目录</li><li class="sidebar-nav-overview" data-target="site-overview-wrap">站点概览</li></ul><section class="site-overview-wrap sidebar-panel"><div class="site-overview"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="site-author-image" itemprop="image" src="/images/chen.png" alt="Zhongzhou Chen"><p class="site-author-name" itemprop="name">Zhongzhou Chen</p><p class="site-description motion-element" itemprop="description"></p></div><nav class="site-state motion-element"><div class="site-state-item site-state-posts"><a href="/archives/%7C%7C%20archive"><span class="site-state-item-count">312</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"><a href="/categories/index.html"><span class="site-state-item-count">84</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"><a href="/tags/index.html"><span class="site-state-item-count">180</span> <span class="site-state-item-name">标签</span></a></div></nav><div class="feed-link motion-element"><a href="/atom.xml" rel="alternate"><i class="fa fa-rss"></i> RSS</a></div></div></section><section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active"><div class="post-toc"><div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#一、Presto-架构组成"><span class="nav-text">一、Presto 架构组成</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-1-Presto-服务器类型"><span class="nav-text">1.1 Presto 服务器类型</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-1-1-Coordinator"><span class="nav-text">1.1.1 Coordinator</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1-1-2-Worker"><span class="nav-text">1.1.2 Worker</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-2-Presto-数据源"><span class="nav-text">1.2 Presto 数据源</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-2-1-Connector"><span class="nav-text">1.2.1 Connector</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1-2-2-Catalog"><span class="nav-text">1.2.2 Catalog</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1-2-3-Schema"><span class="nav-text">1.2.3 Schema</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1-2-4-Table"><span class="nav-text">1.2.4 Table</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-3-presto-查询模型"><span class="nav-text">1.3 presto 查询模型</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-3-1-Statement"><span class="nav-text">1.3.1 Statement</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1-3-2-Query"><span class="nav-text">1.3.2 Query</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1-3-3-Stage"><span class="nav-text">1.3.3 Stage</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1-3-4-Exchange"><span class="nav-text">1.3.4 Exchange</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1-3-5-Task"><span class="nav-text">1.3.5 Task</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1-3-6-Driver"><span class="nav-text">1.3.6 Driver</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1-3-7-Operator"><span class="nav-text">1.3.7 Operator</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1-3-8-Split"><span class="nav-text">1.3.8 Split</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#二、Presto-其它特性"><span class="nav-text">二、Presto 其它特性</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-1-presto-SQL执行步骤"><span class="nav-text">2.1 presto SQL执行步骤</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2-Presto-低延时查询原理"><span class="nav-text">2.2 Presto 低延时查询原理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-3-Presto-的优点与不足"><span class="nav-text">2.3 Presto 的优点与不足</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#2-3-1-presto-优点"><span class="nav-text">2.3.1 presto 优点</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-3-2-Presto-不足"><span class="nav-text">2.3.2 Presto 不足</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-4-Presto-应用场景"><span class="nav-text">2.4 Presto 应用场景</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-5-presto-和hive-的对比"><span class="nav-text">2.5 presto 和hive 的对比</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#三、Presto的优化"><span class="nav-text">三、Presto的优化</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#3-1数据存储"><span class="nav-text">3.1数据存储</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#3-1-1-合理设置分区"><span class="nav-text">3.1.1 合理设置分区</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-1-2-使用-ORC-格式存储"><span class="nav-text">3.1.2 使用 ORC 格式存储</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-1-3-使用压缩"><span class="nav-text">3.1.3 使用压缩</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-1-4-预先排序"><span class="nav-text">3.1.4 预先排序</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-2-SQL查询"><span class="nav-text">3.2 SQL查询</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#3-2-1-只选择需要的字段"><span class="nav-text">3.2.1 只选择需要的字段</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-2-2-过滤条件必须加上分区字段"><span class="nav-text">3.2.2 过滤条件必须加上分区字段</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-2-3-Group-By语句优化"><span class="nav-text">3.2.3 Group By语句优化</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-2-4-Order-by时使用Limit"><span class="nav-text">3.2.4 Order by时使用Limit</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-2-5-使用近似聚合函数"><span class="nav-text">3.2.5 使用近似聚合函数</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-2-6-用regexp-like代替多个like语句"><span class="nav-text">3.2.6 用regexp_like代替多个like语句</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-2-7-使用Join语句时将大表放在左边"><span class="nav-text">3.2.7 使用Join语句时将大表放在左边</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-2-8-使用Rank函数代替row-number函数来获取Top-N"><span class="nav-text">3.2.8 使用Rank函数代替row_number函数来获取Top N</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-3-注意事项"><span class="nav-text">3.3 注意事项</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#3-3-1-字段名引用"><span class="nav-text">3.3.1 字段名引用</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-3-2-时间函数"><span class="nav-text">3.3.2 时间函数</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-3-3-不支持INSERT-OVERWRITE语法"><span class="nav-text">3.3.3 不支持INSERT OVERWRITE语法</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-3-4-PARQUET格式"><span class="nav-text">3.3.4 PARQUET格式</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#四、Presto-部署"><span class="nav-text">四、Presto 部署</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#4-1-Presto-单节点部署"><span class="nav-text">4.1 Presto 单节点部署</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#4-1-1-下载-presto"><span class="nav-text">4.1.1 下载 presto</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-1-2-配置-presto"><span class="nav-text">4.1.2 配置 presto</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-1-3-运行-presto"><span class="nav-text">4.1.3 运行 presto</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-1-4-访问-WEB-UI"><span class="nav-text">4.1.4 访问 WEB UI</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-2-Presto-集群部署"><span class="nav-text">4.2 Presto 集群部署</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#4-2-1-Coordinator-节点配置"><span class="nav-text">4.2.1 Coordinator 节点配置</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-2-2-Worker-节点配置"><span class="nav-text">4.2.2 Worker 节点配置</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-2-3-运行-presto"><span class="nav-text">4.2.3 运行 presto</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-2-4-访问-WEB-UI"><span class="nav-text">4.2.4 访问 WEB UI</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-3-Prest-添加MySQL数据源"><span class="nav-text">4.3 Prest 添加MySQL数据源</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-4-Presto-添加-Hive数据源"><span class="nav-text">4.4 Presto 添加 Hive数据源</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-5-Presto-基于文件的用户管理配置（不完整，待补充）"><span class="nav-text">4.5 Presto 基于文件的用户管理配置（不完整，待补充）</span></a></li></ol></li></ol></div></div></section><div class="back-to-top"><i class="fa fa-arrow-up"></i> <span id="scrollpercent"><span>0</span>%</span></div></div></aside></div></main><footer id="footer" class="footer"><div class="footer-inner"><script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script><div class="copyright">&copy; <span itemprop="copyrightYear">2021</span> <span class="with-love"><i class="fa fa-user"></i> </span><span class="author" itemprop="copyrightHolder">Zhongzhou Chen</span> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-area-chart"></i> </span><span class="post-meta-item-text">Site words total count&#58;</span> <span title="Site words total count">738.6k</span></div><span class="post-meta-divider"></span></div></footer></div><script type="text/javascript">"[object Function]"!==Object.prototype.toString.call(window.Promise)&&(window.Promise=null)</script><script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script><script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script><script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script><script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script><script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script><script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script><script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script><style>.copy-btn{display:inline-block;padding:6px 12px;font-size:13px;font-weight:700;line-height:20px;color:#333;white-space:nowrap;vertical-align:middle;cursor:pointer;background-color:#eee;background-image:linear-gradient(#fcfcfc,#eee);border:1px solid #d5d5d5;border-radius:3px;user-select:none;outline:0}.highlight-wrap .copy-btn{transition:opacity .3s ease-in-out;opacity:0;padding:2px 6px;position:absolute;right:4px;top:8px}.highlight-wrap .copy-btn:focus,.highlight-wrap:hover .copy-btn{opacity:1}.highlight-wrap{position:relative}</style><script>$(".highlight").each(function(t,e){var n=$("<div>").addClass("highlight-wrap");$(e).after(n),n.append($("<button>").addClass("copy-btn").append("复制").on("click",function(t){var e=$(this).parent().find(".code").find(".line").map(function(t,e){return $(e).text()}).toArray().join("\n"),n=document.createElement("textarea");document.body.appendChild(n),n.style.position="absolute",n.style.top="0px",n.style.left="0px",n.value=e,n.select(),n.focus();var o=document.execCommand("copy");document.body.removeChild(n),o?$(this).text("复制成功"):$(this).text("复制失败"),$(this).blur()})).on("mouseleave",function(t){var e=$(this).find(".copy-btn");setTimeout(function(){e.text("复制")},300)}).append(e)})</script><script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script><script type="text/javascript">function proceedsearch(){$("body").append('<div class="search-popup-overlay local-search-pop-overlay"></div>').css("overflow","hidden"),$(".search-popup-overlay").click(onPopupClose),$(".popup").toggle();var t=$("#local-search-input");t.attr("autocapitalize","none"),t.attr("autocorrect","off"),t.focus()}var isfetched=!1,isXml=!0,search_path="search.xml";0===search_path.length?search_path="search.xml":/json$/i.test(search_path)&&(isXml=!1);var path="/"+search_path,onPopupClose=function(t){$(".popup").hide(),$("#local-search-input").val(""),$(".search-result-list").remove(),$("#no-result").remove(),$(".local-search-pop-overlay").remove(),$("body").css("overflow","")},searchFunc=function(t,e,o){"use strict";$("body").append('<div class="search-popup-overlay local-search-pop-overlay"><div id="search-loading-icon"><i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i></div></div>').css("overflow","hidden"),$("#search-loading-icon").css("margin","20% auto 0 auto").css("text-align","center"),$.ajax({url:t,dataType:isXml?"xml":"json",async:!0,success:function(t){isfetched=!0,$(".popup").detach().appendTo(".header-inner");var n=isXml?$("entry",t).map(function(){return{title:$("title",this).text(),content:$("content",this).text(),url:$("url",this).text()}}).get():t,r=document.getElementById(e),s=document.getElementById(o),a=function(){var t=r.value.trim().toLowerCase(),e=t.split(/[\s\-]+/);e.length>1&&e.push(t);var o=[];if(t.length>0&&n.forEach(function(n){function r(e,o,n,r){for(var s=r[r.length-1],a=s.position,i=s.word,l=[],h=0;a+i.length<=n&&0!=r.length;){i===t&&h++,l.push({position:a,length:i.length});var p=a+i.length;for(r.pop();0!=r.length&&(s=r[r.length-1],a=s.position,i=s.word,p>a);)r.pop()}return c+=h,{hits:l,start:o,end:n,searchTextCount:h}}function s(t,e){var o="",n=e.start;return e.hits.forEach(function(e){o+=t.substring(n,e.position);var r=e.position+e.length;o+='<b class="search-keyword">'+t.substring(e.position,r)+"</b>",n=r}),o+=t.substring(n,e.end)}var a=!1,i=0,c=0,l=n.title.trim(),h=l.toLowerCase(),p=n.content.trim().replace(/<[^>]+>/g,""),u=p.toLowerCase(),f=decodeURIComponent(n.url),d=[],g=[];if(""!=l&&(e.forEach(function(t){function e(t,e,o){var n=t.length;if(0===n)return[];var r=0,s=[],a=[];for(o||(e=e.toLowerCase(),t=t.toLowerCase());(s=e.indexOf(t,r))>-1;)a.push({position:s,word:t}),r=s+n;return a}d=d.concat(e(t,h,!1)),g=g.concat(e(t,u,!1))}),(d.length>0||g.length>0)&&(a=!0,i=d.length+g.length)),a){[d,g].forEach(function(t){t.sort(function(t,e){return e.position!==t.position?e.position-t.position:t.word.length-e.word.length})});var v=[];0!=d.length&&v.push(r(l,0,l.length,d));for(var $=[];0!=g.length;){var C=g[g.length-1],m=C.position,x=C.word,w=m-20,y=m+80;0>w&&(w=0),y<m+x.length&&(y=m+x.length),y>p.length&&(y=p.length),$.push(r(p,w,y,g))}$.sort(function(t,e){return t.searchTextCount!==e.searchTextCount?e.searchTextCount-t.searchTextCount:t.hits.length!==e.hits.length?e.hits.length-t.hits.length:t.start-e.start});var T=parseInt("1");T>=0&&($=$.slice(0,T));var b="";b+=0!=v.length?"<li><a href='"+f+"' class='search-result-title'>"+s(l,v[0])+"</a>":"<li><a href='"+f+"' class='search-result-title'>"+l+"</a>",$.forEach(function(t){b+="<a href='"+f+'\'><p class="search-result">'+s(p,t)+"...</p></a>"}),b+="</li>",o.push({item:b,searchTextCount:c,hitCount:i,id:o.length})}}),1===e.length&&""===e[0])s.innerHTML='<div id="no-result"><i class="fa fa-search fa-5x" /></div>';else if(0===o.length)s.innerHTML='<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>';else{o.sort(function(t,e){return t.searchTextCount!==e.searchTextCount?e.searchTextCount-t.searchTextCount:t.hitCount!==e.hitCount?e.hitCount-t.hitCount:e.id-t.id});var a='<ul class="search-result-list">';o.forEach(function(t){a+=t.item}),a+="</ul>",s.innerHTML=a}};r.addEventListener("input",a),$(".local-search-pop-overlay").remove(),$("body").css("overflow",""),proceedsearch()}})};$(".popup-trigger").click(function(t){t.stopPropagation(),isfetched===!1?searchFunc(path,"local-search-input","local-search-result"):proceedsearch()}),$(".popup-btn-close").click(onPopupClose),$(".popup").click(function(t){t.stopPropagation()}),$(document).on("keyup",function(t){var e=27===t.which&&$(".search-popup").is(":visible");e&&onPopupClose()})</script><script type="text/javascript" src="/js/src/love.js"></script><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({pluginRootPath:"live2dw/",pluginJsPath:"lib/",pluginModelPath:"assets/",tagMode:!1,log:!1,model:{jsonPath:"/live2dw/assets/shizuku.model.json"},display:{position:"right"},mobile:{show:!0,scale:.5},react:{opacityDefault:.7,opacityOnHover:.2}})</script></body></html><!-- rebuild by neat -->