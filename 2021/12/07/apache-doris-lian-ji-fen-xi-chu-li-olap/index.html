<!DOCTYPE html><html class="theme-next gemini use-motion" lang="zh-Hans"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><script src="//cdn.bootcss.com/pace/1.0.2/pace.min.js"></script><link href="//cdn.bootcss.com/pace/1.0.2/themes/pink/pace-theme-flash.css" rel="stylesheet"><script></script><meta name="theme-color" content="#222"><style>.pace .pace-progress{background:#1e92fb;height:3px}.pace .pace-progress-inner{box-shadow:0 0 10px #1e92fb,0 0 5px #1e92fb}.pace .pace-activity{border-top-color:#1e92fb;border-left-color:#1e92fb}</style><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><meta name="google-site-verification" content="HGM141IpbHrSmnAmR6W_zE4bo9Z3f-yXLeHYT3bg1fk"><meta name="baidu-site-verification" content="code-5Ai1DA8e6T"><link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css"><link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css"><link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4"><link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222"><meta name="keywords" content="Hadoop,Apache Doris,OLAP,"><link rel="alternate" href="/atom.xml" title="凡间的精灵" type="application/atom+xml"><meta name="description" content="一、概述Apache Doris（原百度 Palo）是一款基于大规模并行处理（MPP）技术的联机分析处理查询（OLAP）系统，由百度在 2017 年开源，2018 年 8 月进入 Apache 孵化。MPP ( Massively Parallel Processing，大规模并行处理)，在数据库非共享集群中，每个节点都有独立的磁盘存储系统和内存系统，业务数据根据数据库模型和应用特点划分到各个节点"><meta name="keywords" content="Hadoop,Apache Doris,OLAP"><meta property="og:type" content="article"><meta property="og:title" content="Apache Doris 联机分析处理(OLAP)"><meta property="og:url" content="http:&#x2F;&#x2F;chenzhonzhou.github.io&#x2F;2021&#x2F;12&#x2F;07&#x2F;apache-doris-lian-ji-fen-xi-chu-li-olap&#x2F;index.html"><meta property="og:site_name" content="凡间的精灵"><meta property="og:description" content="一、概述Apache Doris（原百度 Palo）是一款基于大规模并行处理（MPP）技术的联机分析处理查询（OLAP）系统，由百度在 2017 年开源，2018 年 8 月进入 Apache 孵化。MPP ( Massively Parallel Processing，大规模并行处理)，在数据库非共享集群中，每个节点都有独立的磁盘存储系统和内存系统，业务数据根据数据库模型和应用特点划分到各个节点"><meta property="og:locale" content="zh-Hans"><meta property="og:image" content="http:&#x2F;&#x2F;chenzhonzhou.github.io&#x2F;2021&#x2F;12&#x2F;07&#x2F;apache-doris-lian-ji-fen-xi-chu-li-olap&#x2F;%E5%9B%BE%E7%89%874.png"><meta property="og:image" content="http:&#x2F;&#x2F;chenzhonzhou.github.io&#x2F;2021&#x2F;12&#x2F;07&#x2F;apache-doris-lian-ji-fen-xi-chu-li-olap&#x2F;%E5%9B%BE%E7%89%871.png"><meta property="og:image" content="http:&#x2F;&#x2F;chenzhonzhou.github.io&#x2F;2021&#x2F;12&#x2F;07&#x2F;apache-doris-lian-ji-fen-xi-chu-li-olap&#x2F;%E5%9B%BE%E7%89%872.png"><meta property="og:image" content="http:&#x2F;&#x2F;chenzhonzhou.github.io&#x2F;2021&#x2F;12&#x2F;07&#x2F;apache-doris-lian-ji-fen-xi-chu-li-olap&#x2F;%E5%9B%BE%E7%89%873.png"><meta property="og:image" content="http:&#x2F;&#x2F;chenzhonzhou.github.io&#x2F;2021&#x2F;12&#x2F;07&#x2F;apache-doris-lian-ji-fen-xi-chu-li-olap&#x2F;%E5%9B%BE%E7%89%875.png"><meta property="og:image" content="http:&#x2F;&#x2F;chenzhonzhou.github.io&#x2F;2021&#x2F;12&#x2F;07&#x2F;apache-doris-lian-ji-fen-xi-chu-li-olap&#x2F;%E5%9B%BE%E7%89%876.png"><meta property="og:updated_time" content="2021-12-08T10:58:57.735Z"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="http:&#x2F;&#x2F;chenzhonzhou.github.io&#x2F;2021&#x2F;12&#x2F;07&#x2F;apache-doris-lian-ji-fen-xi-chu-li-olap&#x2F;%E5%9B%BE%E7%89%874.png"><script type="text/javascript" id="hexo.configurations">var NexT=window.NexT||{},CONFIG={root:"/",scheme:"Gemini",version:"5.1.4",sidebar:{position:"left",display:"always",offset:12,b2t:!0,scrollpercent:!0,onmobile:!0},fancybox:!0,tabs:!0,motion:{enable:!0,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}},duoshuo:{userId:"0",author:"博主"},algolia:{applicationID:"",apiKey:"",indexName:"",hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}}}</script><link rel="canonical" href="http://chenzhonzhou.github.io/2021/12/07/apache-doris-lian-ji-fen-xi-chu-li-olap/"><title>Apache Doris 联机分析处理(OLAP) | 凡间的精灵</title><link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css"></head><body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans"><div class="container sidebar-position-left page-post-detail"><div class="headband"></div><header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-wrapper"><div class="site-meta"><div class="custom-logo-site-title"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">凡间的精灵</span><span class="logo-line-after"><i></i></span></a></div><p class="site-subtitle">凡尘落素一精灵</p></div><div class="site-nav-toggle"><button><span class="btn-bar"></span><span class="btn-bar"></span><span class="btn-bar"></span></button></div></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i><br>首页</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i><br>归档</a></li><li class="menu-item menu-item-categories"><a href="/categories" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i><br>分类</a></li><li class="menu-item menu-item-tags"><a href="/tags" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i><br>标签</a></li><li class="menu-item menu-item-sitemap"><a href="/sitemap.xml" rel="section"><i class="menu-item-icon fa fa-fw fa-sitemap"></i><br>站点地图</a></li><li class="menu-item menu-item-search"><a href="javascript:;" class="popup-trigger"><i class="menu-item-icon fa fa-search fa-fw"></i><br>搜索</a></li></ul><div class="site-search"><div class="popup search-popup local-search-popup"><div class="local-search-header clearfix"><span class="search-icon"><i class="fa fa-search"></i></span><span class="popup-btn-close"><i class="fa fa-times-circle"></i></span><div class="local-search-input-wrapper"><input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input"></div></div><div id="local-search-result"></div></div></div></nav></div></header><main id="main" class="main"><div class="main-inner"><div class="content-wrap"><div id="content" class="content"><div id="posts" class="posts-expand"><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><div class="post-block"><link itemprop="mainEntityOfPage" href="http://chenzhonzhou.github.io/2021/12/07/apache-doris-lian-ji-fen-xi-chu-li-olap/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="name" content="Zhongzhou Chen"><meta itemprop="description" content=""><meta itemprop="image" content="/images/chen.png"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="凡间的精灵"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">Apache Doris 联机分析处理(OLAP)</h1><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i></span> <span class="post-meta-item-text">发表于</span> <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-12-07T10:31:35+08:00">2021-12-07</time></span> <span class="post-category"><span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-folder-o"></i></span> <span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Hadoop/" itemprop="url" rel="index"><span itemprop="name">Hadoop</span></a></span></span><div class="post-wordcount"><span class="post-meta-item-icon"><i class="fa fa-file-word-o"></i></span> <span class="post-meta-item-text">字数统计&#58;</span> <span title="字数统计">12.6k</span> <span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-clock-o"></i></span> <span class="post-meta-item-text">阅读时长 &asymp;</span> <span title="阅读时长">48</span></div></div></header><div class="post-body" itemprop="articleBody"><h2 id="一、概述"><a href="#一、概述" class="headerlink" title="一、概述"></a>一、概述</h2><p><a href="https://doris.apache.org/master/zh-CN/" target="_blank" rel="noopener">Apache Doris</a>（原百度 Palo）是一款<strong>基于大规模并行处理（MPP）技术的联机分析处理查询（OLAP）系统</strong>，由百度在 2017 年开源，2018 年 8 月进入 Apache 孵化。</p><p><strong>MPP ( Massively Parallel Processing，大规模并行处理)</strong>，在数据库非共享集群中，每个节点都有独立的磁盘存储系统和内存系统，业务数据根据数据库模型和应用特点划分到各个节点上，每台数据节点通过专用网络或者商业通用网络互相连接，彼此协同计算，作为整体提供数据库服务。非共享数据库集群有完全的可伸缩性、高可用、高性能、优秀的性价比、资源共享等优势。简单来说，MPP 是将任务并行的分散到多个服务器和节点上，在每个节点上计算完成后，将各自部分的结果汇总在一起得到最终的结果 ( 与 Hadoop 相似 )。</p><p><strong>OLAP（On-line Analytical Processing，联机分析处理）</strong>是在基于数据仓库多维模型的基础上实现的面向分析的各类操作的集合。</p><p>Apache Doris 仅需亚秒级响应时间即可获得查询结果，有效地支持实时数据分析。Apache Doris的分布式架构非常简洁，易于运维，并且可以支持10PB以上的超大数据集。Apache Doris可以满足多种数据分析需求，例如固定<strong>历史报表</strong>，<strong>实时数据分析</strong>，<strong>交互式数据分析</strong>和<strong>探索式数据分析</strong>等。让数据分析工作更加简单高效！</p><p>Doris 主要解决 PB 级别的数据量（如果高于 PB 级别，不推荐使用 Doris 解决，可以考虑用 Hive 等工具），解决结构化数据，查询时间一般在<strong>秒级</strong>或<strong>毫秒级</strong>。</p><p><img src="/2021/12/07/apache-doris-lian-ji-fen-xi-chu-li-olap/%E5%9B%BE%E7%89%874.png" alt="图片4"></p><h2 id="二、Doris-架构"><a href="#二、Doris-架构" class="headerlink" title="二、Doris 架构"></a>二、Doris 架构</h2><h3 id="2-1-整体架构"><a href="#2-1-整体架构" class="headerlink" title="2.1 整体架构"></a>2.1 整体架构</h3><p><img src="/2021/12/07/apache-doris-lian-ji-fen-xi-chu-li-olap/%E5%9B%BE%E7%89%871.png" alt="图片1"></p><p>Doris 的架构很简洁，只设 <strong>FE(Frontend)</strong>、<strong>BE(Backend)</strong>两种角色，不依赖于外部组件，方便部署和运维。</p><blockquote><ul><li>FE：Frontend，即 Doris 的前端节点。主要负责接收和返回客户端请求、元数据以及集群管理、查询计划生成等工作。</li><li>BE：Backend，即 Doris 的后端节点。主要负责数据存储与管理、查询计划执行等工作。</li></ul></blockquote><p>在整个架构中FE，BE都可线性扩展。</p><p>FE 主要有有三个角色，一个是 leader，一个是 follower，还有一个 observer。leader 跟 follower，主要是用来达到元数据的高可用，保证单节点宕机的情况下，元数据能够实时地在线恢复，而不影响整个服务。</p><p>右边 observer 只是用来扩展查询节点，就是说如果在发现集群压力非常大的情况下，需要去扩展整个查询的能力，那么可以加 observer 的节点。observer 不参与任何的写入，只参与读取。</p><p>数据的可靠性由 BE 保证，BE 会对整个数据存储多副本或者是三副本。副本数可根据需求动态调整。</p><h3 id="2-2-元数据"><a href="#2-2-元数据" class="headerlink" title="2.2 元数据"></a>2.2 元数据</h3><p>Doris 采用 Paxos 协议以及 Memory + Checkpoint + Journal 的机制来确保元数据的高性能及高可靠。元数据的每次更新，都首先写入到磁盘的日志文件中，然后再写到内存中，最后定期 checkpoint 到本地磁盘上。相当于是一个纯内存的一个结构，也就是说所有的元数据都会缓存在内存之中，从而保证 FE 在宕机后能够快速恢复元数据，而且不丢失元数据。Leader、follower 和 observer 它们三个构成一个可靠的服务，一般是部署一个 leader 两个 follower，在单机节点故障的时候其实基本上三个就够了，因为 FE 节点毕竟它只存了一份元数据，它的压力不大，所以如果 FE 太多的时候它会去消耗机器资源，所以多数情况下三个就足够了，可以达到一个很高可用的元数据服务。</p><p>在百度内部，一个包含2500张表，100万个分片（300万副本）的集群，元数据在内存中仅占用约 2GB。（当然，查询所使用的中间对象、各种作业信息等内存开销，需要根据实际情况估算。但总体依然维持在一个较低的内存开销范围内。）</p><p>同时，元数据在内存中整体采用树状的层级结构存储，并且通过添加辅助结构，能够快速访问各个层级的元数据信息。</p><p><img src="/2021/12/07/apache-doris-lian-ji-fen-xi-chu-li-olap/%E5%9B%BE%E7%89%872.png" alt="图片2"></p><p>如上图，Doris 的元数据主要存储4类数据：</p><blockquote><ul><li>用户数据信息。包括数据库、表的 Schema、分片信息等。</li><li>各类作业信息。如导入作业，Clone 作业、SchemaChange 作业等。</li><li>用户及权限信息。</li><li>集群及节点信息。</li></ul></blockquote><h3 id="2-3-数据流"><a href="#2-3-数据流" class="headerlink" title="2.3 数据流"></a>2.3 数据流</h3><p><img src="/2021/12/07/apache-doris-lian-ji-fen-xi-chu-li-olap/%E5%9B%BE%E7%89%873.png" alt="图片3"></p><p>元数据的数据流具体过程如下：</p><ol><li>只有 leader FE 可以对元数据进行写操作。写操作在修改 leader 的内存后，会序列化为一条log，按照 key-value 的形式写入 bdbje。其中 key 为连续的整型，作为 log id，value 即为序列化后的操作日志。</li><li>日志写入 bdbje 后，bdbje 会根据策略（写多数/全写），将日志复制到其他 non-leader 的 FE 节点。non-leader FE 节点通过对日志回放，修改自身的元数据内存镜像，完成与 leader 节点的元数据同步。</li><li>leader 节点的日志条数达到阈值后（默认 10w 条），会启动 checkpoint 线程。checkpoint 会读取已有的 image 文件，和其之后的日志，重新在内存中回放出一份新的元数据镜像副本。然后将该副本写入到磁盘，形成一个新的 image。之所以是重新生成一份镜像副本，而不是将已有镜像写成 image，主要是考虑写 image 加读锁期间，会阻塞写操作。所以每次 checkpoint 会占用双倍内存空间。</li><li>image 文件生成后，leader 节点会通知其他 non-leader 节点新的 image 已生成。non-leader 主动通过 http 拉取最新的 image 文件，来更换本地的旧文件。</li><li>bdbje 中的日志，在 image 做完后，会定期删除旧的日志。</li></ol><blockquote><p>bdbje：<a href="http://www.oracle.com/technetwork/database/berkeleydb/overview/index-093405.html" target="_blank" rel="noopener">Oracle Berkeley DB Java Edition (opens new window)</a>。在 Doris 中，使用 bdbje 完成元数据操作日志的持久化、FE 高可用等功能。</p></blockquote><h3 id="2-3-实现细节"><a href="#2-3-实现细节" class="headerlink" title="2.3 实现细节"></a>2.3 实现细节</h3><h4 id="2-3-1-元数据目录"><a href="#2-3-1-元数据目录" class="headerlink" title="2.3.1 元数据目录"></a>2.3.1 元数据目录</h4><ol><li>元数据目录通过 FE 的配置项 <code>meta_dir</code> 指定。</li><li><code>bdb/</code> 目录下为 bdbje 的数据存放目录。</li><li><code>image/</code> 目录下为 image 文件的存放目录。<ul><li><code>image.[logid]</code> 是最新的 image 文件。后缀 <code>logid</code> 表明 image 所包含的最后一条日志的 id。</li><li><code>image.ckpt</code> 是正在写入的 image 文件，如果写入成功，会重命名为 <code>image.[logid]</code>，并替换掉旧的 image 文件。</li><li><code>VERSION</code> 文件中记录着 <code>cluster_id</code>。<code>cluster_id</code> 唯一标识一个 Doris 集群。是在 leader 第一次启动时随机生成的一个 32 位整型。也可以通过 fe 配置项 <code>cluster_id</code> 来指定一个 cluster id。</li><li><code>ROLE</code> 文件中记录的 FE 自身的角色。只有 <code>FOLLOWER</code> 和 <code>OBSERVER</code> 两种。其中 <code>FOLLOWER</code> 表示 FE 为一个可选举的节点。（注意：即使是 leader 节点，其角色也为 <code>FOLLOWER</code>）</li></ul></li></ol><h4 id="2-3-2-启动流程"><a href="#2-3-2-启动流程" class="headerlink" title="2.3.2 启动流程"></a>2.3.2 启动流程</h4><ol><li><p>FE 第一次启动，如果启动脚本不加任何参数，则会尝试以 leader 的身份启动。在 FE 启动日志中会最终看到 <code>transfer from UNKNOWN to MASTER</code>。</p></li><li><p>FE 第一次启动，如果启动脚本中指定了 <code>-helper</code> 参数，并且指向了正确的 leader FE 节点，那么该 FE 首先会通过 http 向 leader 节点询问自身的角色（即 ROLE）和 cluster_id。然后拉取最新的 image 文件。读取 image 文件，生成元数据镜像后，启动 bdbje，开始进行 bdbje 日志同步。同步完成后，开始回放 bdbje 中，image 文件之后的日志，完成最终的元数据镜像生成。</p><blockquote><p>注1：使用 <code>-helper</code> 参数启动时，需要首先通过 mysql 命令，通过 leader 来添加该 FE，否则，启动时会报错。</p></blockquote><blockquote><p>注2：<code>-helper</code> 可以指向任何一个 follower 节点，即使它不是 leader。</p></blockquote><blockquote><p>注2：bdbje 在同步日志过程中，fe 日志会显示 <code>xxx detached</code>, 此时正在进行日志拉取，属于正常现象。</p></blockquote></li><li><p>FE 非第一次启动，如果启动脚本不加任何参数，则会根据本地存储的 ROLE 信息，来确定自己的身份。同时根据本地 bdbje 中存储的集群信息，获取 leader 的信息。然后读取本地的 image 文件，以及 bdbje 中的日志，完成元数据镜像生成。（如果本地 ROLE 中记录的角色和 bdbje 中记录的不一致，则会报错。）</p></li><li><p>FE 非第一次启动，且启动脚本中指定了 <code>-helper</code> 参数。则和第一次启动的流程一样，也会先去询问 leader 角色。但是会和自身存储的 ROLE 进行比较。如果不一致，则会报错。</p></li></ol><p><strong>元数据读写与同步</strong></p><ol><li><p>用户可以使用 mysql 连接任意一个 FE 节点进行元数据的读写访问。如果连接的是 non-leader 节点，则该节点会将写操作转发给 leader 节点。leader 写成功后，会返回一个 leader 当前最新的 log id。之后，non-leader 节点会等待自身回放的 log id 大于回传的 log id 后，才将命令成功的消息返回给客户端。这种方式保证了任意 FE 节点的 Read-Your-Write 语义。</p><blockquote><p>注：一些非写操作，也会转发给 leader 执行。比如 <code>SHOW LOAD</code> 操作。因为这些命令通常需要读取一些作业的中间状态，而这些中间状态是不写 bdbje 的，因此 non-leader 节点的内存中，是没有这些中间状态的。（FE 之间的元数据同步完全依赖 bdbje 的日志回放，如果一个元数据修改操作不写 bdbje 日志，则在其他 non-leader 节点中是看不到该操作修改后的结果的。）</p></blockquote></li><li><p>leader 节点会启动一个 TimePrinter 线程。该线程会定期向 bdbje 中写入一个当前时间的 key-value 条目。其余 non-leader 节点通过回放这条日志，读取日志中记录的时间，和本地时间进行比较，如果发现和本地时间的落后大于指定的阈值（配置项：<code>meta_delay_toleration_second</code>。写入间隔为该配置项的一半），则该节点会处于<strong>不可读</strong>的状态。此机制解决了 non-leader 节点在长时间和 leader 失联后，仍然提供过期的元数据服务的问题。</p></li><li><p>各个 FE 的元数据只保证最终一致性。正常情况下，不一致的窗口期仅为毫秒级。我们保证同一 session 中，元数据访问的单调一致性。但是如果同一 client 连接不同 FE，则可能出现元数据回退的现象。（但对于批量更新系统，该问题影响很小。）</p></li></ol><h3 id="2-4-宕机恢复"><a href="#2-4-宕机恢复" class="headerlink" title="2.4 宕机恢复"></a>2.4 宕机恢复</h3><ol><li>leader 节点宕机后，其余 follower 会立即选举出一个新的 leader 节点提供服务。</li><li>当多数 follower 节点宕机时，元数据不可写入。当元数据处于不可写入状态下，如果这时发生写操作请求，目前的处理流程是 <strong>FE 进程直接退出</strong>。后续会优化这个逻辑，在不可写状态下，依然提供读服务。</li><li>observer 节点宕机，不会影响任何其他节点的状态。也不会影响元数据在其他节点的读写。</li></ol><h3 id="2-5-核心特性"><a href="#2-5-核心特性" class="headerlink" title="2.5 核心特性"></a>2.5 核心特性</h3><p><strong>MySQL协议兼容</strong></p><p>Doris提供兼容MySQL协议的连接接口，使得用户不必再单独部署新的客户端库或者工具，可以直接使用MySQL的相关库或者工具；由于提供了MySQL接口，也容易与上层应用兼容；用户学习曲线降低，方便用户上手使用。</p><p><strong>大查询高吞吐</strong></p><p>利用MPP架构的优势，使得查询能够分布式的在多个节点并行执行，充分利用集群整体计算资源，提高大查询的吞吐能力。</p><p><strong>高并发小查询</strong></p><p>通过使用分区裁剪、预聚合，谓词下推，向量化执行、异步RPC等技术，Doris可以支持高并发点查询场景。100台集群可达10w QPS。</p><p><strong>数据更新</strong></p><p>Doris 支持按主键删除和更新数据。能够方便的从 MySQL 等事务数据库中同步实时更新的数据。</p><p><strong>高可用和高可靠</strong></p><p>Doris中的数据和元数据都默认使用3副本存储（Leader Node节点和Compute Node节点需各自大于等于3）。在少数节点宕机的情况下，依然可以保证数据的可靠性。 Doris会自动检查和修复损坏的数据，并将请求自动路由到健康的节点，7*24 小时保证数据的可用性。</p><p><strong>水平扩展和数据均衡</strong></p><p>Leader Node节点和Compute Node节点都可以进行横向扩展。用户可以根据计算和存储需要，灵活的对节点进行扩展。其中Compute Node节点在扩展后，Doris会自动根据节点间的负载情况，进行数据分片的自动均衡，无需人工干预。</p><p><strong>物化视图和预聚合引擎</strong></p><p>Doris支持通过物化视图或上卷表的形式对数据预聚合计算后的结果进行存储，从而加速部分聚合类场景的查询效率。同时，Doris能够保证物化视图和基础表之间的数据一致性，从而使得物化视图会查询和导入完全透明。Doris内部会自动根据用户的查询语句，选择合适的物化视图进行数据摄取。</p><p><strong>丰富的数据导入功能和导入事务保证</strong></p><p>Doris支持多种导入方式。不仅支持近实时的流式导入，也支持大批量的数据导入。同时还可以直接订阅和消费kafka中的数据。Doris自身提供导入事务支持，配合导入Label机制，可以保证导入数据的不丢不重和原子一致性。</p><p><strong>高效的列式存储引擎</strong></p><p>Doris采用自研的列式存储格式来提升OLAP领域的查询效率。存储采用字典编码、RLE等多种编码方式，配合列式存储的特点，提供了非常高的数据压缩比，帮助用户节省存储空间。同时，存储格式上提供包括Min/Max智能索引、稀疏索引、布隆过滤器、bitmap倒排索引等多种查询加速技术，进一步提升了查询效率。</p><p><strong>在线表结构修改</strong></p><p>支持在已导入数据的情况下修改表结构，包括增加列、删除列、修改列类型和改变列顺序等操作。变更操作不会影响当前数据库的查询和写入操作。</p><p><strong>丰富的生态</strong></p><p>Doris可以方便的导入存储在对象存储、HDFS或Kafka中的数据。用户也可以通过Spark来直接查询Doris中存储的数据。而Doris也可以通过ODBC读取包括MySQL、PostgreSQL、SQLServer、Oracle等外部数据源的数据。同时，Doris也可以读取Elasticsearch中存储的数据，为Elasticsearch提供强大的分布式SQL查询层。</p><h2 id="三、Doris-编译与部署"><a href="#三、Doris-编译与部署" class="headerlink" title="三、Doris 编译与部署"></a>三、Doris 编译与部署</h2><p>不想编译的话可以下载 Baidu Doris 团队基于 Apache Doris 的百度<a href="https://cloud.baidu.com/doc/PALO/s/Wksis5irl" target="_blank" rel="noopener">开源版本</a></p><h3 id="3-1-编译"><a href="#3-1-编译" class="headerlink" title="3.1 编译"></a>3.1 编译</h3><blockquote><p>使用 Docker 开发镜像编译（推荐）</p></blockquote><h4 id="3-1-1-下载-Docker-镜像"><a href="#3-1-1-下载-Docker-镜像" class="headerlink" title="3.1.1 下载 Docker 镜像"></a>3.1.1 下载 Docker 镜像</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> docker pull apache/incubator-doris:build-env-1.4.2</span></span><br></pre></td></tr></table></figure><p><strong>注：</strong>针对不同的 Doris 版本，需要下载对应的镜像版本</p><table><thead><tr><th>镜像版本</th><th>commit id</th><th>doris 版本</th></tr></thead><tbody><tr><td>apache/incubator-doris:build-env</td><td>before <a href="https://github.com/apache/incubator-doris/commit/ff0dd0d2daa588f18b6db56f947e813a56d8ec81" target="_blank" rel="noopener">ff0dd0d(opens new window)</a></td><td>0.8.x, 0.9.x</td></tr><tr><td>apache/incubator-doris:build-env-1.1</td><td><a href="https://github.com/apache/incubator-doris/commit/ff0dd0d2daa588f18b6db56f947e813a56d8ec81" target="_blank" rel="noopener">ff0dd0d(opens new window)</a></td><td>0.10.x, 0.11.x</td></tr><tr><td>apache/incubator-doris:build-env-1.2</td><td><a href="https://github.com/apache/incubator-doris/commit/4ef5a8c8560351d7fff7ff8fd51c4c7a75e006a8" target="_blank" rel="noopener">4ef5a8c(opens new window)</a></td><td>0.12.x - 0.14.0</td></tr><tr><td>apache/incubator-doris:build-env-1.3.1</td><td><a href="https://github.com/apache/incubator-doris/commit/ad67dd34a04c1ca960cff38e5b335b30fc7d559f" target="_blank" rel="noopener">ad67dd3(opens new window)</a></td><td>0.14.x</td></tr><tr><td>apache/incubator-doris:build-env-1.4.1</td><td><a href="https://github.com/apache/incubator-doris/commit/24d38614a0f21ed606462816a262c2e1d8273ace" target="_blank" rel="noopener">24d3861 (opens new window)</a>or later</td><td>0.15.x(releasing)</td></tr><tr><td>apache/incubator-doris:build-env-1.4.2</td><td><a href="https://github.com/apache/incubator-doris/commit/a81f4da4e461a54782a96433b746d07be89e6b54" target="_blank" rel="noopener">a81f4da (opens new window)</a>or later</td><td>0.15.x(releasing)</td></tr></tbody></table><p><strong>注意</strong>：</p><blockquote><ol><li>编译镜像 <a href="https://github.com/apache/incubator-doris/blob/master/thirdparty/CHANGELOG.md" target="_blank" rel="noopener">ChangeLog (opens new window)</a>。</li></ol></blockquote><blockquote><ol><li>doris 0.14.0 版本仍然使用apache/incubator-doris:build-env-1.2 编译，之后的代码将使用apache/incubator-doris:build-env-1.3.1。</li></ol></blockquote><blockquote><ol><li>在 build-env-1.3.1 的docker镜像中，同时包含了 OpenJDK 8 和 OpenJDK 11，并且默认使用 OpenJDK 11 编译。请确保编译使用的 JDK 版本和运行时使用的 JDK 版本一致，否则会导致非预期的运行错误。你可以使用在进入编译镜像的容器后，使用以下命令切换默认 JDK 版本：</li></ol><p>切换到 JDK 8：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> alternatives --<span class="built_in">set</span> java java-1.8.0-openjdk.x86_64</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> alternatives --<span class="built_in">set</span> javac java-1.8.0-openjdk.x86_64</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">export</span> JAVA_HOME=/usr/lib/jvm/java-1.8.0</span></span><br></pre></td></tr></table></figure><p>切换到 JDK 11：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> alternatives --<span class="built_in">set</span> java java-11-openjdk.x86_64</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> alternatives --<span class="built_in">set</span> javac java-11-openjdk.x86_64</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">export</span> JAVA_HOME=/usr/lib/jvm/java-11</span></span><br></pre></td></tr></table></figure></blockquote><h4 id="3-1-2-运行镜像"><a href="#3-1-2-运行镜像" class="headerlink" title="3.1.2 运行镜像"></a>3.1.2 运行镜像</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> docker run -it apache/incubator-doris:build-env-1.4.2</span></span><br></pre></td></tr></table></figure><p>建议以挂载本地 Doris 源码目录的方式运行镜像，这样编译的产出二进制文件会存储在宿主机中，不会因为镜像退出而消失。</p><p>同时，建议同时将镜像中 maven 的 <code>.m2</code> 目录挂载到宿主机目录，以防止每次启动镜像编译时，重复下载 maven 的依赖库。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> docker run -it -v /your/<span class="built_in">local</span>/.m2:/root/.m2 -v /your/<span class="built_in">local</span>/incubator-doris-DORIS-x.x.x-release/:/root/incubator-doris-DORIS-x.x.x-release/ apache/incubator-doris:build-env-1.4.2</span></span><br></pre></td></tr></table></figure><h4 id="3-1-3-下载源码"><a href="#3-1-3-下载源码" class="headerlink" title="3.1.3 下载源码"></a>3.1.3 下载源码</h4><p>启动镜像后，你应该已经处于容器内。可以通过以下命令下载 Doris 源码（已挂载本地源码目录则不用）：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> wget https://dist.apache.org/repos/dist/dev/incubator/doris/xxx.tar.gz</span></span><br><span class="line">or</span><br><span class="line"><span class="meta">$</span><span class="bash"> git <span class="built_in">clone</span> https://github.com/apache/incubator-doris.git</span></span><br></pre></td></tr></table></figure><h4 id="3-1-4-编译-Doris"><a href="#3-1-4-编译-Doris" class="headerlink" title="3.1.4 编译 Doris"></a>3.1.4 编译 Doris</h4><p><strong>编译FE，BE</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> sh build.sh</span></span><br></pre></td></tr></table></figure><p><strong>注意:</strong></p><blockquote><p>如果你使用的是 <code>build-env-1.4.1</code> 这个环境，第一次编译的时候要使用如下命令：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> sh build.sh --clean --be --fe --ui</span></span><br></pre></td></tr></table></figure><p>这是因为1.4.1 版本镜像升级了 thrift(0.9 -&gt; 0.13)，需要通过 –clean 命令强制使用新版本的 thrift 生成代码文件，否则会出现不兼容的代码。</p></blockquote><p>编译完成后，产出文件在 <code>output/</code> 目录中。</p><p><strong>编译Broker</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">cd</span> fs_brokers/apache_hdfs_broker/</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> sh build.sh</span></span><br></pre></td></tr></table></figure><p>编译完成后，产出文件在 <code>output/</code> 目录中。</p><h3 id="3-2-群集部署"><a href="#3-2-群集部署" class="headerlink" title="3.2 群集部署"></a>3.2 群集部署</h3><h4 id="3-2-1-官方建议配置"><a href="#3-2-1-官方建议配置" class="headerlink" title="3.2.1 官方建议配置"></a>3.2.1 官方建议配置</h4><p><strong>Linux 操作系统版本需求</strong></p><table><thead><tr><th>Linux 系统</th><th>版本</th></tr></thead><tbody><tr><td>CentOS</td><td>7.1 及以上</td></tr><tr><td>Ubuntu</td><td>16.04 及以上</td></tr></tbody></table><p><strong>软件需求</strong></p><table><thead><tr><th>软件</th><th>版本</th></tr></thead><tbody><tr><td>Java</td><td>1.8 及以上</td></tr><tr><td>GCC</td><td>4.8.2 及以上</td></tr></tbody></table><p><strong>开发测试环境</strong></p><table><thead><tr><th>模块</th><th>CPU</th><th>内存</th><th>磁盘</th><th>网络</th><th>实例数量</th></tr></thead><tbody><tr><td>Frontend</td><td>8核+</td><td>8GB+</td><td>SSD 或 SATA，10GB+ *</td><td>千兆网卡</td><td>1</td></tr><tr><td>Backend</td><td>8核+</td><td>16GB+</td><td>SSD 或 SATA，50GB+ *</td><td>千兆网卡</td><td>1-3 *</td></tr></tbody></table><p><strong>生产环境</strong></p><table><thead><tr><th>模块</th><th>CPU</th><th>内存</th><th>磁盘</th><th>网络</th><th>实例数量（最低要求）</th></tr></thead><tbody><tr><td>Frontend</td><td>16核+</td><td>64GB+</td><td>SSD 或 RAID 卡，100GB+ *</td><td>万兆网卡</td><td>1-5 *</td></tr><tr><td>Backend</td><td>16核+</td><td>64GB+</td><td>SSD 或 SATA，100G+ *</td><td>万兆网卡</td><td>10-100 *</td></tr></tbody></table><p>注1：</p><blockquote><ol><li>FE 的磁盘空间主要用于存储元数据，包括日志和 image。通常从几百 MB 到几个 GB 不等。</li><li>BE 的磁盘空间主要用于存放用户数据，总磁盘空间按用户总数据量 * 3（3副本）计算，然后再预留额外 40% 的空间用作后台 compaction 以及一些中间数据的存放。</li><li>一台机器上可以部署多个 BE 实例，但是<strong>只能部署一个 FE</strong>。如果需要 3 副本数据，那么至少需要 3 台机器各部署一个 BE 实例（而不是1台机器部署3个BE实例）。<strong>多个FE所在服务器的时钟必须保持一致（允许最多5秒的时钟偏差）</strong></li><li>测试环境也可以仅适用一个 BE 进行测试。实际生产环境，BE 实例数量直接决定了整体查询延迟。</li><li>所有部署节点关闭 Swap。</li></ol></blockquote><p>注2：FE 节点的数量</p><blockquote><ol><li>FE 角色分为 Follower 和 Observer，（Leader 为 Follower 组中选举出来的一种角色，以下统称 Follower，具体含义见 <a href="https://doris.apache.org/master/zh-CN/internal/metadata-design" target="_blank" rel="noopener">元数据设计文档</a>）。</li><li>FE 节点数据至少为1（1 个 Follower）。当部署 1 个 Follower 和 1 个 Observer 时，可以实现读高可用。当部署 3 个 Follower 时，可以实现读写高可用（HA）。</li><li>Follower 的数量<strong>必须</strong>为奇数，Observer 数量随意。</li><li>根据以往经验，当集群可用性要求很高时（比如提供在线业务），可以部署 3 个 Follower 和 1-3 个 Observer。如果是离线业务，建议部署 1 个 Follower 和 1-3 个 Observer。</li></ol></blockquote><ul><li><strong>通常我们建议 10 ~ 100 台左右的机器，来充分发挥 Doris 的性能（其中 3 台部署 FE（HA），剩余的部署 BE）</strong></li><li><strong>当然，Doris的性能与节点数量及配置正相关。在最少4台机器（一台 FE，三台 BE，其中一台 BE 混部一个 Observer FE 提供元数据备份），以及较低配置的情况下，依然可以平稳的运行 Doris。</strong></li><li><strong>如果 FE 和 BE 混部，需注意资源竞争问题，并保证元数据目录和数据目录分属不同磁盘。</strong></li></ul><h4 id="3-2-2-网络需求"><a href="#3-2-2-网络需求" class="headerlink" title="3.2.2 网络需求"></a>3.2.2 网络需求</h4><p>Doris 各个实例直接通过网络进行通讯。以下表格展示了所有需要的端口</p><table><thead><tr><th>实例名称</th><th>端口名称</th><th>默认端口</th><th>通讯方向</th><th>说明</th></tr></thead><tbody><tr><td>BE</td><td>be_port</td><td>9060</td><td>FE –&gt; BE</td><td>BE 上 thrift server 的端口，用于接收来自 FE 的请求</td></tr><tr><td>BE</td><td>webserver_port</td><td>8040</td><td>BE &lt;–&gt; BE</td><td>BE 上的 http server 的端口</td></tr><tr><td>BE</td><td>heartbeat_service_port</td><td>9050</td><td>FE –&gt; BE</td><td>BE 上心跳服务端口（thrift），用于接收来自 FE 的心跳</td></tr><tr><td>BE</td><td>brpc_port*</td><td>8060</td><td>FE&lt;–&gt;BE, BE &lt;–&gt; BE</td><td>BE 上的 brpc 端口，用于 BE 之间通讯</td></tr><tr><td>FE</td><td>http_port *</td><td>8030</td><td>FE &lt;–&gt; FE，用户</td><td>FE 上的 http server 端口</td></tr><tr><td>FE</td><td>rpc_port</td><td>9020</td><td>BE –&gt; FE, FE &lt;–&gt; FE</td><td>FE 上的 thrift server 端口，每个fe的配置需要保持一致</td></tr><tr><td>FE</td><td>query_port</td><td>9030</td><td>用户</td><td>FE 上的 mysql server 端口</td></tr><tr><td>FE</td><td>edit_log_port</td><td>9010</td><td>FE &lt;–&gt; FE</td><td>FE 上的 bdbje 之间通信用的端口</td></tr><tr><td>Broker</td><td>broker_ipc_port</td><td>8000</td><td>FE –&gt; Broker, BE –&gt; Broker</td><td>Broker 上的 thrift server，用于接收请求</td></tr></tbody></table><blockquote><p>注：</p><ol><li>当部署多个 FE 实例时，要保证 FE 的 http_port 配置相同。</li><li>部署前请确保各个端口在应有方向上的访问权限。</li></ol></blockquote><h4 id="3-2-3-服务规划"><a href="#3-2-3-服务规划" class="headerlink" title="3.2.3 服务规划"></a>3.2.3 服务规划</h4><p><strong>服务规划</strong></p><table><thead><tr><th>主机名</th><th>doris角色</th><th>依赖服务</th></tr></thead><tbody><tr><td>hadoop1</td><td>FE（Frontend）、BE（Backend）</td><td>JDK1.8、GCC4.8.2 及以上</td></tr><tr><td>hadoop2</td><td>BE（Backend）</td><td>JDK1.8、GCC4.8.2 及以上</td></tr><tr><td>hadoop3</td><td>BE（Backend）</td><td>JDK1.8、GCC4.8.2 及以上</td></tr></tbody></table><p>前置条件</p><blockquote><p>JDK和GCC是可用的</p></blockquote><h4 id="3-2-4-IP-绑定"><a href="#3-2-4-IP-绑定" class="headerlink" title="3.2.4 IP 绑定"></a>3.2.4 IP 绑定</h4><p>因为有多网卡的存在，或因为安装过 docker 等环境导致的虚拟网卡的存在，同一个主机可能存在多个不同的 ip。当前 Doris 并不能自动识别可用 IP。所以当遇到部署主机上有多个 IP 时，必须通过 priority_networks 配置项来强制指定正确的 IP。</p><p>priority_networks 是 FE 和 BE 都有的一个配置，配置项需写在 fe.conf 和 be.conf 中。该配置项用于在 FE 或 BE 启动时，告诉进程应该绑定哪个IP。示例如下：</p><figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">priority_networks=10.1.3.0/24</span><br></pre></td></tr></table></figure><p>这是一种 <a href="https://en.wikipedia.org/wiki/Classless_Inter-Domain_Routing" target="_blank" rel="noopener">CIDR (opens new window)</a>的表示方法。FE 或 BE 会根据这个配置项来寻找匹配的IP，作为自己的 localIP。</p><p><strong>注意</strong>：当配置完 priority_networks 并启动 FE 或 BE 后，只是保证了 FE 或 BE 自身的 IP 进行了正确的绑定。而在使用 ADD BACKEND 或 ADD FRONTEND 语句中，也需要指定和 priority_networks 配置匹配的 IP，否则集群无法建立。举例：</p><p>BE 的配置为：<code>priority_networks=10.1.3.0/24</code></p><p>但是在 ADD BACKEND 时使用的是：<code>ALTER SYSTEM ADD BACKEND &quot;192.168.0.1:9050&quot;;</code></p><p>则 FE 和 BE 将无法正常通信。</p><p>这时，必须 DROP 掉这个添加错误的 BE，重新使用正确的 IP 执行 ADD BACKEND。</p><p>FE 同理。</p><p>BROKER 当前没有，也不需要 priority_networks 这个选项。Broker 的服务默认绑定在 0.0.0.0 上。只需在 ADD BROKER 时，执行正确可访问的 BROKER IP 即可。</p><h4 id="3-2-5-FE-部署"><a href="#3-2-5-FE-部署" class="headerlink" title="3.2.5 FE 部署"></a>3.2.5 FE 部署</h4><p><strong>拷贝 FE 部署文件到指定节点</strong></p><p>将源码编译生成的 output 下的 fe 文件夹拷贝到 FE 的节点指定部署路径下并进入该目录。</p><p><strong>配置 FE</strong></p><p>配置文件为 <code>conf/fe.conf</code>。其中注意：<code>meta_dir</code>是元数据存放位置。默认值为 <code>${DORIS_HOME}/doris-meta</code>。需<strong>手动创建</strong>该目录。</p><blockquote><p><strong>注意：生产环境强烈建议单独指定目录不要放在Doris安装目录下，最好是单独的磁盘（如果有SSD最好），测试开发环境可以使用默认配置</strong></p></blockquote><p>fe.conf 中 JAVA_OPTS 默认 java 最大堆内存为 4GB，<strong>建议生产环境调整至 8G 以上</strong>。</p><p><strong>启动FE</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[hadoop@hadoop1 ~/doris]$ sh fe/bin/start_fe.sh --daemon</span><br></pre></td></tr></table></figure><p>FE进程启动进入后台执行。日志默认存放在 log/ 目录下。如启动失败，可以通过查看 log/fe.log 或者 log/fe.out 查看错误信息。</p><p><strong>查看 FE 进程</strong></p><p>如果成功的话，可以通过jps查看到进程</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[hadoop@hadoop1 ~/doris]$ jps |grep PaloFe</span><br><span class="line">27404 PaloFe</span><br></pre></td></tr></table></figure><blockquote><p>如需部署多 FE，请参见后面的 <strong>FE 扩容和缩容</strong> 部分</p></blockquote><h4 id="3-2-6-BE-部署"><a href="#3-2-6-BE-部署" class="headerlink" title="3.2.6 BE 部署"></a>3.2.6 BE 部署</h4><p><strong>拷贝 BE 部署文件到所有要部署 BE 的节点</strong></p><p>将源码编译生成的 output 下的 be 文件夹拷贝到 BE 的节点的指定部署路径下。</p><p><strong>修改所有 BE 的配置</strong></p><p>修改 <code>be/conf/be.conf</code>。主要是配置 <code>storage_root_path</code>：数据存放目录。默认在be/storage下，需要<strong>手动创建</strong>该目录。多个路径之间使用英文状态的分号 <code>;</code> 分隔（<strong>最后一个目录后不要加 <code>;</code></strong>）。可以通过路径区别存储目录的介质，HDD或SSD。可以添加容量限制在每个路径的末尾，通过英文状态逗号<code>,</code>隔开。</p><p>示例1如下：</p><blockquote><p><strong>注意：如果是SSD磁盘要在目录后面加上<code>.SSD</code>,HDD磁盘在目录后面加<code>.HDD</code></strong><br><code>storage_root_path=/home/disk1/doris.HDD,50;/home/disk2/doris.SSD,10;/home/disk2/doris</code></p></blockquote><p><strong>说明</strong></p><blockquote><p>/home/disk1/doris.HDD, 50，表示存储限制为50GB, HDD;<br>/home/disk2/doris.SSD 10， 存储限制为10GB，SSD；<br>/home/disk2/doris，存储限制为磁盘最大容量，默认为HDD。</p></blockquote><p>示例2如下：</p><blockquote><p><strong>注意：不论HHD磁盘目录还是SSD磁盘目录，都无需添加后缀，storage_root_path参数里指定medium即可</strong><br><code>storage_root_path=/home/disk1/doris,medium:hdd,capacity:50;/home/disk2/doris,medium:ssd,capacity:50</code></p></blockquote><p><strong>说明</strong></p><blockquote><p>/home/disk1/doris,medium:hdd,capacity:10，表示存储限制为10GB, HHD;<br>/home/disk2/doris,medium:ssd,capacity:50，表示存储限制为50GB, SSD;</p></blockquote><p><strong>BE webserver_port端口配置</strong></p><p>如果 be 部署在 hadoop 集群中，注意调整 be.conf 中的 <code>webserver_port = 8040</code> ,以免造成端口冲突</p><p><strong>在 FE 中添加所有 BE 节点</strong></p><p>BE 节点需要先在 FE 中添加，才可加入集群。可以使用 mysql-client(<a href="https://dev.mysql.com/downloads/mysql/5.7.html" target="_blank" rel="noopener">下载MySQL 5.7 (opens new window)</a>) 连接到 FE：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./mysql-client -h host -P port -uroot</span><br></pre></td></tr></table></figure><p>其中 host 为 FE 所在节点 ip；port 为 fe/conf/fe.conf 中的 query_port；默认使用 root 账户，无密码登录。</p><p>登录后，执行以下命令来添加每一个 BE：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">SYSTEM</span> <span class="keyword">ADD</span> BACKEND <span class="string">"host:port"</span>;</span><br></pre></td></tr></table></figure><blockquote><p>其中 host 为 BE 所在节点 ip；port 为 be/conf/be.conf 中的 heartbeat_service_port。</p></blockquote><p><strong>启动 BE</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[hadoop@hadoop1 ~/doris]$ sh be/bin/start_be.sh --daemon</span><br></pre></td></tr></table></figure><p>BE 进程将启动并进入后台执行。日志默认存放在 be/log/ 目录下。如启动失败，可以通过查看 be/log/be.log 或者 be/log/be.out 查看错误信息。</p><p><strong>查看BE状态</strong></p><p>使用 mysql-client 连接到 FE，并执行 <code>SHOW PROC &#39;/backends&#39;;</code> 查看 BE 运行情况。如一切正常，<code>Alive</code> 列应为 <code>true</code>。</p><p><img src="/2021/12/07/apache-doris-lian-ji-fen-xi-chu-li-olap/%E5%9B%BE%E7%89%875.png" alt="图片5"></p><p><strong>访问 FE UI 查询页面</strong> <code>fe.conf</code> 配置的 <code>http_port</code>端口</p><p><img src="/2021/12/07/apache-doris-lian-ji-fen-xi-chu-li-olap/%E5%9B%BE%E7%89%876.png" alt="图片6"></p><h4 id="3-2-7-FS-Broker-部署（可选）"><a href="#3-2-7-FS-Broker-部署（可选）" class="headerlink" title="3.2.7 FS_Broker 部署（可选）"></a>3.2.7 FS_Broker 部署（可选）</h4><p>Broker 以插件的形式，独立于 Doris 部署。如果需要从第三方存储系统导入数据，需要部署相应的 Broker，默认提供了读取 HDFS 和百度云 BOS 的 fs_broker。fs_broker 是无状态的，建议每一个 FE 和 BE 节点都部署一个 Broker。</p><blockquote><ul><li><p>拷贝源码 fs_broker 的 output 目录下的相应 Broker 目录到需要部署的所有节点上。建议和 BE 或者 FE 目录保持同级。</p></li><li><p>修改相应 Broker 配置<br>在相应 broker/conf/ 目录下对应的配置文件中，可以修改相应配置。</p></li><li><p>启动 Broker<br><code>sh bin/start_broker.sh --daemon</code> 启动 Broker。</p></li><li><p>添加 Broker<br>要让 Doris 的 FE 和 BE 知道 Broker 在哪些节点上，通过 sql 命令添加 Broker 节点列表。<br>使用 mysql-client 连接启动的 FE，执行以下命令：<br><code>ALTER SYSTEM ADD BROKER broker_name &quot;host1:port1&quot;,&quot;host2:port2&quot;,...;</code><br>其中 host 为 Broker 所在节点 ip；port 为 Broker 配置文件中的 broker_ipc_port。</p></li><li><p>查看 Broker 状态<br>使用 mysql-client 连接任一已启动的 FE，执行以下命令查看 Broker 状态：<code>SHOW PROC &quot;/brokers&quot;;</code></p></li></ul></blockquote><p><strong>注：在生产环境中，所有实例都应使用守护进程启动，以保证进程退出后，会被自动拉起，如 <a href="http://supervisord.org/" target="_blank" rel="noopener">Supervisor</a>。如需使用守护进程启动，在 0.9.0 及之前版本中，需要修改各个 start_xx.sh 脚本，去掉最后的 &amp; 符号</strong>。从 0.10.0 版本开始，直接调用 <code>sh start_xx.sh</code> 启动即可。也可参考 <a href="https://www.cnblogs.com/lenmom/p/9973401.html" target="_blank" rel="noopener">这里</a></p><h2 id="四、扩容缩容"><a href="#四、扩容缩容" class="headerlink" title="四、扩容缩容"></a>四、扩容缩容</h2><p>Doris 可以很方便的扩容和缩容 FE、BE、Broker 实例。</p><h3 id="4-1-FE-扩容和缩容"><a href="#4-1-FE-扩容和缩容" class="headerlink" title="4.1 FE 扩容和缩容"></a>4.1 FE 扩容和缩容</h3><p>可以通过将 FE 扩容至 3 个以上节点来实现 FE 的高可用。</p><p>用户可以通过 mysql 客户端登陆 Master FE。通过:</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SHOW</span> PROC <span class="string">'/frontends'</span>;</span><br></pre></td></tr></table></figure><p>来查看当前 FE 的节点情况。</p><p>也可以通过前端页面连接：<code>http://fe_hostname:fe_http_port/frontend</code> 或者 <code>http://fe_hostname:fe_http_port/system?path=//frontends</code> 来查看 FE 节点的情况。</p><p>以上方式，都需要 Doris 的 root 用户权限。</p><p>FE 节点的扩容和缩容过程，不影响当前系统运行。</p><h4 id="4-1-1-增加-FE-节点"><a href="#4-1-1-增加-FE-节点" class="headerlink" title="4.1.1 增加 FE 节点"></a>4.1.1 增加 FE 节点</h4><p>FE 分为 Leader，Follower 和 Observer 三种角色。 默认一个集群，只能有一个 Leader，可以有多个 Follower 和 Observer。其中 Leader 和 Follower 组成一个 Paxos 选择组，如果 Leader 宕机，则剩下的 Follower 会自动选出新的 Leader，保证写入高可用。Observer 同步 Leader 的数据，但是不参加选举。如果只部署一个 FE，则 FE 默认就是 Leader。</p><p>第一个启动的 FE 自动成为 Leader。在此基础上，可以添加若干 Follower 和 Observer。</p><p>添加 Follower 或 Observer。使用 mysql-client 连接到已启动的 FE，并执行：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">SYSTEM</span> <span class="keyword">ADD</span> FOLLOWER <span class="string">"host:port"</span>;</span><br></pre></td></tr></table></figure><p>或</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">SYSTEM</span> <span class="keyword">ADD</span> OBSERVER <span class="string">"host:port"</span>;</span><br></pre></td></tr></table></figure><p>其中 host 为 Follower 或 Observer 所在节点 ip，port 为其配置文件 fe.conf 中的 edit_log_port。</p><p>配置及启动 Follower 或 Observer。Follower 和 Observer 的配置同 Leader 的配置。第一次启动时，需执行以下命令：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./bin/start_fe.sh --helper host:port --daemon</span><br></pre></td></tr></table></figure><p>其中 host 为 Leader 所在节点 ip, port 为 Leader 的配置文件 fe.conf 中的 edit_log_port。--helper 参数仅在 follower 和 observer 第一次启动时才需要。</p><p>查看 Follower 或 Observer 运行状态。使用 mysql-client 连接到任一已启动的 FE，并执行：<code>SHOW PROC &#39;/frontends&#39;;</code> 可以查看当前已加入集群的 FE 及其对应角色。</p><p><strong>FE 扩容注意事项：</strong></p><blockquote><ol><li>Follower FE（包括 Leader）的数量必须为奇数，建议最多部署 3 个组成高可用（HA）模式即可。</li><li>当 FE 处于高可用部署时（1个 Leader，2个 Follower），我们建议通过增加 Observer FE 来扩展 FE 的读服务能力。当然也可以继续增加 Follower FE，但几乎是不必要的。</li><li>通常一个 FE 节点可以应对 10-20 台 BE 节点。建议总的 FE 节点数量在 10 个以下。而通常 3 个即可满足绝大部分需求。</li><li>helper 不能指向 FE 自身，必须指向一个或多个已存在并且正常运行中的 Master/Follower FE。</li></ol></blockquote><h4 id="4-1-2-删除-FE-节点"><a href="#4-1-2-删除-FE-节点" class="headerlink" title="4.1.2 删除 FE 节点"></a>4.1.2 删除 FE 节点</h4><p>使用以下命令删除对应的 FE 节点：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">SYSTEM</span> <span class="keyword">DROP</span> FOLLOWER[OBSERVER] <span class="string">"fe_host:edit_log_port"</span>;</span><br></pre></td></tr></table></figure><p><strong>FE 缩容注意事项：</strong></p><blockquote><ol><li>删除 Follower FE 时，确保最终剩余的 Follower（包括 Leader）节点为奇数。</li></ol></blockquote><h3 id="4-2-BE-扩容和缩容"><a href="#4-2-BE-扩容和缩容" class="headerlink" title="4.2 BE 扩容和缩容"></a>4.2 BE 扩容和缩容</h3><p>用户可以通过 mysql-client 登陆 Leader FE。通过:</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SHOW</span> PROC <span class="string">'/backends'</span>;</span><br></pre></td></tr></table></figure><p>来查看当前 BE 的节点情况。</p><p>也可以通过前端页面连接：<code>http://fe_hostname:fe_http_port/backend</code> 或者 <code>http://fe_hostname:fe_http_port/system?path=//backends</code> 来查看 BE 节点的情况。</p><p>以上方式，都需要 Doris 的 root 用户权限。</p><p>BE 节点的扩容和缩容过程，不影响当前系统运行以及正在执行的任务，并且不会影响当前系统的性能。数据均衡会自动进行。根据集群现有数据量的大小，集群会在几个小时到1天不等的时间内，恢复到负载均衡的状态。集群负载情况，可以参见 <a href="https://doris.apache.org/master/zh-CN/administrator-guide/operation/tablet-repair-and-balance.html" target="_blank" rel="noopener">Tablet 负载均衡文档</a>。</p><h4 id="4-2-1-增加-BE-节点"><a href="#4-2-1-增加-BE-节点" class="headerlink" title="4.2.1 增加 BE 节点"></a>4.2.1 增加 BE 节点</h4><p>BE 节点的增加方式同 <strong>BE 部署</strong> 一节中的方式，通过 <code>ALTER SYSTEM ADD BACKEND &quot;host:port&quot;;</code> 命令增加 BE 后 <code>sh be/bin/start_be.sh --daemon</code> 启动节点。</p><p><strong>BE 扩容注意事项：</strong></p><blockquote><ol><li>BE 扩容后，Doris 会自动根据负载情况，进行数据均衡，期间不影响使用。</li></ol></blockquote><h4 id="4-2-2-删除-BE-节点"><a href="#4-2-2-删除-BE-节点" class="headerlink" title="4.2.2 删除 BE 节点"></a>4.2.2 删除 BE 节点</h4><p>删除 BE 节点有两种方式：DROP 和 DECOMMISSION</p><p><strong>DROP 语句如下：</strong></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">SYSTEM</span> <span class="keyword">DROP</span> BACKEND <span class="string">"be_host:be_heartbeat_service_port"</span>;</span><br></pre></td></tr></table></figure><p><strong>注意：DROP BACKEND 会直接删除该 BE，并且其上的数据将不能再恢复！！！所以我们强烈不推荐使用 DROP BACKEND 这种方式删除 BE 节点。当你使用这个语句时，会有对应的防误操作提示。</strong></p><p><strong>DECOMMISSION 语句如下：</strong></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">SYSTEM</span> DECOMMISSION BACKEND <span class="string">"be_host:be_heartbeat_service_port"</span>;</span><br></pre></td></tr></table></figure><p>DECOMMISSION 命令说明：</p><blockquote><ol><li>该命令用于安全删除 BE 节点。命令下发后，Doris 会尝试将该 BE 上的数据向其他 BE 节点迁移，当所有数据都迁移完成后，Doris 会自动删除该节点。</li><li>该命令是一个异步操作。执行后，可以通过 <code>SHOW PROC &#39;/backends&#39;;</code> 看到该 BE 节点的 isDecommission 状态为 true。表示该节点正在进行下线。</li><li>该命令<strong>不一定执行成功</strong>。比如剩余 BE 存储空间不足以容纳下线 BE 上的数据，或者剩余机器数量不满足最小副本数时，该命令都无法完成，并且 BE 会一直处于 isDecommission 为 true 的状态。</li><li>DECOMMISSION 的进度，可以通过 <code>SHOW PROC &#39;/backends&#39;;</code> 中的 TabletNum 查看，如果正在进行，TabletNum 将不断减少。</li><li>该操作可以通过:<br><code>CANCEL DECOMMISSION BACKEND &quot;be_host:be_heartbeat_service_port&quot;;</code><br>命令取消。取消后，该 BE 上的数据将维持当前剩余的数据量。后续 Doris 重新进行负载均衡</li></ol></blockquote><p><strong>对于多租户部署环境下，BE 节点的扩容和缩容，请参阅 <a href="https://doris.apache.org/master/zh-CN/administrator-guide/operation/multi-tenant.html" target="_blank" rel="noopener">多租户设计文档</a>。</strong></p><h3 id="4-3-Broker-扩容缩容"><a href="#4-3-Broker-扩容缩容" class="headerlink" title="4.3 Broker 扩容缩容"></a>4.3 Broker 扩容缩容</h3><p>Broker 实例的数量没有硬性要求。通常每台物理机部署一个即可。Broker 的添加和删除可以通过以下命令完成：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">SYSTEM</span> <span class="keyword">ADD</span> BROKER broker_name <span class="string">"broker_host:broker_ipc_port"</span>;</span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">SYSTEM</span> <span class="keyword">DROP</span> BROKER broker_name <span class="string">"broker_host:broker_ipc_port"</span>;</span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">SYSTEM</span> <span class="keyword">DROP</span> <span class="keyword">ALL</span> BROKER broker_name;</span><br></pre></td></tr></table></figure><p>Broker 是无状态的进程，可以随意启停。当然，停止后，正在其上运行的作业会失败，重试即可。</p><h2 id="五、最佳实践"><a href="#五、最佳实践" class="headerlink" title="五、最佳实践"></a>五、最佳实践</h2><h3 id="5-1-建表"><a href="#5-1-建表" class="headerlink" title="5.1 建表"></a>5.1 建表</h3><h4 id="5-1-1-数据模型选择"><a href="#5-1-1-数据模型选择" class="headerlink" title="5.1.1 数据模型选择"></a>5.1.1 数据模型选择</h4><p>Doris 数据模型上目前分为三类: AGGREGATE KEY, UNIQUE KEY, DUPLICATE KEY。三种模型中数据都是按KEY进行排序。</p><p><strong>5.1.1.1 AGGREGATE KEY</strong></p><p>AGGREGATE KEY相同时，新旧记录进行聚合，目前支持的聚合函数有SUM, MIN, MAX, REPLACE。<br>AGGREGATE KEY模型可以提前聚合数据, 适合报表和多维分析业务。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> site_visit</span><br><span class="line">(</span><br><span class="line">    siteid      <span class="built_in">INT</span>,</span><br><span class="line">    city        <span class="built_in">SMALLINT</span>,</span><br><span class="line">    username    <span class="built_in">VARCHAR</span>(<span class="number">32</span>),</span><br><span class="line">    pv <span class="built_in">BIGINT</span>   <span class="keyword">SUM</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span></span><br><span class="line">)</span><br><span class="line"><span class="keyword">AGGREGATE</span> <span class="keyword">KEY</span>(siteid, city, username)</span><br><span class="line"><span class="keyword">DISTRIBUTED</span> <span class="keyword">BY</span> <span class="keyword">HASH</span>(siteid) BUCKETS <span class="number">10</span>;</span><br></pre></td></tr></table></figure><p><strong>5.1.1.2 UNIQUE KEY</strong></p><p>UNIQUE KEY 相同时，新记录覆盖旧记录。目前 UNIQUE KEY 实现上和 AGGREGATE KEY 的 REPLACE 聚合方法一样，二者本质上相同。适用于有更新需求的分析业务。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> sales_order</span><br><span class="line">(</span><br><span class="line">    orderid     <span class="built_in">BIGINT</span>,</span><br><span class="line">    <span class="keyword">status</span>      <span class="built_in">TINYINT</span>,</span><br><span class="line">    username    <span class="built_in">VARCHAR</span>(<span class="number">32</span>),</span><br><span class="line">    amount      <span class="built_in">BIGINT</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span></span><br><span class="line">)</span><br><span class="line"><span class="keyword">UNIQUE</span> <span class="keyword">KEY</span>(orderid)</span><br><span class="line"><span class="keyword">DISTRIBUTED</span> <span class="keyword">BY</span> <span class="keyword">HASH</span>(orderid) BUCKETS <span class="number">10</span>;</span><br></pre></td></tr></table></figure><p><strong>5.1.1.3 DUPLICATE KEY</strong></p><p>只指定排序列，相同的行不会合并。适用于数据无需提前聚合的分析业务。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> session_data</span><br><span class="line">(</span><br><span class="line">    visitorid   <span class="built_in">SMALLINT</span>,</span><br><span class="line">    sessionid   <span class="built_in">BIGINT</span>,</span><br><span class="line">    visittime   DATETIME,</span><br><span class="line">    city        <span class="built_in">CHAR</span>(<span class="number">20</span>),</span><br><span class="line">    province    <span class="built_in">CHAR</span>(<span class="number">20</span>),</span><br><span class="line">    ip          <span class="built_in">varchar</span>(<span class="number">32</span>),</span><br><span class="line">    brower      <span class="built_in">CHAR</span>(<span class="number">20</span>),</span><br><span class="line">    <span class="keyword">url</span>         <span class="built_in">VARCHAR</span>(<span class="number">1024</span>)</span><br><span class="line">)</span><br><span class="line"><span class="keyword">DUPLICATE</span> <span class="keyword">KEY</span>(visitorid, sessionid)</span><br><span class="line"><span class="keyword">DISTRIBUTED</span> <span class="keyword">BY</span> <span class="keyword">HASH</span>(sessionid, visitorid) BUCKETS <span class="number">10</span>;</span><br></pre></td></tr></table></figure><h4 id="5-1-2-大宽表与-Star-Schema"><a href="#5-1-2-大宽表与-Star-Schema" class="headerlink" title="5.1.2 大宽表与 Star Schema"></a>5.1.2 大宽表与 Star Schema</h4><p>业务方建表时, 为了和前端业务适配, 往往不对维度信息和指标信息加以区分, 而将 Schema 定义成大宽表。对于 Doris 而言, 这类大宽表往往性能不尽如人意:</p><ul><li>Schema 中字段数比较多, 聚合模型中可能 key 列比较多, 导入过程中需要排序的列会增加。</li><li>维度信息更新会反应到整张表中，而更新的频率直接影响查询的效率。</li></ul><p>使用过程中，建议用户尽量使用 Star Schema 区分维度表和指标表。频繁更新的维度表也可以放在 MySQL 外部表中。而如果只有少量更新, 可以直接放在 Doris 中。在 Doris 中存储维度表时，可对维度表设置更多的副本，提升 Join 的性能。</p><h4 id="5-1-3-分区和分桶"><a href="#5-1-3-分区和分桶" class="headerlink" title="5.1.3 分区和分桶"></a>5.1.3 分区和分桶</h4><p>Doris 支持两级分区存储, 第一层为分区(partition)，目前支持 RANGE 分区和 LIST 分区两种类型, 第二层为 HASH 分桶(bucket)。</p><p><strong>5.1.3.1 分区(partition)</strong></p><p>分区用于将数据划分成不同区间, 逻辑上可以理解为将原始表划分成了多个子表。可以方便的按分区对数据进行管理，例如，删除数据时，更加迅速。</p><p>5.1.3.1.1 RANGE分区</p><p>业务上，多数用户会选择采用按时间进行partition, 让时间进行partition有以下好处：</p><ul><li>可区分冷热数据；</li><li>可用上Doris分级存储(SSD + SATA)的功能。</li></ul><p>5.1.3.1.2 LIST分区</p><p>业务上，用户可以选择城市或者其他枚举值进行partition。</p><p><strong>5.1.3.2 HASH分桶(bucket)</strong></p><p>根据hash值将数据划分成不同的 bucket。</p><ul><li>建议采用区分度大的列做分桶, 避免出现数据倾斜；</li><li>为方便数据恢复, 建议单个 bucket 的 size 不要太大, 保持在 10GB 以内, 所以建表或增加 partition 时请合理考虑 bucket 数目, 其中不同 partition 可指定不同的 buckets 数。</li></ul><h4 id="5-1-4-稀疏索引和-Bloom-Filter"><a href="#5-1-4-稀疏索引和-Bloom-Filter" class="headerlink" title="5.1.4 稀疏索引和 Bloom Filter"></a>5.1.4 稀疏索引和 Bloom Filter</h4><p>Doris对数据进行有序存储, 在数据有序的基础上为其建立稀疏索引,索引粒度为 block(1024行)。</p><p>稀疏索引选取 schema 中固定长度的前缀作为索引内容, 目前 Doris 选取 36 个字节的前缀作为索引。</p><ul><li>建表时建议将查询中常见的过滤字段放在 Schema 的前面, 区分度越大，频次越高的查询字段越往前放。</li><li>这其中有一个特殊的地方,就是 varchar 类型的字段。varchar 类型字段只能作为稀疏索引的最后一个字段。索引会在 varchar 处截断, 因此 varchar 如果出现在前面，可能索引的长度可能不足 36 个字节。具体可以参阅 <a href="https://doris.apache.org/master/zh-CN/getting-started/data-model-rollup.html" target="_blank" rel="noopener">数据模型、ROLLUP 及前缀索引</a>。</li><li>除稀疏索引之外, Doris还提供bloomfilter索引, bloomfilter索引对区分度比较大的列过滤效果明显。 如果考虑到varchar不能放在稀疏索引中, 可以建立bloomfilter索引。</li></ul><h4 id="5-1-5-物化视图-rollup"><a href="#5-1-5-物化视图-rollup" class="headerlink" title="5.1.5 物化视图(rollup)"></a>5.1.5 物化视图(rollup)</h4><p>Rollup 本质上可以理解为原始表(Base Table)的一个物化索引。建立 Rollup 时可只选取 Base Table 中的部分列作为 Schema。Schema 中的字段顺序也可与 Base Table 不同。</p><p>下列情形可以考虑建立 Rollup：</p><p><strong>5.1.5.1 Base Table 中数据聚合度不高</strong></p><p>这一般是因 Base Table 有区分度比较大的字段而导致。此时可以考虑选取部分列，建立 Rollup。</p><p>如对于 <code>site_visit</code> 表：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">site_visit(siteid, city, username, pv)</span><br></pre></td></tr></table></figure><p>siteid 可能导致数据聚合度不高，如果业务方经常根据城市统计pv需求，可以建立一个只有 city, pv 的 Rollup：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> site_visit <span class="keyword">ADD</span> <span class="keyword">ROLLUP</span> rollup_city(city, pv);</span><br></pre></td></tr></table></figure><p><strong>5.1.5.2 Base Table 中的前缀索引无法命中</strong></p><p>这一般是 Base Table 的建表方式无法覆盖所有的查询模式。此时可以考虑调整列顺序，建立 Rollup。</p><p>如对于 session_data 表：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">session_data(visitorid, sessionid, visittime, city, province, ip, brower, url)</span><br></pre></td></tr></table></figure><p>如果除了通过 visitorid 分析访问情况外，还有通过 brower, province 分析的情形，可以单独建立 Rollup。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> session_data <span class="keyword">ADD</span> <span class="keyword">ROLLUP</span> rollup_brower(brower,province,ip,<span class="keyword">url</span>) <span class="keyword">DUPLICATE</span> <span class="keyword">KEY</span>(brower,province);</span><br></pre></td></tr></table></figure><h3 id="5-2-Schema-Change"><a href="#5-2-Schema-Change" class="headerlink" title="5.2 Schema Change"></a>5.2 Schema Change</h3><p>Doris中目前进行 Schema Change 的方式有三种：Sorted Schema Change，Direct Schema Change, Linked Schema Change。</p><p>2.1. Sorted Schema Change</p><p>改变了列的排序方式，需对数据进行重新排序。例如删除排序列中的一列, 字段重排序。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> site_visit <span class="keyword">DROP</span> <span class="keyword">COLUMN</span> city;</span><br></pre></td></tr></table></figure><p>2.2. Direct Schema Change: 无需重新排序，但是需要对数据做一次转换。例如修改列的类型，在稀疏索引中加一列等。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> site_visit <span class="keyword">MODIFY</span> <span class="keyword">COLUMN</span> username <span class="built_in">varchar</span>(<span class="number">64</span>);</span><br></pre></td></tr></table></figure><p>2.3. Linked Schema Change: 无需转换数据，直接完成。例如加列操作。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> site_visit <span class="keyword">ADD</span> <span class="keyword">COLUMN</span> click <span class="built_in">bigint</span> <span class="keyword">SUM</span> <span class="keyword">default</span> <span class="string">'0'</span>;</span><br></pre></td></tr></table></figure><p>建表时建议考虑好 Schema，这样在进行 Schema Change 时可以加快速度。</p><h2 id="六、权限管理"><a href="#六、权限管理" class="headerlink" title="六、权限管理"></a>六、权限管理</h2><p>Doris 新的权限管理系统参照了 Mysql 的权限管理机制，做到了表级别细粒度的权限控制，基于角色的权限访问控制，并且支持白名单机制。</p><h3 id="6-1-名词解释"><a href="#6-1-名词解释" class="headerlink" title="6.1 名词解释"></a>6.1 名词解释</h3><ol><li><p>用户标识 user_identity</p><p>在权限系统中，一个用户被识别为一个 User Identity（用户标识）。用户标识由两部分组成：username 和 userhost。其中 username 为用户名，由英文大小写组成。userhost 表示该用户链接来自的 IP。user_identity 以 username@&#39;userhost&#39; 的方式呈现，表示来自 userhost 的 username。<br>user_identity 的另一种表现方式为 username@[&#39;domain&#39;]，其中 domain 为域名，可以通过 DNS 或 BNS（百度名字服务）解析为一组 ip。最终表现为一组 username@&#39;userhost&#39;，所以后面我们统一使用 username@&#39;userhost&#39; 来表示。</p></li><li><p>权限 Privilege</p><p>权限作用的对象是节点、数据库或表。不同的权限代表不同的操作许可。</p></li><li><p>角色 Role</p><p>Doris可以创建自定义命名的角色。角色可以被看做是一组权限的集合。新创建的用户可以被赋予某一角色，则自动被赋予该角色所拥有的权限。后续对角色的权限变更，也会体现在所有属于该角色的用户权限上。</p></li><li><p>用户属性 user_property</p><p>用户属性直接附属于某一用户，而不是用户标识。即 cmy@&#39;192.%&#39; 和 cmy@[&#39;domain&#39;] 都拥有同一组用户属性，该属性属于用户 cmy，而不是 cmy@&#39;192.%&#39; 或 cmy@[&#39;domain&#39;]。</p><p>用户属性包括但不限于： 用户最大连接数、导入集群配置等等。</p></li></ol><h3 id="6-2-支持的操作"><a href="#6-2-支持的操作" class="headerlink" title="6.2 支持的操作"></a>6.2 支持的操作</h3><ol><li>创建用户：CREATE USER</li><li>删除用户：DROP USER</li><li>授权：GRANT</li><li>撤权：REVOKE</li><li>创建角色：CREATE ROLE</li><li>删除角色：DROP ROLE</li><li>查看当前用户权限：SHOW GRANTS</li><li>查看所有用户权限：SHOW ALL GRANTS</li><li>查看已创建的角色：SHOW ROLES</li><li>查看用户属性：SHOW PROPERTY</li></ol><p>关于以上命令的详细帮助，可以通过 mysql 客户端连接 Doris 后，使用 help + command 获取帮助。如 <code>HELP CREATE USER</code>。</p><h3 id="6-3-权限类型"><a href="#6-3-权限类型" class="headerlink" title="6.3 权限类型"></a>6.3 权限类型</h3><p>Doris 目前支持以下几种权限</p><ol><li><p>Node_priv</p><p>节点变更权限。包括 FE、BE、BROKER 节点的添加、删除、下线等操作。目前该权限只能授予 Root 用户。</p></li><li><p>Grant_priv</p><p>权限变更权限。允许执行包括授权、撤权、添加/删除/变更 用户/角色 等操作。</p></li><li><p>Select_priv</p><p>对数据库、表的只读权限。</p></li><li><p>Load_priv</p><p>对数据库、表的写权限。包括 Load、Insert、Delete 等。</p></li><li><p>Alter_priv</p><p>对数据库、表的更改权限。包括重命名 库/表、添加/删除/变更 列、添加/删除 分区等操作。</p></li><li><p>Create_priv</p><p>创建数据库、表、视图的权限。</p></li><li><p>Drop_priv</p><p>删除数据库、表、视图的权限。</p></li><li><p>Usage_priv</p><p>资源的使用权限。</p></li></ol><h3 id="6-4-权限层级"><a href="#6-4-权限层级" class="headerlink" title="6.4 权限层级"></a>6.4 权限层级</h3><p>同时，根据权限适用范围的不同，我们将库表的权限分为以下三个层级：</p><ol><li>GLOBAL LEVEL：全局权限。即通过 GRANT 语句授予的 <code>*.*</code> 上的权限。被授予的权限适用于任意数据库中的任意表。</li><li>DATABASE LEVEL：数据库级权限。即通过 GRANT 语句授予的 <code>db.*</code> 上的权限。被授予的权限适用于指定数据库中的任意表。</li><li>TABLE LEVEL：表级权限。即通过 GRANT 语句授予的 <code>db.tbl</code> 上的权限。被授予的权限适用于指定数据库中的指定表。</li></ol><p>将资源的权限分为以下两个层级：</p><ol><li>GLOBAL LEVEL：全局权限。即通过 GRANT 语句授予的 <code>*</code> 上的权限。被授予的权限适用于资源。</li><li>RESOURCE LEVEL: 资源级权限。即通过 GRANT 语句授予的 <code>resource_name</code> 上的权限。被授予的权限适用于指定资源。</li></ol><h3 id="6-5-ADMIN-GRANT-权限说明"><a href="#6-5-ADMIN-GRANT-权限说明" class="headerlink" title="6.5 ADMIN/GRANT 权限说明"></a>6.5 ADMIN/GRANT 权限说明</h3><p>ADMIN_PRIV 和 GRANT_PRIV 权限同时拥有<strong>授予权限</strong>的权限，较为特殊。这里对和这两个权限相关的操作逐一说明。</p><ol><li>CREATE USER<ul><li>拥有 ADMIN 权限，或任意层级的 GRANT 权限的用户可以创建新用户。</li></ul></li><li>DROP USER<ul><li>只有 ADMIN 权限可以删除用户。</li></ul></li><li>CREATE/DROP ROLE<ul><li>只有 ADMIN 权限可以创建角色。</li></ul></li><li>GRANT/REVOKE<ul><li>拥有 ADMIN 权限，或者 GLOBAL 层级 GRANT 权限的用户，可以授予或撤销任意用户的权限。</li><li>拥有 DATABASE 层级 GRANT 权限的用户，可以授予或撤销任意用户对指定数据库的权限。</li><li>拥有 TABLE 层级 GRANT 权限的用户，可以授予或撤销任意用户对指定数据库中指定表的权限。</li></ul></li><li>SET PASSWORD<ul><li>拥有 ADMIN 权限，或者 GLOBAL 层级 GRANT 权限的用户，可以设置任意用户的密码。</li><li>普通用户可以设置自己对应的 UserIdentity 的密码。自己对应的 UserIdentity 可以通过 <code>SELECT CURRENT_USER();</code> 命令查看。</li><li>拥有非 GLOBAL 层级 GRANT 权限的用户，不可以设置已存在用户的密码，仅能在创建用户时指定密码。</li></ul></li></ol><h3 id="6-6-一些说明"><a href="#6-6-一些说明" class="headerlink" title="6.6 一些说明"></a>6.6 一些说明</h3><ol><li><p>Doris 初始化时，会自动创建如下用户和角色：</p><ol><li>operator 角色：该角色拥有 Node_priv 和 Admin_priv，即对Doris的所有权限。后续某个升级版本中，我们可能会将该角色的权限限制为 Node_priv，即仅授予节点变更权限。以满足某些云上部署需求。</li><li>admin 角色：该角色拥有 Admin_priv，即除节点变更以外的所有权限。</li><li>root@&#39;%&#39;：root 用户，允许从任意节点登陆，角色为 operator。</li><li>admin@&#39;%&#39;：admin 用户，允许从任意节点登陆，角色为 admin。</li></ol></li><li><p>不支持删除或更改默认创建的角色或用户的权限。</p></li><li><p>operator 角色的用户有且只有一个。admin 角色的用户可以创建多个。</p></li><li><p>一些可能产生冲突的操作说明</p><ol><li><p>域名与ip冲突：</p><p>假设创建了如下用户：</p><p>CREATE USER cmy@[&#39;domain&#39;];</p><p>并且授权：</p><p>GRANT SELECT_PRIV ON *.* TO cmy@[&#39;domain&#39;]</p><p>该 domain 被解析为两个 ip：ip1 和 ip2</p><p>假设之后，我们对 cmy@&#39;ip1&#39; 进行一次单独授权：</p><p>GRANT ALTER_PRIV ON <em>.</em> TO cmy@&#39;ip1&#39;;</p><p>则 cmy@&#39;ip1&#39; 的权限会被修改为 SELECT_PRIV, ALTER_PRIV。并且当我们再次变更 cmy@[&#39;domain&#39;] 的权限时，cmy@&#39;ip1&#39; 也不会跟随改变。</p></li><li><p>重复ip冲突：</p><p>假设创建了如下用户：</p><p>CREATE USER cmy@&#39;%&#39; IDENTIFIED BY &quot;12345&quot;;</p><p>CREATE USER cmy@&#39;192.%&#39; IDENTIFIED BY &quot;abcde&quot;;</p><p>在优先级上，&#39;192.%&#39; 优先于 &#39;%&#39;，因此，当用户 cmy 从 192.168.1.1 这台机器尝试使用密码 &#39;12345&#39; 登陆 Doris 会被拒绝。</p></li></ol></li><li><p>忘记密码</p><p>如果忘记了密码无法登陆 Doris，可以在 Doris FE 节点所在机器，使用如下命令无密码登陆 Doris：</p><p><code>mysql-client -h 127.0.0.1 -P query_port -uroot</code></p><p>登陆后，可以通过 SET PASSWORD 命令重置密码。</p></li><li><p>任何用户都不能重置 root 用户的密码，除了 root 用户自己。</p></li><li><p>ADMIN_PRIV 权限只能在 GLOBAL 层级授予或撤销。</p></li><li><p>拥有 GLOBAL 层级 GRANT_PRIV 其实等同于拥有 ADMIN_PRIV，因为该层级的 GRANT_PRIV 有授予任意权限的权限，请谨慎使用。</p></li><li><p><code>current_user()</code> 和 <code>user()</code></p><p>用户可以通过 <code>SELECT current_user();</code> 和 <code>SELECT user();</code> 分别查看 <code>current_user</code> 和 <code>user</code>。其中 <code>current_user</code> 表示当前用户是以哪种身份通过认证系统的，而 <code>user</code> 则是用户当前实际的 <code>user_identity</code>。举例说明：</p><p>假设创建了 <code>user1@&#39;192.%&#39;</code> 这个用户，然后以为来自 192.168.10.1 的用户 user1 登陆了系统，则此时的 <code>current_user</code> 为 <code>user1@&#39;192.%&#39;</code>，而 <code>user</code> 为 <code>user1@&#39;192.168.10.1&#39;</code>。</p><p>所有的权限都是赋予某一个 <code>current_user</code> 的，真实用户拥有对应的 <code>current_user</code> 的所有权限。</p></li></ol><h3 id="6-7-最佳实践"><a href="#6-7-最佳实践" class="headerlink" title="6.7 最佳实践"></a>6.7 最佳实践</h3><p>这里举例一些 Doris 权限系统的使用场景。</p><ol><li><p>场景一</p><p>Doris 集群的使用者分为管理员（Admin）、开发工程师（RD）和用户（Client）。其中管理员拥有整个集群的所有权限，主要负责集群的搭建、节点管理等。开发工程师负责业务建模，包括建库建表、数据的导入和修改等。用户访问不同的数据库和表来获取数据。</p><p>在这种场景下，可以为管理员赋予 ADMIN 权限或 GRANT 权限。对 RD 赋予对任意或指定数据库表的 CREATE、DROP、ALTER、LOAD、SELECT 权限。对 Client 赋予对任意或指定数据库表 SELECT 权限。同时，也可以通过创建不同的角色，来简化对多个用户的授权操作。</p></li><li><p>场景二</p><p>一个集群内有多个业务，每个业务可能使用一个或多个数据。每个业务需要管理自己的用户。在这种场景下。管理员用户可以为每个数据库创建一个拥有 DATABASE 层级 GRANT 权限的用户。该用户仅可以对用户进行指定的数据库的授权。</p></li><li><p>黑名单</p><p>Doris 本身不支持黑名单，只有白名单功能，但我们可以通过某些方式来模拟黑名单。假设先创建了名为 <code>user@&#39;192.%&#39;</code> 的用户，表示允许来自 <code>192.*</code> 的用户登录。此时如果想禁止来自 <code>192.168.10.1</code> 的用户登录。则可以再创建一个用户 <code>cmy@&#39;192.168.10.1&#39;</code> 的用户，并设置一个新的密码。因为 <code>192.168.10.1</code> 的优先级高于 <code>192.%</code>，所以来自 <code>192.168.10.1</code> 将不能再使用旧密码进行登录。</p></li></ol></div><div><div><div style="text-align:center;color:#ccc;font-size:14px">-------------本文结束<i class="fa fa-paw"></i>感谢您的阅读-------------</div></div></div><div></div><footer class="post-footer"><div class="post-tags"><a href="/tags/Hadoop/" rel="tag"><i class="fa fa-tag"></i> Hadoop</a><a href="/tags/Apache-Doris/" rel="tag"><i class="fa fa-tag"></i> Apache Doris</a><a href="/tags/OLAP/" rel="tag"><i class="fa fa-tag"></i> OLAP</a></div><div class="post-nav"><div class="post-nav-next post-nav-item"><a href="/2021/12/02/superset-yi-kuan-qing-liang-ji-bi-gong-ju/" rel="next" title="Superset 一款轻量级BI工具"><i class="fa fa-chevron-left"></i> Superset 一款轻量级BI工具</a></div><span class="post-nav-divider"></span><div class="post-nav-prev post-nav-item"><a href="/2021/12/07/apache-doris-he-clickhouse-shen-du-dui-bi/" rel="prev" title="Apache Doris和 ClickHouse深度对比">Apache Doris和 ClickHouse深度对比<i class="fa fa-chevron-right"></i></a></div></div></footer></div></article><div class="post-spread"><div class="jiathis_style"><span class="jiathis_txt">分享到：</span> <a class="jiathis_button_fav">收藏夹</a> <a class="jiathis_button_copy">复制网址</a> <a class="jiathis_button_email">邮件</a> <a class="jiathis_button_weixin">微信</a> <a class="jiathis_button_qzone">QQ空间</a> <a class="jiathis_button_tqq">腾讯微博</a> <a class="jiathis_button_douban">豆瓣</a> <a class="jiathis_button_share">一键分享</a> <a href="http://www.jiathis.com/share?uid=2140465" class="jiathis jiathis_txt jiathis_separator jtico jtico_jiathis" target="_blank">更多</a><a class="jiathis_counter_style"></a></div><script type="text/javascript">var jiathis_config={data_track_clickback:!0,summary:"",shortUrl:!1,hideMore:!1}</script><script type="text/javascript" src="http://v3.jiathis.com/code/jia.js?uid=" charset="utf-8"></script></div></div></div></div><div class="sidebar-toggle"><div class="sidebar-toggle-line-wrap"><span class="sidebar-toggle-line sidebar-toggle-line-first"></span><span class="sidebar-toggle-line sidebar-toggle-line-middle"></span><span class="sidebar-toggle-line sidebar-toggle-line-last"></span></div></div><aside id="sidebar" class="sidebar"><div id="sidebar-dimmer"></div><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">文章目录</li><li class="sidebar-nav-overview" data-target="site-overview-wrap">站点概览</li></ul><section class="site-overview-wrap sidebar-panel"><div class="site-overview"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="site-author-image" itemprop="image" src="/images/chen.png" alt="Zhongzhou Chen"><p class="site-author-name" itemprop="name">Zhongzhou Chen</p><p class="site-description motion-element" itemprop="description"></p></div><nav class="site-state motion-element"><div class="site-state-item site-state-posts"><a href="/archives/%7C%7C%20archive"><span class="site-state-item-count">318</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"><a href="/categories/index.html"><span class="site-state-item-count">84</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"><a href="/tags/index.html"><span class="site-state-item-count">181</span> <span class="site-state-item-name">标签</span></a></div></nav><div class="feed-link motion-element"><a href="/atom.xml" rel="alternate"><i class="fa fa-rss"></i> RSS</a></div></div></section><section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active"><div class="post-toc"><div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#一、概述"><span class="nav-text">一、概述</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#二、Doris-架构"><span class="nav-text">二、Doris 架构</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-1-整体架构"><span class="nav-text">2.1 整体架构</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2-元数据"><span class="nav-text">2.2 元数据</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-3-数据流"><span class="nav-text">2.3 数据流</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-3-实现细节"><span class="nav-text">2.3 实现细节</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#2-3-1-元数据目录"><span class="nav-text">2.3.1 元数据目录</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-3-2-启动流程"><span class="nav-text">2.3.2 启动流程</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-4-宕机恢复"><span class="nav-text">2.4 宕机恢复</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-5-核心特性"><span class="nav-text">2.5 核心特性</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#三、Doris-编译与部署"><span class="nav-text">三、Doris 编译与部署</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#3-1-编译"><span class="nav-text">3.1 编译</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#3-1-1-下载-Docker-镜像"><span class="nav-text">3.1.1 下载 Docker 镜像</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-1-2-运行镜像"><span class="nav-text">3.1.2 运行镜像</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-1-3-下载源码"><span class="nav-text">3.1.3 下载源码</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-1-4-编译-Doris"><span class="nav-text">3.1.4 编译 Doris</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-2-群集部署"><span class="nav-text">3.2 群集部署</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#3-2-1-官方建议配置"><span class="nav-text">3.2.1 官方建议配置</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-2-2-网络需求"><span class="nav-text">3.2.2 网络需求</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-2-3-服务规划"><span class="nav-text">3.2.3 服务规划</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-2-4-IP-绑定"><span class="nav-text">3.2.4 IP 绑定</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-2-5-FE-部署"><span class="nav-text">3.2.5 FE 部署</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-2-6-BE-部署"><span class="nav-text">3.2.6 BE 部署</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-2-7-FS-Broker-部署（可选）"><span class="nav-text">3.2.7 FS_Broker 部署（可选）</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#四、扩容缩容"><span class="nav-text">四、扩容缩容</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#4-1-FE-扩容和缩容"><span class="nav-text">4.1 FE 扩容和缩容</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#4-1-1-增加-FE-节点"><span class="nav-text">4.1.1 增加 FE 节点</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-1-2-删除-FE-节点"><span class="nav-text">4.1.2 删除 FE 节点</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-2-BE-扩容和缩容"><span class="nav-text">4.2 BE 扩容和缩容</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#4-2-1-增加-BE-节点"><span class="nav-text">4.2.1 增加 BE 节点</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-2-2-删除-BE-节点"><span class="nav-text">4.2.2 删除 BE 节点</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-3-Broker-扩容缩容"><span class="nav-text">4.3 Broker 扩容缩容</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#五、最佳实践"><span class="nav-text">五、最佳实践</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#5-1-建表"><span class="nav-text">5.1 建表</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#5-1-1-数据模型选择"><span class="nav-text">5.1.1 数据模型选择</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#5-1-2-大宽表与-Star-Schema"><span class="nav-text">5.1.2 大宽表与 Star Schema</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#5-1-3-分区和分桶"><span class="nav-text">5.1.3 分区和分桶</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#5-1-4-稀疏索引和-Bloom-Filter"><span class="nav-text">5.1.4 稀疏索引和 Bloom Filter</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#5-1-5-物化视图-rollup"><span class="nav-text">5.1.5 物化视图(rollup)</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-2-Schema-Change"><span class="nav-text">5.2 Schema Change</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#六、权限管理"><span class="nav-text">六、权限管理</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#6-1-名词解释"><span class="nav-text">6.1 名词解释</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-2-支持的操作"><span class="nav-text">6.2 支持的操作</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-3-权限类型"><span class="nav-text">6.3 权限类型</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-4-权限层级"><span class="nav-text">6.4 权限层级</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-5-ADMIN-GRANT-权限说明"><span class="nav-text">6.5 ADMIN/GRANT 权限说明</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-6-一些说明"><span class="nav-text">6.6 一些说明</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-7-最佳实践"><span class="nav-text">6.7 最佳实践</span></a></li></ol></li></ol></div></div></section><div class="back-to-top"><i class="fa fa-arrow-up"></i> <span id="scrollpercent"><span>0</span>%</span></div></div></aside></div></main><footer id="footer" class="footer"><div class="footer-inner"><script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script><div class="copyright">&copy; <span itemprop="copyrightYear">2022</span><span class="with-love"><i class="fa fa-user"></i></span> <span class="author" itemprop="copyrightHolder">Zhongzhou Chen</span> <span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-area-chart"></i></span> <span class="post-meta-item-text">Site words total count&#58;</span> <span title="Site words total count">756k</span></div><span class="post-meta-divider"></span></div></footer></div><script type="text/javascript">"[object Function]"!==Object.prototype.toString.call(window.Promise)&&(window.Promise=null)</script><script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script><script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script><script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script><script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script><script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script><script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script><script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script><style>.copy-btn{display:inline-block;padding:6px 12px;font-size:13px;font-weight:700;line-height:20px;color:#333;white-space:nowrap;vertical-align:middle;cursor:pointer;background-color:#eee;background-image:linear-gradient(#fcfcfc,#eee);border:1px solid #d5d5d5;border-radius:3px;user-select:none;outline:0}.highlight-wrap .copy-btn{transition:opacity .3s ease-in-out;opacity:0;padding:2px 6px;position:absolute;right:4px;top:8px}.highlight-wrap .copy-btn:focus,.highlight-wrap:hover .copy-btn{opacity:1}.highlight-wrap{position:relative}</style><script>$(".highlight").each(function(t,e){var n=$("<div>").addClass("highlight-wrap");$(e).after(n),n.append($("<button>").addClass("copy-btn").append("复制").on("click",function(t){var e=$(this).parent().find(".code").find(".line").map(function(t,e){return $(e).text()}).toArray().join("\n"),n=document.createElement("textarea");document.body.appendChild(n),n.style.position="absolute",n.style.top="0px",n.style.left="0px",n.value=e,n.select(),n.focus();var o=document.execCommand("copy");document.body.removeChild(n),o?$(this).text("复制成功"):$(this).text("复制失败"),$(this).blur()})).on("mouseleave",function(t){var e=$(this).find(".copy-btn");setTimeout(function(){e.text("复制")},300)}).append(e)})</script><script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script><script type="text/javascript">function proceedsearch(){$("body").append('<div class="search-popup-overlay local-search-pop-overlay"></div>').css("overflow","hidden"),$(".search-popup-overlay").click(onPopupClose),$(".popup").toggle();var t=$("#local-search-input");t.attr("autocapitalize","none"),t.attr("autocorrect","off"),t.focus()}var isfetched=!1,isXml=!0,search_path="search.xml";0===search_path.length?search_path="search.xml":/json$/i.test(search_path)&&(isXml=!1);var path="/"+search_path,onPopupClose=function(t){$(".popup").hide(),$("#local-search-input").val(""),$(".search-result-list").remove(),$("#no-result").remove(),$(".local-search-pop-overlay").remove(),$("body").css("overflow","")},searchFunc=function(t,e,s){"use strict";$("body").append('<div class="search-popup-overlay local-search-pop-overlay"><div id="search-loading-icon"><i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i></div></div>').css("overflow","hidden"),$("#search-loading-icon").css("margin","20% auto 0 auto").css("text-align","center"),$.ajax({url:t,dataType:isXml?"xml":"json",async:!0,success:function(t){isfetched=!0,$(".popup").detach().appendTo(".header-inner");var o=isXml?$("entry",t).map(function(){return{title:$("title",this).text(),content:$("content",this).text(),url:$("url",this).text()}}).get():t,n=document.getElementById(e),r=document.getElementById(s);n.addEventListener("input",function(){var y=n.value.trim().toLowerCase(),T=y.split(/[\s\-]+/);1<T.length&&T.push(y);var b=[];if(0<y.length&&o.forEach(function(t){function e(t,e,o,n){for(var r=n[n.length-1],s=r.position,a=r.word,i=[],c=0;s+a.length<=o&&0!=n.length;){a===y&&c++,i.push({position:s,length:a.length});var l=s+a.length;for(n.pop();0!=n.length&&(s=(r=n[n.length-1]).position,a=r.word,s<l);)n.pop()}return h+=c,{hits:i,start:e,end:o,searchTextCount:c}}function o(o,t){var n="",r=t.start;return t.hits.forEach(function(t){n+=o.substring(r,t.position);var e=t.position+t.length;n+='<b class="search-keyword">'+o.substring(t.position,e)+"</b>",r=e}),n+=o.substring(r,t.end)}var n=!1,r=0,h=0,s=t.title.trim(),a=s.toLowerCase(),i=t.content.trim().replace(/<[^>]+>/g,""),c=i.toLowerCase(),l=decodeURIComponent(t.url),p=[],u=[];if(""!=s&&(T.forEach(function(t){function e(t,e,o){var n=t.length;if(0===n)return[];var r=0,s=[],a=[];for(o||(e=e.toLowerCase(),t=t.toLowerCase());-1<(s=e.indexOf(t,r));)a.push({position:s,word:t}),r=s+n;return a}p=p.concat(e(t,a,!1)),u=u.concat(e(t,c,!1))}),(0<p.length||0<u.length)&&(n=!0,r=p.length+u.length)),n){[p,u].forEach(function(t){t.sort(function(t,e){return e.position!==t.position?e.position-t.position:t.word.length-e.word.length})});var f=[];0!=p.length&&f.push(e(0,0,s.length,p));for(var d=[];0!=u.length;){var g=u[u.length-1],v=g.position,$=g.word,C=v-20,m=v+80;C<0&&(C=0),m<v+$.length&&(m=v+$.length),m>i.length&&(m=i.length),d.push(e(0,C,m,u))}d.sort(function(t,e){return t.searchTextCount!==e.searchTextCount?e.searchTextCount-t.searchTextCount:t.hits.length!==e.hits.length?e.hits.length-t.hits.length:t.start-e.start});var x=parseInt("1");0<=x&&(d=d.slice(0,x));var w="";w+=0!=f.length?"<li><a href='"+l+"' class='search-result-title'>"+o(s,f[0])+"</a>":"<li><a href='"+l+"' class='search-result-title'>"+s+"</a>",d.forEach(function(t){w+="<a href='"+l+'\'><p class="search-result">'+o(i,t)+"...</p></a>"}),w+="</li>",b.push({item:w,searchTextCount:h,hitCount:r,id:b.length})}}),1===T.length&&""===T[0])r.innerHTML='<div id="no-result"><i class="fa fa-search fa-5x" /></div>';else if(0===b.length)r.innerHTML='<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>';else{b.sort(function(t,e){return t.searchTextCount!==e.searchTextCount?e.searchTextCount-t.searchTextCount:t.hitCount!==e.hitCount?e.hitCount-t.hitCount:e.id-t.id});var e='<ul class="search-result-list">';b.forEach(function(t){e+=t.item}),e+="</ul>",r.innerHTML=e}}),$(".local-search-pop-overlay").remove(),$("body").css("overflow",""),proceedsearch()}})};$(".popup-trigger").click(function(t){t.stopPropagation(),!1===isfetched?searchFunc(path,"local-search-input","local-search-result"):proceedsearch()}),$(".popup-btn-close").click(onPopupClose),$(".popup").click(function(t){t.stopPropagation()}),$(document).on("keyup",function(t){27===t.which&&$(".search-popup").is(":visible")&&onPopupClose()})</script><script type="text/javascript" src="/js/src/love.js"></script><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({pluginRootPath:"live2dw/",pluginJsPath:"lib/",pluginModelPath:"assets/",tagMode:!1,debug:!1,log:!1,model:{jsonPath:"/live2dw/assets/shizuku.model.json"},display:{position:"right"},mobile:{show:!0,scale:.2},react:{opacityDefault:.7,opacityOnHover:.2,opacity:.4}})</script></body></html>