<!DOCTYPE html><html class="theme-next gemini use-motion" lang="zh-Hans"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><script src="//cdn.bootcss.com/pace/1.0.2/pace.min.js"></script><link href="//cdn.bootcss.com/pace/1.0.2/themes/pink/pace-theme-flash.css" rel="stylesheet"><script></script><meta name="theme-color" content="#222"><style>.pace .pace-progress{background:#1e92fb;height:3px}.pace .pace-progress-inner{box-shadow:0 0 10px #1e92fb,0 0 5px #1e92fb}.pace .pace-activity{border-top-color:#1e92fb;border-left-color:#1e92fb}</style><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><meta name="google-site-verification" content="HGM141IpbHrSmnAmR6W_zE4bo9Z3f-yXLeHYT3bg1fk"><meta name="baidu-site-verification" content="code-5Ai1DA8e6T"><link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css"><link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css"><link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4"><link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222"><meta name="keywords" content="缓存,MemCache,"><link rel="alternate" href="/atom.xml" title="凡间的精灵" type="application/atom+xml"><meta name="description" content="1、MemCache 简介MemCache是一个自由、源码开放、高性能、分布式的分布式内存对象缓存系统，用于动态Web应用以减轻数据库的负载。它通过在内存中缓存数据和对象来减少读取数据库的次数，从而提高了网站访问的速度。 MemCaChe是一个存储键值对的HashMap，在内存中对任意的数据（比如字符串、对象等）所使用的key-value存储，数据可以来自数据库调用、API调用，或者页面渲染的结果"><meta name="keywords" content="缓存,MemCache"><meta property="og:type" content="article"><meta property="og:title" content="MemCache 缓存服务"><meta property="og:url" content="http:&#x2F;&#x2F;chenzhonzhou.github.io&#x2F;2017&#x2F;11&#x2F;05&#x2F;memcache-huan-cun-fu-wu&#x2F;index.html"><meta property="og:site_name" content="凡间的精灵"><meta property="og:description" content="1、MemCache 简介MemCache是一个自由、源码开放、高性能、分布式的分布式内存对象缓存系统，用于动态Web应用以减轻数据库的负载。它通过在内存中缓存数据和对象来减少读取数据库的次数，从而提高了网站访问的速度。 MemCaChe是一个存储键值对的HashMap，在内存中对任意的数据（比如字符串、对象等）所使用的key-value存储，数据可以来自数据库调用、API调用，或者页面渲染的结果"><meta property="og:locale" content="zh-Hans"><meta property="og:image" content="http:&#x2F;&#x2F;chenzhonzhou.github.io&#x2F;2017&#x2F;11&#x2F;05&#x2F;memcache-huan-cun-fu-wu&#x2F;%E5%9B%BE%E7%89%871.png"><meta property="og:image" content="http:&#x2F;&#x2F;chenzhonzhou.github.io&#x2F;2017&#x2F;11&#x2F;05&#x2F;memcache-huan-cun-fu-wu&#x2F;%E5%9B%BE%E7%89%872.png"><meta property="og:image" content="http:&#x2F;&#x2F;chenzhonzhou.github.io&#x2F;2017&#x2F;11&#x2F;05&#x2F;memcache-huan-cun-fu-wu&#x2F;%E5%9B%BE%E7%89%873.png"><meta property="og:image" content="http:&#x2F;&#x2F;chenzhonzhou.github.io&#x2F;2017&#x2F;11&#x2F;05&#x2F;memcache-huan-cun-fu-wu&#x2F;%E5%9B%BE%E7%89%874.png"><meta property="og:image" content="http:&#x2F;&#x2F;chenzhonzhou.github.io&#x2F;2017&#x2F;11&#x2F;05&#x2F;memcache-huan-cun-fu-wu&#x2F;%E5%9B%BE%E7%89%875.png"><meta property="og:image" content="http:&#x2F;&#x2F;chenzhonzhou.github.io&#x2F;2017&#x2F;11&#x2F;05&#x2F;memcache-huan-cun-fu-wu&#x2F;%E5%9B%BE%E7%89%876.png"><meta property="og:image" content="http:&#x2F;&#x2F;chenzhonzhou.github.io&#x2F;2017&#x2F;11&#x2F;05&#x2F;memcache-huan-cun-fu-wu&#x2F;%E5%9B%BE%E7%89%877.png"><meta property="og:image" content="http:&#x2F;&#x2F;chenzhonzhou.github.io&#x2F;2017&#x2F;11&#x2F;05&#x2F;memcache-huan-cun-fu-wu&#x2F;%E5%9B%BE%E7%89%878.png"><meta property="og:image" content="http:&#x2F;&#x2F;chenzhonzhou.github.io&#x2F;2017&#x2F;11&#x2F;05&#x2F;memcache-huan-cun-fu-wu&#x2F;%E5%9B%BE%E7%89%879.png"><meta property="og:image" content="http:&#x2F;&#x2F;chenzhonzhou.github.io&#x2F;2017&#x2F;11&#x2F;05&#x2F;memcache-huan-cun-fu-wu&#x2F;%E5%9B%BE%E7%89%8710.png"><meta property="og:image" content="http:&#x2F;&#x2F;chenzhonzhou.github.io&#x2F;2017&#x2F;11&#x2F;05&#x2F;memcache-huan-cun-fu-wu&#x2F;%E5%9B%BE%E7%89%8711.png"><meta property="og:image" content="http:&#x2F;&#x2F;chenzhonzhou.github.io&#x2F;2017&#x2F;11&#x2F;05&#x2F;memcache-huan-cun-fu-wu&#x2F;%E5%9B%BE%E7%89%8712.png"><meta property="og:image" content="http:&#x2F;&#x2F;chenzhonzhou.github.io&#x2F;2017&#x2F;11&#x2F;05&#x2F;memcache-huan-cun-fu-wu&#x2F;%E5%9B%BE%E7%89%8713.png"><meta property="og:image" content="http:&#x2F;&#x2F;chenzhonzhou.github.io&#x2F;2017&#x2F;11&#x2F;05&#x2F;memcache-huan-cun-fu-wu&#x2F;%E5%9B%BE%E7%89%8714.png"><meta property="og:image" content="http:&#x2F;&#x2F;chenzhonzhou.github.io&#x2F;2017&#x2F;11&#x2F;05&#x2F;memcache-huan-cun-fu-wu&#x2F;%E5%9B%BE%E7%89%8715.png"><meta property="og:image" content="http:&#x2F;&#x2F;chenzhonzhou.github.io&#x2F;2017&#x2F;11&#x2F;05&#x2F;memcache-huan-cun-fu-wu&#x2F;%E5%9B%BE%E7%89%8716.png"><meta property="og:image" content="http:&#x2F;&#x2F;chenzhonzhou.github.io&#x2F;2017&#x2F;11&#x2F;05&#x2F;memcache-huan-cun-fu-wu&#x2F;%E5%9B%BE%E7%89%8717.png"><meta property="og:image" content="http:&#x2F;&#x2F;chenzhonzhou.github.io&#x2F;2017&#x2F;11&#x2F;05&#x2F;memcache-huan-cun-fu-wu&#x2F;%E5%9B%BE%E7%89%8718.png"><meta property="og:image" content="http:&#x2F;&#x2F;chenzhonzhou.github.io&#x2F;2017&#x2F;11&#x2F;05&#x2F;memcache-huan-cun-fu-wu&#x2F;%E5%9B%BE%E7%89%8719.png"><meta property="og:image" content="http:&#x2F;&#x2F;chenzhonzhou.github.io&#x2F;2017&#x2F;11&#x2F;05&#x2F;memcache-huan-cun-fu-wu&#x2F;%E5%9B%BE%E7%89%8720.png"><meta property="og:image" content="http:&#x2F;&#x2F;chenzhonzhou.github.io&#x2F;2017&#x2F;11&#x2F;05&#x2F;memcache-huan-cun-fu-wu&#x2F;%E5%9B%BE%E7%89%8722.png"><meta property="og:image" content="http:&#x2F;&#x2F;chenzhonzhou.github.io&#x2F;2017&#x2F;11&#x2F;05&#x2F;memcache-huan-cun-fu-wu&#x2F;%E5%9B%BE%E7%89%8723.png"><meta property="og:image" content="http:&#x2F;&#x2F;chenzhonzhou.github.io&#x2F;2017&#x2F;11&#x2F;05&#x2F;memcache-huan-cun-fu-wu&#x2F;%E5%9B%BE%E7%89%8724.png"><meta property="og:image" content="http:&#x2F;&#x2F;chenzhonzhou.github.io&#x2F;2017&#x2F;11&#x2F;05&#x2F;memcache-huan-cun-fu-wu&#x2F;%E5%9B%BE%E7%89%8725.png"><meta property="og:image" content="http:&#x2F;&#x2F;chenzhonzhou.github.io&#x2F;2017&#x2F;11&#x2F;05&#x2F;memcache-huan-cun-fu-wu&#x2F;%E5%9B%BE%E7%89%8726.png"><meta property="og:image" content="http:&#x2F;&#x2F;chenzhonzhou.github.io&#x2F;2017&#x2F;11&#x2F;05&#x2F;memcache-huan-cun-fu-wu&#x2F;%E5%9B%BE%E7%89%8727.png"><meta property="og:image" content="http:&#x2F;&#x2F;chenzhonzhou.github.io&#x2F;2017&#x2F;11&#x2F;05&#x2F;memcache-huan-cun-fu-wu&#x2F;%E5%9B%BE%E7%89%8728.png"><meta property="og:image" content="http:&#x2F;&#x2F;chenzhonzhou.github.io&#x2F;2017&#x2F;11&#x2F;05&#x2F;memcache-huan-cun-fu-wu&#x2F;%E5%9B%BE%E7%89%8729.png"><meta property="og:image" content="http:&#x2F;&#x2F;chenzhonzhou.github.io&#x2F;2017&#x2F;11&#x2F;05&#x2F;memcache-huan-cun-fu-wu&#x2F;%E5%9B%BE%E7%89%8730.png"><meta property="og:image" content="http:&#x2F;&#x2F;chenzhonzhou.github.io&#x2F;2017&#x2F;11&#x2F;05&#x2F;memcache-huan-cun-fu-wu&#x2F;%E5%9B%BE%E7%89%8731.png"><meta property="og:image" content="http:&#x2F;&#x2F;chenzhonzhou.github.io&#x2F;2017&#x2F;11&#x2F;05&#x2F;memcache-huan-cun-fu-wu&#x2F;%E5%9B%BE%E7%89%8732.png"><meta property="og:image" content="http:&#x2F;&#x2F;chenzhonzhou.github.io&#x2F;2017&#x2F;11&#x2F;05&#x2F;memcache-huan-cun-fu-wu&#x2F;%E5%9B%BE%E7%89%8733.png"><meta property="og:image" content="http:&#x2F;&#x2F;chenzhonzhou.github.io&#x2F;2017&#x2F;11&#x2F;05&#x2F;memcache-huan-cun-fu-wu&#x2F;%E5%9B%BE%E7%89%8734.png"><meta property="og:image" content="http:&#x2F;&#x2F;chenzhonzhou.github.io&#x2F;2017&#x2F;11&#x2F;05&#x2F;memcache-huan-cun-fu-wu&#x2F;%E5%9B%BE%E7%89%8735.png"><meta property="og:image" content="http:&#x2F;&#x2F;chenzhonzhou.github.io&#x2F;2017&#x2F;11&#x2F;05&#x2F;memcache-huan-cun-fu-wu&#x2F;%E5%9B%BE%E7%89%8736.png"><meta property="og:image" content="http:&#x2F;&#x2F;chenzhonzhou.github.io&#x2F;2017&#x2F;11&#x2F;05&#x2F;memcache-huan-cun-fu-wu&#x2F;%E5%9B%BE%E7%89%8737.png"><meta property="og:image" content="http:&#x2F;&#x2F;chenzhonzhou.github.io&#x2F;2017&#x2F;11&#x2F;05&#x2F;memcache-huan-cun-fu-wu&#x2F;%E5%9B%BE%E7%89%8738.png"><meta property="og:image" content="http:&#x2F;&#x2F;chenzhonzhou.github.io&#x2F;2017&#x2F;11&#x2F;05&#x2F;memcache-huan-cun-fu-wu&#x2F;%E5%9B%BE%E7%89%8739.png"><meta property="og:image" content="http:&#x2F;&#x2F;chenzhonzhou.github.io&#x2F;2017&#x2F;11&#x2F;05&#x2F;memcache-huan-cun-fu-wu&#x2F;%E5%9B%BE%E7%89%8740.png"><meta property="og:image" content="http:&#x2F;&#x2F;chenzhonzhou.github.io&#x2F;2017&#x2F;11&#x2F;05&#x2F;memcache-huan-cun-fu-wu&#x2F;%E5%9B%BE%E7%89%8741.png"><meta property="og:updated_time" content="2019-11-15T03:16:18.797Z"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="http:&#x2F;&#x2F;chenzhonzhou.github.io&#x2F;2017&#x2F;11&#x2F;05&#x2F;memcache-huan-cun-fu-wu&#x2F;%E5%9B%BE%E7%89%871.png"><script type="text/javascript" id="hexo.configurations">var NexT=window.NexT||{},CONFIG={root:"/",scheme:"Gemini",version:"5.1.4",sidebar:{position:"left",display:"always",offset:12,b2t:!0,scrollpercent:!0,onmobile:!0},fancybox:!0,tabs:!0,motion:{enable:!0,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}},duoshuo:{userId:"0",author:"博主"},algolia:{applicationID:"",apiKey:"",indexName:"",hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}}}</script><link rel="canonical" href="http://chenzhonzhou.github.io/2017/11/05/memcache-huan-cun-fu-wu/"><title>MemCache 缓存服务 | 凡间的精灵</title><link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css"></head><body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans"><div class="container sidebar-position-left page-post-detail"><div class="headband"></div><header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-wrapper"><div class="site-meta"><div class="custom-logo-site-title"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">凡间的精灵</span><span class="logo-line-after"><i></i></span></a></div><p class="site-subtitle">凡尘落素一精灵</p></div><div class="site-nav-toggle"><button><span class="btn-bar"></span><span class="btn-bar"></span><span class="btn-bar"></span></button></div></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i><br>首页</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i><br>归档</a></li><li class="menu-item menu-item-categories"><a href="/categories" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i><br>分类</a></li><li class="menu-item menu-item-tags"><a href="/tags" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i><br>标签</a></li><li class="menu-item menu-item-sitemap"><a href="/sitemap.xml" rel="section"><i class="menu-item-icon fa fa-fw fa-sitemap"></i><br>站点地图</a></li><li class="menu-item menu-item-search"><a href="javascript:;" class="popup-trigger"><i class="menu-item-icon fa fa-search fa-fw"></i><br>搜索</a></li></ul><div class="site-search"><div class="popup search-popup local-search-popup"><div class="local-search-header clearfix"><span class="search-icon"><i class="fa fa-search"></i></span><span class="popup-btn-close"><i class="fa fa-times-circle"></i></span><div class="local-search-input-wrapper"><input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input"></div></div><div id="local-search-result"></div></div></div></nav></div></header><main id="main" class="main"><div class="main-inner"><div class="content-wrap"><div id="content" class="content"><div id="posts" class="posts-expand"><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><div class="post-block"><link itemprop="mainEntityOfPage" href="http://chenzhonzhou.github.io/2017/11/05/memcache-huan-cun-fu-wu/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="name" content="Zhongzhou Chen"><meta itemprop="description" content=""><meta itemprop="image" content="/images/chen.png"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="凡间的精灵"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">MemCache 缓存服务</h1><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i></span> <span class="post-meta-item-text">发表于</span> <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-11-05T15:13:45+08:00">2017-11-05</time></span> <span class="post-category"><span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-folder-o"></i></span> <span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/%E7%BC%93%E5%AD%98/" itemprop="url" rel="index"><span itemprop="name">缓存</span></a></span> ， <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/%E7%BC%93%E5%AD%98/MemCache/" itemprop="url" rel="index"><span itemprop="name">MemCache</span></a></span></span><div class="post-wordcount"><span class="post-meta-item-icon"><i class="fa fa-file-word-o"></i></span> <span class="post-meta-item-text">字数统计&#58;</span> <span title="字数统计">8.5k</span> <span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-clock-o"></i></span> <span class="post-meta-item-text">阅读时长 &asymp;</span> <span title="阅读时长">37</span></div></div></header><div class="post-body" itemprop="articleBody"><h2 id="1、MemCache-简介"><a href="#1、MemCache-简介" class="headerlink" title="1、MemCache 简介"></a>1、MemCache 简介</h2><p><strong>MemCache</strong>是一个自由、源码开放、高性能、分布式的分布式内存对象缓存系统，用于动态<strong>Web</strong>应用以减轻数据库的负载。它通过在内存中缓存数据和对象来减少读取数据库的次数，从而提高了网站访问的速度。 <strong>MemCaChe</strong>是一个存储键值对的<strong>HashMap</strong>，在内存中对任意的数据（比如字符串、对象等）所使用的<strong>key-value</strong>存储，数据可以来自数据库调用、<strong>API</strong>调用，或者页面渲染的结果。<strong>MemCache</strong>设计理念就是小而强大，它简单的设计促进了快速部署、易于开发并解决面对大规模的数据缓存的许多难题，而所开放的<strong>API</strong>使得<strong>MemCache</strong>能用于<strong>Java、C/C++/C#、Perl、Python、PHP、Ruby</strong>等大部分流行的程序语言。<br>另外，说一下为什么会有<strong>Memcache</strong>和<strong>memcached</strong>两种名称？其实Memcache是这个项目的名称，而<strong>memcached</strong>是它服务器端的主程序文件名</p><p>MemCache的官方网站为 <a href="http://memcached.org/" target="_blank" rel="noopener">http://memcached.org/</a></p><h3 id="1-1-MemCache访问模型"><a href="#1-1-MemCache访问模型" class="headerlink" title="1.1 MemCache访问模型"></a>1.1 MemCache访问模型</h3><p>为了加深对memcache的理解，以memcache为代表的分布式缓存，访问模型如下：</p><p><img src="/2017/11/05/memcache-huan-cun-fu-wu/%E5%9B%BE%E7%89%871.png" alt="image-20191115092650602"></p><p>特别澄清一个问题，MemCache虽然被称为”分布式缓存”，但是MemCache本身完全不具备分布式的功能，MemCache集群之间不会相互通信（与之形成对比的，比如<strong>JBoss Cache</strong>，某台服务器有缓存数据更新时，会通知集群中其他机器更新缓存或清除缓存数据），所谓的”分布式”，完全依赖于客户端程序的实现，就像上面这张图的流程一样。<br><strong>同时基于这张图，理一下MemCache一次写缓存的流程：</strong><br>1、应用程序输入需要写缓存的数据<br>2、API将Key输入路由算法模块，路由算法根据Key和MemCache集群服务器列表得到一台服务器编号<br>3、由服务器编号得到MemCache及其的ip地址和端口号<br>4、API调用通信模块和指定编号的服务器通信，将数据写入该服务器，完成一次分布式缓存的写操作<br><strong>读缓存和写缓存一样</strong>，只要使用相同的路由算法和服务器列表，只要应用程序查询的是相同的Key，MemCache客户端总是访问相同的客户端去读取数据，只要服务器中还缓存着该数据，就能保证缓存命中。</p><p>这种MemCache集群的方式也是从分区容错性的方面考虑的，假如Node2宕机了，那么Node2上面存储的数据都不可用了，此时由于集群中Node0和Node1还存在，下一次请求Node2中存储的Key值的时候，肯定是没有命中的，这时先从数据库中拿到要缓存的数据，然后路由算法模块根据Key值在Node0和Node1中选取一个节点，把对应的数据放进去，这样下一次就又可以走缓存了，这种集群的做法很好，但是缺点是成本比较大。</p><p>一致性Hash算法</p><p>从上面的图中，可以看出一个很重要的问题，就是对服务器集群的管理，路由算法至关重要，就和负载均衡算法一样，路由算法决定着究竟该访问集群中的哪台服务器，先看一个简单的路由算法。</p><h3 id="1-2-MemCache-缓存算法"><a href="#1-2-MemCache-缓存算法" class="headerlink" title="1.2 MemCache 缓存算法"></a>1.2 MemCache 缓存算法</h3><h4 id="余数Hash"><a href="#余数Hash" class="headerlink" title="余数Hash"></a>余数Hash</h4><p>简单的路由算法可以使用余数Hash：用服务器数目和缓存数据KEY的hash值相除，余数为服务器列表下标编号，假如某个str对应的HashCode是52、服务器的数目是3，取余数得到1，str对应节点Node1，所以路由算法把str路由到Node1服务器上。由于HashCode随机性比较强，所以使用余数Hash路由算法就可以保证缓存数据在整个MemCache服务器集群中有比较均衡的分布。<br>如果不考虑服务器集群的伸缩性，那么余数Hash算法几乎可以满足绝大多数的缓存路由需求，但是当分布式缓存集群需要扩容的时候，就难办了。<br>就假设MemCache服务器集群由3台变为4台吧，更改服务器列表，仍然使用余数Hash，52对4的余数是0，对应Node0，但是str原来是存在Node1上的，这就导致了缓存没有命中。再举个例子，原来有HashCode为0~19的20个数据，那么：</p><p><img src="/2017/11/05/memcache-huan-cun-fu-wu/%E5%9B%BE%E7%89%872.png" alt><br>现在扩容到4台，加粗标红的表示命中：<br><img src="/2017/11/05/memcache-huan-cun-fu-wu/%E5%9B%BE%E7%89%873.png" alt></p><p>如果扩容到20+的台数，只有前三个HashCode对应的Key是命中的，也就是15%。当然现实情况肯定比这个复杂得多，不过足以说明，使用余数Hash的路由算法，在扩容的时候会造成大量的数据无法正确命中（其实不仅仅是无法命中，那些大量的无法命中的数据还在原缓存中在被移除前占据着内存）。在网站业务中，大部分的业务数据度操作请求上事实上是通过缓存获取的，只有少量读操作会访问数据库，因此数据库的负载能力是以有缓存为前提而设计的。当大部分被缓存了的数据因为服务器扩容而不能正确读取时，这些数据访问的压力就落在了数据库的身上，这将大大超过数据库的负载能力，严重的可能会导致数据库宕机。</p><p><strong>这个问题有解决方案，解决步骤为：</strong></p><ol><li><p>在网站访问量低谷，通常是深夜，技术团队加班，扩容、重启服务器</p></li><li><p>通过模拟请求的方式逐渐预热缓存，使缓存服务器中的数据重新分布</p></li></ol><h4 id="一致性Hash算法"><a href="#一致性Hash算法" class="headerlink" title="一致性Hash算法"></a>一致性Hash算法</h4><p>一致性Hash算法通过一个叫做一致性Hash环的数据结构实现Key到缓存服务器的Hash映射。简单地说，一致性哈希将整个哈希值空间组织成一个虚拟的圆环（这个环被称为一致性Hash环），如假设某空间哈希函数H的值空间是0~2^32-1（即哈希值是一个32位无符号整形），整个哈希空间如下：</p><p><img src="/2017/11/05/memcache-huan-cun-fu-wu/%E5%9B%BE%E7%89%874.png" alt="img"></p><p>下一步将各个服务器使用H进行一个哈希计算，具体可以使用服务器的IP地址或者主机名作为关键字，这样每台机器能确定其在上面的哈希环上的位置了，并且是按照顺时针排列，这里我们假设三台节点memcache经计算后位置如下</p><p><img src="/2017/11/05/memcache-huan-cun-fu-wu/%E5%9B%BE%E7%89%875.png" alt="img"></p><p>接下来使用相同算法计算出数据的哈希值h,并由此确定数据在此哈希环上的位置</p><p>假如我们有数据A、B、C、D、4个对象，经过哈希计算后位置如下：</p><p><img src="/2017/11/05/memcache-huan-cun-fu-wu/%E5%9B%BE%E7%89%876.png" alt="img"></p><p>根据一致性哈希算法，数据A就被绑定到了server01上，D被绑定到了server02上，B、C在server03上，是按照顺时针找最近服务节点方法</p><p>这样得到的哈希环调度方法，有很高的容错性和可扩展性：</p><p><strong>假设server03宕机</strong></p><p><img src="/2017/11/05/memcache-huan-cun-fu-wu/%E5%9B%BE%E7%89%877.png" alt="img"></p><p>可以看到此时C、B会受到影响，将B、C被重定位到Server01。一般的，在一致性哈希算法中，如果一台服务器不可用，则受影响的数据仅仅是此服务器到其环空间中前一台服务器（即顺着逆时针方向行走遇到的第一台服务器）之间数据，其它不会受到影响。</p><p>考虑另外一种情况，如果我们在系统中增加一台服务器Memcached Server 04：</p><p><img src="/2017/11/05/memcache-huan-cun-fu-wu/%E5%9B%BE%E7%89%878.png" alt="img"></p><p>此时A、D、C不受影响，只有B需要重定位到新的Server04。一般的，在一致性哈希算法中，如果增加一台服务器，则受影响的数据仅仅是新服务器到其环空间中前一台服务器（即顺着逆时针方向行走遇到的第一台服务器）之间数据，其它不会受到影响。</p><p>综上所述，一致性哈希算法对于节点的增减都只需重定位环空间中的一小部分数据，具有较好的容错性和可扩展性。</p><p><strong>一致性哈希的缺点：</strong>在服务节点太少时，容易因为节点分部不均匀而造成数据倾斜问题。我们可以采用增加虚拟节点的方式解决。</p><p>更重要的是，集群中缓存服务器节点越多，增加/减少节点带来的影响越小，很好理解。换句话说，随着集群规模的增大，继续命中原有缓存数据的概率会越来越大，虽然仍然有小部分数据缓存在服务器中不能被读到，但是这个比例足够小，即使访问数据库，也不会对数据库造成致命的负载压力。</p><h3 id="1-3-MemCache实现原理"><a href="#1-3-MemCache实现原理" class="headerlink" title="1.3 MemCache实现原理"></a>1.3 MemCache实现原理</h3><p>首先要说明一点，MemCache的数据存放在内存中</p><ol><li><p>访问数据的速度比传统的关系型数据库要快，因为Oracle、MySQL这些传统的关系型数据库为了保持数据的持久性，数据存放在硬盘中，IO操作速度慢</p></li><li><p>MemCache的数据存放在内存中同时意味着只要MemCache重启了，数据就会消失</p></li><li><p>既然MemCache的数据存放在内存中，那么势必受到机器位数的限制，32位机器最多只能使用2GB的内存空间，64位机器可以认为没有上限</p></li></ol><p>然后我们来看一下MemCache的原理，MemCache最重要的是内存如何分配的，MemCache采用的内存分配方式是固定空间分配，如下图所示：</p><p><img src="/2017/11/05/memcache-huan-cun-fu-wu/%E5%9B%BE%E7%89%879.png" alt></p><p><strong>这张图片里面涉及了slab_class、slab、page、chunk四个概念，它们之间的关系是：</strong></p><ol><li><p>MemCache将内存空间分为一组slab</p></li><li><p>每个slab下又有若干个page，每个page默认是1M，如果一个slab占用100M内存的话，那么这个slab下应该有100个page</p></li><li><p>每个page里面包含一组chunk，chunk是真正存放数据的地方，同一个slab里面的chunk的大小是固定的</p></li><li><p>有相同大小chunk的slab被组织在一起，称为slab_class</p></li></ol><p>MemCache内存分配的方式称为allocator（分配运算），slab的数量是有限的，几个、十几个或者几十个，这个和启动参数的配置相关。</p><p>MemCache中的value存放的地方是由value的大小决定的，value总是会被存放到与chunk大小最接近的一个slab中，比如slab[1]的chunk大小为80字节、slab[2]的chunk大小为100字节、slab[3]的chunk大小为125字节（相邻slab内的chunk基本以1.25为比例进行增长，MemCache启动时可以用-f指定这个比例），那么过来一个88字节的value，这个value将被放到2号slab中。放slab的时候，首先slab要申请内存，申请内存是以page为单位的，所以在放入第一个数据的时候，无论大小为多少，都会有1M大小的page被分配给该slab。申请到page后，slab会将这个page的内存按chunk的大小进行切分，这样就变成了一个chunk数组，最后从这个chunk数组中选择一个用于存储数据。</p><p>如果这个slab中没有chunk可以分配了怎么办，如果MemCache启动没有追加-M（禁止LRU，这种情况下内存不够会报Out Of Memory错误），那么MemCache会把这个slab中最近最少使用的chunk中的数据清理掉，然后放上最新的数据。</p><h3 id="1-4-Memcache的工作流程"><a href="#1-4-Memcache的工作流程" class="headerlink" title="1.4 Memcache的工作流程"></a>1.4 Memcache的工作流程</h3><p><img src="/2017/11/05/memcache-huan-cun-fu-wu/%E5%9B%BE%E7%89%8710.png" alt="img"></p><ol><li>检查客户端的请求数据是否在memcached中，如果有，直接把请求数据返回，不再对数据库进行任何操作，路径操作为①②③⑦。</li><li>如果请求的数据不在memcached中，就去查数据库，把从数据库中获取的数据返回给客户端，同时把数据缓存一份到memcached中（memcached客户端不负责，需要程序明确实现），路径操作为①②④⑤⑦⑥。</li><li>每次更新数据库的同时更新memcached中的数据，保证一致性。</li><li>当分配给memcached内存空间用完之后，会使用LRU（Least Recently Used，最近最少使用）策略加上到期失效策略，失效数据首先被替换，然后再替换掉最近未使用的数据。</li></ol><h3 id="1-5-Memcached特征"><a href="#1-5-Memcached特征" class="headerlink" title="1.5 Memcached特征"></a>1.5 Memcached特征</h3><p><strong>协议简单：</strong><br>它是基于文本行的协议，直接通过telnet在memcached服务器上可进行存取数据操作</p><p>注：文本行的协议：指的是信息以文本传送，一个信息单元传递完毕后要传送换行。比如对于HTTP的GET请求来说，GET /index.html HTTP/1.1是一行，接下去每个头部信息各占一行。一个空行表示整个请求结束</p><p><strong>基于libevent事件处理：</strong><br>Libevent是一套利用C开发的程序库，它将BSD系统的kqueue，Linux系统的epoll等事件处理功能封装成一个接口，与传统的select相比，提高了性能。</p><p><strong>内置的内存管理方式：</strong><br>所有数据都保存在内存中，存取数据比硬盘快，当内存满后，通过LRU算法自动删除不使用的缓存，但没有考虑数据的容灾问题，重启服务，所有数据会丢失。</p><p><strong>分布式：</strong><br>各个memcached服务器之间互不通信，各自独立存取数据，不共享任何信息。服务器并不具有分布式功能，分布式部署取决于memcache客户端。</p><h2 id="2、memcache-服务部署"><a href="#2、memcache-服务部署" class="headerlink" title="2、memcache 服务部署"></a>2、memcache 服务部署</h2><p>Memcache的安装分为两个过程：memcache服务器端的安装和memcached客户端的安装。</p><p>所谓服务器端的安装就是在服务器（一般都是linux系统）上安装Memcache实现数据的存储。</p><p>所谓客户端的安装就是指php（或者其他程序，Memcache还有其他不错的api接口提供）去使用服务器端的Memcache提供的数据，需要php添加扩展。</p><p><strong>这是讲解PHP的Memcache</strong>（centos7.2+nginx+php+memcache+mysql）</p><h3 id="2-1-环境描述"><a href="#2-1-环境描述" class="headerlink" title="2.1 环境描述"></a>2.1 环境描述</h3><table><thead><tr><th>服务</th><th>版本</th><th>IP地址</th></tr></thead><tbody><tr><td><strong>OS</strong></td><td>Centos 7.2</td><td>192.168.31.141/24</td></tr><tr><td><strong>nginx</strong></td><td>nginx-1.10.2.tar.gz</td><td>192.168.31.141/24</td></tr><tr><td><strong>php</strong></td><td>php-5.6.27.tar.gz</td><td>192.168.31.141/24</td></tr><tr><td><strong>memcached</strong></td><td>memcached-1.4.33.tar.gz</td><td>192.168.31.250/24</td></tr><tr><td><strong>mysql</strong></td><td>mysql-5.7.13.tar.gz</td><td>192.168.31.225/24</td></tr></tbody></table><h3 id="2-2-安装-nginx"><a href="#2-2-安装-nginx" class="headerlink" title="2.2 安装 nginx"></a>2.2 安装 nginx</h3><p>(在192.168.31.141主机操作)</p><p><strong>解压zlib</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@www ~]# tar zxf zlib-1.2.8.tar.gz</span><br></pre></td></tr></table></figure><p>说明：不需要编译，只需要解压就行。<br><strong>解压pcre</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@www ~]# tar zxf pcre-8.39.tar.gz</span><br></pre></td></tr></table></figure><p>说明：不需要编译，只需要解压就行。</p><p><strong>安装依赖包</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@www ~]# yum -y install gcc gcc-c++ make libtool openssl openssl-devel</span><br></pre></td></tr></table></figure><p><strong>下载nginx的源码包：</strong><a href="http://nginx.org/download" target="_blank" rel="noopener">http://nginx.org/download</a><br><strong>解压源码包：</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@www ~]# tar zxf nginx-1.10.2.tar.gz</span><br><span class="line">[root@www ~]# cd nginx-1.10.2/</span><br><span class="line">[root@www ~]# groupadd www   #添加www组</span><br><span class="line">[root@www ~]# useradd -g www www -s /sbin/nologin  #创建nginx运行账户www并加入到www组，不允许www用户直接登录系统</span><br><span class="line"></span><br><span class="line">[root@www nginx-1.10.2]# ./configure --prefix=/usr/local/nginx1.10 --with-http_dav_module --with-http_stub_status_module --with-http_addition_module --with-http_sub_module  --with-http_flv_module --with-http_mp4_module --with-pcre=/root/pcre-8.39 --with-zlib=/root/zlib-1.2.8 --with-http_ssl_module --with-http_gzip_static_module --user=www --group=www</span><br><span class="line"></span><br><span class="line">[root@www nginx-1.10.2]# make &amp;&amp; make install</span><br></pre></td></tr></table></figure><p>注：<br><strong>–with-pcre：</strong>用来设置pcre的源码目录。<br><strong>–with-zlib：</strong>用来设置zlib的源码目录。<br>因为编译nginx需要用到这两个库的源码。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@www nginx-1.10.2]# ln -s /usr/local/nginx1.10/sbin/nginx /usr/local/sbin/</span><br><span class="line">[root@www nginx-1.10.2]# nginx -t</span><br></pre></td></tr></table></figure><p><strong>启动nginx</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@www nginx-1.10.2]# nginx</span><br><span class="line">[root@www nginx-1.10.2]# netstat -anpt | grep nginx</span><br><span class="line">tcp   0   0 0.0.0.0:80     0.0.0.0:*    LISTEN      9834/nginx: master</span><br><span class="line">[root@www nginx-1.10.2]# firewall-cmd --permanent --add-port=80/tcp</span><br><span class="line">success</span><br><span class="line">[root@www nginx-1.10.2]# firewall-cmd --reload </span><br><span class="line">success</span><br></pre></td></tr></table></figure><p>启动后可以再浏览器中打开页面，会显示nginx默认页面。</p><p><img src="/2017/11/05/memcache-huan-cun-fu-wu/%E5%9B%BE%E7%89%8711.png" alt></p><h3 id="2-3-安装-php"><a href="#2-3-安装-php" class="headerlink" title="2.3 安装 php"></a>2.3 安装 php</h3><p><strong>安装libmcrypt</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@www ~]# tar zxf libmcrypt-2.5.7.tar.gz </span><br><span class="line">[root@www ~]# cd libmcrypt-2.5.7/</span><br><span class="line">[root@www libmcrypt-2.5.7]# ./configure --prefix=/usr/local/libmcrypt &amp;&amp; make &amp;&amp; make install</span><br></pre></td></tr></table></figure><p><strong>安装依赖包</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@www ~]# yum -y install libxml2-devel libcurl-devel openssl-devel bzip2-devel</span><br></pre></td></tr></table></figure><p><strong>编译安装php</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@www ~]# tar zxf php-5.6.27.tar.gz </span><br><span class="line">[root@www ~]# cd php-5.6.27/</span><br><span class="line">[root@www php-5.6.27]# ./configure --prefix=/usr/local/php5.6 --with-mysql=mysqlnd --with-pdo-mysql=mysqlnd --with-mysqli=mysqlnd --with-openssl --enable-fpm --enable-sockets --enable-sysvshm --enable-mbstring --with-freetype-dir --with-jpeg-dir --with-png-dir --with-zlib --with-libxml-dir=/usr --enable-xml --with-mhash --with-mcrypt=/usr/local/libmcrypt --with-config-file-path=/etc --with-config-file-scan-dir=/etc/php.d --with-bz2 --enable-maintainer-zts</span><br><span class="line">[root@www php-5.6.27]# make &amp;&amp; make install</span><br><span class="line">[root@www php-5.6.27]# cp php.ini-production /etc/php.ini</span><br></pre></td></tr></table></figure><p>修改/etc/php.ini文件，将short_open_tag修改为on，修改后的内容如下：<br>short_open_tag = On //支持php短标签<br><strong>创建php-fpm服务启动脚本</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@www php-5.6.27]# cp sapi/fpm/init.d.php-fpm /etc/init.d/php-fpm</span><br><span class="line">[root@www php-5.6.27]# chmod +x /etc/init.d/php-fpm </span><br><span class="line">[root@www php-5.6.27]# chkconfig --add php-fpm</span><br><span class="line">[root@www php-5.6.27]# chkconfig php-fpm on</span><br></pre></td></tr></table></figure><p><strong>提供php-fpm配置文件并编辑</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@www php-5.6.27]# cp /usr/local/php5.6/etc/php-fpm.conf.default /usr/local/php5.6/etc/php-fpm.conf</span><br><span class="line"></span><br><span class="line">[root@www php-5.6.27]# vi /usr/local/php5.6/etc/php-fpm.conf</span><br><span class="line">修改内容如下：</span><br><span class="line">pid = run/php-fpm.pid</span><br><span class="line">listen =127.0.0.1:9000</span><br><span class="line">pm.max_children = 300</span><br><span class="line">pm.start_servers = 10</span><br><span class="line">pm.min_spare_servers = 10</span><br><span class="line">pm.max_spare_servers =50</span><br></pre></td></tr></table></figure><p><strong>启动php-fpm服务</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@phpserver ~]# service  php-fpm start</span><br><span class="line">Starting php-fpm  done</span><br><span class="line">[root@www php-5.6.27]# netstat  -anpt | grep php-fpm</span><br><span class="line">tcp   0   0 127.0.0.1:9000    0.0.0.0:*     LISTEN      10937/php-fpm: mast</span><br></pre></td></tr></table></figure><h3 id="2-4-安装mysql"><a href="#2-4-安装mysql" class="headerlink" title="2.4 安装mysql"></a>2.4 安装mysql</h3><p>（在192.168.31.225主机操作）</p><p>因为centos7.2默认安装了mariadb-libs，所以先要卸载掉<br>查看是否安装mariadb</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rpm -qa | grep mariadb</span><br></pre></td></tr></table></figure><p>卸载mariadb</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rpm -e --nodeps mariadb-libs</span><br></pre></td></tr></table></figure><p><img src="/2017/11/05/memcache-huan-cun-fu-wu/%E5%9B%BE%E7%89%8712.png" alt="image-20191115101440718"></p><p><strong>安装依赖包</strong><br>注： 相关依赖包的作用<br><strong>cmake：</strong>由于从MySQL5.5版本开始弃用了常规的configure编译方法，所以需要CMake编译器，用于设置mysql的编译参数。如：安装目录、数据存放目录、字符编码、排序规则等。<br><strong>Boost：</strong> 从MySQL 5.7.5开始Boost库是必需的，mysql源码中用到了C++的Boost库，要求必须安装boost1.59.0或以上版本<br><strong>GCC：</strong>是Linux下的C语言编译工具，mysql源码编译完全由C和C++编写，要求必须安装GCC<br><strong>bison：</strong>Linux下C/C++语法分析器<br><strong>ncurses：</strong>字符终端处理库<br><strong>1）安装文件准备</strong><br>下载cmake-3.5.tar.gz <a href="http://www.cmake.org/download/" target="_blank" rel="noopener">http://www.cmake.org/download/</a><br>下载ncurses-5.9.tar.gz <a href="http://ftp.gnu.org/gnu/ncurses/" target="_blank" rel="noopener">http://ftp.gnu.org/gnu/ncurses/</a><br>下载bison-3.0.4.tar.gz <a href="http://ftp.gnu.org/gnu/bison/" target="_blank" rel="noopener">http://ftp.gnu.org/gnu/bison/</a><br>下载mysql-5.7.13.tar.gz wget <a href="http://cdn.mysql.com/Downloads/MySQL-5.7/mysql-5.7.13.tar.gz" target="_blank" rel="noopener">http://cdn.mysql.com/Downloads/MySQL-5.7/mysql-5.7.13.tar.gz</a><br>下载Boost_1_59_0.tar.gz wget <a href="http://nchc.dl.sourceforge.net/project/boost/boost/1.59.0/boost_1_59_0.tar.gz" target="_blank" rel="noopener">http://nchc.dl.sourceforge.net/project/boost/boost/1.59.0/boost_1_59_0.tar.gz</a><br><strong>2）安装CMAKE及必要的软件</strong><br><strong>安装cmake</strong></p><p><img src="/2017/11/05/memcache-huan-cun-fu-wu/%E5%9B%BE%E7%89%8713.png" alt="image-20191115102555710"></p><p><img src="/2017/11/05/memcache-huan-cun-fu-wu/%E5%9B%BE%E7%89%8714.png" alt="image-20191115102606742"></p><p>cmake –version —查看cmake版本</p><p><img src="/2017/11/05/memcache-huan-cun-fu-wu/%E5%9B%BE%E7%89%8715.png" alt="img"></p><p><strong>安装ncurses</strong></p><p><img src="/2017/11/05/memcache-huan-cun-fu-wu/%E5%9B%BE%E7%89%8716.png" alt="image-20191115102642023"></p><p><strong>安装bison</strong></p><p><img src="/2017/11/05/memcache-huan-cun-fu-wu/%E5%9B%BE%E7%89%8717.png" alt="img"></p><p><strong>安装bootst</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">tar zxf  boost_1_59_0.tar.gz </span><br><span class="line"></span><br><span class="line">mv boost_1_59_0 /usr/local/boost</span><br></pre></td></tr></table></figure><p><strong>3）创建mysql用户和用户组及目录</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># groupadd -r mysql &amp;&amp; useradd -r -g mysql -s /bin/false -M mysql   ---新建msyql组和msyql用户禁止登录shell</span><br><span class="line"></span><br><span class="line"># mkdir /usr/local/mysql        ---创建目录</span><br><span class="line"># mkdir /usr/local/mysql/data    ---数据库目录</span><br></pre></td></tr></table></figure><p><strong>编译安装mysql</strong></p><p>解压mysql源码包</p><p><img src="/2017/11/05/memcache-huan-cun-fu-wu/%E5%9B%BE%E7%89%8718.png" alt="img"></p><p>执行cmake命令进行编译前的配置</p><p><img src="/2017/11/05/memcache-huan-cun-fu-wu/%E5%9B%BE%E7%89%8719.png" alt="img"></p><p>开始编译、编译安装：</p><p><img src="/2017/11/05/memcache-huan-cun-fu-wu/%E5%9B%BE%E7%89%8720.png" alt="img"></p><p><strong>注1：</strong>配置解释：</p><blockquote><p>-DCMAKE_INSTALL_PREFIX=/usr/local/mysql[MySQL安装的根目录]-DMYSQL_DATADIR=/usr/local/mysql /data[MySQL数据库文件存放目录]</p><p>-DSYSCONFDIR=/etc [MySQL配置文件所在目录]</p><p>-DWITH_MYISAM_STORAGE_ENGINE=1 [添加MYISAM引擎支持]</p><p>-DWITH_INNOBASE_STORAGE_ENGINE=1[添加InnoDB引擎支持]</p><p>-DWITH_ARCHIVE_STORAGE_ENGINE=1 [添加ARCHIVE引擎支持]</p><p>-DMYSQL_UNIX_ADDR=/usr/local/mysql /mysql.sock[指定mysql.sock位置]</p><p>-DWITH_PARTITION_STORAGE_ENGINE=1[安装支持数据库分区]</p><p>-DEXTRA_CHARSETS=all [使MySQL支持所有的扩展字符]</p><p>-DDEFAULT_CHARSET=utf8[设置MySQL的默认字符集为utf8]-DDEFAULT_COLLATION=utf8_general_ci [设置默认字符集校对规则]</p><p>-DWITH-SYSTEMD=1 [可以使用systemd控制mysql服务]</p><p>-DWITH_BOOST=/usr/local/boost [指向boost库所在目录]</p></blockquote><p>更多参数执行[root@localhost mysql-5.7.13]# cmake . –LH<br><strong>注2：</strong>为了加快编译速度可以按下面的方式使用多核CPU编译安装</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># make -j $(grep processor /proc/cpuinfo | wc –l) &amp;&amp; make install</span><br></pre></td></tr></table></figure><p><strong>-j：</strong>参数表示根据CPU核数指定编译时的线程数，可以加快编译速度。默认为1个线程编译。<br><strong>注3：</strong>若要重新运行cmake配置，需要删除CMakeCache.txt文件</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># make clean</span><br><span class="line"># rm -f CMakeCache.txt</span><br></pre></td></tr></table></figure><p>优化Mysql的执行路径</p><p><img src="/2017/11/05/memcache-huan-cun-fu-wu/%E5%9B%BE%E7%89%8722.png" alt="image-20191115103157701"></p><p>设置权限并初始化MySQL系统授权表</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># cd/usr/local/mysql</span><br><span class="line"># chown -R mysql:mysql  .       ---更改所有者,属组，注意是mysql .</span><br><span class="line"># bin/mysqld --initialize--user=mysql --basedir=/usr/local/mysql --datadir=/usr/local/mysql/data</span><br></pre></td></tr></table></figure><p>注1：以root初始化操作时要加–user=mysql参数，生成一个随机密码（注意保存登录时用）<br>注2：MySQL 5.7.6之前的版本执行这个脚本初始化系统数据库</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># /usr/local/mysql/bin/mysql_install_db --user=mysql --basedir=/usr/local/mysql --datadir=/usr/local/mysql/data</span><br></pre></td></tr></table></figure><p>5.7.6之后版本初始系统数据库脚本（本文使用此方式初始化）</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># /usr/local/mysql/bin/mysqld --initialize-insecure--user=mysql --basedir=/usr/local/mysql --datadir=/usr/local/mysql/data</span><br></pre></td></tr></table></figure><p><img src="/2017/11/05/memcache-huan-cun-fu-wu/%E5%9B%BE%E7%89%8723.png" alt></p><p>注意：如果使用–initialize参数初始化系统<a href="http://lib.csdn.net/base/14" target="_blank" rel="noopener">数据库</a>之后，会生成root用户的一个临时密码，如上图高亮中所示。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># chown -Rmysql:mysql .       ---改所有者，注意是root .</span><br></pre></td></tr></table></figure><p><strong>创建配置文件</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># cd/usr/local/mysql/support-files     ---进入MySQL安装目录支持文件目录</span><br><span class="line"># cp my-default.cnf /etc/my.cnf    ---复制模板为新的配置文件，</span><br></pre></td></tr></table></figure><p><img src="/2017/11/05/memcache-huan-cun-fu-wu/%E5%9B%BE%E7%89%8724.png" alt="image-20191115104614416"></p><p>修改文件中配置选项，如下图所示，添加如下配置项</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># vi  /etc/my.cnf</span><br></pre></td></tr></table></figure><p><img src="/2017/11/05/memcache-huan-cun-fu-wu/%E5%9B%BE%E7%89%8725.png" alt="image-20191115104636761"></p><p><strong>配置mysql自动启动</strong></p><p><img src="/2017/11/05/memcache-huan-cun-fu-wu/%E5%9B%BE%E7%89%8726.png" alt="image-20191115104701266"></p><p><img src="/2017/11/05/memcache-huan-cun-fu-wu/%E5%9B%BE%E7%89%8727.png" alt="image-20191115104716856"></p><p>服务启动失败，查看错误日志文件</p><p><img src="/2017/11/05/memcache-huan-cun-fu-wu/%E5%9B%BE%E7%89%8728.png" alt="image-20191115104733091"></p><p>在mysqld.service，把默认的pid文件指定到了/var/run/mysqld/目录，而并没有事先建立该目录，因此要手动建立该目录并把权限赋给mysql用户。</p><p><img src="/2017/11/05/memcache-huan-cun-fu-wu/%E5%9B%BE%E7%89%8729.png" alt="image-20191115104748697"></p><p>或者修改/usr/lib/system/system/mysqld.service，修改内容如下：</p><p><img src="/2017/11/05/memcache-huan-cun-fu-wu/%E5%9B%BE%E7%89%8730.png" alt="image-20191115104836469"></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># systemctl  daemon-reload</span><br></pre></td></tr></table></figure><p>再次启动mysql服务</p><p><img src="/2017/11/05/memcache-huan-cun-fu-wu/%E5%9B%BE%E7%89%8731.png" alt="image-20191115104856457"></p><p>查看端口号</p><p><img src="/2017/11/05/memcache-huan-cun-fu-wu/%E5%9B%BE%E7%89%8732.png" alt="img"></p><p>服务启动成功</p><p><strong>访问MySQL数据库</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># mysql -u root -h 127.0.0.1 -p     ---连接mysql，输入初始化时生成的随机密码</span><br></pre></td></tr></table></figure><p><img src="/2017/11/05/memcache-huan-cun-fu-wu/%E5%9B%BE%E7%89%8733.png" alt="image-20191115104935795"></p><p>设置数据库管理员用户root的密码</p><p><img src="/2017/11/05/memcache-huan-cun-fu-wu/%E5%9B%BE%E7%89%8734.png" alt="image-20191115105001118"></p><h3 id="2-5-安装memcached服务端"><a href="#2-5-安装memcached服务端" class="headerlink" title="2.5 安装memcached服务端"></a>2.5 安装memcached服务端</h3><p>（在192.168.31.250主机操作）</p><p>memcached是基于libevent的事件处理。libevent是个程序库，它将Linux的epoll、BSD类操作系统的kqueue等事件处理功能封装成统一的接口。即使对服务器的连接数增加，也能发挥I/O的性能。 memcached使用这个libevent库，因此能在Linux、BSD、Solaris等操作系统上发挥其高性能。<br><strong>首先先安装memcached依赖库libevent</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@memcache ~]# tar zxf libevent-2.0.22-stable.tar.gz </span><br><span class="line">[root@memcache ~]# cd libevent-2.0.22-stable/</span><br><span class="line">[root@memcache libevent-2.0.22-stable]# ./configure</span><br><span class="line">[root@memcache libevent-2.0.22-stable]# make &amp;&amp; make install</span><br></pre></td></tr></table></figure><p><strong>安装memcached</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@memcache ~]# tar zxf memcached-1.4.33.tar.gz </span><br><span class="line">[root@memcache ~]# cd memcached-1.4.33/</span><br><span class="line">[root@memcache memcached-1.4.33]# ./configure --prefix=/usr/local/memcached --with-libevent=/usr/local</span><br><span class="line">[root@memcache memcached-1.4.33]# make&amp;&amp; make install</span><br></pre></td></tr></table></figure><p><strong>检测是否成功安装</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@memcache ~]# ls /usr/local/memcached/bin/memcached </span><br><span class="line">/usr/local/memcached/bin/memcached</span><br></pre></td></tr></table></figure><p>通过以上操作就很简单的把memcached服务端编译好了。这时候就可以打开服务端进行工作了。<br><strong>配置环境变量</strong><br>进入用户宿主目录，编辑.bash_profile，为系统环境变量LD_LIBRARY_PATH增加新的目录，需要增加的内容如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@memcache ~]# vi ~/.bash_profile</span><br><span class="line">MEMCACHED_HOME=/usr/local/memcached</span><br><span class="line">LD_LIBRARY_PATH=$LD_LIBRARY_PATH:$MEMCACHED_HOME/lib</span><br><span class="line">[root@memcache ~]# /usr/local/memcached/bin/memcached -d -m 2048 -l 192.168.31.250 -p 11211 -u root -c 10240 -P /usr/local/memcached/memcached.pid</span><br></pre></td></tr></table></figure><p>启动参数说明：</p><table><thead><tr><th align="left">参数</th><th>说明</th></tr></thead><tbody><tr><td align="left">-d</td><td>选项是启动一个守护进程</td></tr><tr><td align="left">-m</td><td>分配给Memcache使用的内存数量，单位是MB，默认64MB</td></tr><tr><td align="left">-l</td><td>监听的IP地址。（默认：INADDR_ANY，所有地址）</td></tr><tr><td align="left">-p</td><td>设置Memcache的TCP监听的端口，最好是1024以上的端口</td></tr><tr><td align="left">-u</td><td>运行Memcache的用户，如果当前为root的话，需要使用此参数指定用户</td></tr><tr><td align="left">-c</td><td>选项是最大运行的并发连接数，默认是1024</td></tr><tr><td align="left">-P</td><td>设置保存Memcache的pid文件</td></tr><tr><td align="left">-M</td><td>内存耗尽时返回错误，而不是删除项</td></tr><tr><td align="left">-f</td><td>块大小增长因子，默认是1.25</td></tr><tr><td align="left">-n</td><td>最小分配空间，key+value+flags默认是48</td></tr><tr><td align="left">-h</td><td>显示帮助</td></tr></tbody></table><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@memcache ~]# netstat -anpt |grep memcached</span><br><span class="line">tcp   0  0 192.168.31.250:11211    0.0.0.0:*  LISTEN      12840/memcached</span><br></pre></td></tr></table></figure><p><strong>设置防火墙</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@memcache ~]# firewall-cmd --permanent --add-port=11211/tcp</span><br><span class="line">success</span><br><span class="line">[root@memcache ~]# firewall-cmd --reload </span><br><span class="line">success</span><br></pre></td></tr></table></figure><p><strong>刷新用户环境变量</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@memcache ~]# source ~/.bash_profile</span><br></pre></td></tr></table></figure><p><strong>编写memcached服务启停脚本</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line">[root@memcache ~]# cat /etc/init.d/memcached </span><br><span class="line">#!/bin/sh</span><br><span class="line">#</span><br><span class="line"># pidfile: /usr/local/memcached/memcached.pid</span><br><span class="line"># memcached_home: /usr/local/memcached</span><br><span class="line"># chkconfig: 35 21 79</span><br><span class="line"># description: Start and stop memcached Service</span><br><span class="line"></span><br><span class="line"># Source function library</span><br><span class="line">. /etc/rc.d/init.d/functions</span><br><span class="line"></span><br><span class="line">RETVAL=0</span><br><span class="line"></span><br><span class="line">prog=&quot;memcached&quot;</span><br><span class="line">basedir=/usr/local/memcached</span><br><span class="line">cmd=$&#123;basedir&#125;/bin/memcached</span><br><span class="line">pidfile=&quot;$basedir/$&#123;prog&#125;.pid&quot;</span><br><span class="line"></span><br><span class="line">#interface to listen on (default: INADDR_ANY, all addresses)</span><br><span class="line">ipaddr=&quot;192.168.31.250&quot;</span><br><span class="line">#listen port</span><br><span class="line">port=11211</span><br><span class="line">#username for memcached</span><br><span class="line">username=&quot;root&quot;</span><br><span class="line">#max memory for memcached,default is 64M</span><br><span class="line">max_memory=2048</span><br><span class="line">#max connections for memcached</span><br><span class="line">max_simul_conn=10240</span><br><span class="line">start() &#123;</span><br><span class="line">echo -n $&quot;Starting service: $prog&quot;</span><br><span class="line">$cmd -d -m $max_memory -u $username -l $ipaddr -p $port -c $max_simul_conn -P $pidfile</span><br><span class="line">RETVAL=$?</span><br><span class="line">echo</span><br><span class="line">[ $RETVAL -eq 0 ] &amp;&amp; touch /var/lock/subsys/$prog</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">stop() &#123;</span><br><span class="line">echo -n $&quot;Stopping service: $prog  &quot;</span><br><span class="line">run_user=$(whoami)</span><br><span class="line">pidlist=$(ps -ef | grep $run_user | grep memcached | grep -v grep | awk &apos;&#123;print($2)&#125;&apos;)</span><br><span class="line">for pid in $pidlist</span><br><span class="line">do</span><br><span class="line">kill -9 $pid</span><br><span class="line">if [ $? -ne 0 ]; then</span><br><span class="line">return 1</span><br><span class="line">fi</span><br><span class="line">done</span><br><span class="line">RETVAL=$?</span><br><span class="line">echo</span><br><span class="line">[ $RETVAL -eq 0 ] &amp;&amp; rm -f /var/lock/subsys/$prog</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># See how we were called.</span><br><span class="line">case &quot;$1&quot; in</span><br><span class="line">start)</span><br><span class="line">start</span><br><span class="line">;;</span><br><span class="line">stop)</span><br><span class="line">stop</span><br><span class="line">;;</span><br><span class="line">restart)</span><br><span class="line">stop</span><br><span class="line">start</span><br><span class="line">;;</span><br><span class="line">*)</span><br><span class="line">echo &quot;Usage: $0 &#123;start|stop|restart|status&#125;&quot;</span><br><span class="line">exit 1</span><br><span class="line">esac</span><br><span class="line">exit $RETVAL</span><br></pre></td></tr></table></figure><p><strong>设置脚本可被执行</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@memcache ~]# chmod +x /etc/init.d/memcached </span><br><span class="line">[root@memcache ~]# chkconfig --add memcached</span><br><span class="line">[root@memcache ~]# chkconfig memcached on</span><br></pre></td></tr></table></figure><p>说明：<br>shell脚本中return的作用</p><ol><li>终止一个函数.</li><li>return命令允许带一个整型参数, 这个整数将作为函数的”退出状态<br>码”返回给调用这个函数的脚本, 并且这个整数也被赋值给变量$?.</li><li>命令格式：return value</li></ol><h3 id="2-6-配置nginx-conf文件"><a href="#2-6-配置nginx-conf文件" class="headerlink" title="2.6 配置nginx.conf文件"></a>2.6 配置nginx.conf文件</h3><p>（在nginx主机操作）<br><strong>配置内容如下</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br></pre></td><td class="code"><pre><span class="line">user www www;</span><br><span class="line">worker_processes  4;</span><br><span class="line">worker_cpu_affinity 0001 0010 0100 1000;</span><br><span class="line">error_log  logs/error.log;</span><br><span class="line">#error_log  logs/error.log  notice;</span><br><span class="line">#error_log  logs/error.log  info;</span><br><span class="line"></span><br><span class="line">pid        logs/nginx.pid;</span><br><span class="line"></span><br><span class="line">events &#123;</span><br><span class="line">use epoll;</span><br><span class="line">    worker_connections  65535;</span><br><span class="line">multi_accept on;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">http &#123;</span><br><span class="line">include       mime.types;</span><br><span class="line">    default_type  application/octet-stream;</span><br><span class="line"></span><br><span class="line">    #log_format  main  &apos;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &apos;</span><br><span class="line">    #                  &apos;$status $body_bytes_sent &quot;$http_referer&quot; &apos;</span><br><span class="line">    #                  &apos;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&apos;;</span><br><span class="line"></span><br><span class="line">    #access_log  logs/access.log  main;</span><br><span class="line"></span><br><span class="line">sendfile        on;</span><br><span class="line">tcp_nopush     on;</span><br><span class="line">    keepalive_timeout  65;</span><br><span class="line">tcp_nodelay on;</span><br><span class="line">client_header_buffer_size 4k;</span><br><span class="line">open_file_cache max=102400 inactive=20s;</span><br><span class="line">    open_file_cache_valid 30s;</span><br><span class="line">    open_file_cache_min_uses 1;</span><br><span class="line">    client_header_timeout 15;</span><br><span class="line">    client_body_timeout 15;</span><br><span class="line">reset_timedout_connection on;</span><br><span class="line">    send_timeout 15;</span><br><span class="line">server_tokens off;</span><br><span class="line">client_max_body_size 10m;</span><br><span class="line"></span><br><span class="line">    fastcgi_connect_timeout     600;</span><br><span class="line">    fastcgi_send_timeout 600;</span><br><span class="line">    fastcgi_read_timeout 600;</span><br><span class="line">fastcgi_buffer_size 64k;</span><br><span class="line">    fastcgi_buffers     4 64k;</span><br><span class="line">fastcgi_busy_buffers_size 128k;</span><br><span class="line">fastcgi_temp_file_write_size 128k;</span><br><span class="line">    fastcgi_temp_path /usr/local/nginx1.10/nginx_tmp;</span><br><span class="line">fastcgi_intercept_errors on;</span><br><span class="line">    fastcgi_cache_path /usr/local/nginx1.10/fastcgi_cache levels=1:2 keys_zone=cache_fastcgi:128m inactive=1d max_size=10g;</span><br><span class="line"></span><br><span class="line">gzip on;</span><br><span class="line">    gzip_min_length  2k;</span><br><span class="line">    gzip_buffers     4 32k;</span><br><span class="line">    gzip_http_version 1.1;</span><br><span class="line">    gzip_comp_level 6;</span><br><span class="line">    gzip_types  text/plain text/css text/javascript application/json application/javascript application/x-javascript application/xml;</span><br><span class="line">gzip_vary on;</span><br><span class="line">gzip_proxied any;</span><br><span class="line">server &#123;</span><br><span class="line">listen       80;</span><br><span class="line">        server_name  www.benet.com;</span><br><span class="line"></span><br><span class="line">        #charset koi8-r;</span><br><span class="line"></span><br><span class="line">        #access_log  logs/host.access.log  main;</span><br><span class="line"></span><br><span class="line">location ~* ^.+\.(jpg|gif|png|swf|flv|wma|wmv|asf|mp3|mmf|zip|rar)$ &#123;</span><br><span class="line">valid_referers none blocked  www.benet.com benet.com;</span><br><span class="line">if ($invalid_referer) &#123;</span><br><span class="line">                #return 302  http://www.benet.com/img/nolink.jpg;</span><br><span class="line">return 404;</span><br><span class="line">break;</span><br><span class="line">             &#125;</span><br><span class="line">access_log off;</span><br><span class="line">        &#125;</span><br><span class="line">location / &#123;</span><br><span class="line">root   html;</span><br><span class="line">index  index.php index.html index.htm;</span><br><span class="line">        &#125;</span><br><span class="line">location ~* \.(ico|jpe?g|gif|png|bmp|swf|flv)$ &#123;</span><br><span class="line">expires 30d;</span><br><span class="line">            #log_not_found off;</span><br><span class="line">access_log off;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">location ~* \.(js|css)$ &#123;</span><br><span class="line">expires 7d;</span><br><span class="line">log_not_found off;</span><br><span class="line">access_log off;</span><br><span class="line">        &#125;      </span><br><span class="line"></span><br><span class="line">location = /(favicon.ico|roboots.txt) &#123;</span><br><span class="line">access_log off;</span><br><span class="line">log_not_found off;</span><br><span class="line">        &#125;</span><br><span class="line">location /status &#123;</span><br><span class="line">stub_status on;</span><br><span class="line">        &#125;</span><br><span class="line">location ~ .*\.(php|php5)?$ &#123;</span><br><span class="line">root html;</span><br><span class="line">            fastcgi_pass 127.0.0.1:9000;</span><br><span class="line">            fastcgi_index index.php;</span><br><span class="line">include fastcgi.conf;</span><br><span class="line">            #fastcgi_cache cache_fastcgi;</span><br><span class="line">            fastcgi_cache_valid 200 302 1h;</span><br><span class="line">            fastcgi_cache_valid 301 1d;</span><br><span class="line">fastcgi_cache_valid any 1m;</span><br><span class="line">            fastcgi_cache_min_uses 1;</span><br><span class="line">fastcgi_cache_use_stale error timeout invalid_header http_500;</span><br><span class="line">            fastcgi_cache_key http://$host$request_uri;</span><br><span class="line">        &#125;</span><br><span class="line">        #error_page  404              /404.html;</span><br><span class="line">        # redirect server error pages to the static page /50x.html</span><br><span class="line">        #</span><br><span class="line">        error_page   500 502 503 504  /50x.html;</span><br><span class="line">location = /50x.html &#123;</span><br><span class="line">root   html;</span><br><span class="line">        &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>重启nginx服务</p><p><strong>生成一个php测试页</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@www memcache-3.0.8]# cat /usr/local/nginx1.10/html/test1.php </span><br><span class="line">&lt;?php</span><br><span class="line">phpinfo();</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure><p><strong>使用浏览器访问test1.php测试页</strong></p><p><img src="/2017/11/05/memcache-huan-cun-fu-wu/%E5%9B%BE%E7%89%8735.png" alt="img"></p><h3 id="2-7-memcache客户端"><a href="#2-7-memcache客户端" class="headerlink" title="2.7 memcache客户端"></a>2.7 memcache客户端</h3><p>（在php服务器操作）</p><p>memcache分为服务端和客户端。服务端用来存放缓存，客户端用来操作缓存。</p><p>安装php扩展库（phpmemcache）。</p><p>安装PHP Memcache扩展:</p><p><strong>方法一：可以使用php自带的pecl安装程序</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># /usr/local/php5.6/bin/pecl install memcache</span><br></pre></td></tr></table></figure><p><strong>方法二：也可以从源码安装,他是生成php的扩展库文件memcache.so</strong></p><p>安装memcache扩展库</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@www ~]# tar zxf memcache-3.0.8.tgz </span><br><span class="line">[root@www ~]# cd memcache-3.0.8/</span><br><span class="line">[root@www memcache-3.0.8]# /usr/local/php5.6/bin/phpize</span><br><span class="line">[root@wwwmemcache-3.0.8]#./configure --enable-memcache --with-php-config=/usr/local/php5.6/bin/php-config</span><br><span class="line">[root@www memcache-3.0.8]# make &amp;&amp; make install</span><br></pre></td></tr></table></figure><p><strong>安装完后会有类似这样的提示</strong></p><blockquote><p>Installing shared extensions: /usr/local/php5.6/lib/php/extensions/no-debug-zts-20131226/</p></blockquote><p>把这个记住，然后修改/etc/php.ini<br>添加一行</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">extension=/usr/local/php5.6/lib/php/extensions/no-debug-zts-20131226/memcache.so</span><br></pre></td></tr></table></figure><p><strong>重启php-fpm服务</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@www memcache-3.0.8]# service php-fpm restart</span><br><span class="line">Gracefully shutting down php-fpm .done</span><br><span class="line">Starting php-fpm  done</span><br></pre></td></tr></table></figure><p><strong>测试</strong></p><ol><li>检查php扩展是否正确安装</li></ol><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@www html]# /usr/local/php5.6/bin/php -m</span><br></pre></td></tr></table></figure><p>命令行执行php -m 查询结果中是否有memcache项</p><ol start="2"><li>创建phpinfo()页面，查询session项下面的Registered save handlers值中是否有memcache项<br>浏览器访问test1.php</li></ol><p>浏览器访问test1.php</p><p><img src="/2017/11/05/memcache-huan-cun-fu-wu/%E5%9B%BE%E7%89%8736.png" alt="img"></p><p><img src="/2017/11/05/memcache-huan-cun-fu-wu/%E5%9B%BE%E7%89%8737.png" alt="img"></p><p><strong>测试代码</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@www ~]# cat /usr/local/nginx1.10/html/test2.php </span><br><span class="line">&lt;?php</span><br><span class="line">$memcache = new Memcache;</span><br><span class="line">$memcache-&gt;connect(&apos;192.168.31.250&apos;, 11211) or die (&quot;Could not connect&quot;);</span><br><span class="line">$version = $memcache-&gt;getVersion();</span><br><span class="line">echo &quot;Server&apos;s version: &quot;.$version.&quot;&lt;br/&gt;&quot;;</span><br><span class="line">$tmp_object = new stdClass;</span><br><span class="line">$tmp_object-&gt;str_attr = &apos;test&apos;;</span><br><span class="line">$tmp_object-&gt;int_attr = 123;</span><br><span class="line">$memcache-&gt;set(&apos;key&apos;, $tmp_object, false, 10) or die (&quot;Failed to save data at the server&quot;);</span><br><span class="line">echo &quot;Store data in the cache (data will expire in 10 seconds)&lt;br/&gt;&quot;;</span><br><span class="line">$get_result = $memcache-&gt;get(&apos;key&apos;);</span><br><span class="line">echo &quot;Data from the cache:&lt;br/&gt;&quot;;</span><br><span class="line">var_dump($get_result);</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure><p>浏览器访问test2.php</p><p><img src="/2017/11/05/memcache-huan-cun-fu-wu/%E5%9B%BE%E7%89%8738.png" alt="image-20191115110047720"></p><p><strong>使用memcache实现session共享</strong><br>配置php.ini中的Session为memcache方式。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">session.save_handler = memcache</span><br><span class="line">session.save_path = &quot;tcp://192.168.31.250:11211?persistent=1&amp;weight=1&amp;timeout=1&amp;retry_interval=15&quot;</span><br></pre></td></tr></table></figure><p>注：<br><strong>session.save_handler：</strong>设置session的储存方式为memcache 。默认以文件方式存取session数据，如果想要使用自定义的处理来存取session数据，比如memcache方式则修为session.save_handler = memcache<br><strong>session.save_path：</strong>设置session储存的位置，多台memcache用逗号隔开<br>使用多个 memcached server 时用逗号”,”隔开，可以带额外的参数”persistent”、”weight”、”timeout”、”retry_interval”等等，<br>类似这样的：”tcp://host:port?persistent=1&amp;weight=2,tcp://host2:port2”。<br>memcache实现session共享也可以在某个一个应用中设置：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ini_set(&quot;session.save_handler&quot;, &quot;memcache&quot;); </span><br><span class="line">ini_set(&quot;session.save_path&quot;, &quot;tcp://192.168.0.9:11211&quot;);</span><br></pre></td></tr></table></figure><p>ini_set()只对当前php页面有效，并且不会去修改php.ini文件本身，也不会影响其他php页面。<br>测试memcache可用性<br>重启php-fpm</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@www html]# service php-fpm restart</span><br></pre></td></tr></table></figure><p>在web服务器上新建/usr/local/nginx1.10/html/memcache.php文件。内容如</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">session_start();</span><br><span class="line">if (!isset($_SESSION[&apos;session_time&apos;]))</span><br><span class="line">&#123;</span><br><span class="line"> $_SESSION[&apos;session_time&apos;] = time();</span><br><span class="line">&#125;</span><br><span class="line">echo &quot;session_time:&quot;.$_SESSION[&apos;session_time&apos;].&quot;&lt;br /&gt;&quot;;</span><br><span class="line">echo &quot;now_time:&quot;.time().&quot;&lt;br /&gt;&quot;; </span><br><span class="line">echo &quot;session_id:&quot;.session_id().&quot;&lt;br /&gt;&quot;;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure><p>访问网址<a href="http://192.168.31.141/memcache.php" target="_blank" rel="noopener">http://192.168.31.141/memcache.php</a> 可以查看session_time是否都是为memcache中的Session，同时可以在不同的服务器上修改不同的标识查看是否为不同的服务器上的。</p><p><img src="/2017/11/05/memcache-huan-cun-fu-wu/%E5%9B%BE%E7%89%8739.png" alt="image-20191115110255056"></p><p>可以直接用sessionid 去 memcached 里查询一下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@www html]# telnet 192.168.31.250 11211</span><br><span class="line">Trying 192.168.31.250...</span><br><span class="line">Connected to 192.168.31.250.</span><br><span class="line">Escape character is &apos;^]&apos;.</span><br><span class="line">get ffaqe5b1oar311n3cn5q9co5g6</span><br><span class="line">VALUE ffaqe5b1oar311n3cn5q9co5g6 0 26</span><br><span class="line">session_time|i:1479134997;</span><br></pre></td></tr></table></figure><p>得到session_time|i:1479134997;这样的结果，说明session 正常工作</p><p>默认memcache会监听11221端口，如果想清空服务器上memecache的缓存，一般使用的是：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@memcache ~]# telnet 192.168.31.250 11211</span><br><span class="line">Trying 192.168.31.250...</span><br><span class="line">Connected to 192.168.31.250.</span><br><span class="line">Escape character is &apos;^]&apos;.</span><br><span class="line">flush_all</span><br><span class="line">OK</span><br></pre></td></tr></table></figure><p>同样也可以使用</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@memcache ~]# echo &quot;flush_all&quot; | nc 192.168.31.250 11211</span><br><span class="line">OK</span><br></pre></td></tr></table></figure><p>使用flush_all 后并不是删除memcache上的key，而是置为过期</p><p>memcache安全配置</p><p>因为memcache不进行权限控制，因此需要通过iptables将memcache仅开放个web服务器。</p><h3 id="2-8-测试memcache缓存数据库数据"><a href="#2-8-测试memcache缓存数据库数据" class="headerlink" title="2.8 测试memcache缓存数据库数据"></a>2.8 测试memcache缓存数据库数据</h3><p><strong>在Mysql服务器上创建测试表</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; create database testdb1;</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; use testdb1;</span><br><span class="line">Database changed</span><br><span class="line">mysql&gt; create table test1(id int not null auto_increment,name varchar(20) default null,primary key (id)) engine=innodb auto_increment=1 default charset=utf8;</span><br><span class="line">Query OK, 0 rows affected (0.03 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; insert into test1(name) values (&apos;tom1&apos;),(&apos;tom2&apos;),(&apos;tom3&apos;),(&apos;tom4&apos;),(&apos;tom5&apos;);</span><br><span class="line">Query OK, 5 rows affected (0.01 sec)</span><br><span class="line">Records: 5  Duplicates: 0  Warnings: 0</span><br><span class="line"></span><br><span class="line">mysql&gt; select * from test1;</span><br><span class="line">+----+------+</span><br><span class="line">| id | name |</span><br><span class="line">+----+------+</span><br><span class="line">|  1 | tom1 |</span><br><span class="line">|  2 | tom2 |</span><br><span class="line">|  3 | tom3 |</span><br><span class="line">|  4 | tom4 |</span><br><span class="line">|  5 | tom5 |</span><br><span class="line">+----+------+</span><br><span class="line">5 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure><p><strong>开放mysql端口</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@mysqla ~]# firewall-cmd --permanent --add-port=3306/tcp</span><br><span class="line">success</span><br><span class="line">[root@mysqla ~]# firewall-cmd --reload </span><br><span class="line">success</span><br></pre></td></tr></table></figure><h3 id="2-9-测试"><a href="#2-9-测试" class="headerlink" title="2.9 测试"></a>2.9 测试</h3><p>下面就是测试的工作了，这里有个php脚本，用于测试memcache是否缓存数据成功<br>需要为这个脚本添加一个只读的数据库用户，命令格式</p><p>mysql&gt; grant select on testdb1.* to user@’%’ identified by ‘123456’;</p><p>Query OK, 0 rows affected, 1 warning (0.00 sec)</p><p><strong>在web服务器上创建测试脚本内容如下</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">[root@www html]# cat /usr/local/nginx1.10/html/test_db.php </span><br><span class="line">&lt;?php</span><br><span class="line">$memcachehost = &apos;192.168.31.250&apos;;</span><br><span class="line">$memcacheport = 11211;</span><br><span class="line">$memcachelife = 60;</span><br><span class="line">$memcache = new Memcache;</span><br><span class="line">$memcache-&gt;connect($memcachehost,$memcacheport) or die (&quot;Could not connect&quot;);</span><br><span class="line">$query=&quot;select * from test1 limit 10&quot;;</span><br><span class="line">$key=md5($query);</span><br><span class="line">if(!$memcache-&gt;get($key))</span><br><span class="line">&#123;</span><br><span class="line">                $conn=mysql_connect(&quot;192.168.31.225&quot;,&quot;user&quot;,&quot;123456&quot;);</span><br><span class="line">                mysql_select_db(testdb1);</span><br><span class="line">                $result=mysql_query($query);</span><br><span class="line">while ($row=mysql_fetch_assoc($result))</span><br><span class="line">                &#123;</span><br><span class="line">                        $arr[]=$row;</span><br><span class="line">                &#125;</span><br><span class="line">                $f = &apos;mysql&apos;;</span><br><span class="line">                $memcache-&gt;add($key,serialize($arr),0,30);</span><br><span class="line">                $data = $arr ;</span><br><span class="line">&#125;</span><br><span class="line">else&#123;</span><br><span class="line">        $f = &apos;memcache&apos;;</span><br><span class="line">        $data_mem=$memcache-&gt;get($key);</span><br><span class="line">        $data = unserialize($data_mem);</span><br><span class="line">&#125;</span><br><span class="line">echo $f;</span><br><span class="line">echo &quot;&lt;br&gt;&quot;;</span><br><span class="line">echo &quot;$key&quot;;</span><br><span class="line">echo &quot;&lt;br&gt;&quot;;</span><br><span class="line">//print_r($data);</span><br><span class="line">foreach($data as $a)</span><br><span class="line">&#123;</span><br><span class="line">echo &quot;number is &lt;b&gt;&lt;font color=#FF0000&gt;$a[id]&lt;/font&gt;&lt;/b&gt;&quot;;</span><br><span class="line">echo &quot;&lt;br&gt;&quot;;</span><br><span class="line">echo &quot;name is &lt;b&gt;&lt;font color=#FF0000&gt;$a[name]&lt;/font&gt;&lt;/b&gt;&quot;;</span><br><span class="line">echo &quot;&lt;br&gt;&quot;;</span><br><span class="line">&#125;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure><p><strong>访问页面测试</strong></p><p><img src="/2017/11/05/memcache-huan-cun-fu-wu/%E5%9B%BE%E7%89%8740.png" alt="image-20191115110653709"></p><p>如果出现mysql表示memcached中没有内容，需要memcached从数据库中取得<br>再刷新页面，如果有memcache标志表示这次的数据是从memcached中取得的。<br>memcached有个缓存时间默认是1分钟，过了一分钟后，memcached需要重新从数据库中取得数据</p><p><img src="/2017/11/05/memcache-huan-cun-fu-wu/%E5%9B%BE%E7%89%8741.png" alt="image-20191115110729441"></p><p><strong>查看 Memcached 缓存情况</strong></p><p>我们需要使用 telnet 命令查看</p><blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@memcache ~]# telnet 192.168.31.250 11211</span><br></pre></td></tr></table></figure><p>Trying 192.168.31.250…</p><p>Connected to 192.168.31.250.</p><p>Escape character is ‘^]’.</p><p>stats</p><p>STAT pid 1681 <strong>//Memcached 进程的ID</strong></p><p>STAT uptime 8429 <strong>//进程运行时间</strong></p><p>STAT time 1479142306 <strong>//当前时间</strong></p><p>STAT version 1.4.33 <strong>// Memcached 版本</strong></p><p>STAT libevent 2.0.22-stable</p><p>STAT pointer_size 64</p><p>STAT rusage_user 1.218430</p><p>STAT rusage_system 1.449512</p><p>STAT curr_connections 5</p><p>STAT total_connections 32</p><p>STAT connection_structures 10</p><p>STAT reserved_fds 20</p><p><strong><font color="red">STAT cmd_get 25</font></strong> <strong>//总共获取数据的次数（等于 get_hits + get_misses ）</strong></p><p>STAT cmd_set 19 <strong>//总共设置数据的次数</strong></p><p>STAT cmd_flush 4</p><p>STAT cmd_touch 0</p><p><font color="red"><strong>STAT get_hits 15</strong></font> <strong>//命中了多少次数据，也就是从 Memcached 缓存中成功获取数据的次数</strong></p><p>STAT get_misses 10 <strong>//没有命中的次数</strong></p><p>STAT get_expired 3</p><p>STAT get_flushed 1</p><p>STAT delete_misses 0</p><p>STAT delete_hits 0</p><p>STAT incr_misses 2</p><p>STAT incr_hits 2</p><p>STAT decr_misses 0</p><p>STAT decr_hits 0</p><p>STAT cas_misses 0</p><p>STAT cas_hits 0</p><p>STAT cas_badval 0</p><p>STAT touch_hits 0</p><p>STAT touch_misses 0</p><p>STAT auth_cmds 0</p><p>STAT auth_errors 0</p><p>STAT bytes_read 3370</p><p>STAT bytes_written 15710</p><p>STAT limit_maxbytes 2147483648 <strong>//总的存储大小，默认为 64M</strong></p><p>STAT accepting_conns 1</p><p>STAT listen_disabled_num 0</p><p>STAT time_in_listen_disabled_us 0</p><p>STAT threads 4</p><p>STAT conn_yields 0</p><p>STAT hash_power_level 16</p><p>STAT hash_bytes 524288</p><p>STAT hash_is_expanding 0</p><p>STAT malloc_fails 0</p><p>STAT log_worker_dropped 0</p><p>STAT log_worker_written 0</p><p>STAT log_watcher_skipped 0</p><p>STAT log_watcher_sent 0</p><p>STAT bytes 584 <strong>//当前所用存储大小</strong></p><p>STAT curr_items 3</p><p>STAT total_items 17</p><p>STAT expired_unfetched 2</p><p>STAT evicted_unfetched 0</p><p>STAT evictions 0</p><p>STAT reclaimed 4</p><p>STAT crawler_reclaimed 0</p><p>STAT crawler_items_checked 0</p><p>STAT lrutail_reflocked 0</p><p>END</p></blockquote><p><strong>命中率= get_hits/ cmd_get</strong></p></div><div><div><div style="text-align:center;color:#ccc;font-size:14px">-------------本文结束<i class="fa fa-paw"></i>感谢您的阅读-------------</div></div></div><div></div><footer class="post-footer"><div class="post-tags"><a href="/tags/%E7%BC%93%E5%AD%98/" rel="tag"><i class="fa fa-tag"></i> 缓存</a><a href="/tags/MemCache/" rel="tag"><i class="fa fa-tag"></i> MemCache</a></div><div class="post-nav"><div class="post-nav-next post-nav-item"><a href="/2017/11/02/nginx-yuan-ma-bian-yi-bu-shu/" rel="next" title="Nginx源码编译部署"><i class="fa fa-chevron-left"></i> Nginx源码编译部署</a></div><span class="post-nav-divider"></span><div class="post-nav-prev post-nav-item"><a href="/2017/11/16/mysql-shu-ju-ku-fen-biao-fen-qu/" rel="prev" title="MySQL 数据库分表分区">MySQL 数据库分表分区<i class="fa fa-chevron-right"></i></a></div></div></footer></div></article><div class="post-spread"><div class="jiathis_style"><span class="jiathis_txt">分享到：</span> <a class="jiathis_button_fav">收藏夹</a> <a class="jiathis_button_copy">复制网址</a> <a class="jiathis_button_email">邮件</a> <a class="jiathis_button_weixin">微信</a> <a class="jiathis_button_qzone">QQ空间</a> <a class="jiathis_button_tqq">腾讯微博</a> <a class="jiathis_button_douban">豆瓣</a> <a class="jiathis_button_share">一键分享</a> <a href="http://www.jiathis.com/share?uid=2140465" class="jiathis jiathis_txt jiathis_separator jtico jtico_jiathis" target="_blank">更多</a><a class="jiathis_counter_style"></a></div><script type="text/javascript">var jiathis_config={data_track_clickback:!0,summary:"",shortUrl:!1,hideMore:!1}</script><script type="text/javascript" src="http://v3.jiathis.com/code/jia.js?uid=" charset="utf-8"></script></div></div></div></div><div class="sidebar-toggle"><div class="sidebar-toggle-line-wrap"><span class="sidebar-toggle-line sidebar-toggle-line-first"></span><span class="sidebar-toggle-line sidebar-toggle-line-middle"></span><span class="sidebar-toggle-line sidebar-toggle-line-last"></span></div></div><aside id="sidebar" class="sidebar"><div id="sidebar-dimmer"></div><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">文章目录</li><li class="sidebar-nav-overview" data-target="site-overview-wrap">站点概览</li></ul><section class="site-overview-wrap sidebar-panel"><div class="site-overview"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="site-author-image" itemprop="image" src="/images/chen.png" alt="Zhongzhou Chen"><p class="site-author-name" itemprop="name">Zhongzhou Chen</p><p class="site-description motion-element" itemprop="description"></p></div><nav class="site-state motion-element"><div class="site-state-item site-state-posts"><a href="/archives/%7C%7C%20archive"><span class="site-state-item-count">320</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"><a href="/categories/index.html"><span class="site-state-item-count">84</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"><a href="/tags/index.html"><span class="site-state-item-count">182</span> <span class="site-state-item-name">标签</span></a></div></nav><div class="feed-link motion-element"><a href="/atom.xml" rel="alternate"><i class="fa fa-rss"></i> RSS</a></div></div></section><section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active"><div class="post-toc"><div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#1、MemCache-简介"><span class="nav-text">1、MemCache 简介</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-1-MemCache访问模型"><span class="nav-text">1.1 MemCache访问模型</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-2-MemCache-缓存算法"><span class="nav-text">1.2 MemCache 缓存算法</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#余数Hash"><span class="nav-text">余数Hash</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#一致性Hash算法"><span class="nav-text">一致性Hash算法</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-3-MemCache实现原理"><span class="nav-text">1.3 MemCache实现原理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-4-Memcache的工作流程"><span class="nav-text">1.4 Memcache的工作流程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-5-Memcached特征"><span class="nav-text">1.5 Memcached特征</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2、memcache-服务部署"><span class="nav-text">2、memcache 服务部署</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-1-环境描述"><span class="nav-text">2.1 环境描述</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2-安装-nginx"><span class="nav-text">2.2 安装 nginx</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-3-安装-php"><span class="nav-text">2.3 安装 php</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-4-安装mysql"><span class="nav-text">2.4 安装mysql</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-5-安装memcached服务端"><span class="nav-text">2.5 安装memcached服务端</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-6-配置nginx-conf文件"><span class="nav-text">2.6 配置nginx.conf文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-7-memcache客户端"><span class="nav-text">2.7 memcache客户端</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-8-测试memcache缓存数据库数据"><span class="nav-text">2.8 测试memcache缓存数据库数据</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-9-测试"><span class="nav-text">2.9 测试</span></a></li></ol></li></ol></div></div></section><div class="back-to-top"><i class="fa fa-arrow-up"></i> <span id="scrollpercent"><span>0</span>%</span></div></div></aside></div></main><footer id="footer" class="footer"><div class="footer-inner"><script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script><div class="copyright">&copy; <span itemprop="copyrightYear">2022</span><span class="with-love"><i class="fa fa-user"></i></span> <span class="author" itemprop="copyrightHolder">Zhongzhou Chen</span> <span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-area-chart"></i></span> <span class="post-meta-item-text">Site words total count&#58;</span> <span title="Site words total count">758.4k</span></div><span class="post-meta-divider"></span></div></footer></div><script type="text/javascript">"[object Function]"!==Object.prototype.toString.call(window.Promise)&&(window.Promise=null)</script><script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script><script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script><script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script><script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script><script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script><script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script><script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script><style>.copy-btn{display:inline-block;padding:6px 12px;font-size:13px;font-weight:700;line-height:20px;color:#333;white-space:nowrap;vertical-align:middle;cursor:pointer;background-color:#eee;background-image:linear-gradient(#fcfcfc,#eee);border:1px solid #d5d5d5;border-radius:3px;user-select:none;outline:0}.highlight-wrap .copy-btn{transition:opacity .3s ease-in-out;opacity:0;padding:2px 6px;position:absolute;right:4px;top:8px}.highlight-wrap .copy-btn:focus,.highlight-wrap:hover .copy-btn{opacity:1}.highlight-wrap{position:relative}</style><script>$(".highlight").each(function(t,e){var n=$("<div>").addClass("highlight-wrap");$(e).after(n),n.append($("<button>").addClass("copy-btn").append("复制").on("click",function(t){var e=$(this).parent().find(".code").find(".line").map(function(t,e){return $(e).text()}).toArray().join("\n"),n=document.createElement("textarea");document.body.appendChild(n),n.style.position="absolute",n.style.top="0px",n.style.left="0px",n.value=e,n.select(),n.focus();var o=document.execCommand("copy");document.body.removeChild(n),o?$(this).text("复制成功"):$(this).text("复制失败"),$(this).blur()})).on("mouseleave",function(t){var e=$(this).find(".copy-btn");setTimeout(function(){e.text("复制")},300)}).append(e)})</script><script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script><script type="text/javascript">function proceedsearch(){$("body").append('<div class="search-popup-overlay local-search-pop-overlay"></div>').css("overflow","hidden"),$(".search-popup-overlay").click(onPopupClose),$(".popup").toggle();var t=$("#local-search-input");t.attr("autocapitalize","none"),t.attr("autocorrect","off"),t.focus()}var isfetched=!1,isXml=!0,search_path="search.xml";0===search_path.length?search_path="search.xml":/json$/i.test(search_path)&&(isXml=!1);var path="/"+search_path,onPopupClose=function(t){$(".popup").hide(),$("#local-search-input").val(""),$(".search-result-list").remove(),$("#no-result").remove(),$(".local-search-pop-overlay").remove(),$("body").css("overflow","")},searchFunc=function(t,e,s){"use strict";$("body").append('<div class="search-popup-overlay local-search-pop-overlay"><div id="search-loading-icon"><i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i></div></div>').css("overflow","hidden"),$("#search-loading-icon").css("margin","20% auto 0 auto").css("text-align","center"),$.ajax({url:t,dataType:isXml?"xml":"json",async:!0,success:function(t){isfetched=!0,$(".popup").detach().appendTo(".header-inner");var o=isXml?$("entry",t).map(function(){return{title:$("title",this).text(),content:$("content",this).text(),url:$("url",this).text()}}).get():t,n=document.getElementById(e),r=document.getElementById(s);n.addEventListener("input",function(){var y=n.value.trim().toLowerCase(),T=y.split(/[\s\-]+/);1<T.length&&T.push(y);var b=[];if(0<y.length&&o.forEach(function(t){function e(t,e,o,n){for(var r=n[n.length-1],s=r.position,a=r.word,i=[],c=0;s+a.length<=o&&0!=n.length;){a===y&&c++,i.push({position:s,length:a.length});var l=s+a.length;for(n.pop();0!=n.length&&(s=(r=n[n.length-1]).position,a=r.word,s<l);)n.pop()}return h+=c,{hits:i,start:e,end:o,searchTextCount:c}}function o(o,t){var n="",r=t.start;return t.hits.forEach(function(t){n+=o.substring(r,t.position);var e=t.position+t.length;n+='<b class="search-keyword">'+o.substring(t.position,e)+"</b>",r=e}),n+=o.substring(r,t.end)}var n=!1,r=0,h=0,s=t.title.trim(),a=s.toLowerCase(),i=t.content.trim().replace(/<[^>]+>/g,""),c=i.toLowerCase(),l=decodeURIComponent(t.url),p=[],u=[];if(""!=s&&(T.forEach(function(t){function e(t,e,o){var n=t.length;if(0===n)return[];var r=0,s=[],a=[];for(o||(e=e.toLowerCase(),t=t.toLowerCase());-1<(s=e.indexOf(t,r));)a.push({position:s,word:t}),r=s+n;return a}p=p.concat(e(t,a,!1)),u=u.concat(e(t,c,!1))}),(0<p.length||0<u.length)&&(n=!0,r=p.length+u.length)),n){[p,u].forEach(function(t){t.sort(function(t,e){return e.position!==t.position?e.position-t.position:t.word.length-e.word.length})});var f=[];0!=p.length&&f.push(e(0,0,s.length,p));for(var d=[];0!=u.length;){var g=u[u.length-1],v=g.position,$=g.word,C=v-20,m=v+80;C<0&&(C=0),m<v+$.length&&(m=v+$.length),m>i.length&&(m=i.length),d.push(e(0,C,m,u))}d.sort(function(t,e){return t.searchTextCount!==e.searchTextCount?e.searchTextCount-t.searchTextCount:t.hits.length!==e.hits.length?e.hits.length-t.hits.length:t.start-e.start});var x=parseInt("1");0<=x&&(d=d.slice(0,x));var w="";w+=0!=f.length?"<li><a href='"+l+"' class='search-result-title'>"+o(s,f[0])+"</a>":"<li><a href='"+l+"' class='search-result-title'>"+s+"</a>",d.forEach(function(t){w+="<a href='"+l+'\'><p class="search-result">'+o(i,t)+"...</p></a>"}),w+="</li>",b.push({item:w,searchTextCount:h,hitCount:r,id:b.length})}}),1===T.length&&""===T[0])r.innerHTML='<div id="no-result"><i class="fa fa-search fa-5x" /></div>';else if(0===b.length)r.innerHTML='<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>';else{b.sort(function(t,e){return t.searchTextCount!==e.searchTextCount?e.searchTextCount-t.searchTextCount:t.hitCount!==e.hitCount?e.hitCount-t.hitCount:e.id-t.id});var e='<ul class="search-result-list">';b.forEach(function(t){e+=t.item}),e+="</ul>",r.innerHTML=e}}),$(".local-search-pop-overlay").remove(),$("body").css("overflow",""),proceedsearch()}})};$(".popup-trigger").click(function(t){t.stopPropagation(),!1===isfetched?searchFunc(path,"local-search-input","local-search-result"):proceedsearch()}),$(".popup-btn-close").click(onPopupClose),$(".popup").click(function(t){t.stopPropagation()}),$(document).on("keyup",function(t){27===t.which&&$(".search-popup").is(":visible")&&onPopupClose()})</script><script type="text/javascript" src="/js/src/love.js"></script><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({pluginRootPath:"live2dw/",pluginJsPath:"lib/",pluginModelPath:"assets/",tagMode:!1,debug:!1,log:!1,model:{jsonPath:"/live2dw/assets/shizuku.model.json"},display:{position:"right"},mobile:{show:!0,scale:.2},react:{opacityDefault:.7,opacityOnHover:.2,opacity:.4}})</script></body></html>