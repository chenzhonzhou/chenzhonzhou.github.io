<!DOCTYPE html><html class="theme-next gemini use-motion" lang="zh-Hans"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><script src="//cdn.bootcss.com/pace/1.0.2/pace.min.js"></script><link href="//cdn.bootcss.com/pace/1.0.2/themes/pink/pace-theme-flash.css" rel="stylesheet"><script></script><meta name="theme-color" content="#222"><style>.pace .pace-progress{background:#1e92fb;height:3px}.pace .pace-progress-inner{box-shadow:0 0 10px #1e92fb,0 0 5px #1e92fb}.pace .pace-activity{border-top-color:#1e92fb;border-left-color:#1e92fb}</style><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><meta name="google-site-verification" content="HGM141IpbHrSmnAmR6W_zE4bo9Z3f-yXLeHYT3bg1fk"><meta name="baidu-site-verification" content="code-5Ai1DA8e6T"><link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css"><link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css"><link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4"><link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222"><meta name="keywords" content="docker,"><link rel="alternate" href="/atom.xml" title="凡间的精灵" type="application/atom+xml"><meta name="description" content="一、Docker 中的网络功能介绍：默认情况下，容器可以建立到外部网络的连接，但是外部网络无法连接到容器。Docker 允许通过外部访问容器或容器互联的方式来提供网络服务外部访问容器:容器中可以运行一些网络应用，要让外部也可以访问这些应用，可以通过 -P 或 -p 参数来指定端口映射。环境：运行一个容器，提供web服务和ssh服务宿主机启用路由转发（net.ipv4.ip_forward=1）通过"><meta name="keywords" content="docker"><meta property="og:type" content="article"><meta property="og:title" content="Docker网络"><meta property="og:url" content="http:&#x2F;&#x2F;chenzhonzhou.github.io&#x2F;2017&#x2F;04&#x2F;08&#x2F;docker-wang-luo&#x2F;index.html"><meta property="og:site_name" content="凡间的精灵"><meta property="og:description" content="一、Docker 中的网络功能介绍：默认情况下，容器可以建立到外部网络的连接，但是外部网络无法连接到容器。Docker 允许通过外部访问容器或容器互联的方式来提供网络服务外部访问容器:容器中可以运行一些网络应用，要让外部也可以访问这些应用，可以通过 -P 或 -p 参数来指定端口映射。环境：运行一个容器，提供web服务和ssh服务宿主机启用路由转发（net.ipv4.ip_forward=1）通过"><meta property="og:locale" content="zh-Hans"><meta property="og:image" content="http:&#x2F;&#x2F;chenzhonzhou.github.io&#x2F;2017&#x2F;04&#x2F;08&#x2F;docker-wang-luo&#x2F;%E5%9B%BE%E7%89%871.png"><meta property="og:image" content="http:&#x2F;&#x2F;chenzhonzhou.github.io&#x2F;2017&#x2F;04&#x2F;08&#x2F;docker-wang-luo&#x2F;%E5%9B%BE%E7%89%872.png"><meta property="og:image" content="http:&#x2F;&#x2F;chenzhonzhou.github.io&#x2F;2017&#x2F;04&#x2F;08&#x2F;docker-wang-luo&#x2F;%E5%9B%BE%E7%89%873.png"><meta property="og:image" content="http:&#x2F;&#x2F;chenzhonzhou.github.io&#x2F;2017&#x2F;04&#x2F;08&#x2F;docker-wang-luo&#x2F;%E5%9B%BE%E7%89%874.png"><meta property="og:image" content="http:&#x2F;&#x2F;chenzhonzhou.github.io&#x2F;2017&#x2F;04&#x2F;08&#x2F;docker-wang-luo&#x2F;%E5%9B%BE%E7%89%875.png"><meta property="og:image" content="http:&#x2F;&#x2F;chenzhonzhou.github.io&#x2F;2017&#x2F;04&#x2F;08&#x2F;docker-wang-luo&#x2F;%E5%9B%BE%E7%89%876.png"><meta property="og:image" content="http:&#x2F;&#x2F;chenzhonzhou.github.io&#x2F;2017&#x2F;04&#x2F;08&#x2F;docker-wang-luo&#x2F;%E5%9B%BE%E7%89%877.png"><meta property="og:image" content="http:&#x2F;&#x2F;chenzhonzhou.github.io&#x2F;2017&#x2F;04&#x2F;08&#x2F;docker-wang-luo&#x2F;%E5%9B%BE%E7%89%878.png"><meta property="og:updated_time" content="2019-12-18T03:13:26.468Z"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="http:&#x2F;&#x2F;chenzhonzhou.github.io&#x2F;2017&#x2F;04&#x2F;08&#x2F;docker-wang-luo&#x2F;%E5%9B%BE%E7%89%871.png"><script type="text/javascript" id="hexo.configurations">var NexT=window.NexT||{},CONFIG={root:"/",scheme:"Gemini",version:"5.1.4",sidebar:{position:"left",display:"always",offset:12,b2t:!0,scrollpercent:!0,onmobile:!0},fancybox:!0,tabs:!0,motion:{enable:!0,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}},duoshuo:{userId:"0",author:"博主"},algolia:{applicationID:"",apiKey:"",indexName:"",hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}}}</script><link rel="canonical" href="http://chenzhonzhou.github.io/2017/04/08/docker-wang-luo/"><title>Docker网络 | 凡间的精灵</title><link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css"></head><body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans"><div class="container sidebar-position-left page-post-detail"><div class="headband"></div><header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-wrapper"><div class="site-meta"><div class="custom-logo-site-title"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">凡间的精灵</span><span class="logo-line-after"><i></i></span></a></div><p class="site-subtitle">凡尘落素一精灵</p></div><div class="site-nav-toggle"><button><span class="btn-bar"></span><span class="btn-bar"></span><span class="btn-bar"></span></button></div></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i><br>首页</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i><br>归档</a></li><li class="menu-item menu-item-categories"><a href="/categories" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i><br>分类</a></li><li class="menu-item menu-item-tags"><a href="/tags" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i><br>标签</a></li><li class="menu-item menu-item-sitemap"><a href="/sitemap.xml" rel="section"><i class="menu-item-icon fa fa-fw fa-sitemap"></i><br>站点地图</a></li><li class="menu-item menu-item-search"><a href="javascript:;" class="popup-trigger"><i class="menu-item-icon fa fa-search fa-fw"></i><br>搜索</a></li></ul><div class="site-search"><div class="popup search-popup local-search-popup"><div class="local-search-header clearfix"><span class="search-icon"><i class="fa fa-search"></i></span><span class="popup-btn-close"><i class="fa fa-times-circle"></i></span><div class="local-search-input-wrapper"><input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input"></div></div><div id="local-search-result"></div></div></div></nav></div></header><main id="main" class="main"><div class="main-inner"><div class="content-wrap"><div id="content" class="content"><div id="posts" class="posts-expand"><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><div class="post-block"><link itemprop="mainEntityOfPage" href="http://chenzhonzhou.github.io/2017/04/08/docker-wang-luo/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="name" content="Zhongzhou Chen"><meta itemprop="description" content=""><meta itemprop="image" content="/images/chen.png"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="凡间的精灵"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">Docker网络</h1><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i></span> <span class="post-meta-item-text">发表于</span> <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-04-08T12:07:11+08:00">2017-04-08</time></span> <span class="post-category"><span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-folder-o"></i></span> <span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/docker/" itemprop="url" rel="index"><span itemprop="name">docker</span></a></span></span><div class="post-wordcount"><span class="post-meta-item-icon"><i class="fa fa-file-word-o"></i></span> <span class="post-meta-item-text">字数统计&#58;</span> <span title="字数统计">5.6k</span> <span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-clock-o"></i></span> <span class="post-meta-item-text">阅读时长 &asymp;</span> <span title="阅读时长">26</span></div></div></header><div class="post-body" itemprop="articleBody"><h2 id="一、Docker-中的网络功能介绍："><a href="#一、Docker-中的网络功能介绍：" class="headerlink" title="一、Docker 中的网络功能介绍："></a>一、Docker 中的网络功能介绍：</h2><p>默认情况下，容器可以建立到外部网络的连接，但是外部网络无法连接到容器。</p><p>Docker 允许通过外部访问容器或容器互联的方式来提供网络服务</p><p>外部访问容器:</p><p>容器中可以运行一些网络应用，要让外部也可以访问这些应用，可以通过 -P 或 -p 参数来指定端口映射。</p><p><strong>环境：</strong>运行一个容器，提供web服务和ssh服务</p><p>宿主机启用路由转发（net.ipv4.ip_forward=1）</p><p>通过docker commit或dockerfile生成一个web应用的镜像，这里我通过docker dockerfile构建镜像模板</p><h3 id="1-1-创建一个sshd-dockerfile工作目录"><a href="#1-1-创建一个sshd-dockerfile工作目录" class="headerlink" title="1.1 创建一个sshd_dockerfile工作目录"></a>1.1 创建一个sshd_dockerfile工作目录</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# mkdir sshd_dockerfile</span><br><span class="line">[root@localhost ~]# cd sshd_dockerfile/</span><br><span class="line">[root@localhost sshd_dockerfile]# touch dockerfile run.sh</span><br><span class="line">[root@localhost sshd_dockerfile]# ls</span><br><span class="line">dockerfile  run.sh</span><br></pre></td></tr></table></figure><p>编辑run.sh文件</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost sshd_dockerfile]# vim run.sh</span><br><span class="line">#!/bin/bash</span><br><span class="line">/usr/sbin/sshd</span><br><span class="line">/usr/sbin/httpd -DFOREGROUND</span><br></pre></td></tr></table></figure><p>在主机上生成ssh秘钥对，并创建authorized_keys文件</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost sshd_dockerfile]# ssh-keygen -t rsa</span><br><span class="line">Generating public/private rsa key pair.</span><br><span class="line">Enter file in which to save the key (/root/.ssh/id_rsa): </span><br><span class="line">Created directory &apos;/root/.ssh&apos;.</span><br><span class="line">Enter passphrase (empty for no passphrase): </span><br><span class="line">Enter same passphrase again: </span><br><span class="line">Your identification has been saved in /root/.ssh/id_rsa.</span><br><span class="line">Your public key has been saved in /root/.ssh/id_rsa.pub.</span><br><span class="line">The key fingerprint is:</span><br><span class="line">ad:f0:0b:5c:32:c1:17:c1:1f:f7:84:59:79:34:1b:ab root@localhost.localdomain</span><br><span class="line">The key&apos;s randomart image is:</span><br><span class="line">+--[ RSA 2048]----+</span><br><span class="line">|       .o.   +.=.|</span><br><span class="line">|     .  ... + o *|</span><br><span class="line">|      o .. o o + |</span><br><span class="line">|       o ..   o  |</span><br><span class="line">|      + S .  E   |</span><br><span class="line">|     . * .       |</span><br><span class="line">|      o o        |</span><br><span class="line">|       . .       |</span><br><span class="line">|        .        |</span><br><span class="line">+-----------------+</span><br><span class="line"></span><br><span class="line">[root@localhost sshd_dockerfile]# cat ~/.ssh/id_rsa.pub &gt; /root/sshd_dockerfile/authorized_keys</span><br></pre></td></tr></table></figure><p>编写dockerfile文件</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost sshd_dockerfile]# vim dockerfile</span><br><span class="line">FROM docker.io/centos:centos6</span><br><span class="line">MAINTAINER from chen@chen.com</span><br><span class="line">RUN yum install -q -y httpd openssh-server sudo</span><br><span class="line">RUN useradd admin</span><br><span class="line">RUN echo &quot;admin:123456&quot; | chpasswd</span><br><span class="line">RUN echo &quot;admin ALL=(ALL) ALL&quot; &gt;&gt; /etc/sudoers</span><br><span class="line">RUN ssh-keygen -t dsa -f /etc/ssh/ssh_host_dsa_key</span><br><span class="line">RUN ssh-keygen -t rsa -f /etc/ssh/ssh_host_rsa_key</span><br><span class="line">RUN mkdir -p /var/run/sshd</span><br><span class="line">RUN mkdir -p /home/admin/.ssh</span><br><span class="line">RUN sed -ri &apos;s/session reguired pam_loginuid.so/#session required pam_loginuid.so/g&apos; /etc/pam.d/sshd</span><br><span class="line">RUN sed -ri &apos;s/#ServerName www.example.com:80/ServerName www.benet.com:80/g&apos; /etc/httpd/conf/httpd.conf</span><br><span class="line">ADD authorized_keys /home/admin/.ssh/authorized_keys</span><br><span class="line">ADD run.sh /run.sh</span><br><span class="line">RUN chmod 775 /run.sh</span><br><span class="line">EXPOSE 22</span><br><span class="line">EXPOSE 80</span><br><span class="line">CMD [&quot;/bin/bash”,”/run.sh&quot;]</span><br></pre></td></tr></table></figure><p>在sshd_dockerfile目录下，使用docker build命令来创建镜像</p><p><strong>注意：</strong>在最后还有一个”.”，表示使用当前目录中的dockerfile</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost sshd_dockerfile]# docker build -t centos:http .</span><br></pre></td></tr></table></figure><p>执行docker images查看新生成的镜像</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost sshd_dockerfile]# docker images </span><br><span class="line">REPOSITORY       TAG              IMAGE ID          CREATED           SIZE</span><br><span class="line">centos            http             b097bfe56b56      4 months ago        291.7 MB</span><br></pre></td></tr></table></figure><p>当使用–P(大写)标记时，Docker 会随机映射一个随机的端口到内部容器开放的网络端口。<br><strong>注：</strong>-P使用时需要指定–expose选项或dockerfile中用expose指令容器要暴露的端口，指定需要对外提供服务的端口<br>使用 docker ps 可以看到，本地主机的32770被映射到了容器的22端口，本地主机的32769被映射到了容器的80端口，本地主机的32768被映射到了容器的443 端口。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# docker run -d -P centos:http </span><br><span class="line">ba8f0989b897e26c446b8399699f802fecb71f4a7b771b6d03ac25e26eeb0e43</span><br><span class="line">[root@localhost ~]# docker ps</span><br><span class="line">CONTAINER ID        IMAGE               COMMAND               CREATED             STATUS              PORTS                                                                  NAMES</span><br><span class="line">ba8f0989b897        centos:http         &quot;/bin/bash /run.sh&quot;   3 seconds ago       Up 2 seconds        0.0.0.0:32770-&gt;22/tcp, 0.0.0.0:32769-&gt;80/tcp, 0.0.0.0:32768-&gt;443/tcp   hopeful_hypatia</span><br></pre></td></tr></table></figure><p>此时访问本机的 32770端口即可访问容器内 ssh 应用。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# ssh admin@localhost -p 32770</span><br><span class="line">The authenticity of host &apos;[localhost]:32770 ([::1]:32770)&apos; can&apos;t be established.</span><br><span class="line">RSA key fingerprint is 70:8d:e2:a3:b3:26:b0:91:9c:d0:df:7e:a8:de:8b:91.</span><br><span class="line">Are you sure you want to continue connecting (yes/no)? yes</span><br><span class="line">Warning: Permanently added &apos;[localhost]:32770&apos; (RSA) to the list of known hosts.</span><br><span class="line">admin@localhost&apos;s password:</span><br><span class="line">[admin@ba8f0989b897 ~]$</span><br></pre></td></tr></table></figure><p><strong>注：</strong>192.168.1.102是宿主主机地址。<br>查看容器运行的httpd进程</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[admin@ba8f0989b897 ~]$ pgrep httpd</span><br></pre></td></tr></table></figure><p>此时访问本机的 32769端口即可访问容器内 web 应用</p><p>此时访问本机的 32769端口即可访问容器内 web 应用</p><p><img src="/2017/04/08/docker-wang-luo/%E5%9B%BE%E7%89%871.png" alt></p><p>-p（小写）则可以指定要映射的端口，并且，在一个指定端口上只可以绑定一个容器。支持的格式有<em>ip:hostPort:containerPort | ip::containerPort | hostPort:containerPort</em></p><p>注意：</p><p>•容器有自己的内部网络和 ip 地址（使用 docker inspect 可以获取所有的变量。）</p><p>• -p 标记可以多次使用来绑定多个端口</p><h3 id="1-2-映射所有接口地址："><a href="#1-2-映射所有接口地址：" class="headerlink" title="1.2 映射所有接口地址："></a>1.2 映射所有接口地址：</h3><p>使用 hostPort:containerPort 格式，将本地的10111端口映射到容器的 22 端口，本地的801端口映射到容器的80端口可以执行</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# docker run -d -p 10122:22 -p 8080:80 centos:http</span><br><span class="line">3fe981141ab39837e9b0963c7919dc50f48c4a2feed8ce6aa2f54bb7aa0ac26e</span><br><span class="line">[root@localhost ~]# docker ps</span><br><span class="line">CONTAINER ID        IMAGE               COMMAND               CREATED             STATUS              PORTS                                                                  NAMES</span><br><span class="line">3fe981141ab3        centos:http         &quot;/bin/bash /run.sh&quot;   4 seconds ago       Up 4 seconds        443/tcp, 0.0.0.0:10122-&gt;22/tcp, 0.0.0.0:8080-&gt;80/tcp                   jolly_varahamihira</span><br></pre></td></tr></table></figure><p>测试访问：<br><strong>1.2-1)ssh测试：</strong><br>使用xshell工具：</p><p><img src="/2017/04/08/docker-wang-luo/%E5%9B%BE%E7%89%872.png" alt></p><p>测试web访问</p><p><img src="/2017/04/08/docker-wang-luo/%E5%9B%BE%E7%89%873.png" alt></p><h3 id="1-3-映射到指定地址的指定端口"><a href="#1-3-映射到指定地址的指定端口" class="headerlink" title="1.3 映射到指定地址的指定端口"></a>1.3 映射到指定地址的指定端口</h3><p>可以使用 ip:hostPort:containerPort 格式，指定映射使用一个特定地址，比如宿主机网卡配置的一个地址192.168.1.102</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# docker run -dit -p 192.168.1.102:10112:22 -p 192.168.1.102:80:80 centos:http </span><br><span class="line">3c70aba31b2a81047d72a03bef0ca162786230f532acb46e9807147271e83542</span><br><span class="line">[root@localhost ~]# docker ps</span><br><span class="line">CONTAINER ID        IMAGE               COMMAND               CREATED             STATUS              PORTS                                                            NAMES</span><br><span class="line">3c70aba31b2a        centos:http         &quot;/bin/bash /run.sh&quot;   4 seconds ago       Up 3 seconds        192.168.1.102:80-&gt;80/tcp, 443/tcp, 192.168.1.102:10112-&gt;22/tcp   sharp_ardinghelli</span><br></pre></td></tr></table></figure><h3 id="1-4-映射到指定地址的任意端口"><a href="#1-4-映射到指定地址的任意端口" class="headerlink" title="1.4 映射到指定地址的任意端口"></a>1.4 映射到指定地址的任意端口</h3><p>使用 ip::containerPort 绑定192.168.1.102的任意端口到容器的80端口，本地主机会自动分配一个口。–name为启动的容器指定一个容器名。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# docker run -d -p 192.168.1.102::80 --name webserver centos:http </span><br><span class="line">dacbbae69bc21f184611b700c370ce6c5e24bdfadadb98128b4d61ea30824e39</span><br><span class="line">[root@localhost ~]# docker ps</span><br><span class="line">CONTAINER ID        IMAGE               COMMAND               CREATED             STATUS              PORTS                                                            NAMES</span><br><span class="line">dacbbae69bc2        centos:http         &quot;/bin/bash /run.sh&quot;   2 seconds ago       Up 1 seconds        22/tcp, 443/tcp, 192.168.1.102:32768-&gt;80/tcp                     webserver</span><br></pre></td></tr></table></figure><p>注：还可以使用 udp 标记来指定 udp 端口</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># docker run -d -p 127.0.0.1:5000:5000/udp –name db4 commit:v1</span><br></pre></td></tr></table></figure><p>查看映射端口配置<br>使用 docker port 来查看当前映射的端口配置，也可以查看到绑定的地址</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# docker port webserver </span><br><span class="line">80/tcp -&gt; 192.168.1.102:32768</span><br></pre></td></tr></table></figure><h2 id="二、Docker-NAT-iptables实现"><a href="#二、Docker-NAT-iptables实现" class="headerlink" title="二、Docker NAT iptables实现"></a>二、Docker NAT iptables实现</h2><p>默认情况下，容器可以主动访问到外部网络的连接，但是外部网络无法访问到容器</p><h3 id="2-1-容器访问外部实现"><a href="#2-1-容器访问外部实现" class="headerlink" title="2.1 容器访问外部实现"></a>2.1 容器访问外部实现</h3><p>容器所有到外部网络的连接，源地址都会被 NAT 成本地系统的 IP 地址（即docker0地址）。这是使用 iptables 的源地址伪装操作实现的<br>查看主机的 NAT 规则</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# iptables -t nat -vnL</span><br><span class="line">Chain POSTROUTING (policy ACCEPT 16 packets, 1103 bytes)</span><br><span class="line"> pkts bytes target     prot opt in     out     source               destination         </span><br><span class="line">2   148 MASQUERADE  all  --  *      !docker0  172.17.0.0/16        0.0.0.0/0</span><br></pre></td></tr></table></figure><p>其中，上述规则将所有源地址在 172.17.0.0/16 网段，目标地址为其他网段（外部网络）的流量动态伪装为从系统网卡发出。MASQUERADE 跟传统 SNAT 的好处是它能动态从网卡获取地址。</p><h3 id="2-2-外部访问容器实现"><a href="#2-2-外部访问容器实现" class="headerlink" title="2.2 外部访问容器实现"></a>2.2 外部访问容器实现</h3><p>容器允许外部访问，可以在 docker run 时候通过 -p 或 -P 参数来启用，不管用那种办法，其实也是在本地的 iptable 的 nat 表中添加相应的规则<br><strong>2.2-1）使用 -P 时：</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# docker run -d -P centos:http </span><br><span class="line">2719e27d5699a721897cd24314a59e165ef378227134e972999ff86dce6b531e</span><br><span class="line">[root@localhost ~]# docker ps</span><br><span class="line">CONTAINER ID        IMAGE               COMMAND               CREATED             STATUS              PORTS                                                                  NAMES</span><br><span class="line">2719e27d5699        centos:http         &quot;/bin/bash /run.sh&quot;   8 seconds ago       Up 6 seconds        0.0.0.0:32773-&gt;22/tcp, 0.0.0.0:32772-&gt;80/tcp, 0.0.0.0:32771-&gt;443/tcp   fervent_cori</span><br><span class="line">[root@localhost ~]# iptables -t nat -nvL</span><br></pre></td></tr></table></figure><p><img src="/2017/04/08/docker-wang-luo/%E5%9B%BE%E7%89%874.png" alt></p><p><strong>2.2-2）使用 -p 80:80 时：</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# docker run -d -p 80:80 centos:http </span><br><span class="line">3a5a227015b1bc48720a8b20ba52e11553fe0787f7c48a196c60db2f6329f157</span><br><span class="line">[root@localhost ~]# docker ps -a</span><br><span class="line">CONTAINER ID        IMAGE               COMMAND               CREATED             STATUS              PORTS                                                                  NAMES</span><br><span class="line">3a5a227015b1        centos:http         &quot;/bin/bash /run.sh&quot;   20 seconds ago      Up 18 seconds       22/tcp, 443/tcp, 0.0.0.0:80-&gt;80/tcp                                    elated_booth</span><br><span class="line">[root@localhost ~]# iptables -t nat -nvL</span><br></pre></td></tr></table></figure><p><img src="/2017/04/08/docker-wang-luo/%E5%9B%BE%E7%89%875.png" alt></p><h2 id="三、docker0-网桥"><a href="#三、docker0-网桥" class="headerlink" title="三、docker0  网桥"></a>三、docker0 网桥</h2><p>Docker服务默认会创建一个 docker0 网桥（其上有一个 docker0 内部接口），它在内核层连通了其他的物理或虚拟网卡，这就将所有容器和本地主机都放到同一个物理网络。<br>Docker 默认指定了 docker0 接口的 IP 地址和子网掩码，让主机和容器之间可以通过网桥相互通信<br>由于目前 Docker 网桥是 Linux 网桥，用户可以使用 brctl show 来查看网桥和端口连接信息。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# brctl show</span><br><span class="line">bridge name	bridge id		STP enabled	interfaces</span><br><span class="line">docker0		8000.02424adc44fa	no		veth4a9cf7e</span><br><span class="line">							veth56448fa</span><br><span class="line">virbr0		8000.525400e7be5f	yes		virbr0-nic</span><br></pre></td></tr></table></figure><p><strong>注：</strong>brctl 命令在centos中可以使用yum install bridge-utils 来安装<br>每次创建一个新容器的时候，Docker 从可用的地址段中选择一个空闲的 IP 地址分配给容器的eth0端口。使用本地主机上 docker0 接口的 IP 作为所有容器的默认网关。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# docker ps -a</span><br><span class="line">CONTAINER ID        IMAGE               COMMAND               CREATED             STATUS              PORTS                                                                  NAMES</span><br><span class="line">343bb06c90c5        centos:http         &quot;/bin/bash /run.sh&quot;   18 minutes ago      Up 18 minutes       443/tcp, 0.0.0.0:10222-&gt;22/tcp, 0.0.0.0:8080-&gt;80/tcp                   kickass_morse</span><br><span class="line">954ac7210d08        centos:http         &quot;/bin/bash /run.sh&quot;   21 minutes ago      Up 21 minutes       0.0.0.0:32770-&gt;22/tcp, 0.0.0.0:32769-&gt;80/tcp, 0.0.0.0:32768-&gt;443/tcp   happy_panini</span><br><span class="line">[root@localhost ~]#ssh admin@localhost -p 32770</span><br><span class="line">admin@localhost&apos;s password: </span><br><span class="line">[admin@9316715262b8 ~]$ ip a</span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN </span><br><span class="line">    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">    inet 127.0.0.1/8 scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 ::1/128 scope host </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">14: eth0@if15: &lt;BROADCAST,MULTICAST,UP,LOWER_UP,M-DOWN&gt; mtu 1500 qdisc noqueue state UP </span><br><span class="line">    link/ether 02:42:ac:11:00:02 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">inet 172.17.0.2/16 scope global eth0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fe80::42:acff:fe11:2/64 scope link </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">[admin@9316715262b8 ~]$ ip r</span><br><span class="line">default via 172.17.0.1 dev eth0 </span><br><span class="line">172.17.0.0/16 dev eth0  proto kernel  scope link  src 172.17.0.2</span><br><span class="line">[admin@9316715262b8 ~]$</span><br></pre></td></tr></table></figure><p><strong>Docker 网络配置</strong><br><strong>Docker 四种网络模式</strong><br>docker run 创建 Docker 容器时，可以用 –net 选项指定容器的网络模式，Docker 有以下 4 种网络模式：</p><ol><li><p>host 模式，使用 –net=host 指定。</p></li><li><p>container 模式，使用 –net=container:NAMEorID 指定。</p></li><li><p>none 模式，使用 –net=none 指定。</p></li><li><p>bridge 模式，使用 –net=bridge 指定，默认设置。</p></li></ol><h3 id="3-1-host-模式"><a href="#3-1-host-模式" class="headerlink" title="3.1 host 模式"></a>3.1 host 模式</h3><p>如果启动容器的时候使用 host 模式，那么这个容器将不会获得一个独立的 Network Namespace，而是和宿主机共用一个 Network Namespace。容器将不会虚拟出自己的网卡，配置自己的 IP 等，而是使用宿主机的 IP 和端口。<br><strong>例如，</strong>我们在192.168.1.102/24 的机器上用 host 模式启动一个含有 web 应用的 Docker 容器，监听 tcp 80 端口。当我们在容器中执行任何类似 ifconfig 命令查看网络环境时，看到的都是宿主机上的信息。而外界访问容器中的应用，则直接使用192.168.1.102:80 即可，不用任何 NAT 转换，就如直接跑在宿主机中一样。但是，容器的其他方面，如文件系统、进程列表等还是和宿主机隔离的。</p><p><strong>3.1-1) 启动容器前，执行pgrep http查看宿主机httpd进程</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# pgrep httpd</span><br><span class="line">[root@localhost ~]#</span><br></pre></td></tr></table></figure><p>上面显示结果说明宿主机没有httpd进程运行</p><p><strong>3.1-2）用 host 模式启动一个含有 web 应用的 Docker 容器</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# docker images </span><br><span class="line">REPOSITORY          TAG                 IMAGE ID            CREATED             SIZE</span><br><span class="line">centos              http                b097bfe56b56        4 months ago        291.7 MB</span><br><span class="line">docker.io/centos    centos6             cf2c3ece5e41        4 months ago        194.6 MB</span><br><span class="line">[root@localhost ~]# docker run -dit --net=host centos:http </span><br><span class="line">16529da2bcc9bc508e360543373135234c74e13f877b4c1f15be3ca48a696970</span><br><span class="line">[root@localhost ~]# docker ps</span><br><span class="line">CONTAINER ID        IMAGE               COMMAND               CREATED             STATUS              PORTS               NAMES</span><br><span class="line">16529da2bcc9        centos:http         &quot;/bin/bash /run.sh&quot;   10 seconds ago      Up 9 seconds                            admiring_spence</span><br><span class="line">[root@localhost ~]# pgrep httpd</span><br><span class="line">42942</span><br><span class="line">42943</span><br><span class="line">42944</span><br><span class="line">42945</span><br><span class="line">42946</span><br><span class="line">42947</span><br><span class="line">42948</span><br><span class="line">42949</span><br><span class="line">42950</span><br><span class="line">[root@localhost ~]#</span><br></pre></td></tr></table></figure><p><strong>3.1-3）用浏览器访问宿主机地址的80端口</strong><br>注意防火墙：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# firewall-cmd  --add-port=80/tcp</span><br><span class="line">success</span><br></pre></td></tr></table></figure><p><img src="/2017/04/08/docker-wang-luo/%E5%9B%BE%E7%89%876.png" alt></p><h3 id="3-2-container-模式"><a href="#3-2-container-模式" class="headerlink" title="3.2 container 模式"></a>3.2 container 模式</h3><p>这个模式指定新创建的容器和已经存在的一个容器共享一个 NetworkNamespace，而不是和宿主机共享。新创建的容器不会创建自己的网卡，配置自己的 IP，而是和一个指定的容器共享 IP、端口范围等。同样，两个容器除了网络方面，其他的如文件系统、进程列表等还是隔离的。两个容器的进程可以通过 lo 网卡设备通信。<br><strong>3.2-1）运行一个容器：查看容器的IP</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# docker run -it docker.io/centos:centos6 </span><br><span class="line">[root@6a4de392d4bb /]# ifconfig </span><br><span class="line">eth0      Link encap:Ethernet  HWaddr 02:42:AC:11:00:02  </span><br><span class="line">inet addr:172.17.0.2  Bcast:0.0.0.0  Mask:255.255.0.0</span><br><span class="line">          inet6 addr: fe80::42:acff:fe11:2/64 Scope:Link</span><br><span class="line">          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1</span><br><span class="line">          RX packets:6 errors:0 dropped:0 overruns:0 frame:0</span><br><span class="line">          TX packets:6 errors:0 dropped:0 overruns:0 carrier:0</span><br><span class="line">          collisions:0 txqueuelen:0 </span><br><span class="line">          RX bytes:508 (508.0 b)  TX bytes:508 (508.0 b)</span><br><span class="line"></span><br><span class="line">lo        Link encap:Local Loopback  </span><br><span class="line">          inet addr:127.0.0.1  Mask:255.0.0.0</span><br><span class="line">          inet6 addr: ::1/128 Scope:Host</span><br><span class="line">          UP LOOPBACK RUNNING  MTU:65536  Metric:1</span><br><span class="line">          RX packets:0 errors:0 dropped:0 overruns:0 frame:0</span><br><span class="line">          TX packets:0 errors:0 dropped:0 overruns:0 carrier:0</span><br><span class="line">          collisions:0 txqueuelen:0 </span><br><span class="line">          RX bytes:0 (0.0 b)  TX bytes:0 (0.0 b)</span><br><span class="line"></span><br><span class="line">[root@6a4de392d4bb /]#</span><br></pre></td></tr></table></figure><p>将容器切换到后台运行:ctrl+p ctrl+q<br><strong>3.2-2）在运行一个容器使用container模式：查看新容器的地址</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# docker ps </span><br><span class="line">CONTAINER ID        IMAGE                      COMMAND               CREATED             STATUS              PORTS               NAMES</span><br><span class="line">6a4de392d4bb        docker.io/centos:centos6   &quot;/bin/bash&quot;           2 minutes ago       Up 2 minutes                            desperate_jennings</span><br><span class="line">16529da2bcc9        centos:http                &quot;/bin/bash /run.sh&quot;   6 minutes ago       Up 6 minutes                            admiring_spence</span><br><span class="line">[root@localhost ~]# docker run -it --net=container:6a4de392d4bb docker.io/centos:centos6 </span><br><span class="line">[root@6a4de392d4bb /]# ifconfig </span><br><span class="line">eth0      Link encap:Ethernet  HWaddr 02:42:AC:11:00:02  </span><br><span class="line">inet addr:172.17.0.2  Bcast:0.0.0.0  Mask:255.255.0.0</span><br><span class="line">          inet6 addr: fe80::42:acff:fe11:2/64 Scope:Link</span><br><span class="line">          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1</span><br><span class="line">          RX packets:8 errors:0 dropped:0 overruns:0 frame:0</span><br><span class="line">          TX packets:8 errors:0 dropped:0 overruns:0 carrier:0</span><br><span class="line">          collisions:0 txqueuelen:0 </span><br><span class="line">          RX bytes:648 (648.0 b)  TX bytes:648 (648.0 b)</span><br><span class="line"></span><br><span class="line">lo        Link encap:Local Loopback  </span><br><span class="line">          inet addr:127.0.0.1  Mask:255.0.0.0</span><br><span class="line">          inet6 addr: ::1/128 Scope:Host</span><br><span class="line">          UP LOOPBACK RUNNING  MTU:65536  Metric:1</span><br><span class="line">          RX packets:0 errors:0 dropped:0 overruns:0 frame:0</span><br><span class="line">          TX packets:0 errors:0 dropped:0 overruns:0 carrier:0</span><br><span class="line">          collisions:0 txqueuelen:0 </span><br><span class="line">          RX bytes:0 (0.0 b)  TX bytes:0 (0.0 b)</span><br><span class="line"></span><br><span class="line">[root@6a4de392d4bb /]#</span><br></pre></td></tr></table></figure><h3 id="3-3-one模式"><a href="#3-3-one模式" class="headerlink" title="3.3 one模式"></a>3.3 one模式</h3><p>这个模式和前两个不同。在这种模式下，Docker 容器拥有自己的 Network Namespace，但是，并不为 Docker容器进行任何网络配置。也就是说，这个 Docker 容器没有网卡、IP、路由等信息。需要我们自己为 Docker 容器添加网卡、配置 IP 等。</p><h3 id="3-4-bridge模式"><a href="#3-4-bridge模式" class="headerlink" title="3.4 bridge模式"></a>3.4 bridge模式</h3><p>当 docker 启动时，会在主机上创建一个 docker0 的虚拟网卡。他随机挑选 RFC1918 私有网络中的一段地址给 docker0 。比如 172.17.0.1/16,16 位掩码的网段可以拥有 65534 个地址可以使用，这对主机和容器来说应该足够了。<br>docker0 不是普通的网卡，他是桥接到其他网卡的虚拟网卡，容器使用它来和主机相互通信。当创建一个 docker 容器的时候，它就创建了一个对接口，当数据包发送到一个接口时，另外一个接口也可以收到相同的数据包，它们是绑在一起的一对孪生接口。这对接口在容器中那一端的的名字是 eth0 ，宿主主机端的会指定一个唯一的名字，比如 vethAQI2QT 这样的名字。<br>所有的 veth* 的接口都会桥接到 docker0 ，这样 docker 就创建了在主机和所有容器之间一个虚拟共享网</p><p><img src="/2017/04/08/docker-wang-luo/%E5%9B%BE%E7%89%877.png" alt></p><p>bridge 模式是 Docker 默认的网络设置，此模式会为每一个容器分配 Network Namespace、设置 IP 等，并将一个主机上的 Docker 容器连接到一个虚拟网桥上。当 Docker server 启动时，会在主机上创建一个名为 docker0 的虚拟网桥，此主机上启动的 Docker 容器会连接到这个虚拟网桥上。虚拟网桥的工作方式和物理交换机类似，这样主机上的所有容器就通过交换机连在了一个二层网络中。接下来就要为容器分配 IP 了，Docker 会从 RFC1918 所定义的私有 IP 网段中，选择一个和宿主机不同的IP地址和子网分配给 docker0，连接到 docker0 的容器就从这个子网中选择一个未占用的 IP 使用。如一般 Docker 会使用 172.17.0.0/16 这个网段，并将 172.17.0.1/16 分配给 docker0 网桥（在主机上使用 ifconfig 命令是可以看到 docker0 的，可以认为它是网桥的管理接口，在宿主机上作为一块虚拟网卡使用）</p><p><img src="/2017/04/08/docker-wang-luo/%E5%9B%BE%E7%89%878.png" alt></p><p><strong>Docker完成以上网络配置的过程大致是这样的：</strong></p><ol><li><p>在主机上创建一对虚拟网卡veth pair设备。veth设备总是成对出现的，它们组成了一个数据的通道，数据从一个设备进入，就会从另一个设备出来。因此，veth设备常用来连接两个网络设备。</p></li><li><p>Docker将veth pair设备的一端放在新创建的容器中，并命名为eth0。另一端放在主机中，以veth65f9这样类似的名字命名，并将这个网络设备加入到docker0网桥中，可以通过brctl show命令查看。<br>注：brctl 工具依赖 bridge-utils 软件包</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# brctl show</span><br><span class="line">bridge name	bridge id		STP enabled	interfaces</span><br><span class="line">docker0		8000.02424adc44fa	no		veth33164ac</span><br><span class="line">virbr0		8000.525400e7be5f	yes		virbr0-nic</span><br></pre></td></tr></table></figure></li><li><p>从docker0子网中分配一个IP给容器使用，并设置docker0的IP地址为容器的默认网关。<br>容器内部访问外网以及容器和主机之间的端口映射都是通过Iptables实现的，可以查看Iptables表分析。查看当前 docker0地址</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# ifconfig docker0</span><br><span class="line">docker0: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500</span><br><span class="line">        inet 172.17.0.1  netmask 255.255.0.0  broadcast 0.0.0.0</span><br><span class="line">        inet6 fe80::42:4aff:fedc:44fa  prefixlen 64  scopeid 0x20&lt;link&gt;</span><br><span class="line">        ether 02:42:4a:dc:44:fa  txqueuelen 0  (Ethernet)</span><br><span class="line">        RX packets 224  bytes 50408 (49.2 KiB)</span><br><span class="line">        RX errors 0  dropped 0  overruns 0  frame 0</span><br><span class="line">        TX packets 237  bytes 27815 (27.1 KiB)</span><br><span class="line">        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0</span><br></pre></td></tr></table></figure></li><li><p>在容器运行时，每个容器都会分配一个特定的虚拟机口并桥接到 docker0。每个容器都会配置同 docker0 ip 相同网段的专用 ip 地址，docker0 的 IP 地址被用于所有容器的默认网关。<br>4.1运行一个容器：</p></li></ol><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">    [root@localhost ~]# docker run -dit centos:http </span><br><span class="line">5da0f358fcb38f46824db4e375eccf2e7f76ff21a8dacf18b6e8e9558fb39a3b</span><br></pre></td></tr></table></figure><p>4.2查看当前运行的容器：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# docker ps</span><br><span class="line">CONTAINER ID        IMAGE                      COMMAND               CREATED             STATUS              PORTS                     NAMES</span><br><span class="line">	5da0f358fcb3        centos:http                &quot;/bin/bash /run.sh&quot;   27 seconds ago      Up 26 seconds       22/tcp, 80/tcp, 443/tcp   tender_newton</span><br><span class="line">03a5cb217adc        docker.io/centos:centos6   &quot;/bin/bash&quot;           6 minutes ago       Up 6 minutes                                  gigantic_bohr</span><br></pre></td></tr></table></figure><p>4.3通过brctl show命令查看</p><pre><code><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# brctl show</span><br><span class="line">bridge name	bridge id		STP enabled	interfaces</span><br><span class="line">docker0		8000.02424adc44fa	no		veth33164ac</span><br><span class="line">						veth080b625</span><br><span class="line">virbr0		8000.525400e7be5f	yes		virbr0-nic</span><br></pre></td></tr></table></figure> 以上, docker0 扮演着6d51c11aa19b和e6901fb7ab36这两个容器的虚拟接口 vethxx interface 桥接的角色。 4.4执行docker network inspect bridge查看桥接网络的详细信息<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# docker network inspect bridge </span><br><span class="line">[</span><br><span class="line">&#123;</span><br><span class="line">    &quot;Name&quot;: &quot;bridge&quot;,</span><br><span class="line">    &quot;Id&quot;: &quot;b4a135618b2a9aaa3319a941be6803eae00440983c1eac3159bd2976a1608116&quot;,</span><br><span class="line">    &quot;Scope&quot;: &quot;local&quot;,</span><br><span class="line">    &quot;Driver&quot;: &quot;bridge&quot;,</span><br><span class="line">    &quot;IPAM&quot;: &#123;</span><br><span class="line">        &quot;Driver&quot;: &quot;default&quot;,</span><br><span class="line">        &quot;Options&quot;: null,</span><br><span class="line">        &quot;Config&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">                &quot;Subnet&quot;: &quot;172.17.0.0/16&quot;,</span><br><span class="line">                &quot;Gateway&quot;: &quot;172.17.0.1&quot;</span><br><span class="line">            &#125;</span><br><span class="line">        ]</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;Containers&quot;: &#123;</span><br><span class="line">&quot;6a4de392d4bb132def7317d378caa259225b6f0c144cd34b82514093d12e9858&quot;: &#123;</span><br><span class="line">            &quot;Name&quot;: &quot;desperate_jennings&quot;,</span><br><span class="line">            &quot;EndpointID&quot;: &quot;184c034ba8b24768161811b969bd408256baf30f02aef2d2075830b93a1d36d1&quot;,</span><br><span class="line">            &quot;MacAddress&quot;: &quot;02:42:ac:11:00:02&quot;,</span><br><span class="line">            &quot;IPv4Address&quot;: &quot;172.17.0.2/16&quot;,</span><br><span class="line">            &quot;IPv6Address&quot;: &quot;&quot;</span><br><span class="line">        &#125;,</span><br><span class="line"> &quot;70a92ec885f3c6759bebd44141606c3417d969fb1d84604feffd58161600ec0c&quot;: &#123;</span><br><span class="line">            &quot;Name&quot;: &quot;stoic_almeida&quot;,</span><br><span class="line">            &quot;EndpointID&quot;: &quot;82dab105ae0adf413e1b53d8aecc2a734fa78f4c0773fa731d75cb667b32ce38&quot;,</span><br><span class="line">        &quot;MacAddress&quot;: &quot;02:42:ac:11:00:03&quot;,</span><br><span class="line">        &quot;IPv4Address&quot;: &quot;172.17.0.3/16&quot;,</span><br><span class="line">            &quot;IPv6Address&quot;: &quot;&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;Options&quot;: &#123;</span><br><span class="line">        &quot;com.docker.network.bridge.default_bridge&quot;: &quot;true&quot;,</span><br><span class="line">        &quot;com.docker.network.bridge.enable_icc&quot;: &quot;true&quot;,</span><br><span class="line">        &quot;com.docker.network.bridge.enable_ip_masquerade&quot;: &quot;true&quot;,</span><br><span class="line">        &quot;com.docker.network.bridge.host_binding_ipv4&quot;: &quot;0.0.0.0&quot;,</span><br><span class="line">        &quot;com.docker.network.bridge.name&quot;: &quot;docker0&quot;,</span><br><span class="line">        &quot;com.docker.network.driver.mtu&quot;: &quot;1500&quot;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">]</span><br><span class="line">[root@localhost ~]#</span><br></pre></td></tr></table></figure></code></pre><h2 id="四、自定义网桥"><a href="#四、自定义网桥" class="headerlink" title="四、自定义网桥"></a>四、自定义网桥</h2><p>除了默认的 docker0 网桥，用户也可以指定网桥来连接各个容器。在启动 Docker 服务的时候，使用 -b BRIDGE 或 –bridge=BRIDGE 来指定使用的网桥。<br>Docker 允许你管理 docker0 桥接或者通过-b选项自定义桥接网卡，需要安装bridge-utils软件包。</p><p>基本步骤如下：<br>1.确保 docker 的进程是停止的<br>2.创建自定义网桥<br>3.给网桥分配特定的 ip<br>4.以 -b 的方式指定网桥</p><p>具体操作步骤：<br><strong>4-1）如果服务已经运行，那需要先停止服务，并删除旧的网桥</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# systemctl stop docker</span><br><span class="line">[root@localhost ~]# ip link set dev docker0 down</span><br><span class="line">[root@localhost ~]# brctl delbr docker0</span><br><span class="line">[root@localhost ~]# brctl show</span><br><span class="line">bridge name	bridge id		STP enabled	interfaces</span><br><span class="line">virbr0		8000.525400e7be5f	yes		virbr0-nic</span><br></pre></td></tr></table></figure><p><strong>4-2）然后创建一个网桥 bridge0，给网桥分配特定的 ip</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# brctl addbr bridge0</span><br><span class="line">[root@localhost ~]# ip addr add 192.168.10.1/24 dev bridge0</span><br><span class="line">[root@localhost ~]# ip link set dev bridge0 up</span><br></pre></td></tr></table></figure><p><strong>4-3）查看确认网桥创建并启动</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# brctl show</span><br><span class="line">bridge name	bridge id		STP enabled	interfaces</span><br><span class="line">bridge0		8000.000000000000	no		</span><br><span class="line">virbr0		8000.525400e7be5f	yes		virbr0-nic</span><br></pre></td></tr></table></figure><p>或：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# ip addr show bridge0</span><br><span class="line">18: bridge0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UNKNOWN </span><br><span class="line">    link/ether 72:7f:26:c3:c4:93 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">inet 192.168.10.1/24 scope global bridge0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fe80::707f:26ff:fec3:c493/64 scope link </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br></pre></td></tr></table></figure><p><strong>4-4）修改/etc/sysconfig/docker文件</strong></p><p>添加前面所新建的网桥</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# vim /etc/sysconfig/docker</span><br><span class="line"># /etc/sysconfig/docker</span><br><span class="line"></span><br><span class="line"># Modify these options if you want to change the way the docker daemon runs</span><br><span class="line">OPTIONS=&apos;--selinux-enabled --log-driver=journald -b=bridge0&apos;</span><br><span class="line">DOCKER_CERT_PATH=/etc/docker</span><br></pre></td></tr></table></figure><p><strong>4-5）启动 Docker 服务</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# systemctl start docker</span><br><span class="line">[root@localhost ~]#</span><br></pre></td></tr></table></figure><p><strong>4-5）新建一个容器，可以看到它已经桥接到了 bridge0 上</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# docker run -dit docker.io/centos:centos6 </span><br><span class="line">5768f23887b14f3c184a332216e8b47adfaee437dd73ec563d0eea693e3bd977</span><br><span class="line">[root@localhost ~]# brctl show</span><br><span class="line">bridge name	bridge id		STP enabled	interfaces</span><br><span class="line">bridge0		8000.2262a64ca596	no		vethe5afab1</span><br><span class="line">virbr0		8000.525400e7be5f	yes		virbr0-nic</span><br></pre></td></tr></table></figure><p><strong>4-6）进入容器，查看容器的IP</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# docker attach 5768f23887b1</span><br><span class="line">[root@5768f23887b1 /]# ifconfig eth0</span><br><span class="line">eth0      Link encap:Ethernet  HWaddr 02:42:C0:A8:0A:02  </span><br><span class="line">inet addr:192.168.10.2  Bcast:0.0.0.0  Mask:255.255.255.0</span><br><span class="line">          inet6 addr: fe80::42:c0ff:fea8:a02/64 Scope:Link</span><br><span class="line">          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1</span><br><span class="line">          RX packets:8 errors:0 dropped:0 overruns:0 frame:0</span><br><span class="line">          TX packets:8 errors:0 dropped:0 overruns:0 carrier:0</span><br><span class="line">          collisions:0 txqueuelen:0 </span><br><span class="line">          RX bytes:648 (648.0 b)  TX bytes:648 (648.0 b)</span><br><span class="line"></span><br><span class="line">[root@5768f23887b1 /]#</span><br></pre></td></tr></table></figure><p>docker 服务启动成功并绑定容器到新的网桥，新建一个容器，你会看到它的 ip 是我们的设置的新 ip段， docker 会自动检测到它。用 brctl show 可以看到容器启动或则停止后网桥的配置变化，在容器中使用 ip a 和 ip r 来查看 ip 地址配置和路由信息。</p><p><strong>让我们回顾一些基础知识：</strong></p><p>机器需要一个网络接口来发送和接受数据包，路由表来定义如何到达哪些地址段。这里的网络接口可以不是物理接口。事实上，每个 linux 机器上的 lo 环回接口（ docker 容器中也有）就是一个完全的linux 内核虚拟接口，它直接复制发送缓存中的数据包到接收缓存中。 docker 让宿主主机和容器使用特殊的虚拟接口来通信 – 通信的 2 端叫“ peers“，他们在主机内核中连接在一起，所以能够相互通信。创建他们很简单，前面介绍过了。</p></div><div><div><div style="text-align:center;color:#ccc;font-size:14px">-------------本文结束<i class="fa fa-paw"></i>感谢您的阅读-------------</div></div></div><div></div><footer class="post-footer"><div class="post-tags"><a href="/tags/docker/" rel="tag"><i class="fa fa-tag"></i> docker</a></div><div class="post-nav"><div class="post-nav-next post-nav-item"><a href="/2017/04/05/docker-jing-xiang-rong-qi-guan-li/" rel="next" title="Docker镜像、容器管理"><i class="fa fa-chevron-left"></i> Docker镜像、容器管理</a></div><span class="post-nav-divider"></span><div class="post-nav-prev post-nav-item"><a href="/2017/04/11/linux-vim-ming-ling-tu-pu/" rel="prev" title="Linux vim 命令图谱">Linux vim 命令图谱<i class="fa fa-chevron-right"></i></a></div></div></footer></div></article><div class="post-spread"><div class="jiathis_style"><span class="jiathis_txt">分享到：</span> <a class="jiathis_button_fav">收藏夹</a> <a class="jiathis_button_copy">复制网址</a> <a class="jiathis_button_email">邮件</a> <a class="jiathis_button_weixin">微信</a> <a class="jiathis_button_qzone">QQ空间</a> <a class="jiathis_button_tqq">腾讯微博</a> <a class="jiathis_button_douban">豆瓣</a> <a class="jiathis_button_share">一键分享</a> <a href="http://www.jiathis.com/share?uid=2140465" class="jiathis jiathis_txt jiathis_separator jtico jtico_jiathis" target="_blank">更多</a><a class="jiathis_counter_style"></a></div><script type="text/javascript">var jiathis_config={data_track_clickback:!0,summary:"",shortUrl:!1,hideMore:!1}</script><script type="text/javascript" src="http://v3.jiathis.com/code/jia.js?uid=" charset="utf-8"></script></div></div></div></div><div class="sidebar-toggle"><div class="sidebar-toggle-line-wrap"><span class="sidebar-toggle-line sidebar-toggle-line-first"></span><span class="sidebar-toggle-line sidebar-toggle-line-middle"></span><span class="sidebar-toggle-line sidebar-toggle-line-last"></span></div></div><aside id="sidebar" class="sidebar"><div id="sidebar-dimmer"></div><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">文章目录</li><li class="sidebar-nav-overview" data-target="site-overview-wrap">站点概览</li></ul><section class="site-overview-wrap sidebar-panel"><div class="site-overview"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="site-author-image" itemprop="image" src="/images/chen.png" alt="Zhongzhou Chen"><p class="site-author-name" itemprop="name">Zhongzhou Chen</p><p class="site-description motion-element" itemprop="description"></p></div><nav class="site-state motion-element"><div class="site-state-item site-state-posts"><a href="/archives/%7C%7C%20archive"><span class="site-state-item-count">332</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"><a href="/categories/index.html"><span class="site-state-item-count">85</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"><a href="/tags/index.html"><span class="site-state-item-count">183</span> <span class="site-state-item-name">标签</span></a></div></nav><div class="feed-link motion-element"><a href="/atom.xml" rel="alternate"><i class="fa fa-rss"></i> RSS</a></div></div></section><section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active"><div class="post-toc"><div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#一、Docker-中的网络功能介绍："><span class="nav-text">一、Docker 中的网络功能介绍：</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-1-创建一个sshd-dockerfile工作目录"><span class="nav-text">1.1 创建一个sshd_dockerfile工作目录</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-2-映射所有接口地址："><span class="nav-text">1.2 映射所有接口地址：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-3-映射到指定地址的指定端口"><span class="nav-text">1.3 映射到指定地址的指定端口</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-4-映射到指定地址的任意端口"><span class="nav-text">1.4 映射到指定地址的任意端口</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#二、Docker-NAT-iptables实现"><span class="nav-text">二、Docker NAT iptables实现</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-1-容器访问外部实现"><span class="nav-text">2.1 容器访问外部实现</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2-外部访问容器实现"><span class="nav-text">2.2 外部访问容器实现</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#三、docker0-网桥"><span class="nav-text">三、docker0 网桥</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#3-1-host-模式"><span class="nav-text">3.1 host 模式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-2-container-模式"><span class="nav-text">3.2 container 模式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-3-one模式"><span class="nav-text">3.3 one模式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-4-bridge模式"><span class="nav-text">3.4 bridge模式</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#四、自定义网桥"><span class="nav-text">四、自定义网桥</span></a></li></ol></div></div></section><div class="back-to-top"><i class="fa fa-arrow-up"></i> <span id="scrollpercent"><span>0</span>%</span></div></div></aside></div></main><footer id="footer" class="footer"><div class="footer-inner"><script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script><div class="copyright">&copy; <span itemprop="copyrightYear">2022</span><span class="with-love"><i class="fa fa-user"></i></span> <span class="author" itemprop="copyrightHolder">Zhongzhou Chen</span> <span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-area-chart"></i></span> <span class="post-meta-item-text">Site words total count&#58;</span> <span title="Site words total count">780.6k</span></div><span class="post-meta-divider"></span></div></footer></div><script type="text/javascript">"[object Function]"!==Object.prototype.toString.call(window.Promise)&&(window.Promise=null)</script><script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script><script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script><script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script><script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script><script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script><script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script><script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script><style>.copy-btn{display:inline-block;padding:6px 12px;font-size:13px;font-weight:700;line-height:20px;color:#333;white-space:nowrap;vertical-align:middle;cursor:pointer;background-color:#eee;background-image:linear-gradient(#fcfcfc,#eee);border:1px solid #d5d5d5;border-radius:3px;user-select:none;outline:0}.highlight-wrap .copy-btn{transition:opacity .3s ease-in-out;opacity:0;padding:2px 6px;position:absolute;right:4px;top:8px}.highlight-wrap .copy-btn:focus,.highlight-wrap:hover .copy-btn{opacity:1}.highlight-wrap{position:relative}</style><script>$(".highlight").each(function(t,e){var n=$("<div>").addClass("highlight-wrap");$(e).after(n),n.append($("<button>").addClass("copy-btn").append("复制").on("click",function(t){var e=$(this).parent().find(".code").find(".line").map(function(t,e){return $(e).text()}).toArray().join("\n"),n=document.createElement("textarea");document.body.appendChild(n),n.style.position="absolute",n.style.top="0px",n.style.left="0px",n.value=e,n.select(),n.focus();var o=document.execCommand("copy");document.body.removeChild(n),o?$(this).text("复制成功"):$(this).text("复制失败"),$(this).blur()})).on("mouseleave",function(t){var e=$(this).find(".copy-btn");setTimeout(function(){e.text("复制")},300)}).append(e)})</script><script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script><script type="text/javascript">function proceedsearch(){$("body").append('<div class="search-popup-overlay local-search-pop-overlay"></div>').css("overflow","hidden"),$(".search-popup-overlay").click(onPopupClose),$(".popup").toggle();var t=$("#local-search-input");t.attr("autocapitalize","none"),t.attr("autocorrect","off"),t.focus()}var isfetched=!1,isXml=!0,search_path="search.xml";0===search_path.length?search_path="search.xml":/json$/i.test(search_path)&&(isXml=!1);var path="/"+search_path,onPopupClose=function(t){$(".popup").hide(),$("#local-search-input").val(""),$(".search-result-list").remove(),$("#no-result").remove(),$(".local-search-pop-overlay").remove(),$("body").css("overflow","")},searchFunc=function(t,e,s){"use strict";$("body").append('<div class="search-popup-overlay local-search-pop-overlay"><div id="search-loading-icon"><i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i></div></div>').css("overflow","hidden"),$("#search-loading-icon").css("margin","20% auto 0 auto").css("text-align","center"),$.ajax({url:t,dataType:isXml?"xml":"json",async:!0,success:function(t){isfetched=!0,$(".popup").detach().appendTo(".header-inner");var o=isXml?$("entry",t).map(function(){return{title:$("title",this).text(),content:$("content",this).text(),url:$("url",this).text()}}).get():t,n=document.getElementById(e),r=document.getElementById(s);n.addEventListener("input",function(){var y=n.value.trim().toLowerCase(),T=y.split(/[\s\-]+/);1<T.length&&T.push(y);var b=[];if(0<y.length&&o.forEach(function(t){function e(t,e,o,n){for(var r=n[n.length-1],s=r.position,a=r.word,i=[],c=0;s+a.length<=o&&0!=n.length;){a===y&&c++,i.push({position:s,length:a.length});var l=s+a.length;for(n.pop();0!=n.length&&(s=(r=n[n.length-1]).position,a=r.word,s<l);)n.pop()}return h+=c,{hits:i,start:e,end:o,searchTextCount:c}}function o(o,t){var n="",r=t.start;return t.hits.forEach(function(t){n+=o.substring(r,t.position);var e=t.position+t.length;n+='<b class="search-keyword">'+o.substring(t.position,e)+"</b>",r=e}),n+=o.substring(r,t.end)}var n=!1,r=0,h=0,s=t.title.trim(),a=s.toLowerCase(),i=t.content.trim().replace(/<[^>]+>/g,""),c=i.toLowerCase(),l=decodeURIComponent(t.url),p=[],u=[];if(""!=s&&(T.forEach(function(t){function e(t,e,o){var n=t.length;if(0===n)return[];var r=0,s=[],a=[];for(o||(e=e.toLowerCase(),t=t.toLowerCase());-1<(s=e.indexOf(t,r));)a.push({position:s,word:t}),r=s+n;return a}p=p.concat(e(t,a,!1)),u=u.concat(e(t,c,!1))}),(0<p.length||0<u.length)&&(n=!0,r=p.length+u.length)),n){[p,u].forEach(function(t){t.sort(function(t,e){return e.position!==t.position?e.position-t.position:t.word.length-e.word.length})});var f=[];0!=p.length&&f.push(e(0,0,s.length,p));for(var d=[];0!=u.length;){var g=u[u.length-1],v=g.position,$=g.word,C=v-20,m=v+80;C<0&&(C=0),m<v+$.length&&(m=v+$.length),m>i.length&&(m=i.length),d.push(e(0,C,m,u))}d.sort(function(t,e){return t.searchTextCount!==e.searchTextCount?e.searchTextCount-t.searchTextCount:t.hits.length!==e.hits.length?e.hits.length-t.hits.length:t.start-e.start});var x=parseInt("1");0<=x&&(d=d.slice(0,x));var w="";w+=0!=f.length?"<li><a href='"+l+"' class='search-result-title'>"+o(s,f[0])+"</a>":"<li><a href='"+l+"' class='search-result-title'>"+s+"</a>",d.forEach(function(t){w+="<a href='"+l+'\'><p class="search-result">'+o(i,t)+"...</p></a>"}),w+="</li>",b.push({item:w,searchTextCount:h,hitCount:r,id:b.length})}}),1===T.length&&""===T[0])r.innerHTML='<div id="no-result"><i class="fa fa-search fa-5x" /></div>';else if(0===b.length)r.innerHTML='<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>';else{b.sort(function(t,e){return t.searchTextCount!==e.searchTextCount?e.searchTextCount-t.searchTextCount:t.hitCount!==e.hitCount?e.hitCount-t.hitCount:e.id-t.id});var e='<ul class="search-result-list">';b.forEach(function(t){e+=t.item}),e+="</ul>",r.innerHTML=e}}),$(".local-search-pop-overlay").remove(),$("body").css("overflow",""),proceedsearch()}})};$(".popup-trigger").click(function(t){t.stopPropagation(),!1===isfetched?searchFunc(path,"local-search-input","local-search-result"):proceedsearch()}),$(".popup-btn-close").click(onPopupClose),$(".popup").click(function(t){t.stopPropagation()}),$(document).on("keyup",function(t){27===t.which&&$(".search-popup").is(":visible")&&onPopupClose()})</script><script type="text/javascript" src="/js/src/love.js"></script><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({pluginRootPath:"live2dw/",pluginJsPath:"lib/",pluginModelPath:"assets/",tagMode:!1,debug:!1,log:!1,model:{jsonPath:"/live2dw/assets/shizuku.model.json"},display:{position:"right"},mobile:{show:!0,scale:.2},react:{opacityDefault:.7,opacityOnHover:.2,opacity:.4}})</script></body></html>