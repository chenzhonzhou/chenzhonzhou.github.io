<!DOCTYPE html><html class="theme-next gemini use-motion" lang="zh-Hans"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><script src="//cdn.bootcss.com/pace/1.0.2/pace.min.js"></script><link href="//cdn.bootcss.com/pace/1.0.2/themes/pink/pace-theme-flash.css" rel="stylesheet"><script></script><meta name="theme-color" content="#222"><style>.pace .pace-progress{background:#1e92fb;height:3px}.pace .pace-progress-inner{box-shadow:0 0 10px #1e92fb,0 0 5px #1e92fb}.pace .pace-activity{border-top-color:#1e92fb;border-left-color:#1e92fb}</style><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><meta name="google-site-verification" content="HGM141IpbHrSmnAmR6W_zE4bo9Z3f-yXLeHYT3bg1fk"><meta name="baidu-site-verification" content="code-5Ai1DA8e6T"><link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css"><link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css"><link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4"><link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222"><meta name="keywords" content="Nginx,缓存,MySQL,Tomcat,Redis,"><link rel="alternate" href="/atom.xml" title="凡间的精灵" type="application/atom+xml"><meta name="description" content="1、Redis 简介Redis是一个key-value存储系统。和Memcached类似，它支持存储的value类型相对更多，包括string(字符串)、list(链表)、set(集合)、zset(sorted set –有序集合)和hash（哈希类型）。与memcached一样，为了保证效率，数据都是缓存在内存中。区别的是redis会周期性的把更新的数据写入磁盘或者把修改操作写入追加的记录文件，"><meta name="keywords" content="Nginx,缓存,MySQL,Tomcat,Redis"><meta property="og:type" content="article"><meta property="og:title" content="Redis 缓存服务(nginx+tomcat+redis+mysql实现session会话共享)"><meta property="og:url" content="http:&#x2F;&#x2F;chenzhonzhou.github.io&#x2F;2017&#x2F;08&#x2F;11&#x2F;redis-huan-cun-fu-wu-nginx-tomcat-redis-mysql-shi-xian-session-hui-hua-gong-xiang&#x2F;index.html"><meta property="og:site_name" content="凡间的精灵"><meta property="og:description" content="1、Redis 简介Redis是一个key-value存储系统。和Memcached类似，它支持存储的value类型相对更多，包括string(字符串)、list(链表)、set(集合)、zset(sorted set –有序集合)和hash（哈希类型）。与memcached一样，为了保证效率，数据都是缓存在内存中。区别的是redis会周期性的把更新的数据写入磁盘或者把修改操作写入追加的记录文件，"><meta property="og:locale" content="zh-Hans"><meta property="og:image" content="http:&#x2F;&#x2F;chenzhonzhou.github.io&#x2F;2017&#x2F;08&#x2F;11&#x2F;redis-huan-cun-fu-wu-nginx-tomcat-redis-mysql-shi-xian-session-hui-hua-gong-xiang&#x2F;%E5%9B%BE%E7%89%871.png"><meta property="og:image" content="http:&#x2F;&#x2F;chenzhonzhou.github.io&#x2F;2017&#x2F;08&#x2F;11&#x2F;redis-huan-cun-fu-wu-nginx-tomcat-redis-mysql-shi-xian-session-hui-hua-gong-xiang&#x2F;%E5%9B%BE%E7%89%872.png"><meta property="og:image" content="http:&#x2F;&#x2F;chenzhonzhou.github.io&#x2F;2017&#x2F;08&#x2F;11&#x2F;redis-huan-cun-fu-wu-nginx-tomcat-redis-mysql-shi-xian-session-hui-hua-gong-xiang&#x2F;%E5%9B%BE%E7%89%873.png"><meta property="og:image" content="http:&#x2F;&#x2F;chenzhonzhou.github.io&#x2F;2017&#x2F;08&#x2F;11&#x2F;redis-huan-cun-fu-wu-nginx-tomcat-redis-mysql-shi-xian-session-hui-hua-gong-xiang&#x2F;%E5%9B%BE%E7%89%874.png"><meta property="og:image" content="http:&#x2F;&#x2F;chenzhonzhou.github.io&#x2F;2017&#x2F;08&#x2F;11&#x2F;redis-huan-cun-fu-wu-nginx-tomcat-redis-mysql-shi-xian-session-hui-hua-gong-xiang&#x2F;%E5%9B%BE%E7%89%875.png"><meta property="og:image" content="http:&#x2F;&#x2F;chenzhonzhou.github.io&#x2F;2017&#x2F;08&#x2F;11&#x2F;redis-huan-cun-fu-wu-nginx-tomcat-redis-mysql-shi-xian-session-hui-hua-gong-xiang&#x2F;%E5%9B%BE%E7%89%876.png"><meta property="og:image" content="http:&#x2F;&#x2F;chenzhonzhou.github.io&#x2F;2017&#x2F;08&#x2F;11&#x2F;redis-huan-cun-fu-wu-nginx-tomcat-redis-mysql-shi-xian-session-hui-hua-gong-xiang&#x2F;%E5%9B%BE%E7%89%877.png"><meta property="og:image" content="http:&#x2F;&#x2F;chenzhonzhou.github.io&#x2F;2017&#x2F;08&#x2F;11&#x2F;redis-huan-cun-fu-wu-nginx-tomcat-redis-mysql-shi-xian-session-hui-hua-gong-xiang&#x2F;%E5%9B%BE%E7%89%878.png"><meta property="og:image" content="http:&#x2F;&#x2F;chenzhonzhou.github.io&#x2F;2017&#x2F;08&#x2F;11&#x2F;redis-huan-cun-fu-wu-nginx-tomcat-redis-mysql-shi-xian-session-hui-hua-gong-xiang&#x2F;%E5%9B%BE%E7%89%879.png"><meta property="og:image" content="http:&#x2F;&#x2F;chenzhonzhou.github.io&#x2F;2017&#x2F;08&#x2F;11&#x2F;redis-huan-cun-fu-wu-nginx-tomcat-redis-mysql-shi-xian-session-hui-hua-gong-xiang&#x2F;%E5%9B%BE%E7%89%8710.png"><meta property="og:image" content="http:&#x2F;&#x2F;chenzhonzhou.github.io&#x2F;2017&#x2F;08&#x2F;11&#x2F;redis-huan-cun-fu-wu-nginx-tomcat-redis-mysql-shi-xian-session-hui-hua-gong-xiang&#x2F;%E5%9B%BE%E7%89%8711.png"><meta property="og:image" content="http:&#x2F;&#x2F;chenzhonzhou.github.io&#x2F;2017&#x2F;08&#x2F;11&#x2F;redis-huan-cun-fu-wu-nginx-tomcat-redis-mysql-shi-xian-session-hui-hua-gong-xiang&#x2F;%E5%9B%BE%E7%89%8712.png"><meta property="og:updated_time" content="2019-11-18T07:26:46.250Z"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="http:&#x2F;&#x2F;chenzhonzhou.github.io&#x2F;2017&#x2F;08&#x2F;11&#x2F;redis-huan-cun-fu-wu-nginx-tomcat-redis-mysql-shi-xian-session-hui-hua-gong-xiang&#x2F;%E5%9B%BE%E7%89%871.png"><script type="text/javascript" id="hexo.configurations">var NexT=window.NexT||{},CONFIG={root:"/",scheme:"Gemini",version:"5.1.4",sidebar:{position:"left",display:"always",offset:12,b2t:!0,scrollpercent:!0,onmobile:!0},fancybox:!0,tabs:!0,motion:{enable:!0,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}},duoshuo:{userId:"0",author:"博主"},algolia:{applicationID:"",apiKey:"",indexName:"",hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}}}</script><link rel="canonical" href="http://chenzhonzhou.github.io/2017/08/11/redis-huan-cun-fu-wu-nginx-tomcat-redis-mysql-shi-xian-session-hui-hua-gong-xiang/"><title>Redis 缓存服务(nginx+tomcat+redis+mysql实现session会话共享) | 凡间的精灵</title><link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css"></head><body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans"><div class="container sidebar-position-left page-post-detail"><div class="headband"></div><header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-wrapper"><div class="site-meta"><div class="custom-logo-site-title"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">凡间的精灵</span><span class="logo-line-after"><i></i></span></a></div><p class="site-subtitle">凡尘落素一精灵</p></div><div class="site-nav-toggle"><button><span class="btn-bar"></span><span class="btn-bar"></span><span class="btn-bar"></span></button></div></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i><br>首页</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i><br>归档</a></li><li class="menu-item menu-item-categories"><a href="/categories" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i><br>分类</a></li><li class="menu-item menu-item-tags"><a href="/tags" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i><br>标签</a></li><li class="menu-item menu-item-sitemap"><a href="/sitemap.xml" rel="section"><i class="menu-item-icon fa fa-fw fa-sitemap"></i><br>站点地图</a></li><li class="menu-item menu-item-search"><a href="javascript:;" class="popup-trigger"><i class="menu-item-icon fa fa-search fa-fw"></i><br>搜索</a></li></ul><div class="site-search"><div class="popup search-popup local-search-popup"><div class="local-search-header clearfix"><span class="search-icon"><i class="fa fa-search"></i></span><span class="popup-btn-close"><i class="fa fa-times-circle"></i></span><div class="local-search-input-wrapper"><input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input"></div></div><div id="local-search-result"></div></div></div></nav></div></header><main id="main" class="main"><div class="main-inner"><div class="content-wrap"><div id="content" class="content"><div id="posts" class="posts-expand"><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><div class="post-block"><link itemprop="mainEntityOfPage" href="http://chenzhonzhou.github.io/2017/08/11/redis-huan-cun-fu-wu-nginx-tomcat-redis-mysql-shi-xian-session-hui-hua-gong-xiang/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="name" content="Zhongzhou Chen"><meta itemprop="description" content=""><meta itemprop="image" content="/images/chen.png"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="凡间的精灵"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">Redis 缓存服务(nginx+tomcat+redis+mysql实现session会话共享)</h1><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i></span> <span class="post-meta-item-text">发表于</span> <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-08-11T16:11:59+08:00">2017-08-11</time></span> <span class="post-category"><span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-folder-o"></i></span> <span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/%E7%BC%93%E5%AD%98/" itemprop="url" rel="index"><span itemprop="name">缓存</span></a></span> ， <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/%E7%BC%93%E5%AD%98/Redis/" itemprop="url" rel="index"><span itemprop="name">Redis</span></a></span></span><div class="post-wordcount"><span class="post-meta-item-icon"><i class="fa fa-file-word-o"></i></span> <span class="post-meta-item-text">字数统计&#58;</span> <span title="字数统计">6.4k</span> <span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-clock-o"></i></span> <span class="post-meta-item-text">阅读时长 &asymp;</span> <span title="阅读时长">31</span></div></div></header><div class="post-body" itemprop="articleBody"><h2 id="1、Redis-简介"><a href="#1、Redis-简介" class="headerlink" title="1、Redis 简介"></a>1、Redis 简介</h2><p><strong>Redis</strong>是一个<strong>key-value</strong>存储系统。和<strong>Memcached</strong>类似，它支持存储的<strong>value</strong>类型相对更多，包括<strong>string</strong>(<strong>字符串</strong>)、<strong>list(链表)</strong>、<strong>set(集合)</strong>、<strong>zset(sorted set –有序集合)</strong>和<strong>hash（哈希类型）</strong>。与<strong>memcached</strong>一样，为了保证效率，数据都是缓存在内存中。区别的是<strong>redis</strong>会周期性的把更新的数据写入磁盘或者把修改操作写入追加的记录文件，并且在此基础上实现<strong>master-slave</strong>(主从)同步。</p><p><strong>Redis</strong>是一个高性能的<strong>key-value</strong>数据库。<strong>redis</strong>的出现，很大程度补偿了<strong>memcached</strong>这类<strong>key/value</strong>存储的不足，在部分场合可以对关系数据库起到很好的补充作用。它提供了<strong>Java</strong>，<strong>C/C++</strong>，<strong>C#</strong>，<strong>PHP</strong>，<strong>JavaScript</strong>，<strong>Perl</strong>，<strong>Object-C</strong>，<strong>Python</strong>，<strong>Ruby</strong>等客户端，使用很方便。</p><p><strong>如果简单地比较Redis与Memcached的区别，基本上有以下3点：</strong></p><ol><li>Redis不仅仅支持简单的k/v类型的数据，同时还提供list，set，zset，hash等数据结构的存储。</li><li>Redis支持数据的备份，即master-slave模式的数据备份。</li><li>Redis支持数据的持久化，可以将内存中的数据保持在磁盘中，重启的时候可以再次加载进行使用。</li></ol><p>在Redis中，并不是所有的数据都一直存储在内存中的。这是和Memcached相比一个最大的区别。Redis只会缓存所有的key的信息，如果Redis发现内存的使用量超过了某一个阀值，将触发swap的操作，Redis根据“swappability = age*log(size_in_memory)”计算出哪些key对应的value需要swap到磁盘。然后再将这些key对应的value持久化到磁盘中，同时在内存中清除。这种特性使得Redis可以保持超过其机器本身内存大小的数据。当然，机器本身的内存必须要能够保持所有的key，因为这些数据是不会进行swap操作的。<br>当从Redis中读取数据的时候，如果读取的key对应的value不在内存中，那么Redis就需要从swap文件中加载相应数据，然后再返回给请求方。</p><h3 id="memcached和redis的比较"><a href="#memcached和redis的比较" class="headerlink" title="memcached和redis的比较"></a>memcached和redis的比较</h3><ol><li><strong>网络IO模型</strong><br>Memcached是多线程，非阻塞IO复用的网络模型，分为监听主线程和worker子线程，监听线程监听网络连接，接受请求后，将连接描述字pipe 传递给worker线程，进行读写IO, 网络层使用libevent封装的事件库，多线程模型可以发挥多核作用。<br>Redis使用单线程的IO复用模型，自己封装了一个简单的AeEvent事件处理框架，主要实现了epoll、kqueue和select，对于单纯只有IO操作来说，单线程可以将速度优势发挥到最大，但是Redis也提供了一些简单的计算功能，比如排序、聚合等，对于这些操作，单线程模型实际会严重影响整体吞吐量，CPU计算过程中，整个IO调度都是被阻塞住的。</li><li><strong>内存管理方面</strong><br>Memcached使用预分配的内存池的方式，使用slab和大小不同的chunk来管理内存，value根据大小选择合适的chunk存储。Redis使用现场申请内存的方式来存储数据。</li><li><strong>存储方式及其它方面</strong><br>Memcached基本只支持简单的key-value存储，不支持持久化和复制等功能，Redis除key/value之外，还支持list,set,sortedset,hash等众多数据结构</li></ol><h2 id="2、如何保持session会话"><a href="#2、如何保持session会话" class="headerlink" title="2、如何保持session会话"></a>2、如何保持session会话</h2><p>目前，为了使web能适应大规模的访问，需要实现应用的集群部署。集群最有效的方案就是负载均衡，而实现负载均衡用户每一个请求都有可能被分配到不固定的服务器上，这样我们首先要解决session的统一来保证无论用户的请求被转发到哪个服务器上都能保证用户的正常使用，即需要实现session的共享机制。<br>在集群系统下实现session统一的有如下几种方案：</p><ol><li><strong>请求精确定位：sessionsticky</strong>，例如基于访问ip的hash策略，即当前用户的请求都集中定位到一台服务器中，这样单台服务器保存了用户的session登录信息，如果宕机，则等同于单点部署，会丢失，会话不复制。</li><li><strong>session复制共享：sessionreplication</strong>，如tomcat自带session共享，主要是指集群环境下，多台应用服务器之间同步session，使session保持一致，对外透明。 如果其中一台服务器发生故障，根据负载均衡的原理，调度器会遍历寻找可用节点，分发请求，由于session已同步，故能保证用户的session信息不会丢失，会话复制。<br><strong>此方案的不足之处：</strong><br>必须在同一种中间件之间完成(如:tomcat-tomcat之间).<br>session复制带来的性能损失会快速增加。特别是当session中保存了较大的对象,，且对象变化较快时, 性能下降更加显著，会消耗系统性能。这种特性使得web应用的水平扩展受到了限制。<br>Session内容通过广播同步给成员，会造成网络流量瓶颈，即便是内网瓶颈，在大并发下表现并不好。</li><li><strong>基于cache DB缓存的session共享</strong><br>基于memcache/redis缓存的 session 共享<br>即使用cacheDB存取session信息，应用服务器接受新请求将session信息保存在cache DB中，当应用服务器发生故障时，调度器会遍历寻找可用节点，分发请求，当应用服务器发现session不在本机内存时，则去cache DB中查找，如果找到则复制到本机，这样实现session共享和高可用。</li></ol><h2 id="3、部署nginx-tomcat-redis实现负载均衡、session共享"><a href="#3、部署nginx-tomcat-redis实现负载均衡、session共享" class="headerlink" title="3、部署nginx+tomcat+redis实现负载均衡、session共享"></a>3、部署nginx+tomcat+redis实现负载均衡、session共享</h2><p><strong>环境说明：</strong></p><table><thead><tr><th>主机</th><th>操作系统</th><th>IP地址</th></tr></thead><tbody><tr><td>Nginx</td><td>Centos7.2</td><td>192.168.31.141</td></tr><tr><td>Tomcat-1</td><td>Centos7.2</td><td>192.168.31.83</td></tr><tr><td>Tomcat-2</td><td>Centos7.2</td><td>192.168.31.250</td></tr><tr><td>Mysql</td><td>Centos7.2</td><td>192.168.31.225</td></tr><tr><td>Redis</td><td>Centos7.2</td><td>192.168.31.106</td></tr></tbody></table><p><strong>拓扑结构图：</strong></p><p><img src="/2017/08/11/redis-huan-cun-fu-wu-nginx-tomcat-redis-mysql-shi-xian-session-hui-hua-gong-xiang/%E5%9B%BE%E7%89%871.png" alt></p><p>在这个图中，nginx做为反向代理，实现静动分离，将客户动态请求根据权重随机分配给两台tomcat服务器，redis做为两台tomcat的共享session数据服务器，mysql做为两台tomcat的后端数据库。</p><h3 id="3-1-部署配置nginx"><a href="#3-1-部署配置nginx" class="headerlink" title="3.1 部署配置nginx"></a>3.1 部署配置nginx</h3><p>使用Nginx作为Tomcat的负载平衡器，Tomcat的会话Session数据存储在Redis，能够实现零宕机的7x24效果。因为将会话存储在Redis中，因此Nginx就不必配置成stick粘贴某个Tomcat方式，这样才能真正实现后台多个Tomcat负载平衡。<br><strong>安装nginx：</strong><br><strong>安装zlib-devel、pcre-devel等依赖包</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">[root@www ~]# yum -y install gccgcc-c++ make libtoolzlibzlib-develpcrepcre-developensslopenssl-devel</span><br></pre></td></tr></table></figure><p>注：结合proxy和upstream模块实现后端web负载均衡<br>结合nginx默认自带的ngx_http_proxy_module模块 和ngx_http_upstream_module模块实现后端服务器的健康检查<br><strong>创建nginx程序用户</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@www ~]# useradd -s /sbin/nologin www</span><br></pre></td></tr></table></figure><p><strong>编译安装nginx</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@www ~]# tar zxf nginx-1.10.2.tar.gz </span><br><span class="line">[root@www ~]# cd nginx-1.10.2/</span><br><span class="line">[root@www nginx-1.10.2]# ./configure --prefix=/usr/local/nginx1.10 --user=www --group=www --with-http_stub_status_module --with-http_realip_module --with-http_ssl_module --with-http_gzip_static_module  --with-pcre  --with-http_flv_module</span><br><span class="line">[root@www nginx-1.10.2]# make&amp;&amp; make install</span><br></pre></td></tr></table></figure><p><strong>优化nginx程序的执行路径</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@www nginx-1.10.2]# ln -s /usr/local/nginx1.10/sbin/nginx /usr/local/sbin/</span><br><span class="line">[root@www nginx-1.10.2]# nginx -t</span><br><span class="line">nginx: the configuration file /usr/local/nginx1.10/conf/nginx.conf syntax is ok</span><br><span class="line">nginx: configuration file /usr/local/nginx1.10/conf/nginx.conf test is successful</span><br></pre></td></tr></table></figure><p><strong>编写nginx服务脚本，脚本内容如下：</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line">[root@www ~]# cat /etc/init.d/nginx</span><br><span class="line">#!/bin/bash</span><br><span class="line"># nginx Startup script for the Nginx HTTP Server</span><br><span class="line"># chkconfig: - 85 15</span><br><span class="line"># pidfile: /usr/local/nginx1.10/logs/nginx.pid</span><br><span class="line"># config: /usr/local/nginx1.10/conf/nginx.conf</span><br><span class="line">nginxd=/usr/local/nginx1.10/sbin/nginx</span><br><span class="line">nginx_config=/usr/local/nginx1.10/conf/nginx.conf</span><br><span class="line">nginx_pid=/usr/local/nginx1.10/logs/nginx.pid</span><br><span class="line">RETVAL=0</span><br><span class="line">prog=&quot;nginx&quot;</span><br><span class="line"># Source function library.</span><br><span class="line">. /etc/rc.d/init.d/functions</span><br><span class="line"># Start nginx daemons functions.</span><br><span class="line">start() &#123;</span><br><span class="line">if [ -f $nginx_pid ] ; then</span><br><span class="line">echo &quot;nginx already running....&quot;</span><br><span class="line">exit 1</span><br><span class="line">fi</span><br><span class="line">echo -n &quot;Starting $prog: &quot;</span><br><span class="line">   $nginxd -c $&#123;nginx_config&#125;</span><br><span class="line">   RETVAL=$?</span><br><span class="line">[ $RETVAL = 0 ] &amp;&amp; touch /var/lock/subsys/nginx</span><br><span class="line">&#125;</span><br><span class="line"># Stop nginx daemons functions.</span><br><span class="line">stop() &#123;</span><br><span class="line">echo -n &quot;Stopping $prog: &quot;</span><br><span class="line">        $nginxd -s stop</span><br><span class="line">        RETVAL=$?</span><br><span class="line">[ $RETVAL = 0 ] &amp;&amp;rm -f /var/lock/subsys/nginx</span><br><span class="line">&#125;</span><br><span class="line"># reloadnginx service functions.</span><br><span class="line">reload() &#123;</span><br><span class="line">echo -n &quot;Reloading $prog: &quot;</span><br><span class="line">    $nginxd -s reload</span><br><span class="line">&#125;</span><br><span class="line"># statusngnx service functions</span><br><span class="line">status() &#123;</span><br><span class="line">if [ -f $nginx_pid ] ; then</span><br><span class="line">echo  &quot;$prog is running&quot;</span><br><span class="line">else</span><br><span class="line">echo  &quot;$prog is stop&quot;</span><br><span class="line">fi</span><br><span class="line">&#125;</span><br><span class="line">case &quot;$1&quot; in</span><br><span class="line">start)</span><br><span class="line">start</span><br><span class="line">        ;;</span><br><span class="line">stop)</span><br><span class="line">stop</span><br><span class="line">        ;;</span><br><span class="line">reload)</span><br><span class="line">reload</span><br><span class="line">        ;;</span><br><span class="line">restart)</span><br><span class="line">stop</span><br><span class="line">start</span><br><span class="line">        ;;</span><br><span class="line">status)</span><br><span class="line">status</span><br><span class="line">        ;;</span><br><span class="line">*)</span><br><span class="line">echo &quot;Usage: $prog &#123;start|stop|restart|reload|status&#125;&quot;</span><br><span class="line">exit 1</span><br><span class="line">        ;;</span><br><span class="line">esac</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@www ~]# chmod +x /etc/init.d/nginx</span><br><span class="line">[root@www ~]# chkconfig --add nginx</span><br><span class="line">[root@www ~]# chkconfignginx on</span><br><span class="line">[root@www ~]# systemctl daemon-reload</span><br></pre></td></tr></table></figure><p><strong>配置nginx反向代理</strong></p><p>反向代理+负载均衡+健康检测，nginx.conf文件内容：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line">[root@www ~]# cat /usr/local/nginx1.10/conf/nginx.conf</span><br><span class="line">user  wwwwww;</span><br><span class="line">worker_processes  4;</span><br><span class="line">worker_cpu_affinity 0001 0010 0100 1000;</span><br><span class="line">error_log  logs/error.log;</span><br><span class="line">#error_log  logs/error.log  notice;</span><br><span class="line">#error_log  logs/error.log  info;</span><br><span class="line">worker_rlimit_nofile 10240;</span><br><span class="line">pid        logs/nginx.pid;</span><br><span class="line">events &#123;</span><br><span class="line">useepoll;</span><br><span class="line">worker_connections  4096;</span><br><span class="line">&#125;</span><br><span class="line">http &#123;</span><br><span class="line">includemime.types;</span><br><span class="line">default_type  application/octet-stream;</span><br><span class="line">log_format  main  &apos;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &apos;</span><br><span class="line">                      &apos;$status $body_bytes_sent &quot;$http_referer&quot; &apos;</span><br><span class="line">                      &apos;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&apos;;</span><br><span class="line">access_log  logs/access.log  main;</span><br><span class="line">server_tokens off;</span><br><span class="line">sendfile        on;</span><br><span class="line">tcp_nopush     on;</span><br><span class="line">    #keepalive_timeout  0;</span><br><span class="line">keepalive_timeout  65;</span><br><span class="line">    #Compression Settings</span><br><span class="line">gzip on;</span><br><span class="line">gzip_comp_level 6;</span><br><span class="line">gzip_http_version 1.1;</span><br><span class="line">gzip_proxied any;</span><br><span class="line">gzip_min_length 1k;</span><br><span class="line">gzip_buffers 16 8k;</span><br><span class="line">gzip_types text/plain text/css text/javascript application/json application/javascript application/x-javascript application/xml;</span><br><span class="line">gzip_vary on;</span><br><span class="line">    #end gzip</span><br><span class="line">    # http_proxy Settings</span><br><span class="line">client_max_body_size   10m;</span><br><span class="line">client_body_buffer_size   128k;</span><br><span class="line">proxy_connect_timeout   75;</span><br><span class="line">proxy_send_timeout   75;</span><br><span class="line">proxy_read_timeout   75;</span><br><span class="line">proxy_buffer_size   4k;</span><br><span class="line">proxy_buffers   4 32k;</span><br><span class="line">proxy_busy_buffers_size   64k;</span><br><span class="line">proxy_temp_file_write_size  64k;</span><br><span class="line">    #load balance Settings</span><br><span class="line">upstreambackend_tomcat &#123;</span><br><span class="line">server 192.168.31.83:8080 weight=1 max_fails=2 fail_timeout=10s;</span><br><span class="line">server 192.168.31.250:8080 weight=1 max_fails=2 fail_timeout=10s;</span><br><span class="line">    &#125;</span><br><span class="line">    #virtual host Settings</span><br><span class="line">server &#123;</span><br><span class="line">listen       80;</span><br><span class="line">server_name  www.benet.com;</span><br><span class="line">charset utf-8;</span><br><span class="line">location / &#123;</span><br><span class="line">root html;</span><br><span class="line">index  index.jsp index.html index.htm;</span><br><span class="line">        &#125;</span><br><span class="line">location ~* \.(jsp|do)$ &#123;</span><br><span class="line">proxy_pass  http://backend_tomcat;</span><br><span class="line">proxy_redirect off;</span><br><span class="line">proxy_set_header Host $host;</span><br><span class="line">proxy_set_header X-Real-IP $remote_addr;</span><br><span class="line">proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class="line">proxy_next_upstream error timeout invalid_header http_500 http_502 http_503 http_504;</span><br><span class="line">        &#125;</span><br><span class="line">location /nginx_status &#123;</span><br><span class="line">stub_status on;</span><br><span class="line">access_log off;</span><br><span class="line">allow 192.168.31.0/24;</span><br><span class="line">deny all;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>重启nginx服务，使修改生效</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@www ~]# service  nginx restart</span><br></pre></td></tr></table></figure><p>配置防火墙规测</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@www ~]# firewall-cmd --permanent --add-port=80/tcp</span><br><span class="line">success</span><br><span class="line">[root@www ~]# firewall-cmd --reload </span><br><span class="line">success</span><br></pre></td></tr></table></figure><h3 id="3-2-部署两台tomcat服务"><a href="#3-2-部署两台tomcat服务" class="headerlink" title="3.2 部署两台tomcat服务"></a>3.2 部署两台tomcat服务</h3><p>在tomcat-1和tomcat-2节点上安装JDK<br>在安装tomcat之前必须先安装JDK，JDK的全称是java development kit,是sun公司免费提供的java语言的软件开发工具包，其中包含java虚拟机（JVM），编写好的java源程序经过编译可形成java字节码，只要安装了JDK，就可以利用JVM解释这些字节码文件，从而保证了java的跨平台性。<br><strong>安装JDK，配置java环境</strong><br>将jdk-7u65-linux-x64.gz解压</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@tomcat-1 ~]# tar zxf jdk-7u65-linux-x64.gz</span><br></pre></td></tr></table></figure><p>将解压的jdk1.7.0_65目录移致动到/usr/local/下并重命名为java</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@tomcat-1 ~]# mv jdk1.7.0_65/ /usr/local/java</span><br></pre></td></tr></table></figure><p>在/etc/profile文件中添加内容如下</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">export JAVA_HOME=/usr/local/java</span><br><span class="line">export PATH=$JAVA_HOME/bin:$PATH</span><br></pre></td></tr></table></figure><p>通过source命令执行profile文件，使其生效</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@tomcat-1 ~]# source /etc/profile</span><br><span class="line">[root@tomcat-1 ~]# echo $PATH</span><br><span class="line">/usr/local/java/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/root/bin</span><br></pre></td></tr></table></figure><p>按照相同方法在tomcat-2也安装JDK<br>分别在在tomcat-1和tomcat-2节点运行java -version命令查看java版本是否和之前安装的一致。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@tomcat-1 ~]# java -version</span><br><span class="line">java version &quot;1.7.0_65&quot;</span><br><span class="line">Java(TM) SE Runtime Environment (build 1.7.0_65-b17)</span><br><span class="line">Java HotSpot(TM) 64-Bit Server VM (build 24.65-b04, mixed mode)</span><br></pre></td></tr></table></figure><p>至此java环境已经配置完成<br><strong>在tomcat-1和tomcat-2节点安装配置tomcat</strong><br>解压apache-tomcat-7.0.54.tar.gz包</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@tomcat-1 ~]# tar zxf apache-tomcat-7.0.54.tar.gz</span><br></pre></td></tr></table></figure><p>将解压生成的文件夹移动到/usr/local/下，并改名为tomcat7</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@tomcat-1 ~]# mv apache-tomcat-7.0.54 /usr/local/tomcat7</span><br></pre></td></tr></table></figure><p><strong>配置tomcat环境变量</strong><br>/etc/profile文件内容如下</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">export JAVA_HOME=/usr/local/java</span><br><span class="line">export CATALINA_HOME=/usr/local/tomcat7</span><br><span class="line">export PATH=$JAVA_HOME/bin:$CATALINA_HOME/bin:$PATH</span><br></pre></td></tr></table></figure><p><strong>通过source命令执行profile文件，使其生效</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@tomcat-1 ~]# source /etc/profile</span><br><span class="line">[root@tomcat-1 ~]# echo $PATH</span><br><span class="line">/usr/local/java/bin:/usr/local/tomcat7/bin:/usr/local/java/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/root/bin</span><br></pre></td></tr></table></figure><p><strong>查看tomcat的版本信息</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@tomcat-1 ~]# catalina.sh version</span><br><span class="line">Using CATALINA_BASE:   /usr/local/tomcat7</span><br><span class="line">Using CATALINA_HOME:   /usr/local/tomcat7</span><br><span class="line">Using CATALINA_TMPDIR: /usr/local/tomcat7/temp</span><br><span class="line">Using JRE_HOME:        /usr/local/java</span><br><span class="line">Using CLASSPATH:       /usr/local/tomcat7/bin/bootstrap.jar:/usr/local/tomcat7/bin/tomcat-juli.jar</span><br><span class="line">Server version: Apache Tomcat/7.0.54</span><br><span class="line">Server built:   May 19 2014 10:26:15</span><br><span class="line">Server number:  7.0.54.0</span><br><span class="line">OS Name:        Linux</span><br><span class="line">OS Version:     3.10.0-327.el7.x86_64</span><br><span class="line">Architecture:   amd64</span><br><span class="line">JVM Version:    1.7.0_65-b17</span><br><span class="line">JVM Vendor:     Oracle Corporation</span><br></pre></td></tr></table></figure><p><strong>启动tomcat</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@tomcat-1 ~]# /usr/local/tomcat7/bin/startup.sh </span><br><span class="line">Using CATALINA_BASE:   /usr/local/tomcat7</span><br><span class="line">Using CATALINA_HOME:   /usr/local/tomcat7</span><br><span class="line">Using CATALINA_TMPDIR: /usr/local/tomcat7/temp</span><br><span class="line">Using JRE_HOME:        /usr/local/java</span><br><span class="line">Using CLASSPATH:       /usr/local/tomcat7/bin/bootstrap.jar:/usr/local/tomcat7/bin/tomcat-juli.jar</span><br><span class="line">Tomcat started.</span><br></pre></td></tr></table></figure><p>Tomcat默认运行在8080端口，运行netstat命令查看8080端口监听的信息</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@tomcat-1 ~]# netstat -anpt | grep java</span><br><span class="line">tcp6       0      0 :::8009      :::*                    LISTEN      42330/java          </span><br><span class="line">tcp6       0      0 :::8080      :::*                    LISTEN      42330/java</span><br></pre></td></tr></table></figure><p><strong>防火墙规则配置</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@tomcat-1 ~]# firewall-cmd --permanent --add-port=8080/tcp</span><br><span class="line">success</span><br><span class="line">[root@tomcat-1 ~]# firewall-cmd --reload</span><br><span class="line">success</span><br></pre></td></tr></table></figure><p>按照相同方法在tomcat-2也安装<br><strong>打开浏览器分别对tomcat-1和tomcat-2访问测试</strong></p><p><img src="/2017/08/11/redis-huan-cun-fu-wu-nginx-tomcat-redis-mysql-shi-xian-session-hui-hua-gong-xiang/%E5%9B%BE%E7%89%872.png" alt="image-20191118150532647"></p><p>如果想关闭tomcat则运行/usr/local/tomcat7/bin/shutdown.sh命令<br>好了，大家可以看到访成功。说明我们的tomcat安装完成，下面我们来修改配置文件</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@tomcat-1 ~]# vim /usr/local/tomcat7/conf/server.xml</span><br></pre></td></tr></table></figure><p><strong>设置默认虚拟主机，并增加jvmRoute</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;Engine name=&quot;Catalina&quot; defaultHost=&quot;localhost&quot; jvmRoute=&quot;tomcat-1&quot;&gt;</span><br></pre></td></tr></table></figure><p>修改默认虚拟主机，并将网站文件路径指向/web/webapp1，在host段增加context段</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;Host name=&quot;localhost&quot;  appBase=&quot;webapps&quot;</span><br><span class="line">unpackWARs=&quot;true&quot; autoDeploy=&quot;true&quot;&gt;</span><br><span class="line">&lt;Context docBase=&quot;/web/webapp1&quot; path=&quot;&quot; reloadable=&quot;true&quot;/&gt;</span><br><span class="line">&lt;/Host&gt;</span><br></pre></td></tr></table></figure><p><strong>增加文档目录与测试文件</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@tomcat-1 ~]# mkdir -p /web/webapp1</span><br><span class="line">[root@tomcat-1 ~]# cd /web/webapp1/</span><br><span class="line">[root@ tomcat-1 webapp1]# viindex.jsp</span><br></pre></td></tr></table></figure><p><strong>index.jsp内容如下</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">&lt;%@page language=&quot;java&quot; import=&quot;java.util.*&quot; pageEncoding=&quot;UTF-8&quot;%&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">&lt;title&gt;tomcat-1&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;h1&gt;&lt;font color=&quot;red&quot;&gt;Session serviced by tomcat&lt;/font&gt;&lt;/h1&gt;</span><br><span class="line">&lt;table aligh=&quot;center&quot; border=&quot;1&quot;&gt;</span><br><span class="line">&lt;tr&gt;</span><br><span class="line">&lt;td&gt;Session ID&lt;/td&gt;</span><br><span class="line">&lt;td&gt;&lt;%=session.getId() %&gt;&lt;/td&gt;</span><br><span class="line">&lt;% session.setAttribute(&quot;abc&quot;,&quot;abc&quot;);%&gt;</span><br><span class="line">&lt;/tr&gt;</span><br><span class="line">&lt;tr&gt;</span><br><span class="line">&lt;td&gt;Created on&lt;/td&gt;</span><br><span class="line">&lt;td&gt;&lt;%= session.getCreationTime() %&gt;&lt;/td&gt;</span><br><span class="line">&lt;/tr&gt;</span><br><span class="line">&lt;/table&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;html&gt;</span><br></pre></td></tr></table></figure><p><strong>停止tomcat运行，检查配置文件并启动tomcat</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@tomcat-1 ~]# shutdown.sh</span><br><span class="line">[root@tomcat-1 ~]# netstat -anpt | grep java</span><br><span class="line">[root@tomcat-1 ~]# catalina.shconfigtest</span><br><span class="line">Using CATALINA_BASE:   /usr/local/tomcat7</span><br><span class="line">Using CATALINA_HOME:   /usr/local/tomcat7</span><br><span class="line">Using CATALINA_TMPDIR: /usr/local/tomcat7/temp</span><br><span class="line">Using JRE_HOME:        /usr/local/java</span><br><span class="line">Using CLASSPATH:       /usr/local/tomcat7/bin/bootstrap.jar:/usr/local/tomcat7/bin/tomcat-juli.jar</span><br><span class="line">Nov 16, 2016 1:04:05 AM org.apache.catalina.core.AprLifecycleListenerinit</span><br><span class="line">INFO: The APR based Apache Tomcat Native library which allows optimal performance in production environments was not found on the java.library.path: /usr/java/packages/lib/amd64:/usr/lib64:/lib64:/lib:/usr/lib</span><br><span class="line">Nov 16, 2016 1:04:05 AM org.apache.coyote.AbstractProtocolinit</span><br><span class="line">INFO: Initializing ProtocolHandler [&quot;http-bio-8080&quot;]</span><br><span class="line">Nov 16, 2016 1:04:05 AM org.apache.coyote.AbstractProtocolinit</span><br><span class="line">INFO: Initializing ProtocolHandler [&quot;ajp-bio-8009&quot;]</span><br><span class="line">Nov 16, 2016 1:04:05 AM org.apache.catalina.startup.Catalina load</span><br><span class="line">INFO: Initialization processed in 534 ms</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@tomcat-1 ~]# startup.sh </span><br><span class="line">Using CATALINA_BASE:   /usr/local/tomcat7</span><br><span class="line">Using CATALINA_HOME:   /usr/local/tomcat7</span><br><span class="line">Using CATALINA_TMPDIR: /usr/local/tomcat7/temp</span><br><span class="line">Using JRE_HOME:        /usr/local/java</span><br><span class="line">Using CLASSPATH:       /usr/local/tomcat7/bin/bootstrap.jar:/usr/local/tomcat7/bin/tomcat-juli.jar</span><br><span class="line">Tomcat started.</span><br><span class="line"></span><br><span class="line">[root@tomcat-1 ~]# netstat -anpt | grep java</span><br><span class="line">tcp6       0      0 :::8009    :::*                    LISTEN      8180/java           </span><br><span class="line">tcp6       0      0 :::8080    :::*                    LISTEN      8180/java</span><br></pre></td></tr></table></figure><p>Tomcat-2节点与tomcat-1节点配置基本类似，只是jvmRoute不同，另外为了区分由哪个节点提供访问，测试页标题也不同（生产环境两个tomcat服务器提供的网页内容是相同的）。其他的配置都相同。</p><p>用浏览器访问nginx主机，验证负载均衡</p><p><strong>第一次访问的结果</strong></p><p><img src="/2017/08/11/redis-huan-cun-fu-wu-nginx-tomcat-redis-mysql-shi-xian-session-hui-hua-gong-xiang/%E5%9B%BE%E7%89%873.png" alt></p><p><strong>第二次访问的结果</strong></p><p><img src="/2017/08/11/redis-huan-cun-fu-wu-nginx-tomcat-redis-mysql-shi-xian-session-hui-hua-gong-xiang/%E5%9B%BE%E7%89%874.png" alt="image-20191118150750042"></p><p>验证健康检查的方法可以关掉一台tomcat主机，用客户端浏览器测试访问。</p><p>从上面的结果能看出两次访问，nginx把访问请求分别分发给了后端的tomcat-1和tomcat-2，客户端的访问请求实现了负载均衡，但sessionid并一样。所以，到这里我们准备工作就全部完成了，下面我们来配置tomcat通过redis实现会话保持。</p><h3 id="3-3-部署redis"><a href="#3-3-部署redis" class="headerlink" title="3.3 部署redis"></a>3.3 部署redis</h3><p><strong>下载redis源码</strong>，并进行相关操作，如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@redis ~]# wget http://download.redis.io/releases/redis-3.2.3.tar.gz</span><br></pre></td></tr></table></figure><p><strong>解压安装redis</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@redis ~]# tar zxf redis-3.2.3.tar.gz</span><br></pre></td></tr></table></figure><p>解压完毕后，现在开始安装</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@redis ~]# cd redis-3.2.3/</span><br><span class="line">[root@redis redis-3.2.3]# make&amp;&amp; make install</span><br></pre></td></tr></table></figure><p><img src="/2017/08/11/redis-huan-cun-fu-wu-nginx-tomcat-redis-mysql-shi-xian-session-hui-hua-gong-xiang/%E5%9B%BE%E7%89%875.png" alt="img"></p><p><img src="/2017/08/11/redis-huan-cun-fu-wu-nginx-tomcat-redis-mysql-shi-xian-session-hui-hua-gong-xiang/%E5%9B%BE%E7%89%876.png" alt="img"></p><p>通过上图，我们可以很容易的看出，redis安装到/usr/local,/usr/local/bin,/usr/local/share,/usr/local/include,/usr/local/lib,/usr/local/share/man目录下。<br>然后再切换到utils目录下，执行redis初始化脚本install_server.sh，如下：</p><blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@redis redis-3.2.3]# cd utils/</span><br><span class="line">[root@redisutils]# ./install_server.sh</span><br></pre></td></tr></table></figure><p>Welcome to the redis service installer<br>This script will help you easily set up a running redis server</p><p><font color="red">Please select the redis port for this instance: [6379]</font><br>Selecting default: 6379<br><font color="red">Please select the redisconfig file name [/etc/redis/6379.conf]</font><br>Selected default - /etc/redis/6379.conf<br><font color="red">Please select the redis log file name [/var/log/redis_6379.log]</font><br>Selected default - /var/log/redis_6379.log<br><font color="red">Please select the data directory for this instance [/var/lib/redis/6379]</font><br>Selected default - /var/lib/redis/6379<br><font color="red">Please select the redis executable path [/usr/local/bin/redis-server]</font><br>Selected config:<br><font color="red">Port : 6379</font><br><font color="red">Config file : /etc/redis/6379.conf</font><br><font color="red">Log file : /var/log/redis_6379.log</font><br><font color="red">Data dir : /var/lib/redis/6379</font><br><font color="red">Executable : /usr/local/bin/redis-server</font><br><font color="red">CliExecutable : /usr/local/bin/redis-cli</font><br>Is this ok? Then press ENTER to go on or Ctrl-C to abort.<br><font color="red">Copied /tmp/6379.conf =&gt; /etc/init.d/redis_6379</font><br>Installing service…<br><font color="red">Successfully added to chkconfig!</font><br><font color="red">Successfully added to runlevels 345!</font><br><font color="red">Starting Redis server…</font><br><font color="red">Installation successful!</font></p></blockquote><p>通过上面的安装过程，我们可以看出redis初始化后redis配置文件为/etc/redis/6379.conf，日志文件为/var/log/redis_6379.log，数据文件dump.rdb存放到/var/lib/redis/6379目录下，启动脚本为/etc/init.d/redis_6379。<br>现在我们要使用systemd，所以在 /etc/systems/system 下创建一个单位文件名字为 redis_6379.service。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@redisutils]# vi /etc/systemd/system/redis_6379.service</span><br><span class="line">[Unit]</span><br><span class="line">Description=Redis on port 6379</span><br><span class="line">[Service]</span><br><span class="line">Type=forking</span><br><span class="line">ExecStart=/etc/init.d/redis_6379 start</span><br><span class="line">ExecStop=/etc/init.d/redis_6379 stop</span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure><p><strong>注：</strong>这里Type=forking是后台运行的形式</p><p><strong>启动redis服务</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[root@redisutils]# systemctl daemon-reload </span><br><span class="line">[root@redisutils]# systemctl enable redis_6379.service</span><br><span class="line">[root@redisutils]# systemctl start redis_6379.service</span><br><span class="line">[root@redisutils]# systemctl status redis_6379.service </span><br><span class="line">● redis_6379.service - Redis on port 6379</span><br><span class="line">   Loaded: loaded (/etc/systemd/system/redis_6379.service; enabled; vendor preset: disabled)</span><br><span class="line">   Active: active (running) since Wed 2016-11-16 21:07:26 CST; 4min 25s ago</span><br><span class="line">  Process: 7732 ExecStart=/etc/init.d/redis_6379 start (code=exited, status=0/SUCCESS)</span><br><span class="line"> Main PID: 7734 (redis-server)</span><br><span class="line">CGroup: /system.slice/redis_6379.service</span><br><span class="line">└─7734 /usr/local/bin/redis-server 127.0.0.1:6379</span><br><span class="line">Nov 16 21:07:26 redissystemd[1]: Starting Redis on port 6379...</span><br><span class="line">Nov 16 21:07:26 redis redis_6379[7732]: Starting Redis server...</span><br><span class="line">Nov 16 21:07:26 redissystemd[1]: Started Redis on port 6379.</span><br><span class="line"></span><br><span class="line">[root@redisutils]# netstat -anpt | grep 6379</span><br><span class="line">tcp        0      0 127.0.0.1:6379     0.0.0.0:*     LISTEN      7734/redis-server 1</span><br></pre></td></tr></table></figure><p>从显示结果可以看到redis默认监听的是127.0.0.1的6379端口</p><p><strong>防火墙规则设置</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@redisutils]# firewall-cmd --permanent --add-port=6379/tcp</span><br><span class="line">success</span><br><span class="line">[root@redisutils]# firewall-cmd --reload </span><br><span class="line">success</span><br></pre></td></tr></table></figure><p>现在来查看redis版本使用redis-cli –version命令，如下</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@redisutils]# redis-cli --version</span><br><span class="line">redis-cli 3.2.3</span><br></pre></td></tr></table></figure><p>通过显示结果，我们可以看到redis版本是3.2.3。<br>到此源码方式安装redis就介绍完毕。<br>redis安装完毕之后，我们再来配置redis<br>设置redis监听的地址，添加监听redis主机的ip<br>考虑到安全性，我们需要启用redis的密码验证功能requirepass参数<br><strong>最终redis配置文件如下：</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">[root@redis ~]# grep -Ev &apos;^#|^$&apos; /etc/redis/6379.conf </span><br><span class="line">bind 127.0.0.1 192.168.31.106</span><br><span class="line">protected-mode yes</span><br><span class="line">port 6379</span><br><span class="line">tcp-backlog 511</span><br><span class="line">timeout 0</span><br><span class="line">tcp-keepalive 300</span><br><span class="line">daemonize yes</span><br><span class="line">supervised no</span><br><span class="line">pidfile /var/run/redis_6379.pid</span><br><span class="line">loglevel notice</span><br><span class="line">logfile /var/log/redis_6379.log</span><br><span class="line">databases 16</span><br><span class="line">save 900 1</span><br><span class="line">save 300 10</span><br><span class="line">save 60 10000</span><br><span class="line">stop-writes-on-bgsave-error yes</span><br><span class="line">rdbcompression yes</span><br><span class="line">rdbchecksum yes</span><br><span class="line">dbfilenamedump.rdb</span><br><span class="line">dir /var/lib/redis/6379</span><br><span class="line">slave-serve-stale-data yes</span><br><span class="line">slave-read-only yes</span><br><span class="line">repl-diskless-sync no</span><br><span class="line">repl-diskless-sync-delay 5</span><br><span class="line">repl-disable-tcp-nodelay no</span><br><span class="line">slave-priority 100</span><br><span class="line">requirepass pwd@123</span><br><span class="line">appendonly no</span><br><span class="line">appendfilename &quot;appendonly.aof&quot;</span><br><span class="line">appendfsynceverysec</span><br><span class="line">no-appendfsync-on-rewrite no</span><br><span class="line">auto-aof-rewrite-percentage 100</span><br><span class="line">auto-aof-rewrite-min-size 64mb</span><br><span class="line">aof-load-truncated yes</span><br><span class="line">lua-time-limit 5000</span><br><span class="line">slowlog-log-slower-than 10000</span><br><span class="line">slowlog-max-len 128</span><br><span class="line">latency-monitor-threshold 0</span><br><span class="line">notify-keyspace-events &quot;&quot;</span><br><span class="line">hash-max-ziplist-entries 512</span><br><span class="line">hash-max-ziplist-value 64</span><br><span class="line">list-max-ziplist-size -2</span><br><span class="line">list-compress-depth 0</span><br><span class="line">set-max-intset-entries 512</span><br><span class="line">zset-max-ziplist-entries 128</span><br><span class="line">zset-max-ziplist-value 64</span><br><span class="line">hll-sparse-max-bytes 3000</span><br><span class="line">activerehashing yes</span><br><span class="line">client-output-buffer-limit normal 0 0 0</span><br><span class="line">client-output-buffer-limit slave 256mb 64mb 60</span><br><span class="line">client-output-buffer-limitpubsub 32mb 8mb 60</span><br><span class="line">hz 10</span><br><span class="line">aof-rewrite-incremental-fsync yes</span><br></pre></td></tr></table></figure><p><strong>重新启动redis服务</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@redis ~]# systemctl restart redis_6379.service</span><br><span class="line">[root@redis ~]# netstat -anpt | grep redis</span><br><span class="line">tcp   0   0 192.168.31.106:6379     0.0.0.0:*   LISTEN      8418/redis-server 1</span><br></pre></td></tr></table></figure><p>redis配置文件配置完毕后，我们来启动redis并进行简单的操作。如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@redis ~]# redis-cli -h 192.168.31.106 -p 6379 -a pwd@123</span><br><span class="line">192.168.31.106:6379&gt; keys *</span><br><span class="line">(empty list or set)</span><br><span class="line">192.168.31.106:6379&gt; set name lisi</span><br><span class="line">OK</span><br><span class="line">192.168.31.106:6379&gt; get name</span><br><span class="line">&quot;lisi&quot;</span><br><span class="line">192.168.31.106:6379&gt;</span><br></pre></td></tr></table></figure><p><strong>说明：</strong></p><p>关于redis-cli -h 192.168.31.106 -p 6379 -a pwd@123的参数解释<br>这条命令是说要连接redis服务器，IP是192.168.31.106，端口是6379，密码是pwd@123。<br>keys *是查看redis所有的键值对。<br>set namelisi添加一个键值name，内容为lisi。<br>get name查看name这个键值的内容。<br>redis的命令使用暂时我们就介绍这么多</p><h3 id="3-4-配置tomcat-session-redis同步"><a href="#3-4-配置tomcat-session-redis同步" class="headerlink" title="3.4 配置tomcat session redis同步"></a>3.4 配置tomcat session redis同步</h3><p>下载tomcat-redis-session-manager相应的jar包，主要有三个：</p><blockquote><p>tomcat-redis-session-manage-tomcat7.jar<br>jedis-2.5.2.jar<br>commons-pool2-2.2.jar</p></blockquote><p>下载完成后拷贝到$TOMCAT_HOME/lib中</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@tomcat-1 ~]# cp tomcat-redis-session-manage-tomcat7.jar jedis-2.5.2.jar commons-pool2-2.2.jar /usr/local/tomcat7/lib/</span><br></pre></td></tr></table></figure><p><strong>修改tomcat的context.xml</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">[root@tomcat-1 ~]# cat /usr/local/tomcat7/conf/context.xml </span><br><span class="line">&lt;?xml version=&apos;1.0&apos; encoding=&apos;utf-8&apos;?&gt;</span><br><span class="line">&lt;!--</span><br><span class="line">  Licensed to the Apache Software Foundation (ASF) under one or more</span><br><span class="line">contributor license agreements.  See the NOTICE file distributed with</span><br><span class="line">this work for additional information regarding copyright ownership.</span><br><span class="line">  The ASF licenses this file to You under the Apache License, Version 2.0</span><br><span class="line">  (the &quot;License&quot;); you may not use this file except in compliance with</span><br><span class="line">the License.  You may obtain a copy of the License at</span><br><span class="line">      http://www.apache.org/licenses/LICENSE-2.0</span><br><span class="line">  Unless required by applicable law or agreed to in writing, software</span><br><span class="line">distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span><br><span class="line">  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span><br><span class="line">  See the License for the specific language governing permissions and</span><br><span class="line">limitations under the License.</span><br><span class="line">--&gt;</span><br><span class="line">&lt;!-- The contents of this file will be loaded for each web application --&gt;</span><br><span class="line">&lt;Context&gt;</span><br><span class="line">&lt;!-- Default set of monitored resources --&gt;</span><br><span class="line">&lt;WatchedResource&gt;WEB-INF/web.xml&lt;/WatchedResource&gt;</span><br><span class="line">&lt;!-- Uncomment this to disable session persistence across Tomcat restarts --&gt;</span><br><span class="line">&lt;!--</span><br><span class="line">&lt;Manager pathname=&quot;&quot; /&gt;</span><br><span class="line">    --&gt;</span><br><span class="line">&lt;!-- Uncomment this to enable Comet connection tacking (provides events</span><br><span class="line">on session expiration as well as webapp lifecycle) --&gt;</span><br><span class="line">&lt;!--</span><br><span class="line">&lt;Valve className=&quot;org.apache.catalina.valves.CometConnectionManagerValve&quot; /&gt;</span><br><span class="line">    --&gt;</span><br><span class="line">&lt;Valve className=&quot;com.orangefunction.tomcat.redissessions.RedisSessionHandlerValve&quot; /&gt;</span><br><span class="line">&lt;Manager className=&quot;com.orangefunction.tomcat.redissessions.RedisSessionManager&quot;</span><br><span class="line">host=&quot;192.168.31.106&quot;</span><br><span class="line">password=&quot;pwd@123&quot;</span><br><span class="line">port=&quot;6379&quot;</span><br><span class="line">database=&quot;0&quot;</span><br><span class="line">maxInactiveInterval=&quot;60&quot; /&gt;</span><br><span class="line">&lt;/Context&gt;</span><br></pre></td></tr></table></figure><p><strong>重启tomcat服务</strong><br>说明：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">maxInactiveInterval=&quot;60&quot;：session的失效时间</span><br><span class="line">[root@tomcat-1 ~]# shutdown.sh </span><br><span class="line">Using CATALINA_BASE:   /usr/local/tomcat7</span><br><span class="line">Using CATALINA_HOME:   /usr/local/tomcat7</span><br><span class="line">Using CATALINA_TMPDIR: /usr/local/tomcat7/temp</span><br><span class="line">Using JRE_HOME:        /usr/local/java</span><br><span class="line">Using CLASSPATH:       /usr/local/tomcat7/bin/bootstrap.jar:/usr/local/tomcat7/bin/tomcat-juli.jar</span><br><span class="line">[root@tomcat-1 ~]# startup.sh </span><br><span class="line">Using CATALINA_BASE:   /usr/local/tomcat7</span><br><span class="line">Using CATALINA_HOME:   /usr/local/tomcat7</span><br><span class="line">Using CATALINA_TMPDIR: /usr/local/tomcat7/temp</span><br><span class="line">Using JRE_HOME:        /usr/local/java</span><br><span class="line">Using CLASSPATH:       /usr/local/tomcat7/bin/bootstrap.jar:/usr/local/tomcat7/bin/tomcat-juli.jar</span><br><span class="line">Tomcat started.</span><br></pre></td></tr></table></figure><p>tomcat-2执行和tomcat-1相同的操作<br>通过浏览器访问 <a href="http://192.168.31.141/index.jsp" target="_blank" rel="noopener">http://192.168.31.141/index.jsp</a> 测试页</p><p><img src="/2017/08/11/redis-huan-cun-fu-wu-nginx-tomcat-redis-mysql-shi-xian-session-hui-hua-gong-xiang/%E5%9B%BE%E7%89%877.png" alt="img"></p><p><strong>刷新页面</strong></p><p><img src="/2017/08/11/redis-huan-cun-fu-wu-nginx-tomcat-redis-mysql-shi-xian-session-hui-hua-gong-xiang/%E5%9B%BE%E7%89%878.png" alt="img"></p><p>可以看出，分别访问了不同的tomcat，但是得到的session却是相同的，说明达到了集群的目的。</p><p><strong>注：</strong>从Tomcat6开始默认开启了Session持久化设置，测试时可以关闭本地Session持久化，其实也很简单，在Tomcat的conf目录下的context.xml文件中，取消注释下面那段配置即可：</p><p><strong>修改前：</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- Uncomment this to disable session persistence across Tomcat restarts --&gt;</span><br><span class="line">&lt;!--</span><br><span class="line">&lt;Manager pathname=&quot;&quot; /&gt;</span><br><span class="line">--&gt;</span><br></pre></td></tr></table></figure><p>修改后：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- Uncomment this to disable session persistence across Tomcat restarts --&gt;</span><br><span class="line">&lt;Manager pathname=&quot;&quot; /&gt;</span><br></pre></td></tr></table></figure><p><strong>重启tomcat服务</strong></p><p><strong>查看redis:</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@redis ~]# redis-cli -h 192.168.31.106 -p 6379 -a pwd@123</span><br><span class="line">192.168.31.106:6379&gt; keys *</span><br><span class="line">1) &quot;6C3F950BE6413AD2E0EF00F930881224.tomcat-1.tomcat-1&quot;</span><br><span class="line">2) &quot;name&quot;</span><br><span class="line">3) &quot;7A6D5D4C5B1EA52C4E9EED1C5523FEB5.tomcat-2.tomcat-2&quot;</span><br><span class="line">4) &quot;32C35EEA064884F065E93CB00C690662.tomcat-1.tomcat-1&quot;</span><br></pre></td></tr></table></figure><h3 id="3-5-tomcat连接数据库"><a href="#3-5-tomcat连接数据库" class="headerlink" title="3.5 tomcat连接数据库"></a>3.5 tomcat连接数据库</h3><p>192.168.31.225作为mysql数据库服务器</p><p><strong>创建用于连接数据的账户，新建表</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@db ~]# mysql -uroot -p123.abc</span><br><span class="line">mysql&gt; grant all on *.* to javauser@&apos;192.168.31.%&apos; identified by &apos;javapasswd&apos;;</span><br><span class="line">Query OK, 0 rows affected, 1 warning (0.02 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; create database javatest;</span><br><span class="line">Query OK, 1 row affected (0.01 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; use javatest;</span><br><span class="line">Database changed</span><br><span class="line"></span><br><span class="line">mysql&gt; create table testdata(id int not null auto_increment primary key,foo varchar(25),bar int);</span><br><span class="line">Query OK, 0 rows affected (0.02 sec)</span><br></pre></td></tr></table></figure><p><strong>插入些数据</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; insert into testdata(foo,bar) values (&apos;hello&apos;,&apos;123456&apos;),(&apos;ok&apos;,&apos;654321&apos;);</span><br><span class="line">Query OK, 2 rows affected (0.04 sec)</span><br><span class="line">Records: 2  Duplicates: 0  Warnings: 0</span><br><span class="line">mysql&gt; select * from testdata;</span><br><span class="line">+----+-------+--------+</span><br><span class="line">| id | foo   | bar    |</span><br><span class="line">+----+-------+--------+</span><br><span class="line">|  1 | hello | 123456 |</span><br><span class="line">|  2 | ok    | 654321 |</span><br><span class="line">+----+-------+--------+</span><br><span class="line">2 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure><p><strong>mysql防火墙配置</strong></p><p>配置tomcat服务器连接mysql数据库</p><p>下载mysql-connector-java-5.1.22-bin.jar并复制到$CATALINA_HOME/lib目录下</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@tomcat-1 ~]# cp mysql-connector-java-5.1.22-bin.jar /usr/local/tomcat7/lib/</span><br><span class="line">[root@tomcat-1 ~]# ls /usr/local/tomcat7/lib/mysql-connector-java-5.1.22-bin.jar </span><br><span class="line">/usr/local/tomcat7/lib/mysql-connector-java-5.1.22-bin.jar</span><br><span class="line"></span><br><span class="line">[root@tomcat-1 ~]# vi /usr/local/tomcat7/conf/context.xml</span><br></pre></td></tr></table></figure><p><strong>在<context>中添加如下内容：</context></strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;Resource name=&quot;jdbc/TestDB&quot; auth=&quot;Container&quot; type=&quot;javax.sql.DataSource&quot;</span><br><span class="line">maxActive=&quot;100&quot; maxIdle=&quot;30&quot; maxWait=&quot;10000&quot;</span><br><span class="line">username=&quot;javauser&quot; password=&quot;javapass&quot; driverClassName=&quot;com.mysql.jdbc.Driver&quot;</span><br><span class="line">url=&quot;jdbc:mysql://192.168.31.225:3306/javatest&quot;/&gt;</span><br></pre></td></tr></table></figure><p>保存修改并退出</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">web.xml configuration</span><br><span class="line">[root@tomcat-1 ~]# mkdir /web/webapp1/WEB-INF</span><br><span class="line">[root@tomcat-1 ~]# vi /web/webapp1/WEB-INF/web.xml</span><br></pre></td></tr></table></figure><p><strong>添加内容如下：</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&lt;web-app xmlns=&quot;http://java.sun.com/xml/ns/j2ee&quot;</span><br><span class="line">xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span><br><span class="line">xsi:schemaLocation=&quot;http://java.sun.com/xml/ns/j2ee</span><br><span class="line">http://java.sun.com/xml/ns/j2ee/web-app_2_4.xsd&quot;</span><br><span class="line">version=&quot;2.4&quot;&gt;</span><br><span class="line">&lt;description&gt;MySQL Test App&lt;/description&gt;</span><br><span class="line">&lt;resource-ref&gt;</span><br><span class="line">&lt;description&gt;DB Connection&lt;/description&gt;</span><br><span class="line">&lt;res-ref-name&gt;jdbc/TestDB&lt;/res-ref-name&gt;</span><br><span class="line">&lt;res-type&gt;javax.sql.DataSource&lt;/res-type&gt;</span><br><span class="line">&lt;res-auth&gt;Container&lt;/res-auth&gt;</span><br><span class="line">&lt;/resource-ref&gt;</span><br><span class="line">&lt;/web-app&gt;</span><br></pre></td></tr></table></figure><p><strong>保存修改并退出，重启tomcat服务</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@tomcat-1 ~]# shutdown.sh </span><br><span class="line">Using CATALINA_BASE:   /usr/local/tomcat7</span><br><span class="line">Using CATALINA_HOME:   /usr/local/tomcat7</span><br><span class="line">Using CATALINA_TMPDIR: /usr/local/tomcat7/temp</span><br><span class="line">Using JRE_HOME:        /usr/local/java</span><br><span class="line">Using CLASSPATH:       /usr/local/tomcat7/bin/bootstrap.jar:/usr/local/tomcat7/bin/tomcat-juli.jar</span><br><span class="line"></span><br><span class="line">[root@tomcat-1 ~]# startup.sh </span><br><span class="line">Using CATALINA_BASE:   /usr/local/tomcat7</span><br><span class="line">Using CATALINA_HOME:   /usr/local/tomcat7</span><br><span class="line">Using CATALINA_TMPDIR: /usr/local/tomcat7/temp</span><br><span class="line">Using JRE_HOME:        /usr/local/java</span><br><span class="line">Using CLASSPATH:       /usr/local/tomcat7/bin/bootstrap.jar:/usr/local/tomcat7/bin/tomcat-juli.jar</span><br><span class="line">Tomcat started.</span><br></pre></td></tr></table></figure><p>tomcat-2进行和tomcat-1相同的操用</p><p>Test code<br>Now create a simple test.jsp page,内容如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">[root@tomcat-2 ~]# vi /web/webapp1/test.jsp</span><br><span class="line">[root@tomcat-2 webapp1]# cattest.jsp</span><br><span class="line">&lt;%@ page language=&quot;java&quot; import=&quot;java.sql.*&quot; pageEncoding=&quot;GB2312&quot;%&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">&lt;title&gt;MySQL&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">connect MySQL&lt;br&gt;</span><br><span class="line">&lt;%</span><br><span class="line">String driverClass=&quot;com.mysql.jdbc.Driver&quot;;</span><br><span class="line">String url=&quot;jdbc:mysql://192.168.31.225:3306/javatest&quot;;</span><br><span class="line">String username = &quot;javauser&quot;; </span><br><span class="line">String password = &quot;javapasswd&quot;; </span><br><span class="line">Class.forName(driverClass); </span><br><span class="line">Connection conn=DriverManager.getConnection(url, username, password); </span><br><span class="line">Statement stmt=conn.createStatement();</span><br><span class="line">ResultSetrs = stmt.executeQuery(&quot;select * from testdata&quot;); </span><br><span class="line">while(rs.next())&#123;</span><br><span class="line">out.println(&quot;&lt;br&gt;foo:&quot;+rs.getString(2)+&quot;bar:&quot;+rs.getString(3));</span><br><span class="line">&#125;</span><br><span class="line">rs.close();</span><br><span class="line">stmt.close();</span><br><span class="line">conn.close();</span><br><span class="line">%&gt;</span><br><span class="line">&lt;/body&gt;&lt;/html&gt;</span><br></pre></td></tr></table></figure><p>通过浏览器访问 <a href="http://192.168.31.141/test.jsp" target="_blank" rel="noopener">http://192.168.31.141/test.jsp</a> 测试页</p><p><img src="/2017/08/11/redis-huan-cun-fu-wu-nginx-tomcat-redis-mysql-shi-xian-session-hui-hua-gong-xiang/%E5%9B%BE%E7%89%879.png" alt="img"></p><p><strong>注：</strong>以上配置可以参考tomcat docs</p><p><img src="/2017/08/11/redis-huan-cun-fu-wu-nginx-tomcat-redis-mysql-shi-xian-session-hui-hua-gong-xiang/%E5%9B%BE%E7%89%8710.png" alt="img"></p><p><img src="/2017/08/11/redis-huan-cun-fu-wu-nginx-tomcat-redis-mysql-shi-xian-session-hui-hua-gong-xiang/%E5%9B%BE%E7%89%8711.png" alt="img"></p><p><img src="/2017/08/11/redis-huan-cun-fu-wu-nginx-tomcat-redis-mysql-shi-xian-session-hui-hua-gong-xiang/%E5%9B%BE%E7%89%8712.png" alt="img"></p></div><div><div><div style="text-align:center;color:#ccc;font-size:14px">-------------本文结束<i class="fa fa-paw"></i>感谢您的阅读-------------</div></div></div><div></div><footer class="post-footer"><div class="post-tags"><a href="/tags/Nginx/" rel="tag"><i class="fa fa-tag"></i> Nginx</a><a href="/tags/%E7%BC%93%E5%AD%98/" rel="tag"><i class="fa fa-tag"></i> 缓存</a><a href="/tags/MySQL/" rel="tag"><i class="fa fa-tag"></i> MySQL</a><a href="/tags/Tomcat/" rel="tag"><i class="fa fa-tag"></i> Tomcat</a><a href="/tags/Redis/" rel="tag"><i class="fa fa-tag"></i> Redis</a></div><div class="post-nav"><div class="post-nav-next post-nav-item"><a href="/2017/07/27/postfix-you-jian-fu-wu/" rel="next" title="Postfix 邮件服务"><i class="fa fa-chevron-left"></i> Postfix 邮件服务</a></div><span class="post-nav-divider"></span><div class="post-nav-prev post-nav-item"><a href="/2017/08/15/bu-shu-zhu-cong-dns/" rel="prev" title="部署主从DNS">部署主从DNS<i class="fa fa-chevron-right"></i></a></div></div></footer></div></article><div class="post-spread"><div class="jiathis_style"><span class="jiathis_txt">分享到：</span> <a class="jiathis_button_fav">收藏夹</a> <a class="jiathis_button_copy">复制网址</a> <a class="jiathis_button_email">邮件</a> <a class="jiathis_button_weixin">微信</a> <a class="jiathis_button_qzone">QQ空间</a> <a class="jiathis_button_tqq">腾讯微博</a> <a class="jiathis_button_douban">豆瓣</a> <a class="jiathis_button_share">一键分享</a> <a href="http://www.jiathis.com/share?uid=2140465" class="jiathis jiathis_txt jiathis_separator jtico jtico_jiathis" target="_blank">更多</a><a class="jiathis_counter_style"></a></div><script type="text/javascript">var jiathis_config={data_track_clickback:!0,summary:"",shortUrl:!1,hideMore:!1}</script><script type="text/javascript" src="http://v3.jiathis.com/code/jia.js?uid=" charset="utf-8"></script></div></div></div></div><div class="sidebar-toggle"><div class="sidebar-toggle-line-wrap"><span class="sidebar-toggle-line sidebar-toggle-line-first"></span><span class="sidebar-toggle-line sidebar-toggle-line-middle"></span><span class="sidebar-toggle-line sidebar-toggle-line-last"></span></div></div><aside id="sidebar" class="sidebar"><div id="sidebar-dimmer"></div><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">文章目录</li><li class="sidebar-nav-overview" data-target="site-overview-wrap">站点概览</li></ul><section class="site-overview-wrap sidebar-panel"><div class="site-overview"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="site-author-image" itemprop="image" src="/images/chen.png" alt="Zhongzhou Chen"><p class="site-author-name" itemprop="name">Zhongzhou Chen</p><p class="site-description motion-element" itemprop="description"></p></div><nav class="site-state motion-element"><div class="site-state-item site-state-posts"><a href="/archives/%7C%7C%20archive"><span class="site-state-item-count">314</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"><a href="/categories/index.html"><span class="site-state-item-count">84</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"><a href="/tags/index.html"><span class="site-state-item-count">180</span> <span class="site-state-item-name">标签</span></a></div></nav><div class="feed-link motion-element"><a href="/atom.xml" rel="alternate"><i class="fa fa-rss"></i> RSS</a></div></div></section><section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active"><div class="post-toc"><div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#1、Redis-简介"><span class="nav-text">1、Redis 简介</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#memcached和redis的比较"><span class="nav-text">memcached和redis的比较</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2、如何保持session会话"><span class="nav-text">2、如何保持session会话</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3、部署nginx-tomcat-redis实现负载均衡、session共享"><span class="nav-text">3、部署nginx+tomcat+redis实现负载均衡、session共享</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#3-1-部署配置nginx"><span class="nav-text">3.1 部署配置nginx</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-2-部署两台tomcat服务"><span class="nav-text">3.2 部署两台tomcat服务</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-3-部署redis"><span class="nav-text">3.3 部署redis</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-4-配置tomcat-session-redis同步"><span class="nav-text">3.4 配置tomcat session redis同步</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-5-tomcat连接数据库"><span class="nav-text">3.5 tomcat连接数据库</span></a></li></ol></li></ol></div></div></section><div class="back-to-top"><i class="fa fa-arrow-up"></i> <span id="scrollpercent"><span>0</span>%</span></div></div></aside></div></main><footer id="footer" class="footer"><div class="footer-inner"><script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script><div class="copyright">&copy; <span itemprop="copyrightYear">2022</span><span class="with-love"><i class="fa fa-user"></i></span> <span class="author" itemprop="copyrightHolder">Zhongzhou Chen</span> <span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-area-chart"></i></span> <span class="post-meta-item-text">Site words total count&#58;</span> <span title="Site words total count">752.6k</span></div><span class="post-meta-divider"></span></div></footer></div><script type="text/javascript">"[object Function]"!==Object.prototype.toString.call(window.Promise)&&(window.Promise=null)</script><script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script><script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script><script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script><script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script><script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script><script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script><script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script><style>.copy-btn{display:inline-block;padding:6px 12px;font-size:13px;font-weight:700;line-height:20px;color:#333;white-space:nowrap;vertical-align:middle;cursor:pointer;background-color:#eee;background-image:linear-gradient(#fcfcfc,#eee);border:1px solid #d5d5d5;border-radius:3px;user-select:none;outline:0}.highlight-wrap .copy-btn{transition:opacity .3s ease-in-out;opacity:0;padding:2px 6px;position:absolute;right:4px;top:8px}.highlight-wrap .copy-btn:focus,.highlight-wrap:hover .copy-btn{opacity:1}.highlight-wrap{position:relative}</style><script>$(".highlight").each(function(t,e){var n=$("<div>").addClass("highlight-wrap");$(e).after(n),n.append($("<button>").addClass("copy-btn").append("复制").on("click",function(t){var e=$(this).parent().find(".code").find(".line").map(function(t,e){return $(e).text()}).toArray().join("\n"),n=document.createElement("textarea");document.body.appendChild(n),n.style.position="absolute",n.style.top="0px",n.style.left="0px",n.value=e,n.select(),n.focus();var o=document.execCommand("copy");document.body.removeChild(n),o?$(this).text("复制成功"):$(this).text("复制失败"),$(this).blur()})).on("mouseleave",function(t){var e=$(this).find(".copy-btn");setTimeout(function(){e.text("复制")},300)}).append(e)})</script><script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script><script type="text/javascript">function proceedsearch(){$("body").append('<div class="search-popup-overlay local-search-pop-overlay"></div>').css("overflow","hidden"),$(".search-popup-overlay").click(onPopupClose),$(".popup").toggle();var t=$("#local-search-input");t.attr("autocapitalize","none"),t.attr("autocorrect","off"),t.focus()}var isfetched=!1,isXml=!0,search_path="search.xml";0===search_path.length?search_path="search.xml":/json$/i.test(search_path)&&(isXml=!1);var path="/"+search_path,onPopupClose=function(t){$(".popup").hide(),$("#local-search-input").val(""),$(".search-result-list").remove(),$("#no-result").remove(),$(".local-search-pop-overlay").remove(),$("body").css("overflow","")},searchFunc=function(t,e,s){"use strict";$("body").append('<div class="search-popup-overlay local-search-pop-overlay"><div id="search-loading-icon"><i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i></div></div>').css("overflow","hidden"),$("#search-loading-icon").css("margin","20% auto 0 auto").css("text-align","center"),$.ajax({url:t,dataType:isXml?"xml":"json",async:!0,success:function(t){isfetched=!0,$(".popup").detach().appendTo(".header-inner");var o=isXml?$("entry",t).map(function(){return{title:$("title",this).text(),content:$("content",this).text(),url:$("url",this).text()}}).get():t,n=document.getElementById(e),r=document.getElementById(s);n.addEventListener("input",function(){var y=n.value.trim().toLowerCase(),T=y.split(/[\s\-]+/);1<T.length&&T.push(y);var b=[];if(0<y.length&&o.forEach(function(t){function e(t,e,o,n){for(var r=n[n.length-1],s=r.position,a=r.word,i=[],c=0;s+a.length<=o&&0!=n.length;){a===y&&c++,i.push({position:s,length:a.length});var l=s+a.length;for(n.pop();0!=n.length&&(s=(r=n[n.length-1]).position,a=r.word,s<l);)n.pop()}return h+=c,{hits:i,start:e,end:o,searchTextCount:c}}function o(o,t){var n="",r=t.start;return t.hits.forEach(function(t){n+=o.substring(r,t.position);var e=t.position+t.length;n+='<b class="search-keyword">'+o.substring(t.position,e)+"</b>",r=e}),n+=o.substring(r,t.end)}var n=!1,r=0,h=0,s=t.title.trim(),a=s.toLowerCase(),i=t.content.trim().replace(/<[^>]+>/g,""),c=i.toLowerCase(),l=decodeURIComponent(t.url),p=[],u=[];if(""!=s&&(T.forEach(function(t){function e(t,e,o){var n=t.length;if(0===n)return[];var r=0,s=[],a=[];for(o||(e=e.toLowerCase(),t=t.toLowerCase());-1<(s=e.indexOf(t,r));)a.push({position:s,word:t}),r=s+n;return a}p=p.concat(e(t,a,!1)),u=u.concat(e(t,c,!1))}),(0<p.length||0<u.length)&&(n=!0,r=p.length+u.length)),n){[p,u].forEach(function(t){t.sort(function(t,e){return e.position!==t.position?e.position-t.position:t.word.length-e.word.length})});var f=[];0!=p.length&&f.push(e(0,0,s.length,p));for(var d=[];0!=u.length;){var g=u[u.length-1],v=g.position,$=g.word,C=v-20,m=v+80;C<0&&(C=0),m<v+$.length&&(m=v+$.length),m>i.length&&(m=i.length),d.push(e(0,C,m,u))}d.sort(function(t,e){return t.searchTextCount!==e.searchTextCount?e.searchTextCount-t.searchTextCount:t.hits.length!==e.hits.length?e.hits.length-t.hits.length:t.start-e.start});var x=parseInt("1");0<=x&&(d=d.slice(0,x));var w="";w+=0!=f.length?"<li><a href='"+l+"' class='search-result-title'>"+o(s,f[0])+"</a>":"<li><a href='"+l+"' class='search-result-title'>"+s+"</a>",d.forEach(function(t){w+="<a href='"+l+'\'><p class="search-result">'+o(i,t)+"...</p></a>"}),w+="</li>",b.push({item:w,searchTextCount:h,hitCount:r,id:b.length})}}),1===T.length&&""===T[0])r.innerHTML='<div id="no-result"><i class="fa fa-search fa-5x" /></div>';else if(0===b.length)r.innerHTML='<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>';else{b.sort(function(t,e){return t.searchTextCount!==e.searchTextCount?e.searchTextCount-t.searchTextCount:t.hitCount!==e.hitCount?e.hitCount-t.hitCount:e.id-t.id});var e='<ul class="search-result-list">';b.forEach(function(t){e+=t.item}),e+="</ul>",r.innerHTML=e}}),$(".local-search-pop-overlay").remove(),$("body").css("overflow",""),proceedsearch()}})};$(".popup-trigger").click(function(t){t.stopPropagation(),!1===isfetched?searchFunc(path,"local-search-input","local-search-result"):proceedsearch()}),$(".popup-btn-close").click(onPopupClose),$(".popup").click(function(t){t.stopPropagation()}),$(document).on("keyup",function(t){27===t.which&&$(".search-popup").is(":visible")&&onPopupClose()})</script><script type="text/javascript" src="/js/src/love.js"></script><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({pluginRootPath:"live2dw/",pluginJsPath:"lib/",pluginModelPath:"assets/",tagMode:!1,debug:!1,log:!1,model:{jsonPath:"/live2dw/assets/shizuku.model.json"},display:{position:"right"},mobile:{show:!0,scale:.2},react:{opacityDefault:.7,opacityOnHover:.2,opacity:.4}})</script></body></html>