<!DOCTYPE html><html class="theme-next gemini use-motion" lang="zh-Hans"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><script src="//cdn.bootcss.com/pace/1.0.2/pace.min.js"></script><link href="//cdn.bootcss.com/pace/1.0.2/themes/pink/pace-theme-flash.css" rel="stylesheet"><script></script><meta name="theme-color" content="#222"><style>.pace .pace-progress{background:#1e92fb;height:3px}.pace .pace-progress-inner{box-shadow:0 0 10px #1e92fb,0 0 5px #1e92fb}.pace .pace-activity{border-top-color:#1e92fb;border-left-color:#1e92fb}</style><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><meta name="google-site-verification" content="HGM141IpbHrSmnAmR6W_zE4bo9Z3f-yXLeHYT3bg1fk"><meta name="baidu-site-verification" content="code-5Ai1DA8e6T"><link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css"><link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css"><link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4"><link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222"><meta name="keywords" content="注册中心,Consul,"><link rel="alternate" href="/atom.xml" title="凡间的精灵" type="application/atom+xml"><meta name="description" content="CAP理论CAP理论是分布式架构中重要理论一致性(Consistency) (所有节点在同一时间具有相同的数据)可用性(Availability) (保证每个请求不管成功或者失败都有响应)分隔容忍(Partition tolerance) (系统中任意信息的丢失或失败不会影响系统的继续运作)主流注册中心产品NacosEurekaConsulCoreDNSZookeeper一致性协议CP+APAPC"><meta name="keywords" content="注册中心,Consul"><meta property="og:type" content="article"><meta property="og:title" content="Consul 注册中心测试"><meta property="og:url" content="http:&#x2F;&#x2F;chenzhonzhou.github.io&#x2F;2020&#x2F;09&#x2F;17&#x2F;consul-zhu-ce-zhong-xin-ce-shi&#x2F;index.html"><meta property="og:site_name" content="凡间的精灵"><meta property="og:description" content="CAP理论CAP理论是分布式架构中重要理论一致性(Consistency) (所有节点在同一时间具有相同的数据)可用性(Availability) (保证每个请求不管成功或者失败都有响应)分隔容忍(Partition tolerance) (系统中任意信息的丢失或失败不会影响系统的继续运作)主流注册中心产品NacosEurekaConsulCoreDNSZookeeper一致性协议CP+APAPC"><meta property="og:locale" content="zh-Hans"><meta property="og:image" content="http:&#x2F;&#x2F;chenzhonzhou.github.io&#x2F;2020&#x2F;09&#x2F;17&#x2F;consul-zhu-ce-zhong-xin-ce-shi&#x2F;%E5%9B%BE%E7%89%871.png"><meta property="og:image" content="http:&#x2F;&#x2F;chenzhonzhou.github.io&#x2F;2020&#x2F;09&#x2F;17&#x2F;consul-zhu-ce-zhong-xin-ce-shi&#x2F;%E5%9B%BE%E7%89%872.png"><meta property="og:image" content="http:&#x2F;&#x2F;chenzhonzhou.github.io&#x2F;2020&#x2F;09&#x2F;17&#x2F;consul-zhu-ce-zhong-xin-ce-shi&#x2F;%E5%9B%BE%E7%89%873.png"><meta property="og:image" content="http:&#x2F;&#x2F;chenzhonzhou.github.io&#x2F;2020&#x2F;09&#x2F;17&#x2F;consul-zhu-ce-zhong-xin-ce-shi&#x2F;%E5%9B%BE%E7%89%874.png"><meta property="og:image" content="http:&#x2F;&#x2F;chenzhonzhou.github.io&#x2F;2020&#x2F;09&#x2F;17&#x2F;consul-zhu-ce-zhong-xin-ce-shi&#x2F;%E5%9B%BE%E7%89%875.png"><meta property="og:image" content="http:&#x2F;&#x2F;chenzhonzhou.github.io&#x2F;2020&#x2F;09&#x2F;17&#x2F;consul-zhu-ce-zhong-xin-ce-shi&#x2F;%E5%9B%BE%E7%89%875.png"><meta property="og:image" content="http:&#x2F;&#x2F;chenzhonzhou.github.io&#x2F;2020&#x2F;09&#x2F;17&#x2F;consul-zhu-ce-zhong-xin-ce-shi&#x2F;%E5%9B%BE%E7%89%876.png"><meta property="og:updated_time" content="2020-09-17T10:15:28.003Z"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="http:&#x2F;&#x2F;chenzhonzhou.github.io&#x2F;2020&#x2F;09&#x2F;17&#x2F;consul-zhu-ce-zhong-xin-ce-shi&#x2F;%E5%9B%BE%E7%89%871.png"><script type="text/javascript" id="hexo.configurations">var NexT=window.NexT||{},CONFIG={root:"/",scheme:"Gemini",version:"5.1.4",sidebar:{position:"left",display:"always",offset:12,b2t:!0,scrollpercent:!0,onmobile:!0},fancybox:!0,tabs:!0,motion:{enable:!0,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}},duoshuo:{userId:"0",author:"博主"},algolia:{applicationID:"",apiKey:"",indexName:"",hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}}}</script><link rel="canonical" href="http://chenzhonzhou.github.io/2020/09/17/consul-zhu-ce-zhong-xin-ce-shi/"><title>Consul 注册中心测试 | 凡间的精灵</title><link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css"></head><body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans"><div class="container sidebar-position-left page-post-detail"><div class="headband"></div><header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-wrapper"><div class="site-meta"><div class="custom-logo-site-title"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">凡间的精灵</span><span class="logo-line-after"><i></i></span></a></div><p class="site-subtitle">凡尘落素一精灵</p></div><div class="site-nav-toggle"><button><span class="btn-bar"></span><span class="btn-bar"></span><span class="btn-bar"></span></button></div></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i><br>首页</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i><br>归档</a></li><li class="menu-item menu-item-categories"><a href="/categories" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i><br>分类</a></li><li class="menu-item menu-item-tags"><a href="/tags" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i><br>标签</a></li><li class="menu-item menu-item-sitemap"><a href="/sitemap.xml" rel="section"><i class="menu-item-icon fa fa-fw fa-sitemap"></i><br>站点地图</a></li><li class="menu-item menu-item-search"><a href="javascript:;" class="popup-trigger"><i class="menu-item-icon fa fa-search fa-fw"></i><br>搜索</a></li></ul><div class="site-search"><div class="popup search-popup local-search-popup"><div class="local-search-header clearfix"><span class="search-icon"><i class="fa fa-search"></i></span><span class="popup-btn-close"><i class="fa fa-times-circle"></i></span><div class="local-search-input-wrapper"><input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input"></div></div><div id="local-search-result"></div></div></div></nav></div></header><main id="main" class="main"><div class="main-inner"><div class="content-wrap"><div id="content" class="content"><div id="posts" class="posts-expand"><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><div class="post-block"><link itemprop="mainEntityOfPage" href="http://chenzhonzhou.github.io/2020/09/17/consul-zhu-ce-zhong-xin-ce-shi/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="name" content="Zhongzhou Chen"><meta itemprop="description" content=""><meta itemprop="image" content="/images/chen.png"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="凡间的精灵"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">Consul 注册中心测试</h1><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i></span> <span class="post-meta-item-text">发表于</span> <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-09-17T16:10:41+08:00">2020-09-17</time></span> <span class="post-category"><span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-folder-o"></i></span> <span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83/" itemprop="url" rel="index"><span itemprop="name">注册中心</span></a></span> ， <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83/Consul/" itemprop="url" rel="index"><span itemprop="name">Consul</span></a></span></span><div class="post-wordcount"><span class="post-meta-item-icon"><i class="fa fa-file-word-o"></i></span> <span class="post-meta-item-text">字数统计&#58;</span> <span title="字数统计">4.6k</span> <span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-clock-o"></i></span> <span class="post-meta-item-text">阅读时长 &asymp;</span> <span title="阅读时长">22</span></div></div></header><div class="post-body" itemprop="articleBody"><h1 id="CAP理论"><a href="#CAP理论" class="headerlink" title="CAP理论"></a>CAP理论</h1><p>CAP理论是分布式架构中重要理论</p><blockquote><ul><li>一致性(Consistency) (所有节点在同一时间具有相同的数据)</li><li>可用性(Availability) (保证每个请求不管成功或者失败都有响应)</li><li>分隔容忍(Partition tolerance) (系统中任意信息的丢失或失败不会影响系统的继续运作)</li></ul></blockquote><h1 id="主流注册中心产品"><a href="#主流注册中心产品" class="headerlink" title="主流注册中心产品"></a>主流注册中心产品</h1><table><thead><tr><th align="left"></th><th align="left"><strong>Nacos</strong></th><th align="left"><strong>Eureka</strong></th><th align="left"><strong>Consul</strong></th><th align="left"><strong>CoreDNS</strong></th><th align="left"><strong>Zookeeper</strong></th></tr></thead><tbody><tr><td align="left">一致性协议</td><td align="left">CP+AP</td><td align="left">AP</td><td align="left">CP</td><td align="left">—</td><td align="left">CP</td></tr><tr><td align="left">健康检查</td><td align="left">TCP/HTTP/MYSQL/Client Beat</td><td align="left">Client Beat</td><td align="left">TCP/HTTP/gRPC/Cmd</td><td align="left">—</td><td align="left">Keep Alive</td></tr><tr><td align="left">负载均衡策略</td><td align="left">权重/ metadata/Selector</td><td align="left">Ribbon</td><td align="left">Fabio</td><td align="left">RoundRobin</td><td align="left">—</td></tr><tr><td align="left">雪崩保护</td><td align="left">有</td><td align="left">有</td><td align="left">无</td><td align="left">无</td><td align="left">无</td></tr><tr><td align="left">自动注销实例</td><td align="left">支持</td><td align="left">支持</td><td align="left">不支持</td><td align="left">不支持</td><td align="left">支持</td></tr><tr><td align="left">访问协议</td><td align="left">HTTP/DNS</td><td align="left">HTTP</td><td align="left">HTTP/DNS</td><td align="left">DNS</td><td align="left">TCP</td></tr><tr><td align="left">监听支持</td><td align="left">支持</td><td align="left">支持</td><td align="left">支持</td><td align="left">不支持</td><td align="left">支持</td></tr><tr><td align="left">多数据中心</td><td align="left">支持</td><td align="left">支持</td><td align="left">支持</td><td align="left">不支持</td><td align="left">不支持</td></tr><tr><td align="left">跨注册中心同步</td><td align="left">支持</td><td align="left">不支持</td><td align="left">支持</td><td align="left">不支持</td><td align="left">不支持</td></tr><tr><td align="left">SpringCloud集成</td><td align="left">支持</td><td align="left">支持</td><td align="left">支持</td><td align="left">不支持</td><td align="left">支持</td></tr><tr><td align="left">Dubbo集成</td><td align="left">支持</td><td align="left">不支持</td><td align="left">不支持</td><td align="left">不支持</td><td align="left">支持</td></tr><tr><td align="left">K8S集成</td><td align="left">支持</td><td align="left">不支持</td><td align="left">支持</td><td align="left">支持</td><td align="left">不支持</td></tr></tbody></table><h1 id="测试目标"><a href="#测试目标" class="headerlink" title="测试目标"></a>测试目标</h1><ol><li>内部服务注册和健康检查</li><li>外部服务注册和健康检查</li></ol><h1 id="测试环境"><a href="#测试环境" class="headerlink" title="测试环境"></a>测试环境</h1><table><thead><tr><th>节点名称</th><th>节点IP</th><th>运行服务</th><th>服务版本</th></tr></thead><tbody><tr><td>consul_server1</td><td>192.168.48.132</td><td>consul、consul-esm</td><td>Consul v1.8.3、consul-esm v0.4.0</td></tr><tr><td>consul_server2</td><td>192.168.48.133</td><td>consul、consul-esm</td><td>Consul v1.8.3、consul-esm v0.4.0</td></tr><tr><td>consul_server3</td><td>192.168.48.134</td><td>consul、consul-esm</td><td>Consul v1.8.3、consul-esm v0.4.0</td></tr><tr><td>consul_client1</td><td>192.168.48.135</td><td>consul_client</td><td>Consul v1.8.3</td></tr><tr><td>consul_client2</td><td>192.168.48.131</td><td>consul_client</td><td>Consul v1.8.3</td></tr></tbody></table><h2 id="Consul-集群配置"><a href="#Consul-集群配置" class="headerlink" title="Consul 集群配置"></a>Consul 集群配置</h2><p>consul server</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">$ cat consul_server.json </span><br><span class="line">&#123;</span><br><span class="line">    &quot;datacenter&quot;: &quot;dc1&quot;,</span><br><span class="line">    &quot;data_dir&quot;: &quot;/work/admin/consul&quot;,</span><br><span class="line">    &quot;log_level&quot;: &quot;INFO&quot;,</span><br><span class="line">    &quot;node_name&quot;: &quot;consul_server3&quot;,</span><br><span class="line">    &quot;server&quot;: true,</span><br><span class="line">    &quot;ui&quot;: true,</span><br><span class="line">    &quot;bootstrap_expect&quot;: 3,</span><br><span class="line">    &quot;bind_addr&quot;: &quot;192.168.48.134&quot;,</span><br><span class="line">    &quot;client_addr&quot;: &quot;0.0.0.0&quot;,</span><br><span class="line">    &quot;retry_join&quot;: [&quot;192.168.48.132:8301&quot;,&quot;192.168.48.133:8301&quot;],</span><br><span class="line">    &quot;retry_interval&quot;: &quot;3s&quot;,</span><br><span class="line">    &quot;raft_protocol&quot;: 3,</span><br><span class="line">    &quot;enable_debug&quot;: false,</span><br><span class="line">    &quot;rejoin_after_leave&quot;: true,</span><br><span class="line">    &quot;enable_syslog&quot;: false,</span><br><span class="line">    &quot;discovery_max_stale&quot;: &quot;10s&quot;,</span><br><span class="line">    &quot;ports&quot;: &#123;</span><br><span class="line">        &quot;http&quot;: 8500,</span><br><span class="line">        &quot;dns&quot;: 8600,</span><br><span class="line">        &quot;serf_lan&quot;: 8301,</span><br><span class="line">        &quot;serf_wan&quot;: 8302,</span><br><span class="line">        &quot;server&quot;: 8300</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>consul-esm</p><p>无需配置，在server服务器上启动服务即可</p><p>consul client</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">cat consul_client.json </span><br><span class="line">&#123;</span><br><span class="line">    &quot;datacenter&quot;: &quot;dc1&quot;,</span><br><span class="line">    &quot;data_dir&quot;: &quot;/work/admin/consul/data&quot;,</span><br><span class="line">    &quot;log_level&quot;: &quot;INFO&quot;,</span><br><span class="line">    &quot;node_name&quot;: &quot;client2&quot;, </span><br><span class="line">    &quot;server&quot;: false, </span><br><span class="line">    &quot;ui&quot;: true,</span><br><span class="line">    &quot;bootstrap_expect&quot;: 0,</span><br><span class="line">    &quot;bind_addr&quot;: &quot;192.168.48.131&quot;,</span><br><span class="line">    &quot;client_addr&quot;: &quot;0.0.0.0&quot;,</span><br><span class="line">    &quot;retry_join&quot;: [&quot;192.168.48.132:8301&quot;,&quot;192.168.48.133:8301&quot;,&quot;192.168.48.134:8301&quot;],</span><br><span class="line">    &quot;retry_interval&quot;: &quot;5s&quot;,</span><br><span class="line">    &quot;raft_protocol&quot;: 3,</span><br><span class="line">    &quot;enable_debug&quot;: false,</span><br><span class="line">    &quot;rejoin_after_leave&quot;: true,</span><br><span class="line">    &quot;enable_syslog&quot;: false,</span><br><span class="line">    &quot;discovery_max_stale&quot;: &quot;10s&quot;,</span><br><span class="line">    &quot;performance&quot;: &#123;</span><br><span class="line">    &quot;raft_multiplier&quot;: 2</span><br><span class="line">  &#125;,</span><br><span class="line">    &quot;ports&quot;: &#123;</span><br><span class="line">      &quot;http&quot;: 8505,</span><br><span class="line">      &quot;dns&quot;: 8605,</span><br><span class="line">      &quot;serf_lan&quot;: 8351,</span><br><span class="line">      &quot;serf_wan&quot;: 8352,</span><br><span class="line">      &quot;server&quot;: 8350</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="测试过程"><a href="#测试过程" class="headerlink" title="测试过程"></a>测试过程</h1><h2 id="内部服务注册"><a href="#内部服务注册" class="headerlink" title="内部服务注册"></a>内部服务注册</h2><p>在Consul的上下文中，内部服务是由Consul代理可以直接运行的节点(机器)提供的。</p><p>内部服务通过服务定义注册。服务定义可以由Consul代理启动时加载的配置文件提供，也可以通过<a href="https://www.consul.io/api/agent/service.html#register-service" target="_blank" rel="noopener">/agent/service/register</a>的本地HTTP API端点提供。</p><h3 id="服务注册"><a href="#服务注册" class="headerlink" title="服务注册"></a>服务注册</h3><p>我们将用以下配置注册一个内部web示例，<strong>web.json</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;id&quot;: &quot;web1&quot;,</span><br><span class="line">    &quot;name&quot;: &quot;web&quot;,</span><br><span class="line">    &quot;address&quot;: &quot;192.168.48.134&quot;,</span><br><span class="line">    &quot;port&quot;: 8080,</span><br><span class="line">    &quot;tags&quot;: [&quot;test&quot;],</span><br><span class="line">    &quot;checks&quot;: [</span><br><span class="line">      &#123;&quot;http&quot;: &quot;http://192.168.48.134:8080/&quot;,</span><br><span class="line">      &quot;interval&quot;: &quot;3s&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这个示例web服务将具有惟一的id <strong>web1</strong>、逻辑名称<strong>web</strong>、运行在端口<strong>80</strong>上并每隔3秒进行一次健康检查。</p><p>通过使用PUT请求调用HTTP API来注册示例web服务</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ curl --request PUT --data @web.json 192.168.48.135:8505/v1/agent/service/register</span><br></pre></td></tr></table></figure><p>要验证示例web服务已注册上去，请查询<a href="https://www.consul.io/api/catalog.html#list-nodes-for-service" target="_blank" rel="noopener">/catalog/service/:service</a> 端点</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">$ curl 192.168.48.135:8505/v1/agent/checks</span><br><span class="line">&#123;</span><br><span class="line">	&quot;service:web1&quot;: &#123;</span><br><span class="line">		&quot;Node&quot;: &quot;client1&quot;,</span><br><span class="line">		&quot;CheckID&quot;: &quot;service:web1&quot;,</span><br><span class="line">		&quot;Name&quot;: &quot;Service &apos;web&apos; check&quot;,</span><br><span class="line">		&quot;Status&quot;: &quot;passing&quot;,</span><br><span class="line">		&quot;Notes&quot;: &quot;&quot;,</span><br><span class="line">		&quot;Output&quot;: &quot;HTTP GET http://192.168.48.134:8080/: 200 OK Output: \u003c!DOCTYPE html\u003e\n\u003chtml\u003e\n\u003chead\u003e\n\u003ctitle\u003eWelcome to nginx!\u003c/title\u003e\n\u003cstyle\u003e\n    body &#123;\n        width: 35em;\n        margin: 0 auto;\n        font-family: Tahoma, Verdana, Arial, sans-serif;\n    &#125;\n\u003c/style\u003e\n\u003c/head\u003e\n\u003cbody\u003e\n\u003ch1\u003eWelcome to nginx!\u003c/h1\u003e\n\u003cp\u003eIf you see this page, the nginx web server is successfully installed and\nworking. Further configuration is required.\u003c/p\u003e\n\n\u003cp\u003eFor online documentation and support please refer to\n\u003ca href=\&quot;http://nginx.org/\&quot;\u003enginx.org\u003c/a\u003e.\u003cbr/\u003e\nCommercial support is available at\n\u003ca href=\&quot;http://nginx.com/\&quot;\u003enginx.com\u003c/a\u003e.\u003c/p\u003e\n\n\u003cp\u003e\u003cem\u003eThank you for using nginx.\u003c/em\u003e\u003c/p\u003e\n\u003c/body\u003e\n\u003c/html\u003e\n&quot;,</span><br><span class="line">		&quot;ServiceID&quot;: &quot;web1&quot;,</span><br><span class="line">		&quot;ServiceName&quot;: &quot;web&quot;,</span><br><span class="line">		&quot;ServiceTags&quot;: [&quot;test&quot;],</span><br><span class="line">		&quot;Type&quot;: &quot;http&quot;,</span><br><span class="line">		&quot;Definition&quot;: &#123;&#125;,</span><br><span class="line">		&quot;CreateIndex&quot;: 0,</span><br><span class="line">		&quot;ModifyIndex&quot;: 0</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="服务发现"><a href="#服务发现" class="headerlink" title="服务发现"></a>服务发现</h3><p>可以在任意一台consul服务上通过dns查询创建的web服务</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">$ dig @192.168.48.131 -p 8605 web.service.consul dc1</span><br><span class="line"></span><br><span class="line">; &lt;&lt;&gt;&gt; DiG 9.11.4-P2-RedHat-9.11.4-16.P2.el7_8.6 &lt;&lt;&gt;&gt; @localhost -p 8600 web.service.consul dc1</span><br><span class="line">; (2 servers found)</span><br><span class="line">;; global options: +cmd</span><br><span class="line">;; Got answer:</span><br><span class="line">;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 5100</span><br><span class="line">;; flags: qr aa rd; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1</span><br><span class="line">;; WARNING: recursion requested but not available</span><br><span class="line"></span><br><span class="line">;; OPT PSEUDOSECTION:</span><br><span class="line">; EDNS: version: 0, flags:; udp: 4096</span><br><span class="line">;; QUESTION SECTION:</span><br><span class="line">;web.service.consul.		IN	A</span><br><span class="line"></span><br><span class="line">;; ANSWER SECTION:</span><br><span class="line">web.service.consul.	0	IN	A	192.168.48.134</span><br><span class="line"></span><br><span class="line">;; Query time: 1 msec</span><br><span class="line">;; SERVER: ::1#8600(::1)</span><br><span class="line">;; WHEN: Mon Sep 14 22:28:30 CST 2020</span><br><span class="line">;; MSG SIZE  rcvd: 63</span><br><span class="line"></span><br><span class="line">;; Got answer:</span><br><span class="line">;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: SERVFAIL, id: 1828</span><br><span class="line">;; flags: qr rd; QUERY: 1, ANSWER: 0, AUTHORITY: 0, ADDITIONAL: 0</span><br><span class="line">;; WARNING: recursion requested but not available</span><br><span class="line"></span><br><span class="line">;; QUESTION SECTION:</span><br><span class="line">;dc1.				IN	A</span><br><span class="line"></span><br><span class="line">;; Query time: 0 msec</span><br><span class="line">;; SERVER: ::1#8600(::1)</span><br><span class="line">;; WHEN: Mon Sep 14 22:28:30 CST 2020</span><br><span class="line">;; MSG SIZE  rcvd: 21</span><br></pre></td></tr></table></figure><p>当服务健康检测正常时可查询到类似如下信息，便是web服务的地址了</p><blockquote><p>web.service.consul. 0 IN A 192.168.48.134</p></blockquote><h3 id="模拟consul集群故障"><a href="#模拟consul集群故障" class="headerlink" title="模拟consul集群故障"></a>模拟consul集群故障</h3><h4 id="模拟server节点故障"><a href="#模拟server节点故障" class="headerlink" title="模拟server节点故障"></a>模拟server节点故障</h4><p>关闭server leader节点后，剩余server节点会进行leader选举，期间集群会短暂的无法提供服务，以下是重新选举的leader节点</p><p><img src="/2020/09/17/consul-zhu-ce-zhong-xin-ce-shi/%E5%9B%BE%E7%89%871.png" alt="图片1"></p><p>查询web服务</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">$ dig @192.168.48.131 -p 8605 web.service.consul dc1</span><br><span class="line"></span><br><span class="line">; &lt;&lt;&gt;&gt; DiG 9.11.4-P2-RedHat-9.11.4-16.P2.el7_8.6 &lt;&lt;&gt;&gt; @192.168.48.131 -p 8605 web.service.consul dc1</span><br><span class="line">; (1 server found)</span><br><span class="line">;; global options: +cmd</span><br><span class="line">;; Got answer:</span><br><span class="line">;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 1001</span><br><span class="line">;; flags: qr aa rd; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1</span><br><span class="line">;; WARNING: recursion requested but not available</span><br><span class="line"></span><br><span class="line">;; OPT PSEUDOSECTION:</span><br><span class="line">; EDNS: version: 0, flags:; udp: 4096</span><br><span class="line">;; QUESTION SECTION:</span><br><span class="line">;web.service.consul.		IN	A</span><br><span class="line"></span><br><span class="line">;; ANSWER SECTION:</span><br><span class="line">web.service.consul.	0	IN	A	192.168.48.134</span><br><span class="line"></span><br><span class="line">;; Query time: 26 msec</span><br><span class="line">;; SERVER: 192.168.48.131#8605(192.168.48.131)</span><br><span class="line">;; WHEN: Mon Sep 14 22:58:30 CST 2020</span><br><span class="line">;; MSG SIZE  rcvd: 63</span><br><span class="line"></span><br><span class="line">;; Got answer:</span><br><span class="line">;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: SERVFAIL, id: 19177</span><br><span class="line">;; flags: qr rd; QUERY: 1, ANSWER: 0, AUTHORITY: 0, ADDITIONAL: 0</span><br><span class="line">;; WARNING: recursion requested but not available</span><br><span class="line"></span><br><span class="line">;; QUESTION SECTION:</span><br><span class="line">;dc1.				IN	A</span><br><span class="line"></span><br><span class="line">;; Query time: 0 msec</span><br><span class="line">;; SERVER: 192.168.48.131#8605(192.168.48.131)</span><br><span class="line">;; WHEN: Mon Sep 14 22:58:30 CST 2020</span><br><span class="line">;; MSG SIZE  rcvd: 21</span><br></pre></td></tr></table></figure><p>此时可以正常进行查询，可见当server节点故障后consule集群依然可以正常提供服务</p><h4 id="模拟client节点故障"><a href="#模拟client节点故障" class="headerlink" title="模拟client节点故障"></a>模拟client节点故障</h4><p>client1故障前</p><p><img src="/2020/09/17/consul-zhu-ce-zhong-xin-ce-shi/%E5%9B%BE%E7%89%872.png" alt="图片2"></p><p>关闭client1节点后，发现通过client1注册的web服务也不存在</p><p>client1故障后</p><p><img src="/2020/09/17/consul-zhu-ce-zhong-xin-ce-shi/%E5%9B%BE%E7%89%873.png" alt="图片3"></p><p>再次通过client2节点进行查询</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">$ dig @192.168.48.131 -p 8605 web.service.consul dc1</span><br><span class="line"></span><br><span class="line">; &lt;&lt;&gt;&gt; DiG 9.11.4-P2-RedHat-9.11.4-16.P2.el7_8.6 &lt;&lt;&gt;&gt; @192.168.48.131 -p 8605 web.service.consul dc1</span><br><span class="line">; (1 server found)</span><br><span class="line">;; global options: +cmd</span><br><span class="line">;; Got answer:</span><br><span class="line">;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NXDOMAIN, id: 56631</span><br><span class="line">;; flags: qr aa rd; QUERY: 1, ANSWER: 0, AUTHORITY: 1, ADDITIONAL: 1</span><br><span class="line">;; WARNING: recursion requested but not available</span><br><span class="line"></span><br><span class="line">;; OPT PSEUDOSECTION:</span><br><span class="line">; EDNS: version: 0, flags:; udp: 4096</span><br><span class="line">;; QUESTION SECTION:</span><br><span class="line">;web.service.consul.		IN	A</span><br><span class="line"></span><br><span class="line">;; AUTHORITY SECTION:</span><br><span class="line">consul.			0	IN	SOA	ns.consul. hostmaster.consul. 1600095948 3600 600 86400 0</span><br><span class="line"></span><br><span class="line">;; Query time: 5 msec</span><br><span class="line">;; SERVER: 192.168.48.131#8605(192.168.48.131)</span><br><span class="line">;; WHEN: Mon Sep 14 23:05:46 CST 2020</span><br><span class="line">;; MSG SIZE  rcvd: 97</span><br><span class="line"></span><br><span class="line">;; Got answer:</span><br><span class="line">;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: SERVFAIL, id: 35885</span><br><span class="line">;; flags: qr rd; QUERY: 1, ANSWER: 0, AUTHORITY: 0, ADDITIONAL: 0</span><br><span class="line">;; WARNING: recursion requested but not available</span><br><span class="line"></span><br><span class="line">;; QUESTION SECTION:</span><br><span class="line">;dc1.				IN	A</span><br><span class="line"></span><br><span class="line">;; Query time: 1 msec</span><br><span class="line">;; SERVER: 192.168.48.131#8605(192.168.48.131)</span><br><span class="line">;; WHEN: Mon Sep 14 23:05:46 CST 2020</span><br><span class="line">;; MSG SIZE  rcvd: 21</span><br></pre></td></tr></table></figure><p>此时consul集群中查询不到web服务，当前环境中通过内部服务注册方式注册该web服务到client1节点，此时client1节点负责对此web服务进行健康检测，当client1故障时注册到该节点的服务在consul集群中也会随即失联。</p><h3 id="服务剔除"><a href="#服务剔除" class="headerlink" title="服务剔除"></a>服务剔除</h3><p>通过内部服务注册到client后，client会对注册的服务进行健康检测并将结果传递给leader，由leader只对健康检测通过的服务进行解析。</p><p>以下两种方式都可以实现</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ curl --request PUT http://192.168.48.135:8505/v1/agent/service/deregister/web1</span><br><span class="line">$ curl -XPUT http://192.168.48.133:8500/v1/agent/service/deregister/web1</span><br></pre></td></tr></table></figure><p><strong>注：</strong>通过内部服务注册到client1后只能通过client1进行删除。</p><h2 id="外部服务注册"><a href="#外部服务注册" class="headerlink" title="外部服务注册"></a>外部服务注册</h2><p>在Consul的上下文中，外部服务是由不能运行Consul代理的节点提供的服务。这些节点可能位于基础设施内部(例如大型机、虚拟设备或不支持的平台)或基础设施外部(例如SaaS平台)。</p><p>因为根据定义，外部服务在没有运行Consul代理的节点上运行，因此无法向本地代理注册。相反，它们必须使用<a href="https://www.consul.io/api/catalog.html#register-entity" target="_blank" rel="noopener">/catalog/register</a>端点 直接与目录一起注册。这个端点的对象上下文是节点，而不是像/agent/service/register 端点那样的服务。当使用/catalog/register端点时，将注册整个节点。而使用/agent/service/register 端点(这是我们在上面的第一个例子中使用的端点)，本地节点上下文中的单个服务被注册。</p><p>直接通过目录注册的外部服务的配置与通过代理注册的内部服务的配置略有不同:</p><ul><li><a href="https://www.hashicorp.com/blog/consul-and-external-services#node" target="_blank" rel="noopener">节点</a>（<strong>Node</strong>）和<strong>地址(Address)</strong>都是必需的，因为它们不能从本地节点Consul代理自动确定。</li><li>服务(<strong>Service</strong>)和健康检查(<strong>Checks</strong>)是分开定义的。</li><li>如果提供的<strong>ServiceID</strong>与该节点上的服务<strong>ID</strong>匹配，则该检查将被视为服务级健康检查，而不是节点级健康检查。</li><li>可以为<strong>Definition</strong> 字段提供TCP或HTTP健康检查的详细信息。有关更多信息，请参阅<a href="https://www.consul.io/docs/agent/checks.html" target="_blank" rel="noopener">健康检查</a>。</li></ul><h3 id="使用Consul-ESM监控外部服务"><a href="#使用Consul-ESM监控外部服务" class="headerlink" title="使用Consul ESM监控外部服务"></a>使用Consul ESM监控外部服务</h3><p><a href="https://github.com/hashicorp/consul-esm" target="_blank" rel="noopener">Consul ESM</a>是一个与Consul一起运行的守护进程，用于运行外部节点的健康检查并更新目录中那些健康检查的状态。ESM的多个实例可以运行以获得可用性，并且ESM将通过持有一个Consul中的锁来执行领导人选举。然后，领导者将继续监视Consul对目录的更新，并执行在它发现的任何外部节点上定义的健康检查。这允许外部注册的服务和检查访问与Consul代理在本地注册相同的功能。</p><p>Consul ESM是作为一个单一的二进制文件提供的。要安装，请下载适合的<a href="https://releases.hashicorp.com/consul-esm/" target="_blank" rel="noopener">版本</a>。</p><p>在所有consul server服务器上，执行 <strong>consul-esm</strong>启用Consul ESM</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">$ consul-esm </span><br><span class="line">2020/09/15 00:38:25 [INFO] Connecting to Consul on 127.0.0.1:8500...</span><br><span class="line">Consul ESM running!</span><br><span class="line">            Datacenter: (default)</span><br><span class="line">               Service: &quot;consul-esm&quot;</span><br><span class="line">           Service Tag: &quot;&quot;</span><br><span class="line">            Service ID: &quot;consul-esm:17053d33-1783-d99e-8b73-59bfda2b1321&quot;</span><br><span class="line">Node Reconnect Timeout: &quot;72h0m0s&quot;</span><br><span class="line">   Disable coordinates: false</span><br><span class="line"></span><br><span class="line">Log data will now stream in as it occurs:</span><br><span class="line"></span><br><span class="line">2020/09/15 00:38:25 [INFO] Trying to obtain leadership...</span><br><span class="line">2020/09/15 00:38:25 [INFO] Fetched 1 nodes from catalog</span><br><span class="line">2020/09/15 00:38:25 [INFO] Updated 1 checks, found 1, added 1, updated 0, removed 0</span><br><span class="line">2020/09/15 00:38:25 [INFO] Now managing 1 health checks across 1 nodes</span><br></pre></td></tr></table></figure><p>如果您的internet提供者不允许UDP ping，为了使本文中的示例正常工作，您可能需要在配置文件中设置<strong>ping_type = “socket”</strong>，并使用该配置文件启动<strong>consult -esm</strong>。如果你正在使用macOS，你将需要执行<strong>sudo</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo consul-esm -config-file=./consul-esm.hcl</span><br></pre></td></tr></table></figure><p>示例外部服务定义中包含以下节点元数据（NodeMeta），这些元数据使Consul ESM能够进行健康监视:</p><ul><li><p>“<a href="https://www.hashicorp.com/blog/consul-and-external-services#quot-external-node-quot-" target="_blank" rel="noopener">external-node</a>”标识该节点是Consul ESM应该监视的外部节点。</p></li><li><p><a href="https://www.hashicorp.com/blog/consul-and-external-services#quot-external-probe-quot-quot-true-quot-" target="_blank" rel="noopener">“external-probe”:“true”</a>告诉Consul ESM定期对节点执行ping，并维护节点的外部节点健康检查(类似于Consul代理使用的serfHealth检查)。</p></li></ul><h3 id="服务注册-1"><a href="#服务注册-1" class="headerlink" title="服务注册"></a>服务注册</h3><p>要演示外部服务注册是如何工作的，请考虑谷歌提供的外部搜索服务。我们用以下配置来注册这个服务，<strong>web3.json</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;Node&quot;: &quot;test_web&quot;,</span><br><span class="line">  &quot;Address&quot;: &quot;192.168.48.134&quot;,</span><br><span class="line">  &quot;NodeMeta&quot;: &#123;</span><br><span class="line">    &quot;external-node&quot;: &quot;true&quot;,</span><br><span class="line">    &quot;external-probe&quot;: &quot;true&quot;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;Service&quot;: &#123;</span><br><span class="line">    &quot;ID&quot;: &quot;search3&quot;,</span><br><span class="line">    &quot;Service&quot;: &quot;web3&quot;, </span><br><span class="line">    &quot;Port&quot;: 8080</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;Checks&quot;: [&#123;</span><br><span class="line">    &quot;Name&quot;: &quot;http-check&quot;,</span><br><span class="line">    &quot;status&quot;: &quot;passing&quot;,</span><br><span class="line">    &quot;Definition&quot;: &#123;</span><br><span class="line">      &quot;http&quot;: &quot;http://192.168.48.134:8080&quot;,</span><br><span class="line">      &quot;interval&quot;: &quot;3s&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>该配置定义了一个名为<strong>test_web</strong> 的节点，可以在地址<strong>192.168.48.134</strong>上访问，该节点提供一个<strong>web3</strong>服务，ID为<strong>search3</strong>，运行在端口<strong>8080</strong>上。它还定义了每3秒运行一次的http类型健康检查，并设置了该检查的初始状态 <strong>passing</strong>。</p><p>通常，外部服务是通过专门用于此目的的节点注册的，因此我们将继续使用Consul dev代理(localhost)进行示例，就好像它是在和内部web服务(例如“Web”)不同的另一个节点（例如“External Services”）上运行一样。</p><p>使用PUT请求注册外部服务</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ curl --request PUT --data @web3.json 192.168.48.135:8505/v1/catalog/register</span><br><span class="line">true</span><br></pre></td></tr></table></figure><p>与通过代理端点注册的内部服务一样，我们可以通过查询/catalog/service/:service 端点来验证外部服务的注册</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">$ curl 192.168.48.135:8505/v1/catalog/service/web3</span><br><span class="line">[&#123;</span><br><span class="line">	&quot;ID&quot;: &quot;&quot;,</span><br><span class="line">	&quot;Node&quot;: &quot;test_web&quot;,</span><br><span class="line">	&quot;Address&quot;: &quot;192.168.48.134&quot;,</span><br><span class="line">	&quot;Datacenter&quot;: &quot;dc1&quot;,</span><br><span class="line">	&quot;TaggedAddresses&quot;: null,</span><br><span class="line">	&quot;NodeMeta&quot;: &#123;</span><br><span class="line">		&quot;external-node&quot;: &quot;true&quot;,</span><br><span class="line">		&quot;external-probe&quot;: &quot;true&quot;</span><br><span class="line">	&#125;,</span><br><span class="line">	&quot;ServiceKind&quot;: &quot;&quot;,</span><br><span class="line">	&quot;ServiceID&quot;: &quot;search3&quot;,</span><br><span class="line">	&quot;ServiceName&quot;: &quot;web3&quot;,</span><br><span class="line">	&quot;ServiceTags&quot;: [],</span><br><span class="line">	&quot;ServiceAddress&quot;: &quot;&quot;,</span><br><span class="line">	&quot;ServiceWeights&quot;: &#123;</span><br><span class="line">		&quot;Passing&quot;: 1,</span><br><span class="line">		&quot;Warning&quot;: 1</span><br><span class="line">	&#125;,</span><br><span class="line">	&quot;ServiceMeta&quot;: &#123;&#125;,</span><br><span class="line">	&quot;ServicePort&quot;: 8080,</span><br><span class="line">	&quot;ServiceEnableTagOverride&quot;: false,</span><br><span class="line">	&quot;ServiceProxy&quot;: &#123;</span><br><span class="line">		&quot;MeshGateway&quot;: &#123;&#125;,</span><br><span class="line">		&quot;Expose&quot;: &#123;&#125;</span><br><span class="line">	&#125;,</span><br><span class="line">	&quot;ServiceConnect&quot;: &#123;&#125;,</span><br><span class="line">	&quot;CreateIndex&quot;: 2921,</span><br><span class="line">	&quot;ModifyIndex&quot;: 2921</span><br><span class="line">&#125;]</span><br></pre></td></tr></table></figure><p>在我们的内部web服务示例中，我们通过查询本地代理端点 /agent/checks 来验证健康检查是活跃的。如果在添加外部服务之后再次查询此内容，我们将不会看到列出的健康检查，因为它是在服务目录中注册的，而不是本地代理。相反，我们需要查询目录级端点，例如/health/service/:service、/health/node/:node、/health/state/:state。</p><p>我们还可以看到Consul UI中列出的服务和健康检查</p><p><img src="/2020/09/17/consul-zhu-ce-zhong-xin-ce-shi/%E5%9B%BE%E7%89%874.png" alt="图片4"></p><h3 id="服务发现-1"><a href="#服务发现-1" class="headerlink" title="服务发现"></a>服务发现</h3><p>可以在任意一台consul服务上通过dns查询创建的web服务</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">$ dig @192.168.48.135 -p 8605 web3.service.consul dc1</span><br><span class="line"></span><br><span class="line">; &lt;&lt;&gt;&gt; DiG 9.11.4-P2-RedHat-9.11.4-16.P2.el7_8.6 &lt;&lt;&gt;&gt; @192.168.48.135 -p 8605 web3.service.consul dc1</span><br><span class="line">; (1 server found)</span><br><span class="line">;; global options: +cmd</span><br><span class="line">;; Got answer:</span><br><span class="line">;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 58720</span><br><span class="line">;; flags: qr aa rd; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1</span><br><span class="line">;; WARNING: recursion requested but not available</span><br><span class="line"></span><br><span class="line">;; OPT PSEUDOSECTION:</span><br><span class="line">; EDNS: version: 0, flags:; udp: 4096</span><br><span class="line">;; QUESTION SECTION:</span><br><span class="line">;web3.service.consul.		IN	A</span><br><span class="line"></span><br><span class="line">;; ANSWER SECTION:</span><br><span class="line">web3.service.consul.	0	IN	A	192.168.48.134</span><br><span class="line"></span><br><span class="line">;; Query time: 13 msec</span><br><span class="line">;; SERVER: 192.168.48.135#8605(192.168.48.135)</span><br><span class="line">;; WHEN: Tue Sep 15 00:34:18 CST 2020</span><br><span class="line">;; MSG SIZE  rcvd: 64</span><br><span class="line"></span><br><span class="line">;; Got answer:</span><br><span class="line">;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: SERVFAIL, id: 41235</span><br><span class="line">;; flags: qr rd; QUERY: 1, ANSWER: 0, AUTHORITY: 0, ADDITIONAL: 0</span><br><span class="line">;; WARNING: recursion requested but not available</span><br><span class="line"></span><br><span class="line">;; QUESTION SECTION:</span><br><span class="line">;dc1.				IN	A</span><br><span class="line"></span><br><span class="line">;; Query time: 0 msec</span><br><span class="line">;; SERVER: 192.168.48.135#8605(192.168.48.135)</span><br><span class="line">;; WHEN: Tue Sep 15 00:34:18 CST 2020</span><br><span class="line">;; MSG SIZE  rcvd: 21</span><br></pre></td></tr></table></figure><p>当服务健康检测正常时可查询到类似如下信息，便是web服务的地址了</p><blockquote><p>web3.service.consul. 0 IN A 192.168.48.134</p></blockquote><h3 id="模拟consul集群故障-1"><a href="#模拟consul集群故障-1" class="headerlink" title="模拟consul集群故障"></a>模拟consul集群故障</h3><h4 id="模拟server节点故障-1"><a href="#模拟server节点故障-1" class="headerlink" title="模拟server节点故障"></a>模拟server节点故障</h4><p>关闭server leader节点后，剩余server节点会进行leader选举，期间集群会短暂的无法提供服务，以下是重新选举的leader节点</p><p><img src="/2020/09/17/consul-zhu-ce-zhong-xin-ce-shi/%E5%9B%BE%E7%89%875.png" alt="图片5"></p><p>查询web服务</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">$ dig @192.168.48.131 -p 8605 web3.service.consul dc1</span><br><span class="line"></span><br><span class="line">; &lt;&lt;&gt;&gt; DiG 9.11.4-P2-RedHat-9.11.4-16.P2.el7_8.6 &lt;&lt;&gt;&gt; @192.168.48.131 -p 8605 web3.service.consul dc1</span><br><span class="line">; (1 server found)</span><br><span class="line">;; global options: +cmd</span><br><span class="line">;; Got answer:</span><br><span class="line">;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 48205</span><br><span class="line">;; flags: qr aa rd; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1</span><br><span class="line">;; WARNING: recursion requested but not available</span><br><span class="line"></span><br><span class="line">;; OPT PSEUDOSECTION:</span><br><span class="line">; EDNS: version: 0, flags:; udp: 4096</span><br><span class="line">;; QUESTION SECTION:</span><br><span class="line">;web3.service.consul.		IN	A</span><br><span class="line"></span><br><span class="line">;; ANSWER SECTION:</span><br><span class="line">web3.service.consul.	0	IN	A	192.168.48.134</span><br><span class="line"></span><br><span class="line">;; Query time: 5 msec</span><br><span class="line">;; SERVER: 192.168.48.131#8605(192.168.48.131)</span><br><span class="line">;; WHEN: Tue Sep 15 00:59:27 CST 2020</span><br><span class="line">;; MSG SIZE  rcvd: 64</span><br><span class="line"></span><br><span class="line">;; Got answer:</span><br><span class="line">;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: SERVFAIL, id: 11610</span><br><span class="line">;; flags: qr rd; QUERY: 1, ANSWER: 0, AUTHORITY: 0, ADDITIONAL: 0</span><br><span class="line">;; WARNING: recursion requested but not available</span><br><span class="line"></span><br><span class="line">;; QUESTION SECTION:</span><br><span class="line">;dc1.				IN	A</span><br><span class="line"></span><br><span class="line">;; Query time: 0 msec</span><br><span class="line">;; SERVER: 192.168.48.131#8605(192.168.48.131)</span><br><span class="line">;; WHEN: Tue Sep 15 00:59:27 CST 2020</span><br><span class="line">;; MSG SIZE  rcvd: 21</span><br></pre></td></tr></table></figure><p>此时可以正常进行查询，可见当server节点故障后consule集群依然可以正常提供服务</p><h4 id="模拟client节点故障-1"><a href="#模拟client节点故障-1" class="headerlink" title="模拟client节点故障"></a>模拟client节点故障</h4><p>由于web3服务使用了外部服务注册方式进行服务注册，我们将现有的两台client节点全部下线</p><p>client节点故障前</p><p><img src="/2020/09/17/consul-zhu-ce-zhong-xin-ce-shi/%E5%9B%BE%E7%89%875.png" alt="图片6"></p><p>client节点故障后</p><p><img src="/2020/09/17/consul-zhu-ce-zhong-xin-ce-shi/%E5%9B%BE%E7%89%876.png" alt="图片7"></p><p>再次查询web3服务，由于两台client都无法提供服务我们通过其中一台server进行查询</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">$ dig @192.168.48.134 -p 8600 web3.service.consul dc1</span><br><span class="line"></span><br><span class="line">; &lt;&lt;&gt;&gt; DiG 9.11.4-P2-RedHat-9.11.4-16.P2.el7_8.6 &lt;&lt;&gt;&gt; @192.168.48.134 -p 8600 web3.service.consul dc1</span><br><span class="line">; (1 server found)</span><br><span class="line">;; global options: +cmd</span><br><span class="line">;; Got answer:</span><br><span class="line">;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 57744</span><br><span class="line">;; flags: qr aa rd; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1</span><br><span class="line">;; WARNING: recursion requested but not available</span><br><span class="line"></span><br><span class="line">;; OPT PSEUDOSECTION:</span><br><span class="line">; EDNS: version: 0, flags:; udp: 4096</span><br><span class="line">;; QUESTION SECTION:</span><br><span class="line">;web3.service.consul.		IN	A</span><br><span class="line"></span><br><span class="line">;; ANSWER SECTION:</span><br><span class="line">web3.service.consul.	0	IN	A	192.168.48.134</span><br><span class="line"></span><br><span class="line">;; Query time: 0 msec</span><br><span class="line">;; SERVER: 192.168.48.134#8600(192.168.48.134)</span><br><span class="line">;; WHEN: Tue Sep 15 01:06:06 CST 2020</span><br><span class="line">;; MSG SIZE  rcvd: 64</span><br><span class="line"></span><br><span class="line">;; Got answer:</span><br><span class="line">;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: SERVFAIL, id: 18607</span><br><span class="line">;; flags: qr rd; QUERY: 1, ANSWER: 0, AUTHORITY: 0, ADDITIONAL: 0</span><br><span class="line">;; WARNING: recursion requested but not available</span><br><span class="line"></span><br><span class="line">;; QUESTION SECTION:</span><br><span class="line">;dc1.				IN	A</span><br><span class="line"></span><br><span class="line">;; Query time: 0 msec</span><br><span class="line">;; SERVER: 192.168.48.134#8600(192.168.48.134)</span><br><span class="line">;; WHEN: Tue Sep 15 01:06:06 CST 2020</span><br><span class="line">;; MSG SIZE  rcvd: 21</span><br></pre></td></tr></table></figure><p>此时consul集群依然可以正常查询到web3服务，当前环境中由于使用了外部服务注册方式，服务直接注册为目录(节点)；由consul-esm对服务进行健康检测，这样即解耦了服务和consul client的绑定关系又可规避因consul client故障时带来的服务发现问题。</p><h3 id="服务剔除-1"><a href="#服务剔除-1" class="headerlink" title="服务剔除"></a>服务剔除</h3><p>通过上图可以发现，外部服务注册后服务最终落在了Nodes栏，可以在任意节点对node进行剔除。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ curl -X PUT -H &apos;application/json&apos; -d &apos;&#123;&quot;Datacenter&quot;: &quot;dcNode&quot;: &quot;test_web&quot;&#125;&apos; http://127.0.0.1:8500/v1/catalog/deregister</span><br></pre></td></tr></table></figure></div><div><div><div style="text-align:center;color:#ccc;font-size:14px">-------------本文结束<i class="fa fa-paw"></i>感谢您的阅读-------------</div></div></div><div></div><footer class="post-footer"><div class="post-tags"><a href="/tags/%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83/" rel="tag"><i class="fa fa-tag"></i> 注册中心</a><a href="/tags/Consul/" rel="tag"><i class="fa fa-tag"></i> Consul</a></div><div class="post-nav"><div class="post-nav-next post-nav-item"><a href="/2020/08/21/xxl-job-ren-wu-diao-du-ping-tai-bu-shu/" rel="next" title="XXL-JOB 任务调度平台部署"><i class="fa fa-chevron-left"></i> XXL-JOB 任务调度平台部署</a></div><span class="post-nav-divider"></span><div class="post-nav-prev post-nav-item"><a href="/2020/10/22/openldap-bian-yi-bu-shu/" rel="prev" title="OpenLDAP 部署">OpenLDAP 部署<i class="fa fa-chevron-right"></i></a></div></div></footer></div></article><div class="post-spread"><div class="jiathis_style"><span class="jiathis_txt">分享到：</span> <a class="jiathis_button_fav">收藏夹</a> <a class="jiathis_button_copy">复制网址</a> <a class="jiathis_button_email">邮件</a> <a class="jiathis_button_weixin">微信</a> <a class="jiathis_button_qzone">QQ空间</a> <a class="jiathis_button_tqq">腾讯微博</a> <a class="jiathis_button_douban">豆瓣</a> <a class="jiathis_button_share">一键分享</a> <a href="http://www.jiathis.com/share?uid=2140465" class="jiathis jiathis_txt jiathis_separator jtico jtico_jiathis" target="_blank">更多</a><a class="jiathis_counter_style"></a></div><script type="text/javascript">var jiathis_config={data_track_clickback:!0,summary:"",shortUrl:!1,hideMore:!1}</script><script type="text/javascript" src="http://v3.jiathis.com/code/jia.js?uid=" charset="utf-8"></script></div></div></div></div><div class="sidebar-toggle"><div class="sidebar-toggle-line-wrap"><span class="sidebar-toggle-line sidebar-toggle-line-first"></span><span class="sidebar-toggle-line sidebar-toggle-line-middle"></span><span class="sidebar-toggle-line sidebar-toggle-line-last"></span></div></div><aside id="sidebar" class="sidebar"><div id="sidebar-dimmer"></div><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">文章目录</li><li class="sidebar-nav-overview" data-target="site-overview-wrap">站点概览</li></ul><section class="site-overview-wrap sidebar-panel"><div class="site-overview"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="site-author-image" itemprop="image" src="/images/chen.png" alt="Zhongzhou Chen"><p class="site-author-name" itemprop="name">Zhongzhou Chen</p><p class="site-description motion-element" itemprop="description"></p></div><nav class="site-state motion-element"><div class="site-state-item site-state-posts"><a href="/archives/%7C%7C%20archive"><span class="site-state-item-count">332</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"><a href="/categories/index.html"><span class="site-state-item-count">85</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"><a href="/tags/index.html"><span class="site-state-item-count">183</span> <span class="site-state-item-name">标签</span></a></div></nav><div class="feed-link motion-element"><a href="/atom.xml" rel="alternate"><i class="fa fa-rss"></i> RSS</a></div></div></section><section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active"><div class="post-toc"><div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#CAP理论"><span class="nav-text">CAP理论</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#主流注册中心产品"><span class="nav-text">主流注册中心产品</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#测试目标"><span class="nav-text">测试目标</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#测试环境"><span class="nav-text">测试环境</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Consul-集群配置"><span class="nav-text">Consul 集群配置</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#测试过程"><span class="nav-text">测试过程</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#内部服务注册"><span class="nav-text">内部服务注册</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#服务注册"><span class="nav-text">服务注册</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#服务发现"><span class="nav-text">服务发现</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#模拟consul集群故障"><span class="nav-text">模拟consul集群故障</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#模拟server节点故障"><span class="nav-text">模拟server节点故障</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#模拟client节点故障"><span class="nav-text">模拟client节点故障</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#服务剔除"><span class="nav-text">服务剔除</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#外部服务注册"><span class="nav-text">外部服务注册</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#使用Consul-ESM监控外部服务"><span class="nav-text">使用Consul ESM监控外部服务</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#服务注册-1"><span class="nav-text">服务注册</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#服务发现-1"><span class="nav-text">服务发现</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#模拟consul集群故障-1"><span class="nav-text">模拟consul集群故障</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#模拟server节点故障-1"><span class="nav-text">模拟server节点故障</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#模拟client节点故障-1"><span class="nav-text">模拟client节点故障</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#服务剔除-1"><span class="nav-text">服务剔除</span></a></li></ol></li></ol></li></ol></div></div></section><div class="back-to-top"><i class="fa fa-arrow-up"></i> <span id="scrollpercent"><span>0</span>%</span></div></div></aside></div></main><footer id="footer" class="footer"><div class="footer-inner"><script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script><div class="copyright">&copy; <span itemprop="copyrightYear">2022</span><span class="with-love"><i class="fa fa-user"></i></span> <span class="author" itemprop="copyrightHolder">Zhongzhou Chen</span> <span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-area-chart"></i></span> <span class="post-meta-item-text">Site words total count&#58;</span> <span title="Site words total count">780.6k</span></div><span class="post-meta-divider"></span></div></footer></div><script type="text/javascript">"[object Function]"!==Object.prototype.toString.call(window.Promise)&&(window.Promise=null)</script><script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script><script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script><script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script><script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script><script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script><script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script><script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script><style>.copy-btn{display:inline-block;padding:6px 12px;font-size:13px;font-weight:700;line-height:20px;color:#333;white-space:nowrap;vertical-align:middle;cursor:pointer;background-color:#eee;background-image:linear-gradient(#fcfcfc,#eee);border:1px solid #d5d5d5;border-radius:3px;user-select:none;outline:0}.highlight-wrap .copy-btn{transition:opacity .3s ease-in-out;opacity:0;padding:2px 6px;position:absolute;right:4px;top:8px}.highlight-wrap .copy-btn:focus,.highlight-wrap:hover .copy-btn{opacity:1}.highlight-wrap{position:relative}</style><script>$(".highlight").each(function(t,e){var n=$("<div>").addClass("highlight-wrap");$(e).after(n),n.append($("<button>").addClass("copy-btn").append("复制").on("click",function(t){var e=$(this).parent().find(".code").find(".line").map(function(t,e){return $(e).text()}).toArray().join("\n"),n=document.createElement("textarea");document.body.appendChild(n),n.style.position="absolute",n.style.top="0px",n.style.left="0px",n.value=e,n.select(),n.focus();var o=document.execCommand("copy");document.body.removeChild(n),o?$(this).text("复制成功"):$(this).text("复制失败"),$(this).blur()})).on("mouseleave",function(t){var e=$(this).find(".copy-btn");setTimeout(function(){e.text("复制")},300)}).append(e)})</script><script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script><script type="text/javascript">function proceedsearch(){$("body").append('<div class="search-popup-overlay local-search-pop-overlay"></div>').css("overflow","hidden"),$(".search-popup-overlay").click(onPopupClose),$(".popup").toggle();var t=$("#local-search-input");t.attr("autocapitalize","none"),t.attr("autocorrect","off"),t.focus()}var isfetched=!1,isXml=!0,search_path="search.xml";0===search_path.length?search_path="search.xml":/json$/i.test(search_path)&&(isXml=!1);var path="/"+search_path,onPopupClose=function(t){$(".popup").hide(),$("#local-search-input").val(""),$(".search-result-list").remove(),$("#no-result").remove(),$(".local-search-pop-overlay").remove(),$("body").css("overflow","")},searchFunc=function(t,e,s){"use strict";$("body").append('<div class="search-popup-overlay local-search-pop-overlay"><div id="search-loading-icon"><i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i></div></div>').css("overflow","hidden"),$("#search-loading-icon").css("margin","20% auto 0 auto").css("text-align","center"),$.ajax({url:t,dataType:isXml?"xml":"json",async:!0,success:function(t){isfetched=!0,$(".popup").detach().appendTo(".header-inner");var o=isXml?$("entry",t).map(function(){return{title:$("title",this).text(),content:$("content",this).text(),url:$("url",this).text()}}).get():t,n=document.getElementById(e),r=document.getElementById(s);n.addEventListener("input",function(){var y=n.value.trim().toLowerCase(),T=y.split(/[\s\-]+/);1<T.length&&T.push(y);var b=[];if(0<y.length&&o.forEach(function(t){function e(t,e,o,n){for(var r=n[n.length-1],s=r.position,a=r.word,i=[],c=0;s+a.length<=o&&0!=n.length;){a===y&&c++,i.push({position:s,length:a.length});var l=s+a.length;for(n.pop();0!=n.length&&(s=(r=n[n.length-1]).position,a=r.word,s<l);)n.pop()}return h+=c,{hits:i,start:e,end:o,searchTextCount:c}}function o(o,t){var n="",r=t.start;return t.hits.forEach(function(t){n+=o.substring(r,t.position);var e=t.position+t.length;n+='<b class="search-keyword">'+o.substring(t.position,e)+"</b>",r=e}),n+=o.substring(r,t.end)}var n=!1,r=0,h=0,s=t.title.trim(),a=s.toLowerCase(),i=t.content.trim().replace(/<[^>]+>/g,""),c=i.toLowerCase(),l=decodeURIComponent(t.url),p=[],u=[];if(""!=s&&(T.forEach(function(t){function e(t,e,o){var n=t.length;if(0===n)return[];var r=0,s=[],a=[];for(o||(e=e.toLowerCase(),t=t.toLowerCase());-1<(s=e.indexOf(t,r));)a.push({position:s,word:t}),r=s+n;return a}p=p.concat(e(t,a,!1)),u=u.concat(e(t,c,!1))}),(0<p.length||0<u.length)&&(n=!0,r=p.length+u.length)),n){[p,u].forEach(function(t){t.sort(function(t,e){return e.position!==t.position?e.position-t.position:t.word.length-e.word.length})});var f=[];0!=p.length&&f.push(e(0,0,s.length,p));for(var d=[];0!=u.length;){var g=u[u.length-1],v=g.position,$=g.word,C=v-20,m=v+80;C<0&&(C=0),m<v+$.length&&(m=v+$.length),m>i.length&&(m=i.length),d.push(e(0,C,m,u))}d.sort(function(t,e){return t.searchTextCount!==e.searchTextCount?e.searchTextCount-t.searchTextCount:t.hits.length!==e.hits.length?e.hits.length-t.hits.length:t.start-e.start});var x=parseInt("1");0<=x&&(d=d.slice(0,x));var w="";w+=0!=f.length?"<li><a href='"+l+"' class='search-result-title'>"+o(s,f[0])+"</a>":"<li><a href='"+l+"' class='search-result-title'>"+s+"</a>",d.forEach(function(t){w+="<a href='"+l+'\'><p class="search-result">'+o(i,t)+"...</p></a>"}),w+="</li>",b.push({item:w,searchTextCount:h,hitCount:r,id:b.length})}}),1===T.length&&""===T[0])r.innerHTML='<div id="no-result"><i class="fa fa-search fa-5x" /></div>';else if(0===b.length)r.innerHTML='<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>';else{b.sort(function(t,e){return t.searchTextCount!==e.searchTextCount?e.searchTextCount-t.searchTextCount:t.hitCount!==e.hitCount?e.hitCount-t.hitCount:e.id-t.id});var e='<ul class="search-result-list">';b.forEach(function(t){e+=t.item}),e+="</ul>",r.innerHTML=e}}),$(".local-search-pop-overlay").remove(),$("body").css("overflow",""),proceedsearch()}})};$(".popup-trigger").click(function(t){t.stopPropagation(),!1===isfetched?searchFunc(path,"local-search-input","local-search-result"):proceedsearch()}),$(".popup-btn-close").click(onPopupClose),$(".popup").click(function(t){t.stopPropagation()}),$(document).on("keyup",function(t){27===t.which&&$(".search-popup").is(":visible")&&onPopupClose()})</script><script type="text/javascript" src="/js/src/love.js"></script><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({pluginRootPath:"live2dw/",pluginJsPath:"lib/",pluginModelPath:"assets/",tagMode:!1,debug:!1,log:!1,model:{jsonPath:"/live2dw/assets/shizuku.model.json"},display:{position:"right"},mobile:{show:!0,scale:.2},react:{opacityDefault:.7,opacityOnHover:.2,opacity:.4}})</script></body></html>