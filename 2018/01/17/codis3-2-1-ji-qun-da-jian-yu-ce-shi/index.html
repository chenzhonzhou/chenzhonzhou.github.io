<!-- build time:Mon Sep 13 2021 10:58:32 GMT+0800 (GMT+08:00) --><!DOCTYPE html><html class="theme-next gemini use-motion" lang="zh-Hans"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><script src="//cdn.bootcss.com/pace/1.0.2/pace.min.js"></script><link href="//cdn.bootcss.com/pace/1.0.2/themes/pink/pace-theme-flash.css" rel="stylesheet"><script></script><meta name="theme-color" content="#222"><style>.pace .pace-progress{background:#1E92FB;height:3px}.pace .pace-progress-inner{box-shadow:0 0 10px #1E92FB,0 0 5px #1E92FB}.pace .pace-activity{border-top-color:#1E92FB;border-left-color:#1E92FB}</style><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css"><link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css"><link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4"><link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222"><meta name="keywords" content="缓存,Redis,Codis,"><link rel="alternate" href="/atom.xml" title="凡间的精灵" type="application/atom+xml"><meta name="description" content="1、Codis简介Codis是一套用go语言编写的,为了应对高并环境下的redis集群软件,原理是对一个redis key操作前,先把这个key通过crc32算法,分配到不同redis的某一个slot上,实现并发读写功能.而且能通过zookeeper调用redis-sentinel来实现故障切换功能.现在最新版本是3.2.1,依托于redis3.2.9开发出来.优点：实现高并发读写,数据一致性高."><meta name="keywords" content="缓存,Redis,Codis"><meta property="og:type" content="article"><meta property="og:title" content="Codis3.2.1集群搭建与测试"><meta property="og:url" content="http:&#x2F;&#x2F;chenzhonzhou.github.io&#x2F;2018&#x2F;01&#x2F;17&#x2F;codis3-2-1-ji-qun-da-jian-yu-ce-shi&#x2F;index.html"><meta property="og:site_name" content="凡间的精灵"><meta property="og:description" content="1、Codis简介Codis是一套用go语言编写的,为了应对高并环境下的redis集群软件,原理是对一个redis key操作前,先把这个key通过crc32算法,分配到不同redis的某一个slot上,实现并发读写功能.而且能通过zookeeper调用redis-sentinel来实现故障切换功能.现在最新版本是3.2.1,依托于redis3.2.9开发出来.优点：实现高并发读写,数据一致性高."><meta property="og:locale" content="zh-Hans"><meta property="og:image" content="http:&#x2F;&#x2F;chenzhonzhou.github.io&#x2F;2018&#x2F;01&#x2F;17&#x2F;codis3-2-1-ji-qun-da-jian-yu-ce-shi&#x2F;%E5%9B%BE%E7%89%871.png"><meta property="og:image" content="http:&#x2F;&#x2F;chenzhonzhou.github.io&#x2F;2018&#x2F;01&#x2F;17&#x2F;codis3-2-1-ji-qun-da-jian-yu-ce-shi&#x2F;%E5%9B%BE%E7%89%872.png"><meta property="og:image" content="http:&#x2F;&#x2F;chenzhonzhou.github.io&#x2F;2018&#x2F;01&#x2F;17&#x2F;codis3-2-1-ji-qun-da-jian-yu-ce-shi&#x2F;%E5%9B%BE%E7%89%873.png"><meta property="og:image" content="http:&#x2F;&#x2F;chenzhonzhou.github.io&#x2F;2018&#x2F;01&#x2F;17&#x2F;codis3-2-1-ji-qun-da-jian-yu-ce-shi&#x2F;%E5%9B%BE%E7%89%874.png"><meta property="og:image" content="http:&#x2F;&#x2F;chenzhonzhou.github.io&#x2F;2018&#x2F;01&#x2F;17&#x2F;codis3-2-1-ji-qun-da-jian-yu-ce-shi&#x2F;%E5%9B%BE%E7%89%875.png"><meta property="og:image" content="http:&#x2F;&#x2F;chenzhonzhou.github.io&#x2F;2018&#x2F;01&#x2F;17&#x2F;codis3-2-1-ji-qun-da-jian-yu-ce-shi&#x2F;%E5%9B%BE%E7%89%876.png"><meta property="og:image" content="http:&#x2F;&#x2F;chenzhonzhou.github.io&#x2F;2018&#x2F;01&#x2F;17&#x2F;codis3-2-1-ji-qun-da-jian-yu-ce-shi&#x2F;%E5%9B%BE%E7%89%877.png"><meta property="og:image" content="http:&#x2F;&#x2F;chenzhonzhou.github.io&#x2F;2018&#x2F;01&#x2F;17&#x2F;codis3-2-1-ji-qun-da-jian-yu-ce-shi&#x2F;%E5%9B%BE%E7%89%878.png"><meta property="og:image" content="http:&#x2F;&#x2F;chenzhonzhou.github.io&#x2F;2018&#x2F;01&#x2F;17&#x2F;codis3-2-1-ji-qun-da-jian-yu-ce-shi&#x2F;%E5%9B%BE%E7%89%879.png"><meta property="og:image" content="http:&#x2F;&#x2F;chenzhonzhou.github.io&#x2F;2018&#x2F;01&#x2F;17&#x2F;codis3-2-1-ji-qun-da-jian-yu-ce-shi&#x2F;%E5%9B%BE%E7%89%8710.png"><meta property="og:image" content="http:&#x2F;&#x2F;chenzhonzhou.github.io&#x2F;2018&#x2F;01&#x2F;17&#x2F;codis3-2-1-ji-qun-da-jian-yu-ce-shi&#x2F;%E5%9B%BE%E7%89%8711.png"><meta property="og:image" content="http:&#x2F;&#x2F;chenzhonzhou.github.io&#x2F;2018&#x2F;01&#x2F;17&#x2F;codis3-2-1-ji-qun-da-jian-yu-ce-shi&#x2F;%E5%9B%BE%E7%89%8712.png"><meta property="og:image" content="http:&#x2F;&#x2F;chenzhonzhou.github.io&#x2F;2018&#x2F;01&#x2F;17&#x2F;codis3-2-1-ji-qun-da-jian-yu-ce-shi&#x2F;%E5%9B%BE%E7%89%8719.png"><meta property="og:image" content="http:&#x2F;&#x2F;chenzhonzhou.github.io&#x2F;2018&#x2F;01&#x2F;17&#x2F;codis3-2-1-ji-qun-da-jian-yu-ce-shi&#x2F;%E5%9B%BE%E7%89%8713.png"><meta property="og:image" content="http:&#x2F;&#x2F;chenzhonzhou.github.io&#x2F;2018&#x2F;01&#x2F;17&#x2F;codis3-2-1-ji-qun-da-jian-yu-ce-shi&#x2F;%E5%9B%BE%E7%89%8714.png"><meta property="og:image" content="http:&#x2F;&#x2F;chenzhonzhou.github.io&#x2F;2018&#x2F;01&#x2F;17&#x2F;codis3-2-1-ji-qun-da-jian-yu-ce-shi&#x2F;%E5%9B%BE%E7%89%8715.png"><meta property="og:image" content="http:&#x2F;&#x2F;chenzhonzhou.github.io&#x2F;2018&#x2F;01&#x2F;17&#x2F;codis3-2-1-ji-qun-da-jian-yu-ce-shi&#x2F;%E5%9B%BE%E7%89%8716.png"><meta property="og:image" content="http:&#x2F;&#x2F;chenzhonzhou.github.io&#x2F;2018&#x2F;01&#x2F;17&#x2F;codis3-2-1-ji-qun-da-jian-yu-ce-shi&#x2F;%E5%9B%BE%E7%89%8717.png"><meta property="og:image" content="http:&#x2F;&#x2F;chenzhonzhou.github.io&#x2F;2018&#x2F;01&#x2F;17&#x2F;codis3-2-1-ji-qun-da-jian-yu-ce-shi&#x2F;%E5%9B%BE%E7%89%8718.png"><meta property="og:updated_time" content="2019-11-13T08:42:47.794Z"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="http:&#x2F;&#x2F;chenzhonzhou.github.io&#x2F;2018&#x2F;01&#x2F;17&#x2F;codis3-2-1-ji-qun-da-jian-yu-ce-shi&#x2F;%E5%9B%BE%E7%89%871.png"><script type="text/javascript" id="hexo.configurations">var NexT=window.NexT||{},CONFIG={root:"/",scheme:"Gemini",version:"5.1.4",sidebar:{position:"left",display:"always",offset:12,b2t:!0,scrollpercent:!0,onmobile:!0},fancybox:!0,tabs:!0,motion:{enable:!0,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}},duoshuo:{userId:"0",author:"博主"},algolia:{applicationID:"",apiKey:"",indexName:"",hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}}}</script><link rel="canonical" href="http://chenzhonzhou.github.io/2018/01/17/codis3-2-1-ji-qun-da-jian-yu-ce-shi/"><title>Codis3.2.1集群搭建与测试 | 凡间的精灵</title><link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css"></head><body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans"><div class="container sidebar-position-left page-post-detail"><div class="headband"></div><header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-wrapper"><div class="site-meta"><div class="custom-logo-site-title"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">凡间的精灵</span> <span class="logo-line-after"><i></i></span></a></div><p class="site-subtitle">凡尘落素一精灵</p></div><div class="site-nav-toggle"><button><span class="btn-bar"></span> <span class="btn-bar"></span> <span class="btn-bar"></span></button></div></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i><br>首页</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i><br>归档</a></li><li class="menu-item menu-item-categories"><a href="/categories" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i><br>分类</a></li><li class="menu-item menu-item-tags"><a href="/tags" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i><br>标签</a></li><li class="menu-item menu-item-sitemap"><a href="/sitemap.xml" rel="section"><i class="menu-item-icon fa fa-fw fa-sitemap"></i><br>站点地图</a></li><li class="menu-item menu-item-search"><a href="javascript:;" class="popup-trigger"><i class="menu-item-icon fa fa-search fa-fw"></i><br>搜索</a></li></ul><div class="site-search"><div class="popup search-popup local-search-popup"><div class="local-search-header clearfix"><span class="search-icon"><i class="fa fa-search"></i> </span><span class="popup-btn-close"><i class="fa fa-times-circle"></i></span><div class="local-search-input-wrapper"><input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input"></div></div><div id="local-search-result"></div></div></div></nav></div></header><main id="main" class="main"><div class="main-inner"><div class="content-wrap"><div id="content" class="content"><div id="posts" class="posts-expand"><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><div class="post-block"><link itemprop="mainEntityOfPage" href="http://chenzhonzhou.github.io/2018/01/17/codis3-2-1-ji-qun-da-jian-yu-ce-shi/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="name" content="Zhongzhou Chen"><meta itemprop="description" content=""><meta itemprop="image" content="/images/chen.png"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="凡间的精灵"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">Codis3.2.1集群搭建与测试</h1><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-01-17T15:09:47+08:00">2018-01-17 </time></span><span class="post-category"><span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-folder-o"></i> </span><span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/%E7%BC%93%E5%AD%98/" itemprop="url" rel="index"><span itemprop="name">缓存</span> </a></span>， <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/%E7%BC%93%E5%AD%98/Redis/" itemprop="url" rel="index"><span itemprop="name">Redis</span></a></span></span><div class="post-wordcount"><span class="post-meta-item-icon"><i class="fa fa-file-word-o"></i> </span><span class="post-meta-item-text">字数统计&#58;</span> <span title="字数统计">8.1k </span><span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-clock-o"></i> </span><span class="post-meta-item-text">阅读时长 &asymp;</span> <span title="阅读时长">32</span></div></div></header><div class="post-body" itemprop="articleBody"><h2 id="1、Codis简介"><a href="#1、Codis简介" class="headerlink" title="1、Codis简介"></a>1、Codis简介</h2><p>Codis是一套用go语言编写的,为了应对高并环境下的redis集群软件,原理是对一个redis key操作前,先把这个key通过crc32算法,分配到不同redis的某一个slot上,实现并发读写功能.而且能通过zookeeper调用redis-sentinel来实现故障切换功能.现在最新版本是3.2.1,依托于redis3.2.9开发出来.</p><p><strong>优点：</strong>实现高并发读写,数据一致性高.</p><p><strong>缺点：</strong>性能有较大损耗,故障切换无法保证不丢<strong>key</strong>,无法进行读写分离.</p><h2 id="2、部署Codis集群"><a href="#2、部署Codis集群" class="headerlink" title="2、部署Codis集群"></a>2、部署Codis集群</h2><h3 id="2-1-架构介绍"><a href="#2-1-架构介绍" class="headerlink" title="2.1 架构介绍"></a>2.1 架构介绍</h3><h4 id="2-1-1-需要用到的软件有"><a href="#2-1-1-需要用到的软件有" class="headerlink" title="2.1.1 需要用到的软件有"></a>2.1.1 需要用到的软件有</h4><p><strong>codis3.2.1</strong>：codis集群套件,里面含有redis相关程序,和集群专用程序,主要功能程序解析:</p><p><strong>codis-server</strong>：属于redis-server优化版,基于 redis-3.2.9 分支开发。增加了额外的数据结构，以支持 slot 有关的操作以及数据迁移指令。</p><p><strong>codis-proxy</strong>：客户端连接的 Redis 代理服务, 实现了 Redis 协议。 除部分命令不支持以外(例如:keys *,flush )，表现的和原生的 Redis 没有区别（就像 Twemproxy）。</p><p><strong>redis-sentinel</strong>：可以实现对Redis的监控、通知、自动故障转移。如果Master不能工作，则会自动启动故障转移进程，将其中的一个Slave提升为Master，其他的Slave重新设置新的Master服务。Sentinel的配置由 codis-dashboard和zookeeper一起控制,不需要手工填写.</p><p><strong>codis-dashboard</strong>：集群管理工具，支持 codis-proxy、codis-server 的添加、删除，以及据迁移等操作。在集群状态发生改变时，codis-dashboard 维护集群下所有 codis-proxy 的状态的一致性。</p><p><strong>codis-fe</strong>：集群web管理界面。</p><p><strong>go1.9.1</strong>：codis依赖语言包</p><p><strong>jdk1.8</strong>：zookeeper依赖语言包</p><p><strong>zookeeper-3.4.11</strong>：用于存放数据配置路由表。zookeeper简称zk。在生产环境中，zk部署越多，其可靠性越高。由于zk集群是以宕机个数过半才会让整个集群宕机，因此，奇数个zk更佳。</p><h4 id="2-2-2-逻辑架构如下"><a href="#2-2-2-逻辑架构如下" class="headerlink" title="2.2.2 逻辑架构如下:"></a>2.2.2 逻辑架构如下:</h4><p><strong>访问层</strong>：访问方式可以是vip或者是通过java代码调用jodis,然后连接调用不同的codis-proxy地址来实现高可用的LVS和HA功能.</p><p><strong>代理层</strong>：然后中间层由codis-proxy和zookeeper处理数据走向和分配,通过crc32算法,把key平均分配在不同redis的某一个slot中.实现类似raid0的条带化,在旧版本的codis中,slot需要手工分配,在codis3.2之后,slot会自动分配,相当方便.</p><p><strong>数据层</strong>：最后codis-proxy把数据存进真实的redis-server主服务器上,由于codis的作者黄东旭相当注重数据一致性,不允许有数据延时造成的数据不一致,所以架构从一开始就没考虑主从读写分离.从服务器仅仅是作为故障切换的冗余架构,由zookeeper调用redis-sentinel实现故障切换功能.</p><p><img src="/2018/01/17/codis3-2-1-ji-qun-da-jian-yu-ce-shi/%E5%9B%BE%E7%89%871.png" alt="图片1.png"></p><h4 id="2-2-3-因为机器有限-部署的架构如下"><a href="#2-2-3-因为机器有限-部署的架构如下" class="headerlink" title="2.2.3 因为机器有限,部署的架构如下:"></a>2.2.3 因为机器有限,部署的架构如下:</h4><p><strong>zookeeper</strong>集群：</p><blockquote><p>10.0.2.5:2181</p><p>10.0.2.6:2181</p><p>10.0.2.7:2181</p></blockquote><p><strong>codis-config</strong>和<strong>codis-dashboard</strong>：</p><blockquote><p>10.0.2.6:18087</p><p>10.0.2.6:8090</p></blockquote><p><strong>codis-proxy</strong>：</p><blockquote><p>10.0.2.5:19000</p><p>10.0.2.7:19000</p></blockquote><p><strong>codis-server</strong>：</p><blockquote><p>10.0.2.5:6379(主),10.0.2.5:6380(从)</p><p>10.0.2.6:6379(主),10.0.2.6:6380(从)</p><p>10.0.2.7:6379(主),10.0.2.7:6380(从)</p></blockquote><h3 id="2-2-安装部署"><a href="#2-2-安装部署" class="headerlink" title="2.2 安装部署"></a>2.2 安装部署</h3><h4 id="2-2-1-下载程序代码"><a href="#2-2-1-下载程序代码" class="headerlink" title="2.2.1 下载程序代码"></a>2.2.1 下载程序代码</h4><p><strong>下载golang语言程序包</strong></p><p>按正常途径是要×××的,不过国内地址也有人放出来了,因为codis3.2要求至少是1.7或1.8以上版本的,那干脆下最新版吧.</p><p><a href="https://studygolang.com/dl/golang/go1.9.1.linux-amd64.tar.gz" target="_blank" rel="noopener">https://studygolang.com/dl/golang/go1.9.1.linux-amd64.tar.gz</a></p><p><strong>下载java语言程序包</strong></p><p>Java的下载地址一直在变,所以最好自己上去看着来下载</p><p><a href="http://download.oracle.com/otn-pub/java/jdk/8u151-b12/e758a0de34e24606bca991d704f6dcbf/jdk-8u151-linux-x64.tar.gz?AuthParam=1513326216_bcf60226458d67751e1d8d1bbe6689b4" target="_blank" rel="noopener">http://download.oracle.com/otn-pub/java/jdk/8u151-b12/e758a0de34e24606bca991d704f6dcbf/jdk-8u151-linux-x64.tar.gz?AuthParam=1513326216_bcf60226458d67751e1d8d1bbe6689b4</a></p><p><strong>下载zookeeper程序</strong></p><p>直接就是程序包,不用编译了,好方便</p><p><a href="http://mirrors.hust.edu.cn/apache/zookeeper/zookeeper-3.4.11/zookeeper-3.4.11.tar.gz" target="_blank" rel="noopener">http://mirrors.hust.edu.cn/apache/zookeeper/zookeeper-3.4.11/zookeeper-3.4.11.tar.gz</a></p><p><strong>下载codis3.2.1</strong></p><p>直接就是程序包,不用编译了,好方便</p><p><a href="https://github.com/CodisLabs/codis/releases/download/3.2.1/codis3.2.1-go1.7.6-linux.tar.gz" target="_blank" rel="noopener">https://github.com/CodisLabs/codis/releases/download/3.2.1/codis3.2.1-go1.7.6-linux.tar.gz</a></p><h4 id="2-2-2-安装程序"><a href="#2-2-2-安装程序" class="headerlink" title="2.2.2 安装程序"></a>2.2.2 安装程序</h4><p><strong>安装java</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#解压程序包</span></span><br><span class="line">tar xf jdk-8u144-linux-x64.tar.gz</span><br><span class="line"></span><br><span class="line"><span class="comment">#移动到指定目录</span></span><br><span class="line">mv jdk1.8.0_144/ /usr/<span class="built_in">local</span>/</span><br><span class="line"></span><br><span class="line"><span class="comment">#进入指定目录,并创建程序软连接</span></span><br><span class="line"><span class="built_in">cd</span> /usr/<span class="built_in">local</span>/</span><br><span class="line">ln -sf jdk1.8.0_144/ jdk</span><br><span class="line"></span><br><span class="line"><span class="comment">#创建环境变量文件</span></span><br><span class="line"><span class="built_in">echo</span> “<span class="built_in">export</span> JAVA_HOME=/usr/<span class="built_in">local</span>/jdk  </span><br><span class="line"><span class="built_in">export</span> JRE_HOME=/usr/<span class="built_in">local</span>/jdk/jre  </span><br><span class="line"><span class="built_in">export</span> CLASSPATH=.:<span class="variable">$JAVA_HOME</span>/lib/dt.jar:<span class="variable">$JAVA_HOME</span>/lib/tools.jar:<span class="variable">$JRE_HOME</span>/lib  </span><br><span class="line"><span class="built_in">export</span> PATH=<span class="variable">$PATH</span>:<span class="variable">$JAVA_HOME</span>/bin ”&gt; /etc/profile.d/java.sh</span><br><span class="line"></span><br><span class="line"><span class="comment">#重载环境变量</span></span><br><span class="line"><span class="built_in">source</span> /etc/profile</span><br><span class="line"></span><br><span class="line"><span class="comment">#测试检查是否安装完成</span></span><br><span class="line">java -version</span><br><span class="line">java version <span class="string">"1.8.0_144"</span></span><br><span class="line">Java(TM) SE Runtime Environment (build 1.8.0_144-b01)</span><br><span class="line">Java HotSpot(TM) 64-Bit Server VM (build 25.144-b01, mixed mode)</span><br></pre></td></tr></table></figure><p><strong>安装golang</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#解压程序包</span></span><br><span class="line">tar xf go1.9.1.linux-amd64.tar.gz</span><br><span class="line"></span><br><span class="line"><span class="comment">#移动到指定目录</span></span><br><span class="line">mv go /usr/<span class="built_in">local</span>/</span><br><span class="line"></span><br><span class="line"><span class="comment">#把程序包里的命令软连接到系统默认命令目录</span></span><br><span class="line">ln -sf /usr/<span class="built_in">local</span>/go/bin/* /usr/bin/</span><br><span class="line"></span><br><span class="line"><span class="comment">#测试检查是否安装完成</span></span><br><span class="line">go version</span><br><span class="line">go version go1.9.1 linux/amd64</span><br></pre></td></tr></table></figure><p><strong>安装zookeeper</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#解压程序包</span></span><br><span class="line">tar xf zookeeper-3.4.11.tar.gz</span><br><span class="line"></span><br><span class="line"><span class="comment">#移动到指定目录</span></span><br><span class="line">mv zookeeper-3.4.11 /usr/<span class="built_in">local</span>/</span><br><span class="line"></span><br><span class="line"><span class="comment">#进入指定目录,并创建程序软连接</span></span><br><span class="line"><span class="built_in">cd</span> /usr/<span class="built_in">local</span>/</span><br><span class="line">ln -sf zookeeper-3.4.11/ zookeeper</span><br></pre></td></tr></table></figure><p>安装完成，等候配置</p><p><strong>安装codis</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#解压程序包</span></span><br><span class="line">tar xf codis3.2.1-go1.7.6-linux.tar.gz</span><br><span class="line"></span><br><span class="line"><span class="comment">#移动到指定目录</span></span><br><span class="line">mv codis3.2.1-go1.7.6-linux /usr/<span class="built_in">local</span>/</span><br><span class="line"></span><br><span class="line"><span class="comment">#进入指定目录,并创建程序软连接</span></span><br><span class="line"><span class="built_in">cd</span> /usr/<span class="built_in">local</span>/</span><br><span class="line">ln -sf codis3.2.1-go1.7.6-linux/ codis</span><br></pre></td></tr></table></figure><p>安装完成，等候配置，因为我们用的都是二进制程序包,只要依赖包有正常安装,就不会报错,直接就能用,所以安装就很简单</p><h3 id="2-3-配置程序"><a href="#2-3-配置程序" class="headerlink" title="2.3 配置程序"></a>2.3 配置程序</h3><h4 id="2-3-1-配置zookeeper，3台一起都是这么配置"><a href="#2-3-1-配置zookeeper，3台一起都是这么配置" class="headerlink" title="2.3.1 配置zookeeper，3台一起都是这么配置"></a>2.3.1 配置zookeeper，3台一起都是这么配置</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#设置hosts跳转规则,好像不这么设置的话,不能顺利启动</span></span><br><span class="line"><span class="built_in">echo</span> “10.0.2.5        zookeeper-node1</span><br><span class="line">10.0.2.6        zookeeper-node2</span><br><span class="line">10.0.2.7        zookeeper-node3” &gt;&gt; /etc/hosts</span><br><span class="line"></span><br><span class="line"><span class="comment">#创建程序目录</span></span><br><span class="line">mkdir -p /data/zookeeper</span><br><span class="line"></span><br><span class="line"><span class="comment">#创建配置文件,文件夹里有一个模板,有兴趣可以看看</span></span><br><span class="line">vim /usr/<span class="built_in">local</span>/zookeeper/conf/zoo.cfg</span><br><span class="line"></span><br><span class="line"><span class="comment">#最大连接数设置. 注：可不配置. </span></span><br><span class="line">maxClientCnxns=50</span><br><span class="line"></span><br><span class="line"><span class="comment">#一个周期(tick)的时长(单位：毫秒). 注：可用默认值</span></span><br><span class="line">tickTime=2000</span><br><span class="line"></span><br><span class="line"><span class="comment">#初始化同步阶段最多耗费tick个数. 注：可用默认值</span></span><br><span class="line">initLimit=10</span><br><span class="line"></span><br><span class="line"><span class="comment">#等待应答的最大间隔tick个数. 注：可用默认值</span></span><br><span class="line">syncLimit=5</span><br><span class="line"></span><br><span class="line"><span class="comment">#数据存储目录,刚才创建那个. 注：勿放在/tmp目录</span></span><br><span class="line">dataDir=/data/zookeeper/</span><br><span class="line"></span><br><span class="line"><span class="comment">#通信端口. 注：可用默认值</span></span><br><span class="line">clientPort=2181</span><br><span class="line">server.1=zookeeper-node1:2888:3888</span><br><span class="line">server.2=zookeeper-node2:2888:3888</span><br><span class="line">server.3=zookeeper-node3:2888:3888</span><br></pre></td></tr></table></figure><p>生成ID，这里需要注意， myid对应的zoo.cfg的server.ID.比如zookeeper-node2对应的myid应该是2,不按规定设置,zookeeper集群将无法启动.</p><figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title">echo</span> <span class="string">"1"</span>&gt; /<span class="class"><span class="keyword">data</span>/zookeeper/myid</span></span><br></pre></td></tr></table></figure><p>例如:在zookeeper-node3那台10.0.2.7的服务器,就应该是</p><figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title">echo</span> <span class="string">"3"</span>&gt; /<span class="class"><span class="keyword">data</span>/zookeeper/myid</span></span><br></pre></td></tr></table></figure><p><strong>zoo.cfg最后三行特别说明</strong></p><p>说明：server.A=B：C：D：其中 A 是一个数字，表示这个是第几号服务器；B 是这个服务器的 ip 地址；C 表示的是这个服务器与集群中的 Leader 服务器交换信息的端口；D 表示的是万一集群中的 Leader 服务器挂了，需要一个端口来重新进行选举，选出一个新的 Leader，而这个端口就是用来执行选举时服务器相互通信的端口。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#最后启动,因为zookeeper的server是有顺序的,最好是按顺序启动,先启动server.1再启动server2,最后启动server.3这样</span></span><br><span class="line">/usr/<span class="built_in">local</span>/zookeeper/bin/zkServer.sh start</span><br><span class="line"></span><br><span class="line"><span class="comment">#查看状态,会有follower和leader的区别,他们自己会选谁是leader</span></span><br><span class="line">/usr/<span class="built_in">local</span>/zookeeper/bin/zkServer.sh status</span><br><span class="line">ZooKeeper JMX enabled by default</span><br><span class="line">Using config: /usr/<span class="built_in">local</span>/zookeeper/bin/../conf/zoo.cfg</span><br><span class="line">Mode: follower</span><br></pre></td></tr></table></figure><p>配置并启动完毕</p><h4 id="2-3-2-配置codis-server，3台一起都是这么配置"><a href="#2-3-2-配置codis-server，3台一起都是这么配置" class="headerlink" title="2.3.2 配置codis-server，3台一起都是这么配置"></a>2.3.2 配置codis-server，3台一起都是这么配置</h4><p>注意：<strong>codis-server</strong>就是<strong>redis-server</strong>程序,属于<strong>codis</strong>优化版本,配合<strong>codis</strong>集群使用.</p><p>所以就是配置个redis的主从结构,实际生产环境不要搭在一起</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#创建redis数据目录,配置文件目录,日志目录</span></span><br><span class="line">mkdir -p /data/redis/data/config/</span><br><span class="line">mkdir -p /data/redis/data/logs/</span><br><span class="line"><span class="comment">#创建主库的配置文件,暂时只配置这些,其他先默认</span></span><br><span class="line">vim /data/redis/data/config/redis_6379.conf</span><br><span class="line"><span class="comment">#允许后台运行</span></span><br><span class="line">daemonize yes</span><br><span class="line"><span class="comment">#设置端口,最好是非默认端口</span></span><br><span class="line">port 6379</span><br><span class="line"><span class="comment">#绑定登录IP,安全考虑,最好是内网</span></span><br><span class="line"><span class="built_in">bind</span> *</span><br><span class="line"><span class="comment">#命名并指定当前redis的PID路径,用以区分多个redis</span></span><br><span class="line">pidfile <span class="string">"/data/redis/data/config/redis_6379.pid"</span></span><br><span class="line"><span class="comment">#命名并指定当前redis日志文件路径</span></span><br><span class="line">logfile <span class="string">"/data/redis/data/logs/redis_6379.log"</span></span><br><span class="line"><span class="comment">#指定RDB文件名,用以备份数据到硬盘并区分不同redis,当使用内存超过可用内存的45%时触发快照功能</span></span><br><span class="line">dbfilename <span class="string">"dump_6379.rdb"</span></span><br><span class="line"><span class="comment">#指定当前redis的根目录,用来存放RDB/AOF文件</span></span><br><span class="line">dir <span class="string">"/data/redis/data"</span></span><br><span class="line"><span class="comment">#当前redis的认证密钥,redis运行速度非常快,这个密码要足够强大,</span></span><br><span class="line"><span class="comment">#所有codis-proxy集群相关的redis-server认证密码必须全部一致</span></span><br><span class="line">requirepass <span class="string">"123"</span></span><br><span class="line"><span class="comment">#当前redis的最大容量限制,建议设置为可用内存的45%内,最高能设置为系统可用内存的95%,</span></span><br><span class="line"><span class="comment">#可用config set maxmemory 去在线修改,但重启失效,需要使用config rewrite命令去刷新配置文件</span></span><br><span class="line"><span class="comment">#注意,使用codis集群,必须配置容量大小限制,不然无法启动</span></span><br><span class="line">maxmemory 100000kb</span><br><span class="line"><span class="comment">#LRU的策略,有四种,看情况选择</span></span><br><span class="line">maxmemory-policy allkeys-lru</span><br><span class="line"><span class="comment">#如果做故障切换，不论主从节点都要填写密码且要保持一致</span></span><br><span class="line">masterauth <span class="string">"123"</span></span><br><span class="line">  </span><br><span class="line"><span class="comment">#创建从库的配置文件,暂时只配置这些,其他先默认</span></span><br><span class="line">vim /data/redis/data/config/redis_6380.conf</span><br><span class="line"><span class="comment">#允许后台运行</span></span><br><span class="line">daemonize yes</span><br><span class="line"><span class="comment">#设置端口,最好是非默认端口</span></span><br><span class="line">port 6380</span><br><span class="line"><span class="comment">#绑定登录IP,安全考虑,最好是内网</span></span><br><span class="line"><span class="built_in">bind</span> *</span><br><span class="line"><span class="comment">#命名并指定当前redis的PID路径,用以区分多个redis</span></span><br><span class="line">pidfile <span class="string">"/data/redis/data/config/redis_6380.pid"</span></span><br><span class="line"><span class="comment">#命名并指定当前redis日志文件路径</span></span><br><span class="line">logfile <span class="string">"/data/redis/data/logs/redis_6380.log"</span></span><br><span class="line"><span class="comment">#指定RDB文件名,用以备份数据到硬盘并区分不同redis,当使用内存超过可用内存的45%时触发快照功能</span></span><br><span class="line">dbfilename <span class="string">"dump_6380.rdb"</span></span><br><span class="line"><span class="comment">#指定当前redis的根目录,用来存放RDB/AOF文件</span></span><br><span class="line">dir <span class="string">"/data/redis/data"</span></span><br><span class="line"><span class="comment">#当前redis的认证密钥,redis运行速度非常快,这个密码要足够强大</span></span><br><span class="line"><span class="comment">#所有codis-proxy集群相关的redis-server认证密码必须全部一致</span></span><br><span class="line">requirepass <span class="string">"123"</span></span><br><span class="line"><span class="comment">#当前redis的最大容量限制,建议设置为可用内存的45%内,最高能设置为系统可用内存的95%,</span></span><br><span class="line"><span class="comment">#可用config set maxmemory 去在线修改,但重启失效,需要使用config rewrite命令去刷新配置文件</span></span><br><span class="line"><span class="comment">#注意,使用codis集群,必须配置容量大小限制,不然无法启动</span></span><br><span class="line">maxmemory 100000kb</span><br><span class="line"><span class="comment">#LRU的策略,有四种,看情况选择</span></span><br><span class="line">maxmemory-policy allkeys-lru</span><br><span class="line"><span class="comment">#如果做故障切换，不论主从节点都要填写密码且要保持一致</span></span><br><span class="line">masterauth <span class="string">"123"</span></span><br><span class="line"><span class="comment">#配置主节点信息</span></span><br><span class="line">slaveof 10.0.2.5 6379</span><br></pre></td></tr></table></figure><p>除了端口号不同带来的文件名不同.实际上从库配置只是多了最后一行，<font color="red">指定了主库地址</font></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#然后就可以启动了,我一开始就说过codis-server就是redis-server</span></span><br><span class="line">/usr/<span class="built_in">local</span>/codis/codis-server /data/redis/data/config/redis_6379.conf</span><br><span class="line">/usr/<span class="built_in">local</span>/codis/codis-server /data/redis/data/config/redis_6380.conf</span><br><span class="line"></span><br><span class="line"><span class="comment">#验证一下</span></span><br><span class="line">ss -ntplu |grep codis-server</span><br><span class="line">tcp    LISTEN     0      128       *:6379                  *:*                   users:((<span class="string">"codis-server"</span>,pid=2192,fd=4))</span><br><span class="line">tcp    LISTEN     0      128       *:6380                  *:*                   users:((<span class="string">"codis-server"</span>,pid=2197,fd=4))</span><br></pre></td></tr></table></figure><p>启动方式和<strong>redis-server</strong>一样,指定配置文件就可以启动.这就配置并启动成功了.</p><h4 id="2-3-3-配置redis-sentinel，3台一起都是这么配置"><a href="#2-3-3-配置redis-sentinel，3台一起都是这么配置" class="headerlink" title="2.3.3 配置redis-sentinel，3台一起都是这么配置"></a>2.3.3 配置redis-sentinel，3台一起都是这么配置</h4><p>正确来说,redis-sentinel是要配置主从架构才能生效,但是在codis集群中并不一样,因为他的配置由zookeeper来维护,所以,这里codis使用的redis-sentinel只需要配置一些基本配置就可以了.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#我们把配置放到redis数据目录的配置文件目录</span></span><br><span class="line">vim /data/redis/data/config/sentinel.conf</span><br><span class="line"><span class="built_in">bind</span> 0.0.0.0</span><br><span class="line">protected-mode no</span><br><span class="line">port 26379</span><br><span class="line">dir <span class="string">"/data/redis/data"</span></span><br><span class="line">pidfile <span class="string">"/data/redis/data/config/sentinel_26379.pid"</span></span><br><span class="line">logfile <span class="string">"/data/redis/data/logs/sentinel_26379.log"</span></span><br><span class="line">daemonize yes</span><br><span class="line"></span><br><span class="line"><span class="comment">#然后就可以启动了</span></span><br><span class="line">/usr/<span class="built_in">local</span>/codis/redis-sentinel /data/redis/data/config/sentinel.conf</span><br><span class="line"></span><br><span class="line"><span class="comment">#验证一下</span></span><br><span class="line">/usr/<span class="built_in">local</span>/codis/redis-cli -p 26379 -c info Sentinel</span><br><span class="line"></span><br><span class="line"><span class="comment"># Sentinel</span></span><br><span class="line">sentinel_masters:3</span><br><span class="line">sentinel_tilt:0</span><br><span class="line">sentinel_running_scripts:0</span><br><span class="line">sentinel_scripts_queue_length:0</span><br><span class="line">sentinel_simulate_failure_flags:0</span><br><span class="line">master0:name=codis-test1-3,status=ok,address=10.0.2.7:6380,slaves=1,sentinels=3</span><br><span class="line">master1:name=codis-test1-1,status=ok,address=10.0.2.5:6379,slaves=1,sentinels=3</span><br><span class="line">master2:name=codis-test1-2,status=ok,address=10.0.2.6:6379,slaves=1,sentinels=3</span><br></pre></td></tr></table></figure><p>配置并启动成功.</p><p><font color="red"><strong>注意：</strong>没有配置好codis-dashboard会没最后那几行,因为还不受zookeeper控制,所以是正常的,配置好之后才会自动加载进来。</font></p><h4 id="2-3-4-配置codis-proxy-这次只有两台要配置，当然你也可以配三台"><a href="#2-3-4-配置codis-proxy-这次只有两台要配置，当然你也可以配三台" class="headerlink" title="2.3.4 配置codis-proxy,这次只有两台要配置，当然你也可以配三台"></a>2.3.4 配置codis-proxy,这次只有两台要配置，当然你也可以配三台</h4><p>这个是codis集群的核心,实际上他也没配主从架构,配置也是从zookeeper拿来用的,所以,直接来看配置吧</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#配置很多,我们先生成一下默认的配置文件</span></span><br><span class="line">/usr/<span class="built_in">local</span>/codis/codis-proxy --default-config | tee ./proxy.conf</span><br><span class="line"></span><br><span class="line"><span class="comment">#然后我们把配置放到redis数据目录的配置文件目录,再更改关键位置,其他默认即可</span></span><br><span class="line">vim /data/redis/data/config/proxy.conf</span><br><span class="line"></span><br><span class="line"><span class="comment">#项目名称,会登记在zookeeper里,如果你想一套zookeeper管理多套codis,就必须区分好</span></span><br><span class="line">product_name = <span class="string">"codis-test1"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置登录dashboard的密码(与真实redis中requirepass一致)</span></span><br><span class="line">product_auth = <span class="string">"123"</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#客户端(redis-cli)的登录密码(与真实redis中requirepass不一致),是登录codis的密码</span></span><br><span class="line">session_auth = <span class="string">"123456"</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#管理的端口,0.0.0.0即对所有ip开放,基于安全考虑,可以限制内网</span></span><br><span class="line">admin_addr = <span class="string">"0.0.0.0:11080"</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#用那种方式通信,假如你的网络支持tcp6的话就可以设别的</span></span><br><span class="line">proto_type = <span class="string">"tcp4"</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#客户端(redis-cli)访问代理的端口,0.0.0.0即对所有ip开放</span></span><br><span class="line">proxy_addr = <span class="string">"0.0.0.0:19000"</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#外部配置存储类型,我们用的就是zookeeper,当然也是还有其他可以支持,这里不展开说</span></span><br><span class="line">jodis_name = <span class="string">"zookeeper"</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#配置zookeeper的连接地址,这里是三台就填三台</span></span><br><span class="line">jodis_addr = <span class="string">"10.0.2.5:2181,10.0.2.6:2181,10.0.2.7:2181"</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#zookeeper的密码,假如有的话</span></span><br><span class="line">jodis_auth = <span class="string">""</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#codis代理的最大连接数,默认是1000</span></span><br><span class="line">proxy_max_clients = 1000</span><br><span class="line"></span><br><span class="line"><span class="comment">#假如并发太大,你可能需要调这个pipeline参数,大多数情况默认就够了</span></span><br><span class="line">session_max_pipeline = 10000</span><br><span class="line"></span><br><span class="line"><span class="comment">#然后就可以启动了,</span></span><br><span class="line">/usr/<span class="built_in">local</span>/codis/codis-proxy --ncpu=1 --config=/data/redis/data/config/proxy.conf --<span class="built_in">log</span>=/data/redis/data/logs/proxy.log &amp;</span><br><span class="line"></span><br><span class="line"><span class="comment">#验证一下</span></span><br><span class="line">ss -ntplu |grep codis-proxy</span><br><span class="line">tcp    LISTEN     0      128       *:19000                 *:*                   users:((<span class="string">"codis-proxy"</span>,pid=2075,fd=4))</span><br><span class="line">tcp    LISTEN     0      128      :::11080                :::*                   users:((<span class="string">"codis-proxy"</span>,pid=2075,fd=6))</span><br></pre></td></tr></table></figure><blockquote><p><strong>–ncpu</strong> 指定使用多少个cpu,我的是虚拟机,所以就1了,如果你是多核,那就填多个</p><p><strong>–config</strong> 指定配置文件,就是刚才的配置文件</p><p><strong>–log</strong> 指定输出日志文件</p></blockquote><p>配置并启动成功,但是暂时还用不了,因为还需要配置codis-dashboard才能最终完成.</p><h4 id="2-3-5-配置codis-dashboard-只需要配置一台机上"><a href="#2-3-5-配置codis-dashboard-只需要配置一台机上" class="headerlink" title="2.3.5 配置codis-dashboard,只需要配置一台机上"></a>2.3.5 配置codis-dashboard,只需要配置一台机上</h4><p>这个属于管理配置codis集群信息的工具,配置完之后的配置信息会自动加载到zookeeper集群,即使这个服务挂了,配置都还在zookeeper上,所以不用考虑高可用,单点就足够了,大不了重新启动一下也不是特别麻烦,配置界面由codis-fe来实现,所以通常也是一套配置.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#我们也可以用程序来生成一下默认配置文件</span></span><br><span class="line">/usr/<span class="built_in">local</span>/codis/codis-dashboard --default-config | tee ./dashboard.conf</span><br><span class="line"></span><br><span class="line"><span class="comment">#然后我们把配置放到redis数据目录的配置文件目录,再更改关键位置,其他默认即可</span></span><br><span class="line">vim /data/redis/data/config/dashboard.conf</span><br><span class="line"></span><br><span class="line"><span class="comment">#外部配置存储类型,我们用的就是zookeeper,当然也是还有其他可以支持,这里不展开说</span></span><br><span class="line">coordinator_name = <span class="string">"zookeeper"</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#配置zookeeper的连接地址,这里是三台就填三台</span></span><br><span class="line">coordinator_addr = <span class="string">"10.0.2.5:2181,10.0.2.6:2181,10.0.2.7:2181"</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#项目名称,会登记在zookeeper里,如果你想一套zookeeper管理多套codis,就必须区分好</span></span><br><span class="line">product_name = <span class="string">"codis-test1"</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#所有redis的登录密码(与真实redis中requirepass一致),因为要登录进去修改数据</span></span><br><span class="line">product_auth = <span class="string">"123"</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#codis-dashboard的通信端口,0.0.0.0表示对所有开放,最好使用内网地址</span></span><br><span class="line">admin_addr = <span class="string">"0.0.0.0:18080"</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#如果想要在codis集群在故障切换功能上执行一些脚本,可以配置以下两个配置</span></span><br><span class="line">sentinel_notification_script = <span class="string">""</span></span><br><span class="line">sentinel_client_reconfig_script = <span class="string">""</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#然后就可以启动了,</span></span><br><span class="line">/usr/<span class="built_in">local</span>/codis/codis-dashboard --ncpu=1 --config=/data/redis/data/config/dashboard.conf --<span class="built_in">log</span>=/data/redis/data/logs/codis_dashboard.log --<span class="built_in">log</span>-level=WARN &amp;</span><br><span class="line"></span><br><span class="line"><span class="comment">#验证一下</span></span><br><span class="line">ss -ntplu |grep codis-dashboard</span><br><span class="line">tcp    LISTEN     0      128      :::18080                :::*                   users:((<span class="string">"codis-dashboard"</span>,pid=2021,fd=5))</span><br></pre></td></tr></table></figure><blockquote><p><strong>–ncpu</strong> 指定使用多少个cpu</p><p><strong>–config</strong> 指定配置文件</p><p><strong>–log</strong> 指定输出日志文件</p><p><strong>–log-level</strong> 指定日志等级,有INFO,WARN,DEBUG,ERROR</p></blockquote><p>安装完成,就差最后一步就可以开始配置.</p><p><font color="Blue">由于codis-dashboard本身是不需要密码登录的,所以这将会非常危险,强烈建议使用内网地址,而作者表示将会在下个版本考虑增加codis-dashboard的认证密码。</font></p><h4 id="2-3-6-配置codis-fe-只需要配置一台机上"><a href="#2-3-6-配置codis-fe-只需要配置一台机上" class="headerlink" title="2.3.6 配置codis-fe,只需要配置一台机上"></a>2.3.6 配置codis-fe,只需要配置一台机上</h4><p>这个是属于web界面操作codis-dashboard配置的工具,web代码文件在codis安装文件夹的目录下,具体是:/usr/local/codis/assets/这个目录.</p><p>这个工具本身不需要配置文件就能启动,只需要指定codis-dashboard的ip和端口就可以了,但是我为了方便管理,还是生成一个配置文件的好.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#生成一下配置文件,其实也就是codis-dashboard的ip和端口</span></span><br><span class="line">/usr/<span class="built_in">local</span>/codis/codis-admin --dashboard-list --zookeeper=10.0.2.6:2181 &gt;codis.json</span><br><span class="line"><span class="comment">#然后我们把配置放到redis数据目录的配置文件目录,看一下</span></span><br><span class="line">cat /data/redis/data/config/codis.json </span><br><span class="line">[</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">"name"</span>: <span class="string">"codis-test1"</span>,</span><br><span class="line">        <span class="string">"dashboard"</span>: <span class="string">"10.0.2.6:18080"</span></span><br><span class="line">    &#125;</span><br><span class="line">]</span><br><span class="line"><span class="comment">#然后就可以启动了,</span></span><br><span class="line">/usr/<span class="built_in">local</span>/codis/codis-fe --ncpu=1 --<span class="built_in">log</span>=/data/redis/data/logs/fe.log --<span class="built_in">log</span>-level=WARN --dashboard-list=/data/redis/data/config/codis.json --listen=0.0.0.0:8090 &amp;</span><br></pre></td></tr></table></figure><blockquote><p><strong>–ncpu</strong> 指定使用多少个cpu</p><p><strong>–log</strong> 指定输出日志文件</p><p><strong>–log-level</strong> 指定日志等级,有INFO,WARN,DEBUG,ERROR</p><p><strong>–dashboard-list</strong> 指定dashboard的地址和项目名称,这里因为生成了文件,所以就指定成文件了</p><p><strong>–listen</strong> 指定codis-fe的web登录端口,也就是我们通过8090来访问这个管理端了,0.0.0.0即对来访IP无限制,其实最好是限制内网</p></blockquote><p><strong>验证一下</strong></p><p><img src="/2018/01/17/codis3-2-1-ji-qun-da-jian-yu-ce-shi/%E5%9B%BE%E7%89%872.png" alt="图片2.png"></p><p>全套安装完成,成功启动.开始下一步.</p><h3 id="2-4-使用举例"><a href="#2-4-使用举例" class="headerlink" title="2.4 使用举例"></a>2.4 使用举例</h3><p>因为有了web界面,基本上就都是界面操作了,非常方便,配置会直接加载到zookeeper里面去.</p><p>首先,我们先添加codis-proxy地址和端口</p><p><img src="/2018/01/17/codis3-2-1-ji-qun-da-jian-yu-ce-shi/%E5%9B%BE%E7%89%873.png" alt="图片3.png"></p><p><strong>按顺序</strong></p><p>第一步,先添加codis-proxy的地址和管理端口,上面设置的是11080.</p><p>第二步,点击左方的橙色按钮,然后就添加完毕.</p><p>第三步,看到下方出现该有的codis-proxy地址就算完成了,然后看到右方的SYNC字样的颜色是绿色,则代表配置正常.</p><p>如果要删除记录,点击最右方的红色按钮即可.</p><p>然后,我们添加真实redis-server(也是codis-server)地址和端口</p><p><img src="/2018/01/17/codis3-2-1-ji-qun-da-jian-yu-ce-shi/%E5%9B%BE%E7%89%874.png" alt="企业微信截图_20180104161941.png"></p><p>按顺序:</p><p>第一步,先创建一个组,准备把相关的一组主从放进去</p><p>第二步,点击按钮生成这个分组</p><p>第三步,添加真实redis-server地址,并选定一个分组,例如刚才创建的分组1</p><p>第四步,点击按钮生成配置</p><p>第五步,可以看到配置已经登记好,注意sync状态.</p><p>第六步,点击重新平衡所有slots数据块(任何添加和删除新旧节点都需要点击这个)</p><p>在旧版本中slots需要手动配置,但是3.2版本之后就改成自动分配了,所以已经不需要配置,点击一下就可以了.当然你也可以手动去分配.</p><p>最后配置sentinel的地址和端口</p><p><img src="/2018/01/17/codis3-2-1-ji-qun-da-jian-yu-ce-shi/%E5%9B%BE%E7%89%875.png" alt="图片5.png"></p><p>按顺序:</p><p>第一步,添加真实的sentinel地址和端口</p><p>第二步,点击按钮添加</p><p>第三步,查看状态,这里有点不一样,他会自动添加当前主从组架构由多少台,控制切换</p><p>也正如我之前说的,他们自动去改配置文件,可以去看看sentinel的配置文件证实一下,这里不展开来说了</p><p>都配置好了,就可以使用了,连接其中一个codis-proxy测一下,注意区分好登录的地址和端口,还有密码</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">/usr/<span class="built_in">local</span>/codis/redis-cli -h 10.0.2.5 -p 19000 -a 123456</span><br><span class="line">10.0.2.5:19000&gt; info</span><br><span class="line"><span class="comment"># Server</span></span><br><span class="line">redis_version:3.2.9</span><br><span class="line">redis_git_sha1:f8bc4e32</span><br><span class="line">redis_git_dirty:0</span><br><span class="line">redis_build_id:2bdb8aa56be3fbc2</span><br><span class="line">redis_mode:standalone</span><br><span class="line">os:Linux 4.10.0-19-generic x86_64</span><br><span class="line">arch_bits:64</span><br><span class="line">multiplexing_api:epoll</span><br><span class="line">gcc_version:4.8.4</span><br><span class="line">process_id:2032</span><br><span class="line">run_id:98e2364d837990dfb47be050901ef9e36ea113fa</span><br><span class="line">tcp_port:6379</span><br><span class="line">uptime_in_seconds:16312</span><br><span class="line">uptime_in_days:0</span><br><span class="line">hz:10</span><br><span class="line">lru_clock:3634855</span><br><span class="line">executable:/usr/<span class="built_in">local</span>/codis/codis-server</span><br><span class="line">config_file:/data/redis/data/config/redis_6379.conf</span><br><span class="line"> </span><br><span class="line"><span class="comment"># Clients</span></span><br><span class="line">connected_clients:71</span><br><span class="line">client_longest_output_list:0</span><br><span class="line">client_biggest_input_buf:0</span><br><span class="line">blocked_clients:0</span><br><span class="line"> </span><br><span class="line"><span class="comment"># Memory</span></span><br><span class="line">used_memory:61878808</span><br><span class="line">used_memory_human:59.01M</span><br><span class="line">used_memory_rss:76623872</span><br><span class="line">used_memory_rss_human:73.07M</span><br><span class="line">used_memory_peak:63148384</span><br><span class="line">used_memory_peak_human:60.22M</span><br><span class="line">total_system_memory:1529741312</span><br><span class="line">total_system_memory_human:1.42G</span><br><span class="line">used_memory_lua:37888</span><br><span class="line">used_memory_lua_human:37.00K</span><br><span class="line">maxmemory:102400000</span><br><span class="line">maxmemory_human:97.66M</span><br><span class="line">maxmemory_policy:allkeys-lru</span><br><span class="line">mem_fragmentation_ratio:1.24</span><br><span class="line">mem_allocator:jemalloc-4.0.3</span><br><span class="line">.</span><br><span class="line">.</span><br><span class="line">.</span><br></pre></td></tr></table></figure><p>可以使用了.</p><h3 id="2-5-压力测试"><a href="#2-5-压力测试" class="headerlink" title="2.5 压力测试"></a>2.5 压力测试</h3><h4 id="2-5-1-性能测试"><a href="#2-5-1-性能测试" class="headerlink" title="2.5.1 性能测试"></a>2.5.1 性能测试</h4><p>先用自带的redis-benchmark来压测性能,模拟500个并发和100万个请求.注意区分好登录的地址和端口,还有密码</p><p>先压测codis-proxy的性能</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/<span class="built_in">local</span>/codis/redis-benchmark -h 10.0.2.5 -p 19000 -a 123456 -c 500 -n 1000000 -q</span><br></pre></td></tr></table></figure><p>再压测单节点的性能</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/<span class="built_in">local</span>/codis/redis-benchmark -h 10.0.2.5 -p 6379 -a 123 -c 500 -n 1000000 -q</span><br></pre></td></tr></table></figure><p>redis-benchmark参数解析:</p><blockquote><p><strong>-h</strong> ip地址</p><p><strong>-p</strong> redis端口</p><p><strong>-a</strong> 认证密码</p><p><strong>-c</strong> 设定多少个并发连接</p><p><strong>-n</strong> 总共多少个请求</p><p><strong>-q</strong> 显示模式:简要模式</p></blockquote><p>然后看图</p><p><img src="/2018/01/17/codis3-2-1-ji-qun-da-jian-yu-ce-shi/%E5%9B%BE%E7%89%876.png" alt="图片6.png"></p><p>可以看到,有些操作相差不大,有些相差甚远,性能损耗明显,不过作为集群应用,主要应对的是高并发环境,性能损耗是可以接受的,何况对于redis这种内存型高速应用来说,性能损耗基本没什么太大感知.</p><h4 id="2-5-2-数据分布测试"><a href="#2-5-2-数据分布测试" class="headerlink" title="2.5.2 数据分布测试"></a>2.5.2 数据分布测试</h4><p>然后是读写分布测试:</p><p>我写了个脚本来测试:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">cat t-redis.sh</span><br><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">hos=<span class="string">"10.0.2.7"</span></span><br><span class="line">pot=<span class="string">"19000"</span></span><br><span class="line">pawd=<span class="string">"123456"</span></span><br><span class="line">cli=<span class="string">"/usr/local/codis/redis-cli"</span></span><br><span class="line">keyset=<span class="string">"keytest2"</span></span><br><span class="line">valueset=<span class="string">"jlasdnfnsdfsdf;sdfhlkjahsdjlkfadfjkasdbbcjhdgasfyuefkbadjkhflk"</span></span><br><span class="line">dbname=2</span><br><span class="line">a=0</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> `seq 1 300000`</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">        <span class="variable">$cli</span> -h <span class="variable">$hos</span> -p <span class="variable">$pot</span> -a <span class="variable">$pawd</span> -n <span class="variable">$dbname</span> <span class="string">'set'</span> <span class="variable">$&#123;keyset&#125;</span><span class="variable">$&#123;a&#125;</span> <span class="string">"<span class="variable">$&#123;valueset&#125;</span><span class="variable">$&#123;a&#125;</span>"</span> &gt;/dev/null</span><br><span class="line">        <span class="comment">#echo $a</span></span><br><span class="line">        <span class="built_in">let</span> a++</span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure><p>脚本很简单,就是不断向codis集群写垃圾数据而已,执行脚本.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bash t-redis.sh</span><br></pre></td></tr></table></figure><p>然后结果可以看web界面,因为你连接codis-proxy用info来看,其实是不准确的,那个显示的只是单台的数据.</p><p><img src="/2018/01/17/codis3-2-1-ji-qun-da-jian-yu-ce-shi/%E5%9B%BE%E7%89%877.png" alt="图片7.png"></p><p>可以看到,每一个组都分布得比较均匀,把压力都分到三台redis-server主服务器去了.</p><h4 id="2-5-3-故障切换测试"><a href="#2-5-3-故障切换测试" class="headerlink" title="2.5.3 故障切换测试"></a>2.5.3 故障切换测试</h4><p>然后来看故障切换,继续执行那个脚本</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bash t-redis.sh</span><br></pre></td></tr></table></figure><p>进入其中一台codis-server,例如10.0.2.5,此时状态是正常的.</p><p><img src="/2018/01/17/codis3-2-1-ji-qun-da-jian-yu-ce-shi/%E5%9B%BE%E7%89%878.png" alt="图片8.png"></p><p>开始模拟操作</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#查找主库进程</span></span><br><span class="line">ss -ntplu |grep codis-server </span><br><span class="line">tcp    LISTEN     0      128       *:6379                  *:*                   users:((<span class="string">"codis-server"</span>,pid=2032,fd=4))</span><br><span class="line">tcp    LISTEN     0      128       *:6380                  *:*                   users:((<span class="string">"codis-server"</span>,pid=2037,fd=4))</span><br><span class="line"></span><br><span class="line"><span class="comment">#杀掉主库进程</span></span><br><span class="line"><span class="built_in">kill</span> 2032</span><br></pre></td></tr></table></figure><p>此时从库接管了主库的进程,sentinels有提示信息.</p><p><img src="/2018/01/17/codis3-2-1-ji-qun-da-jian-yu-ce-shi/%E5%9B%BE%E7%89%879.png" alt="图片9.png"></p><p>可能有人发现组1的sync按钮变成了红色,也就是说主从失效,点一下就变回正常.</p><p>现在等待数据写完,我先把旧的主进程6379端口从新起来</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="regexp">/usr/</span>local<span class="regexp">/codis/</span>codis-server <span class="regexp">/data/</span>redis<span class="regexp">/data/</span>config<span class="regexp">/redis_6379.conf</span></span><br></pre></td></tr></table></figure><p>然后看看：</p><p><img src="/2018/01/17/codis3-2-1-ji-qun-da-jian-yu-ce-shi/%E5%9B%BE%E7%89%8710.png" alt="图片10.png"></p><p>看状态是恢复正常了,但是有计算机的同学可以算一下,我的脚本执行的总共是30万个key,但是现在少了几千个.</p><p><strong>遇到的坑</strong></p><p>上面丢key的问题是由于redis-sentinel故障切换期间,整个codis集群并不会关闭对此故障redis-server的连接,所以codis-proxy依然会发送数据给当前故障的redis-server,而显然此时的redis-server是无法存储数据的,这就造成了丢key现象了.如果整个主从挂了,就会丢掉所有发送到此redis-server的key了,除非手工剔除故障节点.</p><p>虽然codis还自带有一种故障切换程序codis-ha,他属于一个守护进程,会连接codis-dashboard查看各节点状态,</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#执行一下命令启动codis-ha,端口是codis-dashboard的端口</span></span><br><span class="line">/usr/<span class="built_in">local</span>/codis/codis-ha --dashboard=10.0.2.6:18080 --<span class="built_in">log</span>=/data/redis/data/logs/ha.log --<span class="built_in">log</span>-level=WARN &amp;</span><br></pre></td></tr></table></figure><blockquote><p><strong>–dashboard</strong> 指定dashboard的地址和端口</p><p><strong>–log</strong> 指定日志文件</p><p><strong>–log-level</strong> 指定日志等级,有INFO,WARN,DEBUG,ERROR</p></blockquote><p>但是这个软件也是有缺陷,他会自动连接上dashboard检测各主从结构的健康信息,检测间隔很快(默认3秒,可修改参数–interval),检测到故障后,会将故障主库或者从库强制下线并删除在dashboard登记的信息.</p><p>虽然切换速度非常快,只会有很少的丢key现象(3秒还是会丢一些),但是后面会把故障旧主库强制下线,需要手动修改配置并重新启动redis-server(codis-server),还要再在codis-fe界面添加配置才行.</p><p><img src="/2018/01/17/codis3-2-1-ji-qun-da-jian-yu-ce-shi/%E5%9B%BE%E7%89%8711.png" alt="1.png"></p><p>显然这是做不到全自动管理,有点麻烦了，<font color="red">而且也会让redis-sentinel变得没有意义了,所以只能两个方式选其一。</font></p><p>虽然看上去丢key现象是少了,但是依然还是有丢key的情况,只能说是50步笑100步,而且该组内其他 slave 实例是不会自动改变状态的，这些 slave 仍将试图从旧的 master 上同步数据，因而会导致组内新的 master 和其他 slave 之间的数据不一致。因此当出现主从切换时，需要管理员手动创建新的 sync action 来完成新 master 与 slave 之间的数据同步,这样反而增加了手动操作的工作量,各位对于codis-ha和redis-sentinel的集群的选择还是需要多考虑一些实际情况.</p><p>所以,说到底就是codis的故障切换没有做好,如果对丢key可以容忍的,就开redis-sentinel就足够了,对于数据一致性要求高的,就开codis-ha加脚本来实现比较好,各取所需.</p><h3 id="2-6-实时添加删除节点"><a href="#2-6-实时添加删除节点" class="headerlink" title="2.6 实时添加删除节点"></a>2.6 实时添加删除节点</h3><p>codis的另一个卖点就是可以在线添加/删除redis-server(codis-server)节点,做到实时扩容和更换问题节点,对于单点redis而言优势明显,不用重启服务就能有更大的空间,也可以在线切换掉有问题的节点.不过要注意,可以实时扩容和故障切换,并不代表没有性能损耗,真的要做也是要注意线上压力,避免性能压力导致的服务不可用.</p><p>实现的原理是因为codis集群把各个redis-server节点都用规则分成了多个slots数据块(总共1024个).需要扩容只要把新的节点添加完成后,在把这些slots信息从新分配就可以达到扩容效果,需要故障切换则把问题redis-server节点的slots迁移走,然后就可以把这个节点下架了,对于线上环境可以说是几乎没感知,试验过程中也没发现有丢key现象,就是性能有所下降,但是我测试的环境下性能下降还能接受,大概只有10%-30%的性能损耗.</p><p>开始试验,首先我们假设添加两个新的redis-server节点,都直接是主库,没有从库环境(因为这次不需要测故障切换):</p><p>10.0.2.5:16379</p><p>10.0.2.6:16379</p><h4 id="2-6-1-添加一个节点"><a href="#2-6-1-添加一个节点" class="headerlink" title="2.6.1 添加一个节点"></a>2.6.1 添加一个节点</h4><p>添加一个节点，等于是扩容，这还是比较简单</p><p><img src="/2018/01/17/codis3-2-1-ji-qun-da-jian-yu-ce-shi/%E5%9B%BE%E7%89%8712.png" alt="1.png"></p><p>第一步,和之前差不多,先创建一个新组,点击按钮确认添加</p><p>第二步,把新地址添加到新的组,点击按钮确认添加</p><p>第三步,确认新的地址已成功添加进去</p><p>第四步,点击按钮,从新分配所有slots数据块</p><p>这里唯一问题就是最后一步,重新分配会耗费一定资源,codis会自动平衡数据块的分布,所以会有数据迁移过程,但是据我测试的结果来看,并不很严重,大概在20%左右.</p><p>根据它自带的监控来看的话,</p><p><img src="/2018/01/17/codis3-2-1-ji-qun-da-jian-yu-ce-shi/%E5%9B%BE%E7%89%8719.png" alt="2.png"></p><p>可以看到之前正常情况的qps接近1500,刚点重新平衡下降比较严重一些,后面就大概有20%的性能损耗那样子,最后迁移完毕就恢复正常了.当然这是数据量少的情况,如果数据量多,这个迁移时间就恐怕不是那么简单了.</p><h4 id="2-6-2-切换一个节点，并下架"><a href="#2-6-2-切换一个节点，并下架" class="headerlink" title="2.6.2 切换一个节点，并下架"></a>2.6.2 切换一个节点，并下架</h4><p>正常下架只需要点击这个按钮</p><p><img src="/2018/01/17/codis3-2-1-ji-qun-da-jian-yu-ce-shi/%E5%9B%BE%E7%89%8713.png" alt="3.png"></p><p>但是因为里面还有数据,是不允许直接下架的</p><p><img src="/2018/01/17/codis3-2-1-ji-qun-da-jian-yu-ce-shi/%E5%9B%BE%E7%89%8714.png" alt="4.png"></p><p>所以我们要先迁移数据,如下所示:</p><p><img src="/2018/01/17/codis3-2-1-ji-qun-da-jian-yu-ce-shi/%E5%9B%BE%E7%89%8715.png" alt="5.png"></p><p>第一步,确认一个需要迁移的组的数据块的编号,例如这里499-512的块是数据组4的,我现在要迁移组4,就选定这个</p><p>第二步,把刚才获取到的信息填进去,就是把500这个编号的数据块从组4迁移到组5,点击按钮执行</p><p>然后你就会看到,</p><p><img src="/2018/01/17/codis3-2-1-ji-qun-da-jian-yu-ce-shi/%E5%9B%BE%E7%89%8716.png" alt="6.png"></p><p>显然组4的信息消失了,codis把组4的数据块都迁移到了组5去了,</p><p>这个时候,这个redis-server节点就可以删除了</p><p><img src="/2018/01/17/codis3-2-1-ji-qun-da-jian-yu-ce-shi/%E5%9B%BE%E7%89%8717.png" alt="7.png"></p><p>至于还需不需要重新填补,这个问题则需要自身考虑.如果不需要填补,最好再点一下重新平衡slots比较好.</p><p><img src="/2018/01/17/codis3-2-1-ji-qun-da-jian-yu-ce-shi/%E5%9B%BE%E7%89%8718.png" alt="8.png"></p><p>可以看到,又重新平衡了.</p><h3 id="2-7-故障处理"><a href="#2-7-故障处理" class="headerlink" title="2.7 故障处理"></a>2.7 故障处理</h3><h4 id="2-7-1-codis-dashboard无法启动，并提示："><a href="#2-7-1-codis-dashboard无法启动，并提示：" class="headerlink" title="2.7.1 codis-dashboard无法启动，并提示："></a>2.7.1 codis-dashboard无法启动，并提示：</h4><blockquote><p>[ERROR] store: acquire lock of codis-test1 failed<br>[error]: zk: node already exists</p></blockquote><p>由于是测试环境,我经常强制关机,导致codis-dashboard没有正常关闭.直接造成zookeeper里面的状态没有更新,最终新启动的codis-dashboard不能注册进zookeeper,一直提示已存在而被强制关闭.</p><p>修复方法也不难,就是删除这个lock的状态键值就可以了</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#输入项目名和zookeeper地址</span></span><br><span class="line">/usr/<span class="built_in">local</span>/codis/codis-admin --remove-lock --product=codis-test1 --zookeeper=10.0.2.6:2181</span><br></pre></td></tr></table></figure><p>然后,codis-dashboard又可以正常启动了.</p><p>codis-admin是可以全权控制codis集群的工具,所有添加/删除/修改的工作都可以用他来实现,参数很多,这里只是举例了一个方法,详细可以参照codis-admin –help</p><h4 id="2-7-2-codis-proxy异常退出导致无法删除"><a href="#2-7-2-codis-proxy异常退出导致无法删除" class="headerlink" title="2.7.2 codis-proxy异常退出导致无法删除"></a>2.7.2 codis-proxy异常退出导致无法删除</h4><p>通常codis-proxy都是通过codis-dashboard进行移除，移除过程中codis-dashboard为了安全会向codis-proxy发送offline指令，成功后才会将proxy信息从外部存储（zookeeper）中移除。如果codis-proxy异常退出，该操作会失败。此时需要手动删除zookeeper信息。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#先登入zookeeper进行操作</span></span><br><span class="line">/usr/<span class="built_in">local</span>/zookeeper/bin/zkCli.sh -server</span><br><span class="line"></span><br><span class="line"><span class="comment">#确认有问题的codis-proxy地址对应在zookeeper上的信息</span></span><br><span class="line">[zk: localhost:2181(CONNECTED) 6] get  /codis3/codis-zyyhj1/proxy/proxy-80722e128c6e8fc3d0da44983343a843</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"id"</span>: 1,</span><br><span class="line">    <span class="string">"token"</span>: <span class="string">"80722e128c6e8fc3d0da44983343a843"</span>,</span><br><span class="line">    <span class="string">"start_time"</span>: <span class="string">"2018-06-16 23:30:57.44436209 +0800 CST"</span>,</span><br><span class="line">    <span class="string">"admin_addr"</span>: <span class="string">"10.21.1.140:11080"</span>,</span><br><span class="line">    <span class="string">"proto_type"</span>: <span class="string">"tcp4"</span>,</span><br><span class="line">    <span class="string">"proxy_addr"</span>: <span class="string">"10.21.1.140:19000"</span>,</span><br><span class="line">    <span class="string">"jodis_path"</span>: <span class="string">"/jodis/codis-zyyhj1/proxy-80722e128c6e8fc3d0da44983343a843"</span>,</span><br><span class="line">    <span class="string">"product_name"</span>: <span class="string">"codis-zyyhj1"</span>,</span><br><span class="line">    <span class="string">"pid"</span>: 26493,</span><br><span class="line">    <span class="string">"pwd"</span>: <span class="string">"/root"</span>,</span><br><span class="line">    <span class="string">"sys"</span>: <span class="string">"Linux localhost.localdomain 3.10.0-514.el7.x86_64 #1 SMP Tue Nov 22 16:42:41 UTC 2016 x86_64 x86_64 x86_64 GNU/Linux"</span>,</span><br><span class="line">    <span class="string">"hostname"</span>: <span class="string">"localhost.localdomain"</span>,</span><br><span class="line">    <span class="string">"datacenter"</span>: <span class="string">""</span></span><br><span class="line">&#125;</span><br><span class="line">cZxid = 0x100001c7b</span><br><span class="line">ctime = Fri Jun 15 21:02:22 CST 2018</span><br><span class="line">mZxid = 0x1000038ae</span><br><span class="line">mtime = Sat Jun 16 23:30:57 CST 2018</span><br><span class="line">pZxid = 0x100001c7b</span><br><span class="line">cversion = 0</span><br><span class="line">dataVersion = 2</span><br><span class="line">aclVersion = 0</span><br><span class="line">ephemeralOwner = 0x0</span><br><span class="line">dataLength = 576</span><br><span class="line">numChildren = 0</span><br><span class="line"></span><br><span class="line"><span class="comment">#确认完毕,删除</span></span><br><span class="line">[zk: localhost:2181(CONNECTED) 7] rmr /codis3/codis-zyyhj1/proxy/proxy-80722e128c6e8fc3d0da44983343a843</span><br><span class="line"></span><br><span class="line"><span class="comment">#删除完毕,还需要重载一下dashboard,不然信息也是不会更新的</span></span><br><span class="line">/usr/<span class="built_in">local</span>/codis/codis-admin  --dashboard=10.21.1.124:18081 --reload</span><br></pre></td></tr></table></figure><p>然后,删不掉的proxy端就不见了,完成.</p><p><strong>备注</strong>:</p><p>codis不支持命令列表：</p><table><thead><tr><th>Command Type</th><th>Command Name</th></tr></thead><tbody><tr><td>Keys</td><td>KEYS</td></tr><tr><td></td><td>MIGRATE</td></tr><tr><td></td><td>MOVE</td></tr><tr><td></td><td>OBJECT</td></tr><tr><td></td><td>RANDOMKEY</td></tr><tr><td></td><td>RENAME</td></tr><tr><td></td><td>RENAMENX</td></tr><tr><td></td><td>SCAN</td></tr><tr><td></td><td></td></tr><tr><td>Strings</td><td>BITOP</td></tr><tr><td></td><td>MSETNX</td></tr><tr><td></td><td></td></tr><tr><td>Lists</td><td>BLPOP</td></tr><tr><td></td><td>BRPOP</td></tr><tr><td></td><td>BRPOPLPUSH</td></tr><tr><td></td><td></td></tr><tr><td>Pub/Sub</td><td>PSUBSCRIBE</td></tr><tr><td></td><td>PUBLISH</td></tr><tr><td></td><td>PUNSUBSCRIBE</td></tr><tr><td></td><td>SUBSCRIBE</td></tr><tr><td></td><td>UNSUBSCRIBE</td></tr><tr><td></td><td></td></tr><tr><td>Transactions</td><td>DISCARD</td></tr><tr><td></td><td>EXEC</td></tr><tr><td></td><td>MULTI</td></tr><tr><td></td><td>UNWATCH</td></tr><tr><td></td><td>WATCH</td></tr><tr><td></td><td></td></tr><tr><td>Scripting</td><td>SCRIPT</td></tr><tr><td></td><td></td></tr><tr><td>Server</td><td>BGREWRITEAOF</td></tr><tr><td></td><td>BGSAVE</td></tr><tr><td></td><td>CLIENT</td></tr><tr><td></td><td>CONFIG</td></tr><tr><td></td><td>DBSIZE</td></tr><tr><td></td><td>DEBUG</td></tr><tr><td></td><td>FLUSHALL</td></tr><tr><td></td><td>FLUSHDB</td></tr><tr><td></td><td>LASTSAVE</td></tr><tr><td></td><td>MONITOR</td></tr><tr><td></td><td>RESTORE</td></tr><tr><td></td><td>SAVE</td></tr><tr><td></td><td>SHUTDOWN</td></tr><tr><td></td><td>SLAVEOF</td></tr><tr><td></td><td>SLOWLOG</td></tr><tr><td></td><td>SYNC</td></tr><tr><td></td><td>TIME</td></tr><tr><td></td><td></td></tr><tr><td>Codis Slot</td><td>SLOTSCHECK</td></tr><tr><td></td><td>SLOTSDEL</td></tr><tr><td></td><td>SLOTSINFO</td></tr><tr><td></td><td>SLOTSMGRTONE</td></tr><tr><td></td><td>SLOTSMGRTSLOT</td></tr><tr><td></td><td>SLOTSMGRTTAGONE</td></tr><tr><td></td><td>SLOTSMGRTTAGSLOT</td></tr></tbody></table><p>以下属于半支持命令, Codis不支持跨节点操作，因此您必须使用散列标签将可能显示在一个请求中的所有密钥放入同一个插槽中，然后您可以使用这些命令。 Codis不检查密钥是否有相同的标签，所以如果你不使用标签，你的程序会得到错误的回应。</p><table><thead><tr><th>Command Type</th><th>Command Name</th></tr></thead><tbody><tr><td>Lists</td><td>RPOPLPUSH</td></tr><tr><td>Sets</td><td>SDIFF</td></tr><tr><td></td><td>SINTER</td></tr><tr><td></td><td>SINTERSTORE</td></tr><tr><td></td><td>SMOVE</td></tr><tr><td></td><td>SUNION</td></tr><tr><td></td><td>SUNIONSTORE</td></tr><tr><td>Sorted Sets</td><td>ZINTERSTORE</td></tr><tr><td></td><td>ZUNIONSTORE</td></tr><tr><td>HyperLogLog</td><td>PFMERGE</td></tr><tr><td>Scripting</td><td>EVAL</td></tr><tr><td></td><td>EVALSHA</td></tr></tbody></table><p>原文链接：<a href="https://blog.51cto.com/arthur376/2051993" target="_blank" rel="noopener">https://blog.51cto.com/arthur376/2051993</a></p></div><div><div><div style="text-align:center;color:#ccc;font-size:14px">-------------本文结束<i class="fa fa-paw"></i>感谢您的阅读-------------</div></div></div><div></div><footer class="post-footer"><div class="post-tags"><a href="/tags/%E7%BC%93%E5%AD%98/" rel="tag"><i class="fa fa-tag"></i> 缓存</a> <a href="/tags/Redis/" rel="tag"><i class="fa fa-tag"></i> Redis</a> <a href="/tags/Codis/" rel="tag"><i class="fa fa-tag"></i> Codis</a></div><div class="post-nav"><div class="post-nav-next post-nav-item"><a href="/2018/01/11/tomcat-pei-zhi-wen-jian-server-xml-xiang-jie/" rel="next" title="Tomcat 配置文件server.xml详解"><i class="fa fa-chevron-left"></i> Tomcat 配置文件server.xml详解</a></div><span class="post-nav-divider"></span><div class="post-nav-prev post-nav-item"><a href="/2018/01/20/mysql-proxy-zhu-cong-fu-zhi-yu-du-xie-fen-chi/" rel="prev" title="MySQL-Proxy 主从复制与读写分离">MySQL-Proxy 主从复制与读写分离 <i class="fa fa-chevron-right"></i></a></div></div></footer></div></article><div class="post-spread"><div class="jiathis_style"><span class="jiathis_txt">分享到：</span> <a class="jiathis_button_fav">收藏夹</a> <a class="jiathis_button_copy">复制网址</a> <a class="jiathis_button_email">邮件</a> <a class="jiathis_button_weixin">微信</a> <a class="jiathis_button_qzone">QQ空间</a> <a class="jiathis_button_tqq">腾讯微博</a> <a class="jiathis_button_douban">豆瓣</a> <a class="jiathis_button_share">一键分享</a> <a href="http://www.jiathis.com/share?uid=2140465" class="jiathis jiathis_txt jiathis_separator jtico jtico_jiathis" target="_blank">更多</a> <a class="jiathis_counter_style"></a></div><script type="text/javascript">var jiathis_config={data_track_clickback:!0,summary:"",shortUrl:!1,hideMore:!1}</script><script type="text/javascript" src="http://v3.jiathis.com/code/jia.js?uid=" charset="utf-8"></script></div></div></div></div><div class="sidebar-toggle"><div class="sidebar-toggle-line-wrap"><span class="sidebar-toggle-line sidebar-toggle-line-first"></span> <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span> <span class="sidebar-toggle-line sidebar-toggle-line-last"></span></div></div><aside id="sidebar" class="sidebar"><div id="sidebar-dimmer"></div><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">文章目录</li><li class="sidebar-nav-overview" data-target="site-overview-wrap">站点概览</li></ul><section class="site-overview-wrap sidebar-panel"><div class="site-overview"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="site-author-image" itemprop="image" src="/images/chen.png" alt="Zhongzhou Chen"><p class="site-author-name" itemprop="name">Zhongzhou Chen</p><p class="site-description motion-element" itemprop="description"></p></div><nav class="site-state motion-element"><div class="site-state-item site-state-posts"><a href="/archives/%7C%7C%20archive"><span class="site-state-item-count">282</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"><a href="/categories/index.html"><span class="site-state-item-count">84</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"><a href="/tags/index.html"><span class="site-state-item-count">164</span> <span class="site-state-item-name">标签</span></a></div></nav><div class="feed-link motion-element"><a href="/atom.xml" rel="alternate"><i class="fa fa-rss"></i> RSS</a></div></div></section><section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active"><div class="post-toc"><div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#1、Codis简介"><span class="nav-text">1、Codis简介</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2、部署Codis集群"><span class="nav-text">2、部署Codis集群</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-1-架构介绍"><span class="nav-text">2.1 架构介绍</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#2-1-1-需要用到的软件有"><span class="nav-text">2.1.1 需要用到的软件有</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-2-2-逻辑架构如下"><span class="nav-text">2.2.2 逻辑架构如下:</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-2-3-因为机器有限-部署的架构如下"><span class="nav-text">2.2.3 因为机器有限,部署的架构如下:</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2-安装部署"><span class="nav-text">2.2 安装部署</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#2-2-1-下载程序代码"><span class="nav-text">2.2.1 下载程序代码</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-2-2-安装程序"><span class="nav-text">2.2.2 安装程序</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-3-配置程序"><span class="nav-text">2.3 配置程序</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#2-3-1-配置zookeeper，3台一起都是这么配置"><span class="nav-text">2.3.1 配置zookeeper，3台一起都是这么配置</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-3-2-配置codis-server，3台一起都是这么配置"><span class="nav-text">2.3.2 配置codis-server，3台一起都是这么配置</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-3-3-配置redis-sentinel，3台一起都是这么配置"><span class="nav-text">2.3.3 配置redis-sentinel，3台一起都是这么配置</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-3-4-配置codis-proxy-这次只有两台要配置，当然你也可以配三台"><span class="nav-text">2.3.4 配置codis-proxy,这次只有两台要配置，当然你也可以配三台</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-3-5-配置codis-dashboard-只需要配置一台机上"><span class="nav-text">2.3.5 配置codis-dashboard,只需要配置一台机上</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-3-6-配置codis-fe-只需要配置一台机上"><span class="nav-text">2.3.6 配置codis-fe,只需要配置一台机上</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-4-使用举例"><span class="nav-text">2.4 使用举例</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-5-压力测试"><span class="nav-text">2.5 压力测试</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#2-5-1-性能测试"><span class="nav-text">2.5.1 性能测试</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-5-2-数据分布测试"><span class="nav-text">2.5.2 数据分布测试</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-5-3-故障切换测试"><span class="nav-text">2.5.3 故障切换测试</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-6-实时添加删除节点"><span class="nav-text">2.6 实时添加删除节点</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#2-6-1-添加一个节点"><span class="nav-text">2.6.1 添加一个节点</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-6-2-切换一个节点，并下架"><span class="nav-text">2.6.2 切换一个节点，并下架</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-7-故障处理"><span class="nav-text">2.7 故障处理</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#2-7-1-codis-dashboard无法启动，并提示："><span class="nav-text">2.7.1 codis-dashboard无法启动，并提示：</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-7-2-codis-proxy异常退出导致无法删除"><span class="nav-text">2.7.2 codis-proxy异常退出导致无法删除</span></a></li></ol></li></ol></li></ol></div></div></section><div class="back-to-top"><i class="fa fa-arrow-up"></i> <span id="scrollpercent"><span>0</span>%</span></div></div></aside></div></main><footer id="footer" class="footer"><div class="footer-inner"><script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script><div class="copyright">&copy; <span itemprop="copyrightYear">2021</span> <span class="with-love"><i class="fa fa-user"></i> </span><span class="author" itemprop="copyrightHolder">Zhongzhou Chen</span> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-area-chart"></i> </span><span class="post-meta-item-text">Site words total count&#58;</span> <span title="Site words total count">597k</span></div><span class="post-meta-divider"></span></div></footer></div><script type="text/javascript">"[object Function]"!==Object.prototype.toString.call(window.Promise)&&(window.Promise=null)</script><script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script><script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script><script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script><script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script><script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script><script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script><script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script><script type="text/javascript">function proceedsearch(){$("body").append('<div class="search-popup-overlay local-search-pop-overlay"></div>').css("overflow","hidden"),$(".search-popup-overlay").click(onPopupClose),$(".popup").toggle();var t=$("#local-search-input");t.attr("autocapitalize","none"),t.attr("autocorrect","off"),t.focus()}var isfetched=!1,isXml=!0,search_path="search.xml";0===search_path.length?search_path="search.xml":/json$/i.test(search_path)&&(isXml=!1);var path="/"+search_path,onPopupClose=function(t){$(".popup").hide(),$("#local-search-input").val(""),$(".search-result-list").remove(),$("#no-result").remove(),$(".local-search-pop-overlay").remove(),$("body").css("overflow","")},searchFunc=function(t,e,o){"use strict";$("body").append('<div class="search-popup-overlay local-search-pop-overlay"><div id="search-loading-icon"><i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i></div></div>').css("overflow","hidden"),$("#search-loading-icon").css("margin","20% auto 0 auto").css("text-align","center"),$.ajax({url:t,dataType:isXml?"xml":"json",async:!0,success:function(t){isfetched=!0,$(".popup").detach().appendTo(".header-inner");var n=isXml?$("entry",t).map(function(){return{title:$("title",this).text(),content:$("content",this).text(),url:$("url",this).text()}}).get():t,r=document.getElementById(e),s=document.getElementById(o),a=function(){var t=r.value.trim().toLowerCase(),e=t.split(/[\s\-]+/);e.length>1&&e.push(t);var o=[];if(t.length>0&&n.forEach(function(n){function r(e,o,n,r){for(var s=r[r.length-1],a=s.position,i=s.word,l=[],h=0;a+i.length<=n&&0!=r.length;){i===t&&h++,l.push({position:a,length:i.length});var p=a+i.length;for(r.pop();0!=r.length&&(s=r[r.length-1],a=s.position,i=s.word,p>a);)r.pop()}return c+=h,{hits:l,start:o,end:n,searchTextCount:h}}function s(t,e){var o="",n=e.start;return e.hits.forEach(function(e){o+=t.substring(n,e.position);var r=e.position+e.length;o+='<b class="search-keyword">'+t.substring(e.position,r)+"</b>",n=r}),o+=t.substring(n,e.end)}var a=!1,i=0,c=0,l=n.title.trim(),h=l.toLowerCase(),p=n.content.trim().replace(/<[^>]+>/g,""),u=p.toLowerCase(),f=decodeURIComponent(n.url),d=[],g=[];if(""!=l&&(e.forEach(function(t){function e(t,e,o){var n=t.length;if(0===n)return[];var r=0,s=[],a=[];for(o||(e=e.toLowerCase(),t=t.toLowerCase());(s=e.indexOf(t,r))>-1;)a.push({position:s,word:t}),r=s+n;return a}d=d.concat(e(t,h,!1)),g=g.concat(e(t,u,!1))}),(d.length>0||g.length>0)&&(a=!0,i=d.length+g.length)),a){[d,g].forEach(function(t){t.sort(function(t,e){return e.position!==t.position?e.position-t.position:t.word.length-e.word.length})});var v=[];0!=d.length&&v.push(r(l,0,l.length,d));for(var $=[];0!=g.length;){var C=g[g.length-1],m=C.position,x=C.word,w=m-20,y=m+80;0>w&&(w=0),y<m+x.length&&(y=m+x.length),y>p.length&&(y=p.length),$.push(r(p,w,y,g))}$.sort(function(t,e){return t.searchTextCount!==e.searchTextCount?e.searchTextCount-t.searchTextCount:t.hits.length!==e.hits.length?e.hits.length-t.hits.length:t.start-e.start});var T=parseInt("1");T>=0&&($=$.slice(0,T));var b="";b+=0!=v.length?"<li><a href='"+f+"' class='search-result-title'>"+s(l,v[0])+"</a>":"<li><a href='"+f+"' class='search-result-title'>"+l+"</a>",$.forEach(function(t){b+="<a href='"+f+'\'><p class="search-result">'+s(p,t)+"...</p></a>"}),b+="</li>",o.push({item:b,searchTextCount:c,hitCount:i,id:o.length})}}),1===e.length&&""===e[0])s.innerHTML='<div id="no-result"><i class="fa fa-search fa-5x" /></div>';else if(0===o.length)s.innerHTML='<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>';else{o.sort(function(t,e){return t.searchTextCount!==e.searchTextCount?e.searchTextCount-t.searchTextCount:t.hitCount!==e.hitCount?e.hitCount-t.hitCount:e.id-t.id});var a='<ul class="search-result-list">';o.forEach(function(t){a+=t.item}),a+="</ul>",s.innerHTML=a}};r.addEventListener("input",a),$(".local-search-pop-overlay").remove(),$("body").css("overflow",""),proceedsearch()}})};$(".popup-trigger").click(function(t){t.stopPropagation(),isfetched===!1?searchFunc(path,"local-search-input","local-search-result"):proceedsearch()}),$(".popup-btn-close").click(onPopupClose),$(".popup").click(function(t){t.stopPropagation()}),$(document).on("keyup",function(t){var e=27===t.which&&$(".search-popup").is(":visible");e&&onPopupClose()})</script><script type="text/javascript" src="/js/src/clipboard.min.js"></script><script type="text/javascript" src="/js/src/clipboard-use.js"></script><script type="text/javascript" src="/js/src/love.js"></script><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"log":false,"model":{"jsonPath":"/live2dw/assets/shizuku.model.json"},"display":{"position":"right"},"mobile":{"show":true,"scale":0.5},"react":{"opacityDefault":0.7,"opacityOnHover":0.2}});</script></body></html><!-- rebuild by neat -->