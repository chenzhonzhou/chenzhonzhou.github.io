<!DOCTYPE html><html class="theme-next gemini use-motion" lang="zh-Hans"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><script src="//cdn.bootcss.com/pace/1.0.2/pace.min.js"></script><link href="//cdn.bootcss.com/pace/1.0.2/themes/pink/pace-theme-flash.css" rel="stylesheet"><script></script><meta name="theme-color" content="#222"><style>.pace .pace-progress{background:#1e92fb;height:3px}.pace .pace-progress-inner{box-shadow:0 0 10px #1e92fb,0 0 5px #1e92fb}.pace .pace-activity{border-top-color:#1e92fb;border-left-color:#1e92fb}</style><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><meta name="google-site-verification" content="HGM141IpbHrSmnAmR6W_zE4bo9Z3f-yXLeHYT3bg1fk"><meta name="baidu-site-verification" content="code-5Ai1DA8e6T"><link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css"><link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css"><link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4"><link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222"><meta name="keywords" content="数据库,MySQL,"><link rel="alternate" href="/atom.xml" title="凡间的精灵" type="application/atom+xml"><meta name="description" content="1、MySQL主从复制原理Mysql内建的复制功能是构建大型，高性能应用程序的基础。将Mysql的数据分布到多个系统上去，这种分布的机制，是通过将Mysql的某一台主机的数据复制到其它主机（slaves）上，并重新执行一遍来实现的。复制过程中一个服务器充当主服务器，而一个或多个其它服务器充当从服务器。主服务器将更新写入二进制日志文件，并维护文件的一个索引以跟踪日志循环。这些日志可以记录发送到从服务"><meta name="keywords" content="数据库,MySQL"><meta property="og:type" content="article"><meta property="og:title" content="MySQL Amoeba 主从复制与读写分离"><meta property="og:url" content="http:&#x2F;&#x2F;chenzhonzhou.github.io&#x2F;2018&#x2F;01&#x2F;26&#x2F;mysql-amoeba-zhu-cong-fu-zhi-yu-du-xie-fen-chi&#x2F;index.html"><meta property="og:site_name" content="凡间的精灵"><meta property="og:description" content="1、MySQL主从复制原理Mysql内建的复制功能是构建大型，高性能应用程序的基础。将Mysql的数据分布到多个系统上去，这种分布的机制，是通过将Mysql的某一台主机的数据复制到其它主机（slaves）上，并重新执行一遍来实现的。复制过程中一个服务器充当主服务器，而一个或多个其它服务器充当从服务器。主服务器将更新写入二进制日志文件，并维护文件的一个索引以跟踪日志循环。这些日志可以记录发送到从服务"><meta property="og:locale" content="zh-Hans"><meta property="og:image" content="http:&#x2F;&#x2F;chenzhonzhou.github.io&#x2F;2018&#x2F;01&#x2F;26&#x2F;mysql-amoeba-zhu-cong-fu-zhi-yu-du-xie-fen-chi&#x2F;%E5%9B%BE%E7%89%871.png"><meta property="og:image" content="http:&#x2F;&#x2F;chenzhonzhou.github.io&#x2F;2018&#x2F;01&#x2F;26&#x2F;mysql-amoeba-zhu-cong-fu-zhi-yu-du-xie-fen-chi&#x2F;%E5%9B%BE%E7%89%872.png"><meta property="og:image" content="http:&#x2F;&#x2F;chenzhonzhou.github.io&#x2F;2018&#x2F;01&#x2F;26&#x2F;mysql-amoeba-zhu-cong-fu-zhi-yu-du-xie-fen-chi&#x2F;%E5%9B%BE%E7%89%873.png"><meta property="og:image" content="http:&#x2F;&#x2F;chenzhonzhou.github.io&#x2F;2018&#x2F;01&#x2F;26&#x2F;mysql-amoeba-zhu-cong-fu-zhi-yu-du-xie-fen-chi&#x2F;%E5%9B%BE%E7%89%874.png"><meta property="og:updated_time" content="2019-11-16T10:15:36.409Z"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="http:&#x2F;&#x2F;chenzhonzhou.github.io&#x2F;2018&#x2F;01&#x2F;26&#x2F;mysql-amoeba-zhu-cong-fu-zhi-yu-du-xie-fen-chi&#x2F;%E5%9B%BE%E7%89%871.png"><script type="text/javascript" id="hexo.configurations">var NexT=window.NexT||{},CONFIG={root:"/",scheme:"Gemini",version:"5.1.4",sidebar:{position:"left",display:"always",offset:12,b2t:!0,scrollpercent:!0,onmobile:!0},fancybox:!0,tabs:!0,motion:{enable:!0,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}},duoshuo:{userId:"0",author:"博主"},algolia:{applicationID:"",apiKey:"",indexName:"",hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}}}</script><link rel="canonical" href="http://chenzhonzhou.github.io/2018/01/26/mysql-amoeba-zhu-cong-fu-zhi-yu-du-xie-fen-chi/"><title>MySQL Amoeba 主从复制与读写分离 | 凡间的精灵</title><link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css"></head><body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans"><div class="container sidebar-position-left page-post-detail"><div class="headband"></div><header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-wrapper"><div class="site-meta"><div class="custom-logo-site-title"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">凡间的精灵</span><span class="logo-line-after"><i></i></span></a></div><p class="site-subtitle">凡尘落素一精灵</p></div><div class="site-nav-toggle"><button><span class="btn-bar"></span><span class="btn-bar"></span><span class="btn-bar"></span></button></div></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i><br>首页</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i><br>归档</a></li><li class="menu-item menu-item-categories"><a href="/categories" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i><br>分类</a></li><li class="menu-item menu-item-tags"><a href="/tags" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i><br>标签</a></li><li class="menu-item menu-item-sitemap"><a href="/sitemap.xml" rel="section"><i class="menu-item-icon fa fa-fw fa-sitemap"></i><br>站点地图</a></li><li class="menu-item menu-item-search"><a href="javascript:;" class="popup-trigger"><i class="menu-item-icon fa fa-search fa-fw"></i><br>搜索</a></li></ul><div class="site-search"><div class="popup search-popup local-search-popup"><div class="local-search-header clearfix"><span class="search-icon"><i class="fa fa-search"></i></span><span class="popup-btn-close"><i class="fa fa-times-circle"></i></span><div class="local-search-input-wrapper"><input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input"></div></div><div id="local-search-result"></div></div></div></nav></div></header><main id="main" class="main"><div class="main-inner"><div class="content-wrap"><div id="content" class="content"><div id="posts" class="posts-expand"><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><div class="post-block"><link itemprop="mainEntityOfPage" href="http://chenzhonzhou.github.io/2018/01/26/mysql-amoeba-zhu-cong-fu-zhi-yu-du-xie-fen-chi/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="name" content="Zhongzhou Chen"><meta itemprop="description" content=""><meta itemprop="image" content="/images/chen.png"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="凡间的精灵"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">MySQL Amoeba 主从复制与读写分离</h1><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i></span> <span class="post-meta-item-text">发表于</span> <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-01-26T17:55:56+08:00">2018-01-26</time></span> <span class="post-category"><span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-folder-o"></i></span> <span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/" itemprop="url" rel="index"><span itemprop="name">数据库</span></a></span> ， <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/MySQL/" itemprop="url" rel="index"><span itemprop="name">MySQL</span></a></span></span><div class="post-wordcount"><span class="post-meta-item-icon"><i class="fa fa-file-word-o"></i></span> <span class="post-meta-item-text">字数统计&#58;</span> <span title="字数统计">4.4k</span> <span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-clock-o"></i></span> <span class="post-meta-item-text">阅读时长 &asymp;</span> <span title="阅读时长">20</span></div></div></header><div class="post-body" itemprop="articleBody"><h2 id="1、MySQL主从复制原理"><a href="#1、MySQL主从复制原理" class="headerlink" title="1、MySQL主从复制原理"></a>1、MySQL主从复制原理</h2><p><strong>Mysql</strong>内建的复制功能是构建大型，高性能应用程序的基础。将<strong>Mysql</strong>的数据分布到多个系统上去，这种分布的机制，是通过将<strong>Mysql</strong>的某一台主机的数据复制到其它主机（<strong>slaves</strong>）上，并重新执行一遍来实现的。复制过程中一个服务器充当主服务器，而一个或多个其它服务器充当从服务器。主服务器将更新写入二进制日志文件，并维护文件的一个索引以跟踪日志循环。这些日志可以记录发送到从服务器的更新。当一个从服务器连接主服务器时，它通知主服务器从服务器在日志中读取的最后一次成功更新的位置。从服务器接收从那时起发生的任何更新，然后封锁并等待主服务器通知新的更新。</p><p>请注意当你进行复制时，所有对复制中的表的更新必须在主服务器上进行。否则，你必须要小心，以避免用户对主服务器上的表进行的更新与对从服务器上的表所进行的更新之间的冲突。</p><h3 id="1-1-MySQL支持复制的类型"><a href="#1-1-MySQL支持复制的类型" class="headerlink" title="1.1 MySQL支持复制的类型"></a>1.1 MySQL支持复制的类型</h3><p><strong>MySQL支持复制的类型也就是二进制日志格式：</strong></p><ol><li><strong>基于语句的复制：</strong> 在主服务器上执行的SQL语句，在从服务器上执行同样的语句。MySQL默认采用基于语句的复制，效率比较高</li><li><strong>基于行的复制：</strong>把改变的内容复制过去，而不是把命令在从服务器上执行一遍. 从mysql5.0开始支持</li><li><strong>混合类型的复制：</strong> 默认采用基于语句的复制，一旦发现基于语句的无法精确的复制时，就会采用基于行的复制。</li></ol><h3 id="1-2-复制的特点"><a href="#1-2-复制的特点" class="headerlink" title="1.2 复制的特点"></a>1.2 复制的特点</h3><ul><li>数据分布</li><li>负载均衡</li><li>备份</li><li>高可用性</li></ul><h3 id="1-3-复制过程如下"><a href="#1-3-复制过程如下" class="headerlink" title="1.3 复制过程如下"></a>1.3 复制过程如下</h3><p>Mysql的复制（replication）是一个异步或半同步的复制，从一个Mysql 实例（称之为Master）复制到另一个Mysql 实例（称之Slave）。实现整个复制操作主要由三个进程完成的，其中两个进程在Slave（Sql进程和IO进程），另外一个进程在 Master（IO进程）上。<br>要实施复制，首先必须打开Master端的binary log（bin-log）功能，否则无法实现。因为整个复制过程实际上就是Slave从Master端获取该日志然后再在自己身上完全顺序的执行日志中所记录的各种操作。<br><strong>具体过程如下：</strong></p><p><img src="/2018/01/26/mysql-amoeba-zhu-cong-fu-zhi-yu-du-xie-fen-chi/%E5%9B%BE%E7%89%871.png" alt="image-20191116173854496"></p><ol><li><strong>master记录二进制日志</strong>。在每个事务更新数据完成之前，master在二日志记录这些改变。MySQL将事务串行的写入二进制日志，即使事务中的语句都是交叉执行的。在事件写入二进制日志完成后，master通知存储引擎提交事务。</li><li><strong>slave将master的binary log拷贝到它自己的中继日志</strong>。首先，slave开始一个工作线程——I/O线程。I/O线程在master上打开一个普通的连接，然后开始binlog dump process。Binlog dump process从master的二进制日志中读取事件，如果已经跟上master，它会睡眠并等待master产生新的事件。I/O线程将这些事件写入中继日志。</li><li><strong>SQL slave thread（SQL从线程）处理该过程的最后一步</strong>。SQL线程从中继日志读取事件，并重放其中的事件而更新slave的数据，使其与master中的数据一致。只要该线程与I/O线程保持一致，中继日志通常会位于OS的缓存中，所以中继日志的开销很小。</li></ol><h2 id="2、读写分离原理"><a href="#2、读写分离原理" class="headerlink" title="2、读写分离原理"></a>2、读写分离原理</h2><p>简单来说，读写分离（如下图：）就是只在主服务器上写，只在从服务器上读，基本的原理是让主数据库处理事务性查询，而从数据库处理select查询，数据库复制被用来把事务性查询导致的变更同步到集群中的从数据库。</p><p><img src="/2018/01/26/mysql-amoeba-zhu-cong-fu-zhi-yu-du-xie-fen-chi/%E5%9B%BE%E7%89%872.png" alt="img"></p><h2 id="3、3种实现思路关键技术"><a href="#3、3种实现思路关键技术" class="headerlink" title="3、3种实现思路关键技术"></a>3、3种实现思路关键技术</h2><h3 id="3-1-基于程序代码内部实现"><a href="#3-1-基于程序代码内部实现" class="headerlink" title="3.1 基于程序代码内部实现"></a>3.1 基于程序代码内部实现</h3><p>在代码中根据select、insert进行路由分类，这类方法也是目前生产环境应用最广泛的，优点是性能较好，因为在程序代码中实现，不需要增加额外的设备作为硬件开支；缺点是需要开发人员来实现，运维人员无从下手。</p><h3 id="3-2-基于中间代理层实现"><a href="#3-2-基于中间代理层实现" class="headerlink" title="3.2 基于中间代理层实现"></a>3.2 基于中间代理层实现</h3><p>代理一般位于客户端和服务器之间，代理服务器接到客户端请求后通过判断后转发到后端数据库，有两个代表性程序。</p><ol><li>MySQL-Proxy：MySQL-Proxy为MySQL开源项目，通过其他自带的lua脚本进行SQL判断，虽然是MySQL官方产品，但是MySQL官方并不建议将MySQL-Proxy用到生产环境。</li><li>Amoeba：由陈思儒开发，作者曾就职于阿里巴巴。该程序由java语言进行开发，阿里巴巴将其用于生产环境。它不支持事务和存储过程。</li></ol><h3 id="3-3-驱动实现"><a href="#3-3-驱动实现" class="headerlink" title="3.3 驱动实现"></a>3.3 驱动实现</h3><p>在驱动层使用Mysql提供的主从库访问驱动，直接与数据库连接驱动耦合，扩展性弱，目前还未做原型尝试。</p><h2 id="4、Amoeba是什么"><a href="#4、Amoeba是什么" class="headerlink" title="4、Amoeba是什么"></a>4、Amoeba是什么</h2><p><strong>Amoeba</strong>(变形虫)项目,该开源框架于2008年开始发布一款<strong>Amoeba for Mysql</strong>软件。详细资料可参阅<strong><a href="http://docs.hexnova.com/amoeba/what-is.html" target="_blank" rel="noopener">Amoeba</a></strong>官方文档<strong>(需翻墙)</strong>。</p><h3 id="4-1-Amoeba能做什么"><a href="#4-1-Amoeba能做什么" class="headerlink" title="4.1 Amoeba能做什么"></a>4.1 Amoeba能做什么</h3><p><strong>Amoeba</strong>致力于<strong>MySQL</strong>的分布式数据库前端代理层，它主要在应用层访问<strong>MySQL</strong>的时候充当<strong>SQL</strong>路由功能，专注于分布式数据库代理层 （<strong>Database Proxy</strong>）开发。座落与 <strong>Client</strong>、<strong>DB Server(s)</strong>之间，对客户端透明。具有<strong>负载均衡</strong>、<strong>高可用性</strong>、<strong>SQL过滤</strong>、<strong>读写分离</strong>、可路由相关的到目标数据库、可并发请求多台数据库合并结果。 通过<strong>Amoeba</strong>你能够完成多数据源的高可用、负载均衡、数据切片的功能。</p><h3 id="4-2-Amoeba不能做什么"><a href="#4-2-Amoeba不能做什么" class="headerlink" title="4.2 Amoeba不能做什么"></a>4.2 Amoeba不能做什么</h3><p>既然知道Amoeba能为我们解决什么问题，也要做到Amoeba不擅长的事情。这样在具体项目技术方案选择时，方能权衡考虑。Amoeba对于以下几点暂时无能为力：</p><ol><li>目前还不支持事务；</li><li>暂时不支持存储过程，官方说近期会支持；</li><li>不适合从Amoeba导数据的场景或者对大数据量查询的query并不合适，比如一次请求返回10w以上甚至更多数据的场合；</li><li>暂时不支持分库分表，amoeba目前只做到分数据库实例，每个被切分的节点需要保持库表结构一致。</li></ol><p>若实际项目中所需要的功能正是Amoeba的短板，建议使用Mysql Proxy作为中间件，或者在应用层通过程序控制数据源，手动实现数据库读写分离。</p><h2 id="5、部署MySQL主从复制并实现读写分离"><a href="#5、部署MySQL主从复制并实现读写分离" class="headerlink" title="5、部署MySQL主从复制并实现读写分离"></a>5、部署MySQL主从复制并实现读写分离</h2><p><strong>环境描述：</strong></p><table><thead><tr><th><strong>主机</strong></th><th><strong>操作系统</strong></th><th><strong>IP地址</strong></th><th><strong>主要软件</strong></th></tr></thead><tbody><tr><td>Master</td><td>CentOS 6.5 x86_64</td><td>192.168.1.101</td><td>cmake-2.8.6.tar.gzmysql-5.5.22.tar.gz</td></tr><tr><td>Slave1</td><td>CentOS 6.5 x86_64</td><td>192.168.1.102</td><td>cmake-2.8.6.tar.gzmysql-5.5.22.tar.gz</td></tr><tr><td>Slave2</td><td>CentOS 6.5 x86_64</td><td>192.168.1.103</td><td>cmake-2.8.6.tar.gzmysql-5.5.22.tar.gz</td></tr><tr><td>Amoeba</td><td>CentOS 6.5 x86_64</td><td>192.168.1.110</td><td>amoeba-mysql-binary-2.2.0.tar.gzjdk-6u14-linux-x64.bin</td></tr><tr><td>客户端</td><td>CentOS 6.5 x86_64</td><td>192.168.1.111</td><td></td></tr></tbody></table><h3 id="5-1-部署MySQL主从复制"><a href="#5-1-部署MySQL主从复制" class="headerlink" title="5.1 部署MySQL主从复制"></a>5.1 部署MySQL主从复制</h3><h4 id="5-1-1-部署NTP时间同步环境"><a href="#5-1-1-部署NTP时间同步环境" class="headerlink" title="5.1.1 部署NTP时间同步环境"></a>5.1.1 部署NTP时间同步环境</h4><p><strong>①安装,并配置NTP (在任意位置添加以下红色部分)</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@centos5 ~]# yum install -y ntp</span><br><span class="line">[root@centos5 ~]# vim /etc/ntp.conf</span><br><span class="line">server 127.127.1.0</span><br><span class="line">fudge 127.127.1.0 stratum 8</span><br></pre></td></tr></table></figure><p><strong>②启动服务，并添加防火墙规则</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@centos5 ~]# service ntpd restart</span><br><span class="line">Starting ntpd:                                             [  OK  ]</span><br><span class="line">[root@centos5 ~]# iptables -I INPUT -p udp --dport 123 -j ACCEPT</span><br></pre></td></tr></table></figure><h4 id="5-1-2-安装MySQL数据库"><a href="#5-1-2-安装MySQL数据库" class="headerlink" title="5.1.2 安装MySQL数据库"></a>5.1.2 安装MySQL数据库</h4><p>(在Master、Slave1、Slave2上安装)</p><p><strong>①同步时间</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@centos1 ~]# ntpdate 192.168.1.101</span><br><span class="line">31 Oct 10:08:51 ntpdate[2162]: adjust time server 192.168.1.101 offset -0.078096 sec</span><br></pre></td></tr></table></figure><p><strong>②编译安装MySQL</strong><br>安装依赖包</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@centos1 ~]# yum  -y install ncurses-devel</span><br></pre></td></tr></table></figure><p>编译安装cmake</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@centos1 ~]# tar xf cmake-2.8.6.tar.gz </span><br><span class="line">[root@centos1 ~]# cd cmake-2.8.6</span><br><span class="line">[root@centos1 cmake-2.8.6]# ./configure</span><br><span class="line">[root@centos1 cmake-2.8.6]# gmake &amp;&amp; gmake install</span><br></pre></td></tr></table></figure><p>编译安装mysql</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@centos1 ~]# tar xf mysql-5.5.22.tar.gz </span><br><span class="line">[root@centos1 ~]#cd mysql-5.5.22</span><br><span class="line">[root@centos1 mysql-5.5.22]# cmake -DCMAKE_INSTALL_PREFIX=/usr/local/mysql -DDEFAULT_CHARSET=utf8 -DDEFAULT_COLLATION=utf8_general_ci -DWITH_EXTRA_CHARSETS=all -DSYSCONFDIR=/etc</span><br><span class="line">[root@centos1 mysql-5.5.22]# make &amp;&amp; make install</span><br></pre></td></tr></table></figure><p><strong>②优化调整</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@centos1 mysql-5.5.22]# cp support-files/my-medium.cnf /etc/my.cnf</span><br><span class="line">[root@centos1 mysql-5.5.22]# cp support-files/mysql.server /etc/rc.d/init.d/mysqld</span><br><span class="line">[root@centos1 mysql-5.5.22]# chmod +x /etc/rc.d/init.d/mysqld</span><br><span class="line">[root@centos1 mysql-5.5.22]# chkconfig --add mysqld</span><br><span class="line">[root@centos1 mysql-5.5.22]# echo &quot;PATH=$PATH:/usr/local/mysql/bin&quot; &gt;&gt; /etc/profile</span><br><span class="line">[root@centos1 mysql-5.5.22]# source /etc/profile</span><br><span class="line">[root@centos1 mysql-5.5.22]# echo $PATH</span><br><span class="line">/usr/lib64/qt-3.3/bin:/usr/local/sbin:/usr/local/bin:/sbin:/bin:/usr/sbin:/usr/bin:/root/bin:/usr/local/mysql/bin</span><br></pre></td></tr></table></figure><p><strong>③初始化数据库</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@centos1 mysql-5.5.22]# groupadd mysql</span><br><span class="line">[root@centos1 mysql-5.5.22]# useradd -M -s /sbin/nologin mysql -g mysql</span><br><span class="line">[root@centos1 mysql-5.5.22]# chown -R mysql:mysql /usr/local/mysql/</span><br><span class="line">[root@centos1 mysql-5.5.22]# /usr/local/mysql/scripts/mysql_install_db --basedir=/usr/local/mysql/ --datadir=/usr/local/mysql/data/ --user=mysql</span><br></pre></td></tr></table></figure><p><strong>④启动MySQL服务，创建数据库密码</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@centos1 mysql-5.5.22]# service mysqld start</span><br><span class="line">Starting MySQL..                                           [  OK  ]</span><br><span class="line">[root@centos1 mysql-5.5.22]# mysqladmin -u root password &apos;pwd123&apos;</span><br></pre></td></tr></table></figure><p>到此Master、Slave1、Slave2的MySQL数据库都已经安装完成</p><h4 id="5-1-3-配置MySQL-Master主服务器"><a href="#5-1-3-配置MySQL-Master主服务器" class="headerlink" title="5.1.3 配置MySQL Master主服务器"></a>5.1.3 配置MySQL Master主服务器</h4><p><strong>①在/etc/my.cnf中修改和增加以下内容</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@centos1 ~]# vim /etc/my.cnf</span><br><span class="line">server-id       = 11                  //修改</span><br><span class="line">log-bin=master-bin                    //修改</span><br><span class="line">log-slave-updates=true                //添加</span><br></pre></td></tr></table></figure><p><strong>②重启MySQL服务</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@centos1 ~]# service mysqld restart</span><br><span class="line">Shutting down MySQL.                                       [  OK  ]</span><br><span class="line">Starting MySQL..                                            [  OK  ]</span><br></pre></td></tr></table></figure><p><strong>③登录MySQL数据库，给从服务器授权</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@centos1 ~]# mysql -u root -p</span><br><span class="line">Enter password: </span><br><span class="line">Welcome to the MySQL monitor.  Commands end with ; or \g.</span><br><span class="line">Your MySQL connection id is 1</span><br><span class="line">Server version: 5.5.38-log Source distribution</span><br><span class="line"></span><br><span class="line">Copyright (c) 2000, 2013, Oracle and/or its affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle is a registered trademark of Oracle Corporation and/or its</span><br><span class="line">affiliates. Other names may be trademarks of their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type &apos;help;&apos; or &apos;\h&apos; for help. Type &apos;\c&apos; to clear the current input statement.</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; grant replication slave on *.* to &apos;myslave&apos;@&apos;192.168.1.%&apos; identified by &apos;123456&apos;;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; flush privileges;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show master status;</span><br><span class="line">+-------------------+----------+--------------+------------------+</span><br><span class="line">| File              | Position | Binlog_Do_DB | Binlog_Ignore_DB |</span><br><span class="line">+-------------------+----------+--------------+------------------+</span><br><span class="line">| master-bin.000001 |      337 |              |                  |</span><br><span class="line">+-------------------+----------+--------------+------------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure><p>其中File列显示日志名，Position列显示偏移量，这两个值在后面配置从服务器的时候需要，Slave应从该点在Master上进行新的更新。</p><p><strong>④关闭或添加防火墙规则</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@centos1 ~]# iptables -I INPUT -p tcp --dport 3306 -j ACCEPT</span><br></pre></td></tr></table></figure><h4 id="5-1-4-配置MySQL-Slave1、Slave2从服务器"><a href="#5-1-4-配置MySQL-Slave1、Slave2从服务器" class="headerlink" title="5.1.4 配置MySQL Slave1、Slave2从服务器"></a>5.1.4 配置MySQL Slave1、Slave2从服务器</h4><p><strong>①在/etc/my.cnf中修改和增加下面内容</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@centos2 ~]# vim /etc/my.cnf</span><br><span class="line">server-id       = 22                   //修改</span><br><span class="line">relay-log=relay-log-bin                  //添加</span><br><span class="line">relay-log-index=slave-relay-bin.index      //添加</span><br></pre></td></tr></table></figure><p>这里需要注意server-id不能与主服务器相同，另一个从服务器改为33</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@centos2 ~]# vim /etc/my.cnf</span><br><span class="line">server-id       = 33                   //修改</span><br><span class="line">relay-log=relay-log-bin                  //添加</span><br><span class="line">relay-log-index=slave-relay-bin.index      //添加</span><br></pre></td></tr></table></figure><p><strong>②重启MySQL服务器</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@centos2 ~]# service mysqld restart</span><br><span class="line">Shutting down MySQL.                                       [  OK  ]</span><br><span class="line">Starting MySQL..                                            [  OK  ]</span><br></pre></td></tr></table></figure><p><strong>③登录MySQL，配置同步</strong><br>按主服务器结果更改下面命令中master_log_file和master_log_pos参数。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@centos2 ~]# mysql -u root -p</span><br><span class="line">Enter password: </span><br><span class="line">Welcome to the MySQL monitor.  Commands end with ; or \g.</span><br><span class="line">Your MySQL connection id is 1</span><br><span class="line">Server version: 5.5.38-log Source distribution</span><br><span class="line"></span><br><span class="line">Copyright (c) 2000, 2013, Oracle and/or its affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle is a registered trademark of Oracle Corporation and/or its</span><br><span class="line">affiliates. Other names may be trademarks of their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type &apos;help;&apos; or &apos;\h&apos; for help. Type &apos;\c&apos; to clear the current input statement.</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; change master to master_host=&apos;192.168.1.101&apos;,master_user=&apos;myslave&apos;,master_password=&apos;123456&apos;,master_log_file=&apos;master-bin.000001&apos;,master_log_pos=337;</span><br><span class="line">Query OK, 0 rows affected (0.07 sec)</span><br></pre></td></tr></table></figure><p><strong>④启动同步</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; start slave;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br></pre></td></tr></table></figure><p><strong>⑤查看Slave状态，确保以下两个值为YES</strong></p><blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show slave status\G;</span><br></pre></td></tr></table></figure><p><strong><strong><strong><strong><strong><strong>***</strong></strong></strong></strong></strong></strong> 1. row <strong><strong><strong><strong><strong><strong>***</strong></strong></strong></strong></strong></strong><br>Slave_IO_State: Waiting for master to send event<br>Master_Host: 192.168.1.101<br>Master_User: myslave<br>Master_Port: 3306<br>Connect_Retry: 60<br>Master_Log_File: master-bin.000001<br>Read_Master_Log_Pos: 337<br>Relay_Log_File: relay-log-bin.000002<br>Relay_Log_Pos: 254<br>Relay_Master_Log_File: master-bin.000001<br><font color="red">Slave_IO_Running: Yes</font><br><font color="red">Slave_SQL_Running: Yes</font><br>Replicate_Do_DB:<br>Replicate_Ignore_DB:<br>Replicate_Do_Table:<br>Replicate_Ignore_Table:<br>Replicate_Wild_Do_Table:<br>Replicate_Wild_Ignore_Table:<br>Last_Errno: 0<br>Last_Error:<br>Skip_Counter: 0<br>Exec_Master_Log_Pos: 337<br>Relay_Log_Space: 408<br>Until_Condition: None<br>Until_Log_File:<br>Until_Log_Pos: 0<br>Master_SSL_Allowed: No<br>Master_SSL_CA_File:<br>Master_SSL_CA_Path:<br>Master_SSL_Cert:<br>Master_SSL_Cipher:<br>Master_SSL_Key:<br>Seconds_Behind_Master: 0<br>Master_SSL_Verify_Server_Cert: No<br>Last_IO_Errno: 0<br>Last_IO_Error:<br>Last_SQL_Errno: 0<br>Last_SQL_Error:<br>Replicate_Ignore_Server_Ids:<br>Master_Server_Id: 11<br>1 row in set (0.00 sec)</p><p>ERROR:<br>No query specified</p></blockquote><p><strong>⑥关闭或添加防火墙规则</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@centos2 ~]# iptables -I INPUT -p tcp --dport 3306 -j ACCEPT</span><br></pre></td></tr></table></figure><h4 id="5-1-5-验证主从复制效果"><a href="#5-1-5-验证主从复制效果" class="headerlink" title="5.1.5 验证主从复制效果"></a>5.1.5 验证主从复制效果</h4><p><strong>①在主、从服务器上登录MySQL</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@centos1 ~]# mysql -u root -p</span><br><span class="line">mysql&gt; show databases;</span><br><span class="line">+--------------------+</span><br><span class="line">| Database           |</span><br><span class="line">+--------------------+</span><br><span class="line">| information_schema |</span><br><span class="line">| mysql              |</span><br><span class="line">| performance_schema |</span><br><span class="line">| test               |</span><br><span class="line">+--------------------+</span><br><span class="line">4 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure><p><strong>②在主服务器上新建数据库db_test</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; create database db_test;</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br></pre></td></tr></table></figure><p><strong>③在主从，服务器上分别查看数据库，显示数据库相同，则主从复制成功</strong></p><blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show databases;</span><br></pre></td></tr></table></figure><p>+——————–+<br>| Database |<br>+——————–+<br>| information_schema |<br><font color="red">| db_test |</font><br>| mysql |<br>| performance_schema |<br>| test |<br>+——————–+<br>5 rows in set (0.00 sec)</p></blockquote><h3 id="5-2-部署MySQL读写分离"><a href="#5-2-部署MySQL读写分离" class="headerlink" title="5.2 部署MySQL读写分离"></a>5.2 部署MySQL读写分离</h3><h4 id="5-2-1-在主机Amoeba上安装Java环境"><a href="#5-2-1-在主机Amoeba上安装Java环境" class="headerlink" title="5.2.1 在主机Amoeba上安装Java环境"></a>5.2.1 在主机Amoeba上安装Java环境</h4><p>因为Amoeba是基于jdk1.5开发的，所以官方推荐使用jdk1.5或1.6版本，高版本不建议使用</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@centos4 ~]# cp /media/jdk-6u14-linux-x64.bin /usr/local/</span><br><span class="line">[root@centos4 ~]# chmod +x /usr/local/jdk-6u14-linux-x64.bin </span><br><span class="line">[root@centos4 ja]# ./jdk-6u14-linux-x64.bin</span><br><span class="line">//根据提示输入yes完成安装</span><br><span class="line"></span><br><span class="line">[root@centos4 ja]# mv jdk1.6.0_14/ /usr/local/jdk1.6</span><br><span class="line">[root@centos4 ja]# vim /etc/profile</span><br><span class="line">[root@centos4 ja]# source /etc/profile</span><br><span class="line">bash: export: `PATH+/usr/local/jdk1.6/lib:/usr/local/jdk1.6/jre/bin:/usr/lib64/qt-3.3/bin:/usr/local/sbin:/usr/local/bin:/sbin:/bin:/usr/sbin:/usr/bin:/root/bin:/root/bin:/usr/local/amoeba//bin&apos;: not a valid identifier</span><br><span class="line">[root@centos4 ja]# java -version</span><br><span class="line">java version &quot;1.6.0_14&quot;</span><br><span class="line">Java(TM) SE Runtime Environment (build 1.6.0_14-b08)</span><br><span class="line">Java HotSpot(TM) 64-Bit Server VM (build 14.0-b16, mixed mode)</span><br><span class="line">//Java环境配置成功</span><br></pre></td></tr></table></figure><h4 id="5-2-2-安装并配置Amoeba软件"><a href="#5-2-2-安装并配置Amoeba软件" class="headerlink" title="5.2.2 安装并配置Amoeba软件"></a>5.2.2 安装并配置Amoeba软件</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@centos4 ~]# mkdir /usr/local/amoeba</span><br><span class="line">[root@centos4 ~]# tar xf /root/amoeba-mysql-binary-2.2.0.tar.gz -C /usr/local/amoeba</span><br><span class="line">[root@centos4 ~]# chmod -R 755 /usr/local/amoeba/</span><br><span class="line">[root@centos4 ~]# /usr/local/amoeba/bin/amoeba</span><br><span class="line">amoeba start|stop              //显示此内容说明Amoeba安装成功</span><br></pre></td></tr></table></figure><h4 id="5-2-3-配置Amoeba读写分离，两个Slave读负载均衡"><a href="#5-2-3-配置Amoeba读写分离，两个Slave读负载均衡" class="headerlink" title="5.2.3 配置Amoeba读写分离，两个Slave读负载均衡"></a>5.2.3 配置Amoeba读写分离，两个Slave读负载均衡</h4><p><strong>①Master、Slave1、Slave2中开放权限给Amoeba访问</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@centos1 ~]# mysql -u root -p</span><br><span class="line">Enter password: </span><br><span class="line">Welcome to the MySQL monitor.  Commands end with ; or \g.</span><br><span class="line">Your MySQL connection id is 5</span><br><span class="line">Server version: 5.5.38-log Source distribution</span><br><span class="line"></span><br><span class="line">Copyright (c) 2000, 2013, Oracle and/or its affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle is a registered trademark of Oracle Corporation and/or its</span><br><span class="line">affiliates. Other names may be trademarks of their respective</span><br><span class="line">owners.</span><br><span class="line">Type &apos;help;&apos; or &apos;\h&apos; for help. Type &apos;\c&apos; to clear the current input statement.</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; grant all on *.* to test@&apos;192.168.1.%&apos; identified by &apos;123.com&apos;;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br></pre></td></tr></table></figure><p><strong>②编辑aomeba.xml配置文件</strong></p><p>（修改以下红色内容，注意删除注释）</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@centos4 ~]# vim /usr/local/amoeba/conf/amoeba.xml</span><br></pre></td></tr></table></figure><p><img src="/2018/01/26/mysql-amoeba-zhu-cong-fu-zhi-yu-du-xie-fen-chi/%E5%9B%BE%E7%89%873.png" alt="image-20191116180544313"></p><p><strong>③编辑dbServer.xml配置文件</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@centos4 ~]# vim /usr/local/amoeba/conf/dbServers.xml</span><br></pre></td></tr></table></figure><p><img src="/2018/01/26/mysql-amoeba-zhu-cong-fu-zhi-yu-du-xie-fen-chi/%E5%9B%BE%E7%89%874.png" alt="image-20191116180756090"></p><p><strong>④配置无误后，可以启动Amoeba，其默认端口为tcp 8066</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@centos4 ~]# /usr/local/amoeba/bin/amoeba start&amp;</span><br><span class="line">[root@centos4 ~]# /usr/local/amoeba/bin/amoeba start&amp;</span><br><span class="line">[9] 4222</span><br><span class="line">[root@centos4 ~]# log4j:WARN log4j config load completed from file:/usr/local/amoeba/conf/log4j.xml</span><br><span class="line">2016-10-31 12:47:52,428 INFO  context.MysqlRuntimeContext - Amoeba for Mysql current versoin=5.1.45-mysql-amoeba-proxy-2.2.0</span><br><span class="line">log4j:WARN ip access config load completed from file:/usr/local/amoeba/conf/access_list.conf</span><br><span class="line">2016-10-31 12:47:52,622 INFO  net.ServerableConnectionManager - Amoeba for Mysql listening on 0.0.0.0/0.0.0.0:8066.</span><br><span class="line">2016-10-31 12:47:52,627 INFO  net.ServerableConnectionManager - Amoeba Monitor Server listening on /127.0.0.1:22289.</span><br><span class="line"></span><br><span class="line">[root@centos4 ~]# ss -anpt | grep java</span><br><span class="line">LISTEN     0      50         ::ffff:127.0.0.1:22289                   :::*      users:((&quot;java&quot;,4222,54))</span><br><span class="line">LISTEN     0      128                      :::8066                    :::*      users:((&quot;java&quot;,4222,53))</span><br><span class="line">ESTAB      0      0      ::ffff:192.168.1.110:42345 ::ffff:192.168.1.103:3306   users:((&quot;java&quot;,4222,45))</span><br><span class="line">ESTAB      0      0      ::ffff:192.168.1.110:34060 ::ffff:192.168.1.101:3306   users:((&quot;java&quot;,4222,46))</span><br><span class="line">ESTAB      0      0      ::ffff:192.168.1.110:45002 ::ffff:192.168.1.102:3306   users:((&quot;java&quot;,4222,40)</span><br></pre></td></tr></table></figure><p><strong>⑤关闭或添加防火墙规则</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@centos4 ~]# iptables -I INPUT -p tcp --dport 8066 -j ACCEPT</span><br></pre></td></tr></table></figure><h4 id="5-2-4-测试"><a href="#5-2-4-测试" class="headerlink" title="5.2.4 测试"></a>5.2.4 测试</h4><p><strong>①在Client主机上，通过代理访问MySQL</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@centos5 ~]# yum -y install mysql</span><br><span class="line">[root@centos5 ~]# mysql -u amoeba -p123456 -h 192.168.1.110 -P8066</span><br><span class="line">Welcome to the MySQL monitor.  Commands end with ; or \g.</span><br><span class="line">Your MySQL connection id is 1362913826</span><br><span class="line">Server version: 5.1.45-mysql-amoeba-proxy-2.2.0 Source distribution</span><br><span class="line"></span><br><span class="line">Copyright (c) 2000, 2013, Oracle and/or its affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle is a registered trademark of Oracle Corporation and/or its</span><br><span class="line">affiliates. Other names may be trademarks of their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type &apos;help;&apos; or &apos;\h&apos; for help. Type &apos;\c&apos; to clear the current input statement.</span><br><span class="line"></span><br><span class="line">mysql&gt;</span><br></pre></td></tr></table></figure><p><strong>②在Master上创建一个表，同步到各从服务器上，然后关掉各从服务器的Slave功能，再插入区别语句。</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; use db_test;</span><br><span class="line">Database changed</span><br><span class="line">mysql&gt; create table zang (id int(10));</span><br><span class="line">Query OK, 0 rows affected (0.05 sec)</span><br></pre></td></tr></table></figure><p>分别在Slave1、Slave2两台从服务器上关闭slave</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; stop slave;</span><br><span class="line">Query OK, 0 rows affected, 1 warning (0.00 sec)</span><br></pre></td></tr></table></figure><p>然后在Master主服务器上创建数据</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; use db_test;</span><br><span class="line">Database changed</span><br><span class="line">mysql&gt; insert into zang values (1);</span><br><span class="line">Query OK, 1 row affected (0.01 sec)</span><br></pre></td></tr></table></figure><p><strong>③Slave1、Slave2从服务器上同步了表后，再手动插入其他内容</strong><br>Slave1 上：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; use db_test;</span><br><span class="line">Database changed</span><br><span class="line">mysql&gt; insert into zang values(2);</span><br><span class="line">Query OK, 1 row affected (0.01 sec)</span><br></pre></td></tr></table></figure><p>Slave2 上：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; use db_test;</span><br><span class="line">Database changed</span><br><span class="line">mysql&gt; insert into zang values(3);</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br></pre></td></tr></table></figure><p><strong>④测试读操作</strong></p><p>第一次查询结果</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select * from zang;</span><br><span class="line">+------+</span><br><span class="line">| id   |</span><br><span class="line">+------+</span><br><span class="line">|   2 |</span><br><span class="line">+------+</span><br><span class="line">1 rows in set (0.01 sec)</span><br></pre></td></tr></table></figure><p>第二次查询结果</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select * from zang;</span><br><span class="line">+------+</span><br><span class="line">| id   |</span><br><span class="line">+------+</span><br><span class="line">|   3 |</span><br><span class="line">+------+</span><br><span class="line">1 row in set (0.01 sec)</span><br></pre></td></tr></table></figure><p>第三次查询结果</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select * from zang;</span><br><span class="line">+------+</span><br><span class="line">| id   |</span><br><span class="line">+------+</span><br><span class="line">|   2 |</span><br><span class="line">+------+</span><br><span class="line">1 rows in set (0.01 sec)</span><br></pre></td></tr></table></figure><p><strong>⑤测试写操作</strong><br>在Client主机上插入一条语句</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; insert into zang values (4);</span><br><span class="line">Query OK, 1 row affected (0.01 sec)</span><br></pre></td></tr></table></figure><p>但在Client上查询不到，最终只有在Master上才能查看到这条语句内容，说明写操作在Master服务器上。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select * from zang;</span><br><span class="line">+------+</span><br><span class="line">| id   |</span><br><span class="line">+------+</span><br><span class="line">|    1 |</span><br><span class="line">|    4 |</span><br><span class="line">+------+</span><br><span class="line">2 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure><p>由此验证，已经实现了MySQL读写分离，目前所有的写操作都全部在Master主服务器上，用来避免数据的不同步；所有的读操作都分摊给了Slave从服务器，用来分担数据库压力。</p></div><div><div><div style="text-align:center;color:#ccc;font-size:14px">-------------本文结束<i class="fa fa-paw"></i>感谢您的阅读-------------</div></div></div><div></div><footer class="post-footer"><div class="post-tags"><a href="/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/" rel="tag"><i class="fa fa-tag"></i> 数据库</a><a href="/tags/MySQL/" rel="tag"><i class="fa fa-tag"></i> MySQL</a></div><div class="post-nav"><div class="post-nav-next post-nav-item"><a href="/2018/01/20/mysql-proxy-zhu-cong-fu-zhi-yu-du-xie-fen-chi/" rel="next" title="MySQL-Proxy 主从复制与读写分离"><i class="fa fa-chevron-left"></i> MySQL-Proxy 主从复制与读写分离</a></div><span class="post-nav-divider"></span><div class="post-nav-prev post-nav-item"><a href="/2018/02/03/elasticsearch-ji-qun-yellow-he-red-zhuang-tai-chu-li/" rel="prev" title="Elasticsearch集群yellow和red状态处理">Elasticsearch集群yellow和red状态处理<i class="fa fa-chevron-right"></i></a></div></div></footer></div></article><div class="post-spread"><div class="jiathis_style"><span class="jiathis_txt">分享到：</span> <a class="jiathis_button_fav">收藏夹</a> <a class="jiathis_button_copy">复制网址</a> <a class="jiathis_button_email">邮件</a> <a class="jiathis_button_weixin">微信</a> <a class="jiathis_button_qzone">QQ空间</a> <a class="jiathis_button_tqq">腾讯微博</a> <a class="jiathis_button_douban">豆瓣</a> <a class="jiathis_button_share">一键分享</a> <a href="http://www.jiathis.com/share?uid=2140465" class="jiathis jiathis_txt jiathis_separator jtico jtico_jiathis" target="_blank">更多</a><a class="jiathis_counter_style"></a></div><script type="text/javascript">var jiathis_config={data_track_clickback:!0,summary:"",shortUrl:!1,hideMore:!1}</script><script type="text/javascript" src="http://v3.jiathis.com/code/jia.js?uid=" charset="utf-8"></script></div></div></div></div><div class="sidebar-toggle"><div class="sidebar-toggle-line-wrap"><span class="sidebar-toggle-line sidebar-toggle-line-first"></span><span class="sidebar-toggle-line sidebar-toggle-line-middle"></span><span class="sidebar-toggle-line sidebar-toggle-line-last"></span></div></div><aside id="sidebar" class="sidebar"><div id="sidebar-dimmer"></div><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">文章目录</li><li class="sidebar-nav-overview" data-target="site-overview-wrap">站点概览</li></ul><section class="site-overview-wrap sidebar-panel"><div class="site-overview"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="site-author-image" itemprop="image" src="/images/chen.png" alt="Zhongzhou Chen"><p class="site-author-name" itemprop="name">Zhongzhou Chen</p><p class="site-description motion-element" itemprop="description"></p></div><nav class="site-state motion-element"><div class="site-state-item site-state-posts"><a href="/archives/%7C%7C%20archive"><span class="site-state-item-count">314</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"><a href="/categories/index.html"><span class="site-state-item-count">84</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"><a href="/tags/index.html"><span class="site-state-item-count">180</span> <span class="site-state-item-name">标签</span></a></div></nav><div class="feed-link motion-element"><a href="/atom.xml" rel="alternate"><i class="fa fa-rss"></i> RSS</a></div></div></section><section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active"><div class="post-toc"><div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#1、MySQL主从复制原理"><span class="nav-text">1、MySQL主从复制原理</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-1-MySQL支持复制的类型"><span class="nav-text">1.1 MySQL支持复制的类型</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-2-复制的特点"><span class="nav-text">1.2 复制的特点</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-3-复制过程如下"><span class="nav-text">1.3 复制过程如下</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2、读写分离原理"><span class="nav-text">2、读写分离原理</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3、3种实现思路关键技术"><span class="nav-text">3、3种实现思路关键技术</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#3-1-基于程序代码内部实现"><span class="nav-text">3.1 基于程序代码内部实现</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-2-基于中间代理层实现"><span class="nav-text">3.2 基于中间代理层实现</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-3-驱动实现"><span class="nav-text">3.3 驱动实现</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4、Amoeba是什么"><span class="nav-text">4、Amoeba是什么</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#4-1-Amoeba能做什么"><span class="nav-text">4.1 Amoeba能做什么</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-2-Amoeba不能做什么"><span class="nav-text">4.2 Amoeba不能做什么</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5、部署MySQL主从复制并实现读写分离"><span class="nav-text">5、部署MySQL主从复制并实现读写分离</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#5-1-部署MySQL主从复制"><span class="nav-text">5.1 部署MySQL主从复制</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#5-1-1-部署NTP时间同步环境"><span class="nav-text">5.1.1 部署NTP时间同步环境</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#5-1-2-安装MySQL数据库"><span class="nav-text">5.1.2 安装MySQL数据库</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#5-1-3-配置MySQL-Master主服务器"><span class="nav-text">5.1.3 配置MySQL Master主服务器</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#5-1-4-配置MySQL-Slave1、Slave2从服务器"><span class="nav-text">5.1.4 配置MySQL Slave1、Slave2从服务器</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#5-1-5-验证主从复制效果"><span class="nav-text">5.1.5 验证主从复制效果</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-2-部署MySQL读写分离"><span class="nav-text">5.2 部署MySQL读写分离</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#5-2-1-在主机Amoeba上安装Java环境"><span class="nav-text">5.2.1 在主机Amoeba上安装Java环境</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#5-2-2-安装并配置Amoeba软件"><span class="nav-text">5.2.2 安装并配置Amoeba软件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#5-2-3-配置Amoeba读写分离，两个Slave读负载均衡"><span class="nav-text">5.2.3 配置Amoeba读写分离，两个Slave读负载均衡</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#5-2-4-测试"><span class="nav-text">5.2.4 测试</span></a></li></ol></li></ol></li></ol></div></div></section><div class="back-to-top"><i class="fa fa-arrow-up"></i> <span id="scrollpercent"><span>0</span>%</span></div></div></aside></div></main><footer id="footer" class="footer"><div class="footer-inner"><script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script><div class="copyright">&copy; <span itemprop="copyrightYear">2022</span><span class="with-love"><i class="fa fa-user"></i></span> <span class="author" itemprop="copyrightHolder">Zhongzhou Chen</span> <span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-area-chart"></i></span> <span class="post-meta-item-text">Site words total count&#58;</span> <span title="Site words total count">752.6k</span></div><span class="post-meta-divider"></span></div></footer></div><script type="text/javascript">"[object Function]"!==Object.prototype.toString.call(window.Promise)&&(window.Promise=null)</script><script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script><script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script><script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script><script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script><script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script><script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script><script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script><style>.copy-btn{display:inline-block;padding:6px 12px;font-size:13px;font-weight:700;line-height:20px;color:#333;white-space:nowrap;vertical-align:middle;cursor:pointer;background-color:#eee;background-image:linear-gradient(#fcfcfc,#eee);border:1px solid #d5d5d5;border-radius:3px;user-select:none;outline:0}.highlight-wrap .copy-btn{transition:opacity .3s ease-in-out;opacity:0;padding:2px 6px;position:absolute;right:4px;top:8px}.highlight-wrap .copy-btn:focus,.highlight-wrap:hover .copy-btn{opacity:1}.highlight-wrap{position:relative}</style><script>$(".highlight").each(function(t,e){var n=$("<div>").addClass("highlight-wrap");$(e).after(n),n.append($("<button>").addClass("copy-btn").append("复制").on("click",function(t){var e=$(this).parent().find(".code").find(".line").map(function(t,e){return $(e).text()}).toArray().join("\n"),n=document.createElement("textarea");document.body.appendChild(n),n.style.position="absolute",n.style.top="0px",n.style.left="0px",n.value=e,n.select(),n.focus();var o=document.execCommand("copy");document.body.removeChild(n),o?$(this).text("复制成功"):$(this).text("复制失败"),$(this).blur()})).on("mouseleave",function(t){var e=$(this).find(".copy-btn");setTimeout(function(){e.text("复制")},300)}).append(e)})</script><script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script><script type="text/javascript">function proceedsearch(){$("body").append('<div class="search-popup-overlay local-search-pop-overlay"></div>').css("overflow","hidden"),$(".search-popup-overlay").click(onPopupClose),$(".popup").toggle();var t=$("#local-search-input");t.attr("autocapitalize","none"),t.attr("autocorrect","off"),t.focus()}var isfetched=!1,isXml=!0,search_path="search.xml";0===search_path.length?search_path="search.xml":/json$/i.test(search_path)&&(isXml=!1);var path="/"+search_path,onPopupClose=function(t){$(".popup").hide(),$("#local-search-input").val(""),$(".search-result-list").remove(),$("#no-result").remove(),$(".local-search-pop-overlay").remove(),$("body").css("overflow","")},searchFunc=function(t,e,s){"use strict";$("body").append('<div class="search-popup-overlay local-search-pop-overlay"><div id="search-loading-icon"><i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i></div></div>').css("overflow","hidden"),$("#search-loading-icon").css("margin","20% auto 0 auto").css("text-align","center"),$.ajax({url:t,dataType:isXml?"xml":"json",async:!0,success:function(t){isfetched=!0,$(".popup").detach().appendTo(".header-inner");var o=isXml?$("entry",t).map(function(){return{title:$("title",this).text(),content:$("content",this).text(),url:$("url",this).text()}}).get():t,n=document.getElementById(e),r=document.getElementById(s);n.addEventListener("input",function(){var y=n.value.trim().toLowerCase(),T=y.split(/[\s\-]+/);1<T.length&&T.push(y);var b=[];if(0<y.length&&o.forEach(function(t){function e(t,e,o,n){for(var r=n[n.length-1],s=r.position,a=r.word,i=[],c=0;s+a.length<=o&&0!=n.length;){a===y&&c++,i.push({position:s,length:a.length});var l=s+a.length;for(n.pop();0!=n.length&&(s=(r=n[n.length-1]).position,a=r.word,s<l);)n.pop()}return h+=c,{hits:i,start:e,end:o,searchTextCount:c}}function o(o,t){var n="",r=t.start;return t.hits.forEach(function(t){n+=o.substring(r,t.position);var e=t.position+t.length;n+='<b class="search-keyword">'+o.substring(t.position,e)+"</b>",r=e}),n+=o.substring(r,t.end)}var n=!1,r=0,h=0,s=t.title.trim(),a=s.toLowerCase(),i=t.content.trim().replace(/<[^>]+>/g,""),c=i.toLowerCase(),l=decodeURIComponent(t.url),p=[],u=[];if(""!=s&&(T.forEach(function(t){function e(t,e,o){var n=t.length;if(0===n)return[];var r=0,s=[],a=[];for(o||(e=e.toLowerCase(),t=t.toLowerCase());-1<(s=e.indexOf(t,r));)a.push({position:s,word:t}),r=s+n;return a}p=p.concat(e(t,a,!1)),u=u.concat(e(t,c,!1))}),(0<p.length||0<u.length)&&(n=!0,r=p.length+u.length)),n){[p,u].forEach(function(t){t.sort(function(t,e){return e.position!==t.position?e.position-t.position:t.word.length-e.word.length})});var f=[];0!=p.length&&f.push(e(0,0,s.length,p));for(var d=[];0!=u.length;){var g=u[u.length-1],v=g.position,$=g.word,C=v-20,m=v+80;C<0&&(C=0),m<v+$.length&&(m=v+$.length),m>i.length&&(m=i.length),d.push(e(0,C,m,u))}d.sort(function(t,e){return t.searchTextCount!==e.searchTextCount?e.searchTextCount-t.searchTextCount:t.hits.length!==e.hits.length?e.hits.length-t.hits.length:t.start-e.start});var x=parseInt("1");0<=x&&(d=d.slice(0,x));var w="";w+=0!=f.length?"<li><a href='"+l+"' class='search-result-title'>"+o(s,f[0])+"</a>":"<li><a href='"+l+"' class='search-result-title'>"+s+"</a>",d.forEach(function(t){w+="<a href='"+l+'\'><p class="search-result">'+o(i,t)+"...</p></a>"}),w+="</li>",b.push({item:w,searchTextCount:h,hitCount:r,id:b.length})}}),1===T.length&&""===T[0])r.innerHTML='<div id="no-result"><i class="fa fa-search fa-5x" /></div>';else if(0===b.length)r.innerHTML='<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>';else{b.sort(function(t,e){return t.searchTextCount!==e.searchTextCount?e.searchTextCount-t.searchTextCount:t.hitCount!==e.hitCount?e.hitCount-t.hitCount:e.id-t.id});var e='<ul class="search-result-list">';b.forEach(function(t){e+=t.item}),e+="</ul>",r.innerHTML=e}}),$(".local-search-pop-overlay").remove(),$("body").css("overflow",""),proceedsearch()}})};$(".popup-trigger").click(function(t){t.stopPropagation(),!1===isfetched?searchFunc(path,"local-search-input","local-search-result"):proceedsearch()}),$(".popup-btn-close").click(onPopupClose),$(".popup").click(function(t){t.stopPropagation()}),$(document).on("keyup",function(t){27===t.which&&$(".search-popup").is(":visible")&&onPopupClose()})</script><script type="text/javascript" src="/js/src/love.js"></script><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({pluginRootPath:"live2dw/",pluginJsPath:"lib/",pluginModelPath:"assets/",tagMode:!1,debug:!1,log:!1,model:{jsonPath:"/live2dw/assets/shizuku.model.json"},display:{position:"right"},mobile:{show:!0,scale:.2},react:{opacityDefault:.7,opacityOnHover:.2,opacity:.4}})</script></body></html>