<!-- build time:Mon Sep 13 2021 15:38:08 GMT+0800 (GMT+08:00) --><!DOCTYPE html><html class="theme-next gemini use-motion" lang="zh-Hans"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><script src="//cdn.bootcss.com/pace/1.0.2/pace.min.js"></script><link href="//cdn.bootcss.com/pace/1.0.2/themes/pink/pace-theme-flash.css" rel="stylesheet"><script></script><meta name="theme-color" content="#222"><style>.pace .pace-progress{background:#1E92FB;height:3px}.pace .pace-progress-inner{box-shadow:0 0 10px #1E92FB,0 0 5px #1E92FB}.pace .pace-activity{border-top-color:#1E92FB;border-left-color:#1E92FB}</style><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><meta name="google-site-verification" content="HGM141IpbHrSmnAmR6W_zE4bo9Z3f-yXLeHYT3bg1fk"><meta name="baidu-site-verification" content="code-5Ai1DA8e6T"><link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css"><link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css"><link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4"><link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222"><meta name="keywords" content="Nginx,"><link rel="alternate" href="/atom.xml" title="凡间的精灵" type="application/atom+xml"><meta name="description" content="1、代理服务简介代理服务可简单的分为正向代理和反向代理:正向代理: 用于代理内部网络对Internet的连接请求(如VPN&#x2F;NAT),客户端指定代理服务器,并将本来要直接发送给目标Web服务器的HTTP请求先发送到代理服务器上, 然后由代理服务器去访问Web服务器, 并将Web服务器的Response回传给客户端:反向代理: 与正向代理相反,如果局域网向Internet提供资源,并让Interne"><meta name="keywords" content="Nginx"><meta property="og:type" content="article"><meta property="og:title" content="Nginx 反向代理缓存服务"><meta property="og:url" content="http:&#x2F;&#x2F;chenzhonzhou.github.io&#x2F;2018&#x2F;03&#x2F;02&#x2F;nginx-fan-xiang-dai-li-huan-cun-fu-wu-bu-shu&#x2F;index.html"><meta property="og:site_name" content="凡间的精灵"><meta property="og:description" content="1、代理服务简介代理服务可简单的分为正向代理和反向代理:正向代理: 用于代理内部网络对Internet的连接请求(如VPN&#x2F;NAT),客户端指定代理服务器,并将本来要直接发送给目标Web服务器的HTTP请求先发送到代理服务器上, 然后由代理服务器去访问Web服务器, 并将Web服务器的Response回传给客户端:反向代理: 与正向代理相反,如果局域网向Internet提供资源,并让Interne"><meta property="og:locale" content="zh-Hans"><meta property="og:image" content="http:&#x2F;&#x2F;chenzhonzhou.github.io&#x2F;2018&#x2F;03&#x2F;02&#x2F;nginx-fan-xiang-dai-li-huan-cun-fu-wu-bu-shu&#x2F;%E5%9B%BE%E7%89%871.png"><meta property="og:image" content="http:&#x2F;&#x2F;chenzhonzhou.github.io&#x2F;2018&#x2F;03&#x2F;02&#x2F;nginx-fan-xiang-dai-li-huan-cun-fu-wu-bu-shu&#x2F;%E5%9B%BE%E7%89%872.png"><meta property="og:image" content="http:&#x2F;&#x2F;chenzhonzhou.github.io&#x2F;2018&#x2F;03&#x2F;02&#x2F;nginx-fan-xiang-dai-li-huan-cun-fu-wu-bu-shu&#x2F;%E5%9B%BE%E7%89%873.png"><meta property="og:image" content="http:&#x2F;&#x2F;chenzhonzhou.github.io&#x2F;2018&#x2F;03&#x2F;02&#x2F;nginx-fan-xiang-dai-li-huan-cun-fu-wu-bu-shu&#x2F;%E5%9B%BE%E7%89%874.png"><meta property="og:image" content="http:&#x2F;&#x2F;chenzhonzhou.github.io&#x2F;2018&#x2F;03&#x2F;02&#x2F;nginx-fan-xiang-dai-li-huan-cun-fu-wu-bu-shu&#x2F;%E5%9B%BE%E7%89%875.png"><meta property="og:image" content="http:&#x2F;&#x2F;chenzhonzhou.github.io&#x2F;2018&#x2F;03&#x2F;02&#x2F;nginx-fan-xiang-dai-li-huan-cun-fu-wu-bu-shu&#x2F;%E5%9B%BE%E7%89%876.png"><meta property="og:image" content="http:&#x2F;&#x2F;chenzhonzhou.github.io&#x2F;2018&#x2F;03&#x2F;02&#x2F;nginx-fan-xiang-dai-li-huan-cun-fu-wu-bu-shu&#x2F;%E5%9B%BE%E7%89%877.png"><meta property="og:image" content="http:&#x2F;&#x2F;chenzhonzhou.github.io&#x2F;2018&#x2F;03&#x2F;02&#x2F;nginx-fan-xiang-dai-li-huan-cun-fu-wu-bu-shu&#x2F;%E5%9B%BE%E7%89%878.png"><meta property="og:image" content="http:&#x2F;&#x2F;chenzhonzhou.github.io&#x2F;2018&#x2F;03&#x2F;02&#x2F;nginx-fan-xiang-dai-li-huan-cun-fu-wu-bu-shu&#x2F;%E5%9B%BE%E7%89%879.png"><meta property="og:image" content="http:&#x2F;&#x2F;chenzhonzhou.github.io&#x2F;2018&#x2F;03&#x2F;02&#x2F;nginx-fan-xiang-dai-li-huan-cun-fu-wu-bu-shu&#x2F;%E5%9B%BE%E7%89%8710.png"><meta property="og:updated_time" content="2019-11-18T03:15:10.867Z"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="http:&#x2F;&#x2F;chenzhonzhou.github.io&#x2F;2018&#x2F;03&#x2F;02&#x2F;nginx-fan-xiang-dai-li-huan-cun-fu-wu-bu-shu&#x2F;%E5%9B%BE%E7%89%871.png"><script type="text/javascript" id="hexo.configurations">var NexT=window.NexT||{},CONFIG={root:"/",scheme:"Gemini",version:"5.1.4",sidebar:{position:"left",display:"always",offset:12,b2t:!0,scrollpercent:!0,onmobile:!0},fancybox:!0,tabs:!0,motion:{enable:!0,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}},duoshuo:{userId:"0",author:"博主"},algolia:{applicationID:"",apiKey:"",indexName:"",hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}}}</script><link rel="canonical" href="http://chenzhonzhou.github.io/2018/03/02/nginx-fan-xiang-dai-li-huan-cun-fu-wu-bu-shu/"><title>Nginx 反向代理缓存服务 | 凡间的精灵</title><link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css"></head><body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans"><div class="container sidebar-position-left page-post-detail"><div class="headband"></div><header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-wrapper"><div class="site-meta"><div class="custom-logo-site-title"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">凡间的精灵</span> <span class="logo-line-after"><i></i></span></a></div><p class="site-subtitle">凡尘落素一精灵</p></div><div class="site-nav-toggle"><button><span class="btn-bar"></span> <span class="btn-bar"></span> <span class="btn-bar"></span></button></div></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i><br>首页</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i><br>归档</a></li><li class="menu-item menu-item-categories"><a href="/categories" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i><br>分类</a></li><li class="menu-item menu-item-tags"><a href="/tags" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i><br>标签</a></li><li class="menu-item menu-item-sitemap"><a href="/sitemap.xml" rel="section"><i class="menu-item-icon fa fa-fw fa-sitemap"></i><br>站点地图</a></li><li class="menu-item menu-item-search"><a href="javascript:;" class="popup-trigger"><i class="menu-item-icon fa fa-search fa-fw"></i><br>搜索</a></li></ul><div class="site-search"><div class="popup search-popup local-search-popup"><div class="local-search-header clearfix"><span class="search-icon"><i class="fa fa-search"></i> </span><span class="popup-btn-close"><i class="fa fa-times-circle"></i></span><div class="local-search-input-wrapper"><input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input"></div></div><div id="local-search-result"></div></div></div></nav></div></header><main id="main" class="main"><div class="main-inner"><div class="content-wrap"><div id="content" class="content"><div id="posts" class="posts-expand"><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><div class="post-block"><link itemprop="mainEntityOfPage" href="http://chenzhonzhou.github.io/2018/03/02/nginx-fan-xiang-dai-li-huan-cun-fu-wu-bu-shu/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="name" content="Zhongzhou Chen"><meta itemprop="description" content=""><meta itemprop="image" content="/images/chen.png"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="凡间的精灵"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">Nginx 反向代理缓存服务</h1><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-03-02T16:11:59+08:00">2018-03-02 </time></span><span class="post-category"><span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-folder-o"></i> </span><span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Nginx/" itemprop="url" rel="index"><span itemprop="name">Nginx</span></a></span></span><div class="post-wordcount"><span class="post-meta-item-icon"><i class="fa fa-file-word-o"></i> </span><span class="post-meta-item-text">字数统计&#58;</span> <span title="字数统计">8.6k </span><span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-clock-o"></i> </span><span class="post-meta-item-text">阅读时长 &asymp;</span> <span title="阅读时长">34</span></div></div></header><div class="post-body" itemprop="articleBody"><h2 id="1、代理服务简介"><a href="#1、代理服务简介" class="headerlink" title="1、代理服务简介"></a>1、代理服务简介</h2><p><strong>代理服务可简单的分为正向代理和反向代理:</strong><br><strong>正向代理:</strong> 用于代理内部网络对<strong>Internet</strong>的连接请求(如<strong>VPN/NAT</strong>),客户端指定代理服务器,并将本来要直接发送给目标<strong>Web</strong>服务器的<strong>HTTP</strong>请求先发送到代理服务器上, 然后由代理服务器去访问<strong>Web</strong>服务器, 并将<strong>Web</strong>服务器的<strong>Response</strong>回传给客户端:<br><strong>反向代理:</strong> 与正向代理相反,如果局域网向<strong>Internet</strong>提供资源,并让<strong>Internet</strong>上的其他用户可以访问局域网内资源, 也可以设置一个代理服务器, 它提供的服务就是反向代理. 反向代理服务器接受来自<strong>Internet</strong>的连接,然后将请求转发给内部网络上的服务器,并将<strong>Response</strong>回传给<strong>Internet</strong>上请求连接的客户端:</p><h3 id="nginx反向代理"><a href="#nginx反向代理" class="headerlink" title="nginx反向代理"></a>nginx反向代理</h3><p><strong>Web服务器的调度器</strong></p><ol><li><strong>反向代理（Reverse Proxy）</strong>方式是指以代理服务器来接受客户端的连接请求，然后将请求转发给网络上的web服务器（可能是apache、nginx、tomcat、iis等），并将从web服务器上得到的结果返回给请求连接的客户端，此时代理服务器对外就表现为一个服务器。</li></ol><p><img src="/2018/03/02/nginx-fan-xiang-dai-li-huan-cun-fu-wu-bu-shu/%E5%9B%BE%E7%89%871.png" alt="img"></p><p><strong>从上图可以看出：</strong>反向代理服务器代理网站Web服务器接收Http请求，对请求进行转发。而且nginx作为反向代理服务器可以根据用户请求的内容把请求转发给后端不同的web服务器，例如静动分离，再例如在nginx上创建多个虚拟主机，这样就成功的做到了在浏览器中输入不同域名（url）的时候访问后端的不同web服务器或web群集。</p><ol start="2"><li><strong>反向代理的作用</strong></li></ol><ul><li><p>保护网站安全：任何来自Internet的请求都必须先经过代理服务器；</p><p><img src="/2018/03/02/nginx-fan-xiang-dai-li-huan-cun-fu-wu-bu-shu/%E5%9B%BE%E7%89%872.png" alt></p></li><li><p>通过配置缓存功能加速Web请求：可以缓存真实Web服务器上的某些静态资源，减轻真实Web服务器的负载压力；</p><p><img src="/2018/03/02/nginx-fan-xiang-dai-li-huan-cun-fu-wu-bu-shu/%E5%9B%BE%E7%89%873.png" alt></p></li><li><p>实现负载均衡：充当负载均衡服务器均衡地分发请求，平衡集群中各个服务器的负载压力；</p><p><img src="/2018/03/02/nginx-fan-xiang-dai-li-huan-cun-fu-wu-bu-shu/%E5%9B%BE%E7%89%874.png" alt></p></li></ul><h2 id="2、什么是nginx"><a href="#2、什么是nginx" class="headerlink" title="2、什么是nginx"></a>2、什么是nginx</h2><h3 id="nginx简介"><a href="#nginx简介" class="headerlink" title="nginx简介"></a>nginx简介</h3><p><strong>Nginx</strong>是一款轻量级的网页服务器、反向代理器以及电子邮件代理服务器。因它的稳定性、丰富的功能集、示例配置文件和低系统资源的消耗而闻名。<strong>Nginx</strong>（发音同<strong>engine x</strong>），它是由俄罗斯程序员<strong>Igor Sysoev</strong>所开发的。起初是供俄国大型的门户网站及搜索引擎<strong>Rambler</strong>（俄语：<strong>Рамблер</strong>）使用。此软件<strong>BSD-like</strong>协议下发行，可以在<strong>UNIX</strong>、<strong>GNU/Linux</strong>、<strong>BSD</strong>、<strong>Mac OS X</strong>、<strong>Solaris</strong>，以及<strong>Microsoft Windows</strong>等操作系统中运行。</p><p><strong>Nginx的应用现状</strong><br>Nginx 已经在俄罗斯最大的门户网站── Rambler Media（<a href="http://www.rambler.ru）上运行，同时俄罗斯超过20%的虚拟主机平台采用Nginx作为反向代理服务器。" target="_blank" rel="noopener">www.rambler.ru）上运行，同时俄罗斯超过20%的虚拟主机平台采用Nginx作为反向代理服务器。</a><br>在国内，已经有淘宝、新浪博客、新浪播客、网易新闻、六间房、56.com、Discuz!、水木社区、豆瓣、YUPOO、海内、迅雷在线等多家网站使用 Nginx 作为Web服务器或反向代理服务器。</p><h3 id="Nginx的核心特点"><a href="#Nginx的核心特点" class="headerlink" title="Nginx的核心特点"></a>Nginx的核心特点</h3><ol><li><p>跨平台：Nginx 可以在大多数OS编译运行，而且也有Windows的版本；</p></li><li><p>配置异常简单：非常容易上手。</p></li><li><p>非阻塞、高并发连接：官方测试能够支撑5万并发连接，在实际生产环境中跑到2～3万并发连接数。（这得益于Nginx使用了最新的epoll模型）；<br>注：<br>对于一个Web服务器来说，首先看一个请求的基本过程：建立连接—接收数据—发送数据，在系统底层看来：上述过程（建立连接—接收数据—发送数据）在系统底层就是读写事件。</p><p>如果采用阻塞调用的方式，当读写事件没有准备好时，那么就只能等待，当前线程被挂起，等事件准备好了，才能进行读写事件。<br>如果采用非阻塞调用的方式：事件马上返回，告诉你事件还没准备好呢，过会再来吧。过一会，再来检查一下事件，直到事件准备好了为止，在这期间，你就可以先去做其它事情，然后再来看看事件好了没。虽然不阻塞了，但你得不时地过来检查一下事件的状态，你可以做更多的事情了，但带来的开销也是不小的。非阻塞调用指在不能立刻得到结果之前，该调用不会阻塞当前线程</p></li><li><p>事件驱动：通信机制采用epoll模型，支持更大的并发连接。<br>非阻塞通过不断检查事件的状态来判断是否进行读写操作，这样带来的开销很大，因此就有了<strong>异步非阻塞的事件处理机制。这种机制让你可以同时监控多个事件</strong>，调用他们是非阻塞的，但可以设置超时时间，在超时时间之内，如果有事件准备好了，就返回。这种机制解决了上面阻塞调用与非阻塞调用的两个问题。<br>以epoll模型为例：当事件没有准备好时，就放入epoll(队列)里面。如果有事件准备好了，那么就去处理；当事件没有准备好时，才在epoll里面等着。这样，我们就可以并发处理大量的并发了，当然，这里的并发请求，是指未处理完的请求。线程只有一个，所以同时能处理的请求当然只有一个了，只是在请求之间进行不断地切换而已，切换也是因为异步事件未准备好，而主动让出的。这里的切换是没有任何代价，你可以理解为<strong>循环</strong>处理多个准备好的事件。<br>多线程方式相比，这种事件处理方式是有很大的优势的，不需要创建线程，每个请求占用的内存也很少，没有上下文切换，事件处理非常的轻量级，并发数再多也不会导致无谓的资源浪费（上下文切换）。对于apache服务器，每个请求会独占一个工作线程，当并发数上到几千时，就同时有几千的线程在处理请求了。这对操作系统来说，是个不小的挑战：因为线程带来的内存占用非常大，线程的上下文切换带来的cpu开销很大，自然性能就上不去，从而导致在高并发场景下性能下降严重。</p><p><strong>总结：</strong>通过异步非阻塞的事件处理机制，Nginx实现由进程循环处理多个准备好的事件，从而实现高并发和轻量级。</p></li><li><p>Master/Worker结构：一个master进程，生成一个或多个worker进程。</p><p><img src="/2018/03/02/nginx-fan-xiang-dai-li-huan-cun-fu-wu-bu-shu/%E5%9B%BE%E7%89%875.png" alt></p><p><strong>注：</strong>Master-Worker设计模式主要包含两个主要组件Master和Worker，Master维护着Worker队列，将请求下发到多个Worker并行执行，Worker主要进行实际逻辑计算，并将结果返回给Master。<br>nginx采用这种进程模型有什么好处？采用独立的进程，可以让互相之间不会影响，一个进程退出后，其它进程还在工作，服务不会中断，Master 进程则很快重新启动新的Worker进程。当然，Worker进程的异常退出，肯定是程序有bug了，异常退出，会导致当前Worker上的所有请求失败，不过不会影响到所有请求，所以降低了风险。</p></li><li><p>内存消耗小：处理大并发的请求内存消耗非常小。在3万并发连接下，开启的10个Nginx 进程才消耗150M内存（15M*10=150M）。</p></li><li><p>内置的健康检查功能：如果 Nginx 代理的后端的某台 Web 服务器宕机了，不会影响前端访问。</p></li><li><p>节省带宽：支持 GZIP 压缩，可以添加浏览器本地缓存的 Header 头。</p></li><li><p>稳定性高：用于反向代理，宕机的概率微乎其微。</p></li></ol><h2 id="3、Nginx-apache构筑Web服务器集群的负载均衡"><a href="#3、Nginx-apache构筑Web服务器集群的负载均衡" class="headerlink" title="3、Nginx+apache构筑Web服务器集群的负载均衡"></a>3、Nginx+apache构筑Web服务器集群的负载均衡</h2><p><strong>nginx配置反向代理</strong><br>配置nginx作为反向代理和负载均衡，同时利用其缓存功能，将静态页面在nginx缓存，以达到降低后端服务器连接数的目的并检查后端web服务器的健康状况。</p><p><img src="/2018/03/02/nginx-fan-xiang-dai-li-huan-cun-fu-wu-bu-shu/%E5%9B%BE%E7%89%876.png" alt="image-20191118105127689"></p><h3 id="3-1-部署-nginx"><a href="#3-1-部署-nginx" class="headerlink" title="3.1 部署 nginx"></a>3.1 部署 nginx</h3><p><strong>环境说明：</strong></p><table><thead><tr><th>OS</th><th>centos7.2</th></tr></thead><tbody><tr><td>nginx</td><td>192.168.31.83</td></tr><tr><td>apache1</td><td>192.168.31.141</td></tr><tr><td>apache2</td><td>192.168.31.250</td></tr></tbody></table><p><strong>安装zlib-devel、pcre-devel等依赖包</strong></p><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="symbol">@www</span> ~]<span class="meta"># yum -y install gccgcc-c++ make libtool zlib zlib-devel pcrepcre-devel openssl openssl-devel</span></span><br></pre></td></tr></table></figure><p><strong>注：</strong><br>结合proxy和upstream模块实现后端web负载均衡<br>使用proxy模块实现静态文件缓存<br>结合nginx默认自带的ngx_http_proxy_module模块 和ngx_http_upstream_module模块实现后端服务器的健康检查，也可以使用第三方模块nginx_upstream_check_module<br>使用nginx-sticky-module扩展模块实现Cookie会话黏贴（保持会话）<br>使用ngx_cache_purge实现更强大的缓存清除功能<br>上面提到的2个模块都属于第三方扩展模块，需要提前下好源码，然后编译时通过–add-moudle=src_path一起安装。<br><strong>安装nginx</strong></p><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="symbol">@www</span> ~]<span class="meta"># groupadd www   #添加www组</span></span><br><span class="line">[root<span class="symbol">@www</span> ~]<span class="meta"># useradd -g www www -s /sbin/nologin  #创建nginx运行账户www并加入到www组，不</span></span><br></pre></td></tr></table></figure><p>允许www用户直接登录系统</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># tar zxf nginx-1.10.2.tar.gz </span></span><br><span class="line"><span class="comment"># tar zxf ngx_cache_purge-2.3.tar.gz </span></span><br><span class="line"><span class="comment"># tar zxf master.tar.gz</span></span><br><span class="line"><span class="comment"># cd nginx-1.10.2/</span></span><br><span class="line"></span><br><span class="line">[root@www nginx-1.10.2]# ./configure <span class="attribute">--prefix</span>=/usr/local/nginx1.10 <span class="attribute">--user</span>=www <span class="attribute">--group</span>=www --with-http_stub_status_module --with-http_realip_module --with-http_ssl_module --with-http_gzip_static_module <span class="attribute">--http-client-body-temp-path</span>=/var/tmp/nginx/client <span class="attribute">--http-proxy-temp-path</span>=/var/tmp/nginx/proxy <span class="attribute">--http-fastcgi-temp-path</span>=/var/tmp/nginx/fcgi --with-pcre <span class="attribute">--add-module</span>=../ngx_cache_purge-2.3 --with-http_flv_module  <span class="attribute">--add-module</span>=../nginx-goodies-nginx-sticky-module-ng-08a395c66e42</span><br><span class="line">[root@www nginx-1.10.2]# make&amp;&amp; make install</span><br></pre></td></tr></table></figure><p><strong>注：</strong>nginx的所有模块必须在编译的时候添加，不能再运行的时候动态加载。<br>优化nginx程序的执行路径</p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[<span class="symbol">root@</span>www nginx<span class="number">-1.10</span><span class="number">.2</span>]# ln -s /usr/local/nginx1<span class="number">.10</span>/sbin/nginx /usr/local/sbin/</span><br><span class="line">[<span class="symbol">root@</span>www nginx<span class="number">-1.10</span><span class="number">.2</span>]# nginx -t</span><br><span class="line">[<span class="symbol">root@</span>www nginx<span class="number">-1.10</span><span class="number">.2</span>]# mkdir -p /var/tmp/nginx/client</span><br><span class="line">[<span class="symbol">root@</span>www nginx<span class="number">-1.10</span><span class="number">.2</span>]# chown -R www:www /var/tmp/nginx/</span><br><span class="line">[<span class="symbol">root@</span>www nginx<span class="number">-1.10</span><span class="number">.2</span>]# nginx -t</span><br><span class="line">nginx: the configuration file /usr/local/nginx1<span class="number">.10</span>/conf/nginx.conf syntax <span class="keyword">is</span> ok</span><br><span class="line">nginx: configuration file /usr/local/nginx1<span class="number">.10</span>/conf/nginx.conf test <span class="keyword">is</span> successful</span><br></pre></td></tr></table></figure><h3 id="3-2-编写nginx服务脚本"><a href="#3-2-编写nginx服务脚本" class="headerlink" title="3.2 编写nginx服务脚本"></a>3.2 编写nginx服务脚本</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">[root@www ~]<span class="comment"># vi /etc/init.d/nginx</span></span><br><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># chkconfig: 2345 99 20</span></span><br><span class="line"><span class="comment"># description: Nginx Service Control Script</span></span><br><span class="line">PROG=<span class="string">"/usr/local/nginx1.10/sbin/nginx"</span></span><br><span class="line">PIDF=<span class="string">"/usr/local/nginx1.10/logs/nginx.pid"</span></span><br><span class="line"><span class="keyword">case</span> <span class="string">"<span class="variable">$1</span>"</span> <span class="keyword">in</span></span><br><span class="line">start)</span><br><span class="line">netstat -anplt |grep <span class="string">":80"</span> &amp;&gt; /dev/null &amp;&amp;pgrep <span class="string">"nginx"</span> &amp;&gt; /dev/null</span><br><span class="line"><span class="keyword">if</span> [ $? -eq 0 ]</span><br><span class="line"><span class="keyword">then</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"Nginx service already running."</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">     <span class="variable">$PROG</span> -t &amp;&gt; /dev/null</span><br><span class="line"><span class="keyword">if</span> [ $? -eq 0 ] ; <span class="keyword">then</span> </span><br><span class="line">       <span class="variable">$PROG</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"Nginx service start success."</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">     <span class="variable">$PROG</span> -t</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line">   ;;</span><br><span class="line">stop)</span><br><span class="line">netstat -anplt |grep <span class="string">":80"</span> &amp;&gt; /dev/null &amp;&amp;pgrep <span class="string">"nginx"</span> &amp;&gt; /dev/null</span><br><span class="line"><span class="keyword">if</span> [ $? -eq 0 ]</span><br><span class="line"><span class="keyword">then</span></span><br><span class="line"><span class="built_in">kill</span> -s QUIT $(cat <span class="variable">$PIDF</span>)</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"Nginx service stop success."</span> </span><br><span class="line"><span class="keyword">else</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"Nginx service already stop"</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line">   ;;</span><br><span class="line">restart)</span><br><span class="line">    <span class="variable">$0</span> stop</span><br><span class="line">    <span class="variable">$0</span> start</span><br><span class="line">    ;;</span><br><span class="line">status)</span><br><span class="line">netstat -anplt |grep <span class="string">":80"</span> &amp;&gt; /dev/null &amp;&amp;pgrep <span class="string">"nginx"</span> &amp;&gt; /dev/null</span><br><span class="line"><span class="keyword">if</span> [ $? -eq 0 ]</span><br><span class="line"><span class="keyword">then</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"Nginx service is running."</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"Nginx is stop."</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line">  ;; </span><br><span class="line">reload)</span><br><span class="line">netstat -anplt |grep <span class="string">":80"</span> &amp;&gt; /dev/null &amp;&amp;pgrep <span class="string">"nginx"</span> &amp;&gt; /dev/null</span><br><span class="line"><span class="keyword">if</span> [ $? -eq 0 ]</span><br><span class="line"><span class="keyword">then</span></span><br><span class="line">    <span class="variable">$PROG</span> -t &amp;&gt; /dev/null</span><br><span class="line"><span class="keyword">if</span> [ $? -eq 0 ] ; <span class="keyword">then</span></span><br><span class="line"><span class="built_in">kill</span> -s HUP $(cat <span class="variable">$PIDF</span>)</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"reload Nginxconfig success."</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">      <span class="variable">$PROG</span> -t</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"Nginx service is not run."</span> </span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line">    ;;</span><br><span class="line">  *)</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"Usage: <span class="variable">$0</span> &#123;start|stop|restart|reload&#125;"</span></span><br><span class="line"><span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">esac</span></span><br></pre></td></tr></table></figure><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@www ~]# chmod +x /etc/init.d/nginx</span><br><span class="line">[root@www ~]# chkconfig --<span class="builtin-name">add</span> nginx</span><br><span class="line">[root@www ~]# chkconfig nginx on</span><br><span class="line">[root@www ~]#<span class="built_in"> service </span> nginx start</span><br><span class="line">Nginx<span class="built_in"> service </span>start success.</span><br><span class="line">[root@www ~]#<span class="built_in"> service </span> nginx status</span><br><span class="line">Nginx<span class="built_in"> service </span>is running.</span><br><span class="line">[root@www ~]# netstat -anpt | grep nginx</span><br><span class="line">tcp        0      0 0.0.0.0:80              0.0.0.0:*               LISTEN      3977/nginx: master  </span><br><span class="line">[root@www ~]# firewall-cmd --permanent <span class="attribute">--add-port</span>=80/tcp</span><br><span class="line">success</span><br><span class="line">[root@www ~]# firewall-cmd --reload</span><br><span class="line">Success</span><br></pre></td></tr></table></figure><p><strong>注：</strong>如果你想在已安装好的nginx上添加第三方模块，依然需要重新编译，但为了不覆盖你原有的配置，请不要make install，而是直接拷贝可执行文件：</p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># nginx–V</span><br><span class="line">[<span class="symbol">root@</span>wwwnginx<span class="number">-1.10</span><span class="number">.2</span>]#./configure--add-module=……   #你的第三方模块</span><br><span class="line">[<span class="symbol">root@</span>wwwnginx<span class="number">-1.10</span><span class="number">.2</span>]# make后不要make install,改为手动拷贝，先备份</span><br><span class="line">[<span class="symbol">root@</span>www nginx<span class="number">-1.10</span><span class="number">.2</span>]# cp /usr/local/nginx1<span class="number">.10</span>/sbin/nginx /usr/local/nginx1<span class="number">.10</span>/sbin/nginx.bak</span><br><span class="line">[<span class="symbol">root@</span>www nginx<span class="number">-1.10</span><span class="number">.2</span>]# cp objs/nginx /usr/local/nginx1<span class="number">.10</span>/sbin/nginx</span><br></pre></td></tr></table></figure><h3 id="3-3-配置nginx反向代理"><a href="#3-3-配置nginx反向代理" class="headerlink" title="3.3 配置nginx反向代理"></a>3.3 配置nginx反向代理</h3><p><strong>反向代理+负载均衡+健康探测</strong></p><p>查看nginx加载的模块</p><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@www ~]<span class="comment">## nginx -V</span></span><br><span class="line">nginx <span class="keyword">version</span>: nginx/1.10.2</span><br><span class="line">built by gcc 4.8.5 20150623 <span class="params">(Red Hat 4.8.5-4)</span> <span class="params">(GCC)</span> </span><br><span class="line">built with OpenSSL 1.0.1e-fips 11 Feb 2013</span><br><span class="line">TLS SNI support enabled</span><br><span class="line">configure arguments: <span class="params">--prefix=/usr/local/nginx1</span>.10 <span class="params">--user=www</span> <span class="params">--group=www</span> <span class="params">--with-http_stub_status_module</span> <span class="params">--with-http_realip_module</span> <span class="params">--with-http_ssl_module</span> <span class="params">--with-http_gzip_static_module</span> <span class="params">--http-client-body-temp-path=/var/tmp/nginx/client</span> <span class="params">--http-proxy-temp-path=/var/tmp/nginx/proxy</span> <span class="params">--http-fastcgi-temp-path=/var/tmp/nginx/fcgi</span> <span class="params">--with-pcre</span> <span class="params">--add-module=</span><span class="string">../ngx_cache_purge-2.3</span> <span class="params">--with-http_flv_module</span> <span class="params">--add-module=</span><span class="string">../nginx-goodies-nginx-sticky-module-ng-08a395c66e42</span></span><br></pre></td></tr></table></figure><p>nginx的所有模块必须在编译的时候添加，不能再运行的时候动态加载。</p><h3 id="3-4-nginx-sticky-module模块"><a href="#3-4-nginx-sticky-module模块" class="headerlink" title="3.4 nginx-sticky-module模块"></a>3.4 nginx-sticky-module模块</h3><p>这个模块的作用是通过cookie黏贴的方式将来自同一个客户端（浏览器）的请求发送到同一个后端服务器上处理，这样一定程度上可以解决多个backend servers的session同步的问题 —— 因为不再需要同步，而RR轮询模式必须要运维人员自己考虑session同步的实现。<br>另外内置的ip_hash也可以实现根据客户端IP来分发请求，但它很容易造成负载不均衡的情况，而如果nginx前面有CDN网络或者来自同一局域网的访问，它接收的客户端IP是一样的，容易造成负载不均衡现象。nginx-sticky-module的cookie过期时间，默认浏览器关闭就过期。<br>这个模块并不合适不支持 Cookie 或手动禁用了cookie的浏览器，此时默认sticky就会切换成RR。它不能与ip_hash同时使用。</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">upstream backend &#123;</span><br><span class="line">server 192.168.31.141:80 <span class="attribute">weight</span>=1;</span><br><span class="line">server 192.168.31.250:80 <span class="attribute">weight</span>=1;</span><br><span class="line">sticky;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>配置起来超级简单，一般来说一个sticky指令就够了。<br>相关信息可以查看官方文档 <a href="https://bitbucket.org/nginx-goodies/nginx-sticky-module-ng" target="_blank" rel="noopener">https://bitbucket.org/nginx-goodies/nginx-sticky-module-ng</a></p><h3 id="3-5-load-balance其它调度方案"><a href="#3-5-load-balance其它调度方案" class="headerlink" title="3.5 load-balance其它调度方案"></a>3.5 load-balance其它调度方案</h3><p>这里顺带介绍一下nginx的负载均衡模块支持的其它调度算法：<br><strong>轮询（默认） ：</strong>每个请求按时间顺序逐一分配到不同的后端服务器，如果后端某台服务器宕机，故障系统被自动剔除，使用户访问不受影响。Weight 指定轮询权值，Weight值越大，分配到的访问机率越高，主要用于后端每个服务器性能不均的情况下。<br><strong>ip_hash ：</strong>每个请求按访问IP的hash结果分配，这样来自同一个IP的访客固定访问一个后端服务器，有效解决了动态网页存在的session共享问题。当然如果这个节点不可用了，会发到下个节点，而此时没有session同步的话就注销掉了。<br><strong>least_conn</strong> ：请求被发送到当前活跃连接最少的realserver上。会考虑weight的值。<br><strong>url_hash ：</strong>此方法按访问url的hash结果来分配请求，使每个url定向到同一个后端服务器，可以进一步提高后端缓存服务器的效率。Nginx本身是不支持url_hash的，如果需要使用这种调度算法，必须安装Nginx的hash软件包nginx_upstream_hash。<br><strong>fair ：</strong>这是比上面两个更加智能的负载均衡算法。此种算法可以依据页面大小和加载时间长短智能地进行负载均衡，也就是根据后端服务器的响应时间来分配请求，响应时间短的优先分配。Nginx本身是不支持fair的，如果需要使用这种调度算法，必须下载Nginx的upstream_fair模块。</p><h3 id="3-6-负载均衡与健康检查"><a href="#3-6-负载均衡与健康检查" class="headerlink" title="3.6 负载均衡与健康检查"></a>3.6 负载均衡与健康检查</h3><p>严格来说，nginx自带是没有针对负载均衡后端节点的健康检查的，但是可以通过默认自带的ngx_http_proxy_module模块和ngx_http_upstream_module模块中的相关指令来完成当后端节点出现故障时，自动切换到下一个节点来提供访问。</p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">upstream backend &#123;</span><br><span class="line">sticky;</span><br><span class="line">server <span class="number">192.168</span><span class="number">.31</span><span class="number">.141</span>:<span class="number">80</span> weight=<span class="number">1</span> max_fails=<span class="number">2</span> fail_timeout=<span class="number">10</span>s;</span><br><span class="line">server <span class="number">192.168</span><span class="number">.31</span><span class="number">.250</span>:<span class="number">80</span> weight=<span class="number">1</span> max_fails=<span class="number">2</span> fail_timeout=<span class="number">10</span>s;</span><br><span class="line">&#125;</span><br><span class="line">server &#123;</span><br><span class="line">……</span><br><span class="line">location / &#123;</span><br><span class="line">proxy_pass http:<span class="comment">//backend;</span></span><br><span class="line">&#125;</span><br><span class="line">……</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>weight：</strong>轮询权值也是可以用在ip_hash的，默认值为1<br><strong>max_fails：</strong>允许请求失败的次数，默认为1。当超过最大次数时，返回proxy_next_upstream模块定义的错误。<br><strong>fail_timeout：</strong>有两层含义，一是在10s 时间内最多容许2 次失败；二是在经历了 2 次失败以后，10s时间内不分配请求到这台服务器。</p><h3 id="3-7-nginx的proxy缓存使用"><a href="#3-7-nginx的proxy缓存使用" class="headerlink" title="3.7 nginx的proxy缓存使用"></a>3.7 nginx的proxy缓存使用</h3><p>缓存也就是将js、css、image等静态文件从后端服务器缓存到nginx指定的缓存目录下，既可以减轻后端服务器负担，也可以加快访问速度，但这样缓存及时清理成为了一个问题，所以需要ngx_cache_purge这个模块来在过期时间未到之前，手动清理缓存。<br>proxy模块中常用的指令时proxy_pass和proxy_cache.<br>nginx的web缓存功能的主要是由proxy_cache、fastcgi_cache指令集和相关指令集完成，proxy_cache指令负责反向代理缓存后端服务器的静态内容，fastcgi_cache主要用来处理FastCGI动态进程缓存。</p><blockquote><p>http {<br>#<font color="red">$upstream_cache_status记录缓存命中率</font><br>log_format main ‘$remote_addr - $remote_user [$time_local] “$request” ‘<br>‘$status $body_bytes_sent “$http_referer” ‘<br>‘“$http_user_agent” “$http_x_forwarded_for”‘<br><font color="red">‘“$upstream_cache_status”‘;</font><br>access_log logs/access.log main;<br><font color="red">proxy_buffering on;</font> #代理的时候，开启或关闭缓冲后端服务器的响应<br><font color="red">proxy_temp_path /usr/local/nginx1.10/proxy_temp;</font><br><font color="red">proxy_cache_path /usr/local/nginx1.10/proxy_cache levels=1:2 keys_zone=my-cache:100minactive=600mmax_size=2g;</font><br>server {<br>listen 80;<br>server_namelocalhost;<br>root html;<br>index index.php index.html index.htm;<br>#ngx_cache_purge实现缓存清除<br>location ~/purge(/.<em>) {<br>allow 127.0.0.1;<br>allow 192.168.31.0/24;<br>deny all;<br>proxy_cache_purge my-cache $host$1$is_args$args;<br>}<br>location ~ .*.(gif|jpg|png|html|htm|css|js|ico|swf|pdf)(.</em>) {<br>proxy_pass <a href="http://backend" target="_blank" rel="noopener">http://backend</a>;<br>proxy_redirect off;<br><font color="red">proxy_set_header Host $host;</font><br><font color="red">proxy_set_header X-Real-IP $remote_addr;</font><br><font color="red">proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</font><br><font color="red">proxy_ignore_headers Set-Cookie;</font><br><font color="red">proxy_hide_header Set-Cookie;</font><br><font color="red">proxy_next_upstream error timeout invalid_header http_500 http_502 http_503 http_504;</font><br><font color="red">proxy_cache my-cache;</font><br>add_headerNginx-Cache $upstream_cache_status;<br><font color="red">proxy_cache_valid 200 304 301 302 8h;</font><br><font color="red">proxy_cache_valid 404 1m;</font><br><font color="red">proxy_cache_valid any 1d;</font><br><font color="red">proxy_cache_key $host$uri$is_args$args;</font><br><font color="red">expires 30d;</font><br>}</p></blockquote><p><strong>相关选项说明：</strong></p><p>proxy_buffering on; 代理的时候，开启或关闭缓冲后端服务器的响应。<br>当开启缓冲时，nginx尽可能快地从被代理的服务器接收响应，再将它存入缓冲区中。</p><p>proxy_temp_path：缓存临时目录。后端的响应并不直接返回客户端，而是先写到一个临时文件中，然后被rename一下当做缓存放在proxy_cache_path。0.8.9版本以后允许temp和cache两个目录在不同文件系统上（分区），然而为了减少性能损失还是建议把它们设成一个文件系统上。</p><p>proxy_cache_path：设置缓存目录，目录里的文件名是cache_key的MD5值。<br>levels=1:2 keys_zone=my-cache:100m表示采用2级目录结构，第一层目录只有一个字符，是由levels=1:2设置，总共二层目录，子目录名字由二个字符组成。Web缓存区名称为my-cache，内存缓存空间大小为100MB，这个缓冲zone可以被多次使用。文件系统上看到的缓存文件名类似于 /usr/local/nginx1.10/proxy_cache/c/29/b7f54b2df7773722d382f4809d65029c 。<br>inactive=600max_size=2g表示600分钟没有被访问的内容自动清除，硬盘最大缓存空间为2GB，超过这个大小将清除最近最少使用的数据。</p><p>需要在默认情况，nginx不缓存从后端响应的http头中带有Set-Cookie的对象。如果客户端发送的请求带有Cookie header，varnish将忽略缓存，直接将请求传递到后端。nginx中通过proxy_ignore_headers设置忽略它们，设置方法如下：<br>解决办法：<br>proxy_ignore_headers Set-Cookie;<br>proxy_hide_header Set-Cookie;</p><p>proxy_cache：引用前面定义的缓存区my-cache</p><p>proxy_cache_key：定义如何生成缓存的键，设置web缓存的key值，nginx根据key值md5哈希存储缓存</p><p>proxy_cache_valid：为不同的响应状态码设置不同的缓存时间，比如200、302等正常结果可以缓存的时间长点，而404、500等缓存时间设置短一些，这个时间到了文件就会过期，而不论是否刚被访问过。</p><p>add_header指令来设置response header,语法: add_header name value;<br>$upstream_cache_status这个变量来显示缓存的状态，我们可以在配置中添加一个http头来显示这一状态，<br>$upstream_cache_status包含以下几种状态：<br>·MISS 未命中，请求被传送到后端<br>·HIT 缓存命中<br>·EXPIRED 缓存已经过期请求被传送到后端<br>·UPDATING 正在更新缓存，将使用旧的应答<br>·STALE 后端将得到过期的应答</p><p>expires ：在响应头里设置Expires:或Cache-Control:max-age，返回给客户端的浏览器缓存失效时间。</p><p>下面的nginx.conf实现nginx在前端做反向代理服务器的完整配置文件的例子，处理js、png等静态文件，jsp/php等动态请求转发到其它服务器tomcat/apache</p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">user</span>  <span class="string">www;</span></span><br><span class="line"><span class="attr">worker_processes</span>  <span class="string">4;</span></span><br><span class="line"><span class="attr">worker_cpu_affinity</span> <span class="string">0001 0010 0100 1000;</span></span><br><span class="line"><span class="attr">error_log</span>  <span class="string">logs/error.log;</span></span><br><span class="line"><span class="comment">#error_log  logs/error.log  notice;</span></span><br><span class="line"><span class="comment">#error_log  logs/error.log  info;</span></span><br><span class="line"><span class="attr">worker_rlimit_nofile</span> <span class="string">10240;</span></span><br><span class="line"><span class="attr">pid</span>        <span class="string">logs/nginx.pid;</span></span><br><span class="line"><span class="attr">events</span> <span class="string">&#123;</span></span><br><span class="line"><span class="attr">useepoll;</span></span><br><span class="line"><span class="attr">worker_connections</span>  <span class="string">4096;</span></span><br><span class="line"><span class="attr">&#125;</span></span><br><span class="line"><span class="attr">http</span> <span class="string">&#123;</span></span><br><span class="line"><span class="attr">includemime.types;</span></span><br><span class="line"><span class="attr">default_type</span>  <span class="string">application/octet-stream;</span></span><br><span class="line"><span class="attr">log_format</span>  <span class="string">main  '$remote_addr - $remote_user [$time_local] "$request" '</span></span><br><span class="line">                      <span class="meta">'$status</span> <span class="string">$body_bytes_sent "$http_referer" '</span></span><br><span class="line">                      <span class="meta">'"$http_user_agent"</span> <span class="string">"$http_x_forwarded_for"'</span></span><br><span class="line">                      <span class="attr">'"$upstream_cache_status"';</span></span><br><span class="line"><span class="attr">access_log</span>  <span class="string">logs/access.log  main;</span></span><br><span class="line"><span class="attr">server_tokens</span> <span class="string">off;</span></span><br><span class="line"><span class="attr">sendfile</span>        <span class="string">on;</span></span><br><span class="line"><span class="comment">    #tcp_nopush     on;</span></span><br><span class="line"><span class="comment">    #keepalive_timeout  0;</span></span><br><span class="line"><span class="attr">keepalive_timeout</span>  <span class="string">65;</span></span><br><span class="line"><span class="comment">    #Compression Settings</span></span><br><span class="line"><span class="attr">gzip</span> <span class="string">on;</span></span><br><span class="line"><span class="attr">gzip_comp_level</span> <span class="string">6;</span></span><br><span class="line"><span class="attr">gzip_http_version</span> <span class="string">1.1;</span></span><br><span class="line"><span class="attr">gzip_proxied</span> <span class="string">any;</span></span><br><span class="line"><span class="attr">gzip_min_length</span> <span class="string">1k;</span></span><br><span class="line"><span class="attr">gzip_buffers</span> <span class="string">16 8k;</span></span><br><span class="line"><span class="attr">gzip_types</span> <span class="string">text/plain text/css text/javascript application/json application/javascript application/x-javascript application/xml;</span></span><br><span class="line"><span class="attr">gzip_vary</span> <span class="string">on;</span></span><br><span class="line"><span class="comment">    #end gzip</span></span><br><span class="line"><span class="comment">    # http_proxy Settings</span></span><br><span class="line"><span class="attr">client_max_body_size</span>   <span class="string">10m;</span></span><br><span class="line"><span class="attr">client_body_buffer_size</span>   <span class="string">128k;</span></span><br><span class="line"><span class="attr">proxy_connect_timeout</span>   <span class="string">75;</span></span><br><span class="line"><span class="attr">proxy_send_timeout</span>   <span class="string">75;</span></span><br><span class="line"><span class="attr">proxy_read_timeout</span>   <span class="string">75;</span></span><br><span class="line"><span class="attr">proxy_buffer_size</span>   <span class="string">4k;</span></span><br><span class="line"><span class="attr">proxy_buffers</span>   <span class="string">4 32k;</span></span><br><span class="line"><span class="attr">proxy_busy_buffers_size</span>   <span class="string">64k;</span></span><br><span class="line"><span class="attr">proxy_temp_file_write_size</span>  <span class="string">64k;</span></span><br><span class="line"><span class="attr">proxy_buffering</span> <span class="string">on;</span></span><br><span class="line"><span class="attr">proxy_temp_path</span> <span class="string">/usr/local/nginx1.10/proxy_temp;</span></span><br><span class="line"><span class="attr">proxy_cache_path</span> <span class="string">/usr/local/nginx1.10/proxy_cache levels=1:2 keys_zone=my-cache:100mmax_size=1000m inactive=600m max_size=2g;</span></span><br><span class="line"><span class="comment">    #load balance Settings</span></span><br><span class="line"><span class="attr">upstream</span> <span class="string">backend &#123;</span></span><br><span class="line"><span class="attr">sticky;</span></span><br><span class="line"><span class="attr">server</span> <span class="string">192.168.31.141:80 weight=1 max_fails=2 fail_timeout=10s;</span></span><br><span class="line"><span class="attr">server</span> <span class="string">192.168.31.250:80 weight=1 max_fails=2 fail_timeout=10s;</span></span><br><span class="line">    <span class="attr">&#125;</span></span><br><span class="line"><span class="comment">    #virtual host Settings</span></span><br><span class="line"><span class="attr">server</span> <span class="string">&#123;</span></span><br><span class="line"><span class="attr">listen</span>       <span class="string">80;</span></span><br><span class="line"><span class="attr">server_namelocalhost;</span></span><br><span class="line"><span class="attr">charset</span> <span class="string">utf-8;</span></span><br><span class="line"><span class="attr">location</span>  <span class="string">~/purge(/.*) &#123;</span></span><br><span class="line"><span class="attr">allow</span> <span class="string">127.0.0.1;</span></span><br><span class="line"><span class="attr">allow</span> <span class="string">192.168.31.0/24;</span></span><br><span class="line"><span class="attr">deny</span> <span class="string">all;</span></span><br><span class="line"><span class="attr">proxy_cache_purge</span> <span class="string">my-cache $host$1$is_args$args;</span></span><br><span class="line">        <span class="attr">&#125;</span></span><br><span class="line"><span class="attr">location</span> <span class="string">/ &#123;</span></span><br><span class="line"><span class="attr">index</span>  <span class="string">index.php index.html index.htm;</span></span><br><span class="line"><span class="attr">proxy_pass</span>        <span class="string">http://backend;</span></span><br><span class="line"><span class="attr">proxy_redirect</span> <span class="string">off;</span></span><br><span class="line"><span class="attr">proxy_set_header</span>  <span class="string">Host  $host;</span></span><br><span class="line"><span class="attr">proxy_set_header</span>  <span class="string">X-Real-IP  $remote_addr;</span></span><br><span class="line"><span class="attr">proxy_set_header</span>  <span class="string">X-Forwarded-For  $proxy_add_x_forwarded_for;</span></span><br><span class="line"><span class="attr">proxy_ignore_headers</span> <span class="string">Set-Cookie;</span></span><br><span class="line"><span class="attr">proxy_hide_header</span> <span class="string">Set-Cookie;</span></span><br><span class="line"><span class="attr">proxy_next_upstream</span> <span class="string">error timeout invalid_header http_500 http_502 http_503 http_504;</span></span><br><span class="line">        <span class="attr">&#125;</span></span><br><span class="line"><span class="attr">location</span> <span class="string">~ .*\.(gif|jpg|png|html|htm|css|js|ico|swf|pdf)(.*) &#123;</span></span><br><span class="line"><span class="attr">proxy_pass</span>  <span class="string">http://backend;</span></span><br><span class="line"><span class="attr">proxy_redirect</span> <span class="string">off;</span></span><br><span class="line"><span class="attr">proxy_set_header</span> <span class="string">Host $host;</span></span><br><span class="line"><span class="attr">proxy_set_header</span> <span class="string">X-Real-IP $remote_addr;</span></span><br><span class="line"><span class="attr">proxy_set_header</span> <span class="string">X-Forwarded-For $proxy_add_x_forwarded_for;</span></span><br><span class="line"><span class="attr">proxy_next_upstream</span> <span class="string">error timeout invalid_header http_500 http_502 http_503 http_504;</span></span><br><span class="line"><span class="attr">proxy_cache</span> <span class="string">my-cache;</span></span><br><span class="line"><span class="meta">add_headerNginx-Cache</span> <span class="string">$upstream_cache_status;</span></span><br><span class="line"><span class="attr">proxy_cache_valid</span> <span class="string">200 304 301 302 8h;</span></span><br><span class="line"><span class="attr">proxy_cache_valid</span> <span class="string">404 1m;</span></span><br><span class="line"><span class="attr">proxy_cache_valid</span> <span class="string">any 1d;</span></span><br><span class="line"><span class="attr">proxy_cache_key</span> <span class="string">$host$uri$is_args$args;</span></span><br><span class="line"><span class="attr">expires</span> <span class="string">30d;</span></span><br><span class="line">        <span class="attr">&#125;</span></span><br><span class="line"><span class="attr">location</span> <span class="string">/nginx_status &#123;</span></span><br><span class="line"><span class="attr">stub_status</span> <span class="string">on;</span></span><br><span class="line"><span class="attr">access_log</span> <span class="string">off;</span></span><br><span class="line"><span class="attr">allow</span> <span class="string">192.168.31.0/24;</span></span><br><span class="line"><span class="attr">deny</span> <span class="string">all;</span></span><br><span class="line">        <span class="attr">&#125;</span></span><br><span class="line">    <span class="attr">&#125;</span></span><br><span class="line"><span class="attr">&#125;</span></span><br></pre></td></tr></table></figure><h4 id="常用指令说明"><a href="#常用指令说明" class="headerlink" title="常用指令说明:"></a><strong>常用指令说明:</strong></h4><h5 id="main全局配置"><a href="#main全局配置" class="headerlink" title="main全局配置:"></a><strong>main全局配置:</strong></h5><p><strong>woker_processes4</strong><br>在配置文件的顶级main部分，worker角色的工作进程的个数，master进程是接收并分配请求给worker处理。这个数值简单一点可以设置为cpu的核数grep ^processor /proc/cpuinfo | wc -l，也是 auto 值，如果开启了ssl和gzip更应该设置成与逻辑CPU数量一样甚至为2倍，可以减少I/O操作。如果nginx服务器还有其它服务，可以考虑适当减少。</p><p><strong>worker_cpu_affinity</strong><br>也是写在main部分。在高并发情况下，通过设置cpu粘性来降低由于多CPU核切换造成的寄存器等现场重建带来的性能损耗。如worker_cpu_affinity 0001 0010 0100 1000; （四核）。<br>附：<br>CPU工作状况：（输入 top 后，按1 查看）</p><p><img src="/2018/03/02/nginx-fan-xiang-dai-li-huan-cun-fu-wu-bu-shu/%E5%9B%BE%E7%89%877.png" alt></p><p>上面的配置表示：4核CPU，开启4个进程。0001表示开启第一个cpu内核， 0010表示开启第二个cpu内核，依次类推；有多少个核，就有几位数，1表示该内核开启，0表示该内核关闭。</p><p>例如：</p><p>1、2核CPU，开启2个进程<br>worker_processes2;<br>worker_cpu_affinity0110;<br>2、2核CPU，开启4进程<br>worker_processes4;<br>worker_cpu_affinity01100110;<br>3、2核CPU，开启8进程<br>worker_processes8;<br>worker_cpu_affinity0110011001100110;<br>4、8核CPU，开启2进程<br>worker_processes2;<br>worker_cpu_affinity1010101001010101;<br>说明：10101010表示开启了第2,4,6,8内核，01010101表示开始了1,3,5,7内核<br>通过 apache 的ab测试查看nginx对CPU的使用状况：</p><p><img src="/2018/03/02/nginx-fan-xiang-dai-li-huan-cun-fu-wu-bu-shu/%E5%9B%BE%E7%89%878.png" alt="image-20191118110749369"></p><p>如果多个CPU内核的利用率都相差不多，证明nginx己经成功的利用了多核CPU。<br>测试结束后，CPU内核的负载应该都同时降低。</p><p><strong>worker_connections4096</strong><br>写在events部分。每一个worker进程能并发处理（发起）的最大连接数（包含与客户端或后端被代理服务器间等所有连接数）。</p><p><strong>worker_rlimit_nofile 10240</strong><br>写在main部分。worker进程的最大打开文件数限制。默认是没有设置，如果没设置的话，这个值为操作系统的限制(ulimit -n)。可以限制为操作系统最大的限制65535。把这个值设高，这样nginx就不会有“too many open files”问题了。</p><p><strong>use epoll</strong><br>写在events部分。在Linux操作系统下，nginx默认使用epoll事件模型，得益于此，nginx在Linux操作系统下效率相当高。同时Nginx在OpenBSD或FreeBSD操作系统上采用类似于epoll的高效事件模型kqueue。</p><p>http服务器:<br>与提供http服务相关的一些配置参数。例如：是否使用keepalive啊，是否使用gzip进行压缩等。<br>sendfile on<br>开启高效文件传输模式。</p><p>keepalive_timeout 65 : 长连接超时时间，单位是秒，长连接请求大量小文件的时候，可以减少重建连接的开销，如果设置时间过长，用户又多，长时间保持连接会占用大量资源。<br>client_max_body_size 10m<br>允许客户端请求的最大单文件字节数。如果有上传较大文件，请设置它的限制值<br>client_body_buffer_size 128k<br>缓冲区代理缓冲用户端请求的最大字节数<br>server_tokens off;<br>隐藏nginx的版本号</p><h5 id="模块http-proxy"><a href="#模块http-proxy" class="headerlink" title="模块http_proxy"></a>模块http_proxy</h5><p>这个模块实现的是nginx作为反向代理服务器的功能，包括缓存功能<br><strong>proxy_connect_timeout</strong><br>nginx跟后端服务器连接超时时间(代理连接超时)</p><p><strong>proxy_read_timeout</strong><br>定义从后端服务器读取响应的超时。此超时是指相邻两次读操作之间的最长时间间隔，而不是整个响应传输完成的最长时间。如果后端服务器在超时时间段内没有传输任何数据，连接将被关闭。</p><p><strong>proxy_send_timeout</strong><br>定义向后端服务器传输请求的超时。此超时是指相邻两次写操作之间的最长时间间隔，而不是整个请求传输完成的最长时间。如果后端服务器在超时时间段内没有接收到任何数据，连接将被关闭。</p><p><strong>proxy_buffer_size</strong> 4k<br>设置缓冲区的大小为size。nginx从被代理的服务器读取响应时，使用该缓冲区保存响应的开始部分。这部分通常包含着一个小小的响应头。该缓冲区大小默认等于proxy_buffers指令设置的一块缓冲区的大小，但它也可以被设置得更小。</p><p><strong>proxy_buffers84k</strong><br>语法: proxy_buffersthe_numberis_size;<br>为每个连接设置缓冲区的数量为number，每块缓冲区的大小为size。这些缓冲区用于保存从被代理的服务器读取的响应。每块缓冲区默认等于一个内存页的大小。这个值是4K还是8K，取决于平台。<br><strong>附：</strong>查看Linux内存页大小</p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[<span class="symbol">root@</span>www ~]# getconf PAGESIZE</span><br><span class="line"><span class="number">4096</span></span><br><span class="line">或</span><br><span class="line">[<span class="symbol">root@</span>www ~]# getconf PAGE_SIZE</span><br><span class="line"><span class="number">4096</span></span><br></pre></td></tr></table></figure><p><strong>proxy_busy_buffers_size 64k</strong><br>高负荷下缓冲大小（默认大小是proxy_buffers指令设置单块缓冲大小的2倍）</p><p><strong>proxy_max_temp_file_size</strong><br>当proxy_buffers放不下后端服务器的响应内容时，会将一部分保存到硬盘的临时文件中，这个值用来设置最大临时文件大小，默认1024M。</p><p><strong>proxy_temp_file_write_size 64k</strong><br>当缓存被代理的服务器响应到临时文件时，这个选项限制每次写临时文件的大小。</p><h5 id="模块http-gzip"><a href="#模块http-gzip" class="headerlink" title="模块http_gzip"></a>模块http_gzip</h5><p><strong>gzip on</strong> : 开启gzip压缩输出，减少网络传输。</p><p><strong>gzip_min_length 1k</strong> ：设置允许压缩的页面最小字节数，页面字节数从header头得content-length中进行获取。建议设置成大于1k的字节数，小于1k可能会越压越大。</p><p><strong>gzip_buffers 4 16k</strong> ：设置系统获取几个单位的缓存用于存储gzip的压缩结果数据流。4 16k代表以16k为单位，按照原始数据大小以16k为单位的4倍申请内存。如果没有设置，默认值是申请跟原始数据相同大小的内存空间去存储gzip压缩结果</p><p><strong>gzip_http_version 1.1</strong> ：用于识别 http 协议的版本，早期的浏览器不支持Gzip压缩，用户就会看到乱码，所以为了支持前期版本加上了这个选项，如果你用了Nginx的反向代理并期望也启用Gzip压缩的话，由于末端通信是 http/1.1，故请设置为 1.1。</p><p><strong>gzip_comp_level 6</strong> ：gzip压缩比，1压缩比最小处理速度最快，9压缩比最大但处理速度最慢(传输快但比较消耗cpu)</p><p><strong>gzip_types</strong> ：匹配mime类型进行压缩，无论是否指定”text/html”类型总是会被压缩的。<br>默认值: gzip_types text/html (默认不对js/css文件进行压缩)</p><p>压缩类型，匹配MIME类型进行压缩</p><p>不能用通配符 text/*</p><p>(无论是否指定)text/html默认已经压缩</p><p>设置哪压缩种文本文件可参考conf/mime.types</p><p><strong>gzip_proxied any</strong> ：Nginx作为反向代理的时候启用，根据某些请求和应答来决定是否在对代理请求的应答启用gzip压缩，是否压缩取决于请求头中的“Via”字段，指令中可以同时指定多个不同的参数，意义如下：<br>off – 关闭所有的代理结果数据的压缩<br>expired – 启用压缩，如果header头中包含 “Expires” 头信息<br>no-cache – 启用压缩，如果header头中包含 “Cache-Control:no-cache” 头信息<br>no-store – 启用压缩，如果header头中包含 “Cache-Control:no-store” 头信息<br>private – 启用压缩，如果header头中包含 “Cache-Control:private” 头信息<br>no_last_modified – 启用压缩,如果header头中不包含 “Last-Modified” 头信息<br>no_etag – 启用压缩 ,如果header头中不包含 “ETag” 头信息<br>auth – 启用压缩 , 如果header头中包含 “Authorization” 头信息<br>any – 无条件启用压缩</p><p><strong>gzip_vary on</strong> ：和http头有关系，加个vary头，给代理服务器用的，有的浏览器支持压缩，有的不支持，所以避免浪费不支持的也压缩，所以根据客户端的HTTP头来判断，是否需要压缩</p><h5 id="模块http-stream："><a href="#模块http-stream：" class="headerlink" title="模块http_stream："></a>模块http_stream：</h5><p>这个模块通过一个简单的调度算法来实现客户端IP到后端服务器的负载均衡，upstream后接负载均衡器的名字，后端realserver以 host:port options; 方式组织在 {} 中。如果后端被代理的只有一台，也可以直接写在proxy_pass。</p><p>Location:<br>root /var/www/html<br>定义服务器的默认网站根目录位置。如果locationURL匹配的是子目录或文件，root没什么作用，一般放在server指令里面或/下。</p><p>indexindex.jsp index.html index.htm<br>定义路径下默认访问的文件名，一般跟着root放</p><p>proxy_pass http:/backend<br>请求转向backend定义的服务器列表，即反向代理，对应upstream负载均衡器。也可以proxy_pass<a href="http://ip:port" target="_blank" rel="noopener">http://ip:port</a> 。</p><p>proxy_redirect off;<br>指定是否修改被代理服务器返回的响应头中的location头域跟refresh头域数值<br>例如：<br>设置后端服务器“Location”响应头和“Refresh”响应头的替换文本。假设后端服务器返回的响应头是 “Location: <a href="http://localhost:8000/two/some/uri/" target="_blank" rel="noopener">http://localhost:8000/two/some/uri/</a> ”，那么指令<br>proxy_redirect <a href="http://localhost:8000/two/" target="_blank" rel="noopener">http://localhost:8000/two/</a> <a href="http://frontend/one/" target="_blank" rel="noopener">http://frontend/one/</a> ;<br>将把字符串改写为 “Location: <a href="http://frontend/one/some/uri/" target="_blank" rel="noopener">http://frontend/one/some/uri/</a> ”。</p><p>proxy_set_header Host $host;<br>允许重新定义或者添加发往后端服务器的请求头。<br>Host的含义是表明请求的主机名，nginx反向代理服务器会向后端真实服务器发送请求，并且请求头中的host字段重写为proxy_pass指令设置的服务器。因为nginx作为反向代理使用，而如果后端真实的服务器设置有类似防盗链或者根据http请求头中的host字段来进行路由或判断功能的话，如果反向代理层的nginx不重写请求头中的host字段，将会导致请求失败。</p><p>proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;<br>后端的Web服务器可以通过X-Forwarded-For获取用户真实IP<br>X_Forward_For字段表示该条http请求是有谁发起的？如果反向代理服务器不重写该请求头的话，那么后端真实服务器在处理时会认为所有的请求都来自反向代理服务器，如果后端有防攻击策略的话，那么机器就被封掉了。因此，在配置用作反向代理的nginx中一般会增加两条配置，修改http的请求头：<br>proxy_set_header Host $host;<br>proxy_set_header X-Forward-For $remote_addr;</p><p>proxy_next_upstreamerror timeout invalid_header http_500 http_502 http_503 http_504;<br>增加故障转移，如果后端的服务器返回502、504、执行超时等错误，自动将请求转发到upstream负载均衡池中的另一台服务器，实现故障转移。</p><p>proxy_set_header X-Real-IP $remote_addr;<br>web服务器端获得用户的真实ip但是，实际上要获得用户的真实ip，也可以通过X-Forward-For</p><h3 id="3-8-验证"><a href="#3-8-验证" class="headerlink" title="3.8 验证"></a>3.8 验证</h3><h4 id="3-8-1-下面我们来测试一下缓存功能"><a href="#3-8-1-下面我们来测试一下缓存功能" class="headerlink" title="3.8.1 下面我们来测试一下缓存功能"></a>3.8.1 下面我们来测试一下缓存功能</h4><p>如果在缓存时间之内需要更新被缓存的静态文件怎么办呢，这时候就需要手动来清除缓存了。<br>ngx_cache_pure清除缓存模块使用说明<br>用谷歌浏览器测试的时候，可以按F12调用开发工具，选择Network选项，我们可以看到，Response Headers，在这里我们可以看到，我们请求的是否是缓存</p><p><img src="/2018/03/02/nginx-fan-xiang-dai-li-huan-cun-fu-wu-bu-shu/%E5%9B%BE%E7%89%879.png" alt="image-20191118111134848"></p><p>从图中我们可以看到，我们访问的服务器是192.168.31.83，缓存命中。</p><p>也可以查看缓存目录或nginx的访问日志</p><p><strong>清除缓存:</strong><br>上述配置的proxy_cache_purge指令用于方便的清除缓存，但必须按照第三方的ngx_cache_purge模块才能使用<br>使用ngx_cache_purge模块清除缓存（直接删除缓存目录下的文件也算一种办法）：<br>GET方式请求URL<br>即使用配置文件中的location ~ /purge(/.*)<br>浏览器访问 <a href="http://192.168.31.83/purge/your/may/path" target="_blank" rel="noopener">http://192.168.31.83/purge/your/may/path</a> 来清除缓存</p><p><img src="/2018/03/02/nginx-fan-xiang-dai-li-huan-cun-fu-wu-bu-shu/%E5%9B%BE%E7%89%8710.png" alt="image-20191118111203818"></p><p>缓存清除成功。<br><strong>备注：</strong></p><ol><li>purge是ngx_cache_pure模块指令</li><li>your/may/path是要清除的缓存文件URL路径</li></ol><h4 id="3-8-2-若只有一台客户端要验证负载均衡和健康检查可以先关掉缓存功能和保持session会话"><a href="#3-8-2-若只有一台客户端要验证负载均衡和健康检查可以先关掉缓存功能和保持session会话" class="headerlink" title="3.8.2 若只有一台客户端要验证负载均衡和健康检查可以先关掉缓存功能和保持session会话"></a>3.8.2 若只有一台客户端要验证负载均衡和健康检查可以先关掉缓存功能和保持session会话</h4><figure class="highlight vala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># proxy_buffering off;</span></span><br><span class="line"><span class="meta"># sticky</span></span><br></pre></td></tr></table></figure><p>测试过程略</p><p><strong>扩展知识：</strong><br>nginx修改版本等信息</p><ol><li>vi /usr/local/src/nginx-1.0.12/src/core/nginx.h #编译前编辑<br>#define nginx_version<br>#define NGINX_VERSION<br>#define NGINX_VER<br>#define NGINX_VAR<br>修改上面的信息，即可更改nginx显示版本。</li><li>vi /usr/local/src/nginx-1.0.12/src/http/ngx_http_special_response.c #编译前编辑<br>static u_charngx_http_error_full_tail[] =<br>static u_charngx_http_error_tail[] =<br>修改上面的信息为你自己的。</li><li>vi /usr/local/src/nginx-1.0.12/src/http/ngx_http_header_filter_module.c #编译前编辑<br>static char ngx_http_server_string[]=<br>修改上面的信息为你自己的。</li><li>编译完成之后，修改/usr/local/nginx/conf目录下面<br>fastcgi.conf、fastcgi.conf.default、fastcgi_params、fastcgi_params.default<br>这四个文件里面的版本名称<br>/usr/local/nginx/sbin/nginx -V #查看nginx版本号</li></ol></div><div><div><div style="text-align:center;color:#ccc;font-size:14px">-------------本文结束<i class="fa fa-paw"></i>感谢您的阅读-------------</div></div></div><div></div><footer class="post-footer"><div class="post-tags"><a href="/tags/Nginx/" rel="tag"><i class="fa fa-tag"></i> Nginx</a></div><div class="post-nav"><div class="post-nav-next post-nav-item"><a href="/2018/02/03/elasticsearch-ji-qun-yellow-he-red-zhuang-tai-chu-li/" rel="next" title="Elasticsearch集群yellow和red状态处理"><i class="fa fa-chevron-left"></i> Elasticsearch集群yellow和red状态处理</a></div><span class="post-nav-divider"></span><div class="post-nav-prev post-nav-item"><a href="/2018/03/11/nginx-shi-yong-htpasswd-wei-wang-zhan-ti-gong-yong-hu-mi-ma-fang-wen/" rel="prev" title="Nginx 使用htpasswd为网站提供用户密码访问">Nginx 使用htpasswd为网站提供用户密码访问 <i class="fa fa-chevron-right"></i></a></div></div></footer></div></article><div class="post-spread"><div class="jiathis_style"><span class="jiathis_txt">分享到：</span> <a class="jiathis_button_fav">收藏夹</a> <a class="jiathis_button_copy">复制网址</a> <a class="jiathis_button_email">邮件</a> <a class="jiathis_button_weixin">微信</a> <a class="jiathis_button_qzone">QQ空间</a> <a class="jiathis_button_tqq">腾讯微博</a> <a class="jiathis_button_douban">豆瓣</a> <a class="jiathis_button_share">一键分享</a> <a href="http://www.jiathis.com/share?uid=2140465" class="jiathis jiathis_txt jiathis_separator jtico jtico_jiathis" target="_blank">更多</a> <a class="jiathis_counter_style"></a></div><script type="text/javascript">var jiathis_config={data_track_clickback:!0,summary:"",shortUrl:!1,hideMore:!1}</script><script type="text/javascript" src="http://v3.jiathis.com/code/jia.js?uid=" charset="utf-8"></script></div></div></div></div><div class="sidebar-toggle"><div class="sidebar-toggle-line-wrap"><span class="sidebar-toggle-line sidebar-toggle-line-first"></span> <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span> <span class="sidebar-toggle-line sidebar-toggle-line-last"></span></div></div><aside id="sidebar" class="sidebar"><div id="sidebar-dimmer"></div><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">文章目录</li><li class="sidebar-nav-overview" data-target="site-overview-wrap">站点概览</li></ul><section class="site-overview-wrap sidebar-panel"><div class="site-overview"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="site-author-image" itemprop="image" src="/images/chen.png" alt="Zhongzhou Chen"><p class="site-author-name" itemprop="name">Zhongzhou Chen</p><p class="site-description motion-element" itemprop="description"></p></div><nav class="site-state motion-element"><div class="site-state-item site-state-posts"><a href="/archives/%7C%7C%20archive"><span class="site-state-item-count">283</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"><a href="/categories/index.html"><span class="site-state-item-count">84</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"><a href="/tags/index.html"><span class="site-state-item-count">164</span> <span class="site-state-item-name">标签</span></a></div></nav><div class="feed-link motion-element"><a href="/atom.xml" rel="alternate"><i class="fa fa-rss"></i> RSS</a></div></div></section><section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active"><div class="post-toc"><div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#1、代理服务简介"><span class="nav-text">1、代理服务简介</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#nginx反向代理"><span class="nav-text">nginx反向代理</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2、什么是nginx"><span class="nav-text">2、什么是nginx</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#nginx简介"><span class="nav-text">nginx简介</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Nginx的核心特点"><span class="nav-text">Nginx的核心特点</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3、Nginx-apache构筑Web服务器集群的负载均衡"><span class="nav-text">3、Nginx+apache构筑Web服务器集群的负载均衡</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#3-1-部署-nginx"><span class="nav-text">3.1 部署 nginx</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-2-编写nginx服务脚本"><span class="nav-text">3.2 编写nginx服务脚本</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-3-配置nginx反向代理"><span class="nav-text">3.3 配置nginx反向代理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-4-nginx-sticky-module模块"><span class="nav-text">3.4 nginx-sticky-module模块</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-5-load-balance其它调度方案"><span class="nav-text">3.5 load-balance其它调度方案</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-6-负载均衡与健康检查"><span class="nav-text">3.6 负载均衡与健康检查</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-7-nginx的proxy缓存使用"><span class="nav-text">3.7 nginx的proxy缓存使用</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#常用指令说明"><span class="nav-text">常用指令说明:</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#main全局配置"><span class="nav-text">main全局配置:</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#模块http-proxy"><span class="nav-text">模块http_proxy</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#模块http-gzip"><span class="nav-text">模块http_gzip</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#模块http-stream："><span class="nav-text">模块http_stream：</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-8-验证"><span class="nav-text">3.8 验证</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#3-8-1-下面我们来测试一下缓存功能"><span class="nav-text">3.8.1 下面我们来测试一下缓存功能</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-8-2-若只有一台客户端要验证负载均衡和健康检查可以先关掉缓存功能和保持session会话"><span class="nav-text">3.8.2 若只有一台客户端要验证负载均衡和健康检查可以先关掉缓存功能和保持session会话</span></a></li></ol></li></ol></li></ol></div></div></section><div class="back-to-top"><i class="fa fa-arrow-up"></i> <span id="scrollpercent"><span>0</span>%</span></div></div></aside></div></main><footer id="footer" class="footer"><div class="footer-inner"><script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script><div class="copyright">&copy; <span itemprop="copyrightYear">2021</span> <span class="with-love"><i class="fa fa-user"></i> </span><span class="author" itemprop="copyrightHolder">Zhongzhou Chen</span> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-area-chart"></i> </span><span class="post-meta-item-text">Site words total count&#58;</span> <span title="Site words total count">597.5k</span></div><span class="post-meta-divider"></span></div></footer></div><script type="text/javascript">"[object Function]"!==Object.prototype.toString.call(window.Promise)&&(window.Promise=null)</script><script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script><script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script><script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script><script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script><script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script><script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script><script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script><script type="text/javascript">function proceedsearch(){$("body").append('<div class="search-popup-overlay local-search-pop-overlay"></div>').css("overflow","hidden"),$(".search-popup-overlay").click(onPopupClose),$(".popup").toggle();var t=$("#local-search-input");t.attr("autocapitalize","none"),t.attr("autocorrect","off"),t.focus()}var isfetched=!1,isXml=!0,search_path="search.xml";0===search_path.length?search_path="search.xml":/json$/i.test(search_path)&&(isXml=!1);var path="/"+search_path,onPopupClose=function(t){$(".popup").hide(),$("#local-search-input").val(""),$(".search-result-list").remove(),$("#no-result").remove(),$(".local-search-pop-overlay").remove(),$("body").css("overflow","")},searchFunc=function(t,e,o){"use strict";$("body").append('<div class="search-popup-overlay local-search-pop-overlay"><div id="search-loading-icon"><i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i></div></div>').css("overflow","hidden"),$("#search-loading-icon").css("margin","20% auto 0 auto").css("text-align","center"),$.ajax({url:t,dataType:isXml?"xml":"json",async:!0,success:function(t){isfetched=!0,$(".popup").detach().appendTo(".header-inner");var n=isXml?$("entry",t).map(function(){return{title:$("title",this).text(),content:$("content",this).text(),url:$("url",this).text()}}).get():t,r=document.getElementById(e),s=document.getElementById(o),a=function(){var t=r.value.trim().toLowerCase(),e=t.split(/[\s\-]+/);e.length>1&&e.push(t);var o=[];if(t.length>0&&n.forEach(function(n){function r(e,o,n,r){for(var s=r[r.length-1],a=s.position,i=s.word,l=[],h=0;a+i.length<=n&&0!=r.length;){i===t&&h++,l.push({position:a,length:i.length});var p=a+i.length;for(r.pop();0!=r.length&&(s=r[r.length-1],a=s.position,i=s.word,p>a);)r.pop()}return c+=h,{hits:l,start:o,end:n,searchTextCount:h}}function s(t,e){var o="",n=e.start;return e.hits.forEach(function(e){o+=t.substring(n,e.position);var r=e.position+e.length;o+='<b class="search-keyword">'+t.substring(e.position,r)+"</b>",n=r}),o+=t.substring(n,e.end)}var a=!1,i=0,c=0,l=n.title.trim(),h=l.toLowerCase(),p=n.content.trim().replace(/<[^>]+>/g,""),u=p.toLowerCase(),f=decodeURIComponent(n.url),d=[],g=[];if(""!=l&&(e.forEach(function(t){function e(t,e,o){var n=t.length;if(0===n)return[];var r=0,s=[],a=[];for(o||(e=e.toLowerCase(),t=t.toLowerCase());(s=e.indexOf(t,r))>-1;)a.push({position:s,word:t}),r=s+n;return a}d=d.concat(e(t,h,!1)),g=g.concat(e(t,u,!1))}),(d.length>0||g.length>0)&&(a=!0,i=d.length+g.length)),a){[d,g].forEach(function(t){t.sort(function(t,e){return e.position!==t.position?e.position-t.position:t.word.length-e.word.length})});var v=[];0!=d.length&&v.push(r(l,0,l.length,d));for(var $=[];0!=g.length;){var C=g[g.length-1],m=C.position,x=C.word,w=m-20,y=m+80;0>w&&(w=0),y<m+x.length&&(y=m+x.length),y>p.length&&(y=p.length),$.push(r(p,w,y,g))}$.sort(function(t,e){return t.searchTextCount!==e.searchTextCount?e.searchTextCount-t.searchTextCount:t.hits.length!==e.hits.length?e.hits.length-t.hits.length:t.start-e.start});var T=parseInt("1");T>=0&&($=$.slice(0,T));var b="";b+=0!=v.length?"<li><a href='"+f+"' class='search-result-title'>"+s(l,v[0])+"</a>":"<li><a href='"+f+"' class='search-result-title'>"+l+"</a>",$.forEach(function(t){b+="<a href='"+f+'\'><p class="search-result">'+s(p,t)+"...</p></a>"}),b+="</li>",o.push({item:b,searchTextCount:c,hitCount:i,id:o.length})}}),1===e.length&&""===e[0])s.innerHTML='<div id="no-result"><i class="fa fa-search fa-5x" /></div>';else if(0===o.length)s.innerHTML='<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>';else{o.sort(function(t,e){return t.searchTextCount!==e.searchTextCount?e.searchTextCount-t.searchTextCount:t.hitCount!==e.hitCount?e.hitCount-t.hitCount:e.id-t.id});var a='<ul class="search-result-list">';o.forEach(function(t){a+=t.item}),a+="</ul>",s.innerHTML=a}};r.addEventListener("input",a),$(".local-search-pop-overlay").remove(),$("body").css("overflow",""),proceedsearch()}})};$(".popup-trigger").click(function(t){t.stopPropagation(),isfetched===!1?searchFunc(path,"local-search-input","local-search-result"):proceedsearch()}),$(".popup-btn-close").click(onPopupClose),$(".popup").click(function(t){t.stopPropagation()}),$(document).on("keyup",function(t){var e=27===t.which&&$(".search-popup").is(":visible");e&&onPopupClose()})</script><script type="text/javascript" src="/js/src/clipboard.min.js"></script><script type="text/javascript" src="/js/src/clipboard-use.js"></script><script type="text/javascript" src="/js/src/love.js"></script><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({pluginRootPath:"live2dw/",pluginJsPath:"lib/",pluginModelPath:"assets/",tagMode:!1,log:!1,model:{jsonPath:"/live2dw/assets/shizuku.model.json"},display:{position:"right"},mobile:{show:!0,scale:.5},react:{opacityDefault:.7,opacityOnHover:.2}})</script></body></html><!-- rebuild by neat -->