<!-- build time:Tue Sep 14 2021 14:49:28 GMT+0800 (GMT+08:00) --><!DOCTYPE html><html class="theme-next gemini use-motion" lang="zh-Hans"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><script src="//cdn.bootcss.com/pace/1.0.2/pace.min.js"></script><link href="//cdn.bootcss.com/pace/1.0.2/themes/pink/pace-theme-flash.css" rel="stylesheet"><script></script><meta name="theme-color" content="#222"><style>.pace .pace-progress{background:#1E92FB;height:3px}.pace .pace-progress-inner{box-shadow:0 0 10px #1E92FB,0 0 5px #1E92FB}.pace .pace-activity{border-top-color:#1E92FB;border-left-color:#1E92FB}</style><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><meta name="google-site-verification" content="HGM141IpbHrSmnAmR6W_zE4bo9Z3f-yXLeHYT3bg1fk"><meta name="baidu-site-verification" content="code-5Ai1DA8e6T"><link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css"><link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css"><link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4"><link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222"><meta name="keywords" content="Nginx,"><link rel="alternate" href="/atom.xml" title="凡间的精灵" type="application/atom+xml"><meta name="description" content="1、nginx 简介Nginx是俄罗斯人编写的十分轻量级的HTTP服务器,Nginx，它的发音为“engine X”，是一个高性能的HTTP和反向代理服务器，同时也是一个IMAP&#x2F;POP3&#x2F;SMTP 代理服务器．Nginx是由俄罗斯人 Igor Sysoev为俄罗斯访问量第二的 Rambler.ru站点开发.Nginx以事件驱动（epoll）的方式编写，所以有非常好的性能，同时也是一个非常高效的反"><meta name="keywords" content="Nginx"><meta property="og:type" content="article"><meta property="og:title" content="Nginx 优化与防盗链"><meta property="og:url" content="http:&#x2F;&#x2F;chenzhonzhou.github.io&#x2F;2018&#x2F;03&#x2F;11&#x2F;nginx-you-hua-yu-fang-dao-lian&#x2F;index.html"><meta property="og:site_name" content="凡间的精灵"><meta property="og:description" content="1、nginx 简介Nginx是俄罗斯人编写的十分轻量级的HTTP服务器,Nginx，它的发音为“engine X”，是一个高性能的HTTP和反向代理服务器，同时也是一个IMAP&#x2F;POP3&#x2F;SMTP 代理服务器．Nginx是由俄罗斯人 Igor Sysoev为俄罗斯访问量第二的 Rambler.ru站点开发.Nginx以事件驱动（epoll）的方式编写，所以有非常好的性能，同时也是一个非常高效的反"><meta property="og:locale" content="zh-Hans"><meta property="og:image" content="http:&#x2F;&#x2F;chenzhonzhou.github.io&#x2F;2018&#x2F;03&#x2F;11&#x2F;nginx-you-hua-yu-fang-dao-lian&#x2F;%E5%9B%BE%E7%89%871.png"><meta property="og:image" content="http:&#x2F;&#x2F;chenzhonzhou.github.io&#x2F;2018&#x2F;03&#x2F;11&#x2F;nginx-you-hua-yu-fang-dao-lian&#x2F;%E5%9B%BE%E7%89%872.png"><meta property="og:image" content="http:&#x2F;&#x2F;chenzhonzhou.github.io&#x2F;2018&#x2F;03&#x2F;11&#x2F;nginx-you-hua-yu-fang-dao-lian&#x2F;%E5%9B%BE%E7%89%873.png"><meta property="og:image" content="http:&#x2F;&#x2F;chenzhonzhou.github.io&#x2F;2018&#x2F;03&#x2F;11&#x2F;nginx-you-hua-yu-fang-dao-lian&#x2F;%E5%9B%BE%E7%89%874.png"><meta property="og:image" content="http:&#x2F;&#x2F;chenzhonzhou.github.io&#x2F;2018&#x2F;03&#x2F;11&#x2F;nginx-you-hua-yu-fang-dao-lian&#x2F;%E5%9B%BE%E7%89%875.png"><meta property="og:updated_time" content="2019-11-18T06:33:56.664Z"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="http:&#x2F;&#x2F;chenzhonzhou.github.io&#x2F;2018&#x2F;03&#x2F;11&#x2F;nginx-you-hua-yu-fang-dao-lian&#x2F;%E5%9B%BE%E7%89%871.png"><script type="text/javascript" id="hexo.configurations">var NexT=window.NexT||{},CONFIG={root:"/",scheme:"Gemini",version:"5.1.4",sidebar:{position:"left",display:"always",offset:12,b2t:!0,scrollpercent:!0,onmobile:!0},fancybox:!0,tabs:!0,motion:{enable:!0,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}},duoshuo:{userId:"0",author:"博主"},algolia:{applicationID:"",apiKey:"",indexName:"",hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}}}</script><link rel="canonical" href="http://chenzhonzhou.github.io/2018/03/11/nginx-you-hua-yu-fang-dao-lian/"><title>Nginx 优化与防盗链 | 凡间的精灵</title><link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css"></head><body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans"><div class="container sidebar-position-left page-post-detail"><div class="headband"></div><header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-wrapper"><div class="site-meta"><div class="custom-logo-site-title"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">凡间的精灵</span> <span class="logo-line-after"><i></i></span></a></div><p class="site-subtitle">凡尘落素一精灵</p></div><div class="site-nav-toggle"><button><span class="btn-bar"></span> <span class="btn-bar"></span> <span class="btn-bar"></span></button></div></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i><br>首页</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i><br>归档</a></li><li class="menu-item menu-item-categories"><a href="/categories" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i><br>分类</a></li><li class="menu-item menu-item-tags"><a href="/tags" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i><br>标签</a></li><li class="menu-item menu-item-sitemap"><a href="/sitemap.xml" rel="section"><i class="menu-item-icon fa fa-fw fa-sitemap"></i><br>站点地图</a></li><li class="menu-item menu-item-search"><a href="javascript:;" class="popup-trigger"><i class="menu-item-icon fa fa-search fa-fw"></i><br>搜索</a></li></ul><div class="site-search"><div class="popup search-popup local-search-popup"><div class="local-search-header clearfix"><span class="search-icon"><i class="fa fa-search"></i> </span><span class="popup-btn-close"><i class="fa fa-times-circle"></i></span><div class="local-search-input-wrapper"><input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input"></div></div><div id="local-search-result"></div></div></div></nav></div></header><main id="main" class="main"><div class="main-inner"><div class="content-wrap"><div id="content" class="content"><div id="posts" class="posts-expand"><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><div class="post-block"><link itemprop="mainEntityOfPage" href="http://chenzhonzhou.github.io/2018/03/11/nginx-you-hua-yu-fang-dao-lian/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="name" content="Zhongzhou Chen"><meta itemprop="description" content=""><meta itemprop="image" content="/images/chen.png"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="凡间的精灵"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">Nginx 优化与防盗链</h1><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-03-11T16:11:59+08:00">2018-03-11 </time></span><span class="post-category"><span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-folder-o"></i> </span><span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Nginx/" itemprop="url" rel="index"><span itemprop="name">Nginx</span></a></span></span><div class="post-wordcount"><span class="post-meta-item-icon"><i class="fa fa-file-word-o"></i> </span><span class="post-meta-item-text">字数统计&#58;</span> <span title="字数统计">7.8k </span><span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-clock-o"></i> </span><span class="post-meta-item-text">阅读时长 &asymp;</span> <span title="阅读时长">34</span></div></div></header><div class="post-body" itemprop="articleBody"><h2 id="1、nginx-简介"><a href="#1、nginx-简介" class="headerlink" title="1、nginx 简介"></a>1、nginx 简介</h2><p><strong>Nginx</strong>是俄罗斯人编写的十分轻量级的<strong>HTTP</strong>服务器,<strong>Nginx</strong>，它的发音为“<strong>engine X</strong>”，是一个高性能的<strong>HTTP</strong>和反向代理服务器，同时也是一个<strong>IMAP/POP3/SMTP</strong> 代理服务器．<strong>Nginx</strong>是由俄罗斯人 <strong>Igor Sysoev</strong>为俄罗斯访问量第二的 <strong>Rambler.ru</strong>站点开发.</p><p><strong>Nginx</strong>以事件驱动（<strong>epoll</strong>）的方式编写，所以有非常好的性能，同时也是一个非常高效的反向代理、负载平衡。但是<strong>Nginx</strong>并不支持<strong>cgi</strong>方式运行，原因是可以减少因此带来的一些程序上的漏洞。所以必须使用<strong>FastCGI</strong>方式来执行<strong>PHP</strong>程序。</p><p>由于<strong>Nginx</strong>本身的一些优点，轻量，开源，易用，越来越多的公司使用<strong>nginx</strong>作为自己公司的<strong>web</strong>应用服务器，本文详细介绍<strong>nginx</strong>源码安装的同时并对<strong>nginx</strong>进行优化配置。</p><h2 id="2、Nginx-的优化"><a href="#2、Nginx-的优化" class="headerlink" title="2、Nginx 的优化"></a>2、Nginx 的优化</h2><h3 id="2-1-编译安装前优化"><a href="#2-1-编译安装前优化" class="headerlink" title="2.1 编译安装前优化"></a>2.1 编译安装前优化</h3><p>编译前的优化主要是用来修改程序名等等，目的更改源码隐藏软件名称和版本号<br>安装<strong>zlib-devel</strong>、<strong>pcre-devel</strong>等依赖包</p><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="symbol">@www</span> ~]<span class="meta"># yum -y install gcc gcc-c++ make libtool zlib zlib-devel pcre pcre-devel openssl openssl-devel</span></span><br></pre></td></tr></table></figure><p><strong>下载nginx的源码包：</strong><a href="http://nginx.org/download" target="_blank" rel="noopener">http://nginx.org/download</a></p><p><strong>解压源码包</strong></p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[<span class="symbol">root@</span>www ~]# tar zxf nginx<span class="number">-1.10</span><span class="number">.2</span>.tar.gz</span><br><span class="line">[<span class="symbol">root@</span>www ~]# cd nginx<span class="number">-1.10</span><span class="number">.2</span>/</span><br></pre></td></tr></table></figure><h4 id="隐藏软件名称和版本号"><a href="#隐藏软件名称和版本号" class="headerlink" title="隐藏软件名称和版本号"></a><strong>隐藏软件名称和版本号</strong></h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@www nginx<span class="number">-1.10</span><span class="number">.2</span>]<span class="meta"># vim src/core/nginx.h</span></span><br><span class="line"><span class="comment">//此行修改的是你想要的版本</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NGINX_VERSION      <span class="meta-string">"1.10.2"</span>     <span class="comment">//第13行</span></span></span><br><span class="line"><span class="comment">//此行修改的是你想修改的软件名称</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NGINX_VER          <span class="meta-string">"nginx/"</span> NGINX_VERSION  <span class="comment">//第14行</span></span></span><br><span class="line">修改上面的信息，即可更改nginx显示版本。例如：</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NGINX_VERSION      <span class="meta-string">"7.0"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NGINX_VER          <span class="meta-string">"IIS/"</span> NGINX_VERSION</span></span><br></pre></td></tr></table></figure><p>修改HTTP头信息中的<strong>connection</strong>字段，防止回显具体版本号</p><p><strong>拓展：</strong>通用http头，通用头包含请求和响应消息都支持的头，通用头包含Cache-Control、 Connection、Date、Pragma、Transfer-Encoding、Upgrade、Via。对通用头的扩展要求通讯双方都支持此扩展，如果存在不支持的通用头，一般将会作为实体头处理。那么也就是说有部分设备，或者是软件，能获取到connection，部分不能，要隐藏就要彻底！</p><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">root@www nginx-1.10.2</span>]<span class="meta"># vi src/http/ngx_http_header_filter_module.c</span></span><br><span class="line">修改前：</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">char</span> ngx_http_server_string[] = <span class="string">"Server: nginx"</span> CRLF;  <span class="comment">//第49行</span></span><br><span class="line"></span><br><span class="line">修改后：</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">char</span> ngx_http_server_string[] = <span class="string">"Server: IIS"</span> CRLF;</span><br></pre></td></tr></table></figure><p>定义了http错误码的返回<br>有时候我们页面程序出现错误，Nginx会代我们返回相应的错误代码，回显的时候，会带上nginx和版本号，我们把他隐藏起来</p><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">root@www nginx-1.10.2</span>]<span class="meta"># vi src/http/ngx_http_special_response.c</span></span><br><span class="line">修改前</span><br><span class="line"><span class="keyword">static</span> u_char ngx_http_error_tail[] =     <span class="comment">//第29行</span></span><br><span class="line"><span class="string">"&lt;hr&gt;&lt;center&gt;nginx&lt;/center&gt;"</span> CRLF</span><br><span class="line"><span class="string">"&lt;/body&gt;"</span> CRLF</span><br><span class="line"><span class="string">"&lt;/html&gt;"</span> CRLF</span><br><span class="line">;</span><br><span class="line"></span><br><span class="line">修改后</span><br><span class="line"><span class="keyword">static</span> u_char ngx_http_error_tail[] =</span><br><span class="line"><span class="string">"&lt;hr&gt;&lt;center&gt;IIS&lt;/center&gt;"</span> CRLF</span><br><span class="line"><span class="string">"&lt;/body&gt;"</span> CRLF</span><br><span class="line"><span class="string">"&lt;/html&gt;"</span> CRLF</span><br><span class="line">;</span><br></pre></td></tr></table></figure><h3 id="2-2-安装ngnix"><a href="#2-2-安装ngnix" class="headerlink" title="2.2 安装ngnix"></a>2.2 安装ngnix</h3><figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@www ~]# groupadd www   #添加www组</span><br><span class="line">[root@www ~]# useradd -g www www -s /sbin/nologin  #创建nginx运行账户www并加入到www组，不允许www用户直接登录系统</span><br><span class="line">[root@www nginx<span class="number">-1.10</span><span class="number">.2</span>]# ./configure --prefix=/usr/local/nginx1<span class="number">.10</span> --<span class="keyword">with</span>-http_dav_module --<span class="keyword">with</span>-http_stub_status_module --<span class="keyword">with</span>-http_addition_module --<span class="keyword">with</span>-http_sub_module --<span class="keyword">with</span>-http_flv_module --<span class="keyword">with</span>-http_mp4_module --<span class="keyword">with</span>-pcre --<span class="keyword">with</span>-http_ssl_module --<span class="keyword">with</span>-http_gzip_static_module --user=www --group=www</span><br><span class="line">[root@www nginx<span class="number">-1.10</span><span class="number">.2</span>]# make &amp;&amp; make install</span><br></pre></td></tr></table></figure><p><strong>相关选项说明</strong></p><table><thead><tr><th>选项</th><th>描述</th></tr></thead><tbody><tr><td>–with-http_dav_module</td><td>增加PUT,DELETE,MKCOL：创建集合，COPY和MOVE方法</td></tr><tr><td>–with-http_stub_status_module</td><td>获取Nginx的状态统计信息</td></tr><tr><td>–with-http_addition_module</td><td>作为一个输出过滤器，支持不完全缓冲，分部分相应请求</td></tr><tr><td>–with-http_sub_module</td><td>允许一些其他文本替换Nginx相应中的一些文本</td></tr><tr><td>–with-http_flv_module</td><td>提供支持flv视频文件支持</td></tr><tr><td>–with-http_mp4_module</td><td>提供支持mp4视频文件支持，提供伪流媒体服务端支持</td></tr><tr><td>–with-http_ssl_module</td><td>启用ngx_http_ssl_module</td></tr></tbody></table><p>如果pcre是通过编译安装的话，例如</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">tar zxvf <span class="regexp">/usr/</span>local<span class="regexp">/src/</span>pcre-<span class="number">8.36</span>.tar.gz -C <span class="regexp">/usr/</span>local<span class="regexp">/src/</span></span><br><span class="line">cd  <span class="regexp">/usr/</span>local<span class="regexp">/src/</span>pcre-<span class="number">8.36</span></span><br><span class="line">.<span class="regexp">/configure &amp;&amp;　make &amp;&amp; make install</span></span><br></pre></td></tr></table></figure><p>则–with-pcre=/usr/local/src/pcre-8.36 #需要注意，这里指的是源码,用#./configure –help |grep pcre查看帮助</p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[<span class="symbol">root@</span>www nginx<span class="number">-1.10</span><span class="number">.2</span>]# ln -s /usr/local/nginx1<span class="number">.10</span>/sbin/nginx /usr/local/sbin/</span><br><span class="line">[<span class="symbol">root@</span>www nginx<span class="number">-1.10</span><span class="number">.2</span>]# nginx -t</span><br></pre></td></tr></table></figure><p><strong>启动nginx</strong></p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[<span class="symbol">root@</span>www nginx<span class="number">-1.10</span><span class="number">.2</span>]# nginx</span><br><span class="line">[<span class="symbol">root@</span>www nginx<span class="number">-1.10</span><span class="number">.2</span>]# netstat -anpt | grep nginx</span><br><span class="line">tcp   <span class="number">0</span>   <span class="number">0</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>:<span class="number">80</span>     <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>:*    LISTEN      <span class="number">9834</span>/nginx: master</span><br></pre></td></tr></table></figure><h4 id="测试是否隐藏了版本和软件名"><a href="#测试是否隐藏了版本和软件名" class="headerlink" title="测试是否隐藏了版本和软件名"></a><strong>测试是否隐藏了版本和软件名</strong></h4><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[<span class="symbol">root@</span>www ~]# curl -I http:<span class="comment">//127.0.0.1</span></span><br><span class="line">HTTP/<span class="number">1.1</span> <span class="number">200</span> OK</span><br><span class="line">Server: IIS/<span class="number">7.0</span></span><br><span class="line">Date: Sat, <span class="number">05</span> Nov <span class="number">2016</span> <span class="number">14</span>:<span class="number">38</span>:<span class="number">21</span> GMT</span><br><span class="line">Content-Type: text/html</span><br><span class="line">Content-Length: <span class="number">612</span></span><br><span class="line">Last-Modified: Sat, <span class="number">05</span> Nov <span class="number">2016</span> <span class="number">14</span>:<span class="number">19</span>:<span class="number">47</span> GMT</span><br><span class="line">Connection: keep-alive</span><br><span class="line">ETag: <span class="string">"581dea83-264"</span></span><br><span class="line">Accept-Ranges: bytes</span><br></pre></td></tr></table></figure><h3 id="2-3-nginx配置项优化"><a href="#2-3-nginx配置项优化" class="headerlink" title="2.3 nginx配置项优化"></a>2.3 nginx配置项优化</h3><blockquote><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="symbol">@www</span> ~]<span class="meta"># ps -ef | grep nginx</span></span><br></pre></td></tr></table></figure><p><font color="red">root</font> 9834 1 0 22:36 ? 00:00:00 nginx: <font color="red">master process nginx</font><br><font color="red">www</font> 9953 9834 0 22:43 ? 00:00:00 <font color="red">nginx: worker process</font></p></blockquote><p>在这里我们还可以看到在查看的时候，work进程是nginx程序用户，但是master进程还是root，其中，master是监控进程，也叫主进程，work是工作进程，部分还有cache相关进程，关系如图：</p><p><img src="/2018/03/11/nginx-you-hua-yu-fang-dao-lian/%E5%9B%BE%E7%89%871.png" alt></p><p>可以直接理解为master是管理员，work进程才是为用户提供服务的！</p><h4 id="2-3-1-Nginx运行工作进程个数，一般我们设置CPU的核心或者核心数x2"><a href="#2-3-1-Nginx运行工作进程个数，一般我们设置CPU的核心或者核心数x2" class="headerlink" title="2.3.1 Nginx运行工作进程个数，一般我们设置CPU的核心或者核心数x2"></a>2.3.1 Nginx运行工作进程个数，一般我们设置CPU的核心或者核心数x2</h4><p>如果不了解cpu的核数，可以top命令之后按1也可以看出来，也可以查看/proc/cpuinfo文件#grep processor /proc/cpuinfo | wc -l</p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[<span class="symbol">root@</span>www ~]# vi /usr/local/nginx1<span class="number">.10</span>/conf/nginx.conf</span><br><span class="line">worker_processes  <span class="number">4</span>;</span><br><span class="line">[<span class="symbol">root@</span>www ~]# /usr/local/nginx1<span class="number">.10</span>/sbin/nginx -s reload</span><br><span class="line">[<span class="symbol">root@</span>www ~]# ps -aux | grep nginx | grep -v grep</span><br><span class="line">root  <span class="number">9834</span>  <span class="number">0.0</span>  <span class="number">0.0</span>  <span class="number">47556</span>  <span class="number">1948</span> ?       Ss   <span class="number">22</span>:<span class="number">36</span>   <span class="number">0</span>:<span class="number">00</span> nginx: master process nginx</span><br><span class="line">www <span class="number">10135</span>  <span class="number">0.0</span>  <span class="number">0.0</span>  <span class="number">50088</span>  <span class="number">2004</span> ?        S    <span class="number">22</span>:<span class="number">58</span>   <span class="number">0</span>:<span class="number">00</span> nginx: worker process</span><br><span class="line">www  <span class="number">10136</span>  <span class="number">0.0</span>  <span class="number">0.0</span>  <span class="number">50088</span>  <span class="number">2004</span> ?        S    <span class="number">22</span>:<span class="number">58</span>   <span class="number">0</span>:<span class="number">00</span> nginx: worker process</span><br><span class="line">www  <span class="number">10137</span>  <span class="number">0.0</span>  <span class="number">0.0</span>  <span class="number">50088</span>  <span class="number">2004</span> ?        S    <span class="number">22</span>:<span class="number">58</span>   <span class="number">0</span>:<span class="number">00</span> nginx: worker process</span><br><span class="line">www  <span class="number">10138</span>  <span class="number">0.0</span>  <span class="number">0.0</span>  <span class="number">50088</span>  <span class="number">2004</span> ?        S    <span class="number">22</span>:<span class="number">58</span>   <span class="number">0</span>:<span class="number">00</span> nginx: worker process</span><br></pre></td></tr></table></figure><p><strong>Nginx运行CPU亲和力</strong><br>比如4核配置</p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">worker_processes  <span class="number">4</span>;</span><br><span class="line">worker_cpu_affinity <span class="number">0001</span> <span class="number">0010</span> <span class="number">0100</span> <span class="number">1000</span></span><br></pre></td></tr></table></figure><p>比如8核配置</p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">worker_processes <span class="number">8</span>;</span><br><span class="line">worker_cpu_affinity <span class="number">00000001</span> <span class="number">00000010</span> <span class="number">00000100</span> <span class="number">00001000</span> <span class="number">00010000</span> <span class="number">00100000</span> <span class="number">01000000</span> <span class="number">10000000</span>;</span><br></pre></td></tr></table></figure><p><strong>worker_processes最多开启8个，8个以上性能提升不会再提升了，而且稳定性变得更低，所以8个进程够用了。</strong></p><p><strong>Nginx最多可以打开文件数</strong></p><figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">worker_rlimit_nofile <span class="number">65535</span><span class="comment">;</span></span><br></pre></td></tr></table></figure><p>这个指令是指当一个nginx进程打开的最多文件描述符数目，理论值应该是最多打开文件数（ulimit -n）与nginx进程数相除，但是nginx分配请求并不是那么均匀，所以最好与ulimit -n的值保持一致。<br>注：<br>文件资源限制的配置可以在/etc/security/limits.conf设置，针对root/user等各个用户或者*代表所有用户来设置。</p><ul><li>soft nofile 65535</li><li>hard nofile 65535</li></ul><p>用户重新登录生效（ulimit -n）</p><h4 id="2-3-2-Nginx事件处理模型"><a href="#2-3-2-Nginx事件处理模型" class="headerlink" title="2.3.2 Nginx事件处理模型"></a>2.3.2 Nginx事件处理模型</h4><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">events</span> &#123;</span><br><span class="line"><span class="attribute">use</span> <span class="literal">epoll</span>;</span><br><span class="line"><span class="attribute">worker_connections</span> <span class="number">65535</span>;</span><br><span class="line"><span class="attribute">multi_accept</span> <span class="literal">on</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>nginx采用epoll事件模型，处理效率高<br>work_connections是单个worker进程允许客户端最大连接数，这个数值一般根据服务器性能和内存来制定，实际最大值就是worker进程数乘以work_connections<br>实际我们填入一个65535，足够了，这些都算并发值，一个网站的并发达到这么大的数量，也算一个大站了！<br>multi_accept 告诉nginx收到一个新连接通知后接受尽可能多的连接，默认是on，设置为on后，多个worker按串行方式来处理连接，也就是一个连接只有一个worker被唤醒，其他的处于休眠状态，设置为off后，多个worker按并行方式来处理连接，也就是一个连接会唤醒所有的worker，直到连接分配完毕，没有取得连接的继续休眠。当你的服务器连接数不多时，开启这个参数会让负载有一定的降低，但是当服务器的吞吐量很大时，为了效率，可以关闭这个参数。</p><h4 id="2-3-3-开启高效传输模式"><a href="#2-3-3-开启高效传输模式" class="headerlink" title="2.3.3 开启高效传输模式"></a>2.3.3 开启高效传输模式</h4><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">http &#123;</span><br><span class="line">include mime.types;</span><br><span class="line">default_type <span class="built_in">application</span>/octet-stream;</span><br><span class="line">……</span><br><span class="line">sendfile <span class="keyword">on</span>;</span><br><span class="line">tcp_nopush <span class="keyword">on</span>;</span><br><span class="line">……</span><br></pre></td></tr></table></figure><p><strong>Include mime.types;</strong> //媒体类型,include 只是一个在当前文件中包含另一个文件内容的指令<br><strong>default_type application/octet-stream;</strong> //默认媒体类型足够<br><strong>sendfile on；</strong>//开启高效文件传输模式，sendfile指令指定nginx是否调用sendfile函数来输出文件，对于普通应用设为 on，如果用来进行下载等应用磁盘IO重负载应用，可设置为off，以平衡磁盘与网络I/O处理速度，降低系统的负载。<br>注意：如果图片显示不正常把这个改成off。<br><strong>tcp_nopush on；</strong>必须在sendfile开启模式才有效，防止网路阻塞，积极的减少网络报文段的数量（将响应头和正文的开始部分一起发送，而不一个接一个的发送。）</p><h4 id="2-3-4-连接超时时间"><a href="#2-3-4-连接超时时间" class="headerlink" title="2.3.4 连接超时时间"></a>2.3.4 连接超时时间</h4><p>主要目的是保护服务器资源，CPU，内存，控制连接数，因为建立连接也是需要消耗资源的</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">keepalive_timeout</span> <span class="number">60</span>;</span><br><span class="line"><span class="attribute">tcp_nodelay</span> <span class="literal">on</span>;</span><br><span class="line"><span class="attribute">client_header_buffer_size</span> <span class="number">4k</span>;</span><br><span class="line"><span class="attribute">open_file_cache</span> max=<span class="number">102400</span> inactive=<span class="number">20s</span>;</span><br><span class="line"><span class="attribute">open_file_cache_valid</span> <span class="number">30s</span>;</span><br><span class="line"><span class="attribute">open_file_cache_min_uses</span> <span class="number">1</span>;</span><br><span class="line"><span class="attribute">client_header_timeout</span> <span class="number">15</span>;</span><br><span class="line"><span class="attribute">client_body_timeout</span> <span class="number">15</span>;</span><br><span class="line"><span class="attribute">reset_timedout_connection</span> <span class="literal">on</span>;</span><br><span class="line"><span class="attribute">send_timeout</span> <span class="number">15</span>;</span><br><span class="line"><span class="attribute">server_tokens</span> <span class="literal">off</span>;</span><br><span class="line"><span class="attribute">client_max_body_size</span> <span class="number">10m</span>;</span><br></pre></td></tr></table></figure><p><strong>keepalived_timeout；</strong>客户端连接保持会话超时时间，超过这个时间，服务器断开这个链接<br><strong>tcp_nodelay；</strong>也是防止网络阻塞，不过要包涵在keepalived参数才有效<br><strong>client_header_buffer_size 4k;</strong><br>客户端请求头部的缓冲区大小，这个可以根据你的系统分页大小来设置，一般一个请求头的大小不会超过 1k，不过由于一般系统分页都要大于1k，所以这里设置为分页大小。分页大小可以用命令getconf PAGESIZE取得。<br><strong>open_file_cache max=102400 inactive=20s;</strong><br>这个将为打开文件指定缓存，默认是没有启用的，max指定缓存数量，建议和打开文件<br>数一致，inactive 是指经过多长时间文件没被请求后删除缓存。<br><strong>open_file_cache_valid 30s;</strong><br>这个是指多长时间检查一次缓存的有效信息。<br><strong>open_file_cache_min_uses 1;</strong><br><strong>open_file_cache</strong>指令中的inactive 参数时间内文件的最少使用次数，如果超过这个数字，文<br>件描述符一直是在缓存中打开的，如上例，如果有一个文件在inactive 时间内一次没被使用，它将被移除。<br><strong>client_header_timeout</strong>设置请求头的超时时间。我们也可以把这个设置低些，如果超过这个时间没有发送任何数据，nginx将返回request time out的错误<br><strong>client_body_timeout</strong>设置请求体的超时时间。我们也可以把这个设置低些，超过这个时间没有发送任何数据，和上面一样的错误提示<br><strong>reset_timeout_connection</strong> 告诉nginx关闭不响应的客户端连接。这将会释放那个客户端所占有的内存空间。<br><strong>send_timeout</strong>响应客户端超时时间，这个超时时间仅限于两个活动之间的时间，如果超过这个时间，客户端没有任何活动，nginx关闭连接<br><strong>server_tokens</strong> 并不会让nginx执行的速度更快，但它可以关闭在错误页面中的nginx版本数字，这样对于安全性是有好处的。<br><strong>client_max_body_size</strong>上传文件大小限制</p><h4 id="2-3-5-fastcgi调优"><a href="#2-3-5-fastcgi调优" class="headerlink" title="2.3.5 fastcgi调优"></a>2.3.5 fastcgi调优</h4><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">fastcgi_connect_timeout     <span class="number">600</span>;</span><br><span class="line">fastcgi_send_timeout <span class="number">600</span>;</span><br><span class="line">fastcgi_read_timeout <span class="number">600</span>;</span><br><span class="line">fastcgi_buffer_size <span class="number">64</span>k;</span><br><span class="line">fastcgi_buffers <span class="number">4</span> <span class="number">64</span>k;</span><br><span class="line">fastcgi_busy_buffers_size <span class="number">128</span>k;</span><br><span class="line">fastcgi_temp_file_write_size <span class="number">128</span>k;</span><br><span class="line">fastcgi_temp_path /usr/local/nginx1<span class="number">.10</span>/nginx_tmp;</span><br><span class="line">fastcgi_intercept_errors on;</span><br><span class="line">fastcgi_cache_path /usr/local/nginx1<span class="number">.10</span>/fastcgi_cache levels=<span class="number">1</span>:<span class="number">2</span> keys_zone=cache_fastcgi:<span class="number">128</span>m inactive=<span class="number">1</span>d max_size=<span class="number">10</span>g;</span><br></pre></td></tr></table></figure><p><strong>fastcgi_connect_timeout 600;</strong> #指定连接到后端FastCGI的超时时间。<br><strong>fastcgi_send_timeout 600;</strong> #向FastCGI传送请求的超时时间。<br><strong>fastcgi_read_timeout 600;</strong> #指定接收FastCGI应答的超时时间。<br><strong>fastcgi_buffer_size 64k;</strong> #指定读取FastCGI应答第一部分需要用多大的缓冲区，默认的缓冲区大小为<strong>fastcgi_buffers</strong>指令中的每块大小，可以将这个值设置更小。</p><p><strong>fastcgi_buffers 4 64k;</strong> #指定本地需要用多少和多大的缓冲区来缓冲FastCGI的应答请求，如果一个php脚本所产生的页面大小为256KB，那么会分配4个64KB的缓冲区来缓存，如果页面大小大于256KB，那么大于256KB的部分会缓存到fastcgi_temp_path指定的路径中，但是这并不是好方法，因为内存中的数据处理速度要快于磁盘。一般这个值应该为站点中php脚本所产生的页面大小的中间值，如果站点大部分脚本所产生的页面大小为256KB，那么可以把这个值设置为“8 32K”、“4 64k”等。<br><strong>fastcgi_busy_buffers_size 128k;</strong> #建议设置为fastcgi_buffers的两倍，繁忙时候的buffer<br><strong>fastcgi_temp_file_write_size 128k;</strong> #在写入fastcgi_temp_path时将用多大的数据块，默认值是<strong>fastcgi_buffers</strong>的两倍，该数值设置小时若负载上来时可能报502Bad Gateway<br><strong>fastcgi_temp_path</strong> #缓存临时目录<br><strong>fastcgi_intercept_errors on;</strong>#这个指令指定是否传递4xx和5xx错误信息到客户端，或者允许nginx使用error_page处理错误信息。<br>注：静态文件不存在会返回404页面，但是php页面则返回空白页！！<br>fastcgi_cache_path /usr/local/nginx1.10/fastcgi_cache levels=1:2 keys_zone=cache_fastcgi:128m *<em>inactive=1d max_size=10g; *</em>#fastcgi_cache缓存目录，可以设置目录层级，比如1:2会生成16*256个子目录，cache_fastcgi是这个缓存空间的名字，cache是用多少内存（这样热门的内容nginx直接放内存，提高访问速度），inactive表示默认失效时间，如果缓存数据在失效时间内没有被访问,将被删除，max_size表示最多用多少硬盘空间。</p><p><strong>fastcgi_cache cache_fastcgi;</strong> #表示开启FastCGI缓存并为其指定一个名称。开启缓存非常有用，可以有效降低CPU的负载，并且防止502的错误放生。cache_fastcgi为proxy_cache_path指令创建的缓存区名称</p><p><strong>fastcgi_cache_valid 200 302 1h;</strong> #用来指定应答代码的缓存时间，实例中的值表示将200和302应答缓存一小时，要和fastcgi_cache配合使用<br><strong>fastcgi_cache_valid 301 1d;</strong> #将301应答缓存一天<br><strong>fastcgi_cache_valid any 1m;</strong> #将其他应答缓存为1分钟<br><strong>fastcgi_cache_min_uses 1;</strong> #该指令用于设置经过多少次请求的相同URL将被缓存。<br><strong>fastcgi_cache_key http://$host$request_uri;</strong> #该指令用来设置web缓存的Key值,nginx根据Key值md5哈希存储.一般根据$host(域名)、$request_uri(请求的路径)等变量组合成proxy_cache_key 。<br><strong>fastcgi_pass</strong> #指定FastCGI服务器监听端口与地址，可以是本机或者其它</p><p><strong>总结：</strong><br>nginx的缓存功能有：proxy_cache / fastcgi_cache<br>proxy_cache的作用是缓存后端服务器的内容，可能是任何内容，包括静态的和动态。<br>fastcgi_cache的作用是缓存fastcgi生成的内容，很多情况是php生成的动态的内容。<br>proxy_cache缓存减少了nginx与后端通信的次数，节省了传输时间和后端宽带。<br>fastcgi_cache缓存减少了nginx与php的通信的次数，更减轻了php和数据库(mysql)的压力。</p><h4 id="2-3-6-gzip调优"><a href="#2-3-6-gzip调优" class="headerlink" title="2.3.6 gzip调优"></a>2.3.6 gzip调优</h4><p>使用gzip压缩功能，可能为我们节约带宽，加快传输速度，有更好的体验，也为我们节约成本，所以说这是一个重点。<br>Nginx启用压缩功能需要你来ngx_http_gzip_module模块，apache使用的是mod_deflate<br>一般我们需要压缩的内容有：文本，js，html，css，对于图片，视频，flash什么的不压缩，同时也要注意，我们使用gzip的功能是需要消耗CPU的！</p><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">gzip <span class="keyword">on</span>;</span><br><span class="line">gzip_min_length  <span class="number">2</span>k;</span><br><span class="line">gzip_buffers     <span class="number">4</span> <span class="number">32</span>k;</span><br><span class="line">gzip_http_version <span class="number">1.1</span>;</span><br><span class="line">gzip_comp_level <span class="number">6</span>;</span><br><span class="line">gzip_typestext/plain <span class="built_in">text</span>/css <span class="built_in">text</span>/javascript <span class="built_in">application</span>/json <span class="built_in">application</span>/javascript <span class="built_in">application</span>/x-javascript <span class="built_in">application</span>/xml;</span><br><span class="line">gzip_vary <span class="keyword">on</span>;</span><br><span class="line">gzip_proxied any;</span><br></pre></td></tr></table></figure><p><strong>gzip on;</strong> #开启压缩功能<br><strong>gzip_min_length 1k;</strong> #设置允许压缩的页面最小字节数，页面字节数从header头的Content-Length中获取，默认值是0，不管页面多大都进行压缩，建议设置成大于1K，如果小与1K可能会越压越大。<br><strong>gzip_buffers 4 32k;</strong> #压缩缓冲区大小，表示申请4个单位为32K的内存作为压缩结果流缓存，默认值是申请与原始数据大小相同的内存空间来存储gzip压缩结果。<br><strong>gzip_http_version 1.1;</strong> #压缩版本，用于设置识别HTTP协议版本，默认是1.1，目前大部分浏览器已经支持GZIP解压，使用默认即可<br><strong>gzip_comp_level 6;</strong> #压缩比例，用来指定GZIP压缩比，1压缩比最小，处理速度最快，9压缩比最大，传输速度快，但是处理慢，也比较消耗CPU资源。<br><strong>gzip_types text/css text/xml application/javascript;</strong> #用来指定压缩的类型，‘text/html’类型总是会被压缩。<br>默认值: gzip_types text/html (默认不对js/css文件进行压缩)</p><p>#压缩类型，匹配MIME类型进行压缩<br>#不能用通配符 text/*<br>#(无论是否指定)text/html默认已经压缩<br>#设置哪压缩种文本文件可参考 conf/mime.types<br><strong>gzip_vary on;</strong> #vary header支持，改选项可以让前端的缓存服务器缓存经过GZIP压缩的页面，例如用Squid缓存经过nginx压缩的数据</p><h4 id="2-3-7-expires缓存调优"><a href="#2-3-7-expires缓存调优" class="headerlink" title="2.3.7 expires缓存调优"></a>2.3.7 expires缓存调优</h4><p>缓存，主要针对于图片，css，js等元素更改机会比较少的情况下使用，特别是图片，占用带宽大，我们完全可以设置图片在浏览器本地缓存365d，css，js，html可以缓存个10来天，这样用户第一次打开加载慢一点，第二次，就非常快了！缓存的时候，我们需要将需要缓存的拓展名列出来， Expires缓存配置在server字段里面</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">location</span> <span class="regexp">~* \.(ico|jpe?g|gif|png|bmp|swf|flv)$</span> &#123;</span><br><span class="line">   <span class="attribute">expires</span> <span class="number">30d</span>;</span><br><span class="line">   <span class="comment">#log_not_found off;</span></span><br><span class="line">   <span class="attribute">access_log</span> <span class="literal">off</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="attribute">location</span> <span class="regexp">~* \.(js|css)$</span> &#123;</span><br><span class="line">   <span class="attribute">expires</span> <span class="number">7d</span>;</span><br><span class="line">   <span class="attribute">log_not_found</span> <span class="literal">off</span>;</span><br><span class="line">   <span class="attribute">access_log</span> <span class="literal">off</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>注：</strong>log_not_found off;是否在error_log中记录不存在的错误。默认是。</p><p><strong>总结：</strong><br>expire功能优点</p><ol><li>expires可以降低网站购买的带宽，节约成本</li><li>同时提升用户访问体验</li><li>减轻服务的压力，节约服务器成本，是web服务非常重要的功能。 expire功能缺点：被缓存的页面或数据更新了，用户看到的可能还是旧的内容，反而影响用户体验。解决办法：第一个缩短缓存时间，例如：1天，但不彻底，除非更新频率大于1天；第二个对缓存的对象改名。<br>网站不希望被缓存的内容 1）网站流量统计工具2）更新频繁的文件（google的logo）</li></ol><h4 id="2-3-8-防盗链"><a href="#2-3-8-防盗链" class="headerlink" title="2.3.8 防盗链"></a>2.3.8 防盗链</h4><p>防止别人直接从你网站引用图片等链接，消耗了你的资源和网络流量，那么我们的解决办法由几种：</p><ol><li>水印，品牌宣传，你的带宽，服务器足够</li><li>防火墙，直接控制，前提是你知道IP来源</li><li>防盗链策略下面的方法是直接给予404的错误提示</li></ol><figure class="highlight coq"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">location ~* ^.+\.(jpg|<span class="type">gif</span>|<span class="type">png</span>|<span class="type">swf</span>|<span class="type">flv</span>|<span class="type">wma</span>|<span class="type">wmv</span>|<span class="type">asf</span>|<span class="type">mp3</span>|<span class="type">mmf</span>|<span class="type">zip</span>|<span class="type">rar</span>)$ &#123;</span><br><span class="line">     valid_referers none blocked  www.benet.com benet.com;</span><br><span class="line">     <span class="keyword">if</span> ($invalid_referer) &#123;</span><br><span class="line">       #<span class="keyword">return</span> <span class="number">302</span>  http://www.benet.com/img/nolink.jpg;</span><br><span class="line">       <span class="keyword">return</span> <span class="number">404</span>;</span><br><span class="line">        break;</span><br><span class="line">     &#125;</span><br><span class="line">     access_log off;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><p><strong>参数可以使如下形式：</strong><br>none 意思是不存在的Referer头(表示空的，也就是直接访问，比如直接在浏览器打开一个图片)<br>blocked 意为根据防火墙伪装Referer头，如：“Referer: XXXXXXX”。<br>server_names 为一个或多个服务器的列表，0.5.33版本以后可以在名称中使用“*”通配符。</p><h4 id="2-3-9-内核参数优化"><a href="#2-3-9-内核参数优化" class="headerlink" title="2.3.9 内核参数优化"></a>2.3.9 内核参数优化</h4><p><strong>fs.file-max = 999999</strong> #这个参数表示进程（比如一个worker进程）可以同时打开的最大句柄数，这个参数直线限制最大并发连接数，需根据实际情况配置。<br><strong>net.ipv4.tcp_max_tw_buckets = 6000</strong> #这个参数表示操作系统允许TIME_WAIT套接字数量的最大值，如果超过这个数字，TIME_WAIT套接字将立刻被清除并打印警告信息。该参数默认为180000，过多的TIME_WAIT套接字会使Web服务器变慢。<br>注：主动关闭连接的服务端会产生TIME_WAIT状态的连接<br><strong>net.ipv4.ip_local_port_range = 1024 65000</strong> #允许系统打开的端口范围。<br><strong>net.ipv4.tcp_tw_recycle = 1</strong> #启用timewait快速回收。<br><strong>net.ipv4.tcp_tw_reuse = 1 *<em>#开启重用。允许将TIME-WAIT sockets重新用于新的TCP连接。这对于服务器来说很有意义，因为服务器上总会有大量TIME-WAIT状态的连接。<br>*</em>net.ipv4.tcp_keepalive_time = 30</strong> #这个参数表示当keepalive启用时，TCP发送keepalive消息的频度。默认是2小时，若将其设置的小一些，可以更快地清理无效的连接。<br><strong>net.ipv4.tcp_syncookies = 1</strong> #开启SYN Cookies，当出现SYN等待队列溢出时，启用cookies来处理。<br><strong>net.core.somaxconn = 40960</strong> #web 应用中 listen 函数的 backlog 默认会给我们内核参数的 net.core.somaxconn 限制到128，而nginx定义的NGX_LISTEN_BACKLOG 默认为511，所以有必要调整这个值。<br><strong>注：</strong>对于一个TCP连接，Server与Client需要通过三次握手来建立网络连接.当三次握手成功后,我们可以看到端口的状态由LISTEN转变为ESTABLISHED,接着这条链路上就可以开始传送数据了.每一个处于监听(Listen)状态的端口,都有自己的监听队列.监听队列的长度与如somaxconn参数和使用该端口的程序中listen()函数有关<br><strong>somaxconn</strong>参数:定义了系统中每一个端口最大的监听队列的长度,这是个全局的参数,默认值为128，对于一个经常处理新连接的高负载 web服务环境来说，默认的 128 太小了。大多数环境这个值建议增加到 1024 或者更多。大的侦听队列对防止拒绝服务 DoS 攻击也会有所帮助。<br><strong>net.core.netdev_max_backlog = 262144</strong> #每个网络接口接收数据包的速率比内核处理这些包的速率快时，允许送到队列的数据包的最大数目。<br><strong>net.ipv4.tcp_max_syn_backlog = 262144</strong> #这个参数标示TCP三次握手建立阶段接受SYN请求队列的最大长度，默认为1024，将其设置得大一些可以使出现Nginx繁忙来不及accept新连接的情况时，Linux不至于丢失客户端发起的连接请求。<br><strong>net.ipv4.tcp_rmem = 10240 87380 12582912</strong> #这个参数定义了TCP接受缓存（用于TCP接受滑动窗口）的最小值、默认值、最大值。<br><strong>net.ipv4.tcp_wmem = 10240 87380 12582912</strong> #这个参数定义了TCP发送缓存（用于TCP发送滑动窗口）的最小值、默认值、最大值。<br><strong>net.core.rmem_default = 6291456</strong> #这个参数表示内核套接字接受缓存区默认的大小。<br><strong>net.core.wmem_default = 6291456</strong> #这个参数表示内核套接字发送缓存区默认的大小。<br><strong>net.core.rmem_max = 12582912</strong> #这个参数表示内核套接字接受缓存区的最大大小。<br><strong>net.core.wmem_max = 12582912</strong> #这个参数表示内核套接字发送缓存区的最大大小。<br><strong>net.ipv4.tcp_syncookies = 1</strong> #该参数与性能无关，用于解决TCP的SYN攻击。<br>下面贴一个完整的内核优化设置：</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">fs<span class="selector-class">.file-max</span> = <span class="number">999999</span></span><br><span class="line">net<span class="selector-class">.ipv4</span><span class="selector-class">.ip_forward</span> = <span class="number">0</span></span><br><span class="line">net<span class="selector-class">.ipv4</span><span class="selector-class">.conf</span><span class="selector-class">.default</span><span class="selector-class">.rp_filter</span> = <span class="number">1</span></span><br><span class="line">net<span class="selector-class">.ipv4</span><span class="selector-class">.conf</span><span class="selector-class">.default</span><span class="selector-class">.accept_source_route</span> = <span class="number">0</span></span><br><span class="line">kernel<span class="selector-class">.sysrq</span> = <span class="number">0</span></span><br><span class="line">kernel<span class="selector-class">.core_uses_pid</span> = <span class="number">1</span></span><br><span class="line">net<span class="selector-class">.ipv4</span><span class="selector-class">.tcp_syncookies</span> = <span class="number">1</span></span><br><span class="line">kernel<span class="selector-class">.msgmnb</span> = <span class="number">65536</span></span><br><span class="line">kernel<span class="selector-class">.msgmax</span> = <span class="number">65536</span></span><br><span class="line">kernel<span class="selector-class">.shmmax</span> = <span class="number">68719476736</span></span><br><span class="line">kernel<span class="selector-class">.shmall</span> = <span class="number">4294967296</span></span><br><span class="line">net<span class="selector-class">.ipv4</span><span class="selector-class">.tcp_max_tw_buckets</span> = <span class="number">6000</span></span><br><span class="line">net<span class="selector-class">.ipv4</span><span class="selector-class">.tcp_sack</span> = <span class="number">1</span></span><br><span class="line">net<span class="selector-class">.ipv4</span><span class="selector-class">.tcp_window_scaling</span> = <span class="number">1</span></span><br><span class="line">net<span class="selector-class">.ipv4</span><span class="selector-class">.tcp_rmem</span> = <span class="number">10240</span> <span class="number">87380</span> <span class="number">12582912</span></span><br><span class="line">net<span class="selector-class">.ipv4</span><span class="selector-class">.tcp_wmem</span> = <span class="number">10240</span> <span class="number">87380</span> <span class="number">12582912</span></span><br><span class="line">net<span class="selector-class">.core</span><span class="selector-class">.wmem_default</span> = <span class="number">8388608</span></span><br><span class="line">net<span class="selector-class">.core</span><span class="selector-class">.rmem_default</span> = <span class="number">8388608</span></span><br><span class="line">net<span class="selector-class">.core</span><span class="selector-class">.rmem_max</span> = <span class="number">16777216</span></span><br><span class="line">net<span class="selector-class">.core</span><span class="selector-class">.wmem_max</span> = <span class="number">16777216</span></span><br><span class="line">net<span class="selector-class">.core</span><span class="selector-class">.netdev_max_backlog</span> = <span class="number">262144</span></span><br><span class="line">net<span class="selector-class">.core</span><span class="selector-class">.somaxconn</span> = <span class="number">40960</span></span><br><span class="line">net<span class="selector-class">.ipv4</span><span class="selector-class">.tcp_max_orphans</span> = <span class="number">3276800</span></span><br><span class="line">net<span class="selector-class">.ipv4</span><span class="selector-class">.tcp_max_syn_backlog</span> = <span class="number">262144</span></span><br><span class="line">net<span class="selector-class">.ipv4</span><span class="selector-class">.tcp_timestamps</span> = <span class="number">0</span></span><br><span class="line">net<span class="selector-class">.ipv4</span><span class="selector-class">.tcp_synack_retries</span> = <span class="number">1</span></span><br><span class="line">net<span class="selector-class">.ipv4</span><span class="selector-class">.tcp_syn_retries</span> = <span class="number">1</span></span><br><span class="line">net<span class="selector-class">.ipv4</span><span class="selector-class">.tcp_tw_recycle</span> = <span class="number">1</span></span><br><span class="line">net<span class="selector-class">.ipv4</span><span class="selector-class">.tcp_tw_reuse</span> = <span class="number">1</span></span><br><span class="line">net<span class="selector-class">.ipv4</span><span class="selector-class">.tcp_mem</span> = <span class="number">94500000</span> <span class="number">915000000</span> <span class="number">927000000</span></span><br><span class="line">net<span class="selector-class">.ipv4</span><span class="selector-class">.tcp_fin_timeout</span> = <span class="number">1</span></span><br><span class="line">net<span class="selector-class">.ipv4</span><span class="selector-class">.tcp_keepalive_time</span> = <span class="number">30</span></span><br><span class="line">net<span class="selector-class">.ipv4</span><span class="selector-class">.ip_local_port_range</span> = <span class="number">1024</span> <span class="number">65000</span></span><br></pre></td></tr></table></figure><p>执行sysctl -p使内核修改生效</p><h4 id="2-3-10-关于系统连接数的优化"><a href="#2-3-10-关于系统连接数的优化" class="headerlink" title="2.3.10 关于系统连接数的优化"></a>2.3.10 关于系统连接数的优化</h4><p>linux 默认值 open files为1024</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">ulimit</span> -n</span></span><br><span class="line">1024</span><br></pre></td></tr></table></figure><p>说明server只允许同时打开1024个文件<br>使用ulimit -a 可以查看当前系统的所有限制值，使用ulimit -n 可以查看当前的最大打开文件数。<br>新装的linux 默认只有1024 ，当作负载较大的服务器时，很容易遇到error: too many open files。因此，需要将其改大<br>在/etc/security/limits.conf最后增加：</p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">*                soft    nofile          <span class="number">65535</span></span><br><span class="line">*                hard    nofile          <span class="number">65535</span></span><br><span class="line">*                soft    noproc          <span class="number">65535</span></span><br><span class="line">*                hard    noproc          <span class="number">65535</span></span><br></pre></td></tr></table></figure><h2 id="3、部署LNMP"><a href="#3、部署LNMP" class="headerlink" title="3、部署LNMP"></a>3、部署LNMP</h2><h3 id="3-1-安装php"><a href="#3-1-安装php" class="headerlink" title="3.1 安装php"></a>3.1 安装php</h3><p><strong>解决依赖关系</strong></p><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="symbol">@www</span> ~]<span class="meta"># yum -y install libxml2-devel libcurl-devel openssl-devel bzip2-devel</span></span><br></pre></td></tr></table></figure><p><strong>安装libmcrypt</strong></p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[<span class="symbol">root@</span>www ~]# tar zxf libmcrypt<span class="number">-2.5</span><span class="number">.7</span>.tar.gz </span><br><span class="line">[<span class="symbol">root@</span>wwwr ~]# cd libmcrypt<span class="number">-2.5</span><span class="number">.7</span>/</span><br><span class="line">[<span class="symbol">root@</span>www libmcrypt<span class="number">-2.5</span><span class="number">.7</span>]# ./configure --prefix=/usr/local/libmcrypt &amp;&amp; make &amp;&amp; make install</span><br></pre></td></tr></table></figure><h3 id="3-2-编译安装php"><a href="#3-2-编译安装php" class="headerlink" title="3.2 编译安装php"></a>3.2 编译安装php</h3><figure class="highlight brainfuck"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="title">[</span><span class="comment">root@www</span> <span class="comment">~</span><span class="title">]</span><span class="comment">#</span> <span class="comment">tar</span> <span class="comment">zxf</span> <span class="comment">php</span><span class="literal">-</span><span class="comment">5</span><span class="string">.</span><span class="comment">6</span><span class="string">.</span><span class="comment">27</span><span class="string">.</span><span class="comment">tar</span><span class="string">.</span><span class="comment">gz</span></span><br><span class="line"><span class="comment"></span><span class="title">[</span><span class="comment">root@www</span> <span class="comment">~</span><span class="title">]</span><span class="comment">#</span> <span class="comment">cd</span> <span class="comment">php</span><span class="literal">-</span><span class="comment">5</span><span class="string">.</span><span class="comment">6</span><span class="string">.</span><span class="comment">27/</span></span><br><span class="line"><span class="comment"></span><span class="title">[</span><span class="comment">root@www</span> <span class="comment">php</span><span class="literal">-</span><span class="comment">5</span><span class="string">.</span><span class="comment">6</span><span class="string">.</span><span class="comment">27</span><span class="title">]</span><span class="comment">#</span> <span class="string">.</span><span class="comment">/configure</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">prefix=/usr/local/php5</span><span class="string">.</span><span class="comment">6</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">with</span><span class="literal">-</span><span class="comment">mysql=mysqlnd</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">with</span><span class="literal">-</span><span class="comment">pdo</span><span class="literal">-</span><span class="comment">mysql=mysqlnd</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">with</span><span class="literal">-</span><span class="comment">mysqli=mysqlnd</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">with</span><span class="literal">-</span><span class="comment">openssl</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">enable</span><span class="literal">-</span><span class="comment">fpm</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">enable</span><span class="literal">-</span><span class="comment">sockets</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">enable</span><span class="literal">-</span><span class="comment">sysvshm</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">enable</span><span class="literal">-</span><span class="comment">mbstring</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">with</span><span class="literal">-</span><span class="comment">freetype</span><span class="literal">-</span><span class="comment">dir</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">with</span><span class="literal">-</span><span class="comment">jpeg</span><span class="literal">-</span><span class="comment">dir</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">with</span><span class="literal">-</span><span class="comment">png</span><span class="literal">-</span><span class="comment">dir</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">with</span><span class="literal">-</span><span class="comment">zlib</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">with</span><span class="literal">-</span><span class="comment">libxml</span><span class="literal">-</span><span class="comment">dir=/usr</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">enable</span><span class="literal">-</span><span class="comment">xml</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">with</span><span class="literal">-</span><span class="comment">mhash</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">with</span><span class="literal">-</span><span class="comment">mcrypt=/usr/local/libmcrypt</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">with</span><span class="literal">-</span><span class="comment">config</span><span class="literal">-</span><span class="comment">file</span><span class="literal">-</span><span class="comment">path=/etc</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">with</span><span class="literal">-</span><span class="comment">config</span><span class="literal">-</span><span class="comment">file</span><span class="literal">-</span><span class="comment">scan</span><span class="literal">-</span><span class="comment">dir=/etc/php</span><span class="string">.</span><span class="comment">d</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">with</span><span class="literal">-</span><span class="comment">bz2</span><span class="literal">-</span><span class="literal">-</span><span class="comment">enable</span><span class="literal">-</span><span class="comment">maintainer</span><span class="literal">-</span><span class="comment">zts</span></span><br><span class="line"><span class="comment"></span><span class="title">[</span><span class="comment">root@www</span> <span class="comment">php</span><span class="literal">-</span><span class="comment">5</span><span class="string">.</span><span class="comment">6</span><span class="string">.</span><span class="comment">27</span><span class="title">]</span><span class="comment">#</span> <span class="comment">make&amp;&amp;</span> <span class="comment">make</span> <span class="comment">install</span></span><br></pre></td></tr></table></figure><h3 id="3-3-提供php配置文件"><a href="#3-3-提供php配置文件" class="headerlink" title="3.3 提供php配置文件"></a>3.3 提供php配置文件</h3><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[<span class="symbol">root@</span>www php<span class="number">-5.6</span><span class="number">.27</span>]# cp php.ini-production /etc /php.ini</span><br></pre></td></tr></table></figure><h3 id="3-4-为php-fpm提供脚本"><a href="#3-4-为php-fpm提供脚本" class="headerlink" title="3.4 为php-fpm提供脚本"></a>3.4 为php-fpm提供脚本</h3><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[<span class="symbol">root@</span>www php<span class="number">-5.6</span><span class="number">.27</span>]# cp sapi/fpm/init.d.php-fpm /etc/init.d/php-fpm</span><br><span class="line">[<span class="symbol">root@</span>www php<span class="number">-5.6</span><span class="number">.27</span>]# chmod +x /etc/init.d/php-fpm </span><br><span class="line">[<span class="symbol">root@</span>www php<span class="number">-5.6</span><span class="number">.27</span>]# chkconfig --add php-fpm</span><br><span class="line">[<span class="symbol">root@</span>www php<span class="number">-5.6</span><span class="number">.27</span>]# chkconfig php-fpm on</span><br></pre></td></tr></table></figure><h3 id="3-5-提供php-fpm配置文件并编辑"><a href="#3-5-提供php-fpm配置文件并编辑" class="headerlink" title="3.5 提供php-fpm配置文件并编辑"></a>3.5 提供php-fpm配置文件并编辑</h3><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># cp <span class="regexp">/usr/</span>local<span class="regexp">/php5.6/</span>etc<span class="regexp">/php-fpm.conf.default /u</span>sr<span class="regexp">/local/</span>php5.<span class="number">6</span><span class="regexp">/etc/</span>php-fpm.conf</span><br><span class="line">[root@www ~]# vi <span class="regexp">/usr/</span>local<span class="regexp">/php5.6/</span>etc<span class="regexp">/php-fpm.conf</span></span><br></pre></td></tr></table></figure><p>修改内容如下：</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">pid</span> = run/php-fpm.pid</span><br><span class="line"><span class="attr">listen</span> = <span class="number">0.0</span>.<span class="number">0.0</span>:<span class="number">9000</span></span><br><span class="line"><span class="attr">pm.max_children</span> =<span class="number">300</span></span><br><span class="line"><span class="attr">pm.start_servers</span> =<span class="number">20</span></span><br><span class="line"><span class="attr">pm.min_spare_servers</span> = <span class="number">20</span></span><br><span class="line"><span class="attr">pm.max_spare_servers</span> = <span class="number">100</span></span><br></pre></td></tr></table></figure><p><strong>启动php-fpm服务</strong></p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[<span class="symbol">root@</span>www ~]# service  php-fpm start</span><br><span class="line">Starting php-fpm  done</span><br><span class="line">[<span class="symbol">root@</span>www ~]# netstat -anpt | grep php-fpm</span><br><span class="line">tcp        <span class="number">0</span>      <span class="number">0</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>:<span class="number">9000</span>            <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>:*               LISTEN      <span class="number">25456</span>/php-fpm: mast </span><br><span class="line">[<span class="symbol">root@</span>www ~]# firewall-cmd --permanent --add-port=<span class="number">9000</span>/tcp</span><br><span class="line">success</span><br><span class="line">[<span class="symbol">root@</span>www ~]# firewall-cmd --reload</span><br><span class="line">Success</span><br></pre></td></tr></table></figure><p><strong>在nginx.conf文件的server中添加下面内容支持php</strong></p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">location</span> <span class="regexp">~ .*\.(php|php5)?$</span> &#123;</span><br><span class="line">            <span class="attribute">root</span> html;</span><br><span class="line">            <span class="attribute">fastcgi_pass</span> <span class="number">127.0.0.1:9000</span>;</span><br><span class="line">            <span class="attribute">fastcgi_index</span> index.php;</span><br><span class="line">            <span class="attribute">include</span> fastcgi.conf;</span><br><span class="line">            <span class="attribute">fastcgi_cache</span> cache_fastcgi;</span><br><span class="line">            <span class="attribute">fastcgi_cache_valid</span> <span class="number">200</span> <span class="number">302</span> <span class="number">1h</span>;</span><br><span class="line">            <span class="attribute">fastcgi_cache_valid</span> <span class="number">301</span> <span class="number">1d</span>;</span><br><span class="line">            <span class="attribute">fastcgi_cache_valid</span> any <span class="number">1m</span>;</span><br><span class="line">            <span class="attribute">fastcgi_cache_min_uses</span> <span class="number">1</span>;</span><br><span class="line">            <span class="attribute">fastcgi_cache_use_stale</span> <span class="literal">error</span> timeout invalid_header http_500;</span><br><span class="line">            <span class="attribute">fastcgi_cache_key</span> http://<span class="variable">$host</span><span class="variable">$request_uri</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>下面是nginx.conf的一个完整配置文件</p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">user</span> <span class="string">www www;</span></span><br><span class="line"><span class="attr">worker_processes</span>  <span class="string">4;</span></span><br><span class="line"><span class="attr">worker_cpu_affinity</span> <span class="string">0001 0010 0100 1000;</span></span><br><span class="line"><span class="attr">error_log</span>  <span class="string">logs/error.log;</span></span><br><span class="line"><span class="comment">#error_log  logs/error.log  notice;</span></span><br><span class="line"><span class="comment">#error_log  logs/error.log  info;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">pid</span>        <span class="string">logs/nginx.pid;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="attr">events</span> <span class="string">&#123;</span></span><br><span class="line"><span class="attr">use</span> <span class="string">epoll;</span></span><br><span class="line">    <span class="attr">worker_connections</span>  <span class="string">65535;</span></span><br><span class="line">    <span class="attr">multi_accept</span> <span class="string">on;</span></span><br><span class="line"><span class="attr">&#125;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="attr">http</span> <span class="string">&#123;</span></span><br><span class="line"><span class="attr">include</span>       <span class="string">mime.types;</span></span><br><span class="line">    <span class="attr">default_type</span>  <span class="string">application/octet-stream;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">    #log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '</span></span><br><span class="line"><span class="comment">    #                  '$status $body_bytes_sent "$http_referer" '</span></span><br><span class="line"><span class="comment">    #                  '"$http_user_agent" "$http_x_forwarded_for"';</span></span><br><span class="line"></span><br><span class="line"><span class="comment">    #access_log  logs/access.log  main;</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">sendfile</span>        <span class="string">on;</span></span><br><span class="line">    <span class="attr">tcp_nopush</span>     <span class="string">on;</span></span><br><span class="line">    <span class="attr">keepalive_timeout</span>  <span class="string">65;</span></span><br><span class="line">    <span class="attr">tcp_nodelay</span> <span class="string">on;</span></span><br><span class="line">    <span class="attr">client_header_buffer_size</span> <span class="string">4k;</span></span><br><span class="line">    <span class="attr">open_file_cache</span> <span class="string">max=102400 inactive=20s;</span></span><br><span class="line">    <span class="attr">open_file_cache_valid</span> <span class="string">30s;</span></span><br><span class="line">    <span class="attr">open_file_cache_min_uses</span> <span class="string">1;</span></span><br><span class="line">    <span class="attr">client_header_timeout</span> <span class="string">15;</span></span><br><span class="line">    <span class="attr">client_body_timeout</span> <span class="string">15;</span></span><br><span class="line">    <span class="attr">reset_timedout_connection</span> <span class="string">on;</span></span><br><span class="line">    <span class="attr">send_timeout</span> <span class="string">15;</span></span><br><span class="line">    <span class="attr">server_tokens</span> <span class="string">off;</span></span><br><span class="line">    <span class="attr">client_max_body_size</span> <span class="string">10m;</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">fastcgi_connect_timeout</span>     <span class="string">600;</span></span><br><span class="line">    <span class="attr">fastcgi_send_timeout</span> <span class="string">600;</span></span><br><span class="line">    <span class="attr">fastcgi_read_timeout</span> <span class="string">600;</span></span><br><span class="line">    <span class="attr">fastcgi_buffer_size</span> <span class="string">64k;</span></span><br><span class="line">    <span class="attr">fastcgi_buffers</span>     <span class="string">4 64k;</span></span><br><span class="line">    <span class="attr">fastcgi_busy_buffers_size</span> <span class="string">128k;</span></span><br><span class="line">    <span class="attr">fastcgi_temp_file_write_size</span> <span class="string">128k;</span></span><br><span class="line">    <span class="attr">fastcgi_temp_path</span> <span class="string">/usr/local/nginx1.10/nginx_tmp;</span></span><br><span class="line">    <span class="attr">fastcgi_intercept_errors</span> <span class="string">on;</span></span><br><span class="line">    <span class="attr">fastcgi_cache_path</span> <span class="string">/usr/local/nginx1.10/fastcgi_cache levels=1:2 keys_zone=cache_fastcgi:128m inactive=1d max_size=10g;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">gzip</span> <span class="string">on;</span></span><br><span class="line">    <span class="attr">gzip_min_length</span>  <span class="string">2k;</span></span><br><span class="line">    <span class="attr">gzip_buffers</span>     <span class="string">4 32k;</span></span><br><span class="line">    <span class="attr">gzip_http_version</span> <span class="string">1.1;</span></span><br><span class="line">    <span class="attr">gzip_comp_level</span> <span class="string">6;</span></span><br><span class="line">    <span class="attr">gzip_types</span>  <span class="string">text/plain text/css text/javascript application/json application/javascript application/x-javascript application/xml;</span></span><br><span class="line">    <span class="attr">gzip_vary</span> <span class="string">on;</span></span><br><span class="line">    <span class="attr">gzip_proxied</span> <span class="string">any;</span></span><br><span class="line"><span class="attr">server</span> <span class="string">&#123;</span></span><br><span class="line">        <span class="attr">listen</span>       <span class="string">80;</span></span><br><span class="line">        <span class="attr">server_name</span>  <span class="string">www.benet.com;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">        #charset koi8-r;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">        #access_log  logs/host.access.log  main;</span></span><br><span class="line"></span><br><span class="line">        <span class="attr">location</span> <span class="string">~* ^.+\.(jpg|gif|png|swf|flv|wma|wmv|asf|mp3|mmf|zip|rar)$ &#123;</span></span><br><span class="line">            <span class="attr">valid_referers</span> <span class="string">none blocked  www.benet.com benet.com;</span></span><br><span class="line">            <span class="attr">if</span> <span class="string">($invalid_referer) &#123;</span></span><br><span class="line"><span class="comment">                #return 302  http://www.benet.com/img/nolink.jpg;</span></span><br><span class="line">                <span class="attr">return</span> <span class="string">404;</span></span><br><span class="line">                <span class="attr">break;</span></span><br><span class="line">             <span class="attr">&#125;</span></span><br><span class="line">             <span class="attr">access_log</span> <span class="string">off;</span></span><br><span class="line">        <span class="attr">&#125;</span></span><br><span class="line">        <span class="attr">location</span> <span class="string">/ &#123;</span></span><br><span class="line">             <span class="attr">root</span>   <span class="string">html;</span></span><br><span class="line">             <span class="attr">index</span>  <span class="string">index.php index.html index.htm;</span></span><br><span class="line">        <span class="attr">&#125;</span></span><br><span class="line">        <span class="attr">location</span> <span class="string">~* \.(ico|jpe?g|gif|png|bmp|swf|flv)$ &#123;</span></span><br><span class="line">            <span class="attr">expires</span> <span class="string">30d;</span></span><br><span class="line"><span class="comment">            #log_not_found off;</span></span><br><span class="line">            <span class="attr">access_log</span> <span class="string">off;</span></span><br><span class="line">        <span class="attr">&#125;</span></span><br><span class="line"></span><br><span class="line">        <span class="attr">location</span> <span class="string">~* \.(js|css)$ &#123;</span></span><br><span class="line">            <span class="attr">expires</span> <span class="string">7d;</span></span><br><span class="line">            <span class="attr">log_not_found</span> <span class="string">off;</span></span><br><span class="line">            <span class="attr">access_log</span> <span class="string">off;</span></span><br><span class="line">        <span class="meta">&#125;</span>      <span class="string"></span></span><br><span class="line"></span><br><span class="line">        <span class="attr">location</span> = <span class="string">/(favicon.ico|roboots.txt) &#123;</span></span><br><span class="line">            <span class="attr">access_log</span> <span class="string">off;</span></span><br><span class="line">            <span class="attr">log_not_found</span> <span class="string">off;</span></span><br><span class="line">        <span class="attr">&#125;</span></span><br><span class="line">        <span class="attr">location</span> <span class="string">/status &#123;</span></span><br><span class="line">            <span class="attr">stub_status</span> <span class="string">on;</span></span><br><span class="line">        <span class="attr">&#125;</span></span><br><span class="line">        <span class="attr">location</span> <span class="string">~ .*\.(php|php5)?$ &#123;</span></span><br><span class="line">            <span class="attr">root</span> <span class="string">html;</span></span><br><span class="line">            <span class="attr">fastcgi_pass</span> <span class="string">127.0.0.1:9000;</span></span><br><span class="line">            <span class="attr">fastcgi_index</span> <span class="string">index.php;</span></span><br><span class="line">            <span class="attr">include</span> <span class="string">fastcgi.conf;</span></span><br><span class="line">            <span class="attr">fastcgi_cache</span> <span class="string">cache_fastcgi;</span></span><br><span class="line">            <span class="attr">fastcgi_cache_valid</span> <span class="string">200 302 1h;</span></span><br><span class="line">            <span class="attr">fastcgi_cache_valid</span> <span class="string">301 1d;</span></span><br><span class="line">            <span class="attr">fastcgi_cache_valid</span> <span class="string">any 1m;</span></span><br><span class="line">            <span class="attr">fastcgi_cache_min_uses</span> <span class="string">1;</span></span><br><span class="line">            <span class="attr">fastcgi_cache_use_stale</span> <span class="string">error timeout invalid_header http_500;</span></span><br><span class="line">            <span class="attr">fastcgi_cache_key</span> <span class="string">http://$host$request_uri;</span></span><br><span class="line">        <span class="attr">&#125;</span></span><br><span class="line"><span class="comment">        #error_page  404              /404.html;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">        # redirect server error pages to the static page /50x.html</span></span><br><span class="line"><span class="comment">        #</span></span><br><span class="line">        <span class="attr">error_page</span>   <span class="string">500 502 503 504  /50x.html;</span></span><br><span class="line">        <span class="attr">location</span> = <span class="string">/50x.html &#123;</span></span><br><span class="line">             <span class="attr">root</span>   <span class="string">html;</span></span><br><span class="line">        <span class="attr">&#125;</span></span><br><span class="line">   <span class="attr">&#125;</span></span><br><span class="line"><span class="attr">&#125;</span></span><br></pre></td></tr></table></figure><p>重载nginx服务</p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[<span class="symbol">root@</span>www ~]# /usr/local/nginx1<span class="number">.10</span>/sbin/nginx -s reload</span><br></pre></td></tr></table></figure><h2 id="4、验证、压力测试"><a href="#4、验证、压力测试" class="headerlink" title="4、验证、压力测试"></a>4、验证、压力测试</h2><h3 id="4-1-验证防盗链"><a href="#4-1-验证防盗链" class="headerlink" title="4.1 验证防盗链"></a>4.1 验证防盗链</h3><p>使用apache做为一个测试站点，域名为 <a href="http://www.test.com" target="_blank" rel="noopener">www.test.com</a> ，在测试页上做一个超链接，链接nginx站点的一张图片</p><figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="meta">@centos1</span> ~]<span class="comment"># cat /var/www/html/index.html </span></span><br><span class="line"><span class="variable">&lt;a href="http://www.benet.com/11.gif"&gt;</span>lianjie<span class="variable">&lt;/a&gt;</span></span><br></pre></td></tr></table></figure><p>Nginx站点的网页目录结如下</p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[<span class="symbol">root@</span>centos1 ~]# tree /usr/local/nginx1<span class="number">.10</span>/html/</span><br><span class="line">/usr/local/nginx1<span class="number">.10</span>/html/</span><br><span class="line">├── <span class="number">11.</span>gif</span><br><span class="line">├── <span class="number">50</span>x.html</span><br><span class="line">├── img</span><br><span class="line">│   └── nolink.jpg</span><br><span class="line">├── index.html</span><br><span class="line">├── test.php</span><br></pre></td></tr></table></figure><p>在客户端浏览器中输入 <a href="http://www.test.com" target="_blank" rel="noopener">www.test.com</a> (注意域名解析和防火墙)</p><p><img src="/2018/03/11/nginx-you-hua-yu-fang-dao-lian/%E5%9B%BE%E7%89%872.png" alt="image-20191118142516387"></p><p>点击页面链接</p><p><img src="/2018/03/11/nginx-you-hua-yu-fang-dao-lian/%E5%9B%BE%E7%89%873.png" alt="img"></p><p>从上图可以看到防盗链设置生效了</p><h3 id="4-2-验证gzip功能"><a href="#4-2-验证gzip功能" class="headerlink" title="4.2 验证gzip功能"></a>4.2 验证gzip功能</h3><p>使用谷歌浏览器测试访问，如下图显示结果：（提示：在访问测试页之前按F12键）</p><p><img src="/2018/03/11/nginx-you-hua-yu-fang-dao-lian/%E5%9B%BE%E7%89%874.png" alt="img"></p><p>用户访问test.php文件，在上图中content-encoding:gzip表明响应给用户的数据是压缩传输。</p><h3 id="4-3-压力测试"><a href="#4-3-压力测试" class="headerlink" title="4.3 压力测试"></a>4.3 压力测试</h3><p><strong>安装httpd-tools软件包，进行第一次压力测试</strong></p><blockquote><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[<span class="symbol">root@</span>www ~]# yum -y install httpd-tools</span><br><span class="line">[<span class="symbol">root@</span>www ~]# ab -c <span class="number">500</span> -n <span class="number">50000</span> http:<span class="comment">//www.benet.com/index.html</span></span><br></pre></td></tr></table></figure><p>This is ApacheBench, Version 2.3 &lt;$Revision: 1430300 $&gt;<br>Copyright 1996 Adam Twiss, Zeus Technology Ltd, <a href="http://www.zeustech.net/" target="_blank" rel="noopener">http://www.zeustech.net/</a><br>Licensed to The Apache Software Foundation, <a href="http://www.apache.org/" target="_blank" rel="noopener">http://www.apache.org/</a></p><p>Benchmarking <a href="http://www.benet.com" target="_blank" rel="noopener">www.benet.com</a> (be patient)<br>Completed 5000 requests<br>Completed 10000 requests<br>Completed 15000 requests<br>Completed 20000 requests<br>Completed 25000 requests<br>Completed 30000 requests<br>Completed 35000 requests<br>Completed 40000 requests<br>Completed 45000 requests<br>Completed 50000 requests<br>Finished 50000 requests</p><p>Server Software: IIS<br>Server Hostname: <a href="http://www.benet.com" target="_blank" rel="noopener">www.benet.com</a><br>Server Port: 80</p><p>Document Path: /index.html<br>Document Length: 612 bytes</p><p>Concurrency Level: 500<br>Time taken for tests: 5.734 seconds<br>Complete requests: 50000<br>Failed requests: 0<br>Write errors: 0<br>Total transferred: 41800000 bytes<br>HTML transferred: 30600000 bytes<br><font color="red">Requests per second: 8719.82 [#/sec] (mean)</font><br>Time per request: 57.341 [ms] (mean)<br>Time per request: 0.115 [ms] (mean, across all concurrent requests)<br>Transfer rate: 7118.92 [Kbytes/sec] received</p><p>Connection Times (ms)<br>min mean[+/-sd] median max<br>Connect: 1 25 4.2 25 38<br>Processing: 7 32 5.5 31 47<br>Waiting: 4 24 6.8 21 39<br>Total: 40 57 3.9 57 71</p><p>Percentage of the requests served within a certain time (ms)<br>50% 57<br>66% 59<br>75% 59<br>80% 60<br>90% 61<br>95% 62<br>98% 63<br>99% 64<br>100% 71 (longest request)</p></blockquote><p><strong>第二次压力测试，比较两次的差异</strong></p><blockquote><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[<span class="symbol">root@</span>www ~]# ab -c <span class="number">1000</span> -n <span class="number">100000</span> http:<span class="comment">//www.benet.com/index.html</span></span><br></pre></td></tr></table></figure><p>This is ApacheBench, Version 2.3 &lt;$Revision: 1430300 $&gt;<br>Copyright 1996 Adam Twiss, Zeus Technology Ltd, <a href="http://www.zeustech.net/" target="_blank" rel="noopener">http://www.zeustech.net/</a><br>Licensed to The Apache Software Foundation, <a href="http://www.apache.org/" target="_blank" rel="noopener">http://www.apache.org/</a></p><p>Benchmarking <a href="http://www.benet.com" target="_blank" rel="noopener">www.benet.com</a> (be patient)<br>Completed 10000 requests<br>Completed 20000 requests<br>Completed 30000 requests<br>Completed 40000 requests<br>Completed 50000 requests<br>Completed 60000 requests<br>Completed 70000 requests<br>Completed 80000 requests<br>Completed 90000 requests<br>Completed 100000 requests<br>Finished 100000 requests</p><p>Server Software: IIS<br>Server Hostname: <a href="http://www.benet.com" target="_blank" rel="noopener">www.benet.com</a><br>Server Port: 80</p><p>Document Path: /index.html<br>Document Length: 612 bytes</p><p>Concurrency Level: 1000<br>Time taken for tests: 12.010 seconds<br>Complete requests: 100000<br>Failed requests: 0<br>Write errors: 0<br>Total transferred: 83600000 bytes<br>HTML transferred: 61200000 bytes<br><font color="red">Requests per second: 8326.49 [#/sec] (mean)</font><br>Time per request: 120.099 [ms] (mean)<br>Time per request: 0.120 [ms] (mean, across all concurrent requests)<br>Transfer rate: 6797.80 [Kbytes/sec] received</p><p>Connection Times (ms)<br>min mean[+/-sd] median max<br>Connect: 1 53 8.9 53 82<br>Processing: 17 67 11.4 66 98<br>Waiting: 0 49 14.3 43 84<br>Total: 70 119 6.5 120 140</p><p>Percentage of the requests served within a certain time (ms)<br>50% 120<br>66% 122<br>75% 123<br>80% 124<br>90% 126<br>95% 128<br>98% 129<br>99% 130<br>100% 140 (longest request)</p></blockquote><h3 id="4-4-xcache加速php"><a href="#4-4-xcache加速php" class="headerlink" title="4.4 xcache加速php"></a>4.4 xcache加速php</h3><p><strong>安装xcache</strong></p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[<span class="symbol">root@</span>www ~]# wget http:<span class="comment">//xcache.lighttpd.net/pub/Releases/3.2.0/xcache-3.2.0.tar.gz #下载</span></span><br><span class="line">[<span class="symbol">root@</span>www ~]# tar zxf xcache<span class="number">-3.2</span><span class="number">.0</span>.tar.gz #解压</span><br><span class="line">[<span class="symbol">root@</span>www ~]# cd xcache<span class="number">-3.2</span><span class="number">.0</span>/ #进入安装目录</span><br><span class="line">[<span class="symbol">root@</span>www xcache<span class="number">-3.2</span><span class="number">.0</span>]# /usr/local/php5<span class="number">.6</span>/bin/phpize #用phpize生成configure配置文件</span><br><span class="line">[<span class="symbol">root@</span>www xcache<span class="number">-3.2</span><span class="number">.0</span>]# ./configure --enable-xcache --enable-xcache-coverager --enable-xcache-optimizer --with-php-config=/usr/local/php5<span class="number">.6</span>/bin/php-config  #配置</span><br><span class="line">[<span class="symbol">root@</span>www xcache<span class="number">-3.2</span><span class="number">.0</span>]# make &amp;&amp; make install  #编译、安装</span><br><span class="line">Installing <span class="keyword">shared</span> extensions: </span><br><span class="line">/usr/local/php5<span class="number">.6</span>/lib/php/extensions/no-debug-zts<span class="number">-20131226</span>/</span><br></pre></td></tr></table></figure><p>安装完成之后，出现下面的界面，记住以下路径，后面会用到</p><p>/usr/local/php5.6/lib/php/extensions/no-debug-zts-20131226/</p><p><strong>创建xcache缓存文件</strong></p><figure class="highlight vala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># touch /tmp/xcache</span></span><br><span class="line"><span class="meta"># chmod 777 /tmp/xcache</span></span><br></pre></td></tr></table></figure><p><strong>拷贝xcache后台管理程序到网站根目录</strong></p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[<span class="symbol">root@</span>www xcache<span class="number">-3.2</span><span class="number">.0</span>]# cp -r htdocs/ /usr/local/nginx1<span class="number">.10</span>/html/xcache</span><br></pre></td></tr></table></figure><p><strong>配置php支持xcache</strong></p><p>编辑配置文件，在最后一行添加以下内容</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">vi / etc/php.ini</span><br><span class="line"></span><br><span class="line">[xcache-common]</span><br><span class="line">extension = /usr/local/php5.<span class="number">6</span>/lib/php/extensions/no-debug-zts-<span class="number">20131226</span>/xcache.so</span><br><span class="line">[xcache.admin]</span><br><span class="line">xcache<span class="selector-class">.admin</span><span class="selector-class">.enable_auth</span> = Off</span><br><span class="line">[xcache]</span><br><span class="line">xcache<span class="selector-class">.shm_scheme</span> =<span class="string">"mmap"</span></span><br><span class="line">xcache.size=<span class="number">60</span>M</span><br><span class="line">xcache<span class="selector-class">.count</span> =<span class="number">1</span></span><br><span class="line">xcache<span class="selector-class">.slots</span> =<span class="number">8</span>K</span><br><span class="line">xcache.ttl=<span class="number">0</span></span><br><span class="line">xcache<span class="selector-class">.gc_interval</span> =<span class="number">0</span></span><br><span class="line">xcache.var_size=<span class="number">64</span>M</span><br><span class="line">xcache<span class="selector-class">.var_count</span> =<span class="number">1</span></span><br><span class="line">xcache<span class="selector-class">.var_slots</span> =<span class="number">8</span>K</span><br><span class="line">xcache.var_ttl=<span class="number">0</span></span><br><span class="line">xcache.var_maxttl=<span class="number">0</span></span><br><span class="line">xcache<span class="selector-class">.var_gc_interval</span> =<span class="number">300</span></span><br><span class="line">xcache<span class="selector-class">.test</span> =Off</span><br><span class="line">xcache<span class="selector-class">.readonly_protection</span> = Off</span><br><span class="line">xcache<span class="selector-class">.mmap_path</span> =<span class="string">"/tmp/xcache"</span></span><br><span class="line">xcache<span class="selector-class">.coredump_directory</span> =<span class="string">""</span></span><br><span class="line">xcache<span class="selector-class">.cacher</span> =On</span><br><span class="line">xcache.stat=On</span><br><span class="line">xcache<span class="selector-class">.optimizer</span> =Off</span><br><span class="line">[xcache.coverager]</span><br><span class="line">xcache<span class="selector-class">.coverager</span> =On</span><br><span class="line">xcache<span class="selector-class">.coveragedump_directory</span> =<span class="string">""</span></span><br></pre></td></tr></table></figure><p><strong>重启php-fpm</strong></p><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">service php-fpm restart</span></span><br></pre></td></tr></table></figure><p><strong>测试</strong></p><p>浏览器打开网站根目录下面的xcache</p><p><a href="http://www.benet.com/xcache" target="_blank" rel="noopener">http://www.benet.com/xcache</a> 可以看到如下页面：</p><p><img src="/2018/03/11/nginx-you-hua-yu-fang-dao-lian/%E5%9B%BE%E7%89%875.png" alt="image-20191118143155361"></p><p><strong>测试对php动态页面的压力测试</strong></p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[<span class="symbol">root@</span>www ~]# ab -c <span class="number">1000</span> -n <span class="number">100000</span> http:<span class="comment">//www.benet.com/test.php</span></span><br></pre></td></tr></table></figure><blockquote><p>This is ApacheBench, Version 2.3 &lt;$Revision: 1430300 $&gt;<br>Copyright 1996 Adam Twiss, Zeus Technology Ltd, <a href="http://www.zeustech.net/" target="_blank" rel="noopener">http://www.zeustech.net/</a><br>Licensed to The Apache Software Foundation, <a href="http://www.apache.org/" target="_blank" rel="noopener">http://www.apache.org/</a></p><p>Benchmarking <a href="http://www.benet.com" target="_blank" rel="noopener">www.benet.com</a> (be patient)<br>Completed 10000 requests<br>Completed 20000 requests<br>Completed 30000 requests<br>Completed 40000 requests<br>Completed 50000 requests<br>Completed 60000 requests<br>Completed 70000 requests<br>Completed 80000 requests<br>Completed 90000 requests<br>Completed 100000 requests<br>Finished 100000 requests</p><p>Server Software: IIS<br>Server Hostname: <a href="http://www.benet.com" target="_blank" rel="noopener">www.benet.com</a><br>Server Port: 80</p><p>Document Path: /test.php<br>Document Length: 85102 bytes</p><p>Concurrency Level: 1000<br>Time taken for tests: 13.686 seconds<br>Complete requests: 100000<br>Failed requests: 0<br>Write errors: 0<br>Total transferred: 8527900000 bytes<br>HTML transferred: 8510200000 bytes<br><font color="red">Requests per second: 7306.71 [#/sec] (mean)</font><br>Time per request: 136.861 [ms] (mean)<br>Time per request: 0.137 [ms] (mean, across all concurrent requests)<br>Transfer rate: 608504.46 [Kbytes/sec] received</p><p>Connection Times (ms)<br>min mean[+/-sd] median max<br>Connect: 0 17 5.5 17 81<br>Processing: 21 119 10.8 121 140<br>Waiting: 1 17 6.7 16 68<br>Total: 50 136 8.1 137 151</p><p>Percentage of the requests served within a certain time (ms)<br>50% 137<br>66% 139<br>75% 140<br>80% 141<br>90% 143<br>95% 144<br>98% 146<br>99% 148<br>100% 151 (longest request)</p></blockquote></div><div><div><div style="text-align:center;color:#ccc;font-size:14px">-------------本文结束<i class="fa fa-paw"></i>感谢您的阅读-------------</div></div></div><div></div><footer class="post-footer"><div class="post-tags"><a href="/tags/Nginx/" rel="tag"><i class="fa fa-tag"></i> Nginx</a></div><div class="post-nav"><div class="post-nav-next post-nav-item"><a href="/2018/03/02/nginx-fan-xiang-dai-li-huan-cun-fu-wu-bu-shu/" rel="next" title="Nginx 反向代理缓存服务"><i class="fa fa-chevron-left"></i> Nginx 反向代理缓存服务</a></div><span class="post-nav-divider"></span><div class="post-nav-prev post-nav-item"><a href="/2018/03/11/nginx-shi-yong-htpasswd-wei-wang-zhan-ti-gong-yong-hu-mi-ma-fang-wen/" rel="prev" title="Nginx 使用htpasswd为网站提供用户密码访问">Nginx 使用htpasswd为网站提供用户密码访问 <i class="fa fa-chevron-right"></i></a></div></div></footer></div></article><div class="post-spread"><div class="jiathis_style"><span class="jiathis_txt">分享到：</span> <a class="jiathis_button_fav">收藏夹</a> <a class="jiathis_button_copy">复制网址</a> <a class="jiathis_button_email">邮件</a> <a class="jiathis_button_weixin">微信</a> <a class="jiathis_button_qzone">QQ空间</a> <a class="jiathis_button_tqq">腾讯微博</a> <a class="jiathis_button_douban">豆瓣</a> <a class="jiathis_button_share">一键分享</a> <a href="http://www.jiathis.com/share?uid=2140465" class="jiathis jiathis_txt jiathis_separator jtico jtico_jiathis" target="_blank">更多</a> <a class="jiathis_counter_style"></a></div><script type="text/javascript">var jiathis_config={data_track_clickback:!0,summary:"",shortUrl:!1,hideMore:!1}</script><script type="text/javascript" src="http://v3.jiathis.com/code/jia.js?uid=" charset="utf-8"></script></div></div></div></div><div class="sidebar-toggle"><div class="sidebar-toggle-line-wrap"><span class="sidebar-toggle-line sidebar-toggle-line-first"></span> <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span> <span class="sidebar-toggle-line sidebar-toggle-line-last"></span></div></div><aside id="sidebar" class="sidebar"><div id="sidebar-dimmer"></div><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">文章目录</li><li class="sidebar-nav-overview" data-target="site-overview-wrap">站点概览</li></ul><section class="site-overview-wrap sidebar-panel"><div class="site-overview"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="site-author-image" itemprop="image" src="/images/chen.png" alt="Zhongzhou Chen"><p class="site-author-name" itemprop="name">Zhongzhou Chen</p><p class="site-description motion-element" itemprop="description"></p></div><nav class="site-state motion-element"><div class="site-state-item site-state-posts"><a href="/archives/%7C%7C%20archive"><span class="site-state-item-count">283</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"><a href="/categories/index.html"><span class="site-state-item-count">84</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"><a href="/tags/index.html"><span class="site-state-item-count">164</span> <span class="site-state-item-name">标签</span></a></div></nav><div class="feed-link motion-element"><a href="/atom.xml" rel="alternate"><i class="fa fa-rss"></i> RSS</a></div></div></section><section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active"><div class="post-toc"><div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#1、nginx-简介"><span class="nav-text">1、nginx 简介</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2、Nginx-的优化"><span class="nav-text">2、Nginx 的优化</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-1-编译安装前优化"><span class="nav-text">2.1 编译安装前优化</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#隐藏软件名称和版本号"><span class="nav-text">隐藏软件名称和版本号</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2-安装ngnix"><span class="nav-text">2.2 安装ngnix</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#测试是否隐藏了版本和软件名"><span class="nav-text">测试是否隐藏了版本和软件名</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-3-nginx配置项优化"><span class="nav-text">2.3 nginx配置项优化</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#2-3-1-Nginx运行工作进程个数，一般我们设置CPU的核心或者核心数x2"><span class="nav-text">2.3.1 Nginx运行工作进程个数，一般我们设置CPU的核心或者核心数x2</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-3-2-Nginx事件处理模型"><span class="nav-text">2.3.2 Nginx事件处理模型</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-3-3-开启高效传输模式"><span class="nav-text">2.3.3 开启高效传输模式</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-3-4-连接超时时间"><span class="nav-text">2.3.4 连接超时时间</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-3-5-fastcgi调优"><span class="nav-text">2.3.5 fastcgi调优</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-3-6-gzip调优"><span class="nav-text">2.3.6 gzip调优</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-3-7-expires缓存调优"><span class="nav-text">2.3.7 expires缓存调优</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-3-8-防盗链"><span class="nav-text">2.3.8 防盗链</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-3-9-内核参数优化"><span class="nav-text">2.3.9 内核参数优化</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-3-10-关于系统连接数的优化"><span class="nav-text">2.3.10 关于系统连接数的优化</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3、部署LNMP"><span class="nav-text">3、部署LNMP</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#3-1-安装php"><span class="nav-text">3.1 安装php</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-2-编译安装php"><span class="nav-text">3.2 编译安装php</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-3-提供php配置文件"><span class="nav-text">3.3 提供php配置文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-4-为php-fpm提供脚本"><span class="nav-text">3.4 为php-fpm提供脚本</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-5-提供php-fpm配置文件并编辑"><span class="nav-text">3.5 提供php-fpm配置文件并编辑</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4、验证、压力测试"><span class="nav-text">4、验证、压力测试</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#4-1-验证防盗链"><span class="nav-text">4.1 验证防盗链</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-2-验证gzip功能"><span class="nav-text">4.2 验证gzip功能</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-3-压力测试"><span class="nav-text">4.3 压力测试</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-4-xcache加速php"><span class="nav-text">4.4 xcache加速php</span></a></li></ol></li></ol></div></div></section><div class="back-to-top"><i class="fa fa-arrow-up"></i> <span id="scrollpercent"><span>0</span>%</span></div></div></aside></div></main><footer id="footer" class="footer"><div class="footer-inner"><script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script><div class="copyright">&copy; <span itemprop="copyrightYear">2021</span> <span class="with-love"><i class="fa fa-user"></i> </span><span class="author" itemprop="copyrightHolder">Zhongzhou Chen</span> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-area-chart"></i> </span><span class="post-meta-item-text">Site words total count&#58;</span> <span title="Site words total count">597.5k</span></div><span class="post-meta-divider"></span></div></footer></div><script type="text/javascript">"[object Function]"!==Object.prototype.toString.call(window.Promise)&&(window.Promise=null)</script><script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script><script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script><script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script><script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script><script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script><script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script><script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script><style>.copy-btn{display:inline-block;padding:6px 12px;font-size:13px;font-weight:700;line-height:20px;color:#333;white-space:nowrap;vertical-align:middle;cursor:pointer;background-color:#eee;background-image:linear-gradient(#fcfcfc,#eee);border:1px solid #d5d5d5;border-radius:3px;user-select:none;outline:0}.highlight-wrap .copy-btn{transition:opacity .3s ease-in-out;opacity:0;padding:2px 6px;position:absolute;right:4px;top:8px}.highlight-wrap .copy-btn:focus,.highlight-wrap:hover .copy-btn{opacity:1}.highlight-wrap{position:relative}</style><script>$(".highlight").each(function(t,e){var n=$("<div>").addClass("highlight-wrap");$(e).after(n),n.append($("<button>").addClass("copy-btn").append("复制").on("click",function(t){var e=$(this).parent().find(".code").find(".line").map(function(t,e){return $(e).text()}).toArray().join("\n"),n=document.createElement("textarea");document.body.appendChild(n),n.style.position="absolute",n.style.top="0px",n.style.left="0px",n.value=e,n.select(),n.focus();var o=document.execCommand("copy");document.body.removeChild(n),o?$(this).text("复制成功"):$(this).text("复制失败"),$(this).blur()})).on("mouseleave",function(t){var e=$(this).find(".copy-btn");setTimeout(function(){e.text("复制")},300)}).append(e)})</script><script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script><script type="text/javascript">function proceedsearch(){$("body").append('<div class="search-popup-overlay local-search-pop-overlay"></div>').css("overflow","hidden"),$(".search-popup-overlay").click(onPopupClose),$(".popup").toggle();var t=$("#local-search-input");t.attr("autocapitalize","none"),t.attr("autocorrect","off"),t.focus()}var isfetched=!1,isXml=!0,search_path="search.xml";0===search_path.length?search_path="search.xml":/json$/i.test(search_path)&&(isXml=!1);var path="/"+search_path,onPopupClose=function(t){$(".popup").hide(),$("#local-search-input").val(""),$(".search-result-list").remove(),$("#no-result").remove(),$(".local-search-pop-overlay").remove(),$("body").css("overflow","")},searchFunc=function(t,e,o){"use strict";$("body").append('<div class="search-popup-overlay local-search-pop-overlay"><div id="search-loading-icon"><i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i></div></div>').css("overflow","hidden"),$("#search-loading-icon").css("margin","20% auto 0 auto").css("text-align","center"),$.ajax({url:t,dataType:isXml?"xml":"json",async:!0,success:function(t){isfetched=!0,$(".popup").detach().appendTo(".header-inner");var n=isXml?$("entry",t).map(function(){return{title:$("title",this).text(),content:$("content",this).text(),url:$("url",this).text()}}).get():t,r=document.getElementById(e),s=document.getElementById(o),a=function(){var t=r.value.trim().toLowerCase(),e=t.split(/[\s\-]+/);e.length>1&&e.push(t);var o=[];if(t.length>0&&n.forEach(function(n){function r(e,o,n,r){for(var s=r[r.length-1],a=s.position,i=s.word,l=[],h=0;a+i.length<=n&&0!=r.length;){i===t&&h++,l.push({position:a,length:i.length});var p=a+i.length;for(r.pop();0!=r.length&&(s=r[r.length-1],a=s.position,i=s.word,p>a);)r.pop()}return c+=h,{hits:l,start:o,end:n,searchTextCount:h}}function s(t,e){var o="",n=e.start;return e.hits.forEach(function(e){o+=t.substring(n,e.position);var r=e.position+e.length;o+='<b class="search-keyword">'+t.substring(e.position,r)+"</b>",n=r}),o+=t.substring(n,e.end)}var a=!1,i=0,c=0,l=n.title.trim(),h=l.toLowerCase(),p=n.content.trim().replace(/<[^>]+>/g,""),u=p.toLowerCase(),f=decodeURIComponent(n.url),d=[],g=[];if(""!=l&&(e.forEach(function(t){function e(t,e,o){var n=t.length;if(0===n)return[];var r=0,s=[],a=[];for(o||(e=e.toLowerCase(),t=t.toLowerCase());(s=e.indexOf(t,r))>-1;)a.push({position:s,word:t}),r=s+n;return a}d=d.concat(e(t,h,!1)),g=g.concat(e(t,u,!1))}),(d.length>0||g.length>0)&&(a=!0,i=d.length+g.length)),a){[d,g].forEach(function(t){t.sort(function(t,e){return e.position!==t.position?e.position-t.position:t.word.length-e.word.length})});var v=[];0!=d.length&&v.push(r(l,0,l.length,d));for(var $=[];0!=g.length;){var C=g[g.length-1],m=C.position,x=C.word,w=m-20,y=m+80;0>w&&(w=0),y<m+x.length&&(y=m+x.length),y>p.length&&(y=p.length),$.push(r(p,w,y,g))}$.sort(function(t,e){return t.searchTextCount!==e.searchTextCount?e.searchTextCount-t.searchTextCount:t.hits.length!==e.hits.length?e.hits.length-t.hits.length:t.start-e.start});var T=parseInt("1");T>=0&&($=$.slice(0,T));var b="";b+=0!=v.length?"<li><a href='"+f+"' class='search-result-title'>"+s(l,v[0])+"</a>":"<li><a href='"+f+"' class='search-result-title'>"+l+"</a>",$.forEach(function(t){b+="<a href='"+f+'\'><p class="search-result">'+s(p,t)+"...</p></a>"}),b+="</li>",o.push({item:b,searchTextCount:c,hitCount:i,id:o.length})}}),1===e.length&&""===e[0])s.innerHTML='<div id="no-result"><i class="fa fa-search fa-5x" /></div>';else if(0===o.length)s.innerHTML='<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>';else{o.sort(function(t,e){return t.searchTextCount!==e.searchTextCount?e.searchTextCount-t.searchTextCount:t.hitCount!==e.hitCount?e.hitCount-t.hitCount:e.id-t.id});var a='<ul class="search-result-list">';o.forEach(function(t){a+=t.item}),a+="</ul>",s.innerHTML=a}};r.addEventListener("input",a),$(".local-search-pop-overlay").remove(),$("body").css("overflow",""),proceedsearch()}})};$(".popup-trigger").click(function(t){t.stopPropagation(),isfetched===!1?searchFunc(path,"local-search-input","local-search-result"):proceedsearch()}),$(".popup-btn-close").click(onPopupClose),$(".popup").click(function(t){t.stopPropagation()}),$(document).on("keyup",function(t){var e=27===t.which&&$(".search-popup").is(":visible");e&&onPopupClose()})</script><script type="text/javascript" src="/js/src/love.js"></script><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"log":false,"model":{"jsonPath":"/live2dw/assets/shizuku.model.json"},"display":{"position":"right"},"mobile":{"show":true,"scale":0.5},"react":{"opacityDefault":0.7,"opacityOnHover":0.2}});</script></body></html><!-- rebuild by neat -->