<!DOCTYPE html><html class="theme-next gemini use-motion" lang="zh-Hans"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><script src="//cdn.bootcss.com/pace/1.0.2/pace.min.js"></script><link href="//cdn.bootcss.com/pace/1.0.2/themes/pink/pace-theme-flash.css" rel="stylesheet"><script></script><meta name="theme-color" content="#222"><style>.pace .pace-progress{background:#1e92fb;height:3px}.pace .pace-progress-inner{box-shadow:0 0 10px #1e92fb,0 0 5px #1e92fb}.pace .pace-activity{border-top-color:#1e92fb;border-left-color:#1e92fb}</style><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><meta name="google-site-verification" content="HGM141IpbHrSmnAmR6W_zE4bo9Z3f-yXLeHYT3bg1fk"><meta name="baidu-site-verification" content="code-5Ai1DA8e6T"><link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css"><link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css"><link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4"><link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222"><meta name="keywords" content="OpenLDAP,LDAP,"><link rel="alternate" href="/atom.xml" title="凡间的精灵" type="application/atom+xml"><meta name="description" content="一、前言Openldap为啥要加密​ Openldap默认使用简单验证，对slapd的所有访问都使用明文密码通过未加密通道进行。为了确保信息安全，需要对信息进行加密传输，SSL(Secure Sockets Layer)是一个可靠的解决方案。​ 它使用X.509证书，由可信任第三方（Certificate Authority(CA)）进行数字签名的一个标准格式的数据。有效的数字签名意味着已签名的数"><meta name="keywords" content="OpenLDAP,LDAP"><meta property="og:type" content="article"><meta property="og:title" content="OpenLDAP 开启SSL&#x2F;TLS加密通信"><meta property="og:url" content="http:&#x2F;&#x2F;chenzhonzhou.github.io&#x2F;2022&#x2F;08&#x2F;17&#x2F;openldap-kai-qi-ssl-tls-jia-mi-tong-xin&#x2F;index.html"><meta property="og:site_name" content="凡间的精灵"><meta property="og:description" content="一、前言Openldap为啥要加密​ Openldap默认使用简单验证，对slapd的所有访问都使用明文密码通过未加密通道进行。为了确保信息安全，需要对信息进行加密传输，SSL(Secure Sockets Layer)是一个可靠的解决方案。​ 它使用X.509证书，由可信任第三方（Certificate Authority(CA)）进行数字签名的一个标准格式的数据。有效的数字签名意味着已签名的数"><meta property="og:locale" content="zh-Hans"><meta property="og:image" content="http:&#x2F;&#x2F;chenzhonzhou.github.io&#x2F;2022&#x2F;08&#x2F;17&#x2F;openldap-kai-qi-ssl-tls-jia-mi-tong-xin&#x2F;%E5%9B%BE%E7%89%871.png"><meta property="og:image" content="http:&#x2F;&#x2F;chenzhonzhou.github.io&#x2F;2022&#x2F;08&#x2F;17&#x2F;openldap-kai-qi-ssl-tls-jia-mi-tong-xin&#x2F;%E5%9B%BE%E7%89%872.png"><meta property="og:updated_time" content="2022-08-18T07:16:34.940Z"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="http:&#x2F;&#x2F;chenzhonzhou.github.io&#x2F;2022&#x2F;08&#x2F;17&#x2F;openldap-kai-qi-ssl-tls-jia-mi-tong-xin&#x2F;%E5%9B%BE%E7%89%871.png"><script type="text/javascript" id="hexo.configurations">var NexT=window.NexT||{},CONFIG={root:"/",scheme:"Gemini",version:"5.1.4",sidebar:{position:"left",display:"always",offset:12,b2t:!0,scrollpercent:!0,onmobile:!0},fancybox:!0,tabs:!0,motion:{enable:!0,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}},duoshuo:{userId:"0",author:"博主"},algolia:{applicationID:"",apiKey:"",indexName:"",hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}}}</script><link rel="canonical" href="http://chenzhonzhou.github.io/2022/08/17/openldap-kai-qi-ssl-tls-jia-mi-tong-xin/"><title>OpenLDAP 开启SSL/TLS加密通信 | 凡间的精灵</title><link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css"></head><body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans"><div class="container sidebar-position-left page-post-detail"><div class="headband"></div><header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-wrapper"><div class="site-meta"><div class="custom-logo-site-title"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">凡间的精灵</span><span class="logo-line-after"><i></i></span></a></div><p class="site-subtitle">凡尘落素一精灵</p></div><div class="site-nav-toggle"><button><span class="btn-bar"></span><span class="btn-bar"></span><span class="btn-bar"></span></button></div></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i><br>首页</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i><br>归档</a></li><li class="menu-item menu-item-categories"><a href="/categories" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i><br>分类</a></li><li class="menu-item menu-item-tags"><a href="/tags" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i><br>标签</a></li><li class="menu-item menu-item-sitemap"><a href="/sitemap.xml" rel="section"><i class="menu-item-icon fa fa-fw fa-sitemap"></i><br>站点地图</a></li><li class="menu-item menu-item-search"><a href="javascript:;" class="popup-trigger"><i class="menu-item-icon fa fa-search fa-fw"></i><br>搜索</a></li></ul><div class="site-search"><div class="popup search-popup local-search-popup"><div class="local-search-header clearfix"><span class="search-icon"><i class="fa fa-search"></i></span><span class="popup-btn-close"><i class="fa fa-times-circle"></i></span><div class="local-search-input-wrapper"><input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input"></div></div><div id="local-search-result"></div></div></div></nav></div></header><main id="main" class="main"><div class="main-inner"><div class="content-wrap"><div id="content" class="content"><div id="posts" class="posts-expand"><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><div class="post-block"><link itemprop="mainEntityOfPage" href="http://chenzhonzhou.github.io/2022/08/17/openldap-kai-qi-ssl-tls-jia-mi-tong-xin/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="name" content="Zhongzhou Chen"><meta itemprop="description" content=""><meta itemprop="image" content="/images/chen.png"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="凡间的精灵"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">OpenLDAP 开启SSL/TLS加密通信</h1><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i></span> <span class="post-meta-item-text">发表于</span> <time title="创建于" itemprop="dateCreated datePublished" datetime="2022-08-17T11:34:27+08:00">2022-08-17</time></span> <span class="post-category"><span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-folder-o"></i></span> <span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/LDAP/" itemprop="url" rel="index"><span itemprop="name">LDAP</span></a></span> ， <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/LDAP/OpenLDAP/" itemprop="url" rel="index"><span itemprop="name">OpenLDAP</span></a></span></span><div class="post-wordcount"><span class="post-meta-item-icon"><i class="fa fa-file-word-o"></i></span> <span class="post-meta-item-text">字数统计&#58;</span> <span title="字数统计">3.3k</span> <span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-clock-o"></i></span> <span class="post-meta-item-text">阅读时长 &asymp;</span> <span title="阅读时长">18</span></div></div></header><div class="post-body" itemprop="articleBody"><h2 id="一、前言"><a href="#一、前言" class="headerlink" title="一、前言"></a>一、前言</h2><h3 id="Openldap为啥要加密"><a href="#Openldap为啥要加密" class="headerlink" title="Openldap为啥要加密"></a>Openldap为啥要加密</h3><p>​ Openldap默认使用简单验证，对slapd的所有访问都使用明文密码通过未加密通道进行。为了确保信息安全，需要对信息进行加密传输，SSL(Secure Sockets Layer)是一个可靠的解决方案。</p><p>​ 它使用X.509证书，由可信任第三方（Certificate Authority(CA)）进行数字签名的一个标准格式的数据。有效的数字签名意味着已签名的数据没有被篡改。如果签名的数据被更改，将不会通过验证。</p><h3 id="SSL-TLS加密原理简介"><a href="#SSL-TLS加密原理简介" class="headerlink" title="SSL/TLS加密原理简介"></a>SSL/TLS加密原理简介</h3><p>​ SSL/TLS是基于PKI机制的加密方式，包括证书认证、密钥交换、非对称加密、对称加密。SSL/TLS采用CA作为服务端核客户端都信赖的具有权威性的组织，证书的颁发和认证都依赖于CA，并假定CA颁发的证书是可靠的、可信赖的，证书里面的内容是真实的、有效的，并可用于客户机和服务器进行安全的可靠的通信加密。</p><p>​ SSL/TLS证书用来认证服务器和客户机双方的身份，并用于密钥交换的非对称加密。密钥交换完毕之后，就可以用这个密钥做通信数据的对称加密了，具体的加密算法是由客户机和服务器相互协商得来的。服务器和客户机由于SSL/TLS库的不同以及用户的配置不同，双方支持的算法列表不完全相同，当双方做SSL/TLS握手的时候，就需要将自己支持的算法列表以及优先顺序告知对方，一旦对方按照优先顺序找到了第一个支持的算法，那么协商完成，否则双方协商失败，SSL/TLS连接断开。</p><h2 id="二、自生成证书"><a href="#二、自生成证书" class="headerlink" title="二、自生成证书"></a>二、自生成证书</h2><h2 id="2-1-自建-CA-中心"><a href="#2-1-自建-CA-中心" class="headerlink" title="2.1 自建 CA 中心"></a>2.1 自建 CA 中心</h2><h3 id="2-1-1-CA中心生成自身私钥"><a href="#2-1-1-CA中心生成自身私钥" class="headerlink" title="2.1.1 CA中心生成自身私钥"></a>2.1.1 CA中心生成自身私钥</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost openldap]# cd /etc/pki/CA</span><br><span class="line">[root@localhost CA]# openssl genrsa -out private/cakey.pem 2048</span><br><span class="line">Generating RSA private key, 2048 bit long modulus</span><br><span class="line">............+++</span><br><span class="line">....................+++</span><br><span class="line">e is 65537 (0x10001)</span><br></pre></td></tr></table></figure><h3 id="2-1-2-CA签发自身公钥"><a href="#2-1-2-CA签发自身公钥" class="headerlink" title="2.1.2 CA签发自身公钥"></a>2.1.2 CA签发自身公钥</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost CA]# openssl  req -new -x509 -key private/cakey.pem -out cacert.pem -days 3650</span><br><span class="line">You are about to be asked to enter information that will be incorporated</span><br><span class="line">into your certificate request.</span><br><span class="line">What you are about to enter is what is called a Distinguished Name or a DN.</span><br><span class="line">There are quite a few fields but you can leave some blank</span><br><span class="line">For some fields there will be a default value,</span><br><span class="line">If you enter '.', the field will be left blank.</span><br><span class="line">-----</span><br><span class="line">Country Name (2 letter code) [XX]:CN</span><br><span class="line">State or Province Name (full name) []:BeiJing</span><br><span class="line">Locality Name (eg, city) [Default City]:BeiJing</span><br><span class="line">Organization Name (eg, company) [Default Company Ltd]:sys.com</span><br><span class="line">Organizational Unit Name (eg, section) []:Devops</span><br><span class="line">Common Name (eg, your name or your server's hostname) []:ldap.sys.com</span><br><span class="line">Email Address []:ldap@sys.com</span><br></pre></td></tr></table></figure><p>信息可以随便填写，但后面生成LDAP证书的时候需要和这里的信息保持一致</p><h3 id="2-1-3-创建index-txt和serial文件"><a href="#2-1-3-创建index-txt和serial文件" class="headerlink" title="2.1.3 创建index.txt和serial文件"></a>2.1.3 创建index.txt和serial文件</h3><p>index.txt 文件用于存放客户端证书信息，serial 文件用于存放客户端证书编号，可以自定义，用于识别客户端证书</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost CA]# touch serial index.txt</span><br><span class="line">[root@localhost CA]# echo "01" &gt; serial</span><br></pre></td></tr></table></figure><h3 id="2-1-4-使用openssl命令获取证书信息"><a href="#2-1-4-使用openssl命令获取证书信息" class="headerlink" title="2.1.4 使用openssl命令获取证书信息"></a>2.1.4 使用openssl命令获取证书信息</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost CA]# openssl x509 -noout -text -in /etc/pki/CA/cacert.pem</span><br><span class="line">Certificate:</span><br><span class="line">    Data:</span><br><span class="line">        Version: 3 (0x2)</span><br><span class="line">        Serial Number:</span><br><span class="line">            99:9d:0e:5e:77:51:2c:38</span><br><span class="line">    Signature Algorithm: sha256WithRSAEncryption</span><br><span class="line">        Issuer: C=CN, ST=BeiJing, L=BeiJing, O=sys.com, OU=Devops, CN=ldap.sys.com/emailAddress=ldap@sys.com</span><br><span class="line">        Validity</span><br><span class="line">            Not Before: Aug 17 09:07:28 2022 GMT</span><br><span class="line">            Not After : Aug 14 09:07:28 2032 GMT</span><br><span class="line">        Subject: C=CN, ST=BeiJing, L=BeiJing, O=sys.com, OU=Devops, CN=ldap.sys.com/emailAddress=ldap@sys.com</span><br><span class="line">        Subject Public Key Info:</span><br><span class="line">            Public Key Algorithm: rsaEncryption</span><br><span class="line">                Public-Key: (2048 bit)</span><br><span class="line">                Modulus:</span><br><span class="line">                    00:a6:08:87:0e:0b:cb:85:8b:ef:03:1e:c9:5c:ed:</span><br><span class="line">                    eb:b3:02:77:dd:4d:ad:4b:b5:ca:b3:7c:8c:03:12:</span><br><span class="line">                    63:c5:8c:89:1e:a4:15:c9:4c:c1:68:e0:8c:74:3d:</span><br><span class="line">                    9b:2b:a2:8e:cf:ad:3c:40:42:e7:ff:e8:27:b7:98:</span><br><span class="line">                    73:99:2d:33:b6:c9:39:ce:62:07:cd:ae:65:ea:c2:</span><br><span class="line">                    7a:0a:eb:84:ff:42:db:56:da:e1:6a:ef:fb:fc:29:</span><br><span class="line">                    75:73:1d:00:15:e5:04:f2:fe:d4:4e:f5:00:08:29:</span><br><span class="line">                    b8:f9:89:41:7d:c8:a5:61:ef:10:8f:5d:29:ce:d3:</span><br><span class="line">                    d6:c2:d9:33:4c:ab:e1:d5:49:90:51:b7:3f:a4:6f:</span><br><span class="line">                    7b:6c:2d:1a:8e:8f:73:a6:af:c7:7d:c4:58:7d:36:</span><br><span class="line">                    d4:e7:eb:4c:1a:ba:23:9d:ac:6b:30:54:ba:0a:fb:</span><br><span class="line">                    13:1b:27:7a:a7:f5:ad:3f:e6:be:8b:f7:a3:52:a5:</span><br><span class="line">                    05:23:42:24:56:ba:7d:80:ce:81:fb:00:05:89:19:</span><br><span class="line">                    31:f1:19:66:a7:a8:57:98:5b:5d:b6:9e:4c:bf:a3:</span><br><span class="line">                    15:25:1c:e9:76:cd:84:48:50:0b:e8:f8:cf:df:cb:</span><br><span class="line">                    1e:69:aa:7e:51:73:f6:e8:59:3c:bb:d4:0d:a1:a7:</span><br><span class="line">                    22:3f:54:b2:ae:7c:ea:33:d3:75:64:94:52:aa:2e:</span><br><span class="line">                    b5:33</span><br><span class="line">                Exponent: 65537 (0x10001)</span><br><span class="line">        X509v3 extensions:</span><br><span class="line">            X509v3 Subject Key Identifier:</span><br><span class="line">                15:E1:DF:F5:24:B8:F2:AD:C2:93:0B:92:48:E6:EC:A8:D5:25:88:B8</span><br><span class="line">            X509v3 Authority Key Identifier:</span><br><span class="line">                keyid:15:E1:DF:F5:24:B8:F2:AD:C2:93:0B:92:48:E6:EC:A8:D5:25:88:B8</span><br><span class="line"></span><br><span class="line">            X509v3 Basic Constraints:</span><br><span class="line">                CA:TRUE</span><br><span class="line">    Signature Algorithm: sha256WithRSAEncryption</span><br><span class="line">         01:2e:84:f1:ee:ce:99:b1:77:1b:f3:b4:ab:21:80:8a:8a:04:</span><br><span class="line">         16:23:f9:48:85:d5:db:bf:d1:00:d8:2f:7f:2c:b8:e5:1e:6b:</span><br><span class="line">         0f:f7:10:41:b2:a4:75:84:bf:0b:b6:eb:97:3e:06:07:30:f6:</span><br><span class="line">         c7:f2:6f:9c:ed:9a:0e:70:fd:14:cc:a4:34:b9:ef:a8:69:a7:</span><br><span class="line">         c4:f3:ff:00:b2:2d:c6:ac:3a:35:86:58:25:2a:be:0c:4f:20:</span><br><span class="line">         52:91:98:f3:06:33:79:ce:c7:cb:8c:a2:a3:ca:6d:2a:60:94:</span><br><span class="line">         1d:97:38:d1:f5:55:f6:db:30:ff:67:85:c7:0e:7f:08:eb:88:</span><br><span class="line">         e0:30:b1:f9:6e:01:a8:fa:16:53:53:12:62:af:ca:35:cf:85:</span><br><span class="line">         e2:be:7c:39:70:57:7b:06:19:4a:aa:8a:12:8a:e7:3f:a9:dd:</span><br><span class="line">         11:f4:45:96:6f:1c:82:90:62:bb:24:57:a5:cc:a8:99:96:80:</span><br><span class="line">         8c:48:75:34:94:05:e2:42:9c:64:81:11:d9:f2:1c:c7:c2:4c:</span><br><span class="line">         fa:ad:16:23:7d:ba:a0:26:fc:b5:df:df:5d:34:6d:1c:39:61:</span><br><span class="line">         e2:45:e2:0d:00:22:a2:89:72:d2:25:e0:b0:c0:25:70:8f:bf:</span><br><span class="line">         e3:4c:a9:bd:a5:60:67:d6:d3:77:a2:aa:6e:92:2f:cb:17:fb:</span><br><span class="line">         a4:ef:b2:d3</span><br></pre></td></tr></table></figure><h2 id="2-2-生成-LDAP-证书"><a href="#2-2-生成-LDAP-证书" class="headerlink" title="2.2 生成 LDAP 证书"></a>2.2 生成 LDAP 证书</h2><h3 id="2-2-1-获取LDAP证书"><a href="#2-2-1-获取LDAP证书" class="headerlink" title="2.2.1 获取LDAP证书"></a>2.2.1 获取LDAP证书</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost CA]# mkdir /etc/openldap/ssl</span><br><span class="line">[root@localhost CA]# cd /etc/openldap/ssl</span><br></pre></td></tr></table></figure><p>生成服务端密钥</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ssl]# openssl genrsa -out ldapkey.pem 2048</span><br><span class="line">Generating RSA private key, 2048 bit long modulus</span><br><span class="line">....................................+++</span><br><span class="line">......................................................+++</span><br><span class="line">e is 65537 (0x10001)</span><br></pre></td></tr></table></figure><p>服务端向CA中心申请证书签署请求，相关信息必须和CA所填写一致才可以正常签发</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ssl]# openssl req -new -key ldapkey.pem -out ldap.csr -days 3650</span><br></pre></td></tr></table></figure><h3 id="2-2-2-生成LDAP证书"><a href="#2-2-2-生成LDAP证书" class="headerlink" title="2.2.2 生成LDAP证书"></a>2.2.2 生成LDAP证书</h3><p>CA检测用户请求，通过后生成证书</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ssl]# openssl ca -in ldap.csr -out ldapcert.pem -days 3650</span><br><span class="line">Using configuration from /etc/pki/tls/openssl.cnf</span><br><span class="line">Check that the request matches the signature</span><br><span class="line">Signature ok</span><br><span class="line">Certificate Details:</span><br><span class="line">        Serial Number: 1 (0x1)</span><br><span class="line">        Validity</span><br><span class="line">            Not Before: Aug 17 09:26:34 2022 GMT</span><br><span class="line">            Not After : Aug 14 09:26:34 2032 GMT</span><br><span class="line">        Subject:</span><br><span class="line">            countryName               = CN</span><br><span class="line">            stateOrProvinceName       = BeiJing</span><br><span class="line">            organizationName          = sys.com</span><br><span class="line">            organizationalUnitName    = Devops</span><br><span class="line">            commonName                = ldap.sys.com</span><br><span class="line">            emailAddress              = ldap@sys.com</span><br><span class="line">        X509v3 extensions:</span><br><span class="line">            X509v3 Basic Constraints:</span><br><span class="line">                CA:FALSE</span><br><span class="line">            Netscape Comment:</span><br><span class="line">                OpenSSL Generated Certificate</span><br><span class="line">            X509v3 Subject Key Identifier:</span><br><span class="line">                AD:14:68:D1:B3:1D:4E:34:5A:EA:B0:F5:78:74:C8:51:0B:D8:83:E7</span><br><span class="line">            X509v3 Authority Key Identifier:</span><br><span class="line">                keyid:15:E1:DF:F5:24:B8:F2:AD:C2:93:0B:92:48:E6:EC:A8:D5:25:88:B8</span><br><span class="line"></span><br><span class="line">Certificate is to be certified until Aug 14 09:26:34 2032 GMT (3650 days)</span><br><span class="line">Sign the certificate? [y/n]:y</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">1 out of 1 certificate requests certified, commit? [y/n]y</span><br><span class="line">Write out database with 1 new entries</span><br><span class="line">Data Base Updated</span><br></pre></td></tr></table></figure><h3 id="2-2-3-验证证书"><a href="#2-2-3-验证证书" class="headerlink" title="2.2.3 验证证书"></a>2.2.3 验证证书</h3><p>成功生成证书后，可以 openssl 验证服务端证书的合法性</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ssl]# openssl verify -CAfile /etc/pki/CA/cacert.pem /etc/openldap/ssl/ldapcert.pem</span><br><span class="line">/etc/openldap/ssl/ldapcert.pem: OK</span><br></pre></td></tr></table></figure><h3 id="2-2-4-准备证书文件"><a href="#2-2-4-准备证书文件" class="headerlink" title="2.2.4 准备证书文件"></a>2.2.4 准备证书文件</h3><p>后面ldap开启SSL需要使用到<code>cacert.pem</code>,<code>ldapcert.pem</code>,<code>ldapkey.pem</code></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ssl]# cp /etc/pki/CA/cacert.pem /etc/openldap/ssl/</span><br><span class="line">[root@localhost ssl]# ls /etc/openldap/ssl/</span><br><span class="line">cacert.pem  ldapcert.pem  ldap.csr  ldapkey.pem</span><br></pre></td></tr></table></figure><h2 id="三、OpenLDAP-开启-SSL"><a href="#三、OpenLDAP-开启-SSL" class="headerlink" title="三、OpenLDAP 开启 SSL"></a>三、OpenLDAP 开启 SSL</h2><h3 id="3-1-自建-OpenLDAP"><a href="#3-1-自建-OpenLDAP" class="headerlink" title="3.1 自建 OpenLDAP"></a>3.1 自建 OpenLDAP</h3><p>这里以我之前手动部署了一个openldap 2.4.44为例，开启SSL，不需要重新生成数据直接开启SSL就行</p><p>OpenLDAP 2.5版本开始支持很多新功能，像<code>多重身份认证</code>,<code>密码过期提醒</code>等，更多信息可前往<a href="https://www.openldap.org/software/roadmap.html" target="_blank" rel="noopener">官网</a>查看</p><h4 id="3-1-1-创建ssl的ldif配置文件"><a href="#3-1-1-创建ssl的ldif配置文件" class="headerlink" title="3.1.1 创建ssl的ldif配置文件"></a>3.1.1 创建ssl的ldif配置文件</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost schema]# vim enable_ssl.ldif</span><br><span class="line">dn: cn=config</span><br><span class="line">changetype: modify</span><br><span class="line">replace: olcTLSCACertificateFile</span><br><span class="line">olcTLSCACertificateFile: /etc/openldap/ssl/cacert.pem</span><br><span class="line">-</span><br><span class="line">replace: olcTLSCertificateFile</span><br><span class="line">olcTLSCertificateFile: /etc/openldap/ssl/ldapcert.pem</span><br><span class="line">-</span><br><span class="line">replace: olcTLSCertificateKeyFile</span><br><span class="line">olcTLSCertificateKeyFile: /etc/openldap/ssl/ldapkey.pem</span><br><span class="line">-</span><br><span class="line">add: olcTLSVerifyClient</span><br><span class="line">olcTLSVerifyClient: never</span><br></pre></td></tr></table></figure><h4 id="3-1-2-导入ssl配置"><a href="#3-1-2-导入ssl配置" class="headerlink" title="3.1.2 导入ssl配置"></a>3.1.2 导入ssl配置</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost schema]# ldapmodify -Y EXTERNAL -H ldapi:/// -D "cn=admin,dc=sys,dc=com" -w Abc.123456 -f enable_ssl.ldif</span><br><span class="line">SASL/EXTERNAL authentication started</span><br><span class="line">SASL username: gidNumber=0+uidNumber=0,cn=peercred,cn=external,cn=auth</span><br><span class="line">SASL SSF: 0</span><br><span class="line">modifying entry "cn=config"</span><br></pre></td></tr></table></figure><h4 id="3-1-3-配置只开启ldaps"><a href="#3-1-3-配置只开启ldaps" class="headerlink" title="3.1.3 配置只开启ldaps"></a>3.1.3 配置只开启ldaps</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost schema]# vim /etc/sysconfig/slapd</span><br><span class="line">SLAPD_URLS="ldapi:/// ldaps:///"</span><br></pre></td></tr></table></figure><h4 id="3-1-4-重启slapd服务"><a href="#3-1-4-重启slapd服务" class="headerlink" title="3.1.4 重启slapd服务"></a>3.1.4 重启slapd服务</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost schema]# systemctl restart slapd</span><br><span class="line">[root@localhost schema]# netstat -ntpl</span><br><span class="line">Active Internet connections (only servers)</span><br><span class="line">Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name</span><br><span class="line">tcp        0      0 0.0.0.0:22              0.0.0.0:*               LISTEN      957/sshd</span><br><span class="line">tcp        0      0 127.0.0.1:25            0.0.0.0:*               LISTEN      1152/master</span><br><span class="line">tcp        0      0 0.0.0.0:636             0.0.0.0:*               LISTEN      5650/slapd</span><br></pre></td></tr></table></figure><p>已经开启了636端口</p><h4 id="3-1-5-测试连接"><a href="#3-1-5-测试连接" class="headerlink" title="3.1.5 测试连接"></a>3.1.5 测试连接</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">#命令行连接需要开启</span></span></span><br><span class="line">[root@localhost schema]# echo "TLS_REQCERT allow" &gt;&gt; /etc/openldap/ldap.conf</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">#测试是否可以匿名访问，关闭匿名访问可以参考我的另一篇OpenLDAP 禁止匿名访问</span></span></span><br><span class="line">[root@localhost schema]# ldapwhoami -v -x -Z</span><br><span class="line">ldap_initialize( &lt;DEFAULT&gt; )</span><br><span class="line">anonymous</span><br><span class="line">Result: Success (0)</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">#测试连接</span></span></span><br><span class="line">[root@localhost schema]# ldapwhoami -D "cn=admin,dc=sys,dc=com" -w Abc.123456 -H ldaps://192.168.126.145:636 -v</span><br><span class="line">ldap_initialize( ldaps://192.168.126.145:636/??base )</span><br><span class="line">dn:cn=admin,dc=sys,dc=com</span><br><span class="line">Result: Success (0)</span><br><span class="line">[root@localhost schema]#</span><br></pre></td></tr></table></figure><p>可以正常连接ldap，说明配置成功了<br>同时也可以测试当前套接字是否能通过CA的验证</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost schema]# openssl s_client -connect 192.168.126.145:636 -showcerts -state -CAfile /etc/openldap/ssl/cacert.pem</span><br><span class="line">CONNECTED(00000003)</span><br><span class="line">SSL_connect:before/connect initialization</span><br><span class="line">SSL_connect:SSLv2/v3 write client hello A</span><br><span class="line">SSL_connect:SSLv3 read server hello A</span><br><span class="line">depth=1 C = CN, ST = BeiJing, L = BeiJing, O = sys.com, OU = Devops, CN = ldap.sys.com, emailAddress = ldap@sys.com</span><br><span class="line">verify return:1</span><br><span class="line">depth=0 C = CN, ST = BeiJing, O = sys.com, OU = Devops, CN = ldap.sys.com, emailAddress = ldap@sys.com</span><br><span class="line">verify return:1</span><br><span class="line">SSL_connect:SSLv3 read server certificate A</span><br><span class="line">SSL_connect:SSLv3 read server done A</span><br><span class="line">SSL_connect:SSLv3 write client key exchange A</span><br><span class="line">SSL_connect:SSLv3 write change cipher spec A</span><br><span class="line">SSL_connect:SSLv3 write finished A</span><br><span class="line">SSL_connect:SSLv3 flush data</span><br><span class="line">SSL_connect:SSLv3 read server session ticket A</span><br><span class="line">SSL_connect:SSLv3 read finished A</span><br><span class="line">---</span><br><span class="line">Certificate chain</span><br><span class="line"> 0 s:/C=CN/ST=BeiJing/O=sys.com/OU=Devops/CN=ldap.sys.com/emailAddress=ldap@sys.com</span><br><span class="line">   i:/C=CN/ST=BeiJing/L=BeiJing/O=sys.com/OU=Devops/CN=ldap.sys.com/emailAddress=ldap@sys.com</span><br><span class="line">-----BEGIN CERTIFICATE-----</span><br><span class="line">MIID9TCCAt2gAwIBAgIBATANBgkqhkiG9w0BAQsFADCBiDELMAkGA1UEBhMCQ04x</span><br><span class="line">EDAOBgNVBAgMB0JlaUppbmcxEDAOBgNVBAcMB0JlaUppbmcxEDAOBgNVBAoMB3N5</span><br><span class="line">cy5jb20xDzANBgNVBAsMBkRldm9wczEVMBMGA1UEAwwMbGRhcC5zeXMuY29tMRsw</span><br><span class="line">GQYJKoZIhvcNAQkBFgxsZGFwQHN5cy5jb20wHhcNMjIwODE3MDkyNjM0WhcNMzIw</span><br><span class="line">ODE0MDkyNjM0WjB2MQswCQYDVQQGEwJDTjEQMA4GA1UECAwHQmVpSmluZzEQMA4G</span><br><span class="line">A1UECgwHc3lzLmNvbTEPMA0GA1UECwwGRGV2b3BzMRUwEwYDVQQDDAxsZGFwLnN5</span><br><span class="line">cy5jb20xGzAZBgkqhkiG9w0BCQEWDGxkYXBAc3lzLmNvbTCCASIwDQYJKoZIhvcN</span><br><span class="line">AQEBBQADggEPADCCAQoCggEBANLIIW1esDMAfv/WVFMvHWjeOfkzHxj7U3Npi5o6</span><br><span class="line">m/TYY7tklQYVLl+qdXhVyqOFIxPqISDaIov/33ubgI+2QS6YAGUtaXiNLjrd4G5P</span><br><span class="line">yZ1eOMBR567OojiroF6ZX+ukwp/YK1qD/FjY1lhd2PXnqKmKRfD/6JXmx8fPFsXf</span><br><span class="line">OI2dlMzwE7R+A8O02QUkVtm3fPDKOV67wld2dlrr9F0pf7i3CVW8nQr7ys+487a8</span><br><span class="line">jXEI/AwIsLX1tmJxMZBuswJn+Q3If0n4R9agzfTOm+PuTCCOHbDvBQtSnhogLSRy</span><br><span class="line">OZnkEfAZpSVoo8qZ6rTkZdXbkfN10XJvT2E5f7dhZe+Kj9sCAwEAAaN7MHkwCQYD</span><br><span class="line">VR0TBAIwADAsBglghkgBhvhCAQ0EHxYdT3BlblNTTCBHZW5lcmF0ZWQgQ2VydGlm</span><br><span class="line">aWNhdGUwHQYDVR0OBBYEFK0UaNGzHU40Wuqw9Xh0yFEL2IPnMB8GA1UdIwQYMBaA</span><br><span class="line">FBXh3/UkuPKtwpMLkkjm7KjVJYi4MA0GCSqGSIb3DQEBCwUAA4IBAQB1jIRE0C4c</span><br><span class="line">RAsQTkGEr1p+xkhnkIcBm+ryIyLDRDSPBa6Knd00L//VhM0IcIQCWVRG2LwbfVAD</span><br><span class="line">b8EszOVXB5UHPNyOWUO5aO1jzfeCmMw+IIurYW4iLftMRAwKakwpUobdPmgfuDy9</span><br><span class="line">4SrGAbLEAS3nYt/scM6sGJnQ4cCM9E7kGwyM7a2HqB/XKl6bOESTZ2yhtjaOHT32</span><br><span class="line">vzsr5iQAzSf0Kytp63Y3nYewLO/nE5FlBT84c32nMsliBwN7Tl3CSu1844cnJAPE</span><br><span class="line">pZlBZoGKZGWRGDY4Dw1Tk6PxfrmpmGzVoU7NiyshyThBMx/89Mxx7xQgP4zWtWkA</span><br><span class="line">l0Fyzr3jF3z0</span><br><span class="line">-----END CERTIFICATE-----</span><br><span class="line"> 1 s:/C=CN/ST=BeiJing/L=BeiJing/O=sys.com/OU=Devops/CN=ldap.sys.com/emailAddress=ldap@sys.com</span><br><span class="line">   i:/C=CN/ST=BeiJing/L=BeiJing/O=sys.com/OU=Devops/CN=ldap.sys.com/emailAddress=ldap@sys.com</span><br><span class="line">-----BEGIN CERTIFICATE-----</span><br><span class="line">MIID5TCCAs2gAwIBAgIJAJmdDl53USw4MA0GCSqGSIb3DQEBCwUAMIGIMQswCQYD</span><br><span class="line">VQQGEwJDTjEQMA4GA1UECAwHQmVpSmluZzEQMA4GA1UEBwwHQmVpSmluZzEQMA4G</span><br><span class="line">A1UECgwHc3lzLmNvbTEPMA0GA1UECwwGRGV2b3BzMRUwEwYDVQQDDAxsZGFwLnN5</span><br><span class="line">cy5jb20xGzAZBgkqhkiG9w0BCQEWDGxkYXBAc3lzLmNvbTAeFw0yMjA4MTcwOTA3</span><br><span class="line">MjhaFw0zMjA4MTQwOTA3MjhaMIGIMQswCQYDVQQGEwJDTjEQMA4GA1UECAwHQmVp</span><br><span class="line">SmluZzEQMA4GA1UEBwwHQmVpSmluZzEQMA4GA1UECgwHc3lzLmNvbTEPMA0GA1UE</span><br><span class="line">CwwGRGV2b3BzMRUwEwYDVQQDDAxsZGFwLnN5cy5jb20xGzAZBgkqhkiG9w0BCQEW</span><br><span class="line">DGxkYXBAc3lzLmNvbTCCASIwDQYJKoZIhvcNAQEBBQADggEPADCCAQoCggEBAKYI</span><br><span class="line">hw4Ly4WL7wMeyVzt67MCd91NrUu1yrN8jAMSY8WMiR6kFclMwWjgjHQ9myuijs+t</span><br><span class="line">PEBC5//oJ7eYc5ktM7bJOc5iB82uZerCegrrhP9C21ba4Wrv+/wpdXMdABXlBPL+</span><br><span class="line">1E71AAgpuPmJQX3IpWHvEI9dKc7T1sLZM0yr4dVJkFG3P6Rve2wtGo6Pc6avx33E</span><br><span class="line">WH021OfrTBq6I52sazBUugr7Exsneqf1rT/mvov3o1KlBSNCJFa6fYDOgfsABYkZ</span><br><span class="line">MfEZZqeoV5hbXbaeTL+jFSUc6XbNhEhQC+j4z9/LHmmqflFz9uhZPLvUDaGnIj9U</span><br><span class="line">sq586jPTdWSUUqoutTMCAwEAAaNQME4wHQYDVR0OBBYEFBXh3/UkuPKtwpMLkkjm</span><br><span class="line">7KjVJYi4MB8GA1UdIwQYMBaAFBXh3/UkuPKtwpMLkkjm7KjVJYi4MAwGA1UdEwQF</span><br><span class="line">MAMBAf8wDQYJKoZIhvcNAQELBQADggEBAAEuhPHuzpmxdxvztKshgIqKBBYj+UiF</span><br><span class="line">1du/0QDYL38suOUeaw/3EEGypHWEvwu265c+Bgcw9sfyb5ztmg5w/RTMpDS576hp</span><br><span class="line">p8Tz/wCyLcasOjWGWCUqvgxPIFKRmPMGM3nOx8uMoqPKbSpglB2XONH1VfbbMP9n</span><br><span class="line">hccOfwjriOAwsfluAaj6FlNTEmKvyjXPheK+fDlwV3sGGUqqihKK5z+p3RH0RZZv</span><br><span class="line">HIKQYrskV6XMqJmWgIxIdTSUBeJCnGSBEdnyHMfCTPqtFiN9uqAm/LXf3100bRw5</span><br><span class="line">YeJF4g0AIqKJctIl4LDAJXCPv+NMqb2lYGfW03eiqm6SL8sX+6TvstM=</span><br><span class="line">-----END CERTIFICATE-----</span><br><span class="line">---</span><br><span class="line">Server certificate</span><br><span class="line">subject=/C=CN/ST=BeiJing/O=sys.com/OU=Devops/CN=ldap.sys.com/emailAddress=ldap@sys.com</span><br><span class="line">issuer=/C=CN/ST=BeiJing/L=BeiJing/O=sys.com/OU=Devops/CN=ldap.sys.com/emailAddress=ldap@sys.com</span><br><span class="line">---</span><br><span class="line">No client certificate CA names sent</span><br><span class="line">---</span><br><span class="line">SSL handshake has read 2334 bytes and written 607 bytes</span><br><span class="line">---</span><br><span class="line">New, TLSv1/SSLv3, Cipher is AES256-GCM-SHA384</span><br><span class="line">Server public key is 2048 bit</span><br><span class="line">Secure Renegotiation IS supported</span><br><span class="line">Compression: NONE</span><br><span class="line">Expansion: NONE</span><br><span class="line">No ALPN negotiated</span><br><span class="line">SSL-Session:</span><br><span class="line">    Protocol  : TLSv1.2</span><br><span class="line">    Cipher    : AES256-GCM-SHA384</span><br><span class="line">    Session-ID: 47754753CC89AABE4A33D4E89C6C382C3557F074D1F20EE69C5E07CE3284F7B2</span><br><span class="line">    Session-ID-ctx:</span><br><span class="line">    Master-Key: F115E963EF46F2C6608D0DF61CD676404B54B400E081A56E3C49CC2C8C73D74F59F6D524F5B96AD94F8497737848C71E</span><br><span class="line">    Key-Arg   : None</span><br><span class="line">    Krb5 Principal: None</span><br><span class="line">    PSK identity: None</span><br><span class="line">    PSK identity hint: None</span><br><span class="line">    TLS session ticket lifetime hint: 300 (seconds)</span><br><span class="line">    TLS session ticket:</span><br><span class="line">    0000 - e8 74 39 03 64 ab 5b 66-f8 bc 5c e6 1e cc 55 de   .t9.d.[f..\...U.</span><br><span class="line">    0010 - 99 de 08 3c da ef 99 3f-a9 52 13 e6 34 57 ec a5   ...&lt;...?.R..4W..</span><br><span class="line">    0020 - 4f 49 54 77 df 89 66 93-b1 d6 9f f0 76 39 1b 15   OITw..f.....v9..</span><br><span class="line">    0030 - fc 16 a3 fd 23 ad 7f 6d-a7 dc b4 01 89 3c 9e f4   ....#..m.....&lt;..</span><br><span class="line">    0040 - 0a cd d0 80 fe 90 b5 ff-42 03 31 f2 93 5a f7 af   ........B.1..Z..</span><br><span class="line">    0050 - 92 be 04 5e 22 16 3a 0d-36 46 7c 53 c1 6a f3 71   ...^".:.6F|S.j.q</span><br><span class="line">    0060 - e8 00 3c 01 0a d4 0f 23-6d 27 23 fd fc 91 25 a1   ..&lt;....#m'#...%.</span><br><span class="line">    0070 - 15 d5 da ce 95 f3 bb 74-e1 60 6a 3d 7e a9 81 e3   .......t.`j=~...</span><br><span class="line">    0080 - 5d 6c 2e 5d bb 9e 89 26-23 ab 08 99 66 ee 82 f7   ]l.]...&amp;#...f...</span><br><span class="line">    0090 - 37 2f 1c 0b b1 88 47 6f-45 2e ac ca 11 c2 7e 98   7/....GoE.....~.</span><br><span class="line"></span><br><span class="line">    Start Time: 1660732009</span><br><span class="line">    Timeout   : 300 (sec)</span><br><span class="line">    Verify return code: 0 (ok)</span><br><span class="line">---</span><br></pre></td></tr></table></figure><h3 id="3-2-容器-OpenLDAP"><a href="#3-2-容器-OpenLDAP" class="headerlink" title="3.2 容器 OpenLDAP"></a>3.2 容器 OpenLDAP</h3><p>为了节省资源现在很多服务都采用窗口方式部署，OpenLDAP也不例可以使用容器运行，这里新版本2.6.3为例，镜像使用的<code>bitnami/openldap</code> 目前只有这个OpenLDAP镜像在长期更新</p><h4 id="3-2-1-创建-OpenLDAP-pvc"><a href="#3-2-1-创建-OpenLDAP-pvc" class="headerlink" title="3.2.1 创建 OpenLDAP pvc"></a>3.2.1 创建 OpenLDAP pvc</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">[ec2-user@localhost</span> <span class="string">ldap2.6]$</span> <span class="string">vim</span> <span class="string">openldap-pvc.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolumeClaim</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">openldap-data-pvc</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">monitor</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  accessModes:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">ReadWriteOnce</span></span><br><span class="line"><span class="attr">  resources:</span></span><br><span class="line"><span class="attr">    requests:</span></span><br><span class="line"><span class="attr">      storage:</span> <span class="number">10</span><span class="string">Gi</span></span><br><span class="line"><span class="attr">  storageClassName:</span> <span class="string">nfs</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolumeClaim</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">openldap-config-pvc</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">monitor</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  accessModes:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">ReadWriteOnce</span></span><br><span class="line"><span class="attr">  resources:</span></span><br><span class="line"><span class="attr">    requests:</span></span><br><span class="line"><span class="attr">      storage:</span> <span class="number">10</span><span class="string">Gi</span></span><br><span class="line"><span class="attr">  storageClassName:</span> <span class="string">nfs</span></span><br><span class="line"></span><br><span class="line"><span class="string">[ec2-user@localhost</span> <span class="string">ldap2.6]$</span> <span class="string">kubectl</span> <span class="string">apply</span> <span class="bullet">-f</span> <span class="string">openldap-pvc.yaml</span></span><br></pre></td></tr></table></figure><p>注意：根据自己的环境修改<code>storageClassName:</code>存储类名称</p><h4 id="3-2-2-导入-OpenLDAP-证书"><a href="#3-2-2-导入-OpenLDAP-证书" class="headerlink" title="3.2.2 导入 OpenLDAP 证书"></a>3.2.2 导入 OpenLDAP 证书</h4><p>将生成的OpenLDAP证书导入到k8s的secret中</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[ec2-user@localhost ssl]$ kubectl create secret generic openldap-certs -nmonitor --from-file=./cacert.pem --from-file=./ldapcert.pem --from-file=./ldapkey.pem</span><br><span class="line">secret/openldap-certs created</span><br><span class="line">[ec2-user@localhost ssl]$ kubectl get secret -nmonitor |grep openldap</span><br><span class="line">openldap-certs                      Opaque                                3      12s</span><br></pre></td></tr></table></figure><h4 id="3-2-3-创建-OpenLDAP-deployment"><a href="#3-2-3-创建-OpenLDAP-deployment" class="headerlink" title="3.2.3 创建 OpenLDAP deployment"></a>3.2.3 创建 OpenLDAP deployment</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">[ec2-user@localhost</span> <span class="string">ldap2.6]$</span> <span class="string">vim</span> <span class="string">openldap-deployment.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  annotations:</span></span><br><span class="line">    <span class="string">app.kubernetes.io/alias-name:</span> <span class="string">LDAP</span></span><br><span class="line">    <span class="string">app.kubernetes.io/description:</span> <span class="string">认证中心</span></span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line"><span class="attr">    app:</span> <span class="string">openldap</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">openldap</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">monitor</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  progressDeadlineSeconds:</span> <span class="number">600</span></span><br><span class="line"><span class="attr">  replicas:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">  revisionHistoryLimit:</span> <span class="number">10</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    matchLabels:</span></span><br><span class="line"><span class="attr">      app:</span> <span class="string">openldap</span></span><br><span class="line"><span class="attr">  strategy:</span></span><br><span class="line"><span class="attr">    type:</span> <span class="string">Recreate</span></span><br><span class="line"><span class="attr">  template:</span></span><br><span class="line"><span class="attr">    metadata:</span></span><br><span class="line"><span class="attr">      creationTimestamp:</span> <span class="literal">null</span></span><br><span class="line"><span class="attr">      labels:</span></span><br><span class="line"><span class="attr">        app:</span> <span class="string">openldap</span></span><br><span class="line"><span class="attr">    spec:</span></span><br><span class="line"><span class="attr">      containers:</span></span><br><span class="line"><span class="attr">      - env:</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">LDAP_ROOT</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">dc=sys,dc=com</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">LDAP_ADMIN_USERNAME</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">admin</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">LDAP_ADMIN_PASSWORD</span></span><br><span class="line"><span class="attr">          value:</span> <span class="number">6</span><span class="meta">&amp;g0hbSRZJovaqjsA</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">LDAP_TLS_CERT_FILE</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">/opt/bitnami/openldap/certs/ldapcert.pem</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">LDAP_TLS_KEY_FILE</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">/opt/bitnami/openldap/certs/ldapkey.pem</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">LDAP_TLS_CA_FILE</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">/opt/bitnami/openldap/certs/cacert.pem</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">LDAP_ENABLE_TLS</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">"yes"</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">BITNAMI_DEBUG</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">"true"</span></span><br><span class="line"><span class="attr">        image:</span> <span class="string">bitnami/openldap:2.6.3</span></span><br><span class="line"><span class="attr">        imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line"><span class="attr">        name:</span> <span class="string">openldap</span></span><br><span class="line"><span class="attr">        ports:</span></span><br><span class="line"><span class="attr">        - containerPort:</span> <span class="number">1389</span></span><br><span class="line"><span class="attr">          name:</span> <span class="string">tcp-389</span></span><br><span class="line"><span class="attr">          protocol:</span> <span class="string">TCP</span></span><br><span class="line"><span class="attr">        - containerPort:</span> <span class="number">1636</span></span><br><span class="line"><span class="attr">          name:</span> <span class="string">tcp-636</span></span><br><span class="line"><span class="attr">          protocol:</span> <span class="string">TCP</span></span><br><span class="line"><span class="attr">        resources:</span></span><br><span class="line"><span class="attr">          limits:</span></span><br><span class="line"><span class="attr">            cpu:</span> <span class="number">500</span><span class="string">m</span></span><br><span class="line"><span class="attr">            memory:</span> <span class="number">500</span><span class="string">Mi</span></span><br><span class="line"><span class="attr">          requests:</span></span><br><span class="line"><span class="attr">            cpu:</span> <span class="number">100</span><span class="string">m</span></span><br><span class="line"><span class="attr">            memory:</span> <span class="number">64</span><span class="string">Mi</span></span><br><span class="line"><span class="attr">        terminationMessagePath:</span> <span class="string">/dev/termination-log</span></span><br><span class="line"><span class="attr">        terminationMessagePolicy:</span> <span class="string">File</span></span><br><span class="line"><span class="attr">        volumeMounts:</span></span><br><span class="line"><span class="attr">        - mountPath:</span> <span class="string">/bitnami/openldap/</span></span><br><span class="line"><span class="attr">          name:</span> <span class="string">ldap-data-pvc</span></span><br><span class="line"><span class="attr">        - mountPath:</span> <span class="string">/opt/bitnami/openldap/certs</span></span><br><span class="line"><span class="attr">          name:</span> <span class="string">ldap-certs</span></span><br><span class="line"><span class="attr">      dnsPolicy:</span> <span class="string">ClusterFirst</span></span><br><span class="line"><span class="attr">      restartPolicy:</span> <span class="string">Always</span></span><br><span class="line"><span class="attr">      schedulerName:</span> <span class="string">default-scheduler</span></span><br><span class="line"><span class="attr">      securityContext:</span> <span class="string">&#123;&#125;</span></span><br><span class="line"><span class="attr">      terminationGracePeriodSeconds:</span> <span class="number">30</span></span><br><span class="line"><span class="attr">      volumes:</span></span><br><span class="line"><span class="attr">      - name:</span> <span class="string">ldap-data-pvc</span></span><br><span class="line"><span class="attr">        persistentVolumeClaim:</span></span><br><span class="line"><span class="attr">          claimName:</span> <span class="string">openldap-data-pvc</span></span><br><span class="line"><span class="attr">      - name:</span> <span class="string">ldap-certs</span></span><br><span class="line"><span class="attr">        secret:</span></span><br><span class="line"><span class="attr">          defaultMode:</span> <span class="number">420</span></span><br><span class="line"><span class="attr">          secretName:</span> <span class="string">openldap-certs</span></span><br><span class="line"></span><br><span class="line"><span class="string">[ec2-user@localhost</span> <span class="string">ldap2.6]$</span> <span class="string">kubectl</span> <span class="string">apply</span> <span class="bullet">-f</span> <span class="string">openldap-deployment.yaml</span></span><br></pre></td></tr></table></figure><h4 id="3-2-4-创建-OpenLDAP-service"><a href="#3-2-4-创建-OpenLDAP-service" class="headerlink" title="3.2.4 创建 OpenLDAP service"></a>3.2.4 创建 OpenLDAP service</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">[ec2-user@localhost ldap2.6]$ cat openldap-svc.yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: openldap-svc</span><br><span class="line">  namespace: monitor</span><br><span class="line">  labels:</span><br><span class="line">    app: openldap-svc</span><br><span class="line">spec:</span><br><span class="line">  ports:</span><br><span class="line">  - name: tcp-389</span><br><span class="line">    nodePort: 30402</span><br><span class="line">    port: 1389</span><br><span class="line">    protocol: TCP</span><br><span class="line">    targetPort: 1389</span><br><span class="line">  - name: tcp-636</span><br><span class="line">    nodePort: 30381</span><br><span class="line">    port: 1636</span><br><span class="line">    protocol: TCP</span><br><span class="line">    targetPort: 1636</span><br><span class="line">  selector:</span><br><span class="line">    app: openldap</span><br><span class="line">  type: LoadBalancer</span><br><span class="line"></span><br><span class="line">[ec2-user@localhost ldap2.6]$ kubectl apply -f openldap-svc.yaml</span><br></pre></td></tr></table></figure><h4 id="3-2-5-测试连接"><a href="#3-2-5-测试连接" class="headerlink" title="3.2.5 测试连接"></a>3.2.5 测试连接</h4><p>这里使用ldapadmin连接</p><p><img src="/2022/08/17/openldap-kai-qi-ssl-tls-jia-mi-tong-xin/%E5%9B%BE%E7%89%871.png" alt="图片1"></p><p><img src="/2022/08/17/openldap-kai-qi-ssl-tls-jia-mi-tong-xin/%E5%9B%BE%E7%89%872.png" alt="图片2"></p></div><div><div><div style="text-align:center;color:#ccc;font-size:14px">-------------本文结束<i class="fa fa-paw"></i>感谢您的阅读-------------</div></div></div><div></div><footer class="post-footer"><div class="post-tags"><a href="/tags/OpenLDAP/" rel="tag"><i class="fa fa-tag"></i> OpenLDAP</a><a href="/tags/LDAP/" rel="tag"><i class="fa fa-tag"></i> LDAP</a></div><div class="post-nav"><div class="post-nav-next post-nav-item"><a href="/2022/08/03/k8s-zhong-yun-xing-openldap/" rel="next" title="K8s 中运行OpenLDAP"><i class="fa fa-chevron-left"></i> K8s 中运行OpenLDAP</a></div><span class="post-nav-divider"></span><div class="post-nav-prev post-nav-item"><a href="/2022/08/22/grafana-shi-yong-ssl-jia-mi-ji-cheng-openldap/" rel="prev" title="Grafana 使用SSL加密集成 OpenLDAP">Grafana 使用SSL加密集成 OpenLDAP<i class="fa fa-chevron-right"></i></a></div></div></footer></div></article><div class="post-spread"><div class="jiathis_style"><span class="jiathis_txt">分享到：</span> <a class="jiathis_button_fav">收藏夹</a> <a class="jiathis_button_copy">复制网址</a> <a class="jiathis_button_email">邮件</a> <a class="jiathis_button_weixin">微信</a> <a class="jiathis_button_qzone">QQ空间</a> <a class="jiathis_button_tqq">腾讯微博</a> <a class="jiathis_button_douban">豆瓣</a> <a class="jiathis_button_share">一键分享</a> <a href="http://www.jiathis.com/share?uid=2140465" class="jiathis jiathis_txt jiathis_separator jtico jtico_jiathis" target="_blank">更多</a><a class="jiathis_counter_style"></a></div><script type="text/javascript">var jiathis_config={data_track_clickback:!0,summary:"",shortUrl:!1,hideMore:!1}</script><script type="text/javascript" src="http://v3.jiathis.com/code/jia.js?uid=" charset="utf-8"></script></div></div></div></div><div class="sidebar-toggle"><div class="sidebar-toggle-line-wrap"><span class="sidebar-toggle-line sidebar-toggle-line-first"></span><span class="sidebar-toggle-line sidebar-toggle-line-middle"></span><span class="sidebar-toggle-line sidebar-toggle-line-last"></span></div></div><aside id="sidebar" class="sidebar"><div id="sidebar-dimmer"></div><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">文章目录</li><li class="sidebar-nav-overview" data-target="site-overview-wrap">站点概览</li></ul><section class="site-overview-wrap sidebar-panel"><div class="site-overview"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="site-author-image" itemprop="image" src="/images/chen.png" alt="Zhongzhou Chen"><p class="site-author-name" itemprop="name">Zhongzhou Chen</p><p class="site-description motion-element" itemprop="description"></p></div><nav class="site-state motion-element"><div class="site-state-item site-state-posts"><a href="/archives/%7C%7C%20archive"><span class="site-state-item-count">325</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"><a href="/categories/index.html"><span class="site-state-item-count">84</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"><a href="/tags/index.html"><span class="site-state-item-count">182</span> <span class="site-state-item-name">标签</span></a></div></nav><div class="feed-link motion-element"><a href="/atom.xml" rel="alternate"><i class="fa fa-rss"></i> RSS</a></div></div></section><section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active"><div class="post-toc"><div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#一、前言"><span class="nav-text">一、前言</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Openldap为啥要加密"><span class="nav-text">Openldap为啥要加密</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#SSL-TLS加密原理简介"><span class="nav-text">SSL/TLS加密原理简介</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#二、自生成证书"><span class="nav-text">二、自生成证书</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-1-自建-CA-中心"><span class="nav-text">2.1 自建 CA 中心</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-1-1-CA中心生成自身私钥"><span class="nav-text">2.1.1 CA中心生成自身私钥</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-1-2-CA签发自身公钥"><span class="nav-text">2.1.2 CA签发自身公钥</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-1-3-创建index-txt和serial文件"><span class="nav-text">2.1.3 创建index.txt和serial文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-1-4-使用openssl命令获取证书信息"><span class="nav-text">2.1.4 使用openssl命令获取证书信息</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-2-生成-LDAP-证书"><span class="nav-text">2.2 生成 LDAP 证书</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2-1-获取LDAP证书"><span class="nav-text">2.2.1 获取LDAP证书</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2-2-生成LDAP证书"><span class="nav-text">2.2.2 生成LDAP证书</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2-3-验证证书"><span class="nav-text">2.2.3 验证证书</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2-4-准备证书文件"><span class="nav-text">2.2.4 准备证书文件</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#三、OpenLDAP-开启-SSL"><span class="nav-text">三、OpenLDAP 开启 SSL</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#3-1-自建-OpenLDAP"><span class="nav-text">3.1 自建 OpenLDAP</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#3-1-1-创建ssl的ldif配置文件"><span class="nav-text">3.1.1 创建ssl的ldif配置文件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-1-2-导入ssl配置"><span class="nav-text">3.1.2 导入ssl配置</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-1-3-配置只开启ldaps"><span class="nav-text">3.1.3 配置只开启ldaps</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-1-4-重启slapd服务"><span class="nav-text">3.1.4 重启slapd服务</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-1-5-测试连接"><span class="nav-text">3.1.5 测试连接</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-2-容器-OpenLDAP"><span class="nav-text">3.2 容器 OpenLDAP</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#3-2-1-创建-OpenLDAP-pvc"><span class="nav-text">3.2.1 创建 OpenLDAP pvc</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-2-2-导入-OpenLDAP-证书"><span class="nav-text">3.2.2 导入 OpenLDAP 证书</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-2-3-创建-OpenLDAP-deployment"><span class="nav-text">3.2.3 创建 OpenLDAP deployment</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-2-4-创建-OpenLDAP-service"><span class="nav-text">3.2.4 创建 OpenLDAP service</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-2-5-测试连接"><span class="nav-text">3.2.5 测试连接</span></a></li></ol></li></ol></li></ol></div></div></section><div class="back-to-top"><i class="fa fa-arrow-up"></i> <span id="scrollpercent"><span>0</span>%</span></div></div></aside></div></main><footer id="footer" class="footer"><div class="footer-inner"><script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script><div class="copyright">&copy; <span itemprop="copyrightYear">2022</span><span class="with-love"><i class="fa fa-user"></i></span> <span class="author" itemprop="copyrightHolder">Zhongzhou Chen</span> <span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-area-chart"></i></span> <span class="post-meta-item-text">Site words total count&#58;</span> <span title="Site words total count">765.4k</span></div><span class="post-meta-divider"></span></div></footer></div><script type="text/javascript">"[object Function]"!==Object.prototype.toString.call(window.Promise)&&(window.Promise=null)</script><script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script><script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script><script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script><script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script><script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script><script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script><script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script><style>.copy-btn{display:inline-block;padding:6px 12px;font-size:13px;font-weight:700;line-height:20px;color:#333;white-space:nowrap;vertical-align:middle;cursor:pointer;background-color:#eee;background-image:linear-gradient(#fcfcfc,#eee);border:1px solid #d5d5d5;border-radius:3px;user-select:none;outline:0}.highlight-wrap .copy-btn{transition:opacity .3s ease-in-out;opacity:0;padding:2px 6px;position:absolute;right:4px;top:8px}.highlight-wrap .copy-btn:focus,.highlight-wrap:hover .copy-btn{opacity:1}.highlight-wrap{position:relative}</style><script>$(".highlight").each(function(t,e){var n=$("<div>").addClass("highlight-wrap");$(e).after(n),n.append($("<button>").addClass("copy-btn").append("复制").on("click",function(t){var e=$(this).parent().find(".code").find(".line").map(function(t,e){return $(e).text()}).toArray().join("\n"),n=document.createElement("textarea");document.body.appendChild(n),n.style.position="absolute",n.style.top="0px",n.style.left="0px",n.value=e,n.select(),n.focus();var o=document.execCommand("copy");document.body.removeChild(n),o?$(this).text("复制成功"):$(this).text("复制失败"),$(this).blur()})).on("mouseleave",function(t){var e=$(this).find(".copy-btn");setTimeout(function(){e.text("复制")},300)}).append(e)})</script><script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script><script type="text/javascript">function proceedsearch(){$("body").append('<div class="search-popup-overlay local-search-pop-overlay"></div>').css("overflow","hidden"),$(".search-popup-overlay").click(onPopupClose),$(".popup").toggle();var t=$("#local-search-input");t.attr("autocapitalize","none"),t.attr("autocorrect","off"),t.focus()}var isfetched=!1,isXml=!0,search_path="search.xml";0===search_path.length?search_path="search.xml":/json$/i.test(search_path)&&(isXml=!1);var path="/"+search_path,onPopupClose=function(t){$(".popup").hide(),$("#local-search-input").val(""),$(".search-result-list").remove(),$("#no-result").remove(),$(".local-search-pop-overlay").remove(),$("body").css("overflow","")},searchFunc=function(t,e,s){"use strict";$("body").append('<div class="search-popup-overlay local-search-pop-overlay"><div id="search-loading-icon"><i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i></div></div>').css("overflow","hidden"),$("#search-loading-icon").css("margin","20% auto 0 auto").css("text-align","center"),$.ajax({url:t,dataType:isXml?"xml":"json",async:!0,success:function(t){isfetched=!0,$(".popup").detach().appendTo(".header-inner");var o=isXml?$("entry",t).map(function(){return{title:$("title",this).text(),content:$("content",this).text(),url:$("url",this).text()}}).get():t,n=document.getElementById(e),r=document.getElementById(s);n.addEventListener("input",function(){var y=n.value.trim().toLowerCase(),T=y.split(/[\s\-]+/);1<T.length&&T.push(y);var b=[];if(0<y.length&&o.forEach(function(t){function e(t,e,o,n){for(var r=n[n.length-1],s=r.position,a=r.word,i=[],c=0;s+a.length<=o&&0!=n.length;){a===y&&c++,i.push({position:s,length:a.length});var l=s+a.length;for(n.pop();0!=n.length&&(s=(r=n[n.length-1]).position,a=r.word,s<l);)n.pop()}return h+=c,{hits:i,start:e,end:o,searchTextCount:c}}function o(o,t){var n="",r=t.start;return t.hits.forEach(function(t){n+=o.substring(r,t.position);var e=t.position+t.length;n+='<b class="search-keyword">'+o.substring(t.position,e)+"</b>",r=e}),n+=o.substring(r,t.end)}var n=!1,r=0,h=0,s=t.title.trim(),a=s.toLowerCase(),i=t.content.trim().replace(/<[^>]+>/g,""),c=i.toLowerCase(),l=decodeURIComponent(t.url),p=[],u=[];if(""!=s&&(T.forEach(function(t){function e(t,e,o){var n=t.length;if(0===n)return[];var r=0,s=[],a=[];for(o||(e=e.toLowerCase(),t=t.toLowerCase());-1<(s=e.indexOf(t,r));)a.push({position:s,word:t}),r=s+n;return a}p=p.concat(e(t,a,!1)),u=u.concat(e(t,c,!1))}),(0<p.length||0<u.length)&&(n=!0,r=p.length+u.length)),n){[p,u].forEach(function(t){t.sort(function(t,e){return e.position!==t.position?e.position-t.position:t.word.length-e.word.length})});var f=[];0!=p.length&&f.push(e(0,0,s.length,p));for(var d=[];0!=u.length;){var g=u[u.length-1],v=g.position,$=g.word,C=v-20,m=v+80;C<0&&(C=0),m<v+$.length&&(m=v+$.length),m>i.length&&(m=i.length),d.push(e(0,C,m,u))}d.sort(function(t,e){return t.searchTextCount!==e.searchTextCount?e.searchTextCount-t.searchTextCount:t.hits.length!==e.hits.length?e.hits.length-t.hits.length:t.start-e.start});var x=parseInt("1");0<=x&&(d=d.slice(0,x));var w="";w+=0!=f.length?"<li><a href='"+l+"' class='search-result-title'>"+o(s,f[0])+"</a>":"<li><a href='"+l+"' class='search-result-title'>"+s+"</a>",d.forEach(function(t){w+="<a href='"+l+'\'><p class="search-result">'+o(i,t)+"...</p></a>"}),w+="</li>",b.push({item:w,searchTextCount:h,hitCount:r,id:b.length})}}),1===T.length&&""===T[0])r.innerHTML='<div id="no-result"><i class="fa fa-search fa-5x" /></div>';else if(0===b.length)r.innerHTML='<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>';else{b.sort(function(t,e){return t.searchTextCount!==e.searchTextCount?e.searchTextCount-t.searchTextCount:t.hitCount!==e.hitCount?e.hitCount-t.hitCount:e.id-t.id});var e='<ul class="search-result-list">';b.forEach(function(t){e+=t.item}),e+="</ul>",r.innerHTML=e}}),$(".local-search-pop-overlay").remove(),$("body").css("overflow",""),proceedsearch()}})};$(".popup-trigger").click(function(t){t.stopPropagation(),!1===isfetched?searchFunc(path,"local-search-input","local-search-result"):proceedsearch()}),$(".popup-btn-close").click(onPopupClose),$(".popup").click(function(t){t.stopPropagation()}),$(document).on("keyup",function(t){27===t.which&&$(".search-popup").is(":visible")&&onPopupClose()})</script><script type="text/javascript" src="/js/src/love.js"></script><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({pluginRootPath:"live2dw/",pluginJsPath:"lib/",pluginModelPath:"assets/",tagMode:!1,debug:!1,log:!1,model:{jsonPath:"/live2dw/assets/shizuku.model.json"},display:{position:"right"},mobile:{show:!0,scale:.2},react:{opacityDefault:.7,opacityOnHover:.2,opacity:.4}})</script></body></html>