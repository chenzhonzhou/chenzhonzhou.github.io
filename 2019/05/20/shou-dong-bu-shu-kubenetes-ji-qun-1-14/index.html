<!DOCTYPE html><html class="theme-next gemini use-motion" lang="zh-Hans"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><script src="//cdn.bootcss.com/pace/1.0.2/pace.min.js"></script><link href="//cdn.bootcss.com/pace/1.0.2/themes/pink/pace-theme-flash.css" rel="stylesheet"><script></script><meta name="theme-color" content="#222"><style>.pace .pace-progress{background:#1e92fb;height:3px}.pace .pace-progress-inner{box-shadow:0 0 10px #1e92fb,0 0 5px #1e92fb}.pace .pace-activity{border-top-color:#1e92fb;border-left-color:#1e92fb}</style><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><meta name="google-site-verification" content="HGM141IpbHrSmnAmR6W_zE4bo9Z3f-yXLeHYT3bg1fk"><meta name="baidu-site-verification" content="code-5Ai1DA8e6T"><link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css"><link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css"><link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4"><link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222"><meta name="keywords" content="kubernetes,"><link rel="alternate" href="/atom.xml" title="凡间的精灵" type="application/atom+xml"><meta name="description" content="一、Openssl自签TLS证书配置kubernetes集群组件分布组件版本下载地址etcd3.3.10https:&#x2F;&#x2F;github.com&#x2F;etcd-io&#x2F;etcd&#x2F;releaseskube-apiserver1.4.2https:&#x2F;&#x2F;storage.googleapis.com&#x2F;kubernetes-release&#x2F;release&#x2F;v1.14.2&#x2F;kubernetes-server-linux"><meta name="keywords" content="kubernetes"><meta property="og:type" content="article"><meta property="og:title" content="手动部署kubenetes集群1.14"><meta property="og:url" content="http:&#x2F;&#x2F;chenzhonzhou.github.io&#x2F;2019&#x2F;05&#x2F;20&#x2F;shou-dong-bu-shu-kubenetes-ji-qun-1-14&#x2F;index.html"><meta property="og:site_name" content="凡间的精灵"><meta property="og:description" content="一、Openssl自签TLS证书配置kubernetes集群组件分布组件版本下载地址etcd3.3.10https:&#x2F;&#x2F;github.com&#x2F;etcd-io&#x2F;etcd&#x2F;releaseskube-apiserver1.4.2https:&#x2F;&#x2F;storage.googleapis.com&#x2F;kubernetes-release&#x2F;release&#x2F;v1.14.2&#x2F;kubernetes-server-linux"><meta property="og:locale" content="zh-Hans"><meta property="og:updated_time" content="2023-02-11T03:55:37.936Z"><meta name="twitter:card" content="summary"><script type="text/javascript" id="hexo.configurations">var NexT=window.NexT||{},CONFIG={root:"/",scheme:"Gemini",version:"5.1.4",sidebar:{position:"left",display:"always",offset:12,b2t:!0,scrollpercent:!0,onmobile:!0},fancybox:!0,tabs:!0,motion:{enable:!0,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}},duoshuo:{userId:"0",author:"博主"},algolia:{applicationID:"",apiKey:"",indexName:"",hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}}}</script><link rel="canonical" href="http://chenzhonzhou.github.io/2019/05/20/shou-dong-bu-shu-kubenetes-ji-qun-1-14/"><title>手动部署kubenetes集群1.14 | 凡间的精灵</title><link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css"></head><body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans"><div class="container sidebar-position-left page-post-detail"><div class="headband"></div><header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-wrapper"><div class="site-meta"><div class="custom-logo-site-title"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">凡间的精灵</span><span class="logo-line-after"><i></i></span></a></div><p class="site-subtitle">凡尘落素一精灵</p></div><div class="site-nav-toggle"><button><span class="btn-bar"></span><span class="btn-bar"></span><span class="btn-bar"></span></button></div></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i><br>首页</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i><br>归档</a></li><li class="menu-item menu-item-categories"><a href="/categories" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i><br>分类</a></li><li class="menu-item menu-item-tags"><a href="/tags" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i><br>标签</a></li><li class="menu-item menu-item-sitemap"><a href="/sitemap.xml" rel="section"><i class="menu-item-icon fa fa-fw fa-sitemap"></i><br>站点地图</a></li><li class="menu-item menu-item-search"><a href="javascript:;" class="popup-trigger"><i class="menu-item-icon fa fa-search fa-fw"></i><br>搜索</a></li></ul><div class="site-search"><div class="popup search-popup local-search-popup"><div class="local-search-header clearfix"><span class="search-icon"><i class="fa fa-search"></i></span><span class="popup-btn-close"><i class="fa fa-times-circle"></i></span><div class="local-search-input-wrapper"><input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input"></div></div><div id="local-search-result"></div></div></div></nav></div></header><main id="main" class="main"><div class="main-inner"><div class="content-wrap"><div id="content" class="content"><div id="posts" class="posts-expand"><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><div class="post-block"><link itemprop="mainEntityOfPage" href="http://chenzhonzhou.github.io/2019/05/20/shou-dong-bu-shu-kubenetes-ji-qun-1-14/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="name" content="Zhongzhou Chen"><meta itemprop="description" content=""><meta itemprop="image" content="/images/chen.png"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="凡间的精灵"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">手动部署kubenetes集群1.14</h1><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i></span> <span class="post-meta-item-text">发表于</span> <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-05-20T11:26:30+08:00">2019-05-20</time></span> <span class="post-category"><span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-folder-o"></i></span> <span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/kubernetes/" itemprop="url" rel="index"><span itemprop="name">kubernetes</span></a></span></span><div class="post-wordcount"><span class="post-meta-item-icon"><i class="fa fa-file-word-o"></i></span> <span class="post-meta-item-text">字数统计&#58;</span> <span title="字数统计">9.3k</span> <span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-clock-o"></i></span> <span class="post-meta-item-text">阅读时长 &asymp;</span> <span title="阅读时长">51</span></div></div></header><div class="post-body" itemprop="articleBody"><h2 id="一、Openssl自签TLS证书配置"><a href="#一、Openssl自签TLS证书配置" class="headerlink" title="一、Openssl自签TLS证书配置"></a>一、Openssl自签TLS证书配置</h2><p>kubernetes集群组件分布</p><table><thead><tr><th>组件</th><th>版本</th><th>下载地址</th></tr></thead><tbody><tr><td>etcd</td><td>3.3.10</td><td><a href="https://github.com/etcd-io/etcd/releases" target="_blank" rel="noopener">https://github.com/etcd-io/etcd/releases</a></td></tr><tr><td>kube-apiserver</td><td>1.4.2</td><td><a href="https://storage.googleapis.com/kubernetes-release/release/v1.14.2/kubernetes-server-linux-amd64.tar.gz" target="_blank" rel="noopener">https://storage.googleapis.com/kubernetes-release/release/v1.14.2/kubernetes-server-linux-amd64.tar.gz</a></td></tr><tr><td>kube-controller-manager</td><td>1.4.2</td><td></td></tr><tr><td>kube-scheduler</td><td>1.4.2</td><td></td></tr><tr><td>kubelet</td><td>1.4.2</td><td><a href="https://storage.googleapis.com/kubernetes-release/release/v1.14.2/kubernetes-node-linux-amd64.tar.gz" target="_blank" rel="noopener">https://storage.googleapis.com/kubernetes-release/release/v1.14.2/kubernetes-node-linux-amd64.tar.gz</a></td></tr><tr><td>kube-proxy</td><td>1.4.2</td><td></td></tr><tr><td>calicoctl</td><td>3.7.2</td><td><a href="https://github.com/projectcalico/calicoctl/releases" target="_blank" rel="noopener">https://github.com/projectcalico/calicoctl/releases</a></td></tr></tbody></table><h3 id="证书介绍"><a href="#证书介绍" class="headerlink" title="证书介绍"></a>证书介绍</h3><table><thead><tr><th>证书名称</th><th>配置文件</th><th>用途</th></tr></thead><tbody><tr><td>ca-config.pem</td><td>ca-config.json</td><td>证书有效期描述</td></tr><tr><td>ca.pem</td><td>ca-csr.json</td><td>k8s 根 CA 证书</td></tr><tr><td>etcd.pem</td><td>etcd-csr.json</td><td>etcd 集群证书</td></tr><tr><td>kubernetes.pem</td><td>kubernetes-csr.json</td><td>kube-apiserver 使用的证书</td></tr><tr><td>admin.pem</td><td>admin-csr.json</td><td>kubectl 使用的证书</td></tr><tr><td>kube-proxy.pem</td><td>kube-proxy-csr.json</td><td>kube-proxy 使用的证书</td></tr></tbody></table><h3 id="cfssl-工具安装"><a href="#cfssl-工具安装" class="headerlink" title="cfssl 工具安装"></a>cfssl 工具安装</h3><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[admin@haifly-bj-dev-k8s-master1 adimin] mkdir -p kubenetes/cfssl</span><br><span class="line">[admin@haifly-bj-dev-k8s-master1 adimin] <span class="built_in">cd</span> kubenetes/cfssl</span><br><span class="line">wget https://pkg.cfssl.org/R1.2/cfssl_linux-amd64</span><br><span class="line">wget https://pkg.cfssl.org/R1.2/cfssljson_linux-amd64</span><br><span class="line">wget https://pkg.cfssl.org/R1.2/cfssl-certinfo_linux-amd64</span><br><span class="line">mv cfssl_linux-amd64 cfssl</span><br><span class="line">mv cfssljson_linux-amd64 cfssljson</span><br><span class="line">mv cfssl-certinfo_linux-amd64 cfssl-certinfo</span><br><span class="line">chmod +x ./*</span><br><span class="line"></span><br><span class="line">添加一个临时环境变量，文件生成证书配置</span><br><span class="line">[admin@haifly-bj-dev-k8s-master1 cfssl]$ <span class="built_in">export</span> PATH=/work/admin/kubernetes/cfssl/:<span class="variable">$PATH</span></span><br></pre></td></tr></tbody></table></figure><p>1.配置证书生成策略<br>2.创建用来生成 CA 证书签名请求（CSR）的 JSON 配置文件<br>3.生成CA证书和私钥(root 证书和私钥)<br>4.分发证书</p><h2 id="创建认证中心-CA"><a href="#创建认证中心-CA" class="headerlink" title="创建认证中心(CA)"></a>创建认证中心(CA)</h2><p>CFSSL可以创建一个获取和操作证书的内部认证中心。</p><p>运行认证中心需要一个CA证书和相应的CA私钥。任何知道私钥的人都可以充当CA颁发证书。因此，私钥的保护至关重要。</p><h3 id="1-配置证书生成策略"><a href="#1-配置证书生成策略" class="headerlink" title="1.配置证书生成策略"></a>1.配置证书生成策略</h3><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[admin@haifly-bj-dev-k8s-master1 cfssl]$ cat &lt;&lt;EOF&gt;&gt; ca-config.json </span><br><span class="line">{</span><br><span class="line">  <span class="string">"signing"</span>: {</span><br><span class="line">    <span class="string">"default"</span>: {</span><br><span class="line">      <span class="string">"expiry"</span>: <span class="string">"87600h"</span></span><br><span class="line">    },</span><br><span class="line">    <span class="string">"profiles"</span>: {</span><br><span class="line">      <span class="string">"kubernetes"</span>: {</span><br><span class="line">        <span class="string">"usages"</span>: [</span><br><span class="line">            <span class="string">"signing"</span>,</span><br><span class="line">            <span class="string">"key encipherment"</span>,</span><br><span class="line">            <span class="string">"server auth"</span>,</span><br><span class="line">            <span class="string">"client auth"</span></span><br><span class="line">        ],</span><br><span class="line">        <span class="string">"expiry"</span>: <span class="string">"87600h"</span></span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line">EOF</span><br></pre></td></tr></tbody></table></figure><p>这个策略，有一个默认的配置，和一个profile，可以设置多个profile，这里的profile是kubernetes，也可以是其他用途的比如说etcd等。</p><ul><li><p>默认策略，指定了证书的有效期是一年(8760h)</p></li><li><p>kubernetes策略，指定了证书的用途</p></li><li><p>signing, 表示该证书可用于签名其它证书；生成的 ca.pem 证书中 CA=TRUE</p></li><li><p>server auth：表示 client 可以用该 CA 对 server 提供的证书进行验证</p></li><li><p>client auth：表示 server 可以用该 CA 对 client 提供的证书进行验证</p></li></ul><h3 id="2-创建用来生成-CA-证书签名请求（CSR）的-JSON-配置文件"><a href="#2-创建用来生成-CA-证书签名请求（CSR）的-JSON-配置文件" class="headerlink" title="2.创建用来生成 CA 证书签名请求（CSR）的 JSON 配置文件"></a>2.创建用来生成 CA 证书签名请求（CSR）的 JSON 配置文件</h3><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[admin@haifly-bj-dev-k8s-master1 cfssl]$ cat &lt;&lt;EOF&gt;&gt; ca-csr.json </span><br><span class="line">{</span><br><span class="line">  <span class="string">"CN"</span>: <span class="string">"kubernetes"</span>,</span><br><span class="line">  <span class="string">"key"</span>: {</span><br><span class="line">    <span class="string">"algo"</span>: <span class="string">"rsa"</span>,</span><br><span class="line">    <span class="string">"size"</span>: 2048</span><br><span class="line">  },</span><br><span class="line">  <span class="string">"names"</span>: [</span><br><span class="line">    {</span><br><span class="line">      <span class="string">"C"</span>: <span class="string">"CN"</span>,</span><br><span class="line">      <span class="string">"ST"</span>: <span class="string">"BeiJing"</span>,</span><br><span class="line">      <span class="string">"L"</span>: <span class="string">"BeiJing"</span>,</span><br><span class="line">      <span class="string">"O"</span>: <span class="string">"k8s"</span>,</span><br><span class="line">      <span class="string">"OU"</span>: <span class="string">"System"</span></span><br><span class="line">    }</span><br><span class="line">  ]</span><br><span class="line">}</span><br><span class="line">EOF</span><br></pre></td></tr></tbody></table></figure><ul><li><p>CN: Common Name，浏览器使用该字段验证网站是否合法，一般写的是域名。非常重要。浏览器使用该字段验证网站是否合法</p></li><li><p>C: Country， 国家</p></li><li><p>L: Locality，地区，城市</p></li><li><p>O: Organization Name，组织名称，公司名称</p></li><li><p>OU: Organization Unit Name，组织单位名称，公司部门</p></li><li><p>ST: State，州，省</p></li></ul><h3 id="3-生成CA证书和私钥-root-证书和私钥"><a href="#3-生成CA证书和私钥-root-证书和私钥" class="headerlink" title="3.生成CA证书和私钥(root 证书和私钥)"></a>3.生成CA证书和私钥(root 证书和私钥)</h3><p>ca证书：ca.pem 私钥：ca-key.pem 初始化CA <code>cfssl gencert -initca ca-csr.json | cfssljson -bare ca</code>这个命令会生成运行CA所必需的文件ca-key.pem（私钥）和ca.pem（证书），还会生成ca.csr（证书签名请求），用于交叉签名或重新签名。</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[admin@haifly-bj-dev-k8s-master1 cfssl]$ cfssl gencert -initca ca-csr.json | cfssljson -bare ca</span><br><span class="line">2019/05/27 09:28:14 [INFO] generating a new CA key and certificate from CSR</span><br><span class="line">2019/05/27 09:28:14 [INFO] generate received request</span><br><span class="line">2019/05/27 09:28:14 [INFO] received CSR</span><br><span class="line">2019/05/27 09:28:14 [INFO] generating key: rsa-2048</span><br><span class="line">2019/05/27 09:28:14 [INFO] encoded CSR</span><br><span class="line">2019/05/27 09:28:14 [INFO] signed certificate with serial number 10840760309635909896488288805780810828105360395</span><br><span class="line">ll</span><br><span class="line">total 18828</span><br><span class="line">-rw-rw-r-- 1 admin admin      290 May 25 18:10 ca-config.json</span><br><span class="line">-rw-r--r-- 1 admin admin     1001 May 27 09:28 ca.csr</span><br><span class="line">-rw-rw-r-- 1 admin admin      208 May 25 18:10 ca-csr.json</span><br><span class="line">-rw------- 1 admin admin     1679 May 27 09:28 ca-key.pem</span><br><span class="line">-rw-rw-r-- 1 admin admin     1359 May 27 09:28 ca.pem</span><br><span class="line">-rwxrwxr-x 1 admin admin 10376657 Mar 30  2016 cfssl</span><br><span class="line">-rwxrwxr-x 1 admin admin  6595195 Mar 30  2016 cfssl-certinfo</span><br><span class="line">-rwxrwxr-x 1 admin admin  2277873 Mar 30  2016 cfssljson</span><br></pre></td></tr></tbody></table></figure><p>注意： 使用现有的CA私钥，重新生成：</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">```</span><br><span class="line">cfssl gencert -initca -ca-key key.pem ca-csr.json | cfssljson -bare ca</span><br><span class="line">​```</span><br><span class="line">使用现有的CA私钥和CA证书，重新生成：</span><br><span class="line">​```</span><br><span class="line">cfssl gencert -renewca -ca cert.pem -ca-key key.pem</span><br><span class="line">​```</span><br></pre></td></tr></tbody></table></figure><h4 id="3-1-查看cert-证书信息"><a href="#3-1-查看cert-证书信息" class="headerlink" title="3.1 查看cert(证书信息):"></a>3.1 查看cert(证书信息):</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[admin@haifly-bj-dev-k8s-master1 cfssl]$ cfssl certinfo -cert ca.pem</span><br></pre></td></tr></tbody></table></figure><h4 id="3-2-查看CSR-证书签名请求-信息："><a href="#3-2-查看CSR-证书签名请求-信息：" class="headerlink" title="3.2 查看CSR(证书签名请求)信息："></a>3.2 查看CSR(证书签名请求)信息：</h4><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cfssl certinfo -csr ca.csr</span><br></pre></td></tr></tbody></table></figure><h3 id="4-分发证书"><a href="#4-分发证书" class="headerlink" title="4.分发证书"></a>4.分发证书</h3><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[admin@haifly-bj-dev-k8s-master1 cfssl]$ cp ca.pem ca-key.pem /work/admin/kubernetes/ssl/</span><br><span class="line">SCP证书到master,node节点</span><br><span class="line">[admin@haifly-bj-dev-k8s-master1 cfss]$ scp ca.pem ca-key.pem admin@192.168.9.149:/etc/kubernetes/ssl</span><br><span class="line">[admin@haifly-bj-dev-k8s-master1 cfssl]$ scp ca.pem ca-key.pem admin@192.168.9.150:/etc/kubernetes/ssl</span><br></pre></td></tr></tbody></table></figure><h2 id="二、搭建三节点的etcd集群"><a href="#二、搭建三节点的etcd集群" class="headerlink" title="二、搭建三节点的etcd集群"></a>二、搭建三节点的etcd集群</h2><p>搭建步骤：</p><ol><li>准备安装包</li><li>创建etcd签名请求：</li><li>生成etcd证书和私钥</li><li>分发etcd的证书</li><li>设置ETCD配置文件</li><li>配置完后启动etcd</li><li>查看状态集群的状态是否正常</li></ol><h3 id="1-准备安装包"><a href="#1-准备安装包" class="headerlink" title="1.准备安装包"></a>1.准备安装包</h3><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[admin@haifly-bj-dev-k8s-master1 cfssl]$ ll ~/kubernetes/bin/</span><br><span class="line">-rwxr-xr-x 1 admin admin 19237536 May 27 10:07 etcd</span><br><span class="line">-rwxr-xr-x 1 admin admin 15817472 May 27 10:07 etcdctl</span><br><span class="line">[admin@haifly-bj-dev-k8s-master1 cfssl]$ scp ~/kubernetes/bin/etcd* admin@192.168.9.149:/etc/kubernetes/bin</span><br><span class="line">[admin@haifly-bj-dev-k8s-master1 cfssl]$ scp ~/kubernetes/bin/etcd* admin@192.168.10.177:/etc/kubernetes/bin</span><br></pre></td></tr></tbody></table></figure><h3 id="2-创建etcd签名请求"><a href="#2-创建etcd签名请求" class="headerlink" title="2.创建etcd签名请求"></a>2.创建etcd签名请求</h3><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">[admin@haifly-bj-dev-k8s-master1 cfssl]$ cat &lt;&lt;EOF&gt;&gt; etcd-csr.json </span><br><span class="line">{</span><br><span class="line">  <span class="string">"CN"</span>: <span class="string">"etcd"</span>,</span><br><span class="line">  <span class="string">"hosts"</span>: [</span><br><span class="line">    <span class="string">"127.0.0.1"</span>,</span><br><span class="line">    <span class="string">"192.168.9.148"</span>,</span><br><span class="line">    <span class="string">"192.168.9.149"</span>,</span><br><span class="line">    <span class="string">"192.168.9.150"</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="string">"key"</span>: {</span><br><span class="line">    <span class="string">"algo"</span>: <span class="string">"rsa"</span>,</span><br><span class="line">    <span class="string">"size"</span>: 2048</span><br><span class="line">  },</span><br><span class="line">  <span class="string">"names"</span>: [</span><br><span class="line">    {</span><br><span class="line">      <span class="string">"C"</span>: <span class="string">"CN"</span>,</span><br><span class="line">      <span class="string">"ST"</span>: <span class="string">"BeiJing"</span>,</span><br><span class="line">      <span class="string">"L"</span>: <span class="string">"BeiJing"</span>,</span><br><span class="line">      <span class="string">"O"</span>: <span class="string">"k8s"</span>,</span><br><span class="line">      <span class="string">"OU"</span>: <span class="string">"System"</span></span><br><span class="line">    }</span><br><span class="line">  ]</span><br><span class="line">}</span><br><span class="line">EOF</span><br></pre></td></tr></tbody></table></figure><h3 id="3-生成etcd证书和私钥"><a href="#3-生成etcd证书和私钥" class="headerlink" title="3.生成etcd证书和私钥"></a>3.生成etcd证书和私钥</h3><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[admin@haifly-bj-dev-k8s-master1 cfssl]$ cfssl gencert -ca=/work/admin/kubernetes/cfssl/ca.pem \</span><br><span class="line">   -ca-key=/work/admin/kubernetes/cfssl/ca-key.pem \</span><br><span class="line">   -config=/work/admin/kubernetes/cfssl/ca-config.json \</span><br><span class="line">   -profile=kubernetes etcd-csr.json | cfssljson -bare etcd</span><br><span class="line">2019/05/27 10:18:13 [INFO] generate received request</span><br><span class="line">2019/05/27 10:18:13 [INFO] received CSR</span><br><span class="line">2019/05/27 10:18:13 [INFO] generating key: rsa-2048</span><br><span class="line">2019/05/27 10:18:13 [INFO] encoded CSR</span><br><span class="line">2019/05/27 10:18:13 [INFO] signed certificate with serial number 581380436007405715369541007082781715569637270273</span><br><span class="line">2019/05/27 10:18:13 [WARNING] This certificate lacks a <span class="string">"hosts"</span> field. This makes it unsuitable <span class="keyword">for</span></span><br><span class="line">websites. For more information see the Baseline Requirements <span class="keyword">for</span> the Issuance and Management</span><br><span class="line">of Publicly-Trusted Certificates, v.1.1.6, from the CA/Browser Forum (https://cabforum.org);</span><br><span class="line">specifically, section 10.2.3 (<span class="string">"Information Requirements"</span>).</span><br><span class="line">[admin@haifly-bj-dev-k8s-master1 cfssl]$ ll etcd*</span><br><span class="line">-rw-r--r-- 1 admin admin 1062 May 27 10:18 etcd.csr</span><br><span class="line">-rw-rw-r-- 1 admin admin  300 May 27 10:22 etcd-csr.json</span><br><span class="line">-rw------- 1 admin admin 1675 May 27 10:18 etcd-key.pem</span><br><span class="line">-rw-rw-r-- 1 admin admin 1436 May 27 10:18 etcd.pem</span><br></pre></td></tr></tbody></table></figure><h3 id="4-分发etcd证书"><a href="#4-分发etcd证书" class="headerlink" title="4.分发etcd证书"></a>4.分发etcd证书</h3><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[admin@haifly-bj-dev-k8s-master1 cfssl]$ cp etcd*.pem ~/kubernetes/ssl/</span><br><span class="line">[admin@haifly-bj-dev-k8s-master1 cfssl]$ scp etcd*.pem admin@192.168.9.149:~/kubernetes/ssl/  </span><br><span class="line">[admin@haifly-bj-dev-k8s-master1 cfssl]$ scp etcd*.pem admin@192.168.9.150:~/kubernetes/ssl/</span><br></pre></td></tr></tbody></table></figure><h3 id="5-设置etcd配置文件"><a href="#5-设置etcd配置文件" class="headerlink" title="5.设置etcd配置文件"></a>5.设置etcd配置文件</h3><p>设置etcd的配置有两种方式：</p><ul><li>所有的配置都写在service文件中</li><li>配置文件写在<code>/ect/kubernetes/cfg</code>中，然后在service文件中加上配置的地址</li></ul><p>下面我把两种方式的实现都写出来</p><h3 id="5-1-配置方法1"><a href="#5-1-配置方法1" class="headerlink" title="5.1 配置方法1"></a>5.1 配置方法1</h3><p>先配置etcd.conf 注意：除了<code>ETCD_INITIAL_CLUSTER</code>不改变外，剩下的其他地方涉及到了ip地址的，都需要替换成相应node的ip地址。 另外，要注意<code>ETCD_NAME</code>要和下面的<code>ETCD_INITIAL_CLUSTER</code>中描述的名字对应上。</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">[admin@haifly-bj-dev-k8s-master1 cfg]$ <span class="built_in">pwd</span></span><br><span class="line">/work/admin/kubernetes/cfg</span><br><span class="line">[admin@haifly-bj-dev-k8s-master1 cfg]$ cat &lt;&lt;EOF&gt;&gt; etcd.conf</span><br><span class="line"><span class="comment">#[member]</span></span><br><span class="line">ETCD_NAME=<span class="string">"etcd-node1"</span></span><br><span class="line">ETCD_DATA_DIR=<span class="string">"/var/lib/etcd/default.etcd"</span></span><br><span class="line"><span class="comment">#ETCD_SNAPSHOT_COUNTER="10000"</span></span><br><span class="line"><span class="comment">#ETCD_HEARTBEAT_INTERVAL="100"</span></span><br><span class="line"><span class="comment">#ETCD_ELECTION_TIMEOUT="1000"</span></span><br><span class="line">ETCD_LISTEN_PEER_URLS=<span class="string">"https://192.168.9.148:2380"</span></span><br><span class="line">ETCD_LISTEN_CLIENT_URLS=<span class="string">"https://192.168.9.148:2379,https://127.0.0.1:2379"</span></span><br><span class="line"><span class="comment">#ETCD_MAX_SNAPSHOTS="5"</span></span><br><span class="line"><span class="comment">#ETCD_MAX_WALS="5"</span></span><br><span class="line"><span class="comment">#ETCD_CORS=""</span></span><br><span class="line"><span class="comment">#[cluster]</span></span><br><span class="line">ETCD_INITIAL_ADVERTISE_PEER_URLS=<span class="string">"https://192.168.9.148:2380"</span></span><br><span class="line"><span class="comment"># if you use different ETCD_NAME (e.g. test),</span></span><br><span class="line"><span class="comment"># set ETCD_INITIAL_CLUSTER value for this name, i.e. "test=http://..."</span></span><br><span class="line">ETCD_INITIAL_CLUSTER=<span class="string">"etcd-node1=https://192.168.9.148:2380,etcd-node2=https://192.168.9.149:2380,etcd-node3=https://192.168.9.150:2380"</span></span><br><span class="line">ETCD_INITIAL_CLUSTER_STATE=<span class="string">"new"</span></span><br><span class="line">ETCD_INITIAL_CLUSTER_TOKEN=<span class="string">"k8s-etcd-cluster"</span></span><br><span class="line">ETCD_ADVERTISE_CLIENT_URLS=<span class="string">"https://192.168.9.148:2379"</span></span><br><span class="line"><span class="comment">#[security]</span></span><br><span class="line">CLIENT_CERT_AUTH=<span class="string">"true"</span></span><br><span class="line">ETCD_CA_FILE=<span class="string">"/work/admin/kubernetes/ssl/ca.pem"</span></span><br><span class="line">ETCD_CERT_FILE=<span class="string">"/work/admin/kubernetes/ssl/etcd.pem"</span></span><br><span class="line">ETCD_KEY_FILE=<span class="string">"/work/admin/kubernetes/ssl/etcd-key.pem"</span></span><br><span class="line">PEER_CLIENT_CERT_AUTH=<span class="string">"true"</span></span><br><span class="line">ETCD_PEER_CA_FILE=<span class="string">"/work/admin/kubernetes/ssl/ca.pem"</span></span><br><span class="line">ETCD_PEER_CERT_FILE=<span class="string">"/work/admin/kubernetes/ssl/etcd.pem"</span></span><br><span class="line">ETCD_PEER_KEY_FILE=<span class="string">"/work/admin/kubernetes/ssl/etcd-key.pem"</span></span><br><span class="line">EOF</span><br></pre></td></tr></tbody></table></figure><p>再在服务文件中将配置加上去</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[admin@haifly-bj-dev-k8s-master1 cfg]$ cat /etc/systemd/system/etcd.service</span><br><span class="line">[Unit]</span><br><span class="line">Description=Etcd Server</span><br><span class="line">After=network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=simple</span><br><span class="line">WorkingDirectory=/var/lib/etcd</span><br><span class="line">EnvironmentFile=-/work/admin/kubernetes/cfg/etcd.conf</span><br><span class="line"><span class="comment"># set GOMAXPROCS to number of processors</span></span><br><span class="line">ExecStart=/bin/bash -c <span class="string">"GOMAXPROCS=<span class="variable">$(nproc)</span> /work/admin/kubernetes/bin/etcd"</span></span><br><span class="line">Type=notify</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></tbody></table></figure><h3 id="5-2-配置方法2"><a href="#5-2-配置方法2" class="headerlink" title="5.2 配置方法2"></a>5.2 配置方法2</h3><p>注意：除了<code>initial-cluster</code>不改变外，剩下的其他地方涉及到了ip地址的，都需要替换成相应node的ip地址</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">[admin@haifly-bj-dev-k8s-master1 ~]$ cat /usr/lib/systemd/system/etcd.service</span><br><span class="line">[Unit]</span><br><span class="line">Description=Etcd Server</span><br><span class="line">After=network.target</span><br><span class="line">After=network-online.target</span><br><span class="line">Wants=network-online.target</span><br><span class="line">Documentation=https://github.com/coreos</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=notify</span><br><span class="line">WorkingDirectory=/var/lib/etcd/</span><br><span class="line">EnvironmentFile=-/etc/etcd/etcd.conf</span><br><span class="line">ExecStart=/work/admin/kubernetes/bin/etcd \</span><br><span class="line">--name=etcd-node1 \</span><br><span class="line">--cert-file=/work/admin/kubernetes/ssl/etcd.pem \</span><br><span class="line">--key-file=/work/admin/kubernetes/ssl/etcd-key.pem \</span><br><span class="line">--peer-cert-file=/work/admin/kubernetes/ssl/etcd.pem \</span><br><span class="line">--peer-key-file=/work/admin/kubernetes/ssl/etcd-key.pem \</span><br><span class="line">--trusted-ca-file=/work/admin/kubernetes/ssl/ca.pem \</span><br><span class="line">--peer-trusted-ca-file=/work/admin/kubernetes/ssl/ca.pem \</span><br><span class="line">--initial-advertise-peer-urls=https://192.168.9.148:2380 \</span><br><span class="line">--listen-peer-urls=https://192.168.9.148:2380 \</span><br><span class="line">--listen-client-urls=https://192.168.9.148:2379,https://127.0.0.1:2379,http://127.0.0.1:2379 \</span><br><span class="line">--advertise-client-urls=https://192.168.9.148:2379 \</span><br><span class="line">--initial-cluster-token=etcd-cluster-0 \</span><br><span class="line">--initial-cluster=<span class="string">"etcd-node1=https://192.168.9.148:2380,etcd-node2=https://192.168.9.149:2380,etcd-node3=https://192.168.9.150:2380"</span> \</span><br><span class="line">--initial-cluster-state=new \</span><br><span class="line">--data-dir=/var/lib/etcd</span><br><span class="line">Restart=on-failure</span><br><span class="line">RestartSec=5</span><br><span class="line">LimitNOFILE=65536</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></tbody></table></figure><h3 id="6-启动etcd"><a href="#6-启动etcd" class="headerlink" title="6.启动etcd"></a>6.启动etcd</h3><p>注意，配置完第一个先不着急启动，等其他两个节点的配置完成后，三个节点同时启动etcd，否则第一个节点先启动时会一直夯在那儿。</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[admin@haifly-bj-dev-k8s-master1 ~]$ sudo systemctl daemon-reload</span><br><span class="line">[admin@haifly-bj-dev-k8s-master1 ~]$ sudo systemctl <span class="built_in">enable</span> etcd</span><br><span class="line"></span><br><span class="line">复制相应的配置信息到其他节点，记住一定要修改后才能用！</span><br><span class="line">[admin@haifly-bj-dev-k8s-master1 ~]$ scp ~/kubernetes/cfg/etcd.conf admin@192.168.9.149:~/kubernetes/cfg/ </span><br><span class="line">[admin@haifly-bj-dev-k8s-master1 ~]$ scp /etc/systemd/system/etcd.service admin@192.168.9.149:/etc/systemd/system/etcd.service</span><br><span class="line">[admin@haifly-bj-dev-k8s-master1 ~]$ scp ~/kubernetes/cfg/etcd.conf admin@192.168.9.150:~/kubernetes/cfg/ </span><br><span class="line">[admin@haifly-bj-dev-k8s-master1 ~]$ scp /etc/systemd/system/etcd.service admin@192.168.9.150:/etc/systemd/system/etcd.service</span><br><span class="line"></span><br><span class="line">在所有节点上创建etcd存储目录并启动etcd</span><br><span class="line">[admin@haifly-bj-dev-k8s-master1 ~]$ sudo mkdir /var/lib/etcd</span><br><span class="line">[admin@haifly-bj-dev-k8s-master1 ~]$ sudo systemctl start etcd</span><br></pre></td></tr></tbody></table></figure><h3 id="7-查看etcd集群状态"><a href="#7-查看etcd集群状态" class="headerlink" title="7.查看etcd集群状态"></a>7.查看etcd集群状态</h3><h3 id="master1-etcd-node1-的状态"><a href="#master1-etcd-node1-的状态" class="headerlink" title="master1(etcd-node1)的状态"></a>master1(etcd-node1)的状态</h3><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[admin@haifly-bj-dev-k8s-master1 ~]$ systemctl status etcd</span><br><span class="line">● etcd.service - Etcd Server</span><br><span class="line">   Loaded: loaded (/etc/systemd/system/etcd.service; disabled; vendor preset: disabled)</span><br><span class="line">   Active: active (running) since Mon 2019-05-27 11:34:25 CST; 13s ago</span><br><span class="line"> Main PID: 1274 (etcd)</span><br><span class="line">   CGroup: /system.slice/etcd.service</span><br><span class="line">           └─1274 /work/admin/kubernetes/bin/etcd</span><br></pre></td></tr></tbody></table></figure><h3 id="master2-etcd-node2-的状态"><a href="#master2-etcd-node2-的状态" class="headerlink" title="master2(etcd-node2)的状态"></a>master2(etcd-node2)的状态</h3><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[admin@haifly-bj-dev-k8s-master2 ~]$ systemctl status etcd</span><br><span class="line">● etcd.service - Etcd Server</span><br><span class="line">   Loaded: loaded (/etc/systemd/system/etcd.service; enabled; vendor preset: disabled)</span><br><span class="line">   Active: active (running) since Mon 2019-05-27 11:34:09 CST; 1h 3min ago</span><br><span class="line"> Main PID: 1340 (etcd)</span><br><span class="line">   CGroup: /system.slice/etcd.service</span><br><span class="line">           └─1340 /work/admin/kubernetes/bin/etcd</span><br></pre></td></tr></tbody></table></figure><h3 id="node1-etcd-node3-的状态"><a href="#node1-etcd-node3-的状态" class="headerlink" title="node1(etcd-node3)的状态"></a>node1(etcd-node3)的状态</h3><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[admin@haifly-bj-dev-k8s-node1 ~]$ systemctl status etcd</span><br><span class="line">● etcd.service - Etcd Server</span><br><span class="line">   Loaded: loaded (/etc/systemd/system/etcd.service; enabled; vendor preset: disabled)</span><br><span class="line">   Active: active (running) since Mon 2019-05-27 11:34:09 CST; 1h 9min ago</span><br><span class="line"> Main PID: 1596 (etcd)</span><br><span class="line">   Memory: 27.6M</span><br><span class="line">   CGroup: /system.slice/etcd.service</span><br><span class="line">           └─1596 /work/admin/kubernetes/bin/etcd</span><br></pre></td></tr></tbody></table></figure><h3 id="8-用命令查看集群状态"><a href="#8-用命令查看集群状态" class="headerlink" title="8.用命令查看集群状态"></a>8.用命令查看集群状态</h3><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">[admin@haifly-bj-dev-k8s-master1 ~]$ ~/kubernetes/bin/etcdctl --endpoints=https://192.168.9.148:2379,https://192.168.9.149:2379,https://192.168.9.150:2379 \</span><br><span class="line">  --ca-file=/work/admin/kubernetes/ssl/ca.pem \</span><br><span class="line">  --cert-file=/work/admin/kubernetes/ssl/etcd.pem \</span><br><span class="line">  --key-file=/work/admin/kubernetes/ssl/etcd-key.pem cluster-health</span><br><span class="line">member 9e08e3b367dcae6d is healthy: got healthy result from https://192.168.9.148:2379</span><br><span class="line">member d474e742dc1ac302 is healthy: got healthy result from https://192.168.9.150:2379</span><br><span class="line">member e01ade2c3426b65a is healthy: got healthy result from https://192.168.9.149:2379</span><br><span class="line">cluster is healthy</span><br><span class="line"></span><br><span class="line">[admin@haifly-bj-dev-k8s-master1 cfssl]$  ~/kubernetes/bin/etcdctl --endpoints=https://192.168.9.148:2379,https://192.168.9.149:2379,https://192.168.9.150:2379 \</span><br><span class="line">  --ca-file=/work/admin/kubernetes/ssl/ca.pem \</span><br><span class="line">  --cert-file=/work/admin/kubernetes/ssl/etcd.pem \</span><br><span class="line">  --key-file=/work/admin/kubernetes/ssl/etcd-key.pem member list</span><br><span class="line">9e08e3b367dcae6d: name=etcd-node1 peerURLs=https://192.168.9.148:2380 clientURLs=https://192.168.9.148:2379 isLeader=<span class="literal">false</span></span><br><span class="line">e01ade2c3426b65a: name=etcd-node2 peerURLs=https://192.168.9.149:2380 clientURLs=https://192.168.9.149:2379 isLeader=<span class="literal">false</span></span><br><span class="line">e94f3a70f0d2730e: name=etcd-node3 peerURLs=https://192.168.9.150:2380 clientURLs=https://192.168.9.150:2379 isLeader=<span class="literal">true</span></span><br><span class="line"></span><br><span class="line">创建检索：</span><br><span class="line">[admin@haifly-bj-dev-k8s-master1 cfssl]$ ~/kubernetes/bin/etcdctl --endpoints=https://192.168.9.148:2379,https://192.168.9.149:2379,https://192.168.9.150:2379 \</span><br><span class="line">  --ca-file=/work/admin/kubernetes/ssl/ca.pem \</span><br><span class="line">  --cert-file=/work/admin/kubernetes/ssl/etcd.pem \</span><br><span class="line">  --key-file=/work/admin/kubernetes/ssl/etcd-key.pem mkdir <span class="built_in">test</span></span><br><span class="line"></span><br><span class="line">查看数据是否同步：</span><br><span class="line">[admin@haifly-bj-dev-k8s-master1 cfssl]$ ~/kubernetes/bin/etcdctl --endpoints=https://192.168.9.148:2379,https://192.168.9.149:2379,https://192.168.9.150:2379 \</span><br><span class="line">  --ca-file=/work/admin/kubernetes/ssl/ca.pem \</span><br><span class="line">  --cert-file=/work/admin/kubernetes/ssl/etcd.pem \</span><br><span class="line">  --key-file=/work/admin/kubernetes/ssl/etcd-key.pem ls</span><br><span class="line">/<span class="built_in">test</span></span><br></pre></td></tr></tbody></table></figure><p>这里小小的调优一下etcd timeout时间（默认100ms）</p><p>~/kubernetes/bin/etcd –heartbeat-interval=100 –election-timeout=500</p><p># 环境参数:</p><p>ETCD_HEARTBEAT_INTERVAL=100 ETCD_ELECTION_TIMEOUT=500 etcd</p><h2 id="三、部署master节点"><a href="#三、部署master节点" class="headerlink" title="三、部署master节点"></a>三、部署master节点</h2><p>1.准备安装包<br>2.创建生成kubernetes的CSR的 JSON 配置文件<br>3.生成 kubernetes 证书和私钥<br>4.分发证书<br>5.配置 kube-apiserver<br>5.1 创建 kube-apiserver 使用的客户端 token 文件<br>5.2 创建基础用户名/密码认证配置(abac)<br>5.3 部署kube-apiserver服务<br>5.4 启动kube-apiserver服务<br>5.5 查看kube-apiserver服务状态<br>6.配置kube-controller-manager<br>6.1 部署kube-controller-manager服务<br>6.2 启动kube-controller-manager服务<br>6.3 查看kube-controller-manager服务状态<br>7.配置kube-scheduler<br>7.1 部署kube-scheduler服务<br>7.2 启动 kube-scheduler 服务<br>7.3 查看 kube-scheduler 状态</p><h3 id="1-准备安装包-1"><a href="#1-准备安装包-1" class="headerlink" title="1.准备安装包"></a>1.准备安装包</h3><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[admin@haifly-bj-dev-k8s-master1 ~]$ ll ~/kubernetes/bin/</span><br><span class="line">total 552068</span><br><span class="line">-rwxr-xr-x 1 admin admin  19237536 May 27 10:07 etcd</span><br><span class="line">-rwxr-xr-x 1 admin admin  15817472 May 27 10:07 etcdctl</span><br><span class="line">-rwxr-xr-x 1 admin admin 167595360 May 27 12:57 kube-apiserver</span><br><span class="line">-rwxr-xr-x 1 admin admin 115612192 May 27 12:57 kube-controller-manager</span><br><span class="line">-rwxr-xr-x 1 admin admin  39258304 May 27 12:57 kube-scheduler</span><br></pre></td></tr></tbody></table></figure><h3 id="2-创建生成kubernetes的CSR的-JSON-配置文件"><a href="#2-创建生成kubernetes的CSR的-JSON-配置文件" class="headerlink" title="2.创建生成kubernetes的CSR的 JSON 配置文件"></a>2.创建生成kubernetes的CSR的 JSON 配置文件</h3><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">[admin@haifly-bj-dev-k8s-master1 ~]$ <span class="built_in">cd</span> kubernetes/cfssl/</span><br><span class="line">[admin@haifly-bj-dev-k8s-master1 cfssl]$ cat &lt;&lt;EOF&gt;&gt; kubernetes-csr.json</span><br><span class="line">{</span><br><span class="line">  <span class="string">"CN"</span>: <span class="string">"kubernetes"</span>,</span><br><span class="line">  <span class="string">"hosts"</span>: [</span><br><span class="line">    <span class="string">"127.0.0.1"</span>,</span><br><span class="line">    <span class="string">"10.1.0.1"</span>,</span><br><span class="line">    <span class="string">"192.168.9.148"</span>,</span><br><span class="line">    <span class="string">"192.168.9.149"</span>,</span><br><span class="line">    <span class="string">"192.168.9.150"</span>,</span><br><span class="line">    <span class="string">"192.168.7.177"</span>,</span><br><span class="line">    <span class="string">"192.168.7.178"</span>,</span><br><span class="line">    <span class="string">"kubernetes"</span>,</span><br><span class="line">    <span class="string">"kubernetes.default"</span>,</span><br><span class="line">    <span class="string">"kubernetes.default.svc"</span>,</span><br><span class="line">    <span class="string">"kubernetes.default.svc.cluster"</span>,</span><br><span class="line">    <span class="string">"kubernetes.default.svc.cluster.local"</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="string">"key"</span>: {</span><br><span class="line">    <span class="string">"algo"</span>: <span class="string">"rsa"</span>,</span><br><span class="line">    <span class="string">"size"</span>: 2048</span><br><span class="line">  },</span><br><span class="line">  <span class="string">"names"</span>: [</span><br><span class="line">    {</span><br><span class="line">      <span class="string">"C"</span>: <span class="string">"CN"</span>,</span><br><span class="line">      <span class="string">"ST"</span>: <span class="string">"BeiJing"</span>,</span><br><span class="line">      <span class="string">"L"</span>: <span class="string">"BeiJing"</span>,</span><br><span class="line">      <span class="string">"O"</span>: <span class="string">"k8s"</span>,</span><br><span class="line">      <span class="string">"OU"</span>: <span class="string">"System"</span></span><br><span class="line">    }</span><br><span class="line">  ]</span><br><span class="line">}</span><br><span class="line">EOF</span><br></pre></td></tr></tbody></table></figure><h3 id="3-生成kubernetes证书和私钥"><a href="#3-生成kubernetes证书和私钥" class="headerlink" title="3.生成kubernetes证书和私钥"></a>3.生成kubernetes证书和私钥</h3><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[admin@haifly-bj-dev-k8s-master1 cfssl]$ cfssl gencert -ca=/work/admin/kubernetes/cfssl/ca.pem \</span><br><span class="line">   -ca-key=/work/admin/kubernetes/cfssl/ca-key.pem \</span><br><span class="line">   -config=/work/admin/kubernetes/cfssl/ca-config.json \</span><br><span class="line">   -profile=kubernetes kubernetes-csr.json | cfssljson -bare kubernetes</span><br><span class="line">2019/05/27 13:53:24 [INFO] generate received request</span><br><span class="line">2019/05/27 13:53:24 [INFO] received CSR</span><br><span class="line">2019/05/27 13:53:24 [INFO] generating key: rsa-2048</span><br><span class="line">2019/05/27 13:53:24 [INFO] encoded CSR</span><br><span class="line">2019/05/27 13:53:24 [INFO] signed certificate with serial number 256951686520375414970420988042970133531805257836</span><br><span class="line">2019/05/27 13:53:24 [WARNING] This certificate lacks a <span class="string">"hosts"</span> field. This makes it unsuitable <span class="keyword">for</span></span><br><span class="line">websites. For more information see the Baseline Requirements <span class="keyword">for</span> the Issuance and Management</span><br><span class="line">of Publicly-Trusted Certificates, v.1.1.6, from the CA/Browser Forum (https://cabforum.org);</span><br><span class="line">specifically, section 10.2.3 (<span class="string">"Information Requirements"</span>).</span><br><span class="line">[admin@haifly-bj-dev-k8s-master1 cfssl]$ </span><br><span class="line">[admin@haifly-bj-dev-k8s-master1 cfssl]$ ll kubernetes*</span><br><span class="line">-rw-r--r-- 1 admin admin 1253 May 27 13:53 kubernetes.csr</span><br><span class="line">-rw-rw-r-- 1 admin admin  461 May 27 13:52 kubernetes-csr.json</span><br><span class="line">-rw------- 1 admin admin 1679 May 27 13:53 kubernetes-key.pem</span><br><span class="line">-rw-rw-r-- 1 admin admin 1619 May 27 13:53 kubernetes.pem</span><br></pre></td></tr></tbody></table></figure><h3 id="4-分发证书-1"><a href="#4-分发证书-1" class="headerlink" title="4.分发证书"></a>4.分发证书</h3><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[admin@haifly-bj-dev-k8s-master1 cfssl]$ cp kubernetes*.pem ~/kubernetes/ssl/</span><br><span class="line">[admin@haifly-bj-dev-k8s-master1 cfssl]$ scp kubernetes*.pem admin@192.168.9.149:~/kubernetes/ssl/</span><br></pre></td></tr></tbody></table></figure><h3 id="5-配置-kube-apiserver"><a href="#5-配置-kube-apiserver" class="headerlink" title="5.配置 kube-apiserver"></a>5.配置 kube-apiserver</h3><h3 id="5-1创建kube-apiserver使用的客户端token文件"><a href="#5-1创建kube-apiserver使用的客户端token文件" class="headerlink" title="5.1创建kube-apiserver使用的客户端token文件"></a>5.1创建kube-apiserver使用的客户端token文件</h3><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[admin@haifly-bj-dev-k8s-master1 cfssl]$ head -c 16 /dev/urandom | od -An -t x | tr -d <span class="string">' '</span></span><br><span class="line">c25603db53aff8d0111b4e45c281ab32</span><br><span class="line">[admin@haifly-bj-dev-k8s-master1 cfssl]$ vim ~/kubernetes/ssl/bootstrap-token.csv</span><br><span class="line">[admin@haifly-bj-dev-k8s-master1 cfssl]$ cat ~/kubernetes/ssl/bootstrap-token.csv</span><br><span class="line">c25603db53aff8d0111b4e45c281ab32,kubelet-bootstrap,10001,<span class="string">"system:kubelet-bootstrap"</span></span><br><span class="line"></span><br><span class="line">拷贝 bootstrap-token.csv 到另一台master服务器上</span><br><span class="line">[admin@haifly-bj-dev-k8s-master1 cfssl]$ scp ~/kubernetes/ssl/bootstrap-token.csv admin@192.168.9.149:~/kubernetes/ssl/</span><br></pre></td></tr></tbody></table></figure><h3 id="5-2-部署kube-apiserver服务"><a href="#5-2-部署kube-apiserver服务" class="headerlink" title="5.2 部署kube-apiserver服务"></a>5.2 部署kube-apiserver服务</h3><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">[admin@haifly-bj-dev-k8s-master1 cfssl]$ cat /etc/systemd/system/kube-apiserver.service</span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes API Server</span><br><span class="line">Documentation=https://github.com/kubernetes/kubernetes</span><br><span class="line">After=network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">ExecStart=/work/admin/kubernetes/bin/kube-apiserver \</span><br><span class="line">  --admission-control=NamespaceLifecycle,LimitRanger,ServiceAccount,DefaultStorageClass,ResourceQuota,NodeRestriction \</span><br><span class="line">  --insecure-bind-address=127.0.0.1 \</span><br><span class="line">  --authorization-mode=Node,RBAC \</span><br><span class="line">  --runtime-config=rbac.authorization.k8s.io/v1 \</span><br><span class="line">  --kubelet-https=<span class="literal">true</span> \</span><br><span class="line">  --<span class="built_in">enable</span>-bootstrap-token-auth \</span><br><span class="line">  --token-auth-file=/work/admin/kubernetes/ssl/bootstrap-token.csv \</span><br><span class="line">  --service-cluster-ip-range=10.1.0.0/16 \</span><br><span class="line">  --service-node-port-range=20000-40000 \</span><br><span class="line">  --tls-cert-file=/work/admin/kubernetes/ssl/kubernetes.pem \</span><br><span class="line">  --tls-private-key-file=/work/admin/kubernetes/ssl/kubernetes-key.pem \</span><br><span class="line">  --client-ca-file=/work/admin/kubernetes/ssl/ca.pem \</span><br><span class="line">  --service-account-key-file=/work/admin/kubernetes/ssl/ca-key.pem \</span><br><span class="line">  --etcd-cafile=/work/admin/kubernetes/ssl/ca.pem \</span><br><span class="line">  --etcd-certfile=/work/admin/kubernetes/ssl/kubernetes.pem \</span><br><span class="line">  --etcd-keyfile=/work/admin/kubernetes/ssl/kubernetes-key.pem \</span><br><span class="line">  --etcd-servers=https://192.168.9.148:2379,https://192.168.9.149:2379,https://192.168.9.150:2379 \</span><br><span class="line">  --<span class="built_in">enable</span>-swagger-ui=<span class="literal">true</span> \</span><br><span class="line">  --allow-privileged=<span class="literal">true</span> \</span><br><span class="line">  --audit-log-maxage=30 \</span><br><span class="line">  --audit-log-maxbackup=3 \</span><br><span class="line">  --audit-log-maxsize=100 \</span><br><span class="line">  --audit-log-path=/work/admin/kubernetes/<span class="built_in">log</span>/api-audit.log \</span><br><span class="line">  --event-ttl=1h \</span><br><span class="line">  --v=2 \</span><br><span class="line">  --logtostderr=<span class="literal">false</span> \</span><br><span class="line">  --<span class="built_in">log</span>-dir=/work/admin/kubernetes/<span class="built_in">log</span></span><br><span class="line">Restart=on-failure</span><br><span class="line">RestartSec=5</span><br><span class="line">Type=notify</span><br><span class="line">LimitNOFILE=65536</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></tbody></table></figure><h3 id="5-3-启动kube-apiserver"><a href="#5-3-启动kube-apiserver" class="headerlink" title="5.3 启动kube-apiserver"></a>5.3 启动kube-apiserver</h3><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[admin@haifly-bj-dev-k8s-master1 cfssl]$ sudo systemctl daemon-reload</span><br><span class="line">[admin@haifly-bj-dev-k8s-master1 cfssl]$ sudo systemctl <span class="built_in">enable</span> kube-apiserver</span><br><span class="line">[admin@haifly-bj-dev-k8s-master1 cfssl]$ sudo systemctl start kube-apiserver</span><br><span class="line">[admin@haifly-bj-dev-k8s-master1 ssl]$ systemctl status kube-apiserver</span><br><span class="line">● kube-apiserver.service - Kubernetes API Server</span><br><span class="line">   Loaded: loaded (/usr/lib/systemd/system/kube-apiserver.service; enabled; vendor preset: disabled)</span><br><span class="line">   Active: active (running) since Mon 2019-05-27 14:17:59 CST; 2min 59s ago</span><br><span class="line">     Docs: https://github.com/kubernetes/kubernetes</span><br><span class="line"> Main PID: 1741 (kube-apiserver)</span><br><span class="line">   CGroup: /system.slice/kube-apiserver.service</span><br><span class="line">           └─1741 /work/admin/kubernetes/bin/kube-apiserver --admission-control=NamespaceLifecycle,LimitRanger...</span><br><span class="line">[admin@haifly-bj-dev-k8s-master1 ssl]$</span><br></pre></td></tr></tbody></table></figure><h3 id="6-配置kube-controller-manager"><a href="#6-配置kube-controller-manager" class="headerlink" title="6.配置kube-controller-manager"></a>6.配置kube-controller-manager</h3><h3 id="6-1部署kube-controller-manager"><a href="#6-1部署kube-controller-manager" class="headerlink" title="6.1部署kube-controller-manager"></a>6.1部署kube-controller-manager</h3><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">[admin@haifly-bj-dev-k8s-master1 ssl]$ cat /etc/systemd/system/kube-controller-manager.service</span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes Controller Manager</span><br><span class="line">Documentation=https://github.com/kubernetes/kubernetes</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">ExecStart=/work/admin/kubernetes/bin/kube-controller-manager \</span><br><span class="line">  --<span class="built_in">bind</span>-address=127.0.0.1 \</span><br><span class="line">  --master=http://127.0.0.1:8080 \</span><br><span class="line">  --allocate-node-cidrs=<span class="literal">true</span> \</span><br><span class="line">  --service-cluster-ip-range=10.1.0.0/16 \</span><br><span class="line">  --cluster-cidr=10.2.0.0/16 \</span><br><span class="line">  --cluster-name=kubernetes \</span><br><span class="line">  --cluster-signing-cert-file=/work/admin/kubernetes/ssl/ca.pem \</span><br><span class="line">  --cluster-signing-key-file=/work/admin/kubernetes/ssl/ca-key.pem \</span><br><span class="line">  --service-account-private-key-file=/work/admin/kubernetes/ssl/ca-key.pem \</span><br><span class="line">  --root-ca-file=/work/admin/kubernetes/ssl/ca.pem \</span><br><span class="line">  --leader-elect=<span class="literal">true</span> \</span><br><span class="line">  --v=2 \</span><br><span class="line">  --logtostderr=<span class="literal">false</span> \</span><br><span class="line">  --<span class="built_in">log</span>-dir=/work/admin/kubernetes/<span class="built_in">log</span></span><br><span class="line"></span><br><span class="line">Restart=on-failure</span><br><span class="line">RestartSec=5</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></tbody></table></figure><ul><li><code>--master=http://{MASTER_IP}:8080</code>：使用非安全 8080 端口与 kube-apiserver 通信；</li><li><code>--cluster-cidr</code> 指定 Cluster 中 Pod 的 CIDR 范围，该网段在各 Node 间必须路由可达(flanneld保证)；</li><li><code>--service-cluster-ip-range</code> 参数指定 Cluster 中 Service 的CIDR范围，该网络在各 Node 间必须路由不可达，必须和 kube-apiserver 中的参数一致；</li><li><code>--cluster-signing-*</code> 指定的证书和私钥文件用来签名为 TLS BootStrap 创建的证书和私钥；</li><li><code>--root-ca-file</code> 用来对 kube-apiserver 证书进行校验，<strong>指定该参数后，才会在Pod 容器的 ServiceAccount 中放置该 CA 证书文件</strong>；</li><li><code>--leader-elect=true</code> 部署多台机器组成的 master 集群时选举产生一处于工作状态的 <code>kube-controller-manager</code> 进程；</li></ul><h3 id="6-2启动kube-controller-manager"><a href="#6-2启动kube-controller-manager" class="headerlink" title="6.2启动kube-controller-manager"></a>6.2启动kube-controller-manager</h3><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[admin@haifly-bj-dev-k8s-master1 cfssl]$ sudo systemctl daemon-reload</span><br><span class="line">[admin@haifly-bj-dev-k8s-master1 cfssl]$ sudo systemctl <span class="built_in">enable</span> kube-controller-manager</span><br><span class="line">[admin@haifly-bj-dev-k8s-master1 cfssl]$ sudo systemctl start kube-controller-manager</span><br></pre></td></tr></tbody></table></figure><h3 id="6-3查看kube-controller-manager服务状态"><a href="#6-3查看kube-controller-manager服务状态" class="headerlink" title="6.3查看kube-controller-manager服务状态"></a>6.3查看kube-controller-manager服务状态</h3><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[admin@haifly-bj-dev-k8s-master1 cfssl]$ systemctl status kube-controller-manager</span><br><span class="line">● kube-controller-manager.service - Kubernetes Controller Manager</span><br><span class="line">   Loaded: loaded (/usr/lib/systemd/system/kube-controller-manager.service; disabled; vendor preset: disabled)</span><br><span class="line">   Active: active (running) since Mon 2019-05-27 14:25:42 CST; 7s ago</span><br><span class="line">     Docs: https://github.com/kubernetes/kubernetes</span><br><span class="line"> Main PID: 1813 (kube-controller)</span><br><span class="line">   CGroup: /system.slice/kube-controller-manager.service</span><br><span class="line">           └─1813 /work/admin/kubernetes/bin/kube-controller-manager --address=192.168.9.148 --master=http://1...</span><br></pre></td></tr></tbody></table></figure><h3 id="7-配置kube-scheduler"><a href="#7-配置kube-scheduler" class="headerlink" title="7.配置kube-scheduler"></a>7.配置kube-scheduler</h3><h3 id="7-1部署kube-scheduler服务"><a href="#7-1部署kube-scheduler服务" class="headerlink" title="7.1部署kube-scheduler服务"></a>7.1部署kube-scheduler服务</h3><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[admin@haifly-bj-dev-k8s-master1 cfssl]$ cat /etc/systemd/system/kube-scheduler.service</span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes Scheduler</span><br><span class="line">Documentation=https://github.com/kubernetes/kubernetes</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">ExecStart=/work/admin/kubernetes/bin/kube-scheduler \</span><br><span class="line">  --address=127.0.0.1 \</span><br><span class="line">  --master=http://127.0.0.1:8080 \</span><br><span class="line">  --leader-elect=<span class="literal">true</span> \</span><br><span class="line">  --v=2 \</span><br><span class="line">  --logtostderr=<span class="literal">false</span> \</span><br><span class="line">  --<span class="built_in">log</span>-dir=/work/admin/kubernetes/<span class="built_in">log</span></span><br><span class="line"></span><br><span class="line">Restart=on-failure</span><br><span class="line">RestartSec=5</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></tbody></table></figure><h3 id="7-2启动kube-scheduler服务"><a href="#7-2启动kube-scheduler服务" class="headerlink" title="7.2启动kube-scheduler服务"></a>7.2启动kube-scheduler服务</h3><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[admin@haifly-bj-dev-k8s-master1 cfssl]$ sudo systemctl daemon-reload</span><br><span class="line">[admin@haifly-bj-dev-k8s-master1 cfssl]$ sudo systemctl <span class="built_in">enable</span> kube-scheduler</span><br><span class="line">[admin@haifly-bj-dev-k8s-master1 cfssl]$ sudo systemctl start kube-scheduler</span><br></pre></td></tr></tbody></table></figure><h3 id="7-3查看kube-scheduler状态"><a href="#7-3查看kube-scheduler状态" class="headerlink" title="7.3查看kube-scheduler状态"></a>7.3查看kube-scheduler状态</h3><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[admin@haifly-bj-dev-k8s-master1 ~]$ systemctl status kube-scheduler</span><br><span class="line">● kube-scheduler.service - Kubernetes Scheduler</span><br><span class="line">   Loaded: loaded (/usr/lib/systemd/system/kube-scheduler.service; enabled; vendor preset: disabled)</span><br><span class="line">   Active: active (running) since Mon 2019-05-27 14:29:53 CST; 2min 32s ago</span><br><span class="line">     Docs: https://github.com/kubernetes/kubernetes</span><br><span class="line"> Main PID: 1832 (kube-scheduler)</span><br><span class="line">   CGroup: /system.slice/kube-scheduler.service</span><br><span class="line">           └─1832 /work/admin/kubernetes/bin/kube-scheduler --address=192.168.9.148 --master=http://192.168.9....</span><br><span class="line">[admin@haifly-bj-dev-k8s-master1 ~]$</span><br></pre></td></tr></tbody></table></figure><h2 id="四、部署kubectl工具"><a href="#四、部署kubectl工具" class="headerlink" title="四、部署kubectl工具"></a>四、部署kubectl工具</h2><p>1.准备二进制文件<br>2.创建 admin 证书签名请求<br>3.生成admin证书<br>4.分发证书<br>5.配置kubectl的使用的config<br>5.1 设置集群参数<br>5.2 设置客户端认证参数<br>5.3 设置上下文参数<br>5.4 设置默认上下文<br>6.使用kubectl查看当前的资源情况</p><h3 id="1-准备二进制文件"><a href="#1-准备二进制文件" class="headerlink" title="1.准备二进制文件"></a>1.准备二进制文件</h3><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[admin@haifly-bj-dev-k8s-master1 cfssl]$ ll ~/kubernetes/bin/</span><br><span class="line">total 552072</span><br><span class="line">-rwxr-xr-x 1 admin admin  19237536 May 27 10:07 etcd</span><br><span class="line">-rwxr-xr-x 1 admin admin  15817472 May 27 10:07 etcdctl</span><br><span class="line">-rwxr-xr-x 1 admin admin 167595360 May 27 12:57 kube-apiserver</span><br><span class="line">-rwxr-xr-x 1 admin admin 115612192 May 27 12:57 kube-controller-manager</span><br><span class="line">-rwxr-xr-x 1 admin admin  43115328 May 27 12:57 kubectl</span><br><span class="line">-rwxr-xr-x 1 admin admin 127981504 May 27 12:57 kubelet</span><br><span class="line">-rwxr-xr-x 1 admin admin  36685440 May 27 12:57 kube-proxy</span><br><span class="line">-rwxr-xr-x 1 admin admin  39258304 May 27 12:57 kube-scheduler</span><br></pre></td></tr></tbody></table></figure><h3 id="2-创建admin证书签名"><a href="#2-创建admin证书签名" class="headerlink" title="2.创建admin证书签名"></a>2.创建admin证书签名</h3><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[admin@haifly-bj-dev-k8s-master1 cfssl]$ cat &lt;&lt;EOF&gt;&gt; admin-csr.json</span><br><span class="line">{</span><br><span class="line">  <span class="string">"CN"</span>: <span class="string">"admin"</span>,</span><br><span class="line">  <span class="string">"hosts"</span>: [],</span><br><span class="line">  <span class="string">"key"</span>: {</span><br><span class="line">    <span class="string">"algo"</span>: <span class="string">"rsa"</span>,</span><br><span class="line">    <span class="string">"size"</span>: 2048</span><br><span class="line">  },</span><br><span class="line">  <span class="string">"names"</span>: [</span><br><span class="line">    {</span><br><span class="line">      <span class="string">"C"</span>: <span class="string">"CN"</span>,</span><br><span class="line">      <span class="string">"ST"</span>: <span class="string">"BeiJing"</span>,</span><br><span class="line">      <span class="string">"L"</span>: <span class="string">"BeiJing"</span>,</span><br><span class="line">      <span class="string">"O"</span>: <span class="string">"system:masters"</span>,</span><br><span class="line">      <span class="string">"OU"</span>: <span class="string">"System"</span></span><br><span class="line">    }</span><br><span class="line">  ]</span><br><span class="line">}</span><br><span class="line">EOF</span><br></pre></td></tr></tbody></table></figure><h3 id="3-生成admin证书"><a href="#3-生成admin证书" class="headerlink" title="3.生成admin证书"></a>3.生成admin证书</h3><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[admin@haifly-bj-dev-k8s-master1 cfssl]$ cfssl gencert -ca=/work/admin/kubernetes/cfssl/ca.pem \</span><br><span class="line">    -ca-key=/work/admin/kubernetes/cfssl/ca-key.pem \</span><br><span class="line">    -config=/work/admin/kubernetes/cfssl/ca-config.json \</span><br><span class="line">    -profile=kubernetes admin-csr.json | cfssljson -bare admin</span><br><span class="line">2019/05/27 14:56:55 [INFO] generate received request</span><br><span class="line">2019/05/27 14:56:55 [INFO] received CSR</span><br><span class="line">2019/05/27 14:56:55 [INFO] generating key: rsa-2048</span><br><span class="line">2019/05/27 14:56:56 [INFO] encoded CSR</span><br><span class="line">2019/05/27 14:56:56 [INFO] signed certificate with serial number 619469735564507398344826076638968754739291644427</span><br><span class="line">2019/05/27 14:56:56 [WARNING] This certificate lacks a <span class="string">"hosts"</span> field. This makes it unsuitable <span class="keyword">for</span></span><br><span class="line">websites. For more information see the Baseline Requirements <span class="keyword">for</span> the Issuance and Management</span><br><span class="line">of Publicly-Trusted Certificates, v.1.1.6, from the CA/Browser Forum (https://cabforum.org);</span><br><span class="line">specifically, section 10.2.3 (<span class="string">"Information Requirements"</span>).</span><br><span class="line">[admin@haifly-bj-dev-k8s-master1 cfssl]$ ll admin*</span><br><span class="line">-rw-r--r-- 1 admin admin 1009 May 27 14:56 admin.csr</span><br><span class="line">-rw-rw-r-- 1 admin admin  229 May 27 14:55 admin-csr.json</span><br><span class="line">-rw------- 1 admin admin 1675 May 27 14:56 admin-key.pem</span><br><span class="line">-rw-rw-r-- 1 admin admin 1399 May 27 14:56 admin.pem</span><br></pre></td></tr></tbody></table></figure><h3 id="4-分发证书-2"><a href="#4-分发证书-2" class="headerlink" title="4.分发证书"></a>4.分发证书</h3><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[admin@haifly-bj-dev-k8s-master1 cfssl]$ cp admin*.pem ~/kubernetes/ssl/</span><br><span class="line">[admin@haifly-bj-dev-k8s-master1 cfssl]$ scp admin*.pem admin@192.168.9.149:~/kubernetes/ssl/</span><br></pre></td></tr></tbody></table></figure><h3 id="5-配置kubectl的config"><a href="#5-配置kubectl的config" class="headerlink" title="5.配置kubectl的config"></a>5.配置kubectl的config</h3><p>因为rbac认证的原因，默认会内置一些角色，可以查看admin-crs.json中的<code>"O": "system:masters"</code></p><h3 id="5-1设置集群参数"><a href="#5-1设置集群参数" class="headerlink" title="5.1设置集群参数"></a>5.1设置集群参数</h3><p>先把kubectl命令添加到系统PATH路径下</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[admin@haifly-bj-dev-k8s-master1 cfssl]$ kubectl config <span class="built_in">set</span>-cluster kubernetes \</span><br><span class="line">    --certificate-authority=/work/admin/kubernetes/ssl/ca.pem \</span><br><span class="line">    --embed-certs=<span class="literal">true</span> \</span><br><span class="line">    --server=https://192.168.9.148:6443</span><br></pre></td></tr></tbody></table></figure><h3 id="5-2设置客户端认证参数"><a href="#5-2设置客户端认证参数" class="headerlink" title="5.2设置客户端认证参数"></a>5.2设置客户端认证参数</h3><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[admin@haifly-bj-dev-k8s-master1 cfssl]$ kubectl config <span class="built_in">set</span>-credentials admin \</span><br><span class="line">   --client-certificate=/work/admin/kubernetes/ssl/admin.pem \</span><br><span class="line">   --embed-certs=<span class="literal">true</span> \</span><br><span class="line">   --client-key=/work/admin/kubernetes/ssl/admin-key.pem</span><br></pre></td></tr></tbody></table></figure><h3 id="5-3设置上下文参数"><a href="#5-3设置上下文参数" class="headerlink" title="5.3设置上下文参数"></a>5.3设置上下文参数</h3><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[admin@haifly-bj-dev-k8s-master1 cfssl]$ kubectl config <span class="built_in">set</span>-context kubernetes \</span><br><span class="line">   --cluster=kubernetes \</span><br><span class="line">   --user=admin</span><br></pre></td></tr></tbody></table></figure><h3 id="5-4设置默认上下文"><a href="#5-4设置默认上下文" class="headerlink" title="5.4设置默认上下文"></a>5.4设置默认上下文</h3><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[admin@haifly-bj-dev-k8s-master1 cfssl]$ kubectl config use-context kubernetes</span><br></pre></td></tr></tbody></table></figure><p><strong>以上所有的操作的最终目的是为了生成 ~/.kube/config文件</strong>，如果node节点想使用kubectl的话，就需要将相应的<code>admin*.pem</code>拷贝到<code>/etc/kubernetes/ssl</code>目录，以及拷贝一份 <code>~/.kube/config</code>文件</p><h3 id="6-使用kubectl-查看当前资源情况"><a href="#6-使用kubectl-查看当前资源情况" class="headerlink" title="6.使用kubectl 查看当前资源情况"></a>6.使用kubectl 查看当前资源情况</h3><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[admin@haifly-bj-dev-k8s-master1 ~]$ kubectl get cs</span><br><span class="line">NAME                 STATUS    MESSAGE             ERROR</span><br><span class="line">scheduler            Healthy   ok                  </span><br><span class="line">controller-manager   Healthy   ok                  </span><br><span class="line">etcd-0               Healthy   {<span class="string">"health"</span>:<span class="string">"true"</span>}   </span><br><span class="line">etcd-1               Healthy   {<span class="string">"health"</span>:<span class="string">"true"</span>}   </span><br><span class="line">etcd-2               Healthy   {<span class="string">"health"</span>:<span class="string">"true"</span>}</span><br><span class="line"></span><br><span class="line">[admin@haifly-bj-dev-k8s-master2 ~]$ kubectl get cs</span><br><span class="line">NAME                 STATUS    MESSAGE             ERROR</span><br><span class="line">controller-manager   Healthy   ok                  </span><br><span class="line">scheduler            Healthy   ok                  </span><br><span class="line">etcd-1               Healthy   {<span class="string">"health"</span>:<span class="string">"true"</span>}   </span><br><span class="line">etcd-2               Healthy   {<span class="string">"health"</span>:<span class="string">"true"</span>}   </span><br><span class="line">etcd-0               Healthy   {<span class="string">"health"</span>:<span class="string">"true"</span>}</span><br></pre></td></tr></tbody></table></figure><h2 id="五、部署node节点"><a href="#五、部署node节点" class="headerlink" title="五、部署node节点"></a>五、部署node节点</h2><p>1.安装docker环境<br>1.1.安装一些必要的系统工具<br>1.2.添加docker镜像源<br>1.3.安装需要的版本<br>1.4.把当前用户加入docker用户组<br>1.5.修改配置文件<br>1.6.启动docker服务<br>1.7.查看docker确保没有info类信息<br>2.准备工作<br>2.1. 准备node节点的kubelet和kube-proxy二进制包<br>2.2.创建角色绑定<br>2.3.创建 用于kubelet的kubeconfig 文件<br>3.部署kubelet<br>3.1.创建kubelet工作目录<br>3.2.创建kubelet服务<br>3.3.启动kubelet服务<br>3.4.查看kubelet服务状态<br>3.5.在master节点查看csr请求<br>3.6.在master节点通过kubelet 的 TLS 证书请求<br>4.配置kube-proxy<br>4.1.安装kube-proxy使用LVS需要的包<br>4.2.创建 kube-proxy 证书请求的json<br>4.3.生成kube-proxy证书<br>4.4.分发证书<br>4.5.创建kube-proxy配置文件<br>4.6.创建kube-proxy的工作目录<br>4.7.创建kube-proxy服务配置<br>4.8.启动kube-proxy服务<br>4.9.查看kube-proxy服务状态<br>4.10.检查LVS状态</p><h3 id="1-安装docker环境"><a href="#1-安装docker环境" class="headerlink" title="1.安装docker环境"></a>1.安装docker环境</h3><h3 id="1-1-安装一些必要的系统工具"><a href="#1-1-安装一些必要的系统工具" class="headerlink" title="1.1.安装一些必要的系统工具"></a>1.1.安装一些必要的系统工具</h3><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[admin@haifly-bj-dev-k8s-node1 ~]$ sudo yum install -y yum-utils device-mapper-persistent-data lvm2</span><br></pre></td></tr></tbody></table></figure><h3 id="1-2-添加docker镜像源"><a href="#1-2-添加docker镜像源" class="headerlink" title="1.2.添加docker镜像源"></a>1.2.添加docker镜像源</h3><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[admin@haifly-bj-dev-k8s-node1 ~]$ sudo yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</span><br></pre></td></tr></tbody></table></figure><h3 id="1-3-安装需要的版本"><a href="#1-3-安装需要的版本" class="headerlink" title="1.3.安装需要的版本"></a>1.3.安装需要的版本</h3><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">[admin@haifly-bj-dev-k8s-node1 ~]$ yum list docker-ce  --showduplicates |sort -r</span><br><span class="line">Loaded plugins: fastestmirror</span><br><span class="line">Installed Packages</span><br><span class="line">docker-ce.x86_64            3:18.09.6-3.el7                    docker-ce-stable </span><br><span class="line">docker-ce.x86_64            3:18.09.5-3.el7                    docker-ce-stable </span><br><span class="line">docker-ce.x86_64            3:18.09.4-3.el7                    docker-ce-stable </span><br><span class="line">docker-ce.x86_64            3:18.09.3-3.el7                    docker-ce-stable </span><br><span class="line">docker-ce.x86_64            3:18.09.2-3.el7                    docker-ce-stable </span><br><span class="line">docker-ce.x86_64            3:18.09.1-3.el7                    docker-ce-stable </span><br><span class="line">docker-ce.x86_64            3:18.09.0-3.el7                    docker-ce-stable </span><br><span class="line">docker-ce.x86_64            18.06.3.ce-3.el7                   docker-ce-stable </span><br><span class="line">docker-ce.x86_64            18.06.2.ce-3.el7                   docker-ce-stable </span><br><span class="line">docker-ce.x86_64            18.06.1.ce-3.el7                   docker-ce-stable </span><br><span class="line">docker-ce.x86_64            18.06.0.ce-3.el7                   docker-ce-stable </span><br><span class="line">docker-ce.x86_64            18.03.1.ce-1.el7.centos            docker-ce-stable </span><br><span class="line">docker-ce.x86_64            18.03.1.ce-1.el7.centos            @docker-ce-stable</span><br><span class="line">docker-ce.x86_64            18.03.0.ce-1.el7.centos            docker-ce-stable </span><br><span class="line">docker-ce.x86_64            17.12.1.ce-1.el7.centos            docker-ce-stable </span><br><span class="line">docker-ce.x86_64            17.12.0.ce-1.el7.centos            docker-ce-stable </span><br><span class="line">docker-ce.x86_64            17.09.1.ce-1.el7.centos            docker-ce-stable </span><br><span class="line">docker-ce.x86_64            17.09.0.ce-1.el7.centos            docker-ce-stable </span><br><span class="line">docker-ce.x86_64            17.06.2.ce-1.el7.centos            docker-ce-stable </span><br><span class="line">docker-ce.x86_64            17.06.1.ce-1.el7.centos            docker-ce-stable </span><br><span class="line">docker-ce.x86_64            17.06.0.ce-1.el7.centos            docker-ce-stable </span><br><span class="line">docker-ce.x86_64            17.03.3.ce-1.el7                   docker-ce-stable </span><br><span class="line">docker-ce.x86_64            17.03.2.ce-1.el7.centos            docker-ce-stable </span><br><span class="line">docker-ce.x86_64            17.03.1.ce-1.el7.centos            docker-ce-stable </span><br><span class="line">docker-ce.x86_64            17.03.0.ce-1.el7.centos            docker-ce-stable </span><br><span class="line">Determining fastest mirrors</span><br><span class="line">Available Packages</span><br><span class="line"></span><br><span class="line">[admin@haifly-bj-dev-k8s-node1 ~]$ sudo yum -y install docker-ce-18.03.1.ce-1.el7.centos</span><br></pre></td></tr></tbody></table></figure><h3 id="1-4-把当前用户加入docker用户组"><a href="#1-4-把当前用户加入docker用户组" class="headerlink" title="1.4.把当前用户加入docker用户组"></a>1.4.把当前用户加入docker用户组</h3><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[admin@haifly-bj-dev-k8s-node1 ~]$ sudo groupadd docker</span><br><span class="line">[admin@haifly-bj-dev-k8s-node1 ~]$ sudo usermod -aG docker <span class="variable">$USER</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#退出终端，重新登录生效</span></span><br></pre></td></tr></tbody></table></figure><h3 id="1-5-修改配置文件"><a href="#1-5-修改配置文件" class="headerlink" title="1.5.修改配置文件"></a>1.5.修改配置文件</h3><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[admin@haifly-bj-dev-k8s-node1 ~]$ sudo mkdir /etc/docker</span><br><span class="line">[admin@haifly-bj-dev-k8s-node1 ~]$ sudo vim /etc/docker/daemon.json</span><br><span class="line">{</span><br><span class="line">  <span class="string">"storage-driver"</span>: <span class="string">"overlay2"</span>,</span><br><span class="line">  <span class="string">"storage-opts"</span>: [ <span class="string">"overlay2.override_kernel_check=true"</span> ],</span><br><span class="line">  <span class="string">"graph"</span>:<span class="string">"/work/admin/docker"</span>,</span><br><span class="line">  <span class="string">"insecure-registries"</span>:[<span class="string">"harbor.feiersmart.com"</span>],</span><br><span class="line">  <span class="string">"log-driver"</span>:<span class="string">"json-file"</span>,</span><br><span class="line">  <span class="string">"log-opts"</span>: {<span class="string">"max-size"</span>:<span class="string">"100m"</span>,<span class="string">"max-file"</span>:<span class="string">"3"</span>}</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">#这里修改了docker存储驱动为overlay2，docker数据存储目录，私有镜像仓库地址，日志为json格式方便后期对pod stdout日志进行采集，pod回滚日志大小为100m并保留3个历史日志</span></span><br></pre></td></tr></tbody></table></figure><h3 id="1-6-启动docker服务"><a href="#1-6-启动docker服务" class="headerlink" title="1.6.启动docker服务"></a>1.6.启动docker服务</h3><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[admin@haifly-bj-dev-k8s-node1 ~]$ sudo systemctl daemon-reload</span><br><span class="line">[admin@haifly-bj-dev-k8s-node1 ~]$ sudo systemctl <span class="built_in">enable</span> docker</span><br><span class="line">[admin@haifly-bj-dev-k8s-node1 ~]$ sudo systemctl start docker</span><br></pre></td></tr></tbody></table></figure><h3 id="1-7-查看docker确保没有info类信息"><a href="#1-7-查看docker确保没有info类信息" class="headerlink" title="1.7.查看docker确保没有info类信息"></a>1.7.查看docker确保没有info类信息</h3><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">[admin@haifly-bj-dev-k8s-node1 ~]$ docker info</span><br><span class="line">Containers: 0</span><br><span class="line"> Running: 0</span><br><span class="line"> Paused: 0</span><br><span class="line"> Stopped: 0</span><br><span class="line">Images: 0</span><br><span class="line">Server Version: 18.03.1-ce</span><br><span class="line">Storage Driver: overlay2</span><br><span class="line"> Backing Filesystem: xfs</span><br><span class="line"> Supports d_type: <span class="literal">true</span></span><br><span class="line"> Native Overlay Diff: <span class="literal">true</span></span><br><span class="line">Logging Driver: json-file</span><br><span class="line">Cgroup Driver: cgroupfs</span><br><span class="line">Plugins:</span><br><span class="line"> Volume: <span class="built_in">local</span></span><br><span class="line"> Network: bridge host macvlan null overlay</span><br><span class="line"> Log: awslogs fluentd gcplogs gelf journald json-file logentries splunk syslog</span><br><span class="line">Swarm: inactive</span><br><span class="line">Runtimes: runc</span><br><span class="line">Default Runtime: runc</span><br><span class="line">Init Binary: docker-init</span><br><span class="line">containerd version: 773c489c9c1b21a6d78b5c538cd395416ec50f88</span><br><span class="line">runc version: 4fc53a81fb7c994640722ac585fa9ca548971871</span><br><span class="line">init version: 949e6fa</span><br><span class="line">Security Options:</span><br><span class="line"> seccomp</span><br><span class="line">  Profile: default</span><br><span class="line">Kernel Version: 3.10.0-693.2.2.el7.x86_64</span><br><span class="line">Operating System: CentOS Linux 7 (Core)</span><br><span class="line">OSType: linux</span><br><span class="line">Architecture: x86_64</span><br><span class="line">CPUs: 2</span><br><span class="line">Total Memory: 7.639GiB</span><br><span class="line">Name: haifly-bj-dev-k8s-node1</span><br><span class="line">ID: 7PQT:SMIR:M4GQ:DEV7:CPYX:KXKC:VARL:FJKO:RVRT:NPYZ:SDMC:GLBJ</span><br><span class="line">Docker Root Dir: /work/admin/docker</span><br><span class="line">Debug Mode (client): <span class="literal">false</span></span><br><span class="line">Debug Mode (server): <span class="literal">false</span></span><br><span class="line">Registry: https://index.docker.io/v1/</span><br><span class="line">Labels:</span><br><span class="line">Experimental: <span class="literal">false</span></span><br><span class="line">Insecure Registries:</span><br><span class="line"> harbor.feiersmart.local</span><br><span class="line"> 127.0.0.0/8</span><br><span class="line">Live Restore Enabled: <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">WARNING: bridge-nf-call-iptables is disabled</span><br><span class="line">WARNING: bridge-nf-call-ip6tables is disabled</span><br></pre></td></tr></tbody></table></figure><p>WARNING类的告警需要解决掉</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[admin@haifly-bj-dev-k8s-node1 ~]$ sudo vim /etc/sysctl.conf</span><br><span class="line"></span><br><span class="line">net.bridge.bridge-nf-call-ip6tables = 1</span><br><span class="line">net.bridge.bridge-nf-call-iptables = 1</span><br><span class="line"></span><br><span class="line">[admin@haifly-bj-dev-k8s-node1 ~]$ sudo sysctl -p</span><br></pre></td></tr></tbody></table></figure><h3 id="2-准备工作"><a href="#2-准备工作" class="headerlink" title="2.准备工作"></a>2.准备工作</h3><h3 id="2-1准备node节点的kubelet和kube-proxy二进制包"><a href="#2-1准备node节点的kubelet和kube-proxy二进制包" class="headerlink" title="2.1准备node节点的kubelet和kube-proxy二进制包"></a>2.1准备node节点的kubelet和kube-proxy二进制包</h3><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[admin@haifly-bj-dev-k8s-node1 ~]$ ll kubernetes/bin/</span><br><span class="line">total 160812</span><br><span class="line">-rwxr-xr-x 1 admin admin 127981504 May 27 15:54 kubelet</span><br><span class="line">-rwxr-xr-x 1 admin admin  36685440 May 27 15:54 kube-proxy</span><br></pre></td></tr></tbody></table></figure><h3 id="2-2创建角色绑定"><a href="#2-2创建角色绑定" class="headerlink" title="2.2创建角色绑定"></a>2.2创建角色绑定</h3><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[admin@haifly-bj-dev-k8s-master1 ~]$ kubectl create clusterrolebinding kubelet-bootstrap --clusterrole=system:node-bootstrapper --user=kubelet-bootstrap</span><br></pre></td></tr></tbody></table></figure><h3 id="2-3创建用于kubelet的kubeconfig文件"><a href="#2-3创建用于kubelet的kubeconfig文件" class="headerlink" title="2.3创建用于kubelet的kubeconfig文件"></a>2.3创建用于kubelet的kubeconfig文件</h3><h5 id="2-3-1设置集群参数"><a href="#2-3-1设置集群参数" class="headerlink" title="2.3.1设置集群参数"></a>2.3.1设置集群参数</h5><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[admin@haifly-bj-dev-k8s-master1 ~]$ kubectl config <span class="built_in">set</span>-cluster kubernetes \</span><br><span class="line">   --certificate-authority=/work/admin/kubernetes/ssl/ca.pem \</span><br><span class="line">   --embed-certs=<span class="literal">true</span> \</span><br><span class="line">   --server=https://192.168.9.148:6443 \</span><br><span class="line">   --kubeconfig=bootstrap.kubeconfig</span><br></pre></td></tr></tbody></table></figure><h5 id="2-3-2设置客户端认证参数"><a href="#2-3-2设置客户端认证参数" class="headerlink" title="2.3.2设置客户端认证参数"></a>2.3.2设置客户端认证参数</h5><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[admin@haifly-bj-dev-k8s-master1 ~]$ kubectl config <span class="built_in">set</span>-credentials kubelet-bootstrap \</span><br><span class="line">  --token=c25603db53aff8d0111b4e45c281ab32 \</span><br><span class="line">  --kubeconfig=bootstrap.kubeconfig</span><br></pre></td></tr></tbody></table></figure><p>该token串是之前配置kube-apiserver使用的客户端token文件</p><h5 id="2-3-3设置上下文参数"><a href="#2-3-3设置上下文参数" class="headerlink" title="2.3.3设置上下文参数"></a>2.3.3设置上下文参数</h5><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[admin@haifly-bj-dev-k8s-master1 ~]$ kubectl config <span class="built_in">set</span>-context default \</span><br><span class="line">   --cluster=kubernetes \</span><br><span class="line">   --user=kubelet-bootstrap \</span><br><span class="line">   --kubeconfig=bootstrap.kubeconfig</span><br></pre></td></tr></tbody></table></figure><h5 id="2-3-4选择默认上下文"><a href="#2-3-4选择默认上下文" class="headerlink" title="2.3.4选择默认上下文"></a>2.3.4选择默认上下文</h5><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[admin@haifly-bj-dev-k8s-master1 ~]$ kubectl config use-context default --kubeconfig=bootstrap.kubeconfig</span><br></pre></td></tr></tbody></table></figure><h5 id="2-3-5将当前目录生成的-bootstrap-kubeconfig-分发到node节点上"><a href="#2-3-5将当前目录生成的-bootstrap-kubeconfig-分发到node节点上" class="headerlink" title="2.3.5将当前目录生成的 bootstrap.kubeconfig 分发到node节点上"></a>2.3.5将当前目录生成的 <code>bootstrap.kubeconfig</code> 分发到node节点上</h5><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[admin@haifly-bj-dev-k8s-master1 ~]$ scp bootstrap.kubeconfig admin@192.168.10.177:~/kubernetes/ssl/</span><br></pre></td></tr></tbody></table></figure><h3 id="3-部署kubelet"><a href="#3-部署kubelet" class="headerlink" title="3.部署kubelet"></a>3.部署kubelet</h3><h3 id="3-1创建kubelet工作目录"><a href="#3-1创建kubelet工作目录" class="headerlink" title="3.1创建kubelet工作目录"></a>3.1创建kubelet工作目录</h3><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[admin@haifly-bj-dev-k8s-node1 ~]$ mkdir ~/kubernetes/kubelet/</span><br></pre></td></tr></tbody></table></figure><h3 id="3-2创建kubelet服务"><a href="#3-2创建kubelet服务" class="headerlink" title="3.2创建kubelet服务"></a>3.2创建kubelet服务</h3><p>这里做了一些优化，node主机资源预留，在node资源不足时能够自动驱逐pod到其它节点</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">[admin@haifly-bj-dev-k8s-node1 ~]$ cat /usr/lib/systemd/system/kubelet.service</span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes Kubelet</span><br><span class="line">Documentation=https://github.com/GoogleCloudPlatform/kubernetes</span><br><span class="line">After=docker.service</span><br><span class="line">Requires=docker.service</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">WorkingDirectory=/work/admin/kubernetes/kubelet</span><br><span class="line">ExecStart=/work/admin/kubernetes/bin/kubelet \</span><br><span class="line">  --address=192.168.10.177 \</span><br><span class="line">  --hostname-override=192.168.10.177 \</span><br><span class="line">  --pod-infra-container-image=harbor.feiersmart.local/public/pause-amd64:3.1 \</span><br><span class="line">  --register-node=<span class="literal">true</span> \</span><br><span class="line">  --experimental-bootstrap-kubeconfig=/work/admin/kubernetes/ssl/bootstrap.kubeconfig \</span><br><span class="line">  --kubeconfig=/work/admin/kubernetes/kubelet.kubeconfig \</span><br><span class="line">  --cert-dir=/work/admin/kubernetes/kubelet/ \</span><br><span class="line">  --cluster-dns=10.1.100.100 \</span><br><span class="line">  --cluster-domain=cluster.local. \</span><br><span class="line">  --hairpin-mode promiscuous-bridge</span><br><span class="line">  --max-pods=110 \</span><br><span class="line">  --network-plugin=cni \</span><br><span class="line">  --allow-privileged=<span class="literal">true</span> \</span><br><span class="line">  --serialize-image-pulls=<span class="literal">false</span> \</span><br><span class="line">  --logtostderr=<span class="literal">true</span> \</span><br><span class="line">  --cgroups-per-qos=<span class="literal">true</span> \</span><br><span class="line">  --cgroup-driver=cgroupfs \</span><br><span class="line">  --system-reserved-cgroup=/system.slice \</span><br><span class="line">  --enforce-node-allocatable=pods,kube-reserved,system-reserved \</span><br><span class="line">  --kube-reserved-cgroup=/system.slice/kubelet.service \</span><br><span class="line">  --kube-reserved=cpu=200m,memory=250Mi,ephemeral-storage=1Gi \</span><br><span class="line">  --system-reserved-cgroup=/system.slice</span><br><span class="line">  --system-reserved=cpu=200m,memory=250Mi,ephemeral-storage=1Gi \</span><br><span class="line">  --kube-reserved-cgroup=/system.slice/kubelet.service \</span><br><span class="line">  --eviction-hard=memory.available&lt;5%,nodefs.available&lt;10%,imagefs.available&lt;10% \</span><br><span class="line">  --eviction-soft=memory.available&lt;10%,nodefs.available&lt;15%,imagefs.available&lt;15% \</span><br><span class="line">  --eviction-soft-grace-period=memory.available=2m,nodefs.available=2m,imagefs.available=2m \</span><br><span class="line">  --eviction-minimum-reclaim=memory.available=0Mi,nodefs.available=500Mi,imagefs.available=500Mi \</span><br><span class="line">  --eviction-max-pod-grace-period=110 \</span><br><span class="line">  --v=2 \</span><br><span class="line">  --container-runtime=docker</span><br><span class="line">ExecStartPost=/sbin/iptables -A INPUT -s 10.1.0.0/16 -p tcp --dport 4194 -j ACCEPT</span><br><span class="line">ExecStartPost=/sbin/iptables -A INPUT -s 10.2.0.0/16 -p tcp --dport 4194 -j ACCEPT</span><br><span class="line">ExecStartPost=/sbin/iptables -A INPUT -s 172.16.0.0/12 -p tcp --dport 4194 -j ACCEPT</span><br><span class="line">ExecStartPost=/sbin/iptables -A INPUT -s 192.168.0.0/16 -p tcp --dport 4194 -j ACCEPT</span><br><span class="line">ExecStartPost=/sbin/iptables -A INPUT -p tcp --dport 4194 -j DROP</span><br><span class="line">Restart=on-failure</span><br><span class="line">RestartSec=5</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></tbody></table></figure><ul><li>–hostname-override 在集群中显示的主机名</li><li>–kubeconfig 指定kubeconfig文件位置，会自动生成</li><li>–bootstrap-kubeconfig 指定刚才生成的bootstrap.kubeconfig文件</li><li>–cert-dir 颁发证书存放位置</li><li>–pod-infra-container-image 管理Pod网络的镜像</li></ul><h3 id="3-3启动kubelet服务"><a href="#3-3启动kubelet服务" class="headerlink" title="3.3启动kubelet服务"></a>3.3启动kubelet服务</h3><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[admin@haifly-bj-dev-k8s-node1 ~]$ sudo systemctl daemon-reload</span><br><span class="line">[admin@haifly-bj-dev-k8s-node1 ~]$ sudo systemctl <span class="built_in">enable</span> kubelet</span><br><span class="line">[admin@haifly-bj-dev-k8s-node1 ~]$ sudo systemctl start kubelet</span><br></pre></td></tr></tbody></table></figure><h3 id="3-4查看kubelet服务状态"><a href="#3-4查看kubelet服务状态" class="headerlink" title="3.4查看kubelet服务状态"></a>3.4查看kubelet服务状态</h3><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[admin@haifly-bj-dev-k8s-node1 ~]$ systemctl status kubelet</span><br><span class="line">● kubelet.service - Kubernetes Kubelet</span><br><span class="line">   Loaded: loaded (/usr/lib/systemd/system/kubelet.service; disabled; vendor preset: disabled)</span><br><span class="line">   Active: active (running) since Mon 2019-05-27 17:34:58 CST; 6s ago</span><br><span class="line">     Docs: https://github.com/GoogleCloudPlatform/kubernetes</span><br><span class="line">  Process: 9237 ExecStartPost=/sbin/iptables -A INPUT -p tcp --dport 4194 -j DROP (code=exited, status=0/SUCCESS)</span><br><span class="line">  Process: 9233 ExecStartPost=/sbin/iptables -A INPUT -s 192.168.0.0/16 -p tcp --dport 4194 -j ACCEPT (code=exited, status=0/SUCCESS)</span><br><span class="line">  Process: 9230 ExecStartPost=/sbin/iptables -A INPUT -s 172.16.0.0/12 -p tcp --dport 4194 -j ACCEPT (code=exited, status=0/SUCCESS)</span><br><span class="line">  Process: 9229 ExecStartPost=/sbin/iptables -A INPUT -s 10.2.0.0/16 -p tcp --dport 4194 -j ACCEPT (code=exited, status=0/SUCCESS)</span><br><span class="line">  Process: 9223 ExecStartPost=/sbin/iptables -A INPUT -s 10.1.0.0/16 -p tcp --dport 4194 -j ACCEPT (code=exited, status=0/SUCCESS)</span><br><span class="line"> Main PID: 9222 (kubelet)</span><br><span class="line">   Memory: 13.5M</span><br><span class="line">   CGroup: /system.slice/kubelet.service</span><br><span class="line">           └─9222 /work/admin/kubernetes/bin/kubelet --address=192.168.10.177 --hostname-override=node1 --pod-...</span><br></pre></td></tr></tbody></table></figure><h3 id="3-5在master节点查看csr请求"><a href="#3-5在master节点查看csr请求" class="headerlink" title="3.5在master节点查看csr请求"></a>3.5在master节点查看csr请求</h3><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[admin@haifly-bj-dev-k8s-master1 ~]$ kubectl get csr</span><br><span class="line">NAME                                                   AGE   REQUESTOR           CONDITION</span><br><span class="line">node-csr-QV2WFl5YQzZoV6P__d7rPPi5_PTh2Sx8I1pxEJm-nVE   14s   kubelet-bootstrap   Pending</span><br><span class="line">[admin@haifly-bj-dev-k8s-master1 ~]$</span><br></pre></td></tr></tbody></table></figure><h3 id="3-6在master节点通过kubelet的TLS证书请求"><a href="#3-6在master节点通过kubelet的TLS证书请求" class="headerlink" title="3.6在master节点通过kubelet的TLS证书请求"></a>3.6在master节点通过kubelet的TLS证书请求</h3><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[admin@haifly-bj-dev-k8s-master1 ~]$ kubectl get csr|grep <span class="string">'Pending'</span> | awk <span class="string">'NR&gt;0{print $1}'</span>| xargs kubectl certificate approve</span><br><span class="line">certificatesigningrequest.certificates.k8s.io/node-csr-QV2WFl5YQzZoV6P__d7rPPi5_PTh2Sx8I1pxEJm-nVE approved</span><br><span class="line"></span><br><span class="line">再次查询状态已经approved了</span><br><span class="line">[admin@haifly-bj-dev-k8s-master1 ~]$ kubectl get csr</span><br><span class="line">NAME                                                   AGE     REQUESTOR           CONDITION</span><br><span class="line">node-csr-QV2WFl5YQzZoV6P__d7rPPi5_PTh2Sx8I1pxEJm-nVE   5m27s   kubelet-bootstrap   Approved,Issued</span><br><span class="line"></span><br><span class="line">查询node</span><br><span class="line">[admin@haifly-bj-dev-k8s-master1 ~]$ kubectl get nodes</span><br><span class="line">NAME    STATUS  ROLES    AGE   VERSION</span><br><span class="line">node1   Ready   &lt;none&gt;   66s   v1.14.2</span><br></pre></td></tr></tbody></table></figure><h3 id="4-配置kube-proxy"><a href="#4-配置kube-proxy" class="headerlink" title="4.配置kube-proxy"></a>4.配置kube-proxy</h3><h3 id="4-1安装kube-proxy使用LVS需要的包"><a href="#4-1安装kube-proxy使用LVS需要的包" class="headerlink" title="4.1安装kube-proxy使用LVS需要的包"></a>4.1安装kube-proxy使用LVS需要的包</h3><p>注意：如果不使用lvs的话，就会使用iptables，这个是1.10版本的新特性</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[admin@haifly-bj-dev-k8s-master1 ~]$ sudo yum install -y ipvsadm ipset conntrack</span><br></pre></td></tr></tbody></table></figure><h3 id="4-2创建kube-proxy证书请求的json"><a href="#4-2创建kube-proxy证书请求的json" class="headerlink" title="4.2创建kube-proxy证书请求的json"></a>4.2创建kube-proxy证书请求的json</h3><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[admin@haifly-bj-dev-k8s-master1 cfssl]$ cat &lt;&lt;EOF&gt;&gt; kube-proxy-csr.json</span><br><span class="line">{</span><br><span class="line">  <span class="string">"CN"</span>: <span class="string">"system:kube-proxy"</span>,</span><br><span class="line">  <span class="string">"hosts"</span>: [],</span><br><span class="line">  <span class="string">"key"</span>: {</span><br><span class="line">    <span class="string">"algo"</span>: <span class="string">"rsa"</span>,</span><br><span class="line">    <span class="string">"size"</span>: 2048</span><br><span class="line">  },</span><br><span class="line">  <span class="string">"names"</span>: [</span><br><span class="line">    {</span><br><span class="line">      <span class="string">"C"</span>: <span class="string">"CN"</span>,</span><br><span class="line">      <span class="string">"ST"</span>: <span class="string">"BeiJing"</span>,</span><br><span class="line">      <span class="string">"L"</span>: <span class="string">"BeiJing"</span>,</span><br><span class="line">      <span class="string">"O"</span>: <span class="string">"k8s"</span>,</span><br><span class="line">      <span class="string">"OU"</span>: <span class="string">"System"</span></span><br><span class="line">    }</span><br><span class="line">  ]</span><br><span class="line">}</span><br><span class="line">EOF</span><br></pre></td></tr></tbody></table></figure><h3 id="4-3生成kube-proxy证书"><a href="#4-3生成kube-proxy证书" class="headerlink" title="4.3生成kube-proxy证书"></a>4.3生成kube-proxy证书</h3><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[admin@haifly-bj-dev-k8s-master1 cfssl]$ cfssl gencert -ca=/work/admin/kubernetes/cfssl/ca.pem \</span><br><span class="line">    -ca-key=/work/admin/kubernetes/cfssl/ca-key.pem \</span><br><span class="line">    -config=/work/admin/kubernetes/cfssl/ca-config.json \</span><br><span class="line">    -profile=kubernetes  kube-proxy-csr.json | cfssljson -bare kube-proxy</span><br><span class="line">2019/05/27 17:47:19 [INFO] generate received request</span><br><span class="line">2019/05/27 17:47:19 [INFO] received CSR</span><br><span class="line">2019/05/27 17:47:19 [INFO] generating key: rsa-2048</span><br><span class="line">2019/05/27 17:47:20 [INFO] encoded CSR</span><br><span class="line">2019/05/27 17:47:20 [INFO] signed certificate with serial number 275412850767955755157758754957830816223105416047</span><br><span class="line">2019/05/27 17:47:20 [WARNING] This certificate lacks a <span class="string">"hosts"</span> field. This makes it unsuitable <span class="keyword">for</span></span><br><span class="line">websites. For more information see the Baseline Requirements <span class="keyword">for</span> the Issuance and Management</span><br><span class="line">of Publicly-Trusted Certificates, v.1.1.6, from the CA/Browser Forum (https://cabforum.org);</span><br><span class="line">specifically, section 10.2.3 (<span class="string">"Information Requirements"</span>).</span><br><span class="line">[admin@haifly-bj-dev-k8s-master1 cfssl]$ ll kube-proxy*</span><br><span class="line">-rw-r--r-- 1 admin admin 1009 May 27 17:47 kube-proxy.csr</span><br><span class="line">-rw-rw-r-- 1 admin admin  230 May 27 17:45 kube-proxy-csr.json</span><br><span class="line">-rw------- 1 admin admin 1679 May 27 17:47 kube-proxy-key.pem</span><br><span class="line">-rw-rw-r-- 1 admin admin 1403 May 27 17:47 kube-proxy.pem</span><br></pre></td></tr></tbody></table></figure><h3 id="4-4分发证书"><a href="#4-4分发证书" class="headerlink" title="4.4分发证书"></a>4.4分发证书</h3><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[admin@haifly-bj-dev-k8s-master1 cfssl]$ scp kube-proxy*.pem admin@192.168.10.177:~/kubernetes/ssl/</span><br></pre></td></tr></tbody></table></figure><h3 id="4-5创建kube-proxy配置文件"><a href="#4-5创建kube-proxy配置文件" class="headerlink" title="4.5创建kube-proxy配置文件"></a>4.5创建kube-proxy配置文件</h3><h5 id="4-5-1创建集群信息"><a href="#4-5-1创建集群信息" class="headerlink" title="4.5.1创建集群信息"></a>4.5.1创建集群信息</h5><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[admin@haifly-bj-dev-k8s-master1 cfssl]$ kubectl config <span class="built_in">set</span>-cluster kubernetes \</span><br><span class="line">   --certificate-authority=/work/admin/kubernetes/cfssl/ca.pem \</span><br><span class="line">   --embed-certs=<span class="literal">true</span> \</span><br><span class="line">   --server=https://192.168.9.148:6443 \</span><br><span class="line">   --kubeconfig=kube-proxy.kubeconfig</span><br></pre></td></tr></tbody></table></figure><h5 id="4-5-2配置认证信息"><a href="#4-5-2配置认证信息" class="headerlink" title="4.5.2配置认证信息"></a>4.5.2配置认证信息</h5><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[admin@haifly-bj-dev-k8s-master1 cfssl]$ kubectl config <span class="built_in">set</span>-credentials kube-proxy \</span><br><span class="line"> --client-certificate=/work/admin/kubernetes/cfssl/kube-proxy.pem \</span><br><span class="line"> --client-key=/work/admin/kubernetes/cfssl/kube-proxy-key.pem \</span><br><span class="line"> --embed-certs=<span class="literal">true</span> \</span><br><span class="line"> --kubeconfig=kube-proxy.kubeconfig</span><br></pre></td></tr></tbody></table></figure><h5 id="4-5-3设置上下文环境"><a href="#4-5-3设置上下文环境" class="headerlink" title="4.5.3设置上下文环境"></a>4.5.3设置上下文环境</h5><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[admin@haifly-bj-dev-k8s-master1 cfssl]$ kubectl config <span class="built_in">set</span>-context default \</span><br><span class="line">   --cluster=kubernetes \</span><br><span class="line">   --user=kube-proxy \</span><br><span class="line">   --kubeconfig=kube-proxy.kubeconfig</span><br></pre></td></tr></tbody></table></figure><h5 id="4-5-4配置默认的上下文"><a href="#4-5-4配置默认的上下文" class="headerlink" title="4.5.4配置默认的上下文"></a>4.5.4配置默认的上下文</h5><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[admin@haifly-bj-dev-k8s-master1 cfssl]$ kubectl config use-context default --kubeconfig=kube-proxy.kubeconfig</span><br></pre></td></tr></tbody></table></figure><h5 id="4-5-5分发kube-proxy-kubeconfig到node节点"><a href="#4-5-5分发kube-proxy-kubeconfig到node节点" class="headerlink" title="4.5.5分发kube-proxy.kubeconfig到node节点"></a>4.5.5分发kube-proxy.kubeconfig到node节点</h5><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[admin@haifly-bj-dev-k8s-master1 cfssl]$ scp kube-proxy.kubeconfig admin@192.168.10.177:~/kubernetes/ssl/</span><br></pre></td></tr></tbody></table></figure><h3 id="4-6创建kube-proxy工作目录"><a href="#4-6创建kube-proxy工作目录" class="headerlink" title="4.6创建kube-proxy工作目录"></a>4.6创建kube-proxy工作目录</h3><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[admin@haifly-bj-dev-k8s-node1 ~]$ mkdir ~/kubernetes/kube-proxy</span><br></pre></td></tr></tbody></table></figure><h3 id="4-7创建kube-proxy服务配置"><a href="#4-7创建kube-proxy服务配置" class="headerlink" title="4.7创建kube-proxy服务配置"></a>4.7创建kube-proxy服务配置</h3><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">[admin@haifly-bj-dev-k8s-node1 ~]$ cat /usr/lib/systemd/system/kube-proxy.service</span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes Kube-Proxy Server</span><br><span class="line">Documentation=https://github.com/kubernetes/kubernetes</span><br><span class="line">After=network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">WorkingDirectory=/work/admin/kubernetes/kube-proxy</span><br><span class="line">ExecStart=/work/admin/kubernetes/bin/kube-proxy \</span><br><span class="line">  --<span class="built_in">bind</span>-address=192.168.10.177 \</span><br><span class="line">  --hostname-override=192.168.10.177 \</span><br><span class="line">  --cluster-cidr=10.1.0.0/16 \</span><br><span class="line">  --kubeconfig=/work/admin/kubernetes/ssl/kube-proxy.kubeconfig \</span><br><span class="line">  --masquerade-all \</span><br><span class="line">  --feature-gates=SupportIPVSProxyMode=<span class="literal">true</span> \</span><br><span class="line">  --proxy-mode=ipvs \</span><br><span class="line">  --ipvs-min-sync-period=5s \</span><br><span class="line">  --ipvs-sync-period=5s \</span><br><span class="line">  --ipvs-scheduler=rr \</span><br><span class="line">  --logtostderr=<span class="literal">true</span> \</span><br><span class="line">  --v=2 \</span><br><span class="line">  --logtostderr=<span class="literal">false</span> \</span><br><span class="line">  --<span class="built_in">log</span>-dir=/work/admin/kubernetes/<span class="built_in">log</span></span><br><span class="line"></span><br><span class="line">Restart=on-failure</span><br><span class="line">RestartSec=5</span><br><span class="line">LimitNOFILE=65536</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></tbody></table></figure><ul><li><code>--hostname-override</code> 参数值<strong>必须</strong>与 kubelet 的值一致，否则 kube-proxy 启动后会找不到该 Node，从而不会创建任何 iptables 规则</li><li><code>--cluster-cidr</code> <strong>必须</strong>与 kube-controller-manager 的 <code>--cluster-cidr</code> 选项值一致，10.1.0.0/16</li><li>kube-proxy 根据 <code>--cluster-cidr</code> 判断集群内部和外部流量，指定 <code>--cluster-cidr</code> 或 <code>--masquerade-all</code> 选项后 kube-proxy 才会对访问 Service IP 的请求做 SNAT</li><li><code>--kubeconfig</code> 指定的配置文件嵌入了 kube-apiserver 的地址、用户名、证书、秘钥等请求和认证信息</li><li>预定义的 RoleBinding <code>cluster-admin</code> 将User <code>system:kube-proxy</code> 与 Role <code>system:node-proxier</code> 绑定，该 Role 授予了调用 <code>kube-apiserver</code> Proxy 相关 API 的权限</li></ul><h3 id="4-8启动kube-proxy服务"><a href="#4-8启动kube-proxy服务" class="headerlink" title="4.8启动kube-proxy服务"></a>4.8启动kube-proxy服务</h3><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[admin@haifly-bj-dev-k8s-node1 ~]$ sudo systemctl daemon-reload</span><br><span class="line">[admin@haifly-bj-dev-k8s-node1 ~]$ sudo systemctl <span class="built_in">enable</span> kube-proxy</span><br><span class="line">Created symlink from /etc/systemd/system/multi-user.target.wants/kube-proxy.service to /usr/lib/systemd/system/kube-proxy.service.</span><br><span class="line">[admin@haifly-bj-dev-k8s-node1 ~]$ sudo systemctl start kube-proxy</span><br></pre></td></tr></tbody></table></figure><h3 id="4-9查看kube-proxy服务状态"><a href="#4-9查看kube-proxy服务状态" class="headerlink" title="4.9查看kube-proxy服务状态"></a>4.9查看kube-proxy服务状态</h3><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[admin@haifly-bj-dev-k8s-node1 ~]$ systemctl status kube-proxy</span><br><span class="line">● kube-proxy.service - Kubernetes Kube-Proxy Server</span><br><span class="line">   Loaded: loaded (/usr/lib/systemd/system/kube-proxy.service; enabled; vendor preset: disabled)</span><br><span class="line">   Active: active (running) since Mon 2019-05-27 18:07:23 CST; 4min 31s ago</span><br><span class="line">     Docs: https://github.com/kubernetes/kubernetes</span><br><span class="line"> Main PID: 10323 (kube-proxy)</span><br><span class="line">   CGroup: /system.slice/kube-proxy.service</span><br><span class="line">           ‣ 10323 /work/admin/kubernetes/bin/kube-proxy --<span class="built_in">bind</span>-address=0.0.0.0 --hostname-override=node1 --cl...</span><br></pre></td></tr></tbody></table></figure><h2 id="六、部署kubernetes网络（calico）k8s容器方式"><a href="#六、部署kubernetes网络（calico）k8s容器方式" class="headerlink" title="六、部署kubernetes网络（calico）k8s容器方式"></a>六、部署kubernetes网络（calico）k8s容器方式</h2><h3 id="1-准备工作"><a href="#1-准备工作" class="headerlink" title="1.准备工作"></a>1.准备工作</h3><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">1.1.下载calicoctl工具</span><br><span class="line">1.2.下载安装文件</span><br><span class="line">1.3.拉取calico所需镜像</span><br><span class="line">1.4.修改calico.yaml文件</span><br></pre></td></tr></tbody></table></figure><p>2.部署calico<br>2.1.创建calico容器<br>2.2.查看容器运行状态<br>2.3.查看calico网络状态<br>2.4.修改kubelet配置，支持cni网络插件</p><h3 id="1-准备工作-1"><a href="#1-准备工作-1" class="headerlink" title="1.准备工作"></a>1.准备工作</h3><h3 id="1-1下载calicoctl工具"><a href="#1-1下载calicoctl工具" class="headerlink" title="1.1下载calicoctl工具"></a>1.1下载calicoctl工具</h3><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[admin@haifly-bj-dev-k8s-node1 ~]$ <span class="built_in">cd</span> ~/kubernetes/bin/</span><br><span class="line">[admin@haifly-bj-dev-k8s-node1 bin]$ curl -O -L https://github.com/projectcalico/calicoctl/releases/download/v3.7.2/calicoctl</span><br><span class="line">[admin@haifly-bj-dev-k8s-node1 bin]$ chmod +x calicoctl</span><br></pre></td></tr></tbody></table></figure><h3 id="1-2下载安装文件"><a href="#1-2下载安装文件" class="headerlink" title="1.2下载安装文件"></a>1.2下载安装文件</h3><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[admin@haifly-bj-dev-k8s-master1 bin]$ mkdir ~/kubernetes/calico</span><br><span class="line">[admin@haifly-bj-dev-k8s-master1 bin]$ <span class="built_in">cd</span> ~/kubernetes/calico</span><br><span class="line">[admin@haifly-bj-dev-k8s-master1 calico]$ wget https://docs.projectcalico.org/v3.7/getting-started/kubernetes/installation/hosted/calico.yaml</span><br></pre></td></tr></tbody></table></figure><h3 id="1-3拉取calico所需镜像"><a href="#1-3拉取calico所需镜像" class="headerlink" title="1.3拉取calico所需镜像"></a>1.3拉取calico所需镜像</h3><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[admin@haifly-bj-dev-k8s-node1 ~]$ docker pull calico/cni:v3.7.2</span><br><span class="line">[admin@haifly-bj-dev-k8s-node1 ~]$ calico/node:v3.7.2</span><br><span class="line">[admin@haifly-bj-dev-k8s-node1 ~]$ calico/kube-controllers:v3.7.2</span><br><span class="line"></span><br><span class="line">把镜像都传到自己的私有镜像仓库中去</span><br></pre></td></tr></tbody></table></figure><h3 id="1-4修改calico-yaml文件"><a href="#1-4修改calico-yaml文件" class="headerlink" title="1.4修改calico.yaml文件"></a>1.4修改calico.yaml文件</h3><p>我装的calico是最新版本3.7.2，yaml文件跟以前也差不多，修改以下几行内容</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">17   etcd-key: (cat /work/admin/kubernetes/ssl/etcd-key.pem | base64 | tr -d <span class="string">'\n'</span>)</span><br><span class="line">18   etcd-cert: (cat /work/admin/kubernetes/ssl/etcd.pem | base64 | tr -d <span class="string">'\n'</span>)</span><br><span class="line">19   etcd-ca: (cat /work/admin/kubernetes/ssl/ca.pem | base64 | tr -d <span class="string">'\n'</span>)</span><br><span class="line"><span class="comment">#将etcd 和ca 证书用base64转换后放在这里</span></span><br><span class="line"></span><br><span class="line"> 30   etcd_endpoints: <span class="string">"https://192.168.9.148:2379,https://192.168.9.149:2379,https://192.168.9.150:2379"</span></span><br><span class="line"><span class="comment">#etcd集群地址</span></span><br><span class="line"></span><br><span class="line"> 42   veth_mtu: <span class="string">"1500"</span></span><br><span class="line"> <span class="comment">#MTU最大传输单元，要小于或等于网卡eth0的MTU值</span></span><br><span class="line"> </span><br><span class="line"> 311               value: <span class="string">"10.1.0.0/16"</span></span><br><span class="line"> <span class="comment">#kubernetes容器网段地址，为kube-controller-manager里的--service-cluster-ip-range地址</span></span><br></pre></td></tr></tbody></table></figure><h3 id="2-部署calico"><a href="#2-部署calico" class="headerlink" title="2.部署calico"></a>2.部署calico</h3><h3 id="2-1创建calico容器"><a href="#2-1创建calico容器" class="headerlink" title="2.1创建calico容器"></a>2.1创建calico容器</h3><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[admin@haifly-bj-dev-k8s-master1 calico]$ kubectl create -f calico-etcd.yaml</span><br><span class="line">secret/calico-etcd-secrets created</span><br><span class="line">configmap/calico-config created</span><br><span class="line">clusterrole.rbac.authorization.k8s.io/calico-kube-controllers created</span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.io/calico-kube-controllers created</span><br><span class="line">clusterrole.rbac.authorization.k8s.io/calico-node created</span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.io/calico-node created</span><br><span class="line">daemonset.extensions/calico-node created</span><br><span class="line">serviceaccount/calico-node created</span><br><span class="line">deployment.extensions/calico-kube-controllers created</span><br><span class="line">serviceaccount/calico-kube-controllers created</span><br></pre></td></tr></tbody></table></figure><h3 id="2-2-查看容器运行状态"><a href="#2-2-查看容器运行状态" class="headerlink" title="2.2.查看容器运行状态"></a>2.2.查看容器运行状态</h3><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[admin@haifly-bj-dev-k8s-master1 calico]$ kubectl get pod -o wide -n kube-system </span><br><span class="line">NAME                                       READY   STATUS    RESTARTS   AGE   IP               NODE    NOMINATED NODE   READINESS GATES</span><br><span class="line">calico-kube-controllers-66f5c7bc8c-6c5gg   1/1     Running   0          15s   192.168.10.177   node1   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">calico-node-gs4tb                          1/1     Running   0          15s   192.168.10.177   node1   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">calico-node-tjhxn                          1/1     Running   0          15s   192.168.10.178   node2   &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></tbody></table></figure><h3 id="2-3-查看calico网络状态"><a href="#2-3-查看calico网络状态" class="headerlink" title="2.3.查看calico网络状态"></a>2.3.查看calico网络状态</h3><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[admin@haifly-bj-dev-k8s-node1 ~]$ sudo ~/kubernetes/bin/calicoctl node status</span><br><span class="line">[sudo] password <span class="keyword">for</span> admin: </span><br><span class="line">Calico process is running.</span><br><span class="line"></span><br><span class="line">IPv4 BGP status</span><br><span class="line">+----------------+-------------------+-------+----------+-------------+</span><br><span class="line">|  PEER ADDRESS  |     PEER TYPE     | STATE |  SINCE   |    INFO     |</span><br><span class="line">+----------------+-------------------+-------+----------+-------------+</span><br><span class="line">| 192.168.10.178 | node-to-node mesh | up    | 06:19:27 | Established |</span><br><span class="line">+----------------+-------------------+-------+----------+-------------+</span><br><span class="line"></span><br><span class="line">IPv6 BGP status</span><br><span class="line">No IPv6 peers found.</span><br></pre></td></tr></tbody></table></figure><script>document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });</script></div><div><div><div style="text-align:center;color:#ccc;font-size:14px">-------------本文结束<i class="fa fa-paw"></i>感谢您的阅读-------------</div></div></div><div></div><footer class="post-footer"><div class="post-tags"><a href="/tags/kubernetes/" rel="tag"><i class="fa fa-tag"></i> kubernetes</a></div><div class="post-nav"><div class="post-nav-next post-nav-item"><a href="/2019/05/16/gitlab-bu-shu/" rel="next" title="gitlab部署"><i class="fa fa-chevron-left"></i> gitlab部署</a></div><span class="post-nav-divider"></span><div class="post-nav-prev post-nav-item"><a href="/2019/05/20/prometheus-cha-xun-yu-yan/" rel="prev" title="Prometheus 查询语言">Prometheus 查询语言<i class="fa fa-chevron-right"></i></a></div></div></footer></div></article><div class="post-spread"><div class="jiathis_style"><span class="jiathis_txt">分享到：</span> <a class="jiathis_button_fav">收藏夹</a> <a class="jiathis_button_copy">复制网址</a> <a class="jiathis_button_email">邮件</a> <a class="jiathis_button_weixin">微信</a> <a class="jiathis_button_qzone">QQ空间</a> <a class="jiathis_button_tqq">腾讯微博</a> <a class="jiathis_button_douban">豆瓣</a> <a class="jiathis_button_share">一键分享</a> <a href="http://www.jiathis.com/share?uid=2140465" class="jiathis jiathis_txt jiathis_separator jtico jtico_jiathis" target="_blank">更多</a><a class="jiathis_counter_style"></a></div><script type="text/javascript">var jiathis_config={data_track_clickback:!0,summary:"",shortUrl:!1,hideMore:!1}</script><script type="text/javascript" src="http://v3.jiathis.com/code/jia.js?uid=" charset="utf-8"></script></div></div></div></div><div class="sidebar-toggle"><div class="sidebar-toggle-line-wrap"><span class="sidebar-toggle-line sidebar-toggle-line-first"></span><span class="sidebar-toggle-line sidebar-toggle-line-middle"></span><span class="sidebar-toggle-line sidebar-toggle-line-last"></span></div></div><aside id="sidebar" class="sidebar"><div id="sidebar-dimmer"></div><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">文章目录</li><li class="sidebar-nav-overview" data-target="site-overview-wrap">站点概览</li></ul><section class="site-overview-wrap sidebar-panel"><div class="site-overview"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="site-author-image" itemprop="image" src="/images/chen.png" alt="Zhongzhou Chen"><p class="site-author-name" itemprop="name">Zhongzhou Chen</p><p class="site-description motion-element" itemprop="description"></p></div><nav class="site-state motion-element"><div class="site-state-item site-state-posts"><a href="/archives/%7C%7C%20archive"><span class="site-state-item-count">371</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"><a href="/categories/index.html"><span class="site-state-item-count">89</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"><a href="/tags/index.html"><span class="site-state-item-count">188</span> <span class="site-state-item-name">标签</span></a></div></nav><div class="feed-link motion-element"><a href="/atom.xml" rel="alternate"><i class="fa fa-rss"></i> RSS</a></div></div></section><section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active"><div class="post-toc"><div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#一、Openssl自签TLS证书配置"><span class="nav-text">一、Openssl自签TLS证书配置</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#证书介绍"><span class="nav-text">证书介绍</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#cfssl-工具安装"><span class="nav-text">cfssl 工具安装</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#创建认证中心-CA"><span class="nav-text">创建认证中心(CA)</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-配置证书生成策略"><span class="nav-text">1.配置证书生成策略</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-创建用来生成-CA-证书签名请求（CSR）的-JSON-配置文件"><span class="nav-text">2.创建用来生成 CA 证书签名请求（CSR）的 JSON 配置文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-生成CA证书和私钥-root-证书和私钥"><span class="nav-text">3.生成CA证书和私钥(root 证书和私钥)</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#3-1-查看cert-证书信息"><span class="nav-text">3.1 查看cert(证书信息):</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-2-查看CSR-证书签名请求-信息："><span class="nav-text">3.2 查看CSR(证书签名请求)信息：</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-分发证书"><span class="nav-text">4.分发证书</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#二、搭建三节点的etcd集群"><span class="nav-text">二、搭建三节点的etcd集群</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-准备安装包"><span class="nav-text">1.准备安装包</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-创建etcd签名请求"><span class="nav-text">2.创建etcd签名请求</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-生成etcd证书和私钥"><span class="nav-text">3.生成etcd证书和私钥</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-分发etcd证书"><span class="nav-text">4.分发etcd证书</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-设置etcd配置文件"><span class="nav-text">5.设置etcd配置文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-1-配置方法1"><span class="nav-text">5.1 配置方法1</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-2-配置方法2"><span class="nav-text">5.2 配置方法2</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-启动etcd"><span class="nav-text">6.启动etcd</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-查看etcd集群状态"><span class="nav-text">7.查看etcd集群状态</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#master1-etcd-node1-的状态"><span class="nav-text">master1(etcd-node1)的状态</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#master2-etcd-node2-的状态"><span class="nav-text">master2(etcd-node2)的状态</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#node1-etcd-node3-的状态"><span class="nav-text">node1(etcd-node3)的状态</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#8-用命令查看集群状态"><span class="nav-text">8.用命令查看集群状态</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#三、部署master节点"><span class="nav-text">三、部署master节点</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-准备安装包-1"><span class="nav-text">1.准备安装包</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-创建生成kubernetes的CSR的-JSON-配置文件"><span class="nav-text">2.创建生成kubernetes的CSR的 JSON 配置文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-生成kubernetes证书和私钥"><span class="nav-text">3.生成kubernetes证书和私钥</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-分发证书-1"><span class="nav-text">4.分发证书</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-配置-kube-apiserver"><span class="nav-text">5.配置 kube-apiserver</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-1创建kube-apiserver使用的客户端token文件"><span class="nav-text">5.1创建kube-apiserver使用的客户端token文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-2-部署kube-apiserver服务"><span class="nav-text">5.2 部署kube-apiserver服务</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-3-启动kube-apiserver"><span class="nav-text">5.3 启动kube-apiserver</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-配置kube-controller-manager"><span class="nav-text">6.配置kube-controller-manager</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-1部署kube-controller-manager"><span class="nav-text">6.1部署kube-controller-manager</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-2启动kube-controller-manager"><span class="nav-text">6.2启动kube-controller-manager</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-3查看kube-controller-manager服务状态"><span class="nav-text">6.3查看kube-controller-manager服务状态</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-配置kube-scheduler"><span class="nav-text">7.配置kube-scheduler</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-1部署kube-scheduler服务"><span class="nav-text">7.1部署kube-scheduler服务</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-2启动kube-scheduler服务"><span class="nav-text">7.2启动kube-scheduler服务</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-3查看kube-scheduler状态"><span class="nav-text">7.3查看kube-scheduler状态</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#四、部署kubectl工具"><span class="nav-text">四、部署kubectl工具</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-准备二进制文件"><span class="nav-text">1.准备二进制文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-创建admin证书签名"><span class="nav-text">2.创建admin证书签名</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-生成admin证书"><span class="nav-text">3.生成admin证书</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-分发证书-2"><span class="nav-text">4.分发证书</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-配置kubectl的config"><span class="nav-text">5.配置kubectl的config</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-1设置集群参数"><span class="nav-text">5.1设置集群参数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-2设置客户端认证参数"><span class="nav-text">5.2设置客户端认证参数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-3设置上下文参数"><span class="nav-text">5.3设置上下文参数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-4设置默认上下文"><span class="nav-text">5.4设置默认上下文</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-使用kubectl-查看当前资源情况"><span class="nav-text">6.使用kubectl 查看当前资源情况</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#五、部署node节点"><span class="nav-text">五、部署node节点</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-安装docker环境"><span class="nav-text">1.安装docker环境</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-1-安装一些必要的系统工具"><span class="nav-text">1.1.安装一些必要的系统工具</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-2-添加docker镜像源"><span class="nav-text">1.2.添加docker镜像源</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-3-安装需要的版本"><span class="nav-text">1.3.安装需要的版本</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-4-把当前用户加入docker用户组"><span class="nav-text">1.4.把当前用户加入docker用户组</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-5-修改配置文件"><span class="nav-text">1.5.修改配置文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-6-启动docker服务"><span class="nav-text">1.6.启动docker服务</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-7-查看docker确保没有info类信息"><span class="nav-text">1.7.查看docker确保没有info类信息</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-准备工作"><span class="nav-text">2.准备工作</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-1准备node节点的kubelet和kube-proxy二进制包"><span class="nav-text">2.1准备node节点的kubelet和kube-proxy二进制包</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2创建角色绑定"><span class="nav-text">2.2创建角色绑定</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-3创建用于kubelet的kubeconfig文件"><span class="nav-text">2.3创建用于kubelet的kubeconfig文件</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#2-3-1设置集群参数"><span class="nav-text">2.3.1设置集群参数</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2-3-2设置客户端认证参数"><span class="nav-text">2.3.2设置客户端认证参数</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2-3-3设置上下文参数"><span class="nav-text">2.3.3设置上下文参数</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2-3-4选择默认上下文"><span class="nav-text">2.3.4选择默认上下文</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2-3-5将当前目录生成的-bootstrap-kubeconfig-分发到node节点上"><span class="nav-text">2.3.5将当前目录生成的 bootstrap.kubeconfig 分发到node节点上</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-部署kubelet"><span class="nav-text">3.部署kubelet</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-1创建kubelet工作目录"><span class="nav-text">3.1创建kubelet工作目录</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-2创建kubelet服务"><span class="nav-text">3.2创建kubelet服务</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-3启动kubelet服务"><span class="nav-text">3.3启动kubelet服务</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-4查看kubelet服务状态"><span class="nav-text">3.4查看kubelet服务状态</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-5在master节点查看csr请求"><span class="nav-text">3.5在master节点查看csr请求</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-6在master节点通过kubelet的TLS证书请求"><span class="nav-text">3.6在master节点通过kubelet的TLS证书请求</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-配置kube-proxy"><span class="nav-text">4.配置kube-proxy</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-1安装kube-proxy使用LVS需要的包"><span class="nav-text">4.1安装kube-proxy使用LVS需要的包</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-2创建kube-proxy证书请求的json"><span class="nav-text">4.2创建kube-proxy证书请求的json</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-3生成kube-proxy证书"><span class="nav-text">4.3生成kube-proxy证书</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-4分发证书"><span class="nav-text">4.4分发证书</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-5创建kube-proxy配置文件"><span class="nav-text">4.5创建kube-proxy配置文件</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#4-5-1创建集群信息"><span class="nav-text">4.5.1创建集群信息</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#4-5-2配置认证信息"><span class="nav-text">4.5.2配置认证信息</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#4-5-3设置上下文环境"><span class="nav-text">4.5.3设置上下文环境</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#4-5-4配置默认的上下文"><span class="nav-text">4.5.4配置默认的上下文</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#4-5-5分发kube-proxy-kubeconfig到node节点"><span class="nav-text">4.5.5分发kube-proxy.kubeconfig到node节点</span></a></li></ol></li></ol><li class="nav-item nav-level-3"><a class="nav-link" href="#4-6创建kube-proxy工作目录"><span class="nav-text">4.6创建kube-proxy工作目录</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-7创建kube-proxy服务配置"><span class="nav-text">4.7创建kube-proxy服务配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-8启动kube-proxy服务"><span class="nav-text">4.8启动kube-proxy服务</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-9查看kube-proxy服务状态"><span class="nav-text">4.9查看kube-proxy服务状态</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#六、部署kubernetes网络（calico）k8s容器方式"><span class="nav-text">六、部署kubernetes网络（calico）k8s容器方式</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-准备工作"><span class="nav-text">1.准备工作</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-准备工作-1"><span class="nav-text">1.准备工作</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-1下载calicoctl工具"><span class="nav-text">1.1下载calicoctl工具</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-2下载安装文件"><span class="nav-text">1.2下载安装文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-3拉取calico所需镜像"><span class="nav-text">1.3拉取calico所需镜像</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-4修改calico-yaml文件"><span class="nav-text">1.4修改calico.yaml文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-部署calico"><span class="nav-text">2.部署calico</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-1创建calico容器"><span class="nav-text">2.1创建calico容器</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2-查看容器运行状态"><span class="nav-text">2.2.查看容器运行状态</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-3-查看calico网络状态"><span class="nav-text">2.3.查看calico网络状态</span></a></li></ol></li></div></div></section><div class="back-to-top"><i class="fa fa-arrow-up"></i> <span id="scrollpercent"><span>0</span>%</span></div></div></aside></div></main><footer id="footer" class="footer"><div class="footer-inner"><script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script><div class="copyright">&copy; <span itemprop="copyrightYear">2023</span><span class="with-love"><i class="fa fa-user"></i></span> <span class="author" itemprop="copyrightHolder">Zhongzhou Chen</span> <span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-area-chart"></i></span> <span class="post-meta-item-text">Site words total count&#58;</span> <span title="Site words total count">863.9k</span></div><span class="post-meta-divider"></span></div></footer></div><script type="text/javascript">"[object Function]"!==Object.prototype.toString.call(window.Promise)&&(window.Promise=null)</script><script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script><script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script><script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script><script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script><script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script><script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script><script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script><style>.copy-btn{display:inline-block;padding:6px 12px;font-size:13px;font-weight:700;line-height:20px;color:#333;white-space:nowrap;vertical-align:middle;cursor:pointer;background-color:#eee;background-image:linear-gradient(#fcfcfc,#eee);border:1px solid #d5d5d5;border-radius:3px;user-select:none;outline:0}.highlight-wrap .copy-btn{transition:opacity .3s ease-in-out;opacity:0;padding:2px 6px;position:absolute;right:4px;top:8px}.highlight-wrap .copy-btn:focus,.highlight-wrap:hover .copy-btn{opacity:1}.highlight-wrap{position:relative}</style><script>$(".highlight").each(function(t,e){var n=$("<div>").addClass("highlight-wrap");$(e).after(n),n.append($("<button>").addClass("copy-btn").append("复制").on("click",function(t){var e=$(this).parent().find(".code").find(".line").map(function(t,e){return $(e).text()}).toArray().join("\n"),n=document.createElement("textarea");document.body.appendChild(n),n.style.position="absolute",n.style.top="0px",n.style.left="0px",n.value=e,n.select(),n.focus();var o=document.execCommand("copy");document.body.removeChild(n),o?$(this).text("复制成功"):$(this).text("复制失败"),$(this).blur()})).on("mouseleave",function(t){var e=$(this).find(".copy-btn");setTimeout(function(){e.text("复制")},300)}).append(e)})</script><script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script><script type="text/javascript">function proceedsearch(){$("body").append('<div class="search-popup-overlay local-search-pop-overlay"></div>').css("overflow","hidden"),$(".search-popup-overlay").click(onPopupClose),$(".popup").toggle();var t=$("#local-search-input");t.attr("autocapitalize","none"),t.attr("autocorrect","off"),t.focus()}var isfetched=!1,isXml=!0,search_path="search.xml";0===search_path.length?search_path="search.xml":/json$/i.test(search_path)&&(isXml=!1);var path="/"+search_path,onPopupClose=function(t){$(".popup").hide(),$("#local-search-input").val(""),$(".search-result-list").remove(),$("#no-result").remove(),$(".local-search-pop-overlay").remove(),$("body").css("overflow","")},searchFunc=function(t,e,s){"use strict";$("body").append('<div class="search-popup-overlay local-search-pop-overlay"><div id="search-loading-icon"><i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i></div></div>').css("overflow","hidden"),$("#search-loading-icon").css("margin","20% auto 0 auto").css("text-align","center"),$.ajax({url:t,dataType:isXml?"xml":"json",async:!0,success:function(t){isfetched=!0,$(".popup").detach().appendTo(".header-inner");var o=isXml?$("entry",t).map(function(){return{title:$("title",this).text(),content:$("content",this).text(),url:$("url",this).text()}}).get():t,n=document.getElementById(e),r=document.getElementById(s);n.addEventListener("input",function(){var y=n.value.trim().toLowerCase(),T=y.split(/[\s\-]+/);1<T.length&&T.push(y);var b=[];if(0<y.length&&o.forEach(function(t){function e(t,e,o,n){for(var r=n[n.length-1],s=r.position,a=r.word,i=[],c=0;s+a.length<=o&&0!=n.length;){a===y&&c++,i.push({position:s,length:a.length});var l=s+a.length;for(n.pop();0!=n.length&&(s=(r=n[n.length-1]).position,a=r.word,s<l);)n.pop()}return h+=c,{hits:i,start:e,end:o,searchTextCount:c}}function o(o,t){var n="",r=t.start;return t.hits.forEach(function(t){n+=o.substring(r,t.position);var e=t.position+t.length;n+='<b class="search-keyword">'+o.substring(t.position,e)+"</b>",r=e}),n+=o.substring(r,t.end)}var n=!1,r=0,h=0,s=t.title.trim(),a=s.toLowerCase(),i=t.content.trim().replace(/<[^>]+>/g,""),c=i.toLowerCase(),l=decodeURIComponent(t.url),p=[],u=[];if(""!=s&&(T.forEach(function(t){function e(t,e,o){var n=t.length;if(0===n)return[];var r=0,s=[],a=[];for(o||(e=e.toLowerCase(),t=t.toLowerCase());-1<(s=e.indexOf(t,r));)a.push({position:s,word:t}),r=s+n;return a}p=p.concat(e(t,a,!1)),u=u.concat(e(t,c,!1))}),(0<p.length||0<u.length)&&(n=!0,r=p.length+u.length)),n){[p,u].forEach(function(t){t.sort(function(t,e){return e.position!==t.position?e.position-t.position:t.word.length-e.word.length})});var f=[];0!=p.length&&f.push(e(0,0,s.length,p));for(var d=[];0!=u.length;){var g=u[u.length-1],v=g.position,$=g.word,C=v-20,m=v+80;C<0&&(C=0),m<v+$.length&&(m=v+$.length),m>i.length&&(m=i.length),d.push(e(0,C,m,u))}d.sort(function(t,e){return t.searchTextCount!==e.searchTextCount?e.searchTextCount-t.searchTextCount:t.hits.length!==e.hits.length?e.hits.length-t.hits.length:t.start-e.start});var x=parseInt("1");0<=x&&(d=d.slice(0,x));var w="";w+=0!=f.length?"<li><a href='"+l+"' class='search-result-title'>"+o(s,f[0])+"</a>":"<li><a href='"+l+"' class='search-result-title'>"+s+"</a>",d.forEach(function(t){w+="<a href='"+l+'\'><p class="search-result">'+o(i,t)+"...</p></a>"}),w+="</li>",b.push({item:w,searchTextCount:h,hitCount:r,id:b.length})}}),1===T.length&&""===T[0])r.innerHTML='<div id="no-result"><i class="fa fa-search fa-5x" /></div>';else if(0===b.length)r.innerHTML='<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>';else{b.sort(function(t,e){return t.searchTextCount!==e.searchTextCount?e.searchTextCount-t.searchTextCount:t.hitCount!==e.hitCount?e.hitCount-t.hitCount:e.id-t.id});var e='<ul class="search-result-list">';b.forEach(function(t){e+=t.item}),e+="</ul>",r.innerHTML=e}}),$(".local-search-pop-overlay").remove(),$("body").css("overflow",""),proceedsearch()}})};$(".popup-trigger").click(function(t){t.stopPropagation(),!1===isfetched?searchFunc(path,"local-search-input","local-search-result"):proceedsearch()}),$(".popup-btn-close").click(onPopupClose),$(".popup").click(function(t){t.stopPropagation()}),$(document).on("keyup",function(t){27===t.which&&$(".search-popup").is(":visible")&&onPopupClose()})</script><script type="text/javascript" src="/js/src/love.js"></script><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({pluginRootPath:"live2dw/",pluginJsPath:"lib/",pluginModelPath:"assets/",tagMode:!1,debug:!1,log:!1,model:{jsonPath:"/live2dw/assets/shizuku.model.json"},display:{position:"right"},mobile:{show:!0,scale:.2},react:{opacityDefault:.7,opacityOnHover:.2,opacity:.4}})</script></body></html>